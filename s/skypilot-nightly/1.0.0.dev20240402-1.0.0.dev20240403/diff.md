# Comparing `tmp/skypilot-nightly-1.0.0.dev20240402.tar.gz` & `tmp/skypilot-nightly-1.0.0.dev20240403.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "skypilot-nightly-1.0.0.dev20240402.tar", last modified: Tue Apr  2 10:40:21 2024, max compression
+gzip compressed data, was "skypilot-nightly-1.0.0.dev20240403.tar", last modified: Wed Apr  3 10:40:43 2024, max compression
```

## Comparing `skypilot-nightly-1.0.0.dev20240402.tar` & `skypilot-nightly-1.0.0.dev20240403.tar`

### file list

```diff
@@ -1,333 +1,334 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.238014 skypilot-nightly-1.0.0.dev20240402/
--rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      673 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    17543 2024-04-02 10:40:21.234014 skypilot-nightly-1.0.0.dev20240402/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    11413 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      640 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-02 10:40:21.238014 skypilot-nightly-1.0.0.dev20240402/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)    12002 2024-04-02 10:40:18.000000 skypilot-nightly-1.0.0.dev20240402/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.178014 skypilot-nightly-1.0.0.dev20240402/sky/
--rw-r--r--   0 runner    (1001) docker     (127)     5368 2024-04-02 10:40:21.000000 skypilot-nightly-1.0.0.dev20240402/sky/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.182014 skypilot-nightly-1.0.0.dev20240402/sky/adaptors/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/adaptors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7066 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/adaptors/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)     2376 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/adaptors/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     7762 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/adaptors/cloudflare.py
--rw-r--r--   0 runner    (1001) docker     (127)      706 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/adaptors/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)      852 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/adaptors/docker.py
--rw-r--r--   0 runner    (1001) docker     (127)     3194 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/adaptors/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     5444 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/adaptors/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)     4326 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/adaptors/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)     2054 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/adaptors/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)      700 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/adaptors/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)     5792 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/adaptors/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    21418 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/authentication.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.182014 skypilot-nightly-1.0.0.dev20240402/sky/backends/
--rw-r--r--   0 runner    (1001) docker     (127)      536 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/backends/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/backends/backend.py
--rw-r--r--   0 runner    (1001) docker     (127)   118837 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/backends/backend_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   221634 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/backends/cloud_vm_ray_backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/backends/docker_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/backends/local_docker_backend.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.182014 skypilot-nightly-1.0.0.dev20240402/sky/backends/monkey_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/backends/monkey_patches/monkey_patch_ray_up.py
--rw-r--r--   0 runner    (1001) docker     (127)     7293 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/backends/wheel_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.182014 skypilot-nightly-1.0.0.dev20240402/sky/benchmark/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/benchmark/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/benchmark/benchmark_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    26440 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/benchmark/benchmark_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5904 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/check.py
--rw-r--r--   0 runner    (1001) docker     (127)   186829 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/cli.py
--rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/cloud_stores.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.186014 skypilot-nightly-1.0.0.dev20240402/sky/clouds/
--rw-r--r--   0 runner    (1001) docker     (127)     1302 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    42742 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    30942 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)    30740 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)      955 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/cloud_registry.py
--rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)    12508 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    46892 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)    16791 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)    12012 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    25323 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/paperspace.py
--rw-r--r--   0 runner    (1001) docker     (127)    11042 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/scp.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.190014 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/
--rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    12428 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/aws_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/azure_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    25443 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/common.py
--rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      411 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/cudo_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.190014 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22251 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    11325 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)     5487 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    22061 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    21330 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/fluidstack_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    24009 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/gcp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/ibm_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4094 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/kubernetes_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/lambda_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7546 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/oci_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/paperspace_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/runpod_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/scp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4282 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/vsphere_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.190014 skypilot-nightly-1.0.0.dev20240402/sky/clouds/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/utils/gcp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/utils/lambda_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/utils/oci_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/utils/scp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/clouds/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    39960 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/dag.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.190014 skypilot-nightly-1.0.0.dev20240402/sky/data/
--rw-r--r--   0 runner    (1001) docker     (127)      184 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/data/data_transfer.py
--rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/data/data_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8226 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/data/mounting_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   119221 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/data/storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/data/storage_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8213 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/exceptions.py
--rw-r--r--   0 runner    (1001) docker     (127)    30923 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/execution.py
--rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    53979 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/optimizer.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.194014 skypilot-nightly-1.0.0.dev20240402/sky/provision/
--rw-r--r--   0 runner    (1001) docker     (127)     4907 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.194014 skypilot-nightly-1.0.0.dev20240402/sky/provision/aws/
--rw-r--r--   0 runner    (1001) docker     (127)      782 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/aws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/aws/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    36603 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/aws/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/aws/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.194014 skypilot-nightly-1.0.0.dev20240402/sky/provision/azure/
--rw-r--r--   0 runner    (1001) docker     (127)      199 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4400 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/azure/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     8561 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.194014 skypilot-nightly-1.0.0.dev20240402/sky/provision/cudo/
--rw-r--r--   0 runner    (1001) docker     (127)      676 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/cudo/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      327 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/cudo/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      696 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/cudo/cudo_machine_type.py
--rw-r--r--   0 runner    (1001) docker     (127)     3958 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/cudo/cudo_wrapper.py
--rw-r--r--   0 runner    (1001) docker     (127)     8202 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/cudo/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    16137 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/docker_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.194014 skypilot-nightly-1.0.0.dev20240402/sky/provision/fluidstack/
--rw-r--r--   0 runner    (1001) docker     (127)      592 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/fluidstack/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/fluidstack/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     8694 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/fluidstack/fluidstack_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    14870 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/fluidstack/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.198014 skypilot-nightly-1.0.0.dev20240402/sky/provision/gcp/
--rw-r--r--   0 runner    (1001) docker     (127)      579 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/gcp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/gcp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/gcp/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    24482 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/gcp/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    58971 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/gcp/instance_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    22258 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/instance_setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.198014 skypilot-nightly-1.0.0.dev20240402/sky/provision/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)      653 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/kubernetes/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    14212 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/kubernetes/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    32112 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/kubernetes/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9463 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/kubernetes/network.py
--rw-r--r--   0 runner    (1001) docker     (127)     8296 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/kubernetes/network_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    52441 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/kubernetes/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/logging.py
--rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/metadata_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.198014 skypilot-nightly-1.0.0.dev20240402/sky/provision/paperspace/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/paperspace/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/paperspace/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      553 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/paperspace/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11998 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/paperspace/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/paperspace/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    25255 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/provisioner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.198014 skypilot-nightly-1.0.0.dev20240402/sky/provision/runpod/
--rw-r--r--   0 runner    (1001) docker     (127)      502 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/runpod/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      321 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/runpod/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7849 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/runpod/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     4658 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/runpod/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.198014 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/
--rw-r--r--   0 runner    (1001) docker     (127)      788 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.202014 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/cls_api_client.py
--rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/cls_api_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      481 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/custom_script.py
--rw-r--r--   0 runner    (1001) docker     (127)      303 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/id_generator.py
--rw-r--r--   0 runner    (1001) docker     (127)      914 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/metadata_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/service_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)      544 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/service_manager_factory.py
--rw-r--r--   0 runner    (1001) docker     (127)      795 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/ssl_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/vapiconnect.py
--rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/vim_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      504 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    24330 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/vsphere_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    60100 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/resources.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.202014 skypilot-nightly-1.0.0.dev20240402/sky/serve/
--rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/serve/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    28636 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/serve/autoscalers.py
--rw-r--r--   0 runner    (1001) docker     (127)     3732 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/serve/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     7571 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/serve/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    29231 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/serve/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     4689 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/serve/load_balancer.py
--rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/serve/load_balancing_policies.py
--rw-r--r--   0 runner    (1001) docker     (127)    55329 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/serve/replica_managers.py
--rw-r--r--   0 runner    (1001) docker     (127)    18317 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/serve/serve_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    36822 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/serve/serve_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/serve/service.py
--rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/serve/service_spec.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.206014 skypilot-nightly-1.0.0.dev20240402/sky/setup_files/
--rw-r--r--   0 runner    (1001) docker     (127)      673 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/setup_files/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12002 2024-04-02 10:40:18.000000 skypilot-nightly-1.0.0.dev20240402/sky/setup_files/setup.py
--rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/sky_logging.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.206014 skypilot-nightly-1.0.0.dev20240402/sky/skylet/
--rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/attempt_skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     4293 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/autostop_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/configs.py
--rw-r--r--   0 runner    (1001) docker     (127)     9204 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11542 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/events.py
--rw-r--r--   0 runner    (1001) docker     (127)    35113 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/job_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    18759 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/log_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     4292 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/log_lib.pyi
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.206014 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.206014 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/azure/
--rw-r--r--   0 runner    (1001) docker     (127)       97 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/azure/azure-config-template.json
--rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/azure/azure-vm-template.json
--rw-r--r--   0 runner    (1001) docker     (127)     6203 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/azure/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    18603 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/azure/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    15645 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/command_runner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.210014 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/ibm/
--rw-r--r--   0 runner    (1001) docker     (127)       94 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/ibm/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/ibm/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/ibm/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/ibm/vpc_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.210014 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/lambda_cloud/
--rw-r--r--   0 runner    (1001) docker     (127)      112 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/lambda_cloud/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    13832 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/lambda_cloud/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.210014 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/oci/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/oci/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    20426 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/oci/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    17234 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/oci/query_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      508 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/oci/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.210014 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/scp/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/scp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/scp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/scp/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.210014 skypilot-nightly-1.0.0.dev20240402/sky/skylet/ray_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/ray_patches/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/ray_patches/autoscaler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      349 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/ray_patches/cli.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      224 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/ray_patches/command_runner.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      531 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/ray_patches/log_monitor.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      658 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      289 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/ray_patches/updater.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      565 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/ray_patches/worker.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)     1144 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skylet/subprocess_daemon.py
--rw-r--r--   0 runner    (1001) docker     (127)     5122 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/skypilot_config.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.214014 skypilot-nightly-1.0.0.dev20240402/sky/spot/
--rw-r--r--   0 runner    (1001) docker     (127)     1358 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/spot/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1117 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/spot/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    25326 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/spot/controller.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.214014 skypilot-nightly-1.0.0.dev20240402/sky/spot/dashboard/
--rw-r--r--   0 runner    (1001) docker     (127)     2294 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/spot/dashboard/dashboard.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.214014 skypilot-nightly-1.0.0.dev20240402/sky/spot/dashboard/static/
--rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/spot/dashboard/static/favicon.ico
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.214014 skypilot-nightly-1.0.0.dev20240402/sky/spot/dashboard/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     6247 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/spot/dashboard/templates/index.html
--rw-r--r--   0 runner    (1001) docker     (127)    25656 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/spot/recovery_strategy.py
--rw-r--r--   0 runner    (1001) docker     (127)    22487 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/spot/spot_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    31559 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/spot/spot_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/status_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    46443 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/task.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.214014 skypilot-nightly-1.0.0.dev20240402/sky/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     7290 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/aws-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/azure-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/cudo-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/fluidstack-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     8872 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/gcp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/ibm-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/kubernetes-ingress.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)      376 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/kubernetes-loadbalancer.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
--rw-r--r--   0 runner    (1001) docker     (127)     9851 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/kubernetes-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/kubernetes-ssh-jump.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/lambda-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/local-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/oci-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/paperspace-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/runpod-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/scp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/sky-serve-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1218 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/spot-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/templates/vsphere-ray.yml.j2
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.218014 skypilot-nightly-1.0.0.dev20240402/sky/usage/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/usage/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      590 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/usage/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/usage/usage_lib.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.218014 skypilot-nightly-1.0.0.dev20240402/sky/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/accelerator_registry.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.218014 skypilot-nightly-1.0.0.dev20240402/sky/utils/cli_utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/cli_utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/cli_utils/status_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      695 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/cluster_yaml_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    18791 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/command_runner.py
--rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/command_runner.pyi
--rw-r--r--   0 runner    (1001) docker     (127)    21502 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/common_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    25114 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/controller_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     4574 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/dag_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/db_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      852 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/env_options.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.222014 skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     8632 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/create_cluster.sh
--rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/delete_cluster.sh
--rw-r--r--   0 runner    (1001) docker     (127)     3012 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/generate_kind_config.py
--rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/gpu_labeler.py
--rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)     1173 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes_enums.py
--rw-r--r--   0 runner    (1001) docker     (127)     7747 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/log_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/resources_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/rich_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    20289 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/schemas.py
--rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/subprocess_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/timeline.py
--rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/ux_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      701 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/sky/utils/validator.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.226014 skypilot-nightly-1.0.0.dev20240402/skypilot_nightly.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    17543 2024-04-02 10:40:21.000000 skypilot-nightly-1.0.0.dev20240402/skypilot_nightly.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9122 2024-04-02 10:40:21.000000 skypilot-nightly-1.0.0.dev20240402/skypilot_nightly.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-02 10:40:21.000000 skypilot-nightly-1.0.0.dev20240402/skypilot_nightly.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)       36 2024-04-02 10:40:21.000000 skypilot-nightly-1.0.0.dev20240402/skypilot_nightly.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2312 2024-04-02 10:40:21.000000 skypilot-nightly-1.0.0.dev20240402/skypilot_nightly.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        4 2024-04-02 10:40:21.000000 skypilot-nightly-1.0.0.dev20240402/skypilot_nightly.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-02 10:40:21.226014 skypilot-nightly-1.0.0.dev20240402/tests/
--rw-r--r--   0 runner    (1001) docker     (127)      171 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_api.py
--rw-r--r--   0 runner    (1001) docker     (127)     3618 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_cli.py
--rw-r--r--   0 runner    (1001) docker     (127)     9599 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_config.py
--rw-r--r--   0 runner    (1001) docker     (127)      267 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_jobs.py
--rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_list_accelerators.py
--rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_optimizer_dryruns.py
--rw-r--r--   0 runner    (1001) docker     (127)     6898 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_optimizer_random_dag.py
--rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_serve_autoscaler.py
--rw-r--r--   0 runner    (1001) docker     (127)   207403 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_smoke.py
--rw-r--r--   0 runner    (1001) docker     (127)    17581 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_spot_serve.py
--rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_wheels.py
--rw-r--r--   0 runner    (1001) docker     (127)     3224 2024-04-02 10:40:16.000000 skypilot-nightly-1.0.0.dev20240402/tests/test_yaml_parser.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.596170 skypilot-nightly-1.0.0.dev20240403/
+-rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      673 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    17604 2024-04-03 10:40:43.596170 skypilot-nightly-1.0.0.dev20240403/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    11447 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      640 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-03 10:40:43.596170 skypilot-nightly-1.0.0.dev20240403/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)    12065 2024-04-03 10:40:40.000000 skypilot-nightly-1.0.0.dev20240403/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.540170 skypilot-nightly-1.0.0.dev20240403/sky/
+-rw-r--r--   0 runner    (1001) docker     (127)     5368 2024-04-03 10:40:43.000000 skypilot-nightly-1.0.0.dev20240403/sky/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.544170 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/cloudflare.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)      468 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/docker.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3698 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)      225 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/adaptors/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21410 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/authentication.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.544170 skypilot-nightly-1.0.0.dev20240403/sky/backends/
+-rw-r--r--   0 runner    (1001) docker     (127)      536 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/backends/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/backends/backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)   118820 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/backends/backend_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   221156 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/backends/cloud_vm_ray_backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/backends/docker_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/backends/local_docker_backend.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.544170 skypilot-nightly-1.0.0.dev20240403/sky/backends/monkey_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/backends/monkey_patches/monkey_patch_ray_up.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/backends/wheel_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.544170 skypilot-nightly-1.0.0.dev20240403/sky/benchmark/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/benchmark/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/benchmark/benchmark_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26440 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/benchmark/benchmark_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5904 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/check.py
+-rw-r--r--   0 runner    (1001) docker     (127)   186851 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/cloud_stores.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.548170 skypilot-nightly-1.0.0.dev20240403/sky/clouds/
+-rw-r--r--   0 runner    (1001) docker     (127)     1302 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    42742 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30942 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30816 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)      955 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/cloud_registry.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12508 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    46892 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16657 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12045 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/paperspace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11042 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/scp.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.552170 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/
+-rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/aws_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/azure_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26557 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      411 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/cudo_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.552170 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5487 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/fluidstack_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/gcp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/ibm_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/kubernetes_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/lambda_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7528 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/oci_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/paperspace_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/runpod_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/scp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/vsphere_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.552170 skypilot-nightly-1.0.0.dev20240403/sky/clouds/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/utils/gcp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/utils/lambda_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/utils/oci_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/utils/scp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/clouds/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    39960 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/dag.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.552170 skypilot-nightly-1.0.0.dev20240403/sky/data/
+-rw-r--r--   0 runner    (1001) docker     (127)      184 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/data/data_transfer.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/data/data_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8226 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/data/mounting_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   119221 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/data/storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/data/storage_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8213 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/exceptions.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31094 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/execution.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    54049 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/optimizer.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.556170 skypilot-nightly-1.0.0.dev20240403/sky/provision/
+-rw-r--r--   0 runner    (1001) docker     (127)     4907 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.556170 skypilot-nightly-1.0.0.dev20240403/sky/provision/aws/
+-rw-r--r--   0 runner    (1001) docker     (127)      782 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/aws/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/aws/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36603 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/aws/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/aws/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.556170 skypilot-nightly-1.0.0.dev20240403/sky/provision/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)      199 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4400 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/azure/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8561 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.556170 skypilot-nightly-1.0.0.dev20240403/sky/provision/cudo/
+-rw-r--r--   0 runner    (1001) docker     (127)      676 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/cudo/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      327 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/cudo/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      696 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/cudo/cudo_machine_type.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/cudo/cudo_wrapper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8202 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/cudo/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16137 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/docker_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.556170 skypilot-nightly-1.0.0.dev20240403/sky/provision/fluidstack/
+-rw-r--r--   0 runner    (1001) docker     (127)      592 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/fluidstack/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/fluidstack/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8694 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/fluidstack/fluidstack_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14870 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/fluidstack/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.560170 skypilot-nightly-1.0.0.dev20240403/sky/provision/gcp/
+-rw-r--r--   0 runner    (1001) docker     (127)      579 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/gcp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/gcp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/gcp/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24482 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/gcp/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    58975 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/gcp/instance_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22258 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/instance_setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.560170 skypilot-nightly-1.0.0.dev20240403/sky/provision/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)      653 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/kubernetes/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14212 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/kubernetes/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32106 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/kubernetes/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9457 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/kubernetes/network.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8635 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/kubernetes/network_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    52429 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/kubernetes/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/logging.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/metadata_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.560170 skypilot-nightly-1.0.0.dev20240403/sky/provision/paperspace/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/paperspace/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/paperspace/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      553 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/paperspace/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11998 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/paperspace/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/paperspace/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25255 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/provisioner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.560170 skypilot-nightly-1.0.0.dev20240403/sky/provision/runpod/
+-rw-r--r--   0 runner    (1001) docker     (127)      502 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/runpod/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      321 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/runpod/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7849 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/runpod/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/runpod/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.560170 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/
+-rw-r--r--   0 runner    (1001) docker     (127)      788 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.564170 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/cls_api_client.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/cls_api_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      481 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/custom_script.py
+-rw-r--r--   0 runner    (1001) docker     (127)      303 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/id_generator.py
+-rw-r--r--   0 runner    (1001) docker     (127)      914 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/metadata_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/service_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)      544 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/service_manager_factory.py
+-rw-r--r--   0 runner    (1001) docker     (127)      795 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/ssl_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/vapiconnect.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/vim_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      504 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24476 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/vsphere_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    60100 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/resources.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.564170 skypilot-nightly-1.0.0.dev20240403/sky/serve/
+-rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/serve/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28636 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/serve/autoscalers.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3732 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/serve/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7571 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/serve/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    29231 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/serve/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4689 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/serve/load_balancer.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/serve/load_balancing_policies.py
+-rw-r--r--   0 runner    (1001) docker     (127)    55329 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/serve/replica_managers.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18317 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/serve/serve_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36822 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/serve/serve_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/serve/service.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/serve/service_spec.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.564170 skypilot-nightly-1.0.0.dev20240403/sky/setup_files/
+-rw-r--r--   0 runner    (1001) docker     (127)      673 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/setup_files/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12065 2024-04-03 10:40:40.000000 skypilot-nightly-1.0.0.dev20240403/sky/setup_files/setup.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/sky_logging.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.568170 skypilot-nightly-1.0.0.dev20240403/sky/skylet/
+-rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/attempt_skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4293 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/autostop_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/configs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9204 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11542 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/events.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35113 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/job_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18759 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/log_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4292 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/log_lib.pyi
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.568170 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.568170 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)       97 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/azure/azure-config-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/azure/azure-vm-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)     6203 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/azure/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18603 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/azure/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15645 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/command_runner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.568170 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/ibm/
+-rw-r--r--   0 runner    (1001) docker     (127)       94 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/ibm/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/ibm/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/ibm/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/ibm/vpc_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.572170 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/lambda_cloud/
+-rw-r--r--   0 runner    (1001) docker     (127)      112 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/lambda_cloud/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13992 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/lambda_cloud/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.572170 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/oci/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/oci/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/oci/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/oci/query_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      508 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/oci/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.572170 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/scp/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/scp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/scp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/scp/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.572170 skypilot-nightly-1.0.0.dev20240403/sky/skylet/ray_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/ray_patches/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/ray_patches/autoscaler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      349 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/ray_patches/cli.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      224 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/ray_patches/command_runner.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      531 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/ray_patches/log_monitor.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      658 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      289 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/ray_patches/updater.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      565 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/ray_patches/worker.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)     1144 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skylet/subprocess_daemon.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5122 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/skypilot_config.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.572170 skypilot-nightly-1.0.0.dev20240403/sky/spot/
+-rw-r--r--   0 runner    (1001) docker     (127)     1358 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/spot/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1117 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/spot/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25326 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/spot/controller.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.572170 skypilot-nightly-1.0.0.dev20240403/sky/spot/dashboard/
+-rw-r--r--   0 runner    (1001) docker     (127)     2294 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/spot/dashboard/dashboard.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.572170 skypilot-nightly-1.0.0.dev20240403/sky/spot/dashboard/static/
+-rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/spot/dashboard/static/favicon.ico
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.576170 skypilot-nightly-1.0.0.dev20240403/sky/spot/dashboard/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     6247 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/spot/dashboard/templates/index.html
+-rw-r--r--   0 runner    (1001) docker     (127)    25656 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/spot/recovery_strategy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22487 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/spot/spot_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31559 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/spot/spot_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/status_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    46443 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/task.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.576170 skypilot-nightly-1.0.0.dev20240403/sky/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     7290 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/aws-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/azure-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/cudo-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/fluidstack-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     8872 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/gcp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/ibm-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/kubernetes-ingress.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)      376 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/kubernetes-loadbalancer.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     9851 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/kubernetes-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/kubernetes-ssh-jump.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/lambda-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/local-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/oci-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/paperspace-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/runpod-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/scp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/sky-serve-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1218 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/spot-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/templates/vsphere-ray.yml.j2
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.576170 skypilot-nightly-1.0.0.dev20240403/sky/usage/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/usage/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      590 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/usage/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/usage/usage_lib.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.580170 skypilot-nightly-1.0.0.dev20240403/sky/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/accelerator_registry.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.580170 skypilot-nightly-1.0.0.dev20240403/sky/utils/cli_utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/cli_utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/cli_utils/status_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      849 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/cluster_yaml_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18791 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/command_runner.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/command_runner.pyi
+-rw-r--r--   0 runner    (1001) docker     (127)    21533 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/common_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25413 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/controller_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4574 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/dag_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/db_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      852 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/env_options.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.584170 skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9667 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/create_cluster.sh
+-rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/delete_cluster.sh
+-rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/generate_kind_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/gpu_labeler.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1173 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes_enums.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/log_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/resources_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/rich_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20289 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/schemas.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/subprocess_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/timeline.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/ux_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      701 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/sky/utils/validator.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.584170 skypilot-nightly-1.0.0.dev20240403/skypilot_nightly.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    17604 2024-04-03 10:40:43.000000 skypilot-nightly-1.0.0.dev20240403/skypilot_nightly.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9145 2024-04-03 10:40:43.000000 skypilot-nightly-1.0.0.dev20240403/skypilot_nightly.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-03 10:40:43.000000 skypilot-nightly-1.0.0.dev20240403/skypilot_nightly.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       36 2024-04-03 10:40:43.000000 skypilot-nightly-1.0.0.dev20240403/skypilot_nightly.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2326 2024-04-03 10:40:43.000000 skypilot-nightly-1.0.0.dev20240403/skypilot_nightly.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        4 2024-04-03 10:40:43.000000 skypilot-nightly-1.0.0.dev20240403/skypilot_nightly.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-03 10:40:43.584170 skypilot-nightly-1.0.0.dev20240403/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)      171 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_api.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3618 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9599 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      267 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_jobs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_list_accelerators.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_optimizer_dryruns.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6898 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_optimizer_random_dag.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_serve_autoscaler.py
+-rw-r--r--   0 runner    (1001) docker     (127)   207403 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_smoke.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17581 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_spot_serve.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_wheels.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3224 2024-04-03 10:40:37.000000 skypilot-nightly-1.0.0.dev20240403/tests/test_yaml_parser.py
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/LICENSE` & `skypilot-nightly-1.0.0.dev20240403/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/MANIFEST.in` & `skypilot-nightly-1.0.0.dev20240403/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/PKG-INFO` & `skypilot-nightly-1.0.0.dev20240403/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240402
+Version: 1.0.0.dev20240403
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
@@ -87,14 +87,15 @@
 Requires-Dist: protobuf!=3.19.5,>=3.15.3; extra == "remote"
 Requires-Dist: pydantic!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3; extra == "remote"
 Provides-Extra: runpod
 Requires-Dist: runpod>=1.5.1; extra == "runpod"
 Provides-Extra: fluidstack
 Provides-Extra: cudo
 Requires-Dist: cudo-compute>=0.1.8; extra == "cudo"
+Provides-Extra: paperspace
 Provides-Extra: vsphere
 Requires-Dist: pyvmomi==8.0.1.0.2; extra == "vsphere"
 Provides-Extra: all
 Requires-Dist: urllib3<2; extra == "all"
 Requires-Dist: awscli>=1.27.10; extra == "all"
 Requires-Dist: botocore>=1.29.10; extra == "all"
 Requires-Dist: boto3>=1.26.1; extra == "all"
@@ -196,22 +197,22 @@
 * [Optimizer](https://skypilot.readthedocs.io/en/latest/examples/auto-failover.html): 2x cost savings by auto-picking the cheapest VM/zone/region/cloud
 * [Autostop](https://skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup of idle clusters
 
 SkyPilot supports your existing GPU, TPU, and CPU workloads, with no code changes.
 
 Install with pip (we recommend the nightly build for the latest features or [from source](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html)):
 ```bash
-pip install "skypilot-nightly[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]"  # choose your clouds
+pip install "skypilot-nightly[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"  # choose your clouds
 ```
 To get the last release, use:
 ```bash
-pip install -U "skypilot[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]"  # choose your clouds
+pip install -U "skypilot[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"  # choose your clouds
 ```
 
-Current supported providers (AWS, Azure, GCP, OCI, Lambda Cloud, RunPod, Fluidstack, Cudo, IBM, Samsung, Cloudflare, any Kubernetes cluster):
+Current supported providers (AWS, Azure, GCP, OCI, Lambda Cloud, RunPod, Fluidstack, Paperspace, Cudo, IBM, Samsung, Cloudflare, any Kubernetes cluster):
 <p align="center">
   <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/cloud-logos-light.png" width=85%>
 </p>
 
 
 ## Getting Started
 You can find our documentation [here](https://skypilot.readthedocs.io/en/latest/).
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/README.md` & `skypilot-nightly-1.0.0.dev20240403/README.md`

 * *Files 2% similar despite different names*

```diff
@@ -64,22 +64,22 @@
 * [Optimizer](https://skypilot.readthedocs.io/en/latest/examples/auto-failover.html): 2x cost savings by auto-picking the cheapest VM/zone/region/cloud
 * [Autostop](https://skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup of idle clusters
 
 SkyPilot supports your existing GPU, TPU, and CPU workloads, with no code changes.
 
 Install with pip (we recommend the nightly build for the latest features or [from source](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html)):
 ```bash
-pip install "skypilot-nightly[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]"  # choose your clouds
+pip install "skypilot-nightly[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"  # choose your clouds
 ```
 To get the last release, use:
 ```bash
-pip install -U "skypilot[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]"  # choose your clouds
+pip install -U "skypilot[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"  # choose your clouds
 ```
 
-Current supported providers (AWS, Azure, GCP, OCI, Lambda Cloud, RunPod, Fluidstack, Cudo, IBM, Samsung, Cloudflare, any Kubernetes cluster):
+Current supported providers (AWS, Azure, GCP, OCI, Lambda Cloud, RunPod, Fluidstack, Paperspace, Cudo, IBM, Samsung, Cloudflare, any Kubernetes cluster):
 <p align="center">
   <picture>
     <source media="(prefers-color-scheme: dark)" srcset="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/cloud-logos-dark.png">
     <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/cloud-logos-light.png" width=85%>
   </picture>
 </p>
```

#### html2text {}

```diff
@@ -45,20 +45,21 @@
 skypilot.readthedocs.io/en/latest/examples/auto-failover.html): 2x cost savings
 by auto-picking the cheapest VM/zone/region/cloud * [Autostop](https://
 skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup
 of idle clusters SkyPilot supports your existing GPU, TPU, and CPU workloads,
 with no code changes. Install with pip (we recommend the nightly build for the
 latest features or [from source](https://skypilot.readthedocs.io/en/latest/
 getting-started/installation.html)): ```bash pip install "skypilot-nightly
-[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]" # choose
-your clouds ``` To get the last release, use: ```bash pip install -U "skypilot
-[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]" # choose
-your clouds ``` Current supported providers (AWS, Azure, GCP, OCI, Lambda
-Cloud, RunPod, Fluidstack, Cudo, IBM, Samsung, Cloudflare, any Kubernetes
-cluster):
+[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"
+# choose your clouds ``` To get the last release, use: ```bash pip install -
+U "skypilot
+[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"
+# choose your clouds ``` Current supported providers (AWS, Azure, GCP, OCI,
+Lambda Cloud, RunPod, Fluidstack, Paperspace, Cudo, IBM, Samsung, Cloudflare,
+any Kubernetes cluster):
                                   [SkyPilot]
 ## Getting Started You can find our documentation [here](https://
 skypilot.readthedocs.io/en/latest/). - [Installation](https://
 skypilot.readthedocs.io/en/latest/getting-started/installation.html) -
 [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/
 quickstart.html) - [CLI reference](https://skypilot.readthedocs.io/en/latest/
 reference/cli.html) ## SkyPilot in 1 Minute A SkyPilot task specifies: resource
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/pyproject.toml` & `skypilot-nightly-1.0.0.dev20240403/pyproject.toml`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/setup.py` & `skypilot-nightly-1.0.0.dev20240403/setup.py`

 * *Files 1% similar despite different names*

```diff
@@ -232,14 +232,15 @@
     'scp': local_ray,
     'oci': ['oci'] + local_ray,
     'kubernetes': ['kubernetes>=20.0.0'],
     'remote': remote,
     'runpod': ['runpod>=1.5.1'],
     'fluidstack': [],  # No dependencies needed for fluidstack
     'cudo': ['cudo-compute>=0.1.8'],
+    'paperspace': [],  # No dependencies needed for paperspace
     'vsphere': [
         'pyvmomi==8.0.1.0.2',
         # vsphere-automation-sdk is also required, but it does not have
         # pypi release, which cause failure of our pypi release.
         # https://peps.python.org/pep-0440/#direct-references
         # We have the instruction for its installation in our
         # docs instead.
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/__init__.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 """The SkyPilot package."""
 import os
 import subprocess
 from typing import Optional
 import urllib.request
 
 # Replaced with the current commit when building the wheels.
-_SKYPILOT_COMMIT_SHA = '12b30cc65a779bf1397b94fd0d0a717605b3c5c2'
+_SKYPILOT_COMMIT_SHA = 'bca709b5554858fc630695a1d867c2d84593a291'
 
 
 def _get_git_commit():
     if 'SKYPILOT_COMMIT_SHA' not in _SKYPILOT_COMMIT_SHA:
         # This is a release build, so we don't need to get the commit hash from
         # git, as it's already been set.
         return _SKYPILOT_COMMIT_SHA
@@ -31,15 +31,15 @@
             commit_hash += '-dirty'
         return commit_hash
     except Exception:  # pylint: disable=broad-except
         return _SKYPILOT_COMMIT_SHA
 
 
 __commit__ = _get_git_commit()
-__version__ = '1.0.0.dev20240402'
+__version__ = '1.0.0.dev20240403'
 __root_dir__ = os.path.dirname(os.path.abspath(__file__))
 
 
 # ---------------------- Proxy Configuration ---------------------- #
 def _set_http_proxy_env_vars() -> None:
     urllib_proxies = dict(urllib.request.getproxies())
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/adaptors/aws.py` & `skypilot-nightly-1.0.0.dev20240403/sky/adaptors/aws.py`

 * *Files 10% similar despite different names*

```diff
@@ -30,20 +30,25 @@
 
 import functools
 import logging
 import threading
 import time
 from typing import Any, Callable
 
+from sky.adaptors import common
 from sky.utils import common_utils
 
-logger = logging.getLogger(__name__)
+_IMPORT_ERROR_MESSAGE = ('Failed to import dependencies for AWS. '
+                         'Try pip install "skypilot[aws]"')
+boto3 = common.LazyImport('boto3', import_error_message=_IMPORT_ERROR_MESSAGE)
+botocore = common.LazyImport('botocore',
+                             import_error_message=_IMPORT_ERROR_MESSAGE)
+_LAZY_MODULES = (boto3, botocore)
 
-boto3 = None
-botocore = None
+logger = logging.getLogger(__name__)
 _session_creation_lock = threading.RLock()
 
 version = 1
 
 # Retry 5 times by default for potential credential errors,
 # mentioned in
 # https://github.com/skypilot-org/skypilot/pull/1988
@@ -69,33 +74,14 @@
             return local_cache.cache(func)(*args, **kwargs)
 
         return wrapper
 
     return decorator
 
 
-def import_package(func):
-
-    @functools.wraps(func)
-    def wrapper(*args, **kwargs):
-        global boto3, botocore
-        if boto3 is None or botocore is None:
-            try:
-                import boto3 as _boto3
-                import botocore as _botocore
-                boto3 = _boto3
-                botocore = _botocore
-            except ImportError:
-                raise ImportError('Fail to import dependencies for AWS. '
-                                  'Try pip install "skypilot[aws]"') from None
-        return func(*args, **kwargs)
-
-    return wrapper
-
-
 def _assert_kwargs_builtin_type(kwargs):
     assert all(isinstance(v, (int, float, str)) for v in kwargs.values()), (
         f'kwargs should not contain none built-in types: {kwargs}')
 
 
 def _create_aws_object(creation_fn_or_cls: Callable[[], Any],
                        object_name: str) -> Any:
@@ -127,24 +113,22 @@
             if attempt >= _MAX_ATTEMPT_FOR_CREATION:
                 raise
             time.sleep(backoff.current_backoff())
             logger.info(f'Retry creating AWS {object_name} due to '
                         f'{common_utils.format_exception(e)}.')
 
 
-@import_package
 # The LRU cache needs to be thread-local to avoid multiple threads sharing the
 # same session object, which is not guaranteed to be thread-safe.
 @_thread_local_lru_cache()
 def session():
     """Create an AWS session."""
     return _create_aws_object(boto3.session.Session, 'session')
 
 
-@import_package
 # Avoid caching the resource/client objects. If we are using the assumed role,
 # the credentials will be automatically rotated, but the cached resource/client
 # object will only refresh the credentials with a fixed 15 minutes interval,
 # which can cause unexpected NoCredentialsError. By creating the resource/client
 # object every time, the credentials will be explicitly refreshed.
 # The creation of the resource/client is relatively fast (around 0.3s), so the
 # performance impact is negligible.
@@ -168,15 +152,14 @@
     # Need to use the client retrieved from the per-thread session to avoid
     # thread-safety issues (Directly creating the client with boto3.resource()
     # is not thread-safe). Reference: https://stackoverflow.com/a/59635814
     return _create_aws_object(
         lambda: session().resource(service_name, **kwargs), 'resource')
 
 
-@import_package
 def client(service_name: str, **kwargs):
     """Create an AWS client of a certain service.
 
     Args:
         service_name: AWS service name (e.g., 's3', 'ec2').
         kwargs: Other options.
     """
@@ -185,19 +168,19 @@
     # thread-safety issues (Directly creating the client with boto3.client() is
     # not thread-safe). Reference: https://stackoverflow.com/a/59635814
 
     return _create_aws_object(lambda: session().client(service_name, **kwargs),
                               'client')
 
 
-@import_package
+@common.load_lazy_modules(modules=_LAZY_MODULES)
 def botocore_exceptions():
     """AWS botocore exception."""
     from botocore import exceptions
     return exceptions
 
 
-@import_package
+@common.load_lazy_modules(modules=_LAZY_MODULES)
 def botocore_config():
     """AWS botocore exception."""
     from botocore import config
     return config
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/adaptors/azure.py` & `skypilot-nightly-1.0.0.dev20240403/sky/adaptors/azure.py`

 * *Files 21% similar despite different names*

```diff
@@ -1,75 +1,65 @@
 """Azure cli adaptor"""
 
 # pylint: disable=import-outside-toplevel
 import functools
 import threading
 
-azure = None
-_session_creation_lock = threading.RLock()
-
+from sky.adaptors import common
 
-def import_package(func):
+azure = common.LazyImport(
+    'azure',
+    import_error_message=('Failed to import dependencies for Azure.'
+                          'Try pip install "skypilot[azure]"'))
+_LAZY_MODULES = (azure,)
 
-    @functools.wraps(func)
-    def wrapper(*args, **kwargs):
-        global azure
-        if azure is None:
-            try:
-                import azure as _azure  # type: ignore
-                azure = _azure
-            except ImportError:
-                raise ImportError('Fail to import dependencies for Azure.'
-                                  'Try pip install "skypilot[azure]"') from None
-        return func(*args, **kwargs)
-
-    return wrapper
+_session_creation_lock = threading.RLock()
 
 
-@import_package
+@common.load_lazy_modules(modules=_LAZY_MODULES)
 def get_subscription_id() -> str:
     """Get the default subscription id."""
     from azure.common import credentials
     return credentials.get_cli_profile().get_subscription_id()
 
 
-@import_package
+@common.load_lazy_modules(modules=_LAZY_MODULES)
 def get_current_account_user() -> str:
     """Get the default account user."""
     from azure.common import credentials
     return credentials.get_cli_profile().get_current_account_user()
 
 
-@import_package
+@common.load_lazy_modules(modules=_LAZY_MODULES)
 def exceptions():
     """Azure exceptions."""
     from azure.core import exceptions as azure_exceptions
     return azure_exceptions
 
 
 @functools.lru_cache()
-@import_package
+@common.load_lazy_modules(modules=_LAZY_MODULES)
 def get_client(name: str, subscription_id: str):
     # Sky only supports Azure CLI credential for now.
     # Increase the timeout to fix the Azure get-access-token timeout issue.
     # Tracked in
     # https://github.com/Azure/azure-cli/issues/20404#issuecomment-1249575110
     from azure.identity import AzureCliCredential
-    from azure.mgmt.network import NetworkManagementClient
-    from azure.mgmt.resource import ResourceManagementClient
     with _session_creation_lock:
         credential = AzureCliCredential(process_timeout=30)
         if name == 'compute':
             from azure.mgmt.compute import ComputeManagementClient
             return ComputeManagementClient(credential, subscription_id)
         elif name == 'network':
+            from azure.mgmt.network import NetworkManagementClient
             return NetworkManagementClient(credential, subscription_id)
         elif name == 'resource':
+            from azure.mgmt.resource import ResourceManagementClient
             return ResourceManagementClient(credential, subscription_id)
         else:
             raise ValueError(f'Client not supported: "{name}"')
 
 
-@import_package
+@common.load_lazy_modules(modules=_LAZY_MODULES)
 def create_security_rule(**kwargs):
     from azure.mgmt.network.models import SecurityRule
     return SecurityRule(**kwargs)
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/adaptors/cloudflare.py` & `skypilot-nightly-1.0.0.dev20240403/sky/adaptors/cloudflare.py`

 * *Files 10% similar despite different names*

```diff
@@ -3,45 +3,32 @@
 
 import contextlib
 import functools
 import os
 import threading
 from typing import Dict, Optional, Tuple
 
+from sky.adaptors import common
 from sky.utils import ux_utils
 
-boto3 = None
-botocore = None
+_IMPORT_ERROR_MESSAGE = ('Failed to import dependencies for Cloudflare.'
+                         'Try pip install "skypilot[cloudflare]"')
+boto3 = common.LazyImport('boto3', import_error_message=_IMPORT_ERROR_MESSAGE)
+botocore = common.LazyImport('botocore',
+                             import_error_message=_IMPORT_ERROR_MESSAGE)
+_LAZY_MODULES = (boto3, botocore)
+
 _session_creation_lock = threading.RLock()
 ACCOUNT_ID_PATH = '~/.cloudflare/accountid'
 R2_CREDENTIALS_PATH = '~/.cloudflare/r2.credentials'
 R2_PROFILE_NAME = 'r2'
 _INDENT_PREFIX = '    '
 NAME = 'Cloudflare'
 
 
-def import_package(func):
-
-    @functools.wraps(func)
-    def wrapper(*args, **kwargs):
-        global boto3, botocore
-        if boto3 is None or botocore is None:
-            try:
-                import boto3 as _boto3
-                import botocore as _botocore
-                boto3 = _boto3
-                botocore = _botocore
-            except ImportError:
-                raise ImportError('Fail to import dependencies for Cloudflare.'
-                                  'Try pip install "skypilot[aws]"') from None
-        return func(*args, **kwargs)
-
-    return wrapper
-
-
 @contextlib.contextmanager
 def _load_r2_credentials_env():
     """Context manager to temporarily change the AWS credentials file path."""
     prev_credentials_path = os.environ.get('AWS_SHARED_CREDENTIALS_FILE')
     os.environ['AWS_SHARED_CREDENTIALS_FILE'] = R2_CREDENTIALS_PATH
     try:
         yield
@@ -71,30 +58,28 @@
             return cloudflare_credentials.get_frozen_credentials()
 
 
 # lru_cache() is thread-safe and it will return the same session object
 # for different threads.
 # Reference: https://docs.python.org/3/library/functools.html#functools.lru_cache # pylint: disable=line-too-long
 @functools.lru_cache()
-@import_package
 def session():
     """Create an AWS session."""
     # Creating the session object is not thread-safe for boto3,
     # so we add a reentrant lock to synchronize the session creation.
     # Reference: https://github.com/boto/boto3/issues/1592
     # However, the session object itself is thread-safe, so we are
     # able to use lru_cache() to cache the session object.
     with _session_creation_lock:
         with _load_r2_credentials_env():
             session_ = boto3.session.Session(profile_name=R2_PROFILE_NAME)
         return session_
 
 
 @functools.lru_cache()
-@import_package
 def resource(resource_name: str, **kwargs):
     """Create a Cloudflare resource.
 
     Args:
         resource_name: Cloudflare resource name (e.g., 's3').
         kwargs: Other options.
     """
@@ -137,15 +122,15 @@
         service_name,
         endpoint_url=endpoint,
         aws_access_key_id=cloudflare_credentials.access_key,
         aws_secret_access_key=cloudflare_credentials.secret_key,
         region_name=region)
 
 
-@import_package
+@common.load_lazy_modules(_LAZY_MODULES)
 def botocore_exceptions():
     """AWS botocore exception."""
     from botocore import exceptions
     return exceptions
 
 
 def create_endpoint():
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/adaptors/ibm.py` & `skypilot-nightly-1.0.0.dev20240403/sky/adaptors/ibm.py`

 * *Files 13% similar despite different names*

```diff
@@ -1,77 +1,56 @@
 """IBM cloud adaptors"""
 
 # pylint: disable=import-outside-toplevel
 
-import functools
 import json
 import multiprocessing
 import os
 
 import requests
 import yaml
 
 from sky import sky_logging
+from sky.adaptors import common
 
 CREDENTIAL_FILE = '~/.ibm/credentials.yaml'
 logger = sky_logging.init_logger(__name__)
 
-ibm_vpc = None
-ibm_cloud_sdk_core = None
-ibm_platform_services = None
-ibm_boto3 = None
-ibm_botocore = None
-
-
-def import_package(func):
-
-    @functools.wraps(func)
-    def wrapper(*args, **kwargs):
-        global ibm_vpc, ibm_cloud_sdk_core, ibm_platform_services
-        global ibm_boto3, ibm_botocore
-        if None in [ibm_vpc, ibm_cloud_sdk_core, ibm_platform_services]:
-            try:
-                import ibm_boto3 as _ibm_boto3
-                import ibm_botocore as _ibm_botocore
-                import ibm_cloud_sdk_core as _ibm_cloud_sdk_core
-                import ibm_platform_services as _ibm_platform_services
-                import ibm_vpc as _ibm_vpc
-                ibm_vpc = _ibm_vpc
-                ibm_cloud_sdk_core = _ibm_cloud_sdk_core
-                ibm_platform_services = _ibm_platform_services
-                ibm_boto3 = _ibm_boto3
-                ibm_botocore = _ibm_botocore
-            except ImportError:
-                raise ImportError(
-                    'Failed to import dependencies for IBM. '
-                    'Try running: pip install "skypilot[ibm]".\n') from None
-        return func(*args, **kwargs)
-
-    return wrapper
+_IMPORT_ERROR_MESSAGE = ('Failed to import dependencies for IBM. '
+                         'Try running: pip install "skypilot[ibm]".\n')
+ibm_vpc = common.LazyImport('ibm_vpc',
+                            import_error_message=_IMPORT_ERROR_MESSAGE)
+ibm_cloud_sdk_core = common.LazyImport(
+    'ibm_cloud_sdk_core', import_error_message=_IMPORT_ERROR_MESSAGE)
+ibm_platform_services = common.LazyImport(
+    'ibm_platform_services', import_error_message=_IMPORT_ERROR_MESSAGE)
+ibm_boto3 = common.LazyImport('ibm_boto3',
+                              import_error_message=_IMPORT_ERROR_MESSAGE)
+ibm_botocore = common.LazyImport('ibm_botocore',
+                                 import_error_message=_IMPORT_ERROR_MESSAGE)
 
 
 def read_credential_file():
     try:
         with open(os.path.expanduser(CREDENTIAL_FILE), 'r',
                   encoding='utf-8') as f:
             return yaml.safe_load(f)
     except FileNotFoundError:
-        return False
+        return {}
 
 
 def get_api_key():
     return read_credential_file()['iam_api_key']
 
 
 def get_hmac_keys():
     cred_file = read_credential_file()
     return cred_file['access_key_id'], cred_file['secret_access_key']
 
 
-@import_package
 def _get_authenticator():
     return ibm_cloud_sdk_core.authenticators.IAMAuthenticator(get_api_key())
 
 
 def get_oauth_token():
     """returns a temporary authentication token required by
         various IBM cloud APIs
@@ -83,15 +62,14 @@
         headers={'Content-Type': 'application/x-www-form-urlencoded'},
         data=
         f'grant_type=urn:ibm:params:oauth:grant-type:apikey&apikey={get_api_key()}'
     )
     return json.loads(res.text)['access_token']
 
 
-@import_package
 def client(**kwargs):
     """Create an ibm vpc client.
 
     Sets the vpc client to a specific region.
     If none was specified 'us-south' is set internally.
 
     Args:
@@ -110,27 +88,24 @@
     except Exception:
         logger.error('No registered API key found matching specified value')
         raise
 
     return vpc_client  # returns either formerly or newly created client
 
 
-@import_package
 def search_client():
     return ibm_platform_services.GlobalSearchV2(
         authenticator=_get_authenticator())
 
 
-@import_package
 def tagging_client():
     return ibm_platform_services.GlobalTaggingV1(
         authenticator=_get_authenticator())
 
 
-@import_package
 def get_cos_client(region: str = 'us-east'):
     """Returns an IBM COS client object.
       Using process lock to protect not multi process
       safe Boto3.session, which is invoked (default session) by
       boto3.client.
 
     Args:
@@ -145,15 +120,14 @@
             service_name='s3',
             aws_access_key_id=access_key_id,
             aws_secret_access_key=secret_access_key,
             endpoint_url=
             f'https://s3.{region}.cloud-object-storage.appdomain.cloud')
 
 
-@import_package
 def get_cos_resource(region: str = 'us-east'):
     """Returns an IBM COS Resource object.
       Using process lock to protect not multi process safe
       boto3.Resource.
 
     Args:
         region (str, optional): Resource Endpoint. Defaults to 'us-east'.
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/adaptors/kubernetes.py` & `skypilot-nightly-1.0.0.dev20240403/sky/adaptors/kubernetes.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,60 +1,35 @@
 """Kubernetes adaptors"""
 
 # pylint: disable=import-outside-toplevel
 
-import functools
 import os
 
+from sky.adaptors import common
 from sky.utils import env_options
 from sky.utils import ux_utils
 
-kubernetes = None
-urllib3 = None
+_IMPORT_ERROR_MESSAGE = ('Failed to import dependencies for Kubernetes. '
+                         'Try running: pip install "skypilot[kubernetes]"')
+kubernetes = common.LazyImport('kubernetes',
+                               import_error_message=_IMPORT_ERROR_MESSAGE)
+urllib3 = common.LazyImport('urllib3',
+                            import_error_message=_IMPORT_ERROR_MESSAGE)
 
 _configured = False
 _core_api = None
 _auth_api = None
 _networking_api = None
 _custom_objects_api = None
 _node_api = None
 
 # Timeout to use for API calls
 API_TIMEOUT = 5
 
 
-def import_package(func):
-
-    @functools.wraps(func)
-    def wrapper(*args, **kwargs):
-        global kubernetes
-        global urllib3
-        if kubernetes is None:
-            try:
-                import kubernetes as _kubernetes
-                import urllib3 as _urllib3
-            except ImportError:
-                # TODO(romilb): Update this message to point to installation
-                #  docs when they are ready.
-                raise ImportError('Fail to import dependencies for Kubernetes. '
-                                  'Run `pip install kubernetes` to '
-                                  'install them.') from None
-            kubernetes = _kubernetes
-            urllib3 = _urllib3
-        return func(*args, **kwargs)
-
-    return wrapper
-
-
-@import_package
-def get_kubernetes():
-    return kubernetes
-
-
-@import_package
 def _load_config():
     global _configured
     if _configured:
         return
     try:
         # Load in-cluster config if running in a pod
         # Kubernetes set environment variables for service discovery do not
@@ -84,75 +59,66 @@
                     f'Please check if your kubeconfig file is valid.{suffix}')
             err_str += '\nTo disable Kubernetes for SkyPilot: run `sky check`.'
             with ux_utils.print_exception_no_traceback():
                 raise ValueError(err_str) from None
     _configured = True
 
 
-@import_package
 def core_api():
     global _core_api
     if _core_api is None:
         _load_config()
         _core_api = kubernetes.client.CoreV1Api()
 
     return _core_api
 
 
-@import_package
 def auth_api():
     global _auth_api
     if _auth_api is None:
         _load_config()
         _auth_api = kubernetes.client.RbacAuthorizationV1Api()
 
     return _auth_api
 
 
-@import_package
 def networking_api():
     global _networking_api
     if _networking_api is None:
         _load_config()
         _networking_api = kubernetes.client.NetworkingV1Api()
 
     return _networking_api
 
 
-@import_package
 def custom_objects_api():
     global _custom_objects_api
     if _custom_objects_api is None:
         _load_config()
         _custom_objects_api = kubernetes.client.CustomObjectsApi()
 
     return _custom_objects_api
 
 
-@import_package
 def node_api():
     global _node_api
     if _node_api is None:
         _load_config()
         _node_api = kubernetes.client.NodeV1Api()
 
     return _node_api
 
 
-@import_package
 def api_exception():
     return kubernetes.client.rest.ApiException
 
 
-@import_package
 def config_exception():
     return kubernetes.config.config_exception.ConfigException
 
 
-@import_package
 def max_retry_error():
     return urllib3.exceptions.MaxRetryError
 
 
-@import_package
 def stream():
     return kubernetes.stream.stream
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/authentication.py` & `skypilot-nightly-1.0.0.dev20240403/sky/authentication.py`

 * *Files 0% similar despite different names*

```diff
@@ -406,15 +406,15 @@
     get_or_generate_keys()
 
     # Add the user's public key to the SkyPilot cluster.
     public_key_path = os.path.expanduser(PUBLIC_SSH_KEY_PATH)
     secret_name = clouds.Kubernetes.SKY_SSH_KEY_SECRET_NAME
     secret_field_name = clouds.Kubernetes.SKY_SSH_KEY_SECRET_FIELD_NAME
     namespace = kubernetes_utils.get_current_kube_config_context_namespace()
-    k8s = kubernetes.get_kubernetes()
+    k8s = kubernetes.kubernetes
     with open(public_key_path, 'r', encoding='utf-8') as f:
         public_key = f.read()
         if not public_key.endswith('\n'):
             public_key += '\n'
 
         # Generate metadata
         secret_metadata = {
@@ -472,15 +472,15 @@
     """Sets up SSH authentication for RunPod.
     - Generates a new SSH key pair if one does not exist.
     - Adds the public SSH key to the user's RunPod account.
     """
     _, public_key_path = get_or_generate_keys()
     with open(public_key_path, 'r', encoding='UTF-8') as pub_key_file:
         public_key = pub_key_file.read().strip()
-        runpod.runpod().cli.groups.ssh.functions.add_ssh_key(public_key)
+        runpod.runpod.cli.groups.ssh.functions.add_ssh_key(public_key)
 
     return configure_ssh_info(config)
 
 
 def setup_fluidstack_authentication(config: Dict[str, Any]) -> Dict[str, Any]:
 
     get_or_generate_keys()
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/backends/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/backends/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/backends/backend.py` & `skypilot-nightly-1.0.0.dev20240403/sky/backends/backend.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/backends/backend_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/backends/backend_utils.py`

 * *Files 0% similar despite different names*

```diff
@@ -1935,5494 +1935,5493 @@
 000078e0: 6c61 7465 3a20 7374 722c 0a20 2020 2020  late: str,.     
 000078f0: 2020 2063 6c75 7374 6572 5f6e 616d 653a     cluster_name:
 00007900: 2073 7472 2c0a 2020 2020 2020 2020 6c6f   str,.        lo
 00007910: 6361 6c5f 7768 6565 6c5f 7061 7468 3a20  cal_wheel_path: 
 00007920: 7061 7468 6c69 622e 5061 7468 2c0a 2020  pathlib.Path,.  
 00007930: 2020 2020 2020 7768 6565 6c5f 6861 7368        wheel_hash
 00007940: 3a20 7374 722c 0a20 2020 2020 2020 2072  : str,.        r
-00007950: 6567 696f 6e3a 204f 7074 696f 6e61 6c5b  egion: Optional[
-00007960: 636c 6f75 6473 2e52 6567 696f 6e5d 203d  clouds.Region] =
-00007970: 204e 6f6e 652c 0a20 2020 2020 2020 207a   None,.        z
-00007980: 6f6e 6573 3a20 4f70 7469 6f6e 616c 5b4c  ones: Optional[L
-00007990: 6973 745b 636c 6f75 6473 2e5a 6f6e 655d  ist[clouds.Zone]
-000079a0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-000079b0: 2020 6472 7972 756e 3a20 626f 6f6c 203d    dryrun: bool =
-000079c0: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
-000079d0: 6b65 6570 5f6c 6175 6e63 685f 6669 656c  keep_launch_fiel
-000079e0: 6473 5f69 6e5f 6578 6973 7469 6e67 5f63  ds_in_existing_c
-000079f0: 6f6e 6669 673a 2062 6f6f 6c20 3d20 5472  onfig: bool = Tr
-00007a00: 7565 2920 2d3e 2044 6963 745b 7374 722c  ue) -> Dict[str,
-00007a10: 2073 7472 5d3a 0a20 2020 2022 2222 4669   str]:.    """Fi
-00007a20: 6c6c 7320 696e 2063 6c75 7374 6572 2063  lls in cluster c
-00007a30: 6f6e 6669 6775 7261 7469 6f6e 2074 656d  onfiguration tem
-00007a40: 706c 6174 6573 2061 6e64 2077 7269 7465  plates and write
-00007a50: 7320 7468 656d 206f 7574 2e0a 0a20 2020  s them out...   
-00007a60: 2052 6574 7572 6e73 3a20 7b70 726f 7669   Returns: {provi
-00007a70: 7369 6f6e 6572 3a20 7061 7468 2074 6f20  sioner: path to 
-00007a80: 7961 6d6c 2c20 7468 6520 7072 6f76 6973  yaml, the provis
-00007a90: 696f 6e69 6e67 2073 7065 637d 2e0a 2020  ioning spec}..  
-00007aa0: 2020 2020 2770 726f 7669 7369 6f6e 6572      'provisioner
-00007ab0: 2720 6361 6e20 6265 0a20 2020 2020 2020  ' can be.       
-00007ac0: 202d 2027 7261 7927 0a20 2020 2020 2020   - 'ray'.       
-00007ad0: 202d 2027 7470 752d 6372 6561 7465 2d73   - 'tpu-create-s
-00007ae0: 6372 6970 7427 2028 6966 2054 5055 2069  cript' (if TPU i
-00007af0: 7320 7265 7175 6573 7465 6429 0a20 2020  s requested).   
-00007b00: 2020 2020 202d 2027 7470 752d 6465 6c65       - 'tpu-dele
-00007b10: 7465 2d73 6372 6970 7427 2028 6966 2054  te-script' (if T
-00007b20: 5055 2069 7320 7265 7175 6573 7465 6429  PU is requested)
-00007b30: 0a20 2020 2052 6169 7365 733a 0a20 2020  .    Raises:.   
-00007b40: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
-00007b50: 5265 736f 7572 6365 7355 6e61 7661 696c  ResourcesUnavail
-00007b60: 6162 6c65 4572 726f 723a 2069 6620 7468  ableError: if th
-00007b70: 6520 7265 6769 6f6e 2f7a 6f6e 6573 2072  e region/zones r
-00007b80: 6571 7565 7374 6564 2064 6f65 730a 2020  equested does.  
-00007b90: 2020 2020 2020 2020 2020 6e6f 7420 6170            not ap
-00007ba0: 7065 6172 2069 6e20 7468 6520 6361 7461  pear in the cata
-00007bb0: 6c6f 672c 206f 7220 616e 2073 7368 5f70  log, or an ssh_p
-00007bc0: 726f 7879 5f63 6f6d 6d61 6e64 2069 7320  roxy_command is 
-00007bd0: 7370 6563 6966 6965 6420 6275 740a 2020  specified but.  
-00007be0: 2020 2020 2020 2020 2020 6e6f 7420 666f            not fo
-00007bf0: 7220 7468 6520 6769 7665 6e20 7265 6769  r the given regi
-00007c00: 6f6e 2c20 6f72 2047 5055 7320 6172 6520  on, or GPUs are 
-00007c10: 7265 7175 6573 7465 6420 696e 2061 204b  requested in a K
-00007c20: 7562 6572 6e65 7465 730a 2020 2020 2020  ubernetes.      
-00007c30: 2020 2020 2020 636c 7573 7465 7220 6275        cluster bu
-00007c40: 7420 7468 6520 636c 7573 7465 7220 646f  t the cluster do
-00007c50: 6573 206e 6f74 2068 6176 6520 6e6f 6465  es not have node
-00007c60: 7320 6c61 6265 6c65 6420 7769 7468 2047  s labeled with G
-00007c70: 5055 2074 7970 6573 2e0a 2020 2020 2020  PU types..      
-00007c80: 2020 6578 6365 7074 696f 6e73 2e49 6e76    exceptions.Inv
-00007c90: 616c 6964 436c 6f75 6443 6f6e 6669 6773  alidCloudConfigs
-00007ca0: 3a20 6966 2074 6865 2075 7365 7220 7370  : if the user sp
-00007cb0: 6563 6966 6965 7320 736f 6d65 2063 6f6e  ecifies some con
-00007cc0: 6669 6720 666f 7220 7468 650a 2020 2020  fig for the.    
-00007cd0: 2020 2020 2020 2020 636c 6f75 6420 7468          cloud th
-00007ce0: 6174 2069 7320 6e6f 7420 7661 6c69 642c  at is not valid,
-00007cf0: 2065 2e67 2e20 7265 6d6f 7465 5f69 6465   e.g. remote_ide
-00007d00: 6e74 6974 793a 2053 4552 5649 4345 5f41  ntity: SERVICE_A
-00007d10: 4343 4f55 4e54 0a20 2020 2020 2020 2020  CCOUNT.         
-00007d20: 2020 2066 6f72 2061 2063 6c6f 7564 2074     for a cloud t
-00007d30: 6861 7420 646f 6573 206e 6f74 2073 7570  hat does not sup
-00007d40: 706f 7274 2069 742c 2074 6865 2063 616c  port it, the cal
-00007d50: 6c65 7220 7368 6f75 6c64 2073 6b69 7020  ler should skip 
-00007d60: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-00007d70: 636c 6f75 6420 696e 2074 6869 7320 6361  cloud in this ca
-00007d80: 7365 2e0a 2020 2020 2222 220a 2020 2020  se..    """.    
-00007d90: 2320 7461 736b 2e62 6573 745f 7265 736f  # task.best_reso
-00007da0: 7572 6365 7320 6d61 7920 6e6f 7420 6265  urces may not be
-00007db0: 2065 7175 616c 2074 6f20 746f 5f70 726f   equal to to_pro
-00007dc0: 7669 7369 6f6e 2069 6620 7468 6520 7573  vision if the us
-00007dd0: 6572 0a20 2020 2023 2069 7320 7275 6e6e  er.    # is runn
-00007de0: 696e 6720 6120 6a6f 6220 7769 7468 206c  ing a job with l
-00007df0: 6573 7320 7265 736f 7572 6365 7320 7468  ess resources th
-00007e00: 616e 2074 6865 2063 6c75 7374 6572 2068  an the cluster h
-00007e10: 6173 2e0a 2020 2020 636c 6f75 6420 3d20  as..    cloud = 
-00007e20: 746f 5f70 726f 7669 7369 6f6e 2e63 6c6f  to_provision.clo
-00007e30: 7564 0a20 2020 2061 7373 6572 7420 636c  ud.    assert cl
-00007e40: 6f75 6420 6973 206e 6f74 204e 6f6e 652c  oud is not None,
-00007e50: 2074 6f5f 7072 6f76 6973 696f 6e0a 0a20   to_provision.. 
-00007e60: 2020 2063 6c75 7374 6572 5f6e 616d 655f     cluster_name_
-00007e70: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
-00007e80: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
-00007e90: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
-00007ea0: 7564 280a 2020 2020 2020 2020 636c 7573  ud(.        clus
-00007eb0: 7465 725f 6e61 6d65 2c20 6d61 785f 6c65  ter_name, max_le
-00007ec0: 6e67 7468 3d63 6c6f 7564 2e6d 6178 5f63  ngth=cloud.max_c
-00007ed0: 6c75 7374 6572 5f6e 616d 655f 6c65 6e67  luster_name_leng
-00007ee0: 7468 2829 290a 0a20 2020 2023 2054 6869  th())..    # Thi
-00007ef0: 7320 6361 6e20 7261 6973 6520 6120 5265  s can raise a Re
-00007f00: 736f 7572 6365 7355 6e61 7661 696c 6162  sourcesUnavailab
-00007f10: 6c65 4572 726f 7220 7768 656e 3a0a 2020  leError when:.  
-00007f20: 2020 2320 202a 2054 6865 2072 6567 696f    #  * The regio
-00007f30: 6e2f 7a6f 6e65 7320 7265 7175 6573 7465  n/zones requeste
-00007f40: 6420 646f 6573 206e 6f74 2061 7070 6561  d does not appea
-00007f50: 7220 696e 2074 6865 2063 6174 616c 6f67  r in the catalog
-00007f60: 2e20 4974 2063 616e 2062 650a 2020 2020  . It can be.    
-00007f70: 2320 2020 2074 7269 6767 6572 6564 2069  #    triggered i
-00007f80: 6620 7468 6520 7573 6572 2063 6861 6e67  f the user chang
-00007f90: 6564 2074 6865 2063 6174 616c 6f67 2066  ed the catalog f
-00007fa0: 696c 6520 7768 696c 6520 7468 6572 6520  ile while there 
-00007fb0: 6973 2061 2063 6c75 7374 6572 0a20 2020  is a cluster.   
-00007fc0: 2023 2020 2020 696e 2074 6865 2072 656d   #    in the rem
-00007fd0: 6f76 6564 2072 6567 696f 6e2f 7a6f 6e65  oved region/zone
-00007fe0: 2e0a 2020 2020 2320 202a 2047 5055 7320  ..    #  * GPUs 
-00007ff0: 6172 6520 7265 7175 6573 7465 6420 696e  are requested in
-00008000: 2061 204b 7562 6572 6e65 7465 7320 636c   a Kubernetes cl
-00008010: 7573 7465 7220 6275 7420 7468 6520 636c  uster but the cl
-00008020: 7573 7465 7220 646f 6573 206e 6f74 0a20  uster does not. 
-00008030: 2020 2023 2020 2020 6861 7665 206e 6f64     #    have nod
-00008040: 6573 206c 6162 656c 6564 2077 6974 6820  es labeled with 
-00008050: 4750 5520 7479 7065 732e 0a20 2020 2023  GPU types..    #
-00008060: 0a20 2020 2023 2054 4f44 4f28 7a68 7775  .    # TODO(zhwu
-00008070: 293a 2057 6520 7368 6f75 6c64 2063 6861  ): We should cha
-00008080: 6e67 6520 7468 6520 6578 6365 7074 696f  nge the exceptio
-00008090: 6e20 7479 7065 2074 6f20 6120 6d6f 7265  n type to a more
-000080a0: 2073 7065 6369 6669 6320 6f6e 652c 2061   specific one, a
-000080b0: 730a 2020 2020 2320 7468 6520 5265 736f  s.    # the Reso
-000080c0: 7572 6365 7355 6e61 7661 696c 6162 6c65  urcesUnavailable
-000080d0: 4572 726f 7220 6973 206f 7665 726c 7920  Error is overly 
-000080e0: 7573 6564 2e20 416c 736f 2c20 6974 2077  used. Also, it w
-000080f0: 6f75 6c64 2062 6520 6265 7474 6572 2074  ould be better t
-00008100: 6f0a 2020 2020 2320 6d6f 7665 2074 6865  o.    # move the
-00008110: 2063 6865 636b 206f 7574 206f 6620 7468   check out of th
-00008120: 6973 2066 756e 6374 696f 6e2c 2069 2e65  is function, i.e
-00008130: 2e20 7468 6520 6361 6c6c 6572 2073 686f  . the caller sho
-00008140: 756c 6420 6265 2072 6573 706f 6e73 6962  uld be responsib
-00008150: 6c65 0a20 2020 2023 2066 6f72 2074 6865  le.    # for the
-00008160: 2076 616c 6964 6174 696f 6e2e 0a20 2020   validation..   
-00008170: 2023 2054 4f44 4f28 7469 616e 293a 204d   # TODO(tian): M
-00008180: 6f76 6520 6d6f 7265 2063 6c6f 7564 2061  ove more cloud a
-00008190: 676e 6f73 7469 6320 7661 7273 2074 6f20  gnostic vars to 
-000081a0: 7265 736f 7572 6365 732e 7079 2e0a 2020  resources.py..  
-000081b0: 2020 7265 736f 7572 6365 735f 7661 7273    resources_vars
-000081c0: 203d 2074 6f5f 7072 6f76 6973 696f 6e2e   = to_provision.
-000081d0: 6d61 6b65 5f64 6570 6c6f 795f 7661 7269  make_deploy_vari
-000081e0: 6162 6c65 7328 636c 7573 7465 725f 6e61  ables(cluster_na
-000081f0: 6d65 5f6f 6e5f 636c 6f75 642c 0a20 2020  me_on_cloud,.   
+00007950: 6567 696f 6e3a 2063 6c6f 7564 732e 5265  egion: clouds.Re
+00007960: 6769 6f6e 2c0a 2020 2020 2020 2020 7a6f  gion,.        zo
+00007970: 6e65 733a 204f 7074 696f 6e61 6c5b 4c69  nes: Optional[Li
+00007980: 7374 5b63 6c6f 7564 732e 5a6f 6e65 5d5d  st[clouds.Zone]]
+00007990: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+000079a0: 2064 7279 7275 6e3a 2062 6f6f 6c20 3d20   dryrun: bool = 
+000079b0: 4661 6c73 652c 0a20 2020 2020 2020 206b  False,.        k
+000079c0: 6565 705f 6c61 756e 6368 5f66 6965 6c64  eep_launch_field
+000079d0: 735f 696e 5f65 7869 7374 696e 675f 636f  s_in_existing_co
+000079e0: 6e66 6967 3a20 626f 6f6c 203d 2054 7275  nfig: bool = Tru
+000079f0: 6529 202d 3e20 4469 6374 5b73 7472 2c20  e) -> Dict[str, 
+00007a00: 7374 725d 3a0a 2020 2020 2222 2246 696c  str]:.    """Fil
+00007a10: 6c73 2069 6e20 636c 7573 7465 7220 636f  ls in cluster co
+00007a20: 6e66 6967 7572 6174 696f 6e20 7465 6d70  nfiguration temp
+00007a30: 6c61 7465 7320 616e 6420 7772 6974 6573  lates and writes
+00007a40: 2074 6865 6d20 6f75 742e 0a0a 2020 2020   them out...    
+00007a50: 5265 7475 726e 733a 207b 7072 6f76 6973  Returns: {provis
+00007a60: 696f 6e65 723a 2070 6174 6820 746f 2079  ioner: path to y
+00007a70: 616d 6c2c 2074 6865 2070 726f 7669 7369  aml, the provisi
+00007a80: 6f6e 696e 6720 7370 6563 7d2e 0a20 2020  oning spec}..   
+00007a90: 2020 2027 7072 6f76 6973 696f 6e65 7227     'provisioner'
+00007aa0: 2063 616e 2062 650a 2020 2020 2020 2020   can be.        
+00007ab0: 2d20 2772 6179 270a 2020 2020 2020 2020  - 'ray'.        
+00007ac0: 2d20 2774 7075 2d63 7265 6174 652d 7363  - 'tpu-create-sc
+00007ad0: 7269 7074 2720 2869 6620 5450 5520 6973  ript' (if TPU is
+00007ae0: 2072 6571 7565 7374 6564 290a 2020 2020   requested).    
+00007af0: 2020 2020 2d20 2774 7075 2d64 656c 6574      - 'tpu-delet
+00007b00: 652d 7363 7269 7074 2720 2869 6620 5450  e-script' (if TP
+00007b10: 5520 6973 2072 6571 7565 7374 6564 290a  U is requested).
+00007b20: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+00007b30: 2020 2020 6578 6365 7074 696f 6e73 2e52      exceptions.R
+00007b40: 6573 6f75 7263 6573 556e 6176 6169 6c61  esourcesUnavaila
+00007b50: 626c 6545 7272 6f72 3a20 6966 2074 6865  bleError: if the
+00007b60: 2072 6567 696f 6e2f 7a6f 6e65 7320 7265   region/zones re
+00007b70: 7175 6573 7465 6420 646f 6573 0a20 2020  quested does.   
+00007b80: 2020 2020 2020 2020 206e 6f74 2061 7070           not app
+00007b90: 6561 7220 696e 2074 6865 2063 6174 616c  ear in the catal
+00007ba0: 6f67 2c20 6f72 2061 6e20 7373 685f 7072  og, or an ssh_pr
+00007bb0: 6f78 795f 636f 6d6d 616e 6420 6973 2073  oxy_command is s
+00007bc0: 7065 6369 6669 6564 2062 7574 0a20 2020  pecified but.   
+00007bd0: 2020 2020 2020 2020 206e 6f74 2066 6f72           not for
+00007be0: 2074 6865 2067 6976 656e 2072 6567 696f   the given regio
+00007bf0: 6e2c 206f 7220 4750 5573 2061 7265 2072  n, or GPUs are r
+00007c00: 6571 7565 7374 6564 2069 6e20 6120 4b75  equested in a Ku
+00007c10: 6265 726e 6574 6573 0a20 2020 2020 2020  bernetes.       
+00007c20: 2020 2020 2063 6c75 7374 6572 2062 7574       cluster but
+00007c30: 2074 6865 2063 6c75 7374 6572 2064 6f65   the cluster doe
+00007c40: 7320 6e6f 7420 6861 7665 206e 6f64 6573  s not have nodes
+00007c50: 206c 6162 656c 6564 2077 6974 6820 4750   labeled with GP
+00007c60: 5520 7479 7065 732e 0a20 2020 2020 2020  U types..       
+00007c70: 2065 7863 6570 7469 6f6e 732e 496e 7661   exceptions.Inva
+00007c80: 6c69 6443 6c6f 7564 436f 6e66 6967 733a  lidCloudConfigs:
+00007c90: 2069 6620 7468 6520 7573 6572 2073 7065   if the user spe
+00007ca0: 6369 6669 6573 2073 6f6d 6520 636f 6e66  cifies some conf
+00007cb0: 6967 2066 6f72 2074 6865 0a20 2020 2020  ig for the.     
+00007cc0: 2020 2020 2020 2063 6c6f 7564 2074 6861         cloud tha
+00007cd0: 7420 6973 206e 6f74 2076 616c 6964 2c20  t is not valid, 
+00007ce0: 652e 672e 2072 656d 6f74 655f 6964 656e  e.g. remote_iden
+00007cf0: 7469 7479 3a20 5345 5256 4943 455f 4143  tity: SERVICE_AC
+00007d00: 434f 554e 540a 2020 2020 2020 2020 2020  COUNT.          
+00007d10: 2020 666f 7220 6120 636c 6f75 6420 7468    for a cloud th
+00007d20: 6174 2064 6f65 7320 6e6f 7420 7375 7070  at does not supp
+00007d30: 6f72 7420 6974 2c20 7468 6520 6361 6c6c  ort it, the call
+00007d40: 6572 2073 686f 756c 6420 736b 6970 2074  er should skip t
+00007d50: 6865 0a20 2020 2020 2020 2020 2020 2063  he.            c
+00007d60: 6c6f 7564 2069 6e20 7468 6973 2063 6173  loud in this cas
+00007d70: 652e 0a20 2020 2022 2222 0a20 2020 2023  e..    """.    #
+00007d80: 2074 6173 6b2e 6265 7374 5f72 6573 6f75   task.best_resou
+00007d90: 7263 6573 206d 6179 206e 6f74 2062 6520  rces may not be 
+00007da0: 6571 7561 6c20 746f 2074 6f5f 7072 6f76  equal to to_prov
+00007db0: 6973 696f 6e20 6966 2074 6865 2075 7365  ision if the use
+00007dc0: 720a 2020 2020 2320 6973 2072 756e 6e69  r.    # is runni
+00007dd0: 6e67 2061 206a 6f62 2077 6974 6820 6c65  ng a job with le
+00007de0: 7373 2072 6573 6f75 7263 6573 2074 6861  ss resources tha
+00007df0: 6e20 7468 6520 636c 7573 7465 7220 6861  n the cluster ha
+00007e00: 732e 0a20 2020 2063 6c6f 7564 203d 2074  s..    cloud = t
+00007e10: 6f5f 7072 6f76 6973 696f 6e2e 636c 6f75  o_provision.clou
+00007e20: 640a 2020 2020 6173 7365 7274 2063 6c6f  d.    assert clo
+00007e30: 7564 2069 7320 6e6f 7420 4e6f 6e65 2c20  ud is not None, 
+00007e40: 746f 5f70 726f 7669 7369 6f6e 0a0a 2020  to_provision..  
+00007e50: 2020 636c 7573 7465 725f 6e61 6d65 5f6f    cluster_name_o
+00007e60: 6e5f 636c 6f75 6420 3d20 636f 6d6d 6f6e  n_cloud = common
+00007e70: 5f75 7469 6c73 2e6d 616b 655f 636c 7573  _utils.make_clus
+00007e80: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
+00007e90: 6428 0a20 2020 2020 2020 2063 6c75 7374  d(.        clust
+00007ea0: 6572 5f6e 616d 652c 206d 6178 5f6c 656e  er_name, max_len
+00007eb0: 6774 683d 636c 6f75 642e 6d61 785f 636c  gth=cloud.max_cl
+00007ec0: 7573 7465 725f 6e61 6d65 5f6c 656e 6774  uster_name_lengt
+00007ed0: 6828 2929 0a0a 2020 2020 2320 5468 6973  h())..    # This
+00007ee0: 2063 616e 2072 6169 7365 2061 2052 6573   can raise a Res
+00007ef0: 6f75 7263 6573 556e 6176 6169 6c61 626c  ourcesUnavailabl
+00007f00: 6545 7272 6f72 2077 6865 6e3a 0a20 2020  eError when:.   
+00007f10: 2023 2020 2a20 5468 6520 7265 6769 6f6e   #  * The region
+00007f20: 2f7a 6f6e 6573 2072 6571 7565 7374 6564  /zones requested
+00007f30: 2064 6f65 7320 6e6f 7420 6170 7065 6172   does not appear
+00007f40: 2069 6e20 7468 6520 6361 7461 6c6f 672e   in the catalog.
+00007f50: 2049 7420 6361 6e20 6265 0a20 2020 2023   It can be.    #
+00007f60: 2020 2020 7472 6967 6765 7265 6420 6966      triggered if
+00007f70: 2074 6865 2075 7365 7220 6368 616e 6765   the user change
+00007f80: 6420 7468 6520 6361 7461 6c6f 6720 6669  d the catalog fi
+00007f90: 6c65 2077 6869 6c65 2074 6865 7265 2069  le while there i
+00007fa0: 7320 6120 636c 7573 7465 720a 2020 2020  s a cluster.    
+00007fb0: 2320 2020 2069 6e20 7468 6520 7265 6d6f  #    in the remo
+00007fc0: 7665 6420 7265 6769 6f6e 2f7a 6f6e 652e  ved region/zone.
+00007fd0: 0a20 2020 2023 2020 2a20 4750 5573 2061  .    #  * GPUs a
+00007fe0: 7265 2072 6571 7565 7374 6564 2069 6e20  re requested in 
+00007ff0: 6120 4b75 6265 726e 6574 6573 2063 6c75  a Kubernetes clu
+00008000: 7374 6572 2062 7574 2074 6865 2063 6c75  ster but the clu
+00008010: 7374 6572 2064 6f65 7320 6e6f 740a 2020  ster does not.  
+00008020: 2020 2320 2020 2068 6176 6520 6e6f 6465    #    have node
+00008030: 7320 6c61 6265 6c65 6420 7769 7468 2047  s labeled with G
+00008040: 5055 2074 7970 6573 2e0a 2020 2020 230a  PU types..    #.
+00008050: 2020 2020 2320 544f 444f 287a 6877 7529      # TODO(zhwu)
+00008060: 3a20 5765 2073 686f 756c 6420 6368 616e  : We should chan
+00008070: 6765 2074 6865 2065 7863 6570 7469 6f6e  ge the exception
+00008080: 2074 7970 6520 746f 2061 206d 6f72 6520   type to a more 
+00008090: 7370 6563 6966 6963 206f 6e65 2c20 6173  specific one, as
+000080a0: 0a20 2020 2023 2074 6865 2052 6573 6f75  .    # the Resou
+000080b0: 7263 6573 556e 6176 6169 6c61 626c 6545  rcesUnavailableE
+000080c0: 7272 6f72 2069 7320 6f76 6572 6c79 2075  rror is overly u
+000080d0: 7365 642e 2041 6c73 6f2c 2069 7420 776f  sed. Also, it wo
+000080e0: 756c 6420 6265 2062 6574 7465 7220 746f  uld be better to
+000080f0: 0a20 2020 2023 206d 6f76 6520 7468 6520  .    # move the 
+00008100: 6368 6563 6b20 6f75 7420 6f66 2074 6869  check out of thi
+00008110: 7320 6675 6e63 7469 6f6e 2c20 692e 652e  s function, i.e.
+00008120: 2074 6865 2063 616c 6c65 7220 7368 6f75   the caller shou
+00008130: 6c64 2062 6520 7265 7370 6f6e 7369 626c  ld be responsibl
+00008140: 650a 2020 2020 2320 666f 7220 7468 6520  e.    # for the 
+00008150: 7661 6c69 6461 7469 6f6e 2e0a 2020 2020  validation..    
+00008160: 2320 544f 444f 2874 6961 6e29 3a20 4d6f  # TODO(tian): Mo
+00008170: 7665 206d 6f72 6520 636c 6f75 6420 6167  ve more cloud ag
+00008180: 6e6f 7374 6963 2076 6172 7320 746f 2072  nostic vars to r
+00008190: 6573 6f75 7263 6573 2e70 792e 0a20 2020  esources.py..   
+000081a0: 2072 6573 6f75 7263 6573 5f76 6172 7320   resources_vars 
+000081b0: 3d20 746f 5f70 726f 7669 7369 6f6e 2e6d  = to_provision.m
+000081c0: 616b 655f 6465 706c 6f79 5f76 6172 6961  ake_deploy_varia
+000081d0: 626c 6573 2863 6c75 7374 6572 5f6e 616d  bles(cluster_nam
+000081e0: 655f 6f6e 5f63 6c6f 7564 2c0a 2020 2020  e_on_cloud,.    
+000081f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00008200: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00008210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008230: 2020 2020 2072 6567 696f 6e2c 207a 6f6e       region, zon
-00008240: 6573 2c20 6472 7972 756e 290a 2020 2020  es, dryrun).    
-00008250: 636f 6e66 6967 5f64 6963 7420 3d20 7b7d  config_dict = {}
-00008260: 0a0a 2020 2020 7370 6563 6966 6963 5f72  ..    specific_r
-00008270: 6573 6572 7661 7469 6f6e 7320 3d20 7365  eservations = se
-00008280: 7428 0a20 2020 2020 2020 2073 6b79 7069  t(.        skypi
-00008290: 6c6f 745f 636f 6e66 6967 2e67 6574 5f6e  lot_config.get_n
-000082a0: 6573 7465 6428 0a20 2020 2020 2020 2020  ested(.         
-000082b0: 2020 2028 7374 7228 746f 5f70 726f 7669     (str(to_provi
-000082c0: 7369 6f6e 2e63 6c6f 7564 292e 6c6f 7765  sion.cloud).lowe
-000082d0: 7228 292c 2027 7370 6563 6966 6963 5f72  r(), 'specific_r
-000082e0: 6573 6572 7661 7469 6f6e 7327 292c 2073  eservations'), s
-000082f0: 6574 2829 2929 0a0a 2020 2020 6173 7365  et()))..    asse
-00008300: 7274 2063 6c75 7374 6572 5f6e 616d 6520  rt cluster_name 
-00008310: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
-00008320: 6578 636c 7564 6564 5f63 6c6f 7564 7320  excluded_clouds 
-00008330: 3d20 5b5d 0a20 2020 2072 656d 6f74 655f  = [].    remote_
-00008340: 6964 656e 7469 7479 203d 2073 6b79 7069  identity = skypi
-00008350: 6c6f 745f 636f 6e66 6967 2e67 6574 5f6e  lot_config.get_n
-00008360: 6573 7465 6428 0a20 2020 2020 2020 2028  ested(.        (
-00008370: 7374 7228 636c 6f75 6429 2e6c 6f77 6572  str(cloud).lower
-00008380: 2829 2c20 2772 656d 6f74 655f 6964 656e  (), 'remote_iden
-00008390: 7469 7479 2729 2c20 274c 4f43 414c 5f43  tity'), 'LOCAL_C
-000083a0: 5245 4445 4e54 4941 4c53 2729 0a20 2020  REDENTIALS').   
-000083b0: 2069 6620 7265 6d6f 7465 5f69 6465 6e74   if remote_ident
-000083c0: 6974 7920 3d3d 2027 5345 5256 4943 455f  ity == 'SERVICE_
-000083d0: 4143 434f 554e 5427 3a0a 2020 2020 2020  ACCOUNT':.      
-000083e0: 2020 6966 206e 6f74 2063 6c6f 7564 2e73    if not cloud.s
-000083f0: 7570 706f 7274 735f 7365 7276 6963 655f  upports_service_
-00008400: 6163 636f 756e 745f 6f6e 5f72 656d 6f74  account_on_remot
-00008410: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
-00008420: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
-00008430: 732e 496e 7661 6c69 6443 6c6f 7564 436f  s.InvalidCloudCo
-00008440: 6e66 6967 7328 0a20 2020 2020 2020 2020  nfigs(.         
-00008450: 2020 2020 2020 2027 7265 6d6f 7465 5f69         'remote_i
-00008460: 6465 6e74 6974 793a 2053 4552 5649 4345  dentity: SERVICE
-00008470: 5f41 4343 4f55 4e54 2069 7320 7370 6563  _ACCOUNT is spec
-00008480: 6966 6965 6420 696e 2027 0a20 2020 2020  ified in '.     
-00008490: 2020 2020 2020 2020 2020 2066 277b 736b             f'{sk
-000084a0: 7970 696c 6f74 5f63 6f6e 6669 672e 6c6f  ypilot_config.lo
-000084b0: 6164 6564 5f63 6f6e 6669 675f 7061 7468  aded_config_path
-000084c0: 2172 7d20 666f 7220 7b63 6c6f 7564 7d2c  !r} for {cloud},
-000084d0: 2062 7574 2069 7420 270a 2020 2020 2020   but it '.      
-000084e0: 2020 2020 2020 2020 2020 2769 7320 6e6f            'is no
-000084f0: 7420 7375 7070 6f72 7465 6420 6279 2074  t supported by t
-00008500: 6869 7320 636c 6f75 642e 2052 656d 6f76  his cloud. Remov
-00008510: 6520 7468 6520 636f 6e66 6967 206f 7220  e the config or 
-00008520: 7365 743a 2027 0a20 2020 2020 2020 2020  set: '.         
-00008530: 2020 2020 2020 2027 6072 656d 6f74 655f         '`remote_
-00008540: 6964 656e 7469 7479 3a20 4c4f 4341 4c5f  identity: LOCAL_
-00008550: 4352 4544 454e 5449 414c 5360 2e27 290a  CREDENTIALS`.').
-00008560: 2020 2020 2020 2020 6578 636c 7564 6564          excluded
-00008570: 5f63 6c6f 7564 7320 3d20 5b63 6c6f 7564  _clouds = [cloud
-00008580: 5d0a 2020 2020 6372 6564 656e 7469 616c  ].    credential
-00008590: 7320 3d20 736b 795f 6368 6563 6b2e 6765  s = sky_check.ge
-000085a0: 745f 636c 6f75 645f 6372 6564 656e 7469  t_cloud_credenti
-000085b0: 616c 5f66 696c 655f 6d6f 756e 7473 2865  al_file_mounts(e
-000085c0: 7863 6c75 6465 645f 636c 6f75 6473 290a  xcluded_clouds).
-000085d0: 0a20 2020 2061 7574 685f 636f 6e66 6967  .    auth_config
-000085e0: 203d 207b 2773 7368 5f70 7269 7661 7465   = {'ssh_private
-000085f0: 5f6b 6579 273a 2061 7574 682e 5052 4956  _key': auth.PRIV
-00008600: 4154 455f 5353 485f 4b45 595f 5041 5448  ATE_SSH_KEY_PATH
-00008610: 7d0a 2020 2020 7265 6769 6f6e 5f6e 616d  }.    region_nam
-00008620: 6520 3d20 7265 736f 7572 6365 735f 7661  e = resources_va
-00008630: 7273 2e67 6574 2827 7265 6769 6f6e 2729  rs.get('region')
-00008640: 0a0a 2020 2020 7961 6d6c 5f70 6174 6820  ..    yaml_path 
-00008650: 3d20 5f67 6574 5f79 616d 6c5f 7061 7468  = _get_yaml_path
-00008660: 5f66 726f 6d5f 636c 7573 7465 725f 6e61  _from_cluster_na
-00008670: 6d65 2863 6c75 7374 6572 5f6e 616d 6529  me(cluster_name)
-00008680: 0a0a 2020 2020 2320 5265 7472 6965 7665  ..    # Retrieve
-00008690: 2074 6865 2073 7368 5f70 726f 7879 5f63   the ssh_proxy_c
-000086a0: 6f6d 6d61 6e64 2066 6f72 2074 6865 2067  ommand for the g
-000086b0: 6976 656e 2063 6c6f 7564 202f 2072 6567  iven cloud / reg
-000086c0: 696f 6e2e 0a20 2020 2073 7368 5f70 726f  ion..    ssh_pro
-000086d0: 7879 5f63 6f6d 6d61 6e64 5f63 6f6e 6669  xy_command_confi
-000086e0: 6720 3d20 736b 7970 696c 6f74 5f63 6f6e  g = skypilot_con
-000086f0: 6669 672e 6765 745f 6e65 7374 6564 280a  fig.get_nested(.
-00008700: 2020 2020 2020 2020 2873 7472 2863 6c6f          (str(clo
-00008710: 7564 292e 6c6f 7765 7228 292c 2027 7373  ud).lower(), 'ss
-00008720: 685f 7072 6f78 795f 636f 6d6d 616e 6427  h_proxy_command'
-00008730: 292c 204e 6f6e 6529 0a20 2020 2069 6620  ), None).    if 
-00008740: 2869 7369 6e73 7461 6e63 6528 7373 685f  (isinstance(ssh_
-00008750: 7072 6f78 795f 636f 6d6d 616e 645f 636f  proxy_command_co
-00008760: 6e66 6967 2c20 7374 7229 206f 720a 2020  nfig, str) or.  
-00008770: 2020 2020 2020 2020 2020 7373 685f 7072            ssh_pr
-00008780: 6f78 795f 636f 6d6d 616e 645f 636f 6e66  oxy_command_conf
-00008790: 6967 2069 7320 4e6f 6e65 293a 0a20 2020  ig is None):.   
-000087a0: 2020 2020 2073 7368 5f70 726f 7879 5f63       ssh_proxy_c
-000087b0: 6f6d 6d61 6e64 203d 2073 7368 5f70 726f  ommand = ssh_pro
-000087c0: 7879 5f63 6f6d 6d61 6e64 5f63 6f6e 6669  xy_command_confi
-000087d0: 670a 2020 2020 656c 7365 3a0a 2020 2020  g.    else:.    
-000087e0: 2020 2020 2320 7373 685f 7072 6f78 795f      # ssh_proxy_
-000087f0: 636f 6d6d 616e 645f 636f 6e66 6967 3a20  command_config: 
-00008800: 4469 6374 5b73 7472 2c20 7374 725d 2c20  Dict[str, str], 
-00008810: 7265 6769 6f6e 5f6e 616d 6520 2d3e 2063  region_name -> c
-00008820: 6f6d 6d61 6e64 0a20 2020 2020 2020 2023  ommand.        #
-00008830: 2054 6869 7320 7479 7065 2063 6865 636b   This type check
-00008840: 2069 7320 646f 6e65 2062 7920 736b 7970   is done by skyp
-00008850: 696c 6f74 5f63 6f6e 6669 6720 6174 2063  ilot_config at c
-00008860: 6f6e 6669 6720 6c6f 6164 2074 696d 652e  onfig load time.
-00008870: 0a0a 2020 2020 2020 2020 2320 5468 6572  ..        # Ther
-00008880: 6520 6172 6520 7477 6f20 6361 7365 733a  e are two cases:
-00008890: 0a20 2020 2020 2020 2069 6620 6b65 6570  .        if keep
-000088a0: 5f6c 6175 6e63 685f 6669 656c 6473 5f69  _launch_fields_i
-000088b0: 6e5f 6578 6973 7469 6e67 5f63 6f6e 6669  n_existing_confi
-000088c0: 673a 0a20 2020 2020 2020 2020 2020 2023  g:.            #
-000088d0: 2028 3129 2057 6527 7265 2072 652d 7072   (1) We're re-pr
-000088e0: 6f76 6973 696f 6e69 6e67 2061 6e20 6578  ovisioning an ex
-000088f0: 6973 7469 6e67 2063 6c75 7374 6572 2e0a  isting cluster..
-00008900: 2020 2020 2020 2020 2020 2020 230a 2020              #.  
-00008910: 2020 2020 2020 2020 2020 2320 5765 2075            # We u
-00008920: 7365 204e 6f6e 6520 666f 7220 7373 685f  se None for ssh_
-00008930: 7072 6f78 795f 636f 6d6d 616e 642c 2077  proxy_command, w
-00008940: 6869 6368 2077 696c 6c20 6265 2072 6573  hich will be res
-00008950: 746f 7265 6420 746f 2074 6865 0a20 2020  tored to the.   
-00008960: 2020 2020 2020 2020 2023 2063 6c75 7374           # clust
-00008970: 6572 2773 206f 7269 6769 6e61 6c20 7661  er's original va
-00008980: 6c75 6520 6c61 7465 7220 6279 205f 7265  lue later by _re
-00008990: 706c 6163 655f 7961 6d6c 5f64 6963 7473  place_yaml_dicts
-000089a0: 2829 2e0a 2020 2020 2020 2020 2020 2020  ()..            
-000089b0: 7373 685f 7072 6f78 795f 636f 6d6d 616e  ssh_proxy_comman
-000089c0: 6420 3d20 4e6f 6e65 0a20 2020 2020 2020  d = None.       
-000089d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000089e0: 2020 2023 2028 3229 2057 6527 7265 206c     # (2) We're l
-000089f0: 6175 6e63 6869 6e67 2061 206e 6577 2063  aunching a new c
-00008a00: 6c75 7374 6572 2e0a 2020 2020 2020 2020  luster..        
-00008a10: 2020 2020 230a 2020 2020 2020 2020 2020      #.          
-00008a20: 2020 2320 5265 736f 7572 6365 732e 6765    # Resources.ge
-00008a30: 745f 7661 6c69 645f 7265 6769 6f6e 735f  t_valid_regions_
-00008a40: 666f 725f 6c61 756e 6368 6162 6c65 2829  for_launchable()
-00008a50: 2072 6573 7065 6374 7320 7468 6520 6b65   respects the ke
-00008a60: 7973 2028 7265 6769 6f6e 7329 0a20 2020  ys (regions).   
-00008a70: 2020 2020 2020 2020 2023 2069 6e20 7373           # in ss
-00008a80: 685f 7072 6f78 795f 636f 6d6d 616e 6420  h_proxy_command 
-00008a90: 696e 2073 6b79 7069 6c6f 745f 636f 6e66  in skypilot_conf
-00008aa0: 6967 2e20 536f 2068 6572 6520 7765 2061  ig. So here we a
-00008ab0: 6464 2061 6e20 6173 7365 7274 2e0a 2020  dd an assert..  
-00008ac0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00008ad0: 2072 6567 696f 6e5f 6e61 6d65 2069 6e20   region_name in 
-00008ae0: 7373 685f 7072 6f78 795f 636f 6d6d 616e  ssh_proxy_comman
-00008af0: 645f 636f 6e66 6967 2c20 280a 2020 2020  d_config, (.    
-00008b00: 2020 2020 2020 2020 2020 2020 7265 6769              regi
-00008b10: 6f6e 5f6e 616d 652c 2073 7368 5f70 726f  on_name, ssh_pro
-00008b20: 7879 5f63 6f6d 6d61 6e64 5f63 6f6e 6669  xy_command_confi
-00008b30: 6729 0a20 2020 2020 2020 2020 2020 2073  g).            s
-00008b40: 7368 5f70 726f 7879 5f63 6f6d 6d61 6e64  sh_proxy_command
-00008b50: 203d 2073 7368 5f70 726f 7879 5f63 6f6d   = ssh_proxy_com
-00008b60: 6d61 6e64 5f63 6f6e 6669 675b 7265 6769  mand_config[regi
-00008b70: 6f6e 5f6e 616d 655d 0a20 2020 206c 6f67  on_name].    log
-00008b80: 6765 722e 6465 6275 6728 6627 5573 696e  ger.debug(f'Usin
-00008b90: 6720 7373 685f 7072 6f78 795f 636f 6d6d  g ssh_proxy_comm
-00008ba0: 616e 643a 207b 7373 685f 7072 6f78 795f  and: {ssh_proxy_
-00008bb0: 636f 6d6d 616e 6421 727d 2729 0a0a 2020  command!r}')..  
-00008bc0: 2020 2320 5573 6572 2d73 7570 706c 6965    # User-supplie
-00008bd0: 6420 696e 7374 616e 6365 2074 6167 732e  d instance tags.
-00008be0: 0a20 2020 2069 6e73 7461 6e63 655f 7461  .    instance_ta
-00008bf0: 6773 203d 207b 7d0a 2020 2020 696e 7374  gs = {}.    inst
-00008c00: 616e 6365 5f74 6167 7320 3d20 736b 7970  ance_tags = skyp
-00008c10: 696c 6f74 5f63 6f6e 6669 672e 6765 745f  ilot_config.get_
-00008c20: 6e65 7374 6564 280a 2020 2020 2020 2020  nested(.        
-00008c30: 2873 7472 2863 6c6f 7564 292e 6c6f 7765  (str(cloud).lowe
-00008c40: 7228 292c 2027 696e 7374 616e 6365 5f74  r(), 'instance_t
-00008c50: 6167 7327 292c 207b 7d29 0a20 2020 2023  ags'), {}).    #
-00008c60: 2069 6e73 7461 6e63 655f 7461 6773 2069   instance_tags i
-00008c70: 7320 6120 6469 6374 2c20 7768 6963 6820  s a dict, which 
-00008c80: 6973 2067 7561 7261 6e74 6565 6420 6279  is guaranteed by
-00008c90: 2074 6865 2074 7970 6520 6368 6563 6b20   the type check 
-00008ca0: 696e 0a20 2020 2023 2073 6368 656d 6173  in.    # schemas
-00008cb0: 2e70 790a 2020 2020 6173 7365 7274 2069  .py.    assert i
-00008cc0: 7369 6e73 7461 6e63 6528 696e 7374 616e  sinstance(instan
-00008cd0: 6365 5f74 6167 732c 2064 6963 7429 2c20  ce_tags, dict), 
-00008ce0: 696e 7374 616e 6365 5f74 6167 730a 0a20  instance_tags.. 
-00008cf0: 2020 2023 2044 756d 7020 7468 6520 5261     # Dump the Ra
-00008d00: 7920 706f 7274 7320 746f 2061 2066 696c  y ports to a fil
-00008d10: 6520 666f 7220 5261 7920 6a6f 6220 7375  e for Ray job su
-00008d20: 626d 6973 7369 6f6e 0a20 2020 2064 756d  bmission.    dum
-00008d30: 705f 706f 7274 5f63 6f6d 6d61 6e64 203d  p_port_command =
-00008d40: 2028 0a20 2020 2020 2020 2066 277b 636f   (.        f'{co
-00008d50: 6e73 7461 6e74 732e 534b 595f 5059 5448  nstants.SKY_PYTH
-00008d60: 4f4e 5f43 4d44 7d20 2d63 205c 2769 6d70  ON_CMD} -c \'imp
-00008d70: 6f72 7420 6a73 6f6e 2c20 6f73 3b20 6a73  ort json, os; js
-00008d80: 6f6e 2e64 756d 7028 7b63 6f6e 7374 616e  on.dump({constan
-00008d90: 7473 2e53 4b59 5f52 454d 4f54 455f 5241  ts.SKY_REMOTE_RA
-00008da0: 595f 504f 5254 5f44 4943 545f 5354 527d  Y_PORT_DICT_STR}
-00008db0: 2c20 270a 2020 2020 2020 2020 6627 6f70  , '.        f'op
-00008dc0: 656e 286f 732e 7061 7468 2e65 7870 616e  en(os.path.expan
-00008dd0: 6475 7365 7228 227b 636f 6e73 7461 6e74  duser("{constant
-00008de0: 732e 534b 595f 5245 4d4f 5445 5f52 4159  s.SKY_REMOTE_RAY
-00008df0: 5f50 4f52 545f 4649 4c45 7d22 292c 2022  _PORT_FILE}"), "
-00008e00: 7722 2c20 656e 636f 6469 6e67 3d22 7574  w", encoding="ut
-00008e10: 662d 3822 2929 5c27 270a 2020 2020 290a  f-8"))\''.    ).
-00008e20: 0a20 2020 2023 2055 7365 2061 2074 6d70  .    # Use a tmp
-00008e30: 2066 696c 6520 7061 7468 2074 6f20 6176   file path to av
-00008e40: 6f69 6420 696e 636f 6d70 6c65 7465 2059  oid incomplete Y
-00008e50: 414d 4c20 6669 6c65 2062 6569 6e67 2072  AML file being r
-00008e60: 652d 7573 6564 2069 6e20 7468 650a 2020  e-used in the.  
-00008e70: 2020 2320 6675 7475 7265 2e0a 2020 2020    # future..    
-00008e80: 746d 705f 7961 6d6c 5f70 6174 6820 3d20  tmp_yaml_path = 
-00008e90: 7961 6d6c 5f70 6174 6820 2b20 272e 746d  yaml_path + '.tm
-00008ea0: 7027 0a20 2020 2063 6f6d 6d6f 6e5f 7574  p'.    common_ut
-00008eb0: 696c 732e 6669 6c6c 5f74 656d 706c 6174  ils.fill_templat
-00008ec0: 6528 0a20 2020 2020 2020 2063 6c75 7374  e(.        clust
-00008ed0: 6572 5f63 6f6e 6669 675f 7465 6d70 6c61  er_config_templa
-00008ee0: 7465 2c0a 2020 2020 2020 2020 6469 6374  te,.        dict
-00008ef0: 280a 2020 2020 2020 2020 2020 2020 7265  (.            re
-00008f00: 736f 7572 6365 735f 7661 7273 2c0a 2020  sources_vars,.  
-00008f10: 2020 2020 2020 2020 2020 2a2a 7b0a 2020            **{.  
-00008f20: 2020 2020 2020 2020 2020 2020 2020 2763                'c
-00008f30: 6c75 7374 6572 5f6e 616d 655f 6f6e 5f63  luster_name_on_c
-00008f40: 6c6f 7564 273a 2063 6c75 7374 6572 5f6e  loud': cluster_n
-00008f50: 616d 655f 6f6e 5f63 6c6f 7564 2c0a 2020  ame_on_cloud,.  
-00008f60: 2020 2020 2020 2020 2020 2020 2020 276e                'n
-00008f70: 756d 5f6e 6f64 6573 273a 206e 756d 5f6e  um_nodes': num_n
-00008f80: 6f64 6573 2c0a 2020 2020 2020 2020 2020  odes,.          
-00008f90: 2020 2020 2020 2764 6973 6b5f 7369 7a65        'disk_size
-00008fa0: 273a 2074 6f5f 7072 6f76 6973 696f 6e2e  ': to_provision.
-00008fb0: 6469 736b 5f73 697a 652c 0a20 2020 2020  disk_size,.     
-00008fc0: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
-00008fd0: 7468 6520 6375 7272 656e 7420 636f 6465  the current code
-00008fe0: 2069 7320 7275 6e20 6279 2063 6f6e 7472   is run by contr
-00008ff0: 6f6c 6c65 722c 2070 726f 7061 6761 7465  oller, propagate
-00009000: 2074 6865 2072 6561 6c0a 2020 2020 2020   the real.      
-00009010: 2020 2020 2020 2020 2020 2320 6361 6c6c            # call
-00009020: 696e 6720 7573 6572 2077 6869 6368 2073  ing user which s
-00009030: 686f 756c 6427 7665 2062 6565 6e20 7061  hould've been pa
-00009040: 7373 6564 2069 6e20 6173 2074 6865 0a20  ssed in as the. 
-00009050: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00009060: 2053 4b59 5049 4c4f 545f 5553 4552 2065   SKYPILOT_USER e
-00009070: 6e76 2076 6172 2028 7365 650a 2020 2020  nv var (see.    
-00009080: 2020 2020 2020 2020 2020 2020 2320 636f              # co
-00009090: 6e74 726f 6c6c 6572 5f75 7469 6c73 2e73  ntroller_utils.s
-000090a0: 6861 7265 645f 636f 6e74 726f 6c6c 6572  hared_controller
-000090b0: 5f76 6172 735f 746f 5f66 696c 6c28 292e  _vars_to_fill().
-000090c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000090d0: 2027 7573 6572 273a 2063 6f6d 6d6f 6e5f   'user': common_
-000090e0: 7574 696c 732e 6765 745f 636c 6561 6e65  utils.get_cleane
-000090f0: 645f 7573 6572 6e61 6d65 280a 2020 2020  d_username(.    
-00009100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009110: 6f73 2e65 6e76 6972 6f6e 2e67 6574 2863  os.environ.get(c
-00009120: 6f6e 7374 616e 7473 2e55 5345 525f 454e  onstants.USER_EN
-00009130: 565f 5641 522c 2027 2729 292c 0a0a 2020  V_VAR, '')),..  
-00009140: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00009150: 4e65 7477 6f72 6b69 6e67 2063 6f6e 6669  Networking confi
-00009160: 6773 0a20 2020 2020 2020 2020 2020 2020  gs.             
-00009170: 2020 2027 7573 655f 696e 7465 726e 616c     'use_internal
-00009180: 5f69 7073 273a 2073 6b79 7069 6c6f 745f  _ips': skypilot_
-00009190: 636f 6e66 6967 2e67 6574 5f6e 6573 7465  config.get_neste
-000091a0: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-000091b0: 2020 2020 2020 2028 7374 7228 636c 6f75         (str(clou
-000091c0: 6429 2e6c 6f77 6572 2829 2c20 2775 7365  d).lower(), 'use
-000091d0: 5f69 6e74 6572 6e61 6c5f 6970 7327 292c  _internal_ips'),
-000091e0: 2046 616c 7365 292c 0a20 2020 2020 2020   False),.       
-000091f0: 2020 2020 2020 2020 2027 7373 685f 7072           'ssh_pr
-00009200: 6f78 795f 636f 6d6d 616e 6427 3a20 7373  oxy_command': ss
-00009210: 685f 7072 6f78 795f 636f 6d6d 616e 642c  h_proxy_command,
-00009220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009230: 2027 7670 635f 6e61 6d65 273a 2073 6b79   'vpc_name': sky
-00009240: 7069 6c6f 745f 636f 6e66 6967 2e67 6574  pilot_config.get
-00009250: 5f6e 6573 7465 6428 0a20 2020 2020 2020  _nested(.       
-00009260: 2020 2020 2020 2020 2020 2020 2028 7374               (st
-00009270: 7228 636c 6f75 6429 2e6c 6f77 6572 2829  r(cloud).lower()
-00009280: 2c20 2776 7063 5f6e 616d 6527 292c 204e  , 'vpc_name'), N
-00009290: 6f6e 6529 2c0a 0a20 2020 2020 2020 2020  one),..         
-000092a0: 2020 2020 2020 2023 2055 7365 722d 7375         # User-su
-000092b0: 7070 6c69 6564 2069 6e73 7461 6e63 6520  pplied instance 
-000092c0: 7461 6773 2e0a 2020 2020 2020 2020 2020  tags..          
-000092d0: 2020 2020 2020 2769 6e73 7461 6e63 655f        'instance_
-000092e0: 7461 6773 273a 2069 6e73 7461 6e63 655f  tags': instance_
-000092f0: 7461 6773 2c0a 2020 2020 2020 2020 2020  tags,.          
-00009300: 2020 2020 2020 2320 5468 6520 7265 7365        # The rese
-00009310: 7276 6174 696f 6e20 706f 6f6c 7320 7468  rvation pools th
-00009320: 6174 2073 7065 6369 6669 6564 2062 7920  at specified by 
-00009330: 7468 6520 7573 6572 2e20 5468 6973 2069  the user. This i
-00009340: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00009350: 2020 2320 6375 7272 656e 746c 7920 6f6e    # currently on
-00009360: 6c79 2075 7365 6420 6279 2047 4350 2e0a  ly used by GCP..
-00009370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009380: 2773 7065 6369 6669 635f 7265 7365 7276  'specific_reserv
-00009390: 6174 696f 6e73 273a 2073 7065 6369 6669  ations': specifi
-000093a0: 635f 7265 7365 7276 6174 696f 6e73 2c0a  c_reservations,.
-000093b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000093c0: 2023 2043 6f6e 6461 2073 6574 7570 0a20   # Conda setup. 
-000093d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000093e0: 636f 6e64 615f 696e 7374 616c 6c61 7469  conda_installati
-000093f0: 6f6e 5f63 6f6d 6d61 6e64 7327 3a0a 2020  on_commands':.  
-00009400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009410: 2020 636f 6e73 7461 6e74 732e 434f 4e44    constants.COND
-00009420: 415f 494e 5354 414c 4c41 5449 4f4e 5f43  A_INSTALLATION_C
-00009430: 4f4d 4d41 4e44 532c 0a20 2020 2020 2020  OMMANDS,.       
-00009440: 2020 2020 2020 2020 2023 2057 6520 7368           # We sh
-00009450: 6f75 6c64 206e 6f74 2075 7365 2060 2e66  ould not use `.f
-00009460: 6f72 6d61 7460 2c20 6173 2069 7420 636f  ormat`, as it co
-00009470: 6e74 6169 6e73 2027 7b7d 2720 6173 2074  ntains '{}' as t
-00009480: 6865 2062 6173 680a 2020 2020 2020 2020  he bash.        
-00009490: 2020 2020 2020 2020 2320 7379 6e74 6178          # syntax
-000094a0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000094b0: 2020 2772 6179 5f73 6b79 7069 6c6f 745f    'ray_skypilot_
-000094c0: 696e 7374 616c 6c61 7469 6f6e 5f63 6f6d  installation_com
-000094d0: 6d61 6e64 7327 3a0a 2020 2020 2020 2020  mands':.        
-000094e0: 2020 2020 2020 2020 2020 2020 2863 6f6e              (con
-000094f0: 7374 616e 7473 2e52 4159 5f53 4b59 5049  stants.RAY_SKYPI
-00009500: 4c4f 545f 494e 5354 414c 4c41 5449 4f4e  LOT_INSTALLATION
-00009510: 5f43 4f4d 4d41 4e44 532e 7265 706c 6163  _COMMANDS.replac
-00009520: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-00009530: 2020 2020 2020 2020 2020 2027 7b73 6b79             '{sky
-00009540: 5f77 6865 656c 5f68 6173 687d 272c 0a20  _wheel_hash}',. 
-00009550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009560: 2020 2020 2020 2077 6865 656c 5f68 6173         wheel_has
-00009570: 6829 2e72 6570 6c61 6365 2827 7b63 6c6f  h).replace('{clo
-00009580: 7564 7d27 2c0a 2020 2020 2020 2020 2020  ud}',.          
+00008220: 2020 2020 7265 6769 6f6e 2c20 7a6f 6e65      region, zone
+00008230: 732c 2064 7279 7275 6e29 0a20 2020 2063  s, dryrun).    c
+00008240: 6f6e 6669 675f 6469 6374 203d 207b 7d0a  onfig_dict = {}.
+00008250: 0a20 2020 2073 7065 6369 6669 635f 7265  .    specific_re
+00008260: 7365 7276 6174 696f 6e73 203d 2073 6574  servations = set
+00008270: 280a 2020 2020 2020 2020 736b 7970 696c  (.        skypil
+00008280: 6f74 5f63 6f6e 6669 672e 6765 745f 6e65  ot_config.get_ne
+00008290: 7374 6564 280a 2020 2020 2020 2020 2020  sted(.          
+000082a0: 2020 2873 7472 2874 6f5f 7072 6f76 6973    (str(to_provis
+000082b0: 696f 6e2e 636c 6f75 6429 2e6c 6f77 6572  ion.cloud).lower
+000082c0: 2829 2c20 2773 7065 6369 6669 635f 7265  (), 'specific_re
+000082d0: 7365 7276 6174 696f 6e73 2729 2c20 7365  servations'), se
+000082e0: 7428 2929 290a 0a20 2020 2061 7373 6572  t()))..    asser
+000082f0: 7420 636c 7573 7465 725f 6e61 6d65 2069  t cluster_name i
+00008300: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2065  s not None.    e
+00008310: 7863 6c75 6465 645f 636c 6f75 6473 203d  xcluded_clouds =
+00008320: 205b 5d0a 2020 2020 7265 6d6f 7465 5f69   [].    remote_i
+00008330: 6465 6e74 6974 7920 3d20 736b 7970 696c  dentity = skypil
+00008340: 6f74 5f63 6f6e 6669 672e 6765 745f 6e65  ot_config.get_ne
+00008350: 7374 6564 280a 2020 2020 2020 2020 2873  sted(.        (s
+00008360: 7472 2863 6c6f 7564 292e 6c6f 7765 7228  tr(cloud).lower(
+00008370: 292c 2027 7265 6d6f 7465 5f69 6465 6e74  ), 'remote_ident
+00008380: 6974 7927 292c 2027 4c4f 4341 4c5f 4352  ity'), 'LOCAL_CR
+00008390: 4544 454e 5449 414c 5327 290a 2020 2020  EDENTIALS').    
+000083a0: 6966 2072 656d 6f74 655f 6964 656e 7469  if remote_identi
+000083b0: 7479 203d 3d20 2753 4552 5649 4345 5f41  ty == 'SERVICE_A
+000083c0: 4343 4f55 4e54 273a 0a20 2020 2020 2020  CCOUNT':.       
+000083d0: 2069 6620 6e6f 7420 636c 6f75 642e 7375   if not cloud.su
+000083e0: 7070 6f72 7473 5f73 6572 7669 6365 5f61  pports_service_a
+000083f0: 6363 6f75 6e74 5f6f 6e5f 7265 6d6f 7465  ccount_on_remote
+00008400: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00008410: 7261 6973 6520 6578 6365 7074 696f 6e73  raise exceptions
+00008420: 2e49 6e76 616c 6964 436c 6f75 6443 6f6e  .InvalidCloudCon
+00008430: 6669 6773 280a 2020 2020 2020 2020 2020  figs(.          
+00008440: 2020 2020 2020 2772 656d 6f74 655f 6964        'remote_id
+00008450: 656e 7469 7479 3a20 5345 5256 4943 455f  entity: SERVICE_
+00008460: 4143 434f 554e 5420 6973 2073 7065 6369  ACCOUNT is speci
+00008470: 6669 6564 2069 6e20 270a 2020 2020 2020  fied in '.      
+00008480: 2020 2020 2020 2020 2020 6627 7b73 6b79            f'{sky
+00008490: 7069 6c6f 745f 636f 6e66 6967 2e6c 6f61  pilot_config.loa
+000084a0: 6465 645f 636f 6e66 6967 5f70 6174 6821  ded_config_path!
+000084b0: 727d 2066 6f72 207b 636c 6f75 647d 2c20  r} for {cloud}, 
+000084c0: 6275 7420 6974 2027 0a20 2020 2020 2020  but it '.       
+000084d0: 2020 2020 2020 2020 2027 6973 206e 6f74           'is not
+000084e0: 2073 7570 706f 7274 6564 2062 7920 7468   supported by th
+000084f0: 6973 2063 6c6f 7564 2e20 5265 6d6f 7665  is cloud. Remove
+00008500: 2074 6865 2063 6f6e 6669 6720 6f72 2073   the config or s
+00008510: 6574 3a20 270a 2020 2020 2020 2020 2020  et: '.          
+00008520: 2020 2020 2020 2760 7265 6d6f 7465 5f69        '`remote_i
+00008530: 6465 6e74 6974 793a 204c 4f43 414c 5f43  dentity: LOCAL_C
+00008540: 5245 4445 4e54 4941 4c53 602e 2729 0a20  REDENTIALS`.'). 
+00008550: 2020 2020 2020 2065 7863 6c75 6465 645f         excluded_
+00008560: 636c 6f75 6473 203d 205b 636c 6f75 645d  clouds = [cloud]
+00008570: 0a20 2020 2063 7265 6465 6e74 6961 6c73  .    credentials
+00008580: 203d 2073 6b79 5f63 6865 636b 2e67 6574   = sky_check.get
+00008590: 5f63 6c6f 7564 5f63 7265 6465 6e74 6961  _cloud_credentia
+000085a0: 6c5f 6669 6c65 5f6d 6f75 6e74 7328 6578  l_file_mounts(ex
+000085b0: 636c 7564 6564 5f63 6c6f 7564 7329 0a0a  cluded_clouds)..
+000085c0: 2020 2020 6175 7468 5f63 6f6e 6669 6720      auth_config 
+000085d0: 3d20 7b27 7373 685f 7072 6976 6174 655f  = {'ssh_private_
+000085e0: 6b65 7927 3a20 6175 7468 2e50 5249 5641  key': auth.PRIVA
+000085f0: 5445 5f53 5348 5f4b 4559 5f50 4154 487d  TE_SSH_KEY_PATH}
+00008600: 0a20 2020 2072 6567 696f 6e5f 6e61 6d65  .    region_name
+00008610: 203d 2072 6573 6f75 7263 6573 5f76 6172   = resources_var
+00008620: 732e 6765 7428 2772 6567 696f 6e27 290a  s.get('region').
+00008630: 0a20 2020 2079 616d 6c5f 7061 7468 203d  .    yaml_path =
+00008640: 205f 6765 745f 7961 6d6c 5f70 6174 685f   _get_yaml_path_
+00008650: 6672 6f6d 5f63 6c75 7374 6572 5f6e 616d  from_cluster_nam
+00008660: 6528 636c 7573 7465 725f 6e61 6d65 290a  e(cluster_name).
+00008670: 0a20 2020 2023 2052 6574 7269 6576 6520  .    # Retrieve 
+00008680: 7468 6520 7373 685f 7072 6f78 795f 636f  the ssh_proxy_co
+00008690: 6d6d 616e 6420 666f 7220 7468 6520 6769  mmand for the gi
+000086a0: 7665 6e20 636c 6f75 6420 2f20 7265 6769  ven cloud / regi
+000086b0: 6f6e 2e0a 2020 2020 7373 685f 7072 6f78  on..    ssh_prox
+000086c0: 795f 636f 6d6d 616e 645f 636f 6e66 6967  y_command_config
+000086d0: 203d 2073 6b79 7069 6c6f 745f 636f 6e66   = skypilot_conf
+000086e0: 6967 2e67 6574 5f6e 6573 7465 6428 0a20  ig.get_nested(. 
+000086f0: 2020 2020 2020 2028 7374 7228 636c 6f75         (str(clou
+00008700: 6429 2e6c 6f77 6572 2829 2c20 2773 7368  d).lower(), 'ssh
+00008710: 5f70 726f 7879 5f63 6f6d 6d61 6e64 2729  _proxy_command')
+00008720: 2c20 4e6f 6e65 290a 2020 2020 6966 2028  , None).    if (
+00008730: 6973 696e 7374 616e 6365 2873 7368 5f70  isinstance(ssh_p
+00008740: 726f 7879 5f63 6f6d 6d61 6e64 5f63 6f6e  roxy_command_con
+00008750: 6669 672c 2073 7472 2920 6f72 0a20 2020  fig, str) or.   
+00008760: 2020 2020 2020 2020 2073 7368 5f70 726f           ssh_pro
+00008770: 7879 5f63 6f6d 6d61 6e64 5f63 6f6e 6669  xy_command_confi
+00008780: 6720 6973 204e 6f6e 6529 3a0a 2020 2020  g is None):.    
+00008790: 2020 2020 7373 685f 7072 6f78 795f 636f      ssh_proxy_co
+000087a0: 6d6d 616e 6420 3d20 7373 685f 7072 6f78  mmand = ssh_prox
+000087b0: 795f 636f 6d6d 616e 645f 636f 6e66 6967  y_command_config
+000087c0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+000087d0: 2020 2023 2073 7368 5f70 726f 7879 5f63     # ssh_proxy_c
+000087e0: 6f6d 6d61 6e64 5f63 6f6e 6669 673a 2044  ommand_config: D
+000087f0: 6963 745b 7374 722c 2073 7472 5d2c 2072  ict[str, str], r
+00008800: 6567 696f 6e5f 6e61 6d65 202d 3e20 636f  egion_name -> co
+00008810: 6d6d 616e 640a 2020 2020 2020 2020 2320  mmand.        # 
+00008820: 5468 6973 2074 7970 6520 6368 6563 6b20  This type check 
+00008830: 6973 2064 6f6e 6520 6279 2073 6b79 7069  is done by skypi
+00008840: 6c6f 745f 636f 6e66 6967 2061 7420 636f  lot_config at co
+00008850: 6e66 6967 206c 6f61 6420 7469 6d65 2e0a  nfig load time..
+00008860: 0a20 2020 2020 2020 2023 2054 6865 7265  .        # There
+00008870: 2061 7265 2074 776f 2063 6173 6573 3a0a   are two cases:.
+00008880: 2020 2020 2020 2020 6966 206b 6565 705f          if keep_
+00008890: 6c61 756e 6368 5f66 6965 6c64 735f 696e  launch_fields_in
+000088a0: 5f65 7869 7374 696e 675f 636f 6e66 6967  _existing_config
+000088b0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000088c0: 2831 2920 5765 2772 6520 7265 2d70 726f  (1) We're re-pro
+000088d0: 7669 7369 6f6e 696e 6720 616e 2065 7869  visioning an exi
+000088e0: 7374 696e 6720 636c 7573 7465 722e 0a20  sting cluster.. 
+000088f0: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
+00008900: 2020 2020 2020 2020 2023 2057 6520 7573           # We us
+00008910: 6520 4e6f 6e65 2066 6f72 2073 7368 5f70  e None for ssh_p
+00008920: 726f 7879 5f63 6f6d 6d61 6e64 2c20 7768  roxy_command, wh
+00008930: 6963 6820 7769 6c6c 2062 6520 7265 7374  ich will be rest
+00008940: 6f72 6564 2074 6f20 7468 650a 2020 2020  ored to the.    
+00008950: 2020 2020 2020 2020 2320 636c 7573 7465          # cluste
+00008960: 7227 7320 6f72 6967 696e 616c 2076 616c  r's original val
+00008970: 7565 206c 6174 6572 2062 7920 5f72 6570  ue later by _rep
+00008980: 6c61 6365 5f79 616d 6c5f 6469 6374 7328  lace_yaml_dicts(
+00008990: 292e 0a20 2020 2020 2020 2020 2020 2073  )..            s
+000089a0: 7368 5f70 726f 7879 5f63 6f6d 6d61 6e64  sh_proxy_command
+000089b0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+000089c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000089d0: 2020 2320 2832 2920 5765 2772 6520 6c61    # (2) We're la
+000089e0: 756e 6368 696e 6720 6120 6e65 7720 636c  unching a new cl
+000089f0: 7573 7465 722e 0a20 2020 2020 2020 2020  uster..         
+00008a00: 2020 2023 0a20 2020 2020 2020 2020 2020     #.           
+00008a10: 2023 2052 6573 6f75 7263 6573 2e67 6574   # Resources.get
+00008a20: 5f76 616c 6964 5f72 6567 696f 6e73 5f66  _valid_regions_f
+00008a30: 6f72 5f6c 6175 6e63 6861 626c 6528 2920  or_launchable() 
+00008a40: 7265 7370 6563 7473 2074 6865 206b 6579  respects the key
+00008a50: 7320 2872 6567 696f 6e73 290a 2020 2020  s (regions).    
+00008a60: 2020 2020 2020 2020 2320 696e 2073 7368          # in ssh
+00008a70: 5f70 726f 7879 5f63 6f6d 6d61 6e64 2069  _proxy_command i
+00008a80: 6e20 736b 7970 696c 6f74 5f63 6f6e 6669  n skypilot_confi
+00008a90: 672e 2053 6f20 6865 7265 2077 6520 6164  g. So here we ad
+00008aa0: 6420 616e 2061 7373 6572 742e 0a20 2020  d an assert..   
+00008ab0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00008ac0: 7265 6769 6f6e 5f6e 616d 6520 696e 2073  region_name in s
+00008ad0: 7368 5f70 726f 7879 5f63 6f6d 6d61 6e64  sh_proxy_command
+00008ae0: 5f63 6f6e 6669 672c 2028 0a20 2020 2020  _config, (.     
+00008af0: 2020 2020 2020 2020 2020 2072 6567 696f             regio
+00008b00: 6e5f 6e61 6d65 2c20 7373 685f 7072 6f78  n_name, ssh_prox
+00008b10: 795f 636f 6d6d 616e 645f 636f 6e66 6967  y_command_config
+00008b20: 290a 2020 2020 2020 2020 2020 2020 7373  ).            ss
+00008b30: 685f 7072 6f78 795f 636f 6d6d 616e 6420  h_proxy_command 
+00008b40: 3d20 7373 685f 7072 6f78 795f 636f 6d6d  = ssh_proxy_comm
+00008b50: 616e 645f 636f 6e66 6967 5b72 6567 696f  and_config[regio
+00008b60: 6e5f 6e61 6d65 5d0a 2020 2020 6c6f 6767  n_name].    logg
+00008b70: 6572 2e64 6562 7567 2866 2755 7369 6e67  er.debug(f'Using
+00008b80: 2073 7368 5f70 726f 7879 5f63 6f6d 6d61   ssh_proxy_comma
+00008b90: 6e64 3a20 7b73 7368 5f70 726f 7879 5f63  nd: {ssh_proxy_c
+00008ba0: 6f6d 6d61 6e64 2172 7d27 290a 0a20 2020  ommand!r}')..   
+00008bb0: 2023 2055 7365 722d 7375 7070 6c69 6564   # User-supplied
+00008bc0: 2069 6e73 7461 6e63 6520 7461 6773 2e0a   instance tags..
+00008bd0: 2020 2020 696e 7374 616e 6365 5f74 6167      instance_tag
+00008be0: 7320 3d20 7b7d 0a20 2020 2069 6e73 7461  s = {}.    insta
+00008bf0: 6e63 655f 7461 6773 203d 2073 6b79 7069  nce_tags = skypi
+00008c00: 6c6f 745f 636f 6e66 6967 2e67 6574 5f6e  lot_config.get_n
+00008c10: 6573 7465 6428 0a20 2020 2020 2020 2028  ested(.        (
+00008c20: 7374 7228 636c 6f75 6429 2e6c 6f77 6572  str(cloud).lower
+00008c30: 2829 2c20 2769 6e73 7461 6e63 655f 7461  (), 'instance_ta
+00008c40: 6773 2729 2c20 7b7d 290a 2020 2020 2320  gs'), {}).    # 
+00008c50: 696e 7374 616e 6365 5f74 6167 7320 6973  instance_tags is
+00008c60: 2061 2064 6963 742c 2077 6869 6368 2069   a dict, which i
+00008c70: 7320 6775 6172 616e 7465 6564 2062 7920  s guaranteed by 
+00008c80: 7468 6520 7479 7065 2063 6865 636b 2069  the type check i
+00008c90: 6e0a 2020 2020 2320 7363 6865 6d61 732e  n.    # schemas.
+00008ca0: 7079 0a20 2020 2061 7373 6572 7420 6973  py.    assert is
+00008cb0: 696e 7374 616e 6365 2869 6e73 7461 6e63  instance(instanc
+00008cc0: 655f 7461 6773 2c20 6469 6374 292c 2069  e_tags, dict), i
+00008cd0: 6e73 7461 6e63 655f 7461 6773 0a0a 2020  nstance_tags..  
+00008ce0: 2020 2320 4475 6d70 2074 6865 2052 6179    # Dump the Ray
+00008cf0: 2070 6f72 7473 2074 6f20 6120 6669 6c65   ports to a file
+00008d00: 2066 6f72 2052 6179 206a 6f62 2073 7562   for Ray job sub
+00008d10: 6d69 7373 696f 6e0a 2020 2020 6475 6d70  mission.    dump
+00008d20: 5f70 6f72 745f 636f 6d6d 616e 6420 3d20  _port_command = 
+00008d30: 280a 2020 2020 2020 2020 6627 7b63 6f6e  (.        f'{con
+00008d40: 7374 616e 7473 2e53 4b59 5f50 5954 484f  stants.SKY_PYTHO
+00008d50: 4e5f 434d 447d 202d 6320 5c27 696d 706f  N_CMD} -c \'impo
+00008d60: 7274 206a 736f 6e2c 206f 733b 206a 736f  rt json, os; jso
+00008d70: 6e2e 6475 6d70 287b 636f 6e73 7461 6e74  n.dump({constant
+00008d80: 732e 534b 595f 5245 4d4f 5445 5f52 4159  s.SKY_REMOTE_RAY
+00008d90: 5f50 4f52 545f 4449 4354 5f53 5452 7d2c  _PORT_DICT_STR},
+00008da0: 2027 0a20 2020 2020 2020 2066 276f 7065   '.        f'ope
+00008db0: 6e28 6f73 2e70 6174 682e 6578 7061 6e64  n(os.path.expand
+00008dc0: 7573 6572 2822 7b63 6f6e 7374 616e 7473  user("{constants
+00008dd0: 2e53 4b59 5f52 454d 4f54 455f 5241 595f  .SKY_REMOTE_RAY_
+00008de0: 504f 5254 5f46 494c 457d 2229 2c20 2277  PORT_FILE}"), "w
+00008df0: 222c 2065 6e63 6f64 696e 673d 2275 7466  ", encoding="utf
+00008e00: 2d38 2229 295c 2727 0a20 2020 2029 0a0a  -8"))\''.    )..
+00008e10: 2020 2020 2320 5573 6520 6120 746d 7020      # Use a tmp 
+00008e20: 6669 6c65 2070 6174 6820 746f 2061 766f  file path to avo
+00008e30: 6964 2069 6e63 6f6d 706c 6574 6520 5941  id incomplete YA
+00008e40: 4d4c 2066 696c 6520 6265 696e 6720 7265  ML file being re
+00008e50: 2d75 7365 6420 696e 2074 6865 0a20 2020  -used in the.   
+00008e60: 2023 2066 7574 7572 652e 0a20 2020 2074   # future..    t
+00008e70: 6d70 5f79 616d 6c5f 7061 7468 203d 2079  mp_yaml_path = y
+00008e80: 616d 6c5f 7061 7468 202b 2027 2e74 6d70  aml_path + '.tmp
+00008e90: 270a 2020 2020 636f 6d6d 6f6e 5f75 7469  '.    common_uti
+00008ea0: 6c73 2e66 696c 6c5f 7465 6d70 6c61 7465  ls.fill_template
+00008eb0: 280a 2020 2020 2020 2020 636c 7573 7465  (.        cluste
+00008ec0: 725f 636f 6e66 6967 5f74 656d 706c 6174  r_config_templat
+00008ed0: 652c 0a20 2020 2020 2020 2064 6963 7428  e,.        dict(
+00008ee0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00008ef0: 6f75 7263 6573 5f76 6172 732c 0a20 2020  ources_vars,.   
+00008f00: 2020 2020 2020 2020 202a 2a7b 0a20 2020           **{.   
+00008f10: 2020 2020 2020 2020 2020 2020 2027 636c               'cl
+00008f20: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
+00008f30: 6f75 6427 3a20 636c 7573 7465 725f 6e61  oud': cluster_na
+00008f40: 6d65 5f6f 6e5f 636c 6f75 642c 0a20 2020  me_on_cloud,.   
+00008f50: 2020 2020 2020 2020 2020 2020 2027 6e75               'nu
+00008f60: 6d5f 6e6f 6465 7327 3a20 6e75 6d5f 6e6f  m_nodes': num_no
+00008f70: 6465 732c 0a20 2020 2020 2020 2020 2020  des,.           
+00008f80: 2020 2020 2027 6469 736b 5f73 697a 6527       'disk_size'
+00008f90: 3a20 746f 5f70 726f 7669 7369 6f6e 2e64  : to_provision.d
+00008fa0: 6973 6b5f 7369 7a65 2c0a 2020 2020 2020  isk_size,.      
+00008fb0: 2020 2020 2020 2020 2020 2320 4966 2074            # If t
+00008fc0: 6865 2063 7572 7265 6e74 2063 6f64 6520  he current code 
+00008fd0: 6973 2072 756e 2062 7920 636f 6e74 726f  is run by contro
+00008fe0: 6c6c 6572 2c20 7072 6f70 6167 6174 6520  ller, propagate 
+00008ff0: 7468 6520 7265 616c 0a20 2020 2020 2020  the real.       
+00009000: 2020 2020 2020 2020 2023 2063 616c 6c69           # calli
+00009010: 6e67 2075 7365 7220 7768 6963 6820 7368  ng user which sh
+00009020: 6f75 6c64 2776 6520 6265 656e 2070 6173  ould've been pas
+00009030: 7365 6420 696e 2061 7320 7468 650a 2020  sed in as the.  
+00009040: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00009050: 534b 5950 494c 4f54 5f55 5345 5220 656e  SKYPILOT_USER en
+00009060: 7620 7661 7220 2873 6565 0a20 2020 2020  v var (see.     
+00009070: 2020 2020 2020 2020 2020 2023 2063 6f6e             # con
+00009080: 7472 6f6c 6c65 725f 7574 696c 732e 7368  troller_utils.sh
+00009090: 6172 6564 5f63 6f6e 7472 6f6c 6c65 725f  ared_controller_
+000090a0: 7661 7273 5f74 6f5f 6669 6c6c 2829 2e0a  vars_to_fill()..
+000090b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000090c0: 2775 7365 7227 3a20 636f 6d6d 6f6e 5f75  'user': common_u
+000090d0: 7469 6c73 2e67 6574 5f63 6c65 616e 6564  tils.get_cleaned
+000090e0: 5f75 7365 726e 616d 6528 0a20 2020 2020  _username(.     
+000090f0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00009100: 732e 656e 7669 726f 6e2e 6765 7428 636f  s.environ.get(co
+00009110: 6e73 7461 6e74 732e 5553 4552 5f45 4e56  nstants.USER_ENV
+00009120: 5f56 4152 2c20 2727 2929 2c0a 0a20 2020  _VAR, '')),..   
+00009130: 2020 2020 2020 2020 2020 2020 2023 204e               # N
+00009140: 6574 776f 726b 696e 6720 636f 6e66 6967  etworking config
+00009150: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00009160: 2020 2775 7365 5f69 6e74 6572 6e61 6c5f    'use_internal_
+00009170: 6970 7327 3a20 736b 7970 696c 6f74 5f63  ips': skypilot_c
+00009180: 6f6e 6669 672e 6765 745f 6e65 7374 6564  onfig.get_nested
+00009190: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000091a0: 2020 2020 2020 2873 7472 2863 6c6f 7564        (str(cloud
+000091b0: 292e 6c6f 7765 7228 292c 2027 7573 655f  ).lower(), 'use_
+000091c0: 696e 7465 726e 616c 5f69 7073 2729 2c20  internal_ips'), 
+000091d0: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
+000091e0: 2020 2020 2020 2020 2773 7368 5f70 726f          'ssh_pro
+000091f0: 7879 5f63 6f6d 6d61 6e64 273a 2073 7368  xy_command': ssh
+00009200: 5f70 726f 7879 5f63 6f6d 6d61 6e64 2c0a  _proxy_command,.
+00009210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009220: 2776 7063 5f6e 616d 6527 3a20 736b 7970  'vpc_name': skyp
+00009230: 696c 6f74 5f63 6f6e 6669 672e 6765 745f  ilot_config.get_
+00009240: 6e65 7374 6564 280a 2020 2020 2020 2020  nested(.        
+00009250: 2020 2020 2020 2020 2020 2020 2873 7472              (str
+00009260: 2863 6c6f 7564 292e 6c6f 7765 7228 292c  (cloud).lower(),
+00009270: 2027 7670 635f 6e61 6d65 2729 2c20 4e6f   'vpc_name'), No
+00009280: 6e65 292c 0a0a 2020 2020 2020 2020 2020  ne),..          
+00009290: 2020 2020 2020 2320 5573 6572 2d73 7570        # User-sup
+000092a0: 706c 6965 6420 696e 7374 616e 6365 2074  plied instance t
+000092b0: 6167 732e 0a20 2020 2020 2020 2020 2020  ags..           
+000092c0: 2020 2020 2027 696e 7374 616e 6365 5f74       'instance_t
+000092d0: 6167 7327 3a20 696e 7374 616e 6365 5f74  ags': instance_t
+000092e0: 6167 732c 0a20 2020 2020 2020 2020 2020  ags,.           
+000092f0: 2020 2020 2023 2054 6865 2072 6573 6572       # The reser
+00009300: 7661 7469 6f6e 2070 6f6f 6c73 2074 6861  vation pools tha
+00009310: 7420 7370 6563 6966 6965 6420 6279 2074  t specified by t
+00009320: 6865 2075 7365 722e 2054 6869 7320 6973  he user. This is
+00009330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009340: 2023 2063 7572 7265 6e74 6c79 206f 6e6c   # currently onl
+00009350: 7920 7573 6564 2062 7920 4743 502e 0a20  y used by GCP.. 
+00009360: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00009370: 7370 6563 6966 6963 5f72 6573 6572 7661  specific_reserva
+00009380: 7469 6f6e 7327 3a20 7370 6563 6966 6963  tions': specific
+00009390: 5f72 6573 6572 7661 7469 6f6e 732c 0a0a  _reservations,..
+000093a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000093b0: 2320 436f 6e64 6120 7365 7475 700a 2020  # Conda setup.  
+000093c0: 2020 2020 2020 2020 2020 2020 2020 2763                'c
+000093d0: 6f6e 6461 5f69 6e73 7461 6c6c 6174 696f  onda_installatio
+000093e0: 6e5f 636f 6d6d 616e 6473 273a 0a20 2020  n_commands':.   
+000093f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009400: 2063 6f6e 7374 616e 7473 2e43 4f4e 4441   constants.CONDA
+00009410: 5f49 4e53 5441 4c4c 4154 494f 4e5f 434f  _INSTALLATION_CO
+00009420: 4d4d 414e 4453 2c0a 2020 2020 2020 2020  MMANDS,.        
+00009430: 2020 2020 2020 2020 2320 5765 2073 686f          # We sho
+00009440: 756c 6420 6e6f 7420 7573 6520 602e 666f  uld not use `.fo
+00009450: 726d 6174 602c 2061 7320 6974 2063 6f6e  rmat`, as it con
+00009460: 7461 696e 7320 277b 7d27 2061 7320 7468  tains '{}' as th
+00009470: 6520 6261 7368 0a20 2020 2020 2020 2020  e bash.         
+00009480: 2020 2020 2020 2023 2073 796e 7461 782e         # syntax.
+00009490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000094a0: 2027 7261 795f 736b 7970 696c 6f74 5f69   'ray_skypilot_i
+000094b0: 6e73 7461 6c6c 6174 696f 6e5f 636f 6d6d  nstallation_comm
+000094c0: 616e 6473 273a 0a20 2020 2020 2020 2020  ands':.         
+000094d0: 2020 2020 2020 2020 2020 2028 636f 6e73             (cons
+000094e0: 7461 6e74 732e 5241 595f 534b 5950 494c  tants.RAY_SKYPIL
+000094f0: 4f54 5f49 4e53 5441 4c4c 4154 494f 4e5f  OT_INSTALLATION_
+00009500: 434f 4d4d 414e 4453 2e72 6570 6c61 6365  COMMANDS.replace
+00009510: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00009520: 2020 2020 2020 2020 2020 277b 736b 795f            '{sky_
+00009530: 7768 6565 6c5f 6861 7368 7d27 2c0a 2020  wheel_hash}',.  
+00009540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009550: 2020 2020 2020 7768 6565 6c5f 6861 7368        wheel_hash
+00009560: 292e 7265 706c 6163 6528 277b 636c 6f75  ).replace('{clou
+00009570: 647d 272c 0a20 2020 2020 2020 2020 2020  d}',.           
+00009580: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00009590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000095a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000095b0: 2020 7374 7228 636c 6f75 6429 2e6c 6f77    str(cloud).low
-000095c0: 6572 2829 2929 2c0a 0a20 2020 2020 2020  er())),..       
-000095d0: 2020 2020 2020 2020 2023 2050 6f72 7420           # Port 
-000095e0: 6f66 2052 6179 2028 4743 5320 7365 7276  of Ray (GCS serv
-000095f0: 6572 292e 0a20 2020 2020 2020 2020 2020  er)..           
-00009600: 2020 2020 2023 2052 6179 2773 2064 6566       # Ray's def
-00009610: 6175 6c74 2070 6f72 7420 3633 3739 2069  ault port 6379 i
-00009620: 7320 636f 6e66 6c69 6374 6564 2077 6974  s conflicted wit
-00009630: 6820 5265 6469 732e 0a20 2020 2020 2020  h Redis..       
-00009640: 2020 2020 2020 2020 2027 7261 795f 706f           'ray_po
-00009650: 7274 273a 2063 6f6e 7374 616e 7473 2e53  rt': constants.S
-00009660: 4b59 5f52 454d 4f54 455f 5241 595f 504f  KY_REMOTE_RAY_PO
-00009670: 5254 2c0a 2020 2020 2020 2020 2020 2020  RT,.            
-00009680: 2020 2020 2772 6179 5f64 6173 6862 6f61      'ray_dashboa
-00009690: 7264 5f70 6f72 7427 3a20 636f 6e73 7461  rd_port': consta
-000096a0: 6e74 732e 534b 595f 5245 4d4f 5445 5f52  nts.SKY_REMOTE_R
-000096b0: 4159 5f44 4153 4842 4f41 5244 5f50 4f52  AY_DASHBOARD_POR
-000096c0: 542c 0a20 2020 2020 2020 2020 2020 2020  T,.             
-000096d0: 2020 2027 7261 795f 7465 6d70 5f64 6972     'ray_temp_dir
-000096e0: 273a 2063 6f6e 7374 616e 7473 2e53 4b59  ': constants.SKY
-000096f0: 5f52 454d 4f54 455f 5241 595f 5445 4d50  _REMOTE_RAY_TEMP
-00009700: 4449 522c 0a20 2020 2020 2020 2020 2020  DIR,.           
-00009710: 2020 2020 2027 6475 6d70 5f70 6f72 745f       'dump_port_
-00009720: 636f 6d6d 616e 6427 3a20 6475 6d70 5f70  command': dump_p
-00009730: 6f72 745f 636f 6d6d 616e 642c 0a20 2020  ort_command,.   
-00009740: 2020 2020 2020 2020 2020 2020 2023 2053               # S
-00009750: 6b79 2d69 6e74 6572 6e61 6c20 636f 6e73  ky-internal cons
-00009760: 7461 6e74 732e 0a20 2020 2020 2020 2020  tants..         
-00009770: 2020 2020 2020 2027 736b 795f 7261 795f         'sky_ray_
-00009780: 636d 6427 3a20 636f 6e73 7461 6e74 732e  cmd': constants.
-00009790: 534b 595f 5241 595f 434d 442c 0a20 2020  SKY_RAY_CMD,.   
-000097a0: 2020 2020 2020 2020 2020 2020 2027 736b               'sk
-000097b0: 795f 7069 705f 636d 6427 3a20 636f 6e73  y_pip_cmd': cons
-000097c0: 7461 6e74 732e 534b 595f 5049 505f 434d  tants.SKY_PIP_CM
-000097d0: 442c 0a20 2020 2020 2020 2020 2020 2020  D,.             
-000097e0: 2020 2027 7261 795f 7665 7273 696f 6e27     'ray_version'
-000097f0: 3a20 636f 6e73 7461 6e74 732e 534b 595f  : constants.SKY_
-00009800: 5245 4d4f 5445 5f52 4159 5f56 4552 5349  REMOTE_RAY_VERSI
-00009810: 4f4e 2c0a 2020 2020 2020 2020 2020 2020  ON,.            
-00009820: 2020 2020 2320 436f 6d6d 616e 6420 666f      # Command fo
-00009830: 7220 7761 6974 696e 6720 7261 7920 636c  r waiting ray cl
-00009840: 7573 7465 7220 746f 2062 6520 7265 6164  uster to be read
-00009850: 7920 6f6e 2068 6561 642e 0a20 2020 2020  y on head..     
-00009860: 2020 2020 2020 2020 2020 2027 7261 795f             'ray_
-00009870: 6865 6164 5f77 6169 745f 696e 6974 6961  head_wait_initia
-00009880: 6c69 7a65 645f 636f 6d6d 616e 6427 3a0a  lized_command':.
-00009890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000098a0: 2020 2020 696e 7374 616e 6365 5f73 6574      instance_set
-000098b0: 7570 2e52 4159 5f48 4541 445f 5741 4954  up.RAY_HEAD_WAIT
-000098c0: 5f49 4e49 5449 414c 495a 4544 5f43 4f4d  _INITIALIZED_COM
-000098d0: 4d41 4e44 2c0a 0a20 2020 2020 2020 2020  MAND,..         
-000098e0: 2020 2020 2020 2023 2043 6c6f 7564 2063         # Cloud c
-000098f0: 7265 6465 6e74 6961 6c73 2066 6f72 2063  redentials for c
-00009900: 6c6f 7564 2073 746f 7261 6765 2e0a 2020  loud storage..  
-00009910: 2020 2020 2020 2020 2020 2020 2020 2763                'c
-00009920: 7265 6465 6e74 6961 6c73 273a 2063 7265  redentials': cre
-00009930: 6465 6e74 6961 6c73 2c0a 2020 2020 2020  dentials,.      
-00009940: 2020 2020 2020 2020 2020 2320 536b 7920            # Sky 
-00009950: 7265 6d6f 7465 2075 7469 6c73 2e0a 2020  remote utils..  
-00009960: 2020 2020 2020 2020 2020 2020 2020 2773                's
-00009970: 6b79 5f72 656d 6f74 655f 7061 7468 273a  ky_remote_path':
-00009980: 2053 4b59 5f52 454d 4f54 455f 5041 5448   SKY_REMOTE_PATH
-00009990: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000099a0: 2020 2773 6b79 5f6c 6f63 616c 5f70 6174    'sky_local_pat
-000099b0: 6827 3a20 7374 7228 6c6f 6361 6c5f 7768  h': str(local_wh
-000099c0: 6565 6c5f 7061 7468 292c 0a20 2020 2020  eel_path),.     
-000099d0: 2020 2020 2020 2020 2020 2023 2041 6464             # Add
-000099e0: 2079 616d 6c20 6669 6c65 2070 6174 6820   yaml file path 
-000099f0: 746f 2074 6865 2074 656d 706c 6174 6520  to the template 
-00009a00: 7661 7269 6162 6c65 732e 0a20 2020 2020  variables..     
-00009a10: 2020 2020 2020 2020 2020 2027 736b 795f             'sky_
-00009a20: 7261 795f 7961 6d6c 5f72 656d 6f74 655f  ray_yaml_remote_
-00009a30: 7061 7468 273a 0a20 2020 2020 2020 2020  path':.         
-00009a40: 2020 2020 2020 2020 2020 2063 6c75 7374             clust
-00009a50: 6572 5f79 616d 6c5f 7574 696c 732e 534b  er_yaml_utils.SK
-00009a60: 595f 434c 5553 5445 525f 5941 4d4c 5f52  Y_CLUSTER_YAML_R
-00009a70: 454d 4f54 455f 5041 5448 2c0a 2020 2020  EMOTE_PATH,.    
-00009a80: 2020 2020 2020 2020 2020 2020 2773 6b79              'sky
-00009a90: 5f72 6179 5f79 616d 6c5f 6c6f 6361 6c5f  _ray_yaml_local_
-00009aa0: 7061 7468 273a 2074 6d70 5f79 616d 6c5f  path': tmp_yaml_
-00009ab0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-00009ac0: 2020 2020 2020 2773 6b79 5f76 6572 7369        'sky_versi
-00009ad0: 6f6e 273a 2073 7472 2876 6572 7369 6f6e  on': str(version
-00009ae0: 2e70 6172 7365 2873 6b79 2e5f 5f76 6572  .parse(sky.__ver
-00009af0: 7369 6f6e 5f5f 2929 2c0a 2020 2020 2020  sion__)),.      
-00009b00: 2020 2020 2020 2020 2020 2773 6b79 5f77            'sky_w
-00009b10: 6865 656c 5f68 6173 6827 3a20 7768 6565  heel_hash': whee
-00009b20: 6c5f 6861 7368 2c0a 2020 2020 2020 2020  l_hash,.        
-00009b30: 2020 2020 2020 2020 2320 4175 7468 656e          # Authen
-00009b40: 7469 6361 7469 6f6e 2028 6f70 7469 6f6e  tication (option
-00009b50: 616c 292e 0a20 2020 2020 2020 2020 2020  al)..           
-00009b60: 2020 2020 202a 2a61 7574 685f 636f 6e66       **auth_conf
-00009b70: 6967 2c0a 2020 2020 2020 2020 2020 2020  ig,.            
-00009b80: 7d29 2c0a 2020 2020 2020 2020 6f75 7470  }),.        outp
-00009b90: 7574 5f70 6174 683d 746d 705f 7961 6d6c  ut_path=tmp_yaml
-00009ba0: 5f70 6174 6829 0a20 2020 2063 6f6e 6669  _path).    confi
-00009bb0: 675f 6469 6374 5b27 636c 7573 7465 725f  g_dict['cluster_
-00009bc0: 6e61 6d65 275d 203d 2063 6c75 7374 6572  name'] = cluster
-00009bd0: 5f6e 616d 650a 2020 2020 636f 6e66 6967  _name.    config
-00009be0: 5f64 6963 745b 2772 6179 275d 203d 2079  _dict['ray'] = y
-00009bf0: 616d 6c5f 7061 7468 0a20 2020 2069 6620  aml_path.    if 
-00009c00: 6472 7972 756e 3a0a 2020 2020 2020 2020  dryrun:.        
-00009c10: 2320 4966 2064 7279 7275 6e2c 2072 6574  # If dryrun, ret
-00009c20: 7572 6e20 7468 6520 756e 6669 6e69 7368  urn the unfinish
-00009c30: 6564 2074 6d70 2079 616d 6c20 7061 7468  ed tmp yaml path
-00009c40: 2e0a 2020 2020 2020 2020 636f 6e66 6967  ..        config
-00009c50: 5f64 6963 745b 2772 6179 275d 203d 2074  _dict['ray'] = t
-00009c60: 6d70 5f79 616d 6c5f 7061 7468 0a20 2020  mp_yaml_path.   
-00009c70: 2020 2020 2072 6574 7572 6e20 636f 6e66       return conf
-00009c80: 6967 5f64 6963 740a 2020 2020 5f61 6464  ig_dict.    _add
-00009c90: 5f61 7574 685f 746f 5f63 6c75 7374 6572  _auth_to_cluster
-00009ca0: 5f63 6f6e 6669 6728 636c 6f75 642c 2074  _config(cloud, t
-00009cb0: 6d70 5f79 616d 6c5f 7061 7468 290a 0a20  mp_yaml_path).. 
-00009cc0: 2020 2023 2041 6464 206b 7562 6572 6e65     # Add kuberne
-00009cd0: 7465 7320 636f 6e66 6967 2066 6965 6c64  tes config field
-00009ce0: 7320 6672 6f6d 207e 2f2e 736b 792f 636f  s from ~/.sky/co
-00009cf0: 6e66 6967 0a20 2020 2069 6620 6973 696e  nfig.    if isin
-00009d00: 7374 616e 6365 2863 6c6f 7564 2c20 636c  stance(cloud, cl
-00009d10: 6f75 6473 2e4b 7562 6572 6e65 7465 7329  ouds.Kubernetes)
-00009d20: 3a0a 2020 2020 2020 2020 6b75 6265 726e  :.        kubern
-00009d30: 6574 6573 5f75 7469 6c73 2e63 6f6d 6269  etes_utils.combi
-00009d40: 6e65 5f70 6f64 5f63 6f6e 6669 675f 6669  ne_pod_config_fi
-00009d50: 656c 6473 2874 6d70 5f79 616d 6c5f 7061  elds(tmp_yaml_pa
-00009d60: 7468 290a 2020 2020 2020 2020 6b75 6265  th).        kube
-00009d70: 726e 6574 6573 5f75 7469 6c73 2e63 6f6d  rnetes_utils.com
-00009d80: 6269 6e65 5f6d 6574 6164 6174 615f 6669  bine_metadata_fi
-00009d90: 656c 6473 2874 6d70 5f79 616d 6c5f 7061  elds(tmp_yaml_pa
-00009da0: 7468 290a 0a20 2020 2023 2052 6573 746f  th)..    # Resto
-00009db0: 7265 2074 6865 206f 6c64 2079 616d 6c20  re the old yaml 
-00009dc0: 636f 6e74 656e 7420 666f 7220 6261 636b  content for back
-00009dd0: 7761 7264 2063 6f6d 7061 7469 6269 6c69  ward compatibili
-00009de0: 7479 2e0a 2020 2020 6966 206f 732e 7061  ty..    if os.pa
-00009df0: 7468 2e65 7869 7374 7328 7961 6d6c 5f70  th.exists(yaml_p
-00009e00: 6174 6829 2061 6e64 206b 6565 705f 6c61  ath) and keep_la
-00009e10: 756e 6368 5f66 6965 6c64 735f 696e 5f65  unch_fields_in_e
-00009e20: 7869 7374 696e 675f 636f 6e66 6967 3a0a  xisting_config:.
-00009e30: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
-00009e40: 6e28 7961 6d6c 5f70 6174 682c 2027 7227  n(yaml_path, 'r'
-00009e50: 2c20 656e 636f 6469 6e67 3d27 7574 662d  , encoding='utf-
-00009e60: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
-00009e70: 2020 2020 2020 6f6c 645f 7961 6d6c 5f63        old_yaml_c
-00009e80: 6f6e 7465 6e74 203d 2066 2e72 6561 6428  ontent = f.read(
-00009e90: 290a 2020 2020 2020 2020 7769 7468 206f  ).        with o
-00009ea0: 7065 6e28 746d 705f 7961 6d6c 5f70 6174  pen(tmp_yaml_pat
-00009eb0: 682c 2027 7227 2c20 656e 636f 6469 6e67  h, 'r', encoding
-00009ec0: 3d27 7574 662d 3827 2920 6173 2066 3a0a  ='utf-8') as f:.
-00009ed0: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-00009ee0: 7961 6d6c 5f63 6f6e 7465 6e74 203d 2066  yaml_content = f
-00009ef0: 2e72 6561 6428 290a 2020 2020 2020 2020  .read().        
-00009f00: 7265 7374 6f72 6564 5f79 616d 6c5f 636f  restored_yaml_co
-00009f10: 6e74 656e 7420 3d20 5f72 6570 6c61 6365  ntent = _replace
-00009f20: 5f79 616d 6c5f 6469 6374 7328 0a20 2020  _yaml_dicts(.   
-00009f30: 2020 2020 2020 2020 206e 6577 5f79 616d           new_yam
-00009f40: 6c5f 636f 6e74 656e 742c 206f 6c64 5f79  l_content, old_y
-00009f50: 616d 6c5f 636f 6e74 656e 742c 0a20 2020  aml_content,.   
-00009f60: 2020 2020 2020 2020 205f 5241 595f 5941           _RAY_YA
-00009f70: 4d4c 5f4b 4559 535f 544f 5f52 4553 544f  ML_KEYS_TO_RESTO
-00009f80: 5245 5f46 4f52 5f42 4143 4b5f 434f 4d50  RE_FOR_BACK_COMP
-00009f90: 4154 4942 494c 4954 592c 0a20 2020 2020  ATIBILITY,.     
-00009fa0: 2020 2020 2020 205f 5241 595f 5941 4d4c         _RAY_YAML
-00009fb0: 5f4b 4559 535f 544f 5f52 4553 544f 5245  _KEYS_TO_RESTORE
-00009fc0: 5f45 5843 4550 5449 4f4e 5329 0a20 2020  _EXCEPTIONS).   
-00009fd0: 2020 2020 2077 6974 6820 6f70 656e 2874       with open(t
-00009fe0: 6d70 5f79 616d 6c5f 7061 7468 2c20 2777  mp_yaml_path, 'w
-00009ff0: 272c 2065 6e63 6f64 696e 673d 2775 7466  ', encoding='utf
-0000a000: 2d38 2729 2061 7320 663a 0a20 2020 2020  -8') as f:.     
-0000a010: 2020 2020 2020 2066 2e77 7269 7465 2872         f.write(r
-0000a020: 6573 746f 7265 645f 7961 6d6c 5f63 6f6e  estored_yaml_con
-0000a030: 7465 6e74 290a 0a20 2020 2063 6f6e 6669  tent)..    confi
-0000a040: 675f 6469 6374 5b27 636c 7573 7465 725f  g_dict['cluster_
-0000a050: 6e61 6d65 5f6f 6e5f 636c 6f75 6427 5d20  name_on_cloud'] 
-0000a060: 3d20 636c 7573 7465 725f 6e61 6d65 5f6f  = cluster_name_o
-0000a070: 6e5f 636c 6f75 640a 0a20 2020 2023 204f  n_cloud..    # O
-0000a080: 7074 696d 697a 6174 696f 6e3a 2063 6f70  ptimization: cop
-0000a090: 7920 7468 6520 636f 6e74 656e 7473 206f  y the contents o
-0000a0a0: 6620 736f 7572 6365 2066 696c 6573 2069  f source files i
-0000a0b0: 6e20 6669 6c65 5f6d 6f75 6e74 7320 746f  n file_mounts to
-0000a0c0: 2061 0a20 2020 2023 2073 7065 6369 616c   a.    # special
-0000a0d0: 2064 6972 2c20 616e 6420 7570 6c6f 6164   dir, and upload
-0000a0e0: 2074 6861 7420 6173 2074 6865 206f 6e6c   that as the onl
-0000a0f0: 7920 6669 6c65 5f6d 6f75 6e74 2069 6e73  y file_mount ins
-0000a100: 7465 6164 2e20 4465 6c61 790a 2020 2020  tead. Delay.    
-0000a110: 2320 6361 6c6c 696e 6720 7468 6973 206f  # calling this o
-0000a120: 7074 696d 697a 6174 696f 6e20 756e 7469  ptimization unti
-0000a130: 6c20 6e6f 772c 2077 6865 6e20 616c 6c20  l now, when all 
-0000a140: 736f 7572 6365 2066 696c 6573 2068 6176  source files hav
-0000a150: 6520 6265 656e 0a20 2020 2023 2077 7269  e been.    # wri
-0000a160: 7474 656e 2061 6e64 2074 6865 6972 2063  tten and their c
-0000a170: 6f6e 7465 6e74 7320 6669 6e61 6c69 7a65  ontents finalize
-0000a180: 642e 0a20 2020 2023 0a20 2020 2023 204e  d..    #.    # N
-0000a190: 6f74 6520 7468 6174 2074 6865 2072 6179  ote that the ray
-0000a1a0: 2079 616d 6c20 6669 6c65 2077 696c 6c20   yaml file will 
-0000a1b0: 6265 2063 6f70 6965 6420 696e 746f 2074  be copied into t
-0000a1c0: 6861 7420 7370 6563 6961 6c20 6469 7220  hat special dir 
-0000a1d0: 2869 2e65 2e2c 0a20 2020 2023 2075 706c  (i.e.,.    # upl
-0000a1e0: 6f61 6465 6420 6173 2070 6172 7420 6f66  oaded as part of
-0000a1f0: 2074 6865 2066 696c 655f 6d6f 756e 7473   the file_mounts
-0000a200: 292c 2073 6f20 7468 6520 7265 7374 6f72  ), so the restor
-0000a210: 6520 666f 7220 6261 636b 7761 7264 0a20  e for backward. 
-0000a220: 2020 2023 2063 6f6d 7061 7469 6269 6c69     # compatibili
-0000a230: 7479 2073 686f 756c 6420 676f 2062 6566  ty should go bef
-0000a240: 6f72 6520 7468 6973 2063 616c 6c2e 0a20  ore this call.. 
-0000a250: 2020 205f 6f70 7469 6d69 7a65 5f66 696c     _optimize_fil
-0000a260: 655f 6d6f 756e 7473 2874 6d70 5f79 616d  e_mounts(tmp_yam
-0000a270: 6c5f 7061 7468 290a 0a20 2020 2023 2052  l_path)..    # R
-0000a280: 656e 616d 6520 7468 6520 746d 7020 6669  ename the tmp fi
-0000a290: 6c65 2074 6f20 7468 6520 6669 6e61 6c20  le to the final 
-0000a2a0: 5941 4d4c 2070 6174 682e 0a20 2020 206f  YAML path..    o
-0000a2b0: 732e 7265 6e61 6d65 2874 6d70 5f79 616d  s.rename(tmp_yam
-0000a2c0: 6c5f 7061 7468 2c20 7961 6d6c 5f70 6174  l_path, yaml_pat
-0000a2d0: 6829 0a20 2020 2075 7361 6765 5f6c 6962  h).    usage_lib
-0000a2e0: 2e6d 6573 7361 6765 732e 7573 6167 652e  .messages.usage.
-0000a2f0: 7570 6461 7465 5f72 6179 5f79 616d 6c28  update_ray_yaml(
-0000a300: 7961 6d6c 5f70 6174 6829 0a20 2020 2072  yaml_path).    r
-0000a310: 6574 7572 6e20 636f 6e66 6967 5f64 6963  eturn config_dic
-0000a320: 740a 0a0a 6465 6620 5f61 6464 5f61 7574  t...def _add_aut
-0000a330: 685f 746f 5f63 6c75 7374 6572 5f63 6f6e  h_to_cluster_con
-0000a340: 6669 6728 636c 6f75 643a 2063 6c6f 7564  fig(cloud: cloud
-0000a350: 732e 436c 6f75 642c 2063 6c75 7374 6572  s.Cloud, cluster
-0000a360: 5f63 6f6e 6669 675f 6669 6c65 3a20 7374  _config_file: st
-0000a370: 7229 3a0a 2020 2020 2222 2241 6464 7320  r):.    """Adds 
-0000a380: 5353 4820 6b65 7920 696e 666f 2074 6f20  SSH key info to 
-0000a390: 7468 6520 636c 7573 7465 7220 636f 6e66  the cluster conf
-0000a3a0: 6967 2e0a 0a20 2020 2054 6869 7320 6675  ig...    This fu
-0000a3b0: 6e63 7469 6f6e 2773 206f 7574 7075 7420  nction's output 
-0000a3c0: 7265 6d6f 7665 7320 636f 6d6d 656e 7473  removes comments
-0000a3d0: 2069 6e63 6c75 6465 6420 696e 2074 6865   included in the
-0000a3e0: 206a 696e 6a61 3220 7465 6d70 6c61 7465   jinja2 template
-0000a3f0: 2e0a 2020 2020 2222 220a 2020 2020 636f  ..    """.    co
-0000a400: 6e66 6967 203d 2063 6f6d 6d6f 6e5f 7574  nfig = common_ut
-0000a410: 696c 732e 7265 6164 5f79 616d 6c28 636c  ils.read_yaml(cl
-0000a420: 7573 7465 725f 636f 6e66 6967 5f66 696c  uster_config_fil
-0000a430: 6529 0a20 2020 2023 2043 6865 636b 2074  e).    # Check t
-0000a440: 6865 2061 7661 696c 6162 696c 6974 7920  he availability 
-0000a450: 6f66 2074 6865 2063 6c6f 7564 2074 7970  of the cloud typ
-0000a460: 652e 0a20 2020 2069 6620 6973 696e 7374  e..    if isinst
-0000a470: 616e 6365 2863 6c6f 7564 2c20 2863 6c6f  ance(cloud, (clo
-0000a480: 7564 732e 4157 532c 2063 6c6f 7564 732e  uds.AWS, clouds.
-0000a490: 4f43 492c 2063 6c6f 7564 732e 5343 502c  OCI, clouds.SCP,
-0000a4a0: 2063 6c6f 7564 732e 5673 7068 6572 652c   clouds.Vsphere,
-0000a4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a4c0: 2020 2020 2020 2020 2020 2063 6c6f 7564             cloud
-0000a4d0: 732e 4375 646f 2c20 636c 6f75 6473 2e50  s.Cudo, clouds.P
-0000a4e0: 6170 6572 7370 6163 6529 293a 0a20 2020  aperspace)):.   
-0000a4f0: 2020 2020 2063 6f6e 6669 6720 3d20 6175       config = au
-0000a500: 7468 2e63 6f6e 6669 6775 7265 5f73 7368  th.configure_ssh
-0000a510: 5f69 6e66 6f28 636f 6e66 6967 290a 2020  _info(config).  
-0000a520: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-0000a530: 6528 636c 6f75 642c 2063 6c6f 7564 732e  e(cloud, clouds.
-0000a540: 4743 5029 3a0a 2020 2020 2020 2020 636f  GCP):.        co
-0000a550: 6e66 6967 203d 2061 7574 682e 7365 7475  nfig = auth.setu
-0000a560: 705f 6763 705f 6175 7468 656e 7469 6361  p_gcp_authentica
-0000a570: 7469 6f6e 2863 6f6e 6669 6729 0a20 2020  tion(config).   
-0000a580: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
-0000a590: 2863 6c6f 7564 2c20 636c 6f75 6473 2e41  (cloud, clouds.A
-0000a5a0: 7a75 7265 293a 0a20 2020 2020 2020 2063  zure):.        c
-0000a5b0: 6f6e 6669 6720 3d20 6175 7468 2e73 6574  onfig = auth.set
-0000a5c0: 7570 5f61 7a75 7265 5f61 7574 6865 6e74  up_azure_authent
-0000a5d0: 6963 6174 696f 6e28 636f 6e66 6967 290a  ication(config).
-0000a5e0: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-0000a5f0: 6e63 6528 636c 6f75 642c 2063 6c6f 7564  nce(cloud, cloud
-0000a600: 732e 4c61 6d62 6461 293a 0a20 2020 2020  s.Lambda):.     
-0000a610: 2020 2063 6f6e 6669 6720 3d20 6175 7468     config = auth
-0000a620: 2e73 6574 7570 5f6c 616d 6264 615f 6175  .setup_lambda_au
-0000a630: 7468 656e 7469 6361 7469 6f6e 2863 6f6e  thentication(con
-0000a640: 6669 6729 0a20 2020 2065 6c69 6620 6973  fig).    elif is
-0000a650: 696e 7374 616e 6365 2863 6c6f 7564 2c20  instance(cloud, 
-0000a660: 636c 6f75 6473 2e4b 7562 6572 6e65 7465  clouds.Kubernete
-0000a670: 7329 3a0a 2020 2020 2020 2020 636f 6e66  s):.        conf
-0000a680: 6967 203d 2061 7574 682e 7365 7475 705f  ig = auth.setup_
-0000a690: 6b75 6265 726e 6574 6573 5f61 7574 6865  kubernetes_authe
-0000a6a0: 6e74 6963 6174 696f 6e28 636f 6e66 6967  ntication(config
-0000a6b0: 290a 2020 2020 656c 6966 2069 7369 6e73  ).    elif isins
-0000a6c0: 7461 6e63 6528 636c 6f75 642c 2063 6c6f  tance(cloud, clo
-0000a6d0: 7564 732e 4942 4d29 3a0a 2020 2020 2020  uds.IBM):.      
-0000a6e0: 2020 636f 6e66 6967 203d 2061 7574 682e    config = auth.
-0000a6f0: 7365 7475 705f 6962 6d5f 6175 7468 656e  setup_ibm_authen
-0000a700: 7469 6361 7469 6f6e 2863 6f6e 6669 6729  tication(config)
-0000a710: 0a20 2020 2065 6c69 6620 6973 696e 7374  .    elif isinst
-0000a720: 616e 6365 2863 6c6f 7564 2c20 636c 6f75  ance(cloud, clou
-0000a730: 6473 2e52 756e 506f 6429 3a0a 2020 2020  ds.RunPod):.    
-0000a740: 2020 2020 636f 6e66 6967 203d 2061 7574      config = aut
-0000a750: 682e 7365 7475 705f 7275 6e70 6f64 5f61  h.setup_runpod_a
-0000a760: 7574 6865 6e74 6963 6174 696f 6e28 636f  uthentication(co
-0000a770: 6e66 6967 290a 2020 2020 656c 6966 2069  nfig).    elif i
-0000a780: 7369 6e73 7461 6e63 6528 636c 6f75 642c  sinstance(cloud,
-0000a790: 2063 6c6f 7564 732e 466c 7569 6473 7461   clouds.Fluidsta
-0000a7a0: 636b 293a 0a20 2020 2020 2020 2063 6f6e  ck):.        con
-0000a7b0: 6669 6720 3d20 6175 7468 2e73 6574 7570  fig = auth.setup
-0000a7c0: 5f66 6c75 6964 7374 6163 6b5f 6175 7468  _fluidstack_auth
-0000a7d0: 656e 7469 6361 7469 6f6e 2863 6f6e 6669  entication(confi
-0000a7e0: 6729 0a20 2020 2065 6c73 653a 0a20 2020  g).    else:.   
-0000a7f0: 2020 2020 2061 7373 6572 7420 4661 6c73       assert Fals
-0000a800: 652c 2063 6c6f 7564 0a20 2020 2063 6f6d  e, cloud.    com
-0000a810: 6d6f 6e5f 7574 696c 732e 6475 6d70 5f79  mon_utils.dump_y
-0000a820: 616d 6c28 636c 7573 7465 725f 636f 6e66  aml(cluster_conf
-0000a830: 6967 5f66 696c 652c 2063 6f6e 6669 6729  ig_file, config)
-0000a840: 0a0a 0a64 6566 2067 6574 5f72 756e 5f74  ...def get_run_t
-0000a850: 696d 6573 7461 6d70 2829 202d 3e20 7374  imestamp() -> st
-0000a860: 723a 0a20 2020 2072 6574 7572 6e20 2773  r:.    return 's
-0000a870: 6b79 2d27 202b 2064 6174 6574 696d 652e  ky-' + datetime.
-0000a880: 6e6f 7728 292e 7374 7266 7469 6d65 2827  now().strftime('
-0000a890: 2559 2d25 6d2d 2564 2d25 482d 254d 2d25  %Y-%m-%d-%H-%M-%
-0000a8a0: 532d 2566 2729 0a0a 0a64 6566 2067 6574  S-%f')...def get
-0000a8b0: 5f74 696d 6573 7461 6d70 5f66 726f 6d5f  _timestamp_from_
-0000a8c0: 7275 6e5f 7469 6d65 7374 616d 7028 7275  run_timestamp(ru
-0000a8d0: 6e5f 7469 6d65 7374 616d 703a 2073 7472  n_timestamp: str
-0000a8e0: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
-0000a8f0: 7265 7475 726e 2064 6174 6574 696d 652e  return datetime.
-0000a900: 7374 7270 7469 6d65 280a 2020 2020 2020  strptime(.      
-0000a910: 2020 7275 6e5f 7469 6d65 7374 616d 702e    run_timestamp.
-0000a920: 7061 7274 6974 696f 6e28 272d 2729 5b32  partition('-')[2
-0000a930: 5d2c 2027 2559 2d25 6d2d 2564 2d25 482d  ], '%Y-%m-%d-%H-
-0000a940: 254d 2d25 532d 2566 2729 2e74 696d 6573  %M-%S-%f').times
-0000a950: 7461 6d70 2829 0a0a 0a64 6566 205f 636f  tamp()...def _co
-0000a960: 756e 745f 6865 616c 7468 795f 6e6f 6465  unt_healthy_node
-0000a970: 735f 6672 6f6d 5f72 6179 286f 7574 7075  s_from_ray(outpu
-0000a980: 743a 2073 7472 2c0a 2020 2020 2020 2020  t: str,.        
-0000a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a9a0: 2020 2020 2020 2020 2020 6973 5f6c 6f63            is_loc
-0000a9b0: 616c 5f63 6c6f 7564 3a20 626f 6f6c 203d  al_cloud: bool =
-0000a9c0: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-0000a9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a9e0: 2020 2020 2020 2020 2920 2d3e 2054 7570          ) -> Tup
-0000a9f0: 6c65 5b69 6e74 2c20 696e 745d 3a0a 2020  le[int, int]:.  
-0000aa00: 2020 2222 2243 6f75 6e74 2074 6865 206e    """Count the n
-0000aa10: 756d 6265 7220 6f66 2068 6561 6c74 6879  umber of healthy
-0000aa20: 206e 6f64 6573 2066 726f 6d20 7468 6520   nodes from the 
-0000aa30: 6f75 7470 7574 206f 6620 6072 6179 2073  output of `ray s
-0000aa40: 7461 7475 7360 2e22 2222 0a0a 2020 2020  tatus`."""..    
-0000aa50: 6465 6620 6765 745f 7265 6164 795f 6e6f  def get_ready_no
-0000aa60: 6465 735f 636f 756e 7473 2870 6174 7465  des_counts(patte
-0000aa70: 726e 2c20 6f75 7470 7574 293a 0a20 2020  rn, output):.   
-0000aa80: 2020 2020 2072 6573 756c 7420 3d20 7061       result = pa
-0000aa90: 7474 6572 6e2e 6669 6e64 616c 6c28 6f75  ttern.findall(ou
-0000aaa0: 7470 7574 290a 2020 2020 2020 2020 6966  tput).        if
-0000aab0: 206e 6f74 2072 6573 756c 743a 0a20 2020   not result:.   
-0000aac0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000aad0: 300a 2020 2020 2020 2020 6173 7365 7274  0.        assert
-0000aae0: 206c 656e 2872 6573 756c 7429 203d 3d20   len(result) == 
-0000aaf0: 312c 2072 6573 756c 740a 2020 2020 2020  1, result.      
-0000ab00: 2020 7265 7475 726e 2069 6e74 2872 6573    return int(res
-0000ab10: 756c 745b 305d 290a 0a20 2020 2023 2043  ult[0])..    # C
-0000ab20: 6865 636b 2069 6620 7468 6520 7261 7920  heck if the ray 
-0000ab30: 636c 7573 7465 7220 6973 2073 7461 7274  cluster is start
-0000ab40: 6564 2077 6974 6820 7261 7920 6175 746f  ed with ray auto
-0000ab50: 7363 616c 6572 2e20 496e 206e 6577 0a20  scaler. In new. 
-0000ab60: 2020 2023 2070 726f 7669 7369 6f6e 6572     # provisioner
-0000ab70: 2028 2331 3730 3229 2061 6e64 206c 6f63   (#1702) and loc
-0000ab80: 616c 206d 6f64 652c 2077 6520 7374 6172  al mode, we star
-0000ab90: 7465 6420 7468 6520 7261 7920 636c 7573  ted the ray clus
-0000aba0: 7465 7220 7769 7468 6f75 7420 7261 790a  ter without ray.
-0000abb0: 2020 2020 2320 6175 746f 7363 616c 6572      # autoscaler
-0000abc0: 2e0a 2020 2020 2320 4966 2072 6179 2063  ..    # If ray c
-0000abd0: 6c75 7374 6572 2069 7320 7374 6172 7465  luster is starte
-0000abe0: 6420 7769 7468 2072 6179 2061 7574 6f73  d with ray autos
-0000abf0: 6361 6c65 722c 2074 6865 206f 7574 7075  caler, the outpu
-0000ac00: 7420 7769 6c6c 2062 653a 0a20 2020 2023  t will be:.    #
-0000ac10: 2020 3120 7261 792e 6865 6164 2e64 6566    1 ray.head.def
-0000ac20: 6175 6c74 0a20 2020 2023 2020 2e2e 2e0a  ault.    #  ....
-0000ac30: 2020 2020 2320 544f 444f 287a 6877 7529      # TODO(zhwu)
-0000ac40: 3a20 6f6e 6365 2077 6520 6465 7072 6563  : once we deprec
-0000ac50: 6174 6520 7468 6520 6f6c 6420 7072 6f76  ate the old prov
-0000ac60: 6973 696f 6e65 722c 2077 6520 6361 6e20  isioner, we can 
-0000ac70: 7265 6d6f 7665 2074 6869 730a 2020 2020  remove this.    
-0000ac80: 2320 6368 6563 6b2e 0a20 2020 2072 6179  # check..    ray
-0000ac90: 5f61 7574 6f73 6361 6c65 725f 6865 6164  _autoscaler_head
-0000aca0: 203d 2067 6574 5f72 6561 6479 5f6e 6f64   = get_ready_nod
-0000acb0: 6573 5f63 6f75 6e74 7328 5f4c 4155 4e43  es_counts(_LAUNC
-0000acc0: 4845 445f 4845 4144 5f50 4154 5445 524e  HED_HEAD_PATTERN
-0000acd0: 2c20 6f75 7470 7574 290a 2020 2020 6973  , output).    is
-0000ace0: 5f6c 6f63 616c 5f72 6179 5f63 6c75 7374  _local_ray_clust
-0000acf0: 6572 203d 2072 6179 5f61 7574 6f73 6361  er = ray_autosca
-0000ad00: 6c65 725f 6865 6164 203d 3d20 300a 0a20  ler_head == 0.. 
-0000ad10: 2020 2069 6620 6973 5f6c 6f63 616c 5f72     if is_local_r
-0000ad20: 6179 5f63 6c75 7374 6572 206f 7220 6973  ay_cluster or is
-0000ad30: 5f6c 6f63 616c 5f63 6c6f 7564 3a0a 2020  _local_cloud:.  
-0000ad40: 2020 2020 2020 2320 5261 7920 636c 7573        # Ray clus
-0000ad50: 7465 7220 6973 206c 6175 6e63 6865 6420  ter is launched 
-0000ad60: 7769 7468 206e 6577 2070 726f 7669 7369  with new provisi
-0000ad70: 6f6e 6572 0a20 2020 2020 2020 2023 2046  oner.        # F
-0000ad80: 6f72 206e 6577 2070 726f 7669 7369 6f6e  or new provision
-0000ad90: 6572 2061 6e64 206c 6f63 616c 206d 6f64  er and local mod
-0000ada0: 652c 2074 6865 206f 7574 7075 7420 7769  e, the output wi
-0000adb0: 6c6c 2062 653a 0a20 2020 2020 2020 2023  ll be:.        #
-0000adc0: 2020 3120 6e6f 6465 5f78 7878 780a 2020    1 node_xxxx.  
-0000add0: 2020 2020 2020 2320 2031 206e 6f64 655f        #  1 node_
-0000ade0: 7878 7878 0a20 2020 2020 2020 2072 6561  xxxx.        rea
-0000adf0: 6479 5f68 6561 6420 3d20 300a 2020 2020  dy_head = 0.    
-0000ae00: 2020 2020 7265 6164 795f 776f 726b 6572      ready_worker
-0000ae10: 7320 3d20 5f4c 4155 4e43 4845 445f 4c4f  s = _LAUNCHED_LO
-0000ae20: 4341 4c5f 574f 524b 4552 5f50 4154 5445  CAL_WORKER_PATTE
-0000ae30: 524e 2e66 696e 6461 6c6c 286f 7574 7075  RN.findall(outpu
-0000ae40: 7429 0a20 2020 2020 2020 2072 6561 6479  t).        ready
-0000ae50: 5f77 6f72 6b65 7273 203d 206c 656e 2872  _workers = len(r
-0000ae60: 6561 6479 5f77 6f72 6b65 7273 290a 2020  eady_workers).  
-0000ae70: 2020 2020 2020 6966 2069 735f 6c6f 6361        if is_loca
-0000ae80: 6c5f 7261 795f 636c 7573 7465 723a 0a20  l_ray_cluster:. 
-0000ae90: 2020 2020 2020 2020 2020 2072 6561 6479             ready
-0000aea0: 5f68 6561 6420 3d20 310a 2020 2020 2020  _head = 1.      
-0000aeb0: 2020 2020 2020 7265 6164 795f 776f 726b        ready_work
-0000aec0: 6572 7320 2d3d 2031 0a20 2020 2020 2020  ers -= 1.       
-0000aed0: 2072 6574 7572 6e20 7265 6164 795f 6865   return ready_he
-0000aee0: 6164 2c20 7265 6164 795f 776f 726b 6572  ad, ready_worker
-0000aef0: 730a 0a20 2020 2023 2043 6f75 6e74 206e  s..    # Count n
-0000af00: 756d 6265 7220 6f66 206e 6f64 6573 2062  umber of nodes b
-0000af10: 7920 7061 7273 696e 6720 7468 6520 6f75  y parsing the ou
-0000af20: 7470 7574 206f 6620 6072 6179 2073 7461  tput of `ray sta
-0000af30: 7475 7360 2e20 5468 6520 6f75 7470 7574  tus`. The output
-0000af40: 0a20 2020 2023 206c 6f6f 6b73 206c 696b  .    # looks lik
-0000af50: 653a 0a20 2020 2023 2020 2031 2072 6179  e:.    #   1 ray
-0000af60: 2e68 6561 642e 6465 6661 756c 740a 2020  .head.default.  
-0000af70: 2020 2320 2020 3220 7261 792e 776f 726b    #   2 ray.work
-0000af80: 6572 2e64 6566 6175 6c74 0a20 2020 2072  er.default.    r
-0000af90: 6561 6479 5f68 6561 6420 3d20 7261 795f  eady_head = ray_
-0000afa0: 6175 746f 7363 616c 6572 5f68 6561 640a  autoscaler_head.
-0000afb0: 2020 2020 7265 6164 795f 776f 726b 6572      ready_worker
-0000afc0: 7320 3d20 6765 745f 7265 6164 795f 6e6f  s = get_ready_no
-0000afd0: 6465 735f 636f 756e 7473 285f 4c41 554e  des_counts(_LAUN
-0000afe0: 4348 4544 5f57 4f52 4b45 525f 5041 5454  CHED_WORKER_PATT
-0000aff0: 4552 4e2c 206f 7574 7075 7429 0a20 2020  ERN, output).   
-0000b000: 2072 6561 6479 5f72 6573 6572 7665 645f   ready_reserved_
-0000b010: 776f 726b 6572 7320 3d20 6765 745f 7265  workers = get_re
-0000b020: 6164 795f 6e6f 6465 735f 636f 756e 7473  ady_nodes_counts
-0000b030: 280a 2020 2020 2020 2020 5f4c 4155 4e43  (.        _LAUNC
-0000b040: 4845 445f 5245 5345 5256 4544 5f57 4f52  HED_RESERVED_WOR
-0000b050: 4b45 525f 5041 5454 4552 4e2c 206f 7574  KER_PATTERN, out
-0000b060: 7075 7429 0a20 2020 2072 6561 6479 5f77  put).    ready_w
-0000b070: 6f72 6b65 7273 202b 3d20 7265 6164 795f  orkers += ready_
-0000b080: 7265 7365 7276 6564 5f77 6f72 6b65 7273  reserved_workers
-0000b090: 0a20 2020 2061 7373 6572 7420 7265 6164  .    assert read
-0000b0a0: 795f 6865 6164 203c 3d20 312c 2066 2723  y_head <= 1, f'#
-0000b0b0: 6865 6164 206e 6f64 6520 7368 6f75 6c64  head node should
-0000b0c0: 2062 6520 3c3d 3120 2847 6f74 207b 7265   be <=1 (Got {re
-0000b0d0: 6164 795f 6865 6164 7d29 2e27 0a20 2020  ady_head}).'.   
-0000b0e0: 2072 6574 7572 6e20 7265 6164 795f 6865   return ready_he
-0000b0f0: 6164 2c20 7265 6164 795f 776f 726b 6572  ad, ready_worker
-0000b100: 730a 0a0a 6465 6620 6765 745f 646f 636b  s...def get_dock
-0000b110: 6572 5f75 7365 7228 6970 3a20 7374 722c  er_user(ip: str,
-0000b120: 2063 6c75 7374 6572 5f63 6f6e 6669 675f   cluster_config_
-0000b130: 6669 6c65 3a20 7374 7229 202d 3e20 7374  file: str) -> st
-0000b140: 723a 0a20 2020 2022 2222 4669 6e64 2064  r:.    """Find d
-0000b150: 6f63 6b65 7220 636f 6e74 6169 6e65 7220  ocker container 
-0000b160: 7573 6572 6e61 6d65 2e22 2222 0a20 2020  username.""".   
-0000b170: 2073 7368 5f63 7265 6465 6e74 6961 6c73   ssh_credentials
-0000b180: 203d 2073 7368 5f63 7265 6465 6e74 6961   = ssh_credentia
-0000b190: 6c5f 6672 6f6d 5f79 616d 6c28 636c 7573  l_from_yaml(clus
-0000b1a0: 7465 725f 636f 6e66 6967 5f66 696c 6529  ter_config_file)
-0000b1b0: 0a20 2020 2072 756e 6e65 7220 3d20 636f  .    runner = co
-0000b1c0: 6d6d 616e 645f 7275 6e6e 6572 2e53 5348  mmand_runner.SSH
-0000b1d0: 436f 6d6d 616e 6452 756e 6e65 7228 6970  CommandRunner(ip
-0000b1e0: 2c20 706f 7274 3d32 322c 202a 2a73 7368  , port=22, **ssh
-0000b1f0: 5f63 7265 6465 6e74 6961 6c73 290a 2020  _credentials).  
-0000b200: 2020 636f 6e74 6169 6e65 725f 6e61 6d65    container_name
-0000b210: 203d 2063 6f6e 7374 616e 7473 2e44 4546   = constants.DEF
-0000b220: 4155 4c54 5f44 4f43 4b45 525f 434f 4e54  AULT_DOCKER_CONT
-0000b230: 4149 4e45 525f 4e41 4d45 0a20 2020 2077  AINER_NAME.    w
-0000b240: 686f 616d 695f 7265 7475 726e 636f 6465  hoami_returncode
-0000b250: 2c20 7768 6f61 6d69 5f73 7464 6f75 742c  , whoami_stdout,
-0000b260: 2077 686f 616d 695f 7374 6465 7272 203d   whoami_stderr =
-0000b270: 2072 756e 6e65 722e 7275 6e28 0a20 2020   runner.run(.   
-0000b280: 2020 2020 2066 2773 7564 6f20 646f 636b       f'sudo dock
-0000b290: 6572 2065 7865 6320 7b63 6f6e 7461 696e  er exec {contain
-0000b2a0: 6572 5f6e 616d 657d 2077 686f 616d 6927  er_name} whoami'
-0000b2b0: 2c0a 2020 2020 2020 2020 7374 7265 616d  ,.        stream
-0000b2c0: 5f6c 6f67 733d 4661 6c73 652c 0a20 2020  _logs=False,.   
-0000b2d0: 2020 2020 2072 6571 7569 7265 5f6f 7574       require_out
-0000b2e0: 7075 7473 3d54 7275 6529 0a20 2020 2061  puts=True).    a
-0000b2f0: 7373 6572 7420 7768 6f61 6d69 5f72 6574  ssert whoami_ret
-0000b300: 7572 6e63 6f64 6520 3d3d 2030 2c20 280a  urncode == 0, (.
-0000b310: 2020 2020 2020 2020 6627 4661 696c 6564          f'Failed
-0000b320: 2074 6f20 6765 7420 646f 636b 6572 2063   to get docker c
-0000b330: 6f6e 7461 696e 6572 2075 7365 722e 2052  ontainer user. R
-0000b340: 6574 7572 6e20 270a 2020 2020 2020 2020  eturn '.        
-0000b350: 6627 636f 6465 3a20 7b77 686f 616d 695f  f'code: {whoami_
-0000b360: 7265 7475 726e 636f 6465 7d2c 2045 7272  returncode}, Err
-0000b370: 6f72 3a20 7b77 686f 616d 695f 7374 6465  or: {whoami_stde
-0000b380: 7272 7d27 290a 2020 2020 646f 636b 6572  rr}').    docker
-0000b390: 5f75 7365 7220 3d20 7768 6f61 6d69 5f73  _user = whoami_s
-0000b3a0: 7464 6f75 742e 7374 7269 7028 290a 2020  tdout.strip().  
-0000b3b0: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
-0000b3c0: 2744 6f63 6b65 7220 636f 6e74 6169 6e65  'Docker containe
-0000b3d0: 7220 7573 6572 3a20 7b64 6f63 6b65 725f  r user: {docker_
-0000b3e0: 7573 6572 7d27 290a 2020 2020 7265 7475  user}').    retu
-0000b3f0: 726e 2064 6f63 6b65 725f 7573 6572 0a0a  rn docker_user..
-0000b400: 0a40 7469 6d65 6c69 6e65 2e65 7665 6e74  .@timeline.event
-0000b410: 0a64 6566 2077 6169 745f 756e 7469 6c5f  .def wait_until_
-0000b420: 7261 795f 636c 7573 7465 725f 7265 6164  ray_cluster_read
-0000b430: 7928 0a20 2020 2063 6c75 7374 6572 5f63  y(.    cluster_c
-0000b440: 6f6e 6669 675f 6669 6c65 3a20 7374 722c  onfig_file: str,
-0000b450: 0a20 2020 206e 756d 5f6e 6f64 6573 3a20  .    num_nodes: 
-0000b460: 696e 742c 0a20 2020 206c 6f67 5f70 6174  int,.    log_pat
-0000b470: 683a 2073 7472 2c0a 2020 2020 6973 5f6c  h: str,.    is_l
-0000b480: 6f63 616c 5f63 6c6f 7564 3a20 626f 6f6c  ocal_cloud: bool
-0000b490: 203d 2046 616c 7365 2c0a 2020 2020 6e6f   = False,.    no
-0000b4a0: 6465 735f 6c61 756e 6368 696e 675f 7072  des_launching_pr
-0000b4b0: 6f67 7265 7373 5f74 696d 656f 7574 3a20  ogress_timeout: 
-0000b4c0: 4f70 7469 6f6e 616c 5b69 6e74 5d20 3d20  Optional[int] = 
-0000b4d0: 4e6f 6e65 2c0a 2920 2d3e 2054 7570 6c65  None,.) -> Tuple
-0000b4e0: 5b62 6f6f 6c2c 204f 7074 696f 6e61 6c5b  [bool, Optional[
-0000b4f0: 7374 725d 5d3a 0a20 2020 2022 2222 5761  str]]:.    """Wa
-0000b500: 6974 2075 6e74 696c 2074 6865 2072 6179  it until the ray
-0000b510: 2063 6c75 7374 6572 2069 7320 7365 7420   cluster is set 
-0000b520: 7570 206f 6e20 564d 7320 6f72 2069 6e20  up on VMs or in 
-0000b530: 636f 6e74 6169 6e65 7273 2e0a 0a20 2020  containers...   
-0000b540: 2052 6574 7572 6e73 3a20 2077 6865 7468   Returns:  wheth
-0000b550: 6572 2074 6865 2065 6e74 6972 6520 7261  er the entire ra
-0000b560: 7920 636c 7573 7465 7220 6973 2072 6561  y cluster is rea
-0000b570: 6479 2c20 616e 6420 646f 636b 6572 2075  dy, and docker u
-0000b580: 7365 726e 616d 650a 2020 2020 6966 206c  sername.    if l
-0000b590: 6175 6e63 6865 6420 7769 7468 2064 6f63  aunched with doc
-0000b5a0: 6b65 722e 0a20 2020 2022 2222 0a20 2020  ker..    """.   
-0000b5b0: 2023 204d 616e 7561 6c6c 7920 6665 7463   # Manually fetc
-0000b5c0: 6869 6e67 2068 6561 6420 6970 2069 6e73  hing head ip ins
-0000b5d0: 7465 6164 206f 6620 7573 696e 6720 6072  tead of using `r
-0000b5e0: 6179 2065 7865 6360 2074 6f20 6176 6f69  ay exec` to avoi
-0000b5f0: 6420 7468 6520 6275 670a 2020 2020 2320  d the bug.    # 
-0000b600: 7468 6174 2060 7261 7920 6578 6563 6020  that `ray exec` 
-0000b610: 6661 696c 7320 746f 2063 6f6e 6e65 6374  fails to connect
-0000b620: 2074 6f20 7468 6520 6865 6164 206e 6f64   to the head nod
-0000b630: 6520 6166 7465 7220 736f 6d65 2077 6f72  e after some wor
-0000b640: 6b65 7273 0a20 2020 2023 206c 6175 6e63  kers.    # launc
-0000b650: 6865 6420 6573 7065 6369 616c 6c79 2066  hed especially f
-0000b660: 6f72 2041 7a75 7265 2e0a 2020 2020 7472  or Azure..    tr
-0000b670: 793a 0a20 2020 2020 2020 2068 6561 645f  y:.        head_
-0000b680: 6970 203d 205f 7175 6572 795f 6865 6164  ip = _query_head
-0000b690: 5f69 705f 7769 7468 5f72 6574 7269 6573  _ip_with_retries
-0000b6a0: 280a 2020 2020 2020 2020 2020 2020 636c  (.            cl
-0000b6b0: 7573 7465 725f 636f 6e66 6967 5f66 696c  uster_config_fil
-0000b6c0: 652c 206d 6178 5f61 7474 656d 7074 733d  e, max_attempts=
-0000b6d0: 5741 4954 5f48 4541 445f 4e4f 4445 5f49  WAIT_HEAD_NODE_I
-0000b6e0: 505f 4d41 585f 4154 5445 4d50 5453 290a  P_MAX_ATTEMPTS).
-0000b6f0: 2020 2020 6578 6365 7074 2065 7863 6570      except excep
-0000b700: 7469 6f6e 732e 4665 7463 6849 5045 7272  tions.FetchIPErr
-0000b710: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
-0000b720: 206c 6f67 6765 722e 6572 726f 7228 636f   logger.error(co
-0000b730: 6d6d 6f6e 5f75 7469 6c73 2e66 6f72 6d61  mmon_utils.forma
-0000b740: 745f 6578 6365 7074 696f 6e28 6529 290a  t_exception(e)).
-0000b750: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-0000b760: 616c 7365 2c20 4e6f 6e65 2020 2320 6661  alse, None  # fa
-0000b770: 696c 6564 0a0a 2020 2020 636f 6e66 6967  iled..    config
-0000b780: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-0000b790: 7265 6164 5f79 616d 6c28 636c 7573 7465  read_yaml(cluste
-0000b7a0: 725f 636f 6e66 6967 5f66 696c 6529 0a0a  r_config_file)..
-0000b7b0: 2020 2020 646f 636b 6572 5f75 7365 7220      docker_user 
-0000b7c0: 3d20 4e6f 6e65 0a20 2020 2069 6620 2764  = None.    if 'd
-0000b7d0: 6f63 6b65 7227 2069 6e20 636f 6e66 6967  ocker' in config
-0000b7e0: 3a0a 2020 2020 2020 2020 646f 636b 6572  :.        docker
-0000b7f0: 5f75 7365 7220 3d20 6765 745f 646f 636b  _user = get_dock
-0000b800: 6572 5f75 7365 7228 6865 6164 5f69 702c  er_user(head_ip,
-0000b810: 2063 6c75 7374 6572 5f63 6f6e 6669 675f   cluster_config_
-0000b820: 6669 6c65 290a 0a20 2020 2069 6620 6e75  file)..    if nu
-0000b830: 6d5f 6e6f 6465 7320 3c3d 2031 3a0a 2020  m_nodes <= 1:.  
-0000b840: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-0000b850: 652c 2064 6f63 6b65 725f 7573 6572 0a0a  e, docker_user..
-0000b860: 2020 2020 7373 685f 6372 6564 656e 7469      ssh_credenti
-0000b870: 616c 7320 3d20 7373 685f 6372 6564 656e  als = ssh_creden
-0000b880: 7469 616c 5f66 726f 6d5f 7961 6d6c 2863  tial_from_yaml(c
-0000b890: 6c75 7374 6572 5f63 6f6e 6669 675f 6669  luster_config_fi
-0000b8a0: 6c65 2c20 646f 636b 6572 5f75 7365 7229  le, docker_user)
-0000b8b0: 0a20 2020 206c 6173 745f 6e6f 6465 735f  .    last_nodes_
-0000b8c0: 736f 5f66 6172 203d 2030 0a20 2020 2073  so_far = 0.    s
-0000b8d0: 7461 7274 203d 2074 696d 652e 7469 6d65  tart = time.time
-0000b8e0: 2829 0a20 2020 2072 756e 6e65 7220 3d20  ().    runner = 
-0000b8f0: 636f 6d6d 616e 645f 7275 6e6e 6572 2e53  command_runner.S
-0000b900: 5348 436f 6d6d 616e 6452 756e 6e65 7228  SHCommandRunner(
-0000b910: 6865 6164 5f69 702c 0a20 2020 2020 2020  head_ip,.       
+000095a0: 2073 7472 2863 6c6f 7564 292e 6c6f 7765   str(cloud).lowe
+000095b0: 7228 2929 292c 0a0a 2020 2020 2020 2020  r())),..        
+000095c0: 2020 2020 2020 2020 2320 506f 7274 206f          # Port o
+000095d0: 6620 5261 7920 2847 4353 2073 6572 7665  f Ray (GCS serve
+000095e0: 7229 2e0a 2020 2020 2020 2020 2020 2020  r)..            
+000095f0: 2020 2020 2320 5261 7927 7320 6465 6661      # Ray's defa
+00009600: 756c 7420 706f 7274 2036 3337 3920 6973  ult port 6379 is
+00009610: 2063 6f6e 666c 6963 7465 6420 7769 7468   conflicted with
+00009620: 2052 6564 6973 2e0a 2020 2020 2020 2020   Redis..        
+00009630: 2020 2020 2020 2020 2772 6179 5f70 6f72          'ray_por
+00009640: 7427 3a20 636f 6e73 7461 6e74 732e 534b  t': constants.SK
+00009650: 595f 5245 4d4f 5445 5f52 4159 5f50 4f52  Y_REMOTE_RAY_POR
+00009660: 542c 0a20 2020 2020 2020 2020 2020 2020  T,.             
+00009670: 2020 2027 7261 795f 6461 7368 626f 6172     'ray_dashboar
+00009680: 645f 706f 7274 273a 2063 6f6e 7374 616e  d_port': constan
+00009690: 7473 2e53 4b59 5f52 454d 4f54 455f 5241  ts.SKY_REMOTE_RA
+000096a0: 595f 4441 5348 424f 4152 445f 504f 5254  Y_DASHBOARD_PORT
+000096b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000096c0: 2020 2772 6179 5f74 656d 705f 6469 7227    'ray_temp_dir'
+000096d0: 3a20 636f 6e73 7461 6e74 732e 534b 595f  : constants.SKY_
+000096e0: 5245 4d4f 5445 5f52 4159 5f54 454d 5044  REMOTE_RAY_TEMPD
+000096f0: 4952 2c0a 2020 2020 2020 2020 2020 2020  IR,.            
+00009700: 2020 2020 2764 756d 705f 706f 7274 5f63      'dump_port_c
+00009710: 6f6d 6d61 6e64 273a 2064 756d 705f 706f  ommand': dump_po
+00009720: 7274 5f63 6f6d 6d61 6e64 2c0a 2020 2020  rt_command,.    
+00009730: 2020 2020 2020 2020 2020 2020 2320 536b              # Sk
+00009740: 792d 696e 7465 726e 616c 2063 6f6e 7374  y-internal const
+00009750: 616e 7473 2e0a 2020 2020 2020 2020 2020  ants..          
+00009760: 2020 2020 2020 2773 6b79 5f72 6179 5f63        'sky_ray_c
+00009770: 6d64 273a 2063 6f6e 7374 616e 7473 2e53  md': constants.S
+00009780: 4b59 5f52 4159 5f43 4d44 2c0a 2020 2020  KY_RAY_CMD,.    
+00009790: 2020 2020 2020 2020 2020 2020 2773 6b79              'sky
+000097a0: 5f70 6970 5f63 6d64 273a 2063 6f6e 7374  _pip_cmd': const
+000097b0: 616e 7473 2e53 4b59 5f50 4950 5f43 4d44  ants.SKY_PIP_CMD
+000097c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000097d0: 2020 2772 6179 5f76 6572 7369 6f6e 273a    'ray_version':
+000097e0: 2063 6f6e 7374 616e 7473 2e53 4b59 5f52   constants.SKY_R
+000097f0: 454d 4f54 455f 5241 595f 5645 5253 494f  EMOTE_RAY_VERSIO
+00009800: 4e2c 0a20 2020 2020 2020 2020 2020 2020  N,.             
+00009810: 2020 2023 2043 6f6d 6d61 6e64 2066 6f72     # Command for
+00009820: 2077 6169 7469 6e67 2072 6179 2063 6c75   waiting ray clu
+00009830: 7374 6572 2074 6f20 6265 2072 6561 6479  ster to be ready
+00009840: 206f 6e20 6865 6164 2e0a 2020 2020 2020   on head..      
+00009850: 2020 2020 2020 2020 2020 2772 6179 5f68            'ray_h
+00009860: 6561 645f 7761 6974 5f69 6e69 7469 616c  ead_wait_initial
+00009870: 697a 6564 5f63 6f6d 6d61 6e64 273a 0a20  ized_command':. 
+00009880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009890: 2020 2069 6e73 7461 6e63 655f 7365 7475     instance_setu
+000098a0: 702e 5241 595f 4845 4144 5f57 4149 545f  p.RAY_HEAD_WAIT_
+000098b0: 494e 4954 4941 4c49 5a45 445f 434f 4d4d  INITIALIZED_COMM
+000098c0: 414e 442c 0a0a 2020 2020 2020 2020 2020  AND,..          
+000098d0: 2020 2020 2020 2320 436c 6f75 6420 6372        # Cloud cr
+000098e0: 6564 656e 7469 616c 7320 666f 7220 636c  edentials for cl
+000098f0: 6f75 6420 7374 6f72 6167 652e 0a20 2020  oud storage..   
+00009900: 2020 2020 2020 2020 2020 2020 2027 6372               'cr
+00009910: 6564 656e 7469 616c 7327 3a20 6372 6564  edentials': cred
+00009920: 656e 7469 616c 732c 0a20 2020 2020 2020  entials,.       
+00009930: 2020 2020 2020 2020 2023 2053 6b79 2072           # Sky r
+00009940: 656d 6f74 6520 7574 696c 732e 0a20 2020  emote utils..   
+00009950: 2020 2020 2020 2020 2020 2020 2027 736b               'sk
+00009960: 795f 7265 6d6f 7465 5f70 6174 6827 3a20  y_remote_path': 
+00009970: 534b 595f 5245 4d4f 5445 5f50 4154 482c  SKY_REMOTE_PATH,
+00009980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009990: 2027 736b 795f 6c6f 6361 6c5f 7061 7468   'sky_local_path
+000099a0: 273a 2073 7472 286c 6f63 616c 5f77 6865  ': str(local_whe
+000099b0: 656c 5f70 6174 6829 2c0a 2020 2020 2020  el_path),.      
+000099c0: 2020 2020 2020 2020 2020 2320 4164 6420            # Add 
+000099d0: 7961 6d6c 2066 696c 6520 7061 7468 2074  yaml file path t
+000099e0: 6f20 7468 6520 7465 6d70 6c61 7465 2076  o the template v
+000099f0: 6172 6961 626c 6573 2e0a 2020 2020 2020  ariables..      
+00009a00: 2020 2020 2020 2020 2020 2773 6b79 5f72            'sky_r
+00009a10: 6179 5f79 616d 6c5f 7265 6d6f 7465 5f70  ay_yaml_remote_p
+00009a20: 6174 6827 3a0a 2020 2020 2020 2020 2020  ath':.          
+00009a30: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
+00009a40: 725f 7961 6d6c 5f75 7469 6c73 2e53 4b59  r_yaml_utils.SKY
+00009a50: 5f43 4c55 5354 4552 5f59 414d 4c5f 5245  _CLUSTER_YAML_RE
+00009a60: 4d4f 5445 5f50 4154 482c 0a20 2020 2020  MOTE_PATH,.     
+00009a70: 2020 2020 2020 2020 2020 2027 736b 795f             'sky_
+00009a80: 7261 795f 7961 6d6c 5f6c 6f63 616c 5f70  ray_yaml_local_p
+00009a90: 6174 6827 3a20 746d 705f 7961 6d6c 5f70  ath': tmp_yaml_p
+00009aa0: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+00009ab0: 2020 2020 2027 736b 795f 7665 7273 696f       'sky_versio
+00009ac0: 6e27 3a20 7374 7228 7665 7273 696f 6e2e  n': str(version.
+00009ad0: 7061 7273 6528 736b 792e 5f5f 7665 7273  parse(sky.__vers
+00009ae0: 696f 6e5f 5f29 292c 0a20 2020 2020 2020  ion__)),.       
+00009af0: 2020 2020 2020 2020 2027 736b 795f 7768           'sky_wh
+00009b00: 6565 6c5f 6861 7368 273a 2077 6865 656c  eel_hash': wheel
+00009b10: 5f68 6173 682c 0a20 2020 2020 2020 2020  _hash,.         
+00009b20: 2020 2020 2020 2023 2041 7574 6865 6e74         # Authent
+00009b30: 6963 6174 696f 6e20 286f 7074 696f 6e61  ication (optiona
+00009b40: 6c29 2e0a 2020 2020 2020 2020 2020 2020  l)..            
+00009b50: 2020 2020 2a2a 6175 7468 5f63 6f6e 6669      **auth_confi
+00009b60: 672c 0a20 2020 2020 2020 2020 2020 207d  g,.            }
+00009b70: 292c 0a20 2020 2020 2020 206f 7574 7075  ),.        outpu
+00009b80: 745f 7061 7468 3d74 6d70 5f79 616d 6c5f  t_path=tmp_yaml_
+00009b90: 7061 7468 290a 2020 2020 636f 6e66 6967  path).    config
+00009ba0: 5f64 6963 745b 2763 6c75 7374 6572 5f6e  _dict['cluster_n
+00009bb0: 616d 6527 5d20 3d20 636c 7573 7465 725f  ame'] = cluster_
+00009bc0: 6e61 6d65 0a20 2020 2063 6f6e 6669 675f  name.    config_
+00009bd0: 6469 6374 5b27 7261 7927 5d20 3d20 7961  dict['ray'] = ya
+00009be0: 6d6c 5f70 6174 680a 2020 2020 6966 2064  ml_path.    if d
+00009bf0: 7279 7275 6e3a 0a20 2020 2020 2020 2023  ryrun:.        #
+00009c00: 2049 6620 6472 7972 756e 2c20 7265 7475   If dryrun, retu
+00009c10: 726e 2074 6865 2075 6e66 696e 6973 6865  rn the unfinishe
+00009c20: 6420 746d 7020 7961 6d6c 2070 6174 682e  d tmp yaml path.
+00009c30: 0a20 2020 2020 2020 2063 6f6e 6669 675f  .        config_
+00009c40: 6469 6374 5b27 7261 7927 5d20 3d20 746d  dict['ray'] = tm
+00009c50: 705f 7961 6d6c 5f70 6174 680a 2020 2020  p_yaml_path.    
+00009c60: 2020 2020 7265 7475 726e 2063 6f6e 6669      return confi
+00009c70: 675f 6469 6374 0a20 2020 205f 6164 645f  g_dict.    _add_
+00009c80: 6175 7468 5f74 6f5f 636c 7573 7465 725f  auth_to_cluster_
+00009c90: 636f 6e66 6967 2863 6c6f 7564 2c20 746d  config(cloud, tm
+00009ca0: 705f 7961 6d6c 5f70 6174 6829 0a0a 2020  p_yaml_path)..  
+00009cb0: 2020 2320 4164 6420 6b75 6265 726e 6574    # Add kubernet
+00009cc0: 6573 2063 6f6e 6669 6720 6669 656c 6473  es config fields
+00009cd0: 2066 726f 6d20 7e2f 2e73 6b79 2f63 6f6e   from ~/.sky/con
+00009ce0: 6669 670a 2020 2020 6966 2069 7369 6e73  fig.    if isins
+00009cf0: 7461 6e63 6528 636c 6f75 642c 2063 6c6f  tance(cloud, clo
+00009d00: 7564 732e 4b75 6265 726e 6574 6573 293a  uds.Kubernetes):
+00009d10: 0a20 2020 2020 2020 206b 7562 6572 6e65  .        kuberne
+00009d20: 7465 735f 7574 696c 732e 636f 6d62 696e  tes_utils.combin
+00009d30: 655f 706f 645f 636f 6e66 6967 5f66 6965  e_pod_config_fie
+00009d40: 6c64 7328 746d 705f 7961 6d6c 5f70 6174  lds(tmp_yaml_pat
+00009d50: 6829 0a20 2020 2020 2020 206b 7562 6572  h).        kuber
+00009d60: 6e65 7465 735f 7574 696c 732e 636f 6d62  netes_utils.comb
+00009d70: 696e 655f 6d65 7461 6461 7461 5f66 6965  ine_metadata_fie
+00009d80: 6c64 7328 746d 705f 7961 6d6c 5f70 6174  lds(tmp_yaml_pat
+00009d90: 6829 0a0a 2020 2020 2320 5265 7374 6f72  h)..    # Restor
+00009da0: 6520 7468 6520 6f6c 6420 7961 6d6c 2063  e the old yaml c
+00009db0: 6f6e 7465 6e74 2066 6f72 2062 6163 6b77  ontent for backw
+00009dc0: 6172 6420 636f 6d70 6174 6962 696c 6974  ard compatibilit
+00009dd0: 792e 0a20 2020 2069 6620 6f73 2e70 6174  y..    if os.pat
+00009de0: 682e 6578 6973 7473 2879 616d 6c5f 7061  h.exists(yaml_pa
+00009df0: 7468 2920 616e 6420 6b65 6570 5f6c 6175  th) and keep_lau
+00009e00: 6e63 685f 6669 656c 6473 5f69 6e5f 6578  nch_fields_in_ex
+00009e10: 6973 7469 6e67 5f63 6f6e 6669 673a 0a20  isting_config:. 
+00009e20: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
+00009e30: 2879 616d 6c5f 7061 7468 2c20 2772 272c  (yaml_path, 'r',
+00009e40: 2065 6e63 6f64 696e 673d 2775 7466 2d38   encoding='utf-8
+00009e50: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
+00009e60: 2020 2020 206f 6c64 5f79 616d 6c5f 636f       old_yaml_co
+00009e70: 6e74 656e 7420 3d20 662e 7265 6164 2829  ntent = f.read()
+00009e80: 0a20 2020 2020 2020 2077 6974 6820 6f70  .        with op
+00009e90: 656e 2874 6d70 5f79 616d 6c5f 7061 7468  en(tmp_yaml_path
+00009ea0: 2c20 2772 272c 2065 6e63 6f64 696e 673d  , 'r', encoding=
+00009eb0: 2775 7466 2d38 2729 2061 7320 663a 0a20  'utf-8') as f:. 
+00009ec0: 2020 2020 2020 2020 2020 206e 6577 5f79             new_y
+00009ed0: 616d 6c5f 636f 6e74 656e 7420 3d20 662e  aml_content = f.
+00009ee0: 7265 6164 2829 0a20 2020 2020 2020 2072  read().        r
+00009ef0: 6573 746f 7265 645f 7961 6d6c 5f63 6f6e  estored_yaml_con
+00009f00: 7465 6e74 203d 205f 7265 706c 6163 655f  tent = _replace_
+00009f10: 7961 6d6c 5f64 6963 7473 280a 2020 2020  yaml_dicts(.    
+00009f20: 2020 2020 2020 2020 6e65 775f 7961 6d6c          new_yaml
+00009f30: 5f63 6f6e 7465 6e74 2c20 6f6c 645f 7961  _content, old_ya
+00009f40: 6d6c 5f63 6f6e 7465 6e74 2c0a 2020 2020  ml_content,.    
+00009f50: 2020 2020 2020 2020 5f52 4159 5f59 414d          _RAY_YAM
+00009f60: 4c5f 4b45 5953 5f54 4f5f 5245 5354 4f52  L_KEYS_TO_RESTOR
+00009f70: 455f 464f 525f 4241 434b 5f43 4f4d 5041  E_FOR_BACK_COMPA
+00009f80: 5449 4249 4c49 5459 2c0a 2020 2020 2020  TIBILITY,.      
+00009f90: 2020 2020 2020 5f52 4159 5f59 414d 4c5f        _RAY_YAML_
+00009fa0: 4b45 5953 5f54 4f5f 5245 5354 4f52 455f  KEYS_TO_RESTORE_
+00009fb0: 4558 4345 5054 494f 4e53 290a 2020 2020  EXCEPTIONS).    
+00009fc0: 2020 2020 7769 7468 206f 7065 6e28 746d      with open(tm
+00009fd0: 705f 7961 6d6c 5f70 6174 682c 2027 7727  p_yaml_path, 'w'
+00009fe0: 2c20 656e 636f 6469 6e67 3d27 7574 662d  , encoding='utf-
+00009ff0: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
+0000a000: 2020 2020 2020 662e 7772 6974 6528 7265        f.write(re
+0000a010: 7374 6f72 6564 5f79 616d 6c5f 636f 6e74  stored_yaml_cont
+0000a020: 656e 7429 0a0a 2020 2020 636f 6e66 6967  ent)..    config
+0000a030: 5f64 6963 745b 2763 6c75 7374 6572 5f6e  _dict['cluster_n
+0000a040: 616d 655f 6f6e 5f63 6c6f 7564 275d 203d  ame_on_cloud'] =
+0000a050: 2063 6c75 7374 6572 5f6e 616d 655f 6f6e   cluster_name_on
+0000a060: 5f63 6c6f 7564 0a0a 2020 2020 2320 4f70  _cloud..    # Op
+0000a070: 7469 6d69 7a61 7469 6f6e 3a20 636f 7079  timization: copy
+0000a080: 2074 6865 2063 6f6e 7465 6e74 7320 6f66   the contents of
+0000a090: 2073 6f75 7263 6520 6669 6c65 7320 696e   source files in
+0000a0a0: 2066 696c 655f 6d6f 756e 7473 2074 6f20   file_mounts to 
+0000a0b0: 610a 2020 2020 2320 7370 6563 6961 6c20  a.    # special 
+0000a0c0: 6469 722c 2061 6e64 2075 706c 6f61 6420  dir, and upload 
+0000a0d0: 7468 6174 2061 7320 7468 6520 6f6e 6c79  that as the only
+0000a0e0: 2066 696c 655f 6d6f 756e 7420 696e 7374   file_mount inst
+0000a0f0: 6561 642e 2044 656c 6179 0a20 2020 2023  ead. Delay.    #
+0000a100: 2063 616c 6c69 6e67 2074 6869 7320 6f70   calling this op
+0000a110: 7469 6d69 7a61 7469 6f6e 2075 6e74 696c  timization until
+0000a120: 206e 6f77 2c20 7768 656e 2061 6c6c 2073   now, when all s
+0000a130: 6f75 7263 6520 6669 6c65 7320 6861 7665  ource files have
+0000a140: 2062 6565 6e0a 2020 2020 2320 7772 6974   been.    # writ
+0000a150: 7465 6e20 616e 6420 7468 6569 7220 636f  ten and their co
+0000a160: 6e74 656e 7473 2066 696e 616c 697a 6564  ntents finalized
+0000a170: 2e0a 2020 2020 230a 2020 2020 2320 4e6f  ..    #.    # No
+0000a180: 7465 2074 6861 7420 7468 6520 7261 7920  te that the ray 
+0000a190: 7961 6d6c 2066 696c 6520 7769 6c6c 2062  yaml file will b
+0000a1a0: 6520 636f 7069 6564 2069 6e74 6f20 7468  e copied into th
+0000a1b0: 6174 2073 7065 6369 616c 2064 6972 2028  at special dir (
+0000a1c0: 692e 652e 2c0a 2020 2020 2320 7570 6c6f  i.e.,.    # uplo
+0000a1d0: 6164 6564 2061 7320 7061 7274 206f 6620  aded as part of 
+0000a1e0: 7468 6520 6669 6c65 5f6d 6f75 6e74 7329  the file_mounts)
+0000a1f0: 2c20 736f 2074 6865 2072 6573 746f 7265  , so the restore
+0000a200: 2066 6f72 2062 6163 6b77 6172 640a 2020   for backward.  
+0000a210: 2020 2320 636f 6d70 6174 6962 696c 6974    # compatibilit
+0000a220: 7920 7368 6f75 6c64 2067 6f20 6265 666f  y should go befo
+0000a230: 7265 2074 6869 7320 6361 6c6c 2e0a 2020  re this call..  
+0000a240: 2020 5f6f 7074 696d 697a 655f 6669 6c65    _optimize_file
+0000a250: 5f6d 6f75 6e74 7328 746d 705f 7961 6d6c  _mounts(tmp_yaml
+0000a260: 5f70 6174 6829 0a0a 2020 2020 2320 5265  _path)..    # Re
+0000a270: 6e61 6d65 2074 6865 2074 6d70 2066 696c  name the tmp fil
+0000a280: 6520 746f 2074 6865 2066 696e 616c 2059  e to the final Y
+0000a290: 414d 4c20 7061 7468 2e0a 2020 2020 6f73  AML path..    os
+0000a2a0: 2e72 656e 616d 6528 746d 705f 7961 6d6c  .rename(tmp_yaml
+0000a2b0: 5f70 6174 682c 2079 616d 6c5f 7061 7468  _path, yaml_path
+0000a2c0: 290a 2020 2020 7573 6167 655f 6c69 622e  ).    usage_lib.
+0000a2d0: 6d65 7373 6167 6573 2e75 7361 6765 2e75  messages.usage.u
+0000a2e0: 7064 6174 655f 7261 795f 7961 6d6c 2879  pdate_ray_yaml(y
+0000a2f0: 616d 6c5f 7061 7468 290a 2020 2020 7265  aml_path).    re
+0000a300: 7475 726e 2063 6f6e 6669 675f 6469 6374  turn config_dict
+0000a310: 0a0a 0a64 6566 205f 6164 645f 6175 7468  ...def _add_auth
+0000a320: 5f74 6f5f 636c 7573 7465 725f 636f 6e66  _to_cluster_conf
+0000a330: 6967 2863 6c6f 7564 3a20 636c 6f75 6473  ig(cloud: clouds
+0000a340: 2e43 6c6f 7564 2c20 636c 7573 7465 725f  .Cloud, cluster_
+0000a350: 636f 6e66 6967 5f66 696c 653a 2073 7472  config_file: str
+0000a360: 293a 0a20 2020 2022 2222 4164 6473 2053  ):.    """Adds S
+0000a370: 5348 206b 6579 2069 6e66 6f20 746f 2074  SH key info to t
+0000a380: 6865 2063 6c75 7374 6572 2063 6f6e 6669  he cluster confi
+0000a390: 672e 0a0a 2020 2020 5468 6973 2066 756e  g...    This fun
+0000a3a0: 6374 696f 6e27 7320 6f75 7470 7574 2072  ction's output r
+0000a3b0: 656d 6f76 6573 2063 6f6d 6d65 6e74 7320  emoves comments 
+0000a3c0: 696e 636c 7564 6564 2069 6e20 7468 6520  included in the 
+0000a3d0: 6a69 6e6a 6132 2074 656d 706c 6174 652e  jinja2 template.
+0000a3e0: 0a20 2020 2022 2222 0a20 2020 2063 6f6e  .    """.    con
+0000a3f0: 6669 6720 3d20 636f 6d6d 6f6e 5f75 7469  fig = common_uti
+0000a400: 6c73 2e72 6561 645f 7961 6d6c 2863 6c75  ls.read_yaml(clu
+0000a410: 7374 6572 5f63 6f6e 6669 675f 6669 6c65  ster_config_file
+0000a420: 290a 2020 2020 2320 4368 6563 6b20 7468  ).    # Check th
+0000a430: 6520 6176 6169 6c61 6269 6c69 7479 206f  e availability o
+0000a440: 6620 7468 6520 636c 6f75 6420 7479 7065  f the cloud type
+0000a450: 2e0a 2020 2020 6966 2069 7369 6e73 7461  ..    if isinsta
+0000a460: 6e63 6528 636c 6f75 642c 2028 636c 6f75  nce(cloud, (clou
+0000a470: 6473 2e41 5753 2c20 636c 6f75 6473 2e4f  ds.AWS, clouds.O
+0000a480: 4349 2c20 636c 6f75 6473 2e53 4350 2c20  CI, clouds.SCP, 
+0000a490: 636c 6f75 6473 2e56 7370 6865 7265 2c0a  clouds.Vsphere,.
+0000a4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a4b0: 2020 2020 2020 2020 2020 636c 6f75 6473            clouds
+0000a4c0: 2e43 7564 6f2c 2063 6c6f 7564 732e 5061  .Cudo, clouds.Pa
+0000a4d0: 7065 7273 7061 6365 2929 3a0a 2020 2020  perspace)):.    
+0000a4e0: 2020 2020 636f 6e66 6967 203d 2061 7574      config = aut
+0000a4f0: 682e 636f 6e66 6967 7572 655f 7373 685f  h.configure_ssh_
+0000a500: 696e 666f 2863 6f6e 6669 6729 0a20 2020  info(config).   
+0000a510: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+0000a520: 2863 6c6f 7564 2c20 636c 6f75 6473 2e47  (cloud, clouds.G
+0000a530: 4350 293a 0a20 2020 2020 2020 2063 6f6e  CP):.        con
+0000a540: 6669 6720 3d20 6175 7468 2e73 6574 7570  fig = auth.setup
+0000a550: 5f67 6370 5f61 7574 6865 6e74 6963 6174  _gcp_authenticat
+0000a560: 696f 6e28 636f 6e66 6967 290a 2020 2020  ion(config).    
+0000a570: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+0000a580: 636c 6f75 642c 2063 6c6f 7564 732e 417a  cloud, clouds.Az
+0000a590: 7572 6529 3a0a 2020 2020 2020 2020 636f  ure):.        co
+0000a5a0: 6e66 6967 203d 2061 7574 682e 7365 7475  nfig = auth.setu
+0000a5b0: 705f 617a 7572 655f 6175 7468 656e 7469  p_azure_authenti
+0000a5c0: 6361 7469 6f6e 2863 6f6e 6669 6729 0a20  cation(config). 
+0000a5d0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+0000a5e0: 6365 2863 6c6f 7564 2c20 636c 6f75 6473  ce(cloud, clouds
+0000a5f0: 2e4c 616d 6264 6129 3a0a 2020 2020 2020  .Lambda):.      
+0000a600: 2020 636f 6e66 6967 203d 2061 7574 682e    config = auth.
+0000a610: 7365 7475 705f 6c61 6d62 6461 5f61 7574  setup_lambda_aut
+0000a620: 6865 6e74 6963 6174 696f 6e28 636f 6e66  hentication(conf
+0000a630: 6967 290a 2020 2020 656c 6966 2069 7369  ig).    elif isi
+0000a640: 6e73 7461 6e63 6528 636c 6f75 642c 2063  nstance(cloud, c
+0000a650: 6c6f 7564 732e 4b75 6265 726e 6574 6573  louds.Kubernetes
+0000a660: 293a 0a20 2020 2020 2020 2063 6f6e 6669  ):.        confi
+0000a670: 6720 3d20 6175 7468 2e73 6574 7570 5f6b  g = auth.setup_k
+0000a680: 7562 6572 6e65 7465 735f 6175 7468 656e  ubernetes_authen
+0000a690: 7469 6361 7469 6f6e 2863 6f6e 6669 6729  tication(config)
+0000a6a0: 0a20 2020 2065 6c69 6620 6973 696e 7374  .    elif isinst
+0000a6b0: 616e 6365 2863 6c6f 7564 2c20 636c 6f75  ance(cloud, clou
+0000a6c0: 6473 2e49 424d 293a 0a20 2020 2020 2020  ds.IBM):.       
+0000a6d0: 2063 6f6e 6669 6720 3d20 6175 7468 2e73   config = auth.s
+0000a6e0: 6574 7570 5f69 626d 5f61 7574 6865 6e74  etup_ibm_authent
+0000a6f0: 6963 6174 696f 6e28 636f 6e66 6967 290a  ication(config).
+0000a700: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+0000a710: 6e63 6528 636c 6f75 642c 2063 6c6f 7564  nce(cloud, cloud
+0000a720: 732e 5275 6e50 6f64 293a 0a20 2020 2020  s.RunPod):.     
+0000a730: 2020 2063 6f6e 6669 6720 3d20 6175 7468     config = auth
+0000a740: 2e73 6574 7570 5f72 756e 706f 645f 6175  .setup_runpod_au
+0000a750: 7468 656e 7469 6361 7469 6f6e 2863 6f6e  thentication(con
+0000a760: 6669 6729 0a20 2020 2065 6c69 6620 6973  fig).    elif is
+0000a770: 696e 7374 616e 6365 2863 6c6f 7564 2c20  instance(cloud, 
+0000a780: 636c 6f75 6473 2e46 6c75 6964 7374 6163  clouds.Fluidstac
+0000a790: 6b29 3a0a 2020 2020 2020 2020 636f 6e66  k):.        conf
+0000a7a0: 6967 203d 2061 7574 682e 7365 7475 705f  ig = auth.setup_
+0000a7b0: 666c 7569 6473 7461 636b 5f61 7574 6865  fluidstack_authe
+0000a7c0: 6e74 6963 6174 696f 6e28 636f 6e66 6967  ntication(config
+0000a7d0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+0000a7e0: 2020 2020 6173 7365 7274 2046 616c 7365      assert False
+0000a7f0: 2c20 636c 6f75 640a 2020 2020 636f 6d6d  , cloud.    comm
+0000a800: 6f6e 5f75 7469 6c73 2e64 756d 705f 7961  on_utils.dump_ya
+0000a810: 6d6c 2863 6c75 7374 6572 5f63 6f6e 6669  ml(cluster_confi
+0000a820: 675f 6669 6c65 2c20 636f 6e66 6967 290a  g_file, config).
+0000a830: 0a0a 6465 6620 6765 745f 7275 6e5f 7469  ..def get_run_ti
+0000a840: 6d65 7374 616d 7028 2920 2d3e 2073 7472  mestamp() -> str
+0000a850: 3a0a 2020 2020 7265 7475 726e 2027 736b  :.    return 'sk
+0000a860: 792d 2720 2b20 6461 7465 7469 6d65 2e6e  y-' + datetime.n
+0000a870: 6f77 2829 2e73 7472 6674 696d 6528 2725  ow().strftime('%
+0000a880: 592d 256d 2d25 642d 2548 2d25 4d2d 2553  Y-%m-%d-%H-%M-%S
+0000a890: 2d25 6627 290a 0a0a 6465 6620 6765 745f  -%f')...def get_
+0000a8a0: 7469 6d65 7374 616d 705f 6672 6f6d 5f72  timestamp_from_r
+0000a8b0: 756e 5f74 696d 6573 7461 6d70 2872 756e  un_timestamp(run
+0000a8c0: 5f74 696d 6573 7461 6d70 3a20 7374 7229  _timestamp: str)
+0000a8d0: 202d 3e20 666c 6f61 743a 0a20 2020 2072   -> float:.    r
+0000a8e0: 6574 7572 6e20 6461 7465 7469 6d65 2e73  eturn datetime.s
+0000a8f0: 7472 7074 696d 6528 0a20 2020 2020 2020  trptime(.       
+0000a900: 2072 756e 5f74 696d 6573 7461 6d70 2e70   run_timestamp.p
+0000a910: 6172 7469 7469 6f6e 2827 2d27 295b 325d  artition('-')[2]
+0000a920: 2c20 2725 592d 256d 2d25 642d 2548 2d25  , '%Y-%m-%d-%H-%
+0000a930: 4d2d 2553 2d25 6627 292e 7469 6d65 7374  M-%S-%f').timest
+0000a940: 616d 7028 290a 0a0a 6465 6620 5f63 6f75  amp()...def _cou
+0000a950: 6e74 5f68 6561 6c74 6879 5f6e 6f64 6573  nt_healthy_nodes
+0000a960: 5f66 726f 6d5f 7261 7928 6f75 7470 7574  _from_ray(output
+0000a970: 3a20 7374 722c 0a20 2020 2020 2020 2020  : str,.         
+0000a980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a990: 2020 2020 2020 2020 2069 735f 6c6f 6361           is_loca
+0000a9a0: 6c5f 636c 6f75 643a 2062 6f6f 6c20 3d20  l_cloud: bool = 
+0000a9b0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+0000a9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a9d0: 2020 2020 2020 2029 202d 3e20 5475 706c         ) -> Tupl
+0000a9e0: 655b 696e 742c 2069 6e74 5d3a 0a20 2020  e[int, int]:.   
+0000a9f0: 2022 2222 436f 756e 7420 7468 6520 6e75   """Count the nu
+0000aa00: 6d62 6572 206f 6620 6865 616c 7468 7920  mber of healthy 
+0000aa10: 6e6f 6465 7320 6672 6f6d 2074 6865 206f  nodes from the o
+0000aa20: 7574 7075 7420 6f66 2060 7261 7920 7374  utput of `ray st
+0000aa30: 6174 7573 602e 2222 220a 0a20 2020 2064  atus`."""..    d
+0000aa40: 6566 2067 6574 5f72 6561 6479 5f6e 6f64  ef get_ready_nod
+0000aa50: 6573 5f63 6f75 6e74 7328 7061 7474 6572  es_counts(patter
+0000aa60: 6e2c 206f 7574 7075 7429 3a0a 2020 2020  n, output):.    
+0000aa70: 2020 2020 7265 7375 6c74 203d 2070 6174      result = pat
+0000aa80: 7465 726e 2e66 696e 6461 6c6c 286f 7574  tern.findall(out
+0000aa90: 7075 7429 0a20 2020 2020 2020 2069 6620  put).        if 
+0000aaa0: 6e6f 7420 7265 7375 6c74 3a0a 2020 2020  not result:.    
+0000aab0: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
+0000aac0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0000aad0: 6c65 6e28 7265 7375 6c74 2920 3d3d 2031  len(result) == 1
+0000aae0: 2c20 7265 7375 6c74 0a20 2020 2020 2020  , result.       
+0000aaf0: 2072 6574 7572 6e20 696e 7428 7265 7375   return int(resu
+0000ab00: 6c74 5b30 5d29 0a0a 2020 2020 2320 4368  lt[0])..    # Ch
+0000ab10: 6563 6b20 6966 2074 6865 2072 6179 2063  eck if the ray c
+0000ab20: 6c75 7374 6572 2069 7320 7374 6172 7465  luster is starte
+0000ab30: 6420 7769 7468 2072 6179 2061 7574 6f73  d with ray autos
+0000ab40: 6361 6c65 722e 2049 6e20 6e65 770a 2020  caler. In new.  
+0000ab50: 2020 2320 7072 6f76 6973 696f 6e65 7220    # provisioner 
+0000ab60: 2823 3137 3032 2920 616e 6420 6c6f 6361  (#1702) and loca
+0000ab70: 6c20 6d6f 6465 2c20 7765 2073 7461 7274  l mode, we start
+0000ab80: 6564 2074 6865 2072 6179 2063 6c75 7374  ed the ray clust
+0000ab90: 6572 2077 6974 686f 7574 2072 6179 0a20  er without ray. 
+0000aba0: 2020 2023 2061 7574 6f73 6361 6c65 722e     # autoscaler.
+0000abb0: 0a20 2020 2023 2049 6620 7261 7920 636c  .    # If ray cl
+0000abc0: 7573 7465 7220 6973 2073 7461 7274 6564  uster is started
+0000abd0: 2077 6974 6820 7261 7920 6175 746f 7363   with ray autosc
+0000abe0: 616c 6572 2c20 7468 6520 6f75 7470 7574  aler, the output
+0000abf0: 2077 696c 6c20 6265 3a0a 2020 2020 2320   will be:.    # 
+0000ac00: 2031 2072 6179 2e68 6561 642e 6465 6661   1 ray.head.defa
+0000ac10: 756c 740a 2020 2020 2320 202e 2e2e 0a20  ult.    #  .... 
+0000ac20: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
+0000ac30: 206f 6e63 6520 7765 2064 6570 7265 6361   once we depreca
+0000ac40: 7465 2074 6865 206f 6c64 2070 726f 7669  te the old provi
+0000ac50: 7369 6f6e 6572 2c20 7765 2063 616e 2072  sioner, we can r
+0000ac60: 656d 6f76 6520 7468 6973 0a20 2020 2023  emove this.    #
+0000ac70: 2063 6865 636b 2e0a 2020 2020 7261 795f   check..    ray_
+0000ac80: 6175 746f 7363 616c 6572 5f68 6561 6420  autoscaler_head 
+0000ac90: 3d20 6765 745f 7265 6164 795f 6e6f 6465  = get_ready_node
+0000aca0: 735f 636f 756e 7473 285f 4c41 554e 4348  s_counts(_LAUNCH
+0000acb0: 4544 5f48 4541 445f 5041 5454 4552 4e2c  ED_HEAD_PATTERN,
+0000acc0: 206f 7574 7075 7429 0a20 2020 2069 735f   output).    is_
+0000acd0: 6c6f 6361 6c5f 7261 795f 636c 7573 7465  local_ray_cluste
+0000ace0: 7220 3d20 7261 795f 6175 746f 7363 616c  r = ray_autoscal
+0000acf0: 6572 5f68 6561 6420 3d3d 2030 0a0a 2020  er_head == 0..  
+0000ad00: 2020 6966 2069 735f 6c6f 6361 6c5f 7261    if is_local_ra
+0000ad10: 795f 636c 7573 7465 7220 6f72 2069 735f  y_cluster or is_
+0000ad20: 6c6f 6361 6c5f 636c 6f75 643a 0a20 2020  local_cloud:.   
+0000ad30: 2020 2020 2023 2052 6179 2063 6c75 7374       # Ray clust
+0000ad40: 6572 2069 7320 6c61 756e 6368 6564 2077  er is launched w
+0000ad50: 6974 6820 6e65 7720 7072 6f76 6973 696f  ith new provisio
+0000ad60: 6e65 720a 2020 2020 2020 2020 2320 466f  ner.        # Fo
+0000ad70: 7220 6e65 7720 7072 6f76 6973 696f 6e65  r new provisione
+0000ad80: 7220 616e 6420 6c6f 6361 6c20 6d6f 6465  r and local mode
+0000ad90: 2c20 7468 6520 6f75 7470 7574 2077 696c  , the output wil
+0000ada0: 6c20 6265 3a0a 2020 2020 2020 2020 2320  l be:.        # 
+0000adb0: 2031 206e 6f64 655f 7878 7878 0a20 2020   1 node_xxxx.   
+0000adc0: 2020 2020 2023 2020 3120 6e6f 6465 5f78       #  1 node_x
+0000add0: 7878 780a 2020 2020 2020 2020 7265 6164  xxx.        read
+0000ade0: 795f 6865 6164 203d 2030 0a20 2020 2020  y_head = 0.     
+0000adf0: 2020 2072 6561 6479 5f77 6f72 6b65 7273     ready_workers
+0000ae00: 203d 205f 4c41 554e 4348 4544 5f4c 4f43   = _LAUNCHED_LOC
+0000ae10: 414c 5f57 4f52 4b45 525f 5041 5454 4552  AL_WORKER_PATTER
+0000ae20: 4e2e 6669 6e64 616c 6c28 6f75 7470 7574  N.findall(output
+0000ae30: 290a 2020 2020 2020 2020 7265 6164 795f  ).        ready_
+0000ae40: 776f 726b 6572 7320 3d20 6c65 6e28 7265  workers = len(re
+0000ae50: 6164 795f 776f 726b 6572 7329 0a20 2020  ady_workers).   
+0000ae60: 2020 2020 2069 6620 6973 5f6c 6f63 616c       if is_local
+0000ae70: 5f72 6179 5f63 6c75 7374 6572 3a0a 2020  _ray_cluster:.  
+0000ae80: 2020 2020 2020 2020 2020 7265 6164 795f            ready_
+0000ae90: 6865 6164 203d 2031 0a20 2020 2020 2020  head = 1.       
+0000aea0: 2020 2020 2072 6561 6479 5f77 6f72 6b65       ready_worke
+0000aeb0: 7273 202d 3d20 310a 2020 2020 2020 2020  rs -= 1.        
+0000aec0: 7265 7475 726e 2072 6561 6479 5f68 6561  return ready_hea
+0000aed0: 642c 2072 6561 6479 5f77 6f72 6b65 7273  d, ready_workers
+0000aee0: 0a0a 2020 2020 2320 436f 756e 7420 6e75  ..    # Count nu
+0000aef0: 6d62 6572 206f 6620 6e6f 6465 7320 6279  mber of nodes by
+0000af00: 2070 6172 7369 6e67 2074 6865 206f 7574   parsing the out
+0000af10: 7075 7420 6f66 2060 7261 7920 7374 6174  put of `ray stat
+0000af20: 7573 602e 2054 6865 206f 7574 7075 740a  us`. The output.
+0000af30: 2020 2020 2320 6c6f 6f6b 7320 6c69 6b65      # looks like
+0000af40: 3a0a 2020 2020 2320 2020 3120 7261 792e  :.    #   1 ray.
+0000af50: 6865 6164 2e64 6566 6175 6c74 0a20 2020  head.default.   
+0000af60: 2023 2020 2032 2072 6179 2e77 6f72 6b65   #   2 ray.worke
+0000af70: 722e 6465 6661 756c 740a 2020 2020 7265  r.default.    re
+0000af80: 6164 795f 6865 6164 203d 2072 6179 5f61  ady_head = ray_a
+0000af90: 7574 6f73 6361 6c65 725f 6865 6164 0a20  utoscaler_head. 
+0000afa0: 2020 2072 6561 6479 5f77 6f72 6b65 7273     ready_workers
+0000afb0: 203d 2067 6574 5f72 6561 6479 5f6e 6f64   = get_ready_nod
+0000afc0: 6573 5f63 6f75 6e74 7328 5f4c 4155 4e43  es_counts(_LAUNC
+0000afd0: 4845 445f 574f 524b 4552 5f50 4154 5445  HED_WORKER_PATTE
+0000afe0: 524e 2c20 6f75 7470 7574 290a 2020 2020  RN, output).    
+0000aff0: 7265 6164 795f 7265 7365 7276 6564 5f77  ready_reserved_w
+0000b000: 6f72 6b65 7273 203d 2067 6574 5f72 6561  orkers = get_rea
+0000b010: 6479 5f6e 6f64 6573 5f63 6f75 6e74 7328  dy_nodes_counts(
+0000b020: 0a20 2020 2020 2020 205f 4c41 554e 4348  .        _LAUNCH
+0000b030: 4544 5f52 4553 4552 5645 445f 574f 524b  ED_RESERVED_WORK
+0000b040: 4552 5f50 4154 5445 524e 2c20 6f75 7470  ER_PATTERN, outp
+0000b050: 7574 290a 2020 2020 7265 6164 795f 776f  ut).    ready_wo
+0000b060: 726b 6572 7320 2b3d 2072 6561 6479 5f72  rkers += ready_r
+0000b070: 6573 6572 7665 645f 776f 726b 6572 730a  eserved_workers.
+0000b080: 2020 2020 6173 7365 7274 2072 6561 6479      assert ready
+0000b090: 5f68 6561 6420 3c3d 2031 2c20 6627 2368  _head <= 1, f'#h
+0000b0a0: 6561 6420 6e6f 6465 2073 686f 756c 6420  ead node should 
+0000b0b0: 6265 203c 3d31 2028 476f 7420 7b72 6561  be <=1 (Got {rea
+0000b0c0: 6479 5f68 6561 647d 292e 270a 2020 2020  dy_head}).'.    
+0000b0d0: 7265 7475 726e 2072 6561 6479 5f68 6561  return ready_hea
+0000b0e0: 642c 2072 6561 6479 5f77 6f72 6b65 7273  d, ready_workers
+0000b0f0: 0a0a 0a64 6566 2067 6574 5f64 6f63 6b65  ...def get_docke
+0000b100: 725f 7573 6572 2869 703a 2073 7472 2c20  r_user(ip: str, 
+0000b110: 636c 7573 7465 725f 636f 6e66 6967 5f66  cluster_config_f
+0000b120: 696c 653a 2073 7472 2920 2d3e 2073 7472  ile: str) -> str
+0000b130: 3a0a 2020 2020 2222 2246 696e 6420 646f  :.    """Find do
+0000b140: 636b 6572 2063 6f6e 7461 696e 6572 2075  cker container u
+0000b150: 7365 726e 616d 652e 2222 220a 2020 2020  sername.""".    
+0000b160: 7373 685f 6372 6564 656e 7469 616c 7320  ssh_credentials 
+0000b170: 3d20 7373 685f 6372 6564 656e 7469 616c  = ssh_credential
+0000b180: 5f66 726f 6d5f 7961 6d6c 2863 6c75 7374  _from_yaml(clust
+0000b190: 6572 5f63 6f6e 6669 675f 6669 6c65 290a  er_config_file).
+0000b1a0: 2020 2020 7275 6e6e 6572 203d 2063 6f6d      runner = com
+0000b1b0: 6d61 6e64 5f72 756e 6e65 722e 5353 4843  mand_runner.SSHC
+0000b1c0: 6f6d 6d61 6e64 5275 6e6e 6572 2869 702c  ommandRunner(ip,
+0000b1d0: 2070 6f72 743d 3232 2c20 2a2a 7373 685f   port=22, **ssh_
+0000b1e0: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
+0000b1f0: 2063 6f6e 7461 696e 6572 5f6e 616d 6520   container_name 
+0000b200: 3d20 636f 6e73 7461 6e74 732e 4445 4641  = constants.DEFA
+0000b210: 554c 545f 444f 434b 4552 5f43 4f4e 5441  ULT_DOCKER_CONTA
+0000b220: 494e 4552 5f4e 414d 450a 2020 2020 7768  INER_NAME.    wh
+0000b230: 6f61 6d69 5f72 6574 7572 6e63 6f64 652c  oami_returncode,
+0000b240: 2077 686f 616d 695f 7374 646f 7574 2c20   whoami_stdout, 
+0000b250: 7768 6f61 6d69 5f73 7464 6572 7220 3d20  whoami_stderr = 
+0000b260: 7275 6e6e 6572 2e72 756e 280a 2020 2020  runner.run(.    
+0000b270: 2020 2020 6627 7375 646f 2064 6f63 6b65      f'sudo docke
+0000b280: 7220 6578 6563 207b 636f 6e74 6169 6e65  r exec {containe
+0000b290: 725f 6e61 6d65 7d20 7768 6f61 6d69 272c  r_name} whoami',
+0000b2a0: 0a20 2020 2020 2020 2073 7472 6561 6d5f  .        stream_
+0000b2b0: 6c6f 6773 3d46 616c 7365 2c0a 2020 2020  logs=False,.    
+0000b2c0: 2020 2020 7265 7175 6972 655f 6f75 7470      require_outp
+0000b2d0: 7574 733d 5472 7565 290a 2020 2020 6173  uts=True).    as
+0000b2e0: 7365 7274 2077 686f 616d 695f 7265 7475  sert whoami_retu
+0000b2f0: 726e 636f 6465 203d 3d20 302c 2028 0a20  rncode == 0, (. 
+0000b300: 2020 2020 2020 2066 2746 6169 6c65 6420         f'Failed 
+0000b310: 746f 2067 6574 2064 6f63 6b65 7220 636f  to get docker co
+0000b320: 6e74 6169 6e65 7220 7573 6572 2e20 5265  ntainer user. Re
+0000b330: 7475 726e 2027 0a20 2020 2020 2020 2066  turn '.        f
+0000b340: 2763 6f64 653a 207b 7768 6f61 6d69 5f72  'code: {whoami_r
+0000b350: 6574 7572 6e63 6f64 657d 2c20 4572 726f  eturncode}, Erro
+0000b360: 723a 207b 7768 6f61 6d69 5f73 7464 6572  r: {whoami_stder
+0000b370: 727d 2729 0a20 2020 2064 6f63 6b65 725f  r}').    docker_
+0000b380: 7573 6572 203d 2077 686f 616d 695f 7374  user = whoami_st
+0000b390: 646f 7574 2e73 7472 6970 2829 0a20 2020  dout.strip().   
+0000b3a0: 206c 6f67 6765 722e 6465 6275 6728 6627   logger.debug(f'
+0000b3b0: 446f 636b 6572 2063 6f6e 7461 696e 6572  Docker container
+0000b3c0: 2075 7365 723a 207b 646f 636b 6572 5f75   user: {docker_u
+0000b3d0: 7365 727d 2729 0a20 2020 2072 6574 7572  ser}').    retur
+0000b3e0: 6e20 646f 636b 6572 5f75 7365 720a 0a0a  n docker_user...
+0000b3f0: 4074 696d 656c 696e 652e 6576 656e 740a  @timeline.event.
+0000b400: 6465 6620 7761 6974 5f75 6e74 696c 5f72  def wait_until_r
+0000b410: 6179 5f63 6c75 7374 6572 5f72 6561 6479  ay_cluster_ready
+0000b420: 280a 2020 2020 636c 7573 7465 725f 636f  (.    cluster_co
+0000b430: 6e66 6967 5f66 696c 653a 2073 7472 2c0a  nfig_file: str,.
+0000b440: 2020 2020 6e75 6d5f 6e6f 6465 733a 2069      num_nodes: i
+0000b450: 6e74 2c0a 2020 2020 6c6f 675f 7061 7468  nt,.    log_path
+0000b460: 3a20 7374 722c 0a20 2020 2069 735f 6c6f  : str,.    is_lo
+0000b470: 6361 6c5f 636c 6f75 643a 2062 6f6f 6c20  cal_cloud: bool 
+0000b480: 3d20 4661 6c73 652c 0a20 2020 206e 6f64  = False,.    nod
+0000b490: 6573 5f6c 6175 6e63 6869 6e67 5f70 726f  es_launching_pro
+0000b4a0: 6772 6573 735f 7469 6d65 6f75 743a 204f  gress_timeout: O
+0000b4b0: 7074 696f 6e61 6c5b 696e 745d 203d 204e  ptional[int] = N
+0000b4c0: 6f6e 652c 0a29 202d 3e20 5475 706c 655b  one,.) -> Tuple[
+0000b4d0: 626f 6f6c 2c20 4f70 7469 6f6e 616c 5b73  bool, Optional[s
+0000b4e0: 7472 5d5d 3a0a 2020 2020 2222 2257 6169  tr]]:.    """Wai
+0000b4f0: 7420 756e 7469 6c20 7468 6520 7261 7920  t until the ray 
+0000b500: 636c 7573 7465 7220 6973 2073 6574 2075  cluster is set u
+0000b510: 7020 6f6e 2056 4d73 206f 7220 696e 2063  p on VMs or in c
+0000b520: 6f6e 7461 696e 6572 732e 0a0a 2020 2020  ontainers...    
+0000b530: 5265 7475 726e 733a 2020 7768 6574 6865  Returns:  whethe
+0000b540: 7220 7468 6520 656e 7469 7265 2072 6179  r the entire ray
+0000b550: 2063 6c75 7374 6572 2069 7320 7265 6164   cluster is read
+0000b560: 792c 2061 6e64 2064 6f63 6b65 7220 7573  y, and docker us
+0000b570: 6572 6e61 6d65 0a20 2020 2069 6620 6c61  ername.    if la
+0000b580: 756e 6368 6564 2077 6974 6820 646f 636b  unched with dock
+0000b590: 6572 2e0a 2020 2020 2222 220a 2020 2020  er..    """.    
+0000b5a0: 2320 4d61 6e75 616c 6c79 2066 6574 6368  # Manually fetch
+0000b5b0: 696e 6720 6865 6164 2069 7020 696e 7374  ing head ip inst
+0000b5c0: 6561 6420 6f66 2075 7369 6e67 2060 7261  ead of using `ra
+0000b5d0: 7920 6578 6563 6020 746f 2061 766f 6964  y exec` to avoid
+0000b5e0: 2074 6865 2062 7567 0a20 2020 2023 2074   the bug.    # t
+0000b5f0: 6861 7420 6072 6179 2065 7865 6360 2066  hat `ray exec` f
+0000b600: 6169 6c73 2074 6f20 636f 6e6e 6563 7420  ails to connect 
+0000b610: 746f 2074 6865 2068 6561 6420 6e6f 6465  to the head node
+0000b620: 2061 6674 6572 2073 6f6d 6520 776f 726b   after some work
+0000b630: 6572 730a 2020 2020 2320 6c61 756e 6368  ers.    # launch
+0000b640: 6564 2065 7370 6563 6961 6c6c 7920 666f  ed especially fo
+0000b650: 7220 417a 7572 652e 0a20 2020 2074 7279  r Azure..    try
+0000b660: 3a0a 2020 2020 2020 2020 6865 6164 5f69  :.        head_i
+0000b670: 7020 3d20 5f71 7565 7279 5f68 6561 645f  p = _query_head_
+0000b680: 6970 5f77 6974 685f 7265 7472 6965 7328  ip_with_retries(
+0000b690: 0a20 2020 2020 2020 2020 2020 2063 6c75  .            clu
+0000b6a0: 7374 6572 5f63 6f6e 6669 675f 6669 6c65  ster_config_file
+0000b6b0: 2c20 6d61 785f 6174 7465 6d70 7473 3d57  , max_attempts=W
+0000b6c0: 4149 545f 4845 4144 5f4e 4f44 455f 4950  AIT_HEAD_NODE_IP
+0000b6d0: 5f4d 4158 5f41 5454 454d 5054 5329 0a20  _MAX_ATTEMPTS). 
+0000b6e0: 2020 2065 7863 6570 7420 6578 6365 7074     except except
+0000b6f0: 696f 6e73 2e46 6574 6368 4950 4572 726f  ions.FetchIPErro
+0000b700: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
+0000b710: 6c6f 6767 6572 2e65 7272 6f72 2863 6f6d  logger.error(com
+0000b720: 6d6f 6e5f 7574 696c 732e 666f 726d 6174  mon_utils.format
+0000b730: 5f65 7863 6570 7469 6f6e 2865 2929 0a20  _exception(e)). 
+0000b740: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
+0000b750: 6c73 652c 204e 6f6e 6520 2023 2066 6169  lse, None  # fai
+0000b760: 6c65 640a 0a20 2020 2063 6f6e 6669 6720  led..    config 
+0000b770: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e72  = common_utils.r
+0000b780: 6561 645f 7961 6d6c 2863 6c75 7374 6572  ead_yaml(cluster
+0000b790: 5f63 6f6e 6669 675f 6669 6c65 290a 0a20  _config_file).. 
+0000b7a0: 2020 2064 6f63 6b65 725f 7573 6572 203d     docker_user =
+0000b7b0: 204e 6f6e 650a 2020 2020 6966 2027 646f   None.    if 'do
+0000b7c0: 636b 6572 2720 696e 2063 6f6e 6669 673a  cker' in config:
+0000b7d0: 0a20 2020 2020 2020 2064 6f63 6b65 725f  .        docker_
+0000b7e0: 7573 6572 203d 2067 6574 5f64 6f63 6b65  user = get_docke
+0000b7f0: 725f 7573 6572 2868 6561 645f 6970 2c20  r_user(head_ip, 
+0000b800: 636c 7573 7465 725f 636f 6e66 6967 5f66  cluster_config_f
+0000b810: 696c 6529 0a0a 2020 2020 6966 206e 756d  ile)..    if num
+0000b820: 5f6e 6f64 6573 203c 3d20 313a 0a20 2020  _nodes <= 1:.   
+0000b830: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+0000b840: 2c20 646f 636b 6572 5f75 7365 720a 0a20  , docker_user.. 
+0000b850: 2020 2073 7368 5f63 7265 6465 6e74 6961     ssh_credentia
+0000b860: 6c73 203d 2073 7368 5f63 7265 6465 6e74  ls = ssh_credent
+0000b870: 6961 6c5f 6672 6f6d 5f79 616d 6c28 636c  ial_from_yaml(cl
+0000b880: 7573 7465 725f 636f 6e66 6967 5f66 696c  uster_config_fil
+0000b890: 652c 2064 6f63 6b65 725f 7573 6572 290a  e, docker_user).
+0000b8a0: 2020 2020 6c61 7374 5f6e 6f64 6573 5f73      last_nodes_s
+0000b8b0: 6f5f 6661 7220 3d20 300a 2020 2020 7374  o_far = 0.    st
+0000b8c0: 6172 7420 3d20 7469 6d65 2e74 696d 6528  art = time.time(
+0000b8d0: 290a 2020 2020 7275 6e6e 6572 203d 2063  ).    runner = c
+0000b8e0: 6f6d 6d61 6e64 5f72 756e 6e65 722e 5353  ommand_runner.SS
+0000b8f0: 4843 6f6d 6d61 6e64 5275 6e6e 6572 2868  HCommandRunner(h
+0000b900: 6561 645f 6970 2c0a 2020 2020 2020 2020  ead_ip,.        
+0000b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b940: 2020 2020 2020 706f 7274 3d32 322c 0a20        port=22,. 
+0000b930: 2020 2020 2070 6f72 743d 3232 2c0a 2020       port=22,.  
+0000b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000b950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b970: 2020 2020 2020 2020 2020 2020 2a2a 7373              **ss
-0000b980: 685f 6372 6564 656e 7469 616c 7329 0a20  h_credentials). 
-0000b990: 2020 2077 6974 6820 7269 6368 5f75 7469     with rich_uti
-0000b9a0: 6c73 2e73 6166 655f 7374 6174 7573 280a  ls.safe_status(.
-0000b9b0: 2020 2020 2020 2020 2020 2020 275b 626f              '[bo
-0000b9c0: 6c64 2063 7961 6e5d 5761 6974 696e 6720  ld cyan]Waiting 
-0000b9d0: 666f 7220 776f 726b 6572 732e 2e2e 2729  for workers...')
-0000b9e0: 2061 7320 776f 726b 6572 5f73 7461 7475   as worker_statu
-0000b9f0: 733a 0a20 2020 2020 2020 2077 6869 6c65  s:.        while
-0000ba00: 2054 7275 653a 0a20 2020 2020 2020 2020   True:.         
-0000ba10: 2020 2072 632c 206f 7574 7075 742c 2073     rc, output, s
-0000ba20: 7464 6572 7220 3d20 7275 6e6e 6572 2e72  tderr = runner.r
-0000ba30: 756e 280a 2020 2020 2020 2020 2020 2020  un(.            
-0000ba40: 2020 2020 696e 7374 616e 6365 5f73 6574      instance_set
-0000ba50: 7570 2e52 4159 5f53 5441 5455 535f 5749  up.RAY_STATUS_WI
-0000ba60: 5448 5f53 4b59 5f52 4159 5f50 4f52 545f  TH_SKY_RAY_PORT_
-0000ba70: 434f 4d4d 414e 442c 0a20 2020 2020 2020  COMMAND,.       
-0000ba80: 2020 2020 2020 2020 206c 6f67 5f70 6174           log_pat
-0000ba90: 683d 6c6f 675f 7061 7468 2c0a 2020 2020  h=log_path,.    
-0000baa0: 2020 2020 2020 2020 2020 2020 7374 7265              stre
-0000bab0: 616d 5f6c 6f67 733d 4661 6c73 652c 0a20  am_logs=False,. 
-0000bac0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000bad0: 6571 7569 7265 5f6f 7574 7075 7473 3d54  equire_outputs=T
-0000bae0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-0000baf0: 2020 2020 2073 6570 6172 6174 655f 7374       separate_st
-0000bb00: 6465 7272 3d54 7275 6529 0a20 2020 2020  derr=True).     
-0000bb10: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
-0000bb20: 735f 7574 696c 732e 6861 6e64 6c65 5f72  s_utils.handle_r
-0000bb30: 6574 7572 6e63 6f64 6528 0a20 2020 2020  eturncode(.     
-0000bb40: 2020 2020 2020 2020 2020 2072 632c 2069             rc, i
-0000bb50: 6e73 7461 6e63 655f 7365 7475 702e 5241  nstance_setup.RA
-0000bb60: 595f 5354 4154 5553 5f57 4954 485f 534b  Y_STATUS_WITH_SK
-0000bb70: 595f 5241 595f 504f 5254 5f43 4f4d 4d41  Y_RAY_PORT_COMMA
-0000bb80: 4e44 2c0a 2020 2020 2020 2020 2020 2020  ND,.            
-0000bb90: 2020 2020 2746 6169 6c65 6420 746f 2072      'Failed to r
-0000bba0: 756e 2072 6179 2073 7461 7475 7320 6f6e  un ray status on
-0000bbb0: 2068 6561 6420 6e6f 6465 2e27 2c20 7374   head node.', st
-0000bbc0: 6465 7272 290a 2020 2020 2020 2020 2020  derr).          
-0000bbd0: 2020 6c6f 6767 6572 2e64 6562 7567 286f    logger.debug(o
-0000bbe0: 7574 7075 7429 0a0a 2020 2020 2020 2020  utput)..        
-0000bbf0: 2020 2020 7265 6164 795f 6865 6164 2c20      ready_head, 
-0000bc00: 7265 6164 795f 776f 726b 6572 7320 3d20  ready_workers = 
-0000bc10: 5f63 6f75 6e74 5f68 6561 6c74 6879 5f6e  _count_healthy_n
-0000bc20: 6f64 6573 5f66 726f 6d5f 7261 7928 0a20  odes_from_ray(. 
-0000bc30: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0000bc40: 7574 7075 742c 2069 735f 6c6f 6361 6c5f  utput, is_local_
-0000bc50: 636c 6f75 643d 6973 5f6c 6f63 616c 5f63  cloud=is_local_c
-0000bc60: 6c6f 7564 290a 0a20 2020 2020 2020 2020  loud)..         
-0000bc70: 2020 2077 6f72 6b65 725f 7374 6174 7573     worker_status
-0000bc80: 2e75 7064 6174 6528 275b 626f 6c64 2063  .update('[bold c
-0000bc90: 7961 6e5d 270a 2020 2020 2020 2020 2020  yan]'.          
-0000bca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bcb0: 2020 2020 2020 2066 277b 7265 6164 795f         f'{ready_
-0000bcc0: 776f 726b 6572 737d 206f 7574 206f 6620  workers} out of 
-0000bcd0: 7b6e 756d 5f6e 6f64 6573 202d 2031 7d20  {num_nodes - 1} 
-0000bce0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000bcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd00: 2020 2027 776f 726b 6572 7320 7265 6164     'workers read
-0000bd10: 7927 290a 0a20 2020 2020 2020 2020 2020  y')..           
-0000bd20: 2023 2049 6e20 7468 6520 6c6f 6361 6c20   # In the local 
-0000bd30: 6361 7365 2c20 7265 6164 795f 6865 6164  case, ready_head
-0000bd40: 3d30 2061 6e64 2072 6561 6479 5f77 6f72  =0 and ready_wor
-0000bd50: 6b65 7273 3d6e 756d 5f6e 6f64 6573 2e20  kers=num_nodes. 
-0000bd60: 5468 6973 0a20 2020 2020 2020 2020 2020  This.           
-0000bd70: 2023 2069 7320 6265 6361 7573 6520 7468   # is because th
-0000bd80: 6572 6520 6973 206e 6f20 6d61 7463 6869  ere is no matchi
-0000bd90: 6e67 2072 6567 6578 2066 6f72 205f 4c41  ng regex for _LA
-0000bda0: 554e 4348 4544 5f48 4541 445f 5041 5454  UNCHED_HEAD_PATT
-0000bdb0: 4552 4e2e 0a20 2020 2020 2020 2020 2020  ERN..           
-0000bdc0: 2069 6620 7265 6164 795f 6865 6164 202b   if ready_head +
-0000bdd0: 2072 6561 6479 5f77 6f72 6b65 7273 203d   ready_workers =
-0000bde0: 3d20 6e75 6d5f 6e6f 6465 733a 0a20 2020  = num_nodes:.   
-0000bdf0: 2020 2020 2020 2020 2020 2020 2023 2041               # A
-0000be00: 6c6c 206e 6f64 6573 2061 7265 2075 702e  ll nodes are up.
-0000be10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000be20: 2062 7265 616b 0a0a 2020 2020 2020 2020   break..        
-0000be30: 2020 2020 2320 5065 6e64 696e 6720 776f      # Pending wo
-0000be40: 726b 6572 7320 7468 6174 2068 6176 6520  rkers that have 
-0000be50: 6265 656e 206c 6175 6e63 6865 6420 6279  been launched by
-0000be60: 2072 6179 2075 702e 0a20 2020 2020 2020   ray up..       
-0000be70: 2020 2020 2066 6f75 6e64 5f69 7073 203d       found_ips =
-0000be80: 205f 4c41 554e 4348 494e 475f 4950 5f50   _LAUNCHING_IP_P
-0000be90: 4154 5445 524e 2e66 696e 6461 6c6c 286f  ATTERN.findall(o
-0000bea0: 7574 7075 7429 0a20 2020 2020 2020 2020  utput).         
-0000beb0: 2020 2070 656e 6469 6e67 5f77 6f72 6b65     pending_worke
-0000bec0: 7273 203d 206c 656e 2866 6f75 6e64 5f69  rs = len(found_i
-0000bed0: 7073 290a 0a20 2020 2020 2020 2020 2020  ps)..           
-0000bee0: 2023 2054 4f44 4f28 7a68 7775 293a 2048   # TODO(zhwu): H
-0000bef0: 616e 646c 6520 7468 6520 6361 7365 2077  andle the case w
-0000bf00: 6865 7265 2074 6865 2066 6f6c 6c6f 7769  here the followi
-0000bf10: 6e67 206f 6363 7572 732c 2077 6865 7265  ng occurs, where
-0000bf20: 2072 6179 0a20 2020 2020 2020 2020 2020   ray.           
-0000bf30: 2023 2063 6c75 7374 6572 2069 7320 6e6f   # cluster is no
-0000bf40: 7420 636f 7272 6563 746c 7920 7374 6172  t correctly star
-0000bf50: 7465 6420 6f6e 2074 6865 2063 6c75 7374  ted on the clust
-0000bf60: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
-0000bf70: 2320 5065 6e64 696e 673a 0a20 2020 2020  # Pending:.     
-0000bf80: 2020 2020 2020 2023 2020 3137 322e 3331         #  172.31
-0000bf90: 2e39 2e31 3231 3a20 7261 792e 776f 726b  .9.121: ray.work
-0000bfa0: 6572 2e64 6566 6175 6c74 2c20 756e 696e  er.default, unin
-0000bfb0: 6974 6961 6c69 7a65 640a 2020 2020 2020  itialized.      
-0000bfc0: 2020 2020 2020 6e6f 6465 735f 736f 5f66        nodes_so_f
-0000bfd0: 6172 203d 2072 6561 6479 5f68 6561 6420  ar = ready_head 
-0000bfe0: 2b20 7265 6164 795f 776f 726b 6572 7320  + ready_workers 
-0000bff0: 2b20 7065 6e64 696e 675f 776f 726b 6572  + pending_worker
-0000c000: 730a 0a20 2020 2020 2020 2020 2020 2023  s..            #
-0000c010: 2043 6865 636b 2074 6865 206e 756d 6265   Check the numbe
-0000c020: 7220 6f66 206e 6f64 6573 2074 6861 7420  r of nodes that 
-0000c030: 6172 6520 6665 7463 6865 642e 2054 696d  are fetched. Tim
-0000c040: 656f 7574 2069 6620 6e6f 206e 6577 0a20  eout if no new. 
-0000c050: 2020 2020 2020 2020 2020 2023 206e 6f64             # nod
-0000c060: 6573 2066 6574 6368 6564 2069 6e20 6120  es fetched in a 
-0000c070: 7768 696c 6520 286e 6f64 6573 5f6c 6175  while (nodes_lau
-0000c080: 6e63 6869 6e67 5f70 726f 6772 6573 735f  nching_progress_
-0000c090: 7469 6d65 6f75 7429 2c0a 2020 2020 2020  timeout),.      
-0000c0a0: 2020 2020 2020 2320 7468 6f75 6768 206e        # though n
-0000c0b0: 756d 6265 7220 6f66 206e 6f64 6573 5f73  umber of nodes_s
-0000c0c0: 6f5f 6661 7220 6973 2073 7469 6c6c 206e  o_far is still n
-0000c0d0: 6f74 2061 7320 6578 7065 6374 6564 2e0a  ot as expected..
-0000c0e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000c0f0: 6f64 6573 5f73 6f5f 6661 7220 3e20 6c61  odes_so_far > la
-0000c100: 7374 5f6e 6f64 6573 5f73 6f5f 6661 723a  st_nodes_so_far:
-0000c110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c120: 2023 2052 6573 6574 2074 6865 2073 7461   # Reset the sta
-0000c130: 7274 2074 696d 6520 6966 2074 6865 206e  rt time if the n
-0000c140: 756d 6265 7220 6f66 206c 6175 6e63 6869  umber of launchi
-0000c150: 6e67 206e 6f64 6573 0a20 2020 2020 2020  ng nodes.       
-0000c160: 2020 2020 2020 2020 2023 2063 6861 6e67           # chang
-0000c170: 6573 2c20 692e 652e 206e 6577 206e 6f64  es, i.e. new nod
-0000c180: 6573 2061 7265 206c 6175 6e63 6865 642e  es are launched.
-0000c190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c1a0: 206c 6f67 6765 722e 6465 6275 6728 2752   logger.debug('R
-0000c1b0: 6573 6574 2073 7461 7274 2074 696d 652c  eset start time,
-0000c1c0: 2061 7320 6e65 7720 6e6f 6465 7320 6172   as new nodes ar
-0000c1d0: 6520 6c61 756e 6368 6564 2e20 270a 2020  e launched. '.  
-0000c1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c1f0: 2020 2020 2020 2020 2020 2066 2728 7b6c             f'({l
-0000c200: 6173 745f 6e6f 6465 735f 736f 5f66 6172  ast_nodes_so_far
-0000c210: 7d20 2d3e 207b 6e6f 6465 735f 736f 5f66  } -> {nodes_so_f
-0000c220: 6172 7d29 2729 0a20 2020 2020 2020 2020  ar})').         
-0000c230: 2020 2020 2020 2073 7461 7274 203d 2074         start = t
-0000c240: 696d 652e 7469 6d65 2829 0a20 2020 2020  ime.time().     
-0000c250: 2020 2020 2020 2020 2020 206c 6173 745f             last_
-0000c260: 6e6f 6465 735f 736f 5f66 6172 203d 206e  nodes_so_far = n
-0000c270: 6f64 6573 5f73 6f5f 6661 720a 2020 2020  odes_so_far.    
-0000c280: 2020 2020 2020 2020 656c 6966 2028 6e6f          elif (no
-0000c290: 6465 735f 6c61 756e 6368 696e 675f 7072  des_launching_pr
-0000c2a0: 6f67 7265 7373 5f74 696d 656f 7574 2069  ogress_timeout i
-0000c2b0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 0a20  s not None and. 
-0000c2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2d0: 2074 696d 652e 7469 6d65 2829 202d 2073   time.time() - s
-0000c2e0: 7461 7274 203e 206e 6f64 6573 5f6c 6175  tart > nodes_lau
-0000c2f0: 6e63 6869 6e67 5f70 726f 6772 6573 735f  nching_progress_
-0000c300: 7469 6d65 6f75 7420 616e 640a 2020 2020  timeout and.    
-0000c310: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-0000c320: 6465 735f 736f 5f66 6172 2021 3d20 6e75  des_so_far != nu
-0000c330: 6d5f 6e6f 6465 7329 3a0a 2020 2020 2020  m_nodes):.      
-0000c340: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0000c350: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
-0000c360: 2020 2020 2020 2020 2020 2020 2754 696d              'Tim
-0000c370: 6564 206f 7574 3a20 7761 6974 6564 2066  ed out: waited f
-0000c380: 6f72 206d 6f72 6520 7468 616e 2027 0a20  or more than '. 
-0000c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3a0: 2020 2066 277b 6e6f 6465 735f 6c61 756e     f'{nodes_laun
-0000c3b0: 6368 696e 675f 7072 6f67 7265 7373 5f74  ching_progress_t
-0000c3c0: 696d 656f 7574 7d20 7365 636f 6e64 7320  imeout} seconds 
-0000c3d0: 666f 7220 6e65 7720 270a 2020 2020 2020  for new '.      
-0000c3e0: 2020 2020 2020 2020 2020 2020 2020 2777                'w
-0000c3f0: 6f72 6b65 7273 2074 6f20 6265 2070 726f  orkers to be pro
-0000c400: 7669 7369 6f6e 6564 2c20 6275 7420 6e6f  visioned, but no
-0000c410: 2070 726f 6772 6573 732e 2729 0a20 2020   progress.').   
-0000c420: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000c430: 7572 6e20 4661 6c73 652c 204e 6f6e 6520  urn False, None 
-0000c440: 2023 2066 6169 6c65 640a 0a20 2020 2020   # failed..     
-0000c450: 2020 2020 2020 2069 6620 2728 6e6f 2070         if '(no p
-0000c460: 656e 6469 6e67 206e 6f64 6573 2927 2069  ending nodes)' i
-0000c470: 6e20 6f75 7470 7574 2061 6e64 2027 286e  n output and '(n
-0000c480: 6f20 6661 696c 7572 6573 2927 2069 6e20  o failures)' in 
-0000c490: 6f75 7470 7574 3a0a 2020 2020 2020 2020  output:.        
-0000c4a0: 2020 2020 2020 2020 2320 4275 6720 696e          # Bug in
-0000c4b0: 2072 6179 2061 7574 6f73 6361 6c65 723a   ray autoscaler:
-0000c4c0: 2065 2e67 2e2c 206f 6e20 4743 502c 2069   e.g., on GCP, i
-0000c4d0: 6620 7265 7175 6573 7469 6e67 2032 206e  f requesting 2 n
-0000c4e0: 6f64 6573 0a20 2020 2020 2020 2020 2020  odes.           
-0000c4f0: 2020 2020 2023 2074 6861 7420 4743 5020       # that GCP 
-0000c500: 6361 6e20 7361 7469 7366 7920 6f6e 6c79  can satisfy only
-0000c510: 2062 7920 6861 6c66 2c20 7468 6520 776f   by half, the wo
-0000c520: 726b 6572 206e 6f64 6520 776f 756c 6420  rker node would 
-0000c530: 6265 0a20 2020 2020 2020 2020 2020 2020  be.             
-0000c540: 2020 2023 2066 6f72 676f 7474 656e 2e20     # forgotten. 
-0000c550: 5468 6520 636f 7272 6563 7420 6265 6861  The correct beha
-0000c560: 7669 6f72 2073 686f 756c 6420 6265 2066  vior should be f
-0000c570: 6f72 2069 7420 746f 2065 7272 6f72 206f  or it to error o
-0000c580: 7574 2e0a 2020 2020 2020 2020 2020 2020  ut..            
-0000c590: 2020 2020 6c6f 6767 6572 2e65 7272 6f72      logger.error
-0000c5a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000c5b0: 2020 2020 2020 2746 6169 6c65 6420 746f        'Failed to
-0000c5c0: 206c 6175 6e63 6820 6d75 6c74 6970 6c65   launch multiple
-0000c5d0: 206e 6f64 6573 206f 6e20 270a 2020 2020   nodes on '.    
-0000c5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5f0: 2747 4350 2064 7565 2074 6f20 6120 6e6f  'GCP due to a no
-0000c600: 6e64 6574 6572 6d69 6e69 7374 6963 2062  ndeterministic b
-0000c610: 7567 2069 6e20 7261 7920 6175 746f 7363  ug in ray autosc
-0000c620: 616c 6572 2e27 290a 2020 2020 2020 2020  aler.').        
-0000c630: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-0000c640: 616c 7365 2c20 4e6f 6e65 2020 2320 6661  alse, None  # fa
-0000c650: 696c 6564 0a20 2020 2020 2020 2020 2020  iled.           
-0000c660: 2074 696d 652e 736c 6565 7028 3130 290a   time.sleep(10).
-0000c670: 2020 2020 7265 7475 726e 2054 7275 652c      return True,
-0000c680: 2064 6f63 6b65 725f 7573 6572 2020 2320   docker_user  # 
-0000c690: 7375 6363 6573 730a 0a0a 6465 6620 7373  success...def ss
-0000c6a0: 685f 6372 6564 656e 7469 616c 5f66 726f  h_credential_fro
-0000c6b0: 6d5f 7961 6d6c 280a 2020 2020 636c 7573  m_yaml(.    clus
-0000c6c0: 7465 725f 7961 6d6c 3a20 7374 722c 0a20  ter_yaml: str,. 
-0000c6d0: 2020 2064 6f63 6b65 725f 7573 6572 3a20     docker_user: 
-0000c6e0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-0000c6f0: 4e6f 6e65 2c0a 2020 2020 7373 685f 7573  None,.    ssh_us
-0000c700: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
-0000c710: 5d20 3d20 4e6f 6e65 2c0a 2920 2d3e 2044  ] = None,.) -> D
-0000c720: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
-0000c730: 2020 2022 2222 5265 7475 726e 7320 7373     """Returns ss
-0000c740: 685f 7573 6572 2c20 7373 685f 7072 6976  h_user, ssh_priv
-0000c750: 6174 655f 6b65 7920 616e 6420 7373 685f  ate_key and ssh_
-0000c760: 636f 6e74 726f 6c20 6e61 6d65 2e0a 0a20  control name... 
-0000c770: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0000c780: 2063 6c75 7374 6572 5f79 616d 6c3a 2070   cluster_yaml: p
-0000c790: 6174 6820 746f 2074 6865 2063 6c75 7374  ath to the clust
-0000c7a0: 6572 2079 616d 6c2e 0a20 2020 2020 2020  er yaml..       
-0000c7b0: 2064 6f63 6b65 725f 7573 6572 3a20 7768   docker_user: wh
-0000c7c0: 656e 2075 7369 6e67 2063 7573 746f 6d20  en using custom 
-0000c7d0: 646f 636b 6572 2069 6d61 6765 2c20 7573  docker image, us
-0000c7e0: 6520 7468 6973 2075 7365 7220 746f 2073  e this user to s
-0000c7f0: 7368 2069 6e74 6f0a 2020 2020 2020 2020  sh into.        
-0000c800: 2020 2020 7468 6520 646f 636b 6572 2063      the docker c
-0000c810: 6f6e 7461 696e 6572 2e0a 2020 2020 2020  ontainer..      
-0000c820: 2020 7373 685f 7573 6572 3a20 6f76 6572    ssh_user: over
-0000c830: 7269 6465 2074 6865 2073 7368 5f75 7365  ride the ssh_use
-0000c840: 7220 696e 2074 6865 2063 6c75 7374 6572  r in the cluster
-0000c850: 2079 616d 6c2e 0a20 2020 2022 2222 0a20   yaml..    """. 
-0000c860: 2020 2063 6f6e 6669 6720 3d20 636f 6d6d     config = comm
-0000c870: 6f6e 5f75 7469 6c73 2e72 6561 645f 7961  on_utils.read_ya
-0000c880: 6d6c 2863 6c75 7374 6572 5f79 616d 6c29  ml(cluster_yaml)
-0000c890: 0a20 2020 2061 7574 685f 7365 6374 696f  .    auth_sectio
-0000c8a0: 6e20 3d20 636f 6e66 6967 5b27 6175 7468  n = config['auth
-0000c8b0: 275d 0a20 2020 2069 6620 7373 685f 7573  '].    if ssh_us
-0000c8c0: 6572 2069 7320 4e6f 6e65 3a0a 2020 2020  er is None:.    
-0000c8d0: 2020 2020 7373 685f 7573 6572 203d 2061      ssh_user = a
-0000c8e0: 7574 685f 7365 6374 696f 6e5b 2773 7368  uth_section['ssh
-0000c8f0: 5f75 7365 7227 5d2e 7374 7269 7028 290a  _user'].strip().
-0000c900: 2020 2020 7373 685f 7072 6976 6174 655f      ssh_private_
-0000c910: 6b65 7920 3d20 6175 7468 5f73 6563 7469  key = auth_secti
-0000c920: 6f6e 2e67 6574 2827 7373 685f 7072 6976  on.get('ssh_priv
-0000c930: 6174 655f 6b65 7927 290a 2020 2020 7373  ate_key').    ss
-0000c940: 685f 636f 6e74 726f 6c5f 6e61 6d65 203d  h_control_name =
-0000c950: 2063 6f6e 6669 672e 6765 7428 2763 6c75   config.get('clu
-0000c960: 7374 6572 5f6e 616d 6527 2c20 275f 5f64  ster_name', '__d
-0000c970: 6566 6175 6c74 5f5f 2729 0a20 2020 2073  efault__').    s
-0000c980: 7368 5f70 726f 7879 5f63 6f6d 6d61 6e64  sh_proxy_command
-0000c990: 203d 2061 7574 685f 7365 6374 696f 6e2e   = auth_section.
-0000c9a0: 6765 7428 2773 7368 5f70 726f 7879 5f63  get('ssh_proxy_c
-0000c9b0: 6f6d 6d61 6e64 2729 0a20 2020 2063 7265  ommand').    cre
-0000c9c0: 6465 6e74 6961 6c73 203d 207b 0a20 2020  dentials = {.   
-0000c9d0: 2020 2020 2027 7373 685f 7573 6572 273a       'ssh_user':
-0000c9e0: 2073 7368 5f75 7365 722c 0a20 2020 2020   ssh_user,.     
-0000c9f0: 2020 2027 7373 685f 7072 6976 6174 655f     'ssh_private_
-0000ca00: 6b65 7927 3a20 7373 685f 7072 6976 6174  key': ssh_privat
-0000ca10: 655f 6b65 792c 0a20 2020 2020 2020 2027  e_key,.        '
-0000ca20: 7373 685f 636f 6e74 726f 6c5f 6e61 6d65  ssh_control_name
-0000ca30: 273a 2073 7368 5f63 6f6e 7472 6f6c 5f6e  ': ssh_control_n
-0000ca40: 616d 652c 0a20 2020 2020 2020 2027 7373  ame,.        'ss
-0000ca50: 685f 7072 6f78 795f 636f 6d6d 616e 6427  h_proxy_command'
-0000ca60: 3a20 7373 685f 7072 6f78 795f 636f 6d6d  : ssh_proxy_comm
-0000ca70: 616e 642c 0a20 2020 207d 0a20 2020 2069  and,.    }.    i
-0000ca80: 6620 646f 636b 6572 5f75 7365 7220 6973  f docker_user is
-0000ca90: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0000caa0: 2020 2063 7265 6465 6e74 6961 6c73 5b27     credentials['
-0000cab0: 646f 636b 6572 5f75 7365 7227 5d20 3d20  docker_user'] = 
-0000cac0: 646f 636b 6572 5f75 7365 720a 2020 2020  docker_user.    
-0000cad0: 7373 685f 7072 6f76 6964 6572 5f6d 6f64  ssh_provider_mod
-0000cae0: 756c 6520 3d20 636f 6e66 6967 5b27 7072  ule = config['pr
-0000caf0: 6f76 6964 6572 275d 5b27 6d6f 6475 6c65  ovider']['module
-0000cb00: 275d 0a20 2020 2023 2049 6620 7765 2061  '].    # If we a
-0000cb10: 7265 2072 756e 6e69 6e67 2073 7368 2063  re running ssh c
-0000cb20: 6f6d 6d61 6e64 206f 6e20 6b75 6265 726e  ommand on kubern
-0000cb30: 6574 6573 206e 6f64 652e 0a20 2020 2069  etes node..    i
-0000cb40: 6620 276b 7562 6572 6e65 7465 7327 2069  f 'kubernetes' i
-0000cb50: 6e20 7373 685f 7072 6f76 6964 6572 5f6d  n ssh_provider_m
-0000cb60: 6f64 756c 653a 0a20 2020 2020 2020 2063  odule:.        c
-0000cb70: 7265 6465 6e74 6961 6c73 5b27 6469 7361  redentials['disa
-0000cb80: 626c 655f 636f 6e74 726f 6c5f 6d61 7374  ble_control_mast
-0000cb90: 6572 275d 203d 2054 7275 650a 2020 2020  er'] = True.    
-0000cba0: 7265 7475 726e 2063 7265 6465 6e74 6961  return credentia
-0000cbb0: 6c73 0a0a 0a64 6566 2070 6172 616c 6c65  ls...def paralle
-0000cbc0: 6c5f 6461 7461 5f74 7261 6e73 6665 725f  l_data_transfer_
-0000cbd0: 746f 5f6e 6f64 6573 280a 2020 2020 7275  to_nodes(.    ru
-0000cbe0: 6e6e 6572 733a 204c 6973 745b 636f 6d6d  nners: List[comm
-0000cbf0: 616e 645f 7275 6e6e 6572 2e53 5348 436f  and_runner.SSHCo
-0000cc00: 6d6d 616e 6452 756e 6e65 725d 2c0a 2020  mmandRunner],.  
-0000cc10: 2020 736f 7572 6365 3a20 4f70 7469 6f6e    source: Option
-0000cc20: 616c 5b73 7472 5d2c 0a20 2020 2074 6172  al[str],.    tar
-0000cc30: 6765 743a 2073 7472 2c0a 2020 2020 636d  get: str,.    cm
-0000cc40: 643a 204f 7074 696f 6e61 6c5b 7374 725d  d: Optional[str]
-0000cc50: 2c0a 2020 2020 7275 6e5f 7273 796e 633a  ,.    run_rsync:
-0000cc60: 2062 6f6f 6c2c 0a20 2020 202a 2c0a 2020   bool,.    *,.  
-0000cc70: 2020 6163 7469 6f6e 5f6d 6573 7361 6765    action_message
-0000cc80: 3a20 7374 722c 0a20 2020 2023 2041 6476  : str,.    # Adv
-0000cc90: 616e 6365 6420 6f70 7469 6f6e 732e 0a20  anced options.. 
-0000cca0: 2020 206c 6f67 5f70 6174 683a 2073 7472     log_path: str
-0000ccb0: 203d 206f 732e 6465 766e 756c 6c2c 0a20   = os.devnull,. 
-0000ccc0: 2020 2073 7472 6561 6d5f 6c6f 6773 3a20     stream_logs: 
-0000ccd0: 626f 6f6c 203d 2046 616c 7365 2c0a 293a  bool = False,.):
-0000cce0: 0a20 2020 2022 2222 5275 6e73 2061 2063  .    """Runs a c
-0000ccf0: 6f6d 6d61 6e64 206f 6e20 616c 6c20 6e6f  ommand on all no
-0000cd00: 6465 7320 616e 6420 6f70 7469 6f6e 616c  des and optional
-0000cd10: 6c79 2072 756e 7320 7273 796e 6320 6672  ly runs rsync fr
-0000cd20: 6f6d 2073 7263 2d3e 6473 742e 0a0a 2020  om src->dst...  
-0000cd30: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0000cd40: 7275 6e6e 6572 733a 2041 206c 6973 7420  runners: A list 
-0000cd50: 6f66 2053 5348 436f 6d6d 616e 6452 756e  of SSHCommandRun
-0000cd60: 6e65 7220 6f62 6a65 6374 7320 7468 6174  ner objects that
-0000cd70: 2072 6570 7265 7365 6e74 206d 756c 7469   represent multi
-0000cd80: 706c 6520 6e6f 6465 732e 0a20 2020 2020  ple nodes..     
-0000cd90: 2020 2073 6f75 7263 653a 204f 7074 696f     source: Optio
-0000cda0: 6e61 6c5b 7374 725d 3b20 536f 7572 6365  nal[str]; Source
-0000cdb0: 2066 6f72 2072 7379 6e63 206f 6e20 6c6f   for rsync on lo
-0000cdc0: 6361 6c20 6e6f 6465 0a20 2020 2020 2020  cal node.       
-0000cdd0: 2074 6172 6765 743a 2073 7472 3b20 4465   target: str; De
-0000cde0: 7374 696e 6174 696f 6e20 6f6e 2072 656d  stination on rem
-0000cdf0: 6f74 6520 6e6f 6465 2066 6f72 2072 7379  ote node for rsy
-0000ce00: 6e63 0a20 2020 2020 2020 2063 6d64 3a20  nc.        cmd: 
-0000ce10: 7374 723b 2043 6f6d 6d61 6e64 2074 6f20  str; Command to 
-0000ce20: 6265 2065 7865 6375 7465 6420 6f6e 2061  be executed on a
-0000ce30: 6c6c 206e 6f64 6573 0a20 2020 2020 2020  ll nodes.       
-0000ce40: 2061 6374 696f 6e5f 6d65 7373 6167 653a   action_message:
-0000ce50: 2073 7472 3b20 4d65 7373 6167 6520 746f   str; Message to
-0000ce60: 2062 6520 7072 696e 7465 6420 7768 696c   be printed whil
-0000ce70: 6520 7468 6520 636f 6d6d 616e 6420 7275  e the command ru
-0000ce80: 6e73 0a20 2020 2020 2020 206c 6f67 5f70  ns.        log_p
-0000ce90: 6174 683a 2073 7472 3b20 5061 7468 2074  ath: str; Path t
-0000cea0: 6f20 7468 6520 6c6f 6720 6669 6c65 0a20  o the log file. 
-0000ceb0: 2020 2020 2020 2073 7472 6561 6d5f 6c6f         stream_lo
-0000cec0: 6773 3a20 626f 6f6c 3b20 5768 6574 6865  gs: bool; Whethe
-0000ced0: 7220 746f 2073 7472 6561 6d20 6c6f 6773  r to stream logs
-0000cee0: 2074 6f20 7374 646f 7574 0a20 2020 2022   to stdout.    "
-0000cef0: 2222 0a20 2020 2066 6f72 6520 3d20 636f  "".    fore = co
-0000cf00: 6c6f 7261 6d61 2e46 6f72 650a 2020 2020  lorama.Fore.    
-0000cf10: 7374 796c 6520 3d20 636f 6c6f 7261 6d61  style = colorama
-0000cf20: 2e53 7479 6c65 0a0a 2020 2020 6f72 6967  .Style..    orig
-0000cf30: 696e 5f73 6f75 7263 6520 3d20 736f 7572  in_source = sour
-0000cf40: 6365 0a0a 2020 2020 6465 6620 5f73 796e  ce..    def _syn
-0000cf50: 635f 6e6f 6465 2872 756e 6e65 723a 2027  c_node(runner: '
-0000cf60: 636f 6d6d 616e 645f 7275 6e6e 6572 2e53  command_runner.S
-0000cf70: 5348 436f 6d6d 616e 6452 756e 6e65 7227  SHCommandRunner'
-0000cf80: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0000cf90: 2020 2069 6620 636d 6420 6973 206e 6f74     if cmd is not
-0000cfa0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000cfb0: 2020 2072 632c 2073 7464 6f75 742c 2073     rc, stdout, s
-0000cfc0: 7464 6572 7220 3d20 7275 6e6e 6572 2e72  tderr = runner.r
-0000cfd0: 756e 2863 6d64 2c0a 2020 2020 2020 2020  un(cmd,.        
+0000b960: 2020 2020 2020 2020 2020 202a 2a73 7368             **ssh
+0000b970: 5f63 7265 6465 6e74 6961 6c73 290a 2020  _credentials).  
+0000b980: 2020 7769 7468 2072 6963 685f 7574 696c    with rich_util
+0000b990: 732e 7361 6665 5f73 7461 7475 7328 0a20  s.safe_status(. 
+0000b9a0: 2020 2020 2020 2020 2020 2027 5b62 6f6c             '[bol
+0000b9b0: 6420 6379 616e 5d57 6169 7469 6e67 2066  d cyan]Waiting f
+0000b9c0: 6f72 2077 6f72 6b65 7273 2e2e 2e27 2920  or workers...') 
+0000b9d0: 6173 2077 6f72 6b65 725f 7374 6174 7573  as worker_status
+0000b9e0: 3a0a 2020 2020 2020 2020 7768 696c 6520  :.        while 
+0000b9f0: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
+0000ba00: 2020 7263 2c20 6f75 7470 7574 2c20 7374    rc, output, st
+0000ba10: 6465 7272 203d 2072 756e 6e65 722e 7275  derr = runner.ru
+0000ba20: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+0000ba30: 2020 2069 6e73 7461 6e63 655f 7365 7475     instance_setu
+0000ba40: 702e 5241 595f 5354 4154 5553 5f57 4954  p.RAY_STATUS_WIT
+0000ba50: 485f 534b 595f 5241 595f 504f 5254 5f43  H_SKY_RAY_PORT_C
+0000ba60: 4f4d 4d41 4e44 2c0a 2020 2020 2020 2020  OMMAND,.        
+0000ba70: 2020 2020 2020 2020 6c6f 675f 7061 7468          log_path
+0000ba80: 3d6c 6f67 5f70 6174 682c 0a20 2020 2020  =log_path,.     
+0000ba90: 2020 2020 2020 2020 2020 2073 7472 6561             strea
+0000baa0: 6d5f 6c6f 6773 3d46 616c 7365 2c0a 2020  m_logs=False,.  
+0000bab0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000bac0: 7175 6972 655f 6f75 7470 7574 733d 5472  quire_outputs=Tr
+0000bad0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0000bae0: 2020 2020 7365 7061 7261 7465 5f73 7464      separate_std
+0000baf0: 6572 723d 5472 7565 290a 2020 2020 2020  err=True).      
+0000bb00: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
+0000bb10: 5f75 7469 6c73 2e68 616e 646c 655f 7265  _utils.handle_re
+0000bb20: 7475 726e 636f 6465 280a 2020 2020 2020  turncode(.      
+0000bb30: 2020 2020 2020 2020 2020 7263 2c20 696e            rc, in
+0000bb40: 7374 616e 6365 5f73 6574 7570 2e52 4159  stance_setup.RAY
+0000bb50: 5f53 5441 5455 535f 5749 5448 5f53 4b59  _STATUS_WITH_SKY
+0000bb60: 5f52 4159 5f50 4f52 545f 434f 4d4d 414e  _RAY_PORT_COMMAN
+0000bb70: 442c 0a20 2020 2020 2020 2020 2020 2020  D,.             
+0000bb80: 2020 2027 4661 696c 6564 2074 6f20 7275     'Failed to ru
+0000bb90: 6e20 7261 7920 7374 6174 7573 206f 6e20  n ray status on 
+0000bba0: 6865 6164 206e 6f64 652e 272c 2073 7464  head node.', std
+0000bbb0: 6572 7229 0a20 2020 2020 2020 2020 2020  err).           
+0000bbc0: 206c 6f67 6765 722e 6465 6275 6728 6f75   logger.debug(ou
+0000bbd0: 7470 7574 290a 0a20 2020 2020 2020 2020  tput)..         
+0000bbe0: 2020 2072 6561 6479 5f68 6561 642c 2072     ready_head, r
+0000bbf0: 6561 6479 5f77 6f72 6b65 7273 203d 205f  eady_workers = _
+0000bc00: 636f 756e 745f 6865 616c 7468 795f 6e6f  count_healthy_no
+0000bc10: 6465 735f 6672 6f6d 5f72 6179 280a 2020  des_from_ray(.  
+0000bc20: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+0000bc30: 7470 7574 2c20 6973 5f6c 6f63 616c 5f63  tput, is_local_c
+0000bc40: 6c6f 7564 3d69 735f 6c6f 6361 6c5f 636c  loud=is_local_cl
+0000bc50: 6f75 6429 0a0a 2020 2020 2020 2020 2020  oud)..          
+0000bc60: 2020 776f 726b 6572 5f73 7461 7475 732e    worker_status.
+0000bc70: 7570 6461 7465 2827 5b62 6f6c 6420 6379  update('[bold cy
+0000bc80: 616e 5d27 0a20 2020 2020 2020 2020 2020  an]'.           
+0000bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bca0: 2020 2020 2020 6627 7b72 6561 6479 5f77        f'{ready_w
+0000bcb0: 6f72 6b65 7273 7d20 6f75 7420 6f66 207b  orkers} out of {
+0000bcc0: 6e75 6d5f 6e6f 6465 7320 2d20 317d 2027  num_nodes - 1} '
+0000bcd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bcf0: 2020 2777 6f72 6b65 7273 2072 6561 6479    'workers ready
+0000bd00: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+0000bd10: 2320 496e 2074 6865 206c 6f63 616c 2063  # In the local c
+0000bd20: 6173 652c 2072 6561 6479 5f68 6561 643d  ase, ready_head=
+0000bd30: 3020 616e 6420 7265 6164 795f 776f 726b  0 and ready_work
+0000bd40: 6572 733d 6e75 6d5f 6e6f 6465 732e 2054  ers=num_nodes. T
+0000bd50: 6869 730a 2020 2020 2020 2020 2020 2020  his.            
+0000bd60: 2320 6973 2062 6563 6175 7365 2074 6865  # is because the
+0000bd70: 7265 2069 7320 6e6f 206d 6174 6368 696e  re is no matchin
+0000bd80: 6720 7265 6765 7820 666f 7220 5f4c 4155  g regex for _LAU
+0000bd90: 4e43 4845 445f 4845 4144 5f50 4154 5445  NCHED_HEAD_PATTE
+0000bda0: 524e 2e0a 2020 2020 2020 2020 2020 2020  RN..            
+0000bdb0: 6966 2072 6561 6479 5f68 6561 6420 2b20  if ready_head + 
+0000bdc0: 7265 6164 795f 776f 726b 6572 7320 3d3d  ready_workers ==
+0000bdd0: 206e 756d 5f6e 6f64 6573 3a0a 2020 2020   num_nodes:.    
+0000bde0: 2020 2020 2020 2020 2020 2020 2320 416c              # Al
+0000bdf0: 6c20 6e6f 6465 7320 6172 6520 7570 2e0a  l nodes are up..
+0000be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be10: 6272 6561 6b0a 0a20 2020 2020 2020 2020  break..         
+0000be20: 2020 2023 2050 656e 6469 6e67 2077 6f72     # Pending wor
+0000be30: 6b65 7273 2074 6861 7420 6861 7665 2062  kers that have b
+0000be40: 6565 6e20 6c61 756e 6368 6564 2062 7920  een launched by 
+0000be50: 7261 7920 7570 2e0a 2020 2020 2020 2020  ray up..        
+0000be60: 2020 2020 666f 756e 645f 6970 7320 3d20      found_ips = 
+0000be70: 5f4c 4155 4e43 4849 4e47 5f49 505f 5041  _LAUNCHING_IP_PA
+0000be80: 5454 4552 4e2e 6669 6e64 616c 6c28 6f75  TTERN.findall(ou
+0000be90: 7470 7574 290a 2020 2020 2020 2020 2020  tput).          
+0000bea0: 2020 7065 6e64 696e 675f 776f 726b 6572    pending_worker
+0000beb0: 7320 3d20 6c65 6e28 666f 756e 645f 6970  s = len(found_ip
+0000bec0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+0000bed0: 2320 544f 444f 287a 6877 7529 3a20 4861  # TODO(zhwu): Ha
+0000bee0: 6e64 6c65 2074 6865 2063 6173 6520 7768  ndle the case wh
+0000bef0: 6572 6520 7468 6520 666f 6c6c 6f77 696e  ere the followin
+0000bf00: 6720 6f63 6375 7273 2c20 7768 6572 6520  g occurs, where 
+0000bf10: 7261 790a 2020 2020 2020 2020 2020 2020  ray.            
+0000bf20: 2320 636c 7573 7465 7220 6973 206e 6f74  # cluster is not
+0000bf30: 2063 6f72 7265 6374 6c79 2073 7461 7274   correctly start
+0000bf40: 6564 206f 6e20 7468 6520 636c 7573 7465  ed on the cluste
+0000bf50: 722e 0a20 2020 2020 2020 2020 2020 2023  r..            #
+0000bf60: 2050 656e 6469 6e67 3a0a 2020 2020 2020   Pending:.      
+0000bf70: 2020 2020 2020 2320 2031 3732 2e33 312e        #  172.31.
+0000bf80: 392e 3132 313a 2072 6179 2e77 6f72 6b65  9.121: ray.worke
+0000bf90: 722e 6465 6661 756c 742c 2075 6e69 6e69  r.default, unini
+0000bfa0: 7469 616c 697a 6564 0a20 2020 2020 2020  tialized.       
+0000bfb0: 2020 2020 206e 6f64 6573 5f73 6f5f 6661       nodes_so_fa
+0000bfc0: 7220 3d20 7265 6164 795f 6865 6164 202b  r = ready_head +
+0000bfd0: 2072 6561 6479 5f77 6f72 6b65 7273 202b   ready_workers +
+0000bfe0: 2070 656e 6469 6e67 5f77 6f72 6b65 7273   pending_workers
+0000bff0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000c000: 4368 6563 6b20 7468 6520 6e75 6d62 6572  Check the number
+0000c010: 206f 6620 6e6f 6465 7320 7468 6174 2061   of nodes that a
+0000c020: 7265 2066 6574 6368 6564 2e20 5469 6d65  re fetched. Time
+0000c030: 6f75 7420 6966 206e 6f20 6e65 770a 2020  out if no new.  
+0000c040: 2020 2020 2020 2020 2020 2320 6e6f 6465            # node
+0000c050: 7320 6665 7463 6865 6420 696e 2061 2077  s fetched in a w
+0000c060: 6869 6c65 2028 6e6f 6465 735f 6c61 756e  hile (nodes_laun
+0000c070: 6368 696e 675f 7072 6f67 7265 7373 5f74  ching_progress_t
+0000c080: 696d 656f 7574 292c 0a20 2020 2020 2020  imeout),.       
+0000c090: 2020 2020 2023 2074 686f 7567 6820 6e75       # though nu
+0000c0a0: 6d62 6572 206f 6620 6e6f 6465 735f 736f  mber of nodes_so
+0000c0b0: 5f66 6172 2069 7320 7374 696c 6c20 6e6f  _far is still no
+0000c0c0: 7420 6173 2065 7870 6563 7465 642e 0a20  t as expected.. 
+0000c0d0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0000c0e0: 6465 735f 736f 5f66 6172 203e 206c 6173  des_so_far > las
+0000c0f0: 745f 6e6f 6465 735f 736f 5f66 6172 3a0a  t_nodes_so_far:.
+0000c100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c110: 2320 5265 7365 7420 7468 6520 7374 6172  # Reset the star
+0000c120: 7420 7469 6d65 2069 6620 7468 6520 6e75  t time if the nu
+0000c130: 6d62 6572 206f 6620 6c61 756e 6368 696e  mber of launchin
+0000c140: 6720 6e6f 6465 730a 2020 2020 2020 2020  g nodes.        
+0000c150: 2020 2020 2020 2020 2320 6368 616e 6765          # change
+0000c160: 732c 2069 2e65 2e20 6e65 7720 6e6f 6465  s, i.e. new node
+0000c170: 7320 6172 6520 6c61 756e 6368 6564 2e0a  s are launched..
+0000c180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c190: 6c6f 6767 6572 2e64 6562 7567 2827 5265  logger.debug('Re
+0000c1a0: 7365 7420 7374 6172 7420 7469 6d65 2c20  set start time, 
+0000c1b0: 6173 206e 6577 206e 6f64 6573 2061 7265  as new nodes are
+0000c1c0: 206c 6175 6e63 6865 642e 2027 0a20 2020   launched. '.   
+0000c1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1e0: 2020 2020 2020 2020 2020 6627 287b 6c61            f'({la
+0000c1f0: 7374 5f6e 6f64 6573 5f73 6f5f 6661 727d  st_nodes_so_far}
+0000c200: 202d 3e20 7b6e 6f64 6573 5f73 6f5f 6661   -> {nodes_so_fa
+0000c210: 727d 2927 290a 2020 2020 2020 2020 2020  r})').          
+0000c220: 2020 2020 2020 7374 6172 7420 3d20 7469        start = ti
+0000c230: 6d65 2e74 696d 6528 290a 2020 2020 2020  me.time().      
+0000c240: 2020 2020 2020 2020 2020 6c61 7374 5f6e            last_n
+0000c250: 6f64 6573 5f73 6f5f 6661 7220 3d20 6e6f  odes_so_far = no
+0000c260: 6465 735f 736f 5f66 6172 0a20 2020 2020  des_so_far.     
+0000c270: 2020 2020 2020 2065 6c69 6620 286e 6f64         elif (nod
+0000c280: 6573 5f6c 6175 6e63 6869 6e67 5f70 726f  es_launching_pro
+0000c290: 6772 6573 735f 7469 6d65 6f75 7420 6973  gress_timeout is
+0000c2a0: 206e 6f74 204e 6f6e 6520 616e 640a 2020   not None and.  
+0000c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c2c0: 7469 6d65 2e74 696d 6528 2920 2d20 7374  time.time() - st
+0000c2d0: 6172 7420 3e20 6e6f 6465 735f 6c61 756e  art > nodes_laun
+0000c2e0: 6368 696e 675f 7072 6f67 7265 7373 5f74  ching_progress_t
+0000c2f0: 696d 656f 7574 2061 6e64 0a20 2020 2020  imeout and.     
+0000c300: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+0000c310: 6573 5f73 6f5f 6661 7220 213d 206e 756d  es_so_far != num
+0000c320: 5f6e 6f64 6573 293a 0a20 2020 2020 2020  _nodes):.       
+0000c330: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0000c340: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
+0000c350: 2020 2020 2020 2020 2020 2027 5469 6d65             'Time
+0000c360: 6420 6f75 743a 2077 6169 7465 6420 666f  d out: waited fo
+0000c370: 7220 6d6f 7265 2074 6861 6e20 270a 2020  r more than '.  
+0000c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c390: 2020 6627 7b6e 6f64 6573 5f6c 6175 6e63    f'{nodes_launc
+0000c3a0: 6869 6e67 5f70 726f 6772 6573 735f 7469  hing_progress_ti
+0000c3b0: 6d65 6f75 747d 2073 6563 6f6e 6473 2066  meout} seconds f
+0000c3c0: 6f72 206e 6577 2027 0a20 2020 2020 2020  or new '.       
+0000c3d0: 2020 2020 2020 2020 2020 2020 2027 776f               'wo
+0000c3e0: 726b 6572 7320 746f 2062 6520 7072 6f76  rkers to be prov
+0000c3f0: 6973 696f 6e65 642c 2062 7574 206e 6f20  isioned, but no 
+0000c400: 7072 6f67 7265 7373 2e27 290a 2020 2020  progress.').    
+0000c410: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000c420: 726e 2046 616c 7365 2c20 4e6f 6e65 2020  rn False, None  
+0000c430: 2320 6661 696c 6564 0a0a 2020 2020 2020  # failed..      
+0000c440: 2020 2020 2020 6966 2027 286e 6f20 7065        if '(no pe
+0000c450: 6e64 696e 6720 6e6f 6465 7329 2720 696e  nding nodes)' in
+0000c460: 206f 7574 7075 7420 616e 6420 2728 6e6f   output and '(no
+0000c470: 2066 6169 6c75 7265 7329 2720 696e 206f   failures)' in o
+0000c480: 7574 7075 743a 0a20 2020 2020 2020 2020  utput:.         
+0000c490: 2020 2020 2020 2023 2042 7567 2069 6e20         # Bug in 
+0000c4a0: 7261 7920 6175 746f 7363 616c 6572 3a20  ray autoscaler: 
+0000c4b0: 652e 672e 2c20 6f6e 2047 4350 2c20 6966  e.g., on GCP, if
+0000c4c0: 2072 6571 7565 7374 696e 6720 3220 6e6f   requesting 2 no
+0000c4d0: 6465 730a 2020 2020 2020 2020 2020 2020  des.            
+0000c4e0: 2020 2020 2320 7468 6174 2047 4350 2063      # that GCP c
+0000c4f0: 616e 2073 6174 6973 6679 206f 6e6c 7920  an satisfy only 
+0000c500: 6279 2068 616c 662c 2074 6865 2077 6f72  by half, the wor
+0000c510: 6b65 7220 6e6f 6465 2077 6f75 6c64 2062  ker node would b
+0000c520: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000c530: 2020 2320 666f 7267 6f74 7465 6e2e 2054    # forgotten. T
+0000c540: 6865 2063 6f72 7265 6374 2062 6568 6176  he correct behav
+0000c550: 696f 7220 7368 6f75 6c64 2062 6520 666f  ior should be fo
+0000c560: 7220 6974 2074 6f20 6572 726f 7220 6f75  r it to error ou
+0000c570: 742e 0a20 2020 2020 2020 2020 2020 2020  t..             
+0000c580: 2020 206c 6f67 6765 722e 6572 726f 7228     logger.error(
+0000c590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c5a0: 2020 2020 2027 4661 696c 6564 2074 6f20       'Failed to 
+0000c5b0: 6c61 756e 6368 206d 756c 7469 706c 6520  launch multiple 
+0000c5c0: 6e6f 6465 7320 6f6e 2027 0a20 2020 2020  nodes on '.     
+0000c5d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000c5e0: 4743 5020 6475 6520 746f 2061 206e 6f6e  GCP due to a non
+0000c5f0: 6465 7465 726d 696e 6973 7469 6320 6275  deterministic bu
+0000c600: 6720 696e 2072 6179 2061 7574 6f73 6361  g in ray autosca
+0000c610: 6c65 722e 2729 0a20 2020 2020 2020 2020  ler.').         
+0000c620: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
+0000c630: 6c73 652c 204e 6f6e 6520 2023 2066 6169  lse, None  # fai
+0000c640: 6c65 640a 2020 2020 2020 2020 2020 2020  led.            
+0000c650: 7469 6d65 2e73 6c65 6570 2831 3029 0a20  time.sleep(10). 
+0000c660: 2020 2072 6574 7572 6e20 5472 7565 2c20     return True, 
+0000c670: 646f 636b 6572 5f75 7365 7220 2023 2073  docker_user  # s
+0000c680: 7563 6365 7373 0a0a 0a64 6566 2073 7368  uccess...def ssh
+0000c690: 5f63 7265 6465 6e74 6961 6c5f 6672 6f6d  _credential_from
+0000c6a0: 5f79 616d 6c28 0a20 2020 2063 6c75 7374  _yaml(.    clust
+0000c6b0: 6572 5f79 616d 6c3a 2073 7472 2c0a 2020  er_yaml: str,.  
+0000c6c0: 2020 646f 636b 6572 5f75 7365 723a 204f    docker_user: O
+0000c6d0: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+0000c6e0: 6f6e 652c 0a20 2020 2073 7368 5f75 7365  one,.    ssh_use
+0000c6f0: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
+0000c700: 203d 204e 6f6e 652c 0a29 202d 3e20 4469   = None,.) -> Di
+0000c710: 6374 5b73 7472 2c20 416e 795d 3a0a 2020  ct[str, Any]:.  
+0000c720: 2020 2222 2252 6574 7572 6e73 2073 7368    """Returns ssh
+0000c730: 5f75 7365 722c 2073 7368 5f70 7269 7661  _user, ssh_priva
+0000c740: 7465 5f6b 6579 2061 6e64 2073 7368 5f63  te_key and ssh_c
+0000c750: 6f6e 7472 6f6c 206e 616d 652e 0a0a 2020  ontrol name...  
+0000c760: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0000c770: 636c 7573 7465 725f 7961 6d6c 3a20 7061  cluster_yaml: pa
+0000c780: 7468 2074 6f20 7468 6520 636c 7573 7465  th to the cluste
+0000c790: 7220 7961 6d6c 2e0a 2020 2020 2020 2020  r yaml..        
+0000c7a0: 646f 636b 6572 5f75 7365 723a 2077 6865  docker_user: whe
+0000c7b0: 6e20 7573 696e 6720 6375 7374 6f6d 2064  n using custom d
+0000c7c0: 6f63 6b65 7220 696d 6167 652c 2075 7365  ocker image, use
+0000c7d0: 2074 6869 7320 7573 6572 2074 6f20 7373   this user to ss
+0000c7e0: 6820 696e 746f 0a20 2020 2020 2020 2020  h into.         
+0000c7f0: 2020 2074 6865 2064 6f63 6b65 7220 636f     the docker co
+0000c800: 6e74 6169 6e65 722e 0a20 2020 2020 2020  ntainer..       
+0000c810: 2073 7368 5f75 7365 723a 206f 7665 7272   ssh_user: overr
+0000c820: 6964 6520 7468 6520 7373 685f 7573 6572  ide the ssh_user
+0000c830: 2069 6e20 7468 6520 636c 7573 7465 7220   in the cluster 
+0000c840: 7961 6d6c 2e0a 2020 2020 2222 220a 2020  yaml..    """.  
+0000c850: 2020 636f 6e66 6967 203d 2063 6f6d 6d6f    config = commo
+0000c860: 6e5f 7574 696c 732e 7265 6164 5f79 616d  n_utils.read_yam
+0000c870: 6c28 636c 7573 7465 725f 7961 6d6c 290a  l(cluster_yaml).
+0000c880: 2020 2020 6175 7468 5f73 6563 7469 6f6e      auth_section
+0000c890: 203d 2063 6f6e 6669 675b 2761 7574 6827   = config['auth'
+0000c8a0: 5d0a 2020 2020 6966 2073 7368 5f75 7365  ].    if ssh_use
+0000c8b0: 7220 6973 204e 6f6e 653a 0a20 2020 2020  r is None:.     
+0000c8c0: 2020 2073 7368 5f75 7365 7220 3d20 6175     ssh_user = au
+0000c8d0: 7468 5f73 6563 7469 6f6e 5b27 7373 685f  th_section['ssh_
+0000c8e0: 7573 6572 275d 2e73 7472 6970 2829 0a20  user'].strip(). 
+0000c8f0: 2020 2073 7368 5f70 7269 7661 7465 5f6b     ssh_private_k
+0000c900: 6579 203d 2061 7574 685f 7365 6374 696f  ey = auth_sectio
+0000c910: 6e2e 6765 7428 2773 7368 5f70 7269 7661  n.get('ssh_priva
+0000c920: 7465 5f6b 6579 2729 0a20 2020 2073 7368  te_key').    ssh
+0000c930: 5f63 6f6e 7472 6f6c 5f6e 616d 6520 3d20  _control_name = 
+0000c940: 636f 6e66 6967 2e67 6574 2827 636c 7573  config.get('clus
+0000c950: 7465 725f 6e61 6d65 272c 2027 5f5f 6465  ter_name', '__de
+0000c960: 6661 756c 745f 5f27 290a 2020 2020 7373  fault__').    ss
+0000c970: 685f 7072 6f78 795f 636f 6d6d 616e 6420  h_proxy_command 
+0000c980: 3d20 6175 7468 5f73 6563 7469 6f6e 2e67  = auth_section.g
+0000c990: 6574 2827 7373 685f 7072 6f78 795f 636f  et('ssh_proxy_co
+0000c9a0: 6d6d 616e 6427 290a 2020 2020 6372 6564  mmand').    cred
+0000c9b0: 656e 7469 616c 7320 3d20 7b0a 2020 2020  entials = {.    
+0000c9c0: 2020 2020 2773 7368 5f75 7365 7227 3a20      'ssh_user': 
+0000c9d0: 7373 685f 7573 6572 2c0a 2020 2020 2020  ssh_user,.      
+0000c9e0: 2020 2773 7368 5f70 7269 7661 7465 5f6b    'ssh_private_k
+0000c9f0: 6579 273a 2073 7368 5f70 7269 7661 7465  ey': ssh_private
+0000ca00: 5f6b 6579 2c0a 2020 2020 2020 2020 2773  _key,.        's
+0000ca10: 7368 5f63 6f6e 7472 6f6c 5f6e 616d 6527  sh_control_name'
+0000ca20: 3a20 7373 685f 636f 6e74 726f 6c5f 6e61  : ssh_control_na
+0000ca30: 6d65 2c0a 2020 2020 2020 2020 2773 7368  me,.        'ssh
+0000ca40: 5f70 726f 7879 5f63 6f6d 6d61 6e64 273a  _proxy_command':
+0000ca50: 2073 7368 5f70 726f 7879 5f63 6f6d 6d61   ssh_proxy_comma
+0000ca60: 6e64 2c0a 2020 2020 7d0a 2020 2020 6966  nd,.    }.    if
+0000ca70: 2064 6f63 6b65 725f 7573 6572 2069 7320   docker_user is 
+0000ca80: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0000ca90: 2020 6372 6564 656e 7469 616c 735b 2764    credentials['d
+0000caa0: 6f63 6b65 725f 7573 6572 275d 203d 2064  ocker_user'] = d
+0000cab0: 6f63 6b65 725f 7573 6572 0a20 2020 2073  ocker_user.    s
+0000cac0: 7368 5f70 726f 7669 6465 725f 6d6f 6475  sh_provider_modu
+0000cad0: 6c65 203d 2063 6f6e 6669 675b 2770 726f  le = config['pro
+0000cae0: 7669 6465 7227 5d5b 276d 6f64 756c 6527  vider']['module'
+0000caf0: 5d0a 2020 2020 2320 4966 2077 6520 6172  ].    # If we ar
+0000cb00: 6520 7275 6e6e 696e 6720 7373 6820 636f  e running ssh co
+0000cb10: 6d6d 616e 6420 6f6e 206b 7562 6572 6e65  mmand on kuberne
+0000cb20: 7465 7320 6e6f 6465 2e0a 2020 2020 6966  tes node..    if
+0000cb30: 2027 6b75 6265 726e 6574 6573 2720 696e   'kubernetes' in
+0000cb40: 2073 7368 5f70 726f 7669 6465 725f 6d6f   ssh_provider_mo
+0000cb50: 6475 6c65 3a0a 2020 2020 2020 2020 6372  dule:.        cr
+0000cb60: 6564 656e 7469 616c 735b 2764 6973 6162  edentials['disab
+0000cb70: 6c65 5f63 6f6e 7472 6f6c 5f6d 6173 7465  le_control_maste
+0000cb80: 7227 5d20 3d20 5472 7565 0a20 2020 2072  r'] = True.    r
+0000cb90: 6574 7572 6e20 6372 6564 656e 7469 616c  eturn credential
+0000cba0: 730a 0a0a 6465 6620 7061 7261 6c6c 656c  s...def parallel
+0000cbb0: 5f64 6174 615f 7472 616e 7366 6572 5f74  _data_transfer_t
+0000cbc0: 6f5f 6e6f 6465 7328 0a20 2020 2072 756e  o_nodes(.    run
+0000cbd0: 6e65 7273 3a20 4c69 7374 5b63 6f6d 6d61  ners: List[comma
+0000cbe0: 6e64 5f72 756e 6e65 722e 5353 4843 6f6d  nd_runner.SSHCom
+0000cbf0: 6d61 6e64 5275 6e6e 6572 5d2c 0a20 2020  mandRunner],.   
+0000cc00: 2073 6f75 7263 653a 204f 7074 696f 6e61   source: Optiona
+0000cc10: 6c5b 7374 725d 2c0a 2020 2020 7461 7267  l[str],.    targ
+0000cc20: 6574 3a20 7374 722c 0a20 2020 2063 6d64  et: str,.    cmd
+0000cc30: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d2c  : Optional[str],
+0000cc40: 0a20 2020 2072 756e 5f72 7379 6e63 3a20  .    run_rsync: 
+0000cc50: 626f 6f6c 2c0a 2020 2020 2a2c 0a20 2020  bool,.    *,.   
+0000cc60: 2061 6374 696f 6e5f 6d65 7373 6167 653a   action_message:
+0000cc70: 2073 7472 2c0a 2020 2020 2320 4164 7661   str,.    # Adva
+0000cc80: 6e63 6564 206f 7074 696f 6e73 2e0a 2020  nced options..  
+0000cc90: 2020 6c6f 675f 7061 7468 3a20 7374 7220    log_path: str 
+0000cca0: 3d20 6f73 2e64 6576 6e75 6c6c 2c0a 2020  = os.devnull,.  
+0000ccb0: 2020 7374 7265 616d 5f6c 6f67 733a 2062    stream_logs: b
+0000ccc0: 6f6f 6c20 3d20 4661 6c73 652c 0a29 3a0a  ool = False,.):.
+0000ccd0: 2020 2020 2222 2252 756e 7320 6120 636f      """Runs a co
+0000cce0: 6d6d 616e 6420 6f6e 2061 6c6c 206e 6f64  mmand on all nod
+0000ccf0: 6573 2061 6e64 206f 7074 696f 6e61 6c6c  es and optionall
+0000cd00: 7920 7275 6e73 2072 7379 6e63 2066 726f  y runs rsync fro
+0000cd10: 6d20 7372 632d 3e64 7374 2e0a 0a20 2020  m src->dst...   
+0000cd20: 2041 7267 733a 0a20 2020 2020 2020 2072   Args:.        r
+0000cd30: 756e 6e65 7273 3a20 4120 6c69 7374 206f  unners: A list o
+0000cd40: 6620 5353 4843 6f6d 6d61 6e64 5275 6e6e  f SSHCommandRunn
+0000cd50: 6572 206f 626a 6563 7473 2074 6861 7420  er objects that 
+0000cd60: 7265 7072 6573 656e 7420 6d75 6c74 6970  represent multip
+0000cd70: 6c65 206e 6f64 6573 2e0a 2020 2020 2020  le nodes..      
+0000cd80: 2020 736f 7572 6365 3a20 4f70 7469 6f6e    source: Option
+0000cd90: 616c 5b73 7472 5d3b 2053 6f75 7263 6520  al[str]; Source 
+0000cda0: 666f 7220 7273 796e 6320 6f6e 206c 6f63  for rsync on loc
+0000cdb0: 616c 206e 6f64 650a 2020 2020 2020 2020  al node.        
+0000cdc0: 7461 7267 6574 3a20 7374 723b 2044 6573  target: str; Des
+0000cdd0: 7469 6e61 7469 6f6e 206f 6e20 7265 6d6f  tination on remo
+0000cde0: 7465 206e 6f64 6520 666f 7220 7273 796e  te node for rsyn
+0000cdf0: 630a 2020 2020 2020 2020 636d 643a 2073  c.        cmd: s
+0000ce00: 7472 3b20 436f 6d6d 616e 6420 746f 2062  tr; Command to b
+0000ce10: 6520 6578 6563 7574 6564 206f 6e20 616c  e executed on al
+0000ce20: 6c20 6e6f 6465 730a 2020 2020 2020 2020  l nodes.        
+0000ce30: 6163 7469 6f6e 5f6d 6573 7361 6765 3a20  action_message: 
+0000ce40: 7374 723b 204d 6573 7361 6765 2074 6f20  str; Message to 
+0000ce50: 6265 2070 7269 6e74 6564 2077 6869 6c65  be printed while
+0000ce60: 2074 6865 2063 6f6d 6d61 6e64 2072 756e   the command run
+0000ce70: 730a 2020 2020 2020 2020 6c6f 675f 7061  s.        log_pa
+0000ce80: 7468 3a20 7374 723b 2050 6174 6820 746f  th: str; Path to
+0000ce90: 2074 6865 206c 6f67 2066 696c 650a 2020   the log file.  
+0000cea0: 2020 2020 2020 7374 7265 616d 5f6c 6f67        stream_log
+0000ceb0: 733a 2062 6f6f 6c3b 2057 6865 7468 6572  s: bool; Whether
+0000cec0: 2074 6f20 7374 7265 616d 206c 6f67 7320   to stream logs 
+0000ced0: 746f 2073 7464 6f75 740a 2020 2020 2222  to stdout.    ""
+0000cee0: 220a 2020 2020 666f 7265 203d 2063 6f6c  ".    fore = col
+0000cef0: 6f72 616d 612e 466f 7265 0a20 2020 2073  orama.Fore.    s
+0000cf00: 7479 6c65 203d 2063 6f6c 6f72 616d 612e  tyle = colorama.
+0000cf10: 5374 796c 650a 0a20 2020 206f 7269 6769  Style..    origi
+0000cf20: 6e5f 736f 7572 6365 203d 2073 6f75 7263  n_source = sourc
+0000cf30: 650a 0a20 2020 2064 6566 205f 7379 6e63  e..    def _sync
+0000cf40: 5f6e 6f64 6528 7275 6e6e 6572 3a20 2763  _node(runner: 'c
+0000cf50: 6f6d 6d61 6e64 5f72 756e 6e65 722e 5353  ommand_runner.SS
+0000cf60: 4843 6f6d 6d61 6e64 5275 6e6e 6572 2729  HCommandRunner')
+0000cf70: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0000cf80: 2020 6966 2063 6d64 2069 7320 6e6f 7420    if cmd is not 
+0000cf90: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000cfa0: 2020 7263 2c20 7374 646f 7574 2c20 7374    rc, stdout, st
+0000cfb0: 6465 7272 203d 2072 756e 6e65 722e 7275  derr = runner.ru
+0000cfc0: 6e28 636d 642c 0a20 2020 2020 2020 2020  n(cmd,.         
+0000cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000cfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d000: 2020 2020 6c6f 675f 7061 7468 3d6c 6f67      log_path=log
-0000d010: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
+0000cff0: 2020 206c 6f67 5f70 6174 683d 6c6f 675f     log_path=log_
+0000d000: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
+0000d010: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000d020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d040: 2020 2073 7472 6561 6d5f 6c6f 6773 3d73     stream_logs=s
-0000d050: 7472 6561 6d5f 6c6f 6773 2c0a 2020 2020  tream_logs,.    
+0000d030: 2020 7374 7265 616d 5f6c 6f67 733d 7374    stream_logs=st
+0000d040: 7265 616d 5f6c 6f67 732c 0a20 2020 2020  ream_logs,.     
+0000d050: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000d060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d080: 2020 2020 2020 2020 7265 7175 6972 655f          require_
-0000d090: 6f75 7470 7574 733d 5472 7565 290a 2020  outputs=True).  
-0000d0a0: 2020 2020 2020 2020 2020 6572 725f 6d73            err_ms
-0000d0b0: 6720 3d20 2827 4661 696c 6564 2074 6f20  g = ('Failed to 
-0000d0c0: 7275 6e20 636f 6d6d 616e 6420 6265 666f  run command befo
-0000d0d0: 7265 2072 7379 6e63 2027 0a20 2020 2020  re rsync '.     
-0000d0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d0f0: 2020 6627 7b6f 7269 6769 6e5f 736f 7572    f'{origin_sour
-0000d100: 6365 7d20 2d3e 207b 7461 7267 6574 7d2e  ce} -> {target}.
-0000d110: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0000d120: 2020 2020 2020 2020 2020 2745 6e73 7572            'Ensur
-0000d130: 6520 7468 6174 2074 6865 206e 6574 776f  e that the netwo
-0000d140: 726b 2069 7320 7374 6162 6c65 2c20 7468  rk is stable, th
-0000d150: 656e 2072 6574 7279 2e27 290a 2020 2020  en retry.').    
-0000d160: 2020 2020 2020 2020 6966 206c 6f67 5f70          if log_p
-0000d170: 6174 6820 213d 206f 732e 6465 766e 756c  ath != os.devnul
-0000d180: 6c3a 0a20 2020 2020 2020 2020 2020 2020  l:.             
-0000d190: 2020 2065 7272 5f6d 7367 202b 3d20 6627     err_msg += f'
-0000d1a0: 2053 6565 206c 6f67 7320 696e 207b 6c6f   See logs in {lo
-0000d1b0: 675f 7061 7468 7d27 0a20 2020 2020 2020  g_path}'.       
-0000d1c0: 2020 2020 2073 7562 7072 6f63 6573 735f       subprocess_
-0000d1d0: 7574 696c 732e 6861 6e64 6c65 5f72 6574  utils.handle_ret
-0000d1e0: 7572 6e63 6f64 6528 7263 2c0a 2020 2020  urncode(rc,.    
+0000d070: 2020 2020 2020 2072 6571 7569 7265 5f6f         require_o
+0000d080: 7574 7075 7473 3d54 7275 6529 0a20 2020  utputs=True).   
+0000d090: 2020 2020 2020 2020 2065 7272 5f6d 7367           err_msg
+0000d0a0: 203d 2028 2746 6169 6c65 6420 746f 2072   = ('Failed to r
+0000d0b0: 756e 2063 6f6d 6d61 6e64 2062 6566 6f72  un command befor
+0000d0c0: 6520 7273 796e 6320 270a 2020 2020 2020  e rsync '.      
+0000d0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d0e0: 2066 277b 6f72 6967 696e 5f73 6f75 7263   f'{origin_sourc
+0000d0f0: 657d 202d 3e20 7b74 6172 6765 747d 2e20  e} -> {target}. 
+0000d100: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0000d110: 2020 2020 2020 2020 2027 456e 7375 7265           'Ensure
+0000d120: 2074 6861 7420 7468 6520 6e65 7477 6f72   that the networ
+0000d130: 6b20 6973 2073 7461 626c 652c 2074 6865  k is stable, the
+0000d140: 6e20 7265 7472 792e 2729 0a20 2020 2020  n retry.').     
+0000d150: 2020 2020 2020 2069 6620 6c6f 675f 7061         if log_pa
+0000d160: 7468 2021 3d20 6f73 2e64 6576 6e75 6c6c  th != os.devnull
+0000d170: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d180: 2020 6572 725f 6d73 6720 2b3d 2066 2720    err_msg += f' 
+0000d190: 5365 6520 6c6f 6773 2069 6e20 7b6c 6f67  See logs in {log
+0000d1a0: 5f70 6174 687d 270a 2020 2020 2020 2020  _path}'.        
+0000d1b0: 2020 2020 7375 6270 726f 6365 7373 5f75      subprocess_u
+0000d1c0: 7469 6c73 2e68 616e 646c 655f 7265 7475  tils.handle_retu
+0000d1d0: 726e 636f 6465 2872 632c 0a20 2020 2020  rncode(rc,.     
+0000d1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000d1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d210: 2020 2020 2020 2020 2020 2063 6d64 2c0a             cmd,.
+0000d200: 2020 2020 2020 2020 2020 636d 642c 0a20            cmd,. 
+0000d210: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000d220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d240: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000d250: 7272 5f6d 7367 2c0a 2020 2020 2020 2020  rr_msg,.        
+0000d230: 2020 2020 2020 2020 2020 2020 2020 6572                er
+0000d240: 725f 6d73 672c 0a20 2020 2020 2020 2020  r_msg,.         
+0000d250: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000d260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d280: 2020 2020 2020 2073 7464 6572 723d 7374         stderr=st
-0000d290: 646f 7574 202b 2073 7464 6572 7229 0a0a  dout + stderr)..
-0000d2a0: 2020 2020 2020 2020 6966 2072 756e 5f72          if run_r
-0000d2b0: 7379 6e63 3a0a 2020 2020 2020 2020 2020  sync:.          
-0000d2c0: 2020 6173 7365 7274 2073 6f75 7263 6520    assert source 
-0000d2d0: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
-0000d2e0: 2020 2020 2020 2020 2320 544f 444f 287a          # TODO(z
-0000d2f0: 6877 7529 3a20 4f70 7469 6d69 7a65 2066  hwu): Optimize f
-0000d300: 6f72 206c 6172 6765 2061 6d6f 756e 7420  or large amount 
-0000d310: 6f66 2066 696c 6573 2e0a 2020 2020 2020  of files..      
-0000d320: 2020 2020 2020 2320 7a69 7020 2f20 7472        # zip / tr
-0000d330: 616e 7366 6572 202f 2075 6e7a 6970 0a20  ansfer / unzip. 
-0000d340: 2020 2020 2020 2020 2020 2072 756e 6e65             runne
-0000d350: 722e 7273 796e 6328 0a20 2020 2020 2020  r.rsync(.       
-0000d360: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0000d370: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-0000d380: 2020 2020 2020 2020 7461 7267 6574 3d74          target=t
-0000d390: 6172 6765 742c 0a20 2020 2020 2020 2020  arget,.         
-0000d3a0: 2020 2020 2020 2075 703d 5472 7565 2c0a         up=True,.
-0000d3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3c0: 6c6f 675f 7061 7468 3d6c 6f67 5f70 6174  log_path=log_pat
-0000d3d0: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-0000d3e0: 2020 2073 7472 6561 6d5f 6c6f 6773 3d73     stream_logs=s
-0000d3f0: 7472 6561 6d5f 6c6f 6773 2c0a 2020 2020  tream_logs,.    
-0000d400: 2020 2020 2020 2020 290a 0a20 2020 206e          )..    n
-0000d410: 756d 5f6e 6f64 6573 203d 206c 656e 2872  um_nodes = len(r
-0000d420: 756e 6e65 7273 290a 2020 2020 706c 7572  unners).    plur
-0000d430: 616c 203d 2027 7327 2069 6620 6e75 6d5f  al = 's' if num_
-0000d440: 6e6f 6465 7320 3e20 3120 656c 7365 2027  nodes > 1 else '
-0000d450: 270a 2020 2020 6d65 7373 6167 6520 3d20  '.    message = 
-0000d460: 2866 277b 666f 7265 2e43 5941 4e7d 7b61  (f'{fore.CYAN}{a
-0000d470: 6374 696f 6e5f 6d65 7373 6167 657d 2028  ction_message} (
-0000d480: 746f 207b 6e75 6d5f 6e6f 6465 737d 206e  to {num_nodes} n
-0000d490: 6f64 657b 706c 7572 616c 7d29 270a 2020  ode{plural})'.  
-0000d4a0: 2020 2020 2020 2020 2020 2020 2066 273a               f':
-0000d4b0: 207b 7374 796c 652e 4252 4947 4854 7d7b   {style.BRIGHT}{
-0000d4c0: 6f72 6967 696e 5f73 6f75 7263 657d 7b73  origin_source}{s
-0000d4d0: 7479 6c65 2e52 4553 4554 5f41 4c4c 7d20  tyle.RESET_ALL} 
-0000d4e0: 2d3e 2027 0a20 2020 2020 2020 2020 2020  -> '.           
-0000d4f0: 2020 2020 6627 7b73 7479 6c65 2e42 5249      f'{style.BRI
-0000d500: 4748 547d 7b74 6172 6765 747d 7b73 7479  GHT}{target}{sty
-0000d510: 6c65 2e52 4553 4554 5f41 4c4c 7d27 290a  le.RESET_ALL}').
-0000d520: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-0000d530: 6d65 7373 6167 6529 0a20 2020 2077 6974  message).    wit
-0000d540: 6820 7269 6368 5f75 7469 6c73 2e73 6166  h rich_utils.saf
-0000d550: 655f 7374 6174 7573 2866 275b 626f 6c64  e_status(f'[bold
-0000d560: 2063 7961 6e5d 7b61 6374 696f 6e5f 6d65   cyan]{action_me
-0000d570: 7373 6167 657d 5b2f 5d27 293a 0a20 2020  ssage}[/]'):.   
-0000d580: 2020 2020 2073 7562 7072 6f63 6573 735f       subprocess_
-0000d590: 7574 696c 732e 7275 6e5f 696e 5f70 6172  utils.run_in_par
-0000d5a0: 616c 6c65 6c28 5f73 796e 635f 6e6f 6465  allel(_sync_node
-0000d5b0: 2c20 7275 6e6e 6572 7329 0a0a 0a64 6566  , runners)...def
-0000d5c0: 2063 6865 636b 5f6c 6f63 616c 5f67 7075   check_local_gpu
-0000d5d0: 7328 2920 2d3e 2062 6f6f 6c3a 0a20 2020  s() -> bool:.   
-0000d5e0: 2022 2222 4368 6563 6b73 2069 6620 4750   """Checks if GP
-0000d5f0: 5573 2061 7265 2061 7661 696c 6162 6c65  Us are available
-0000d600: 206c 6f63 616c 6c79 2e0a 0a20 2020 2052   locally...    R
-0000d610: 6574 7572 6e73 2077 6865 7468 6572 2047  eturns whether G
-0000d620: 5055 7320 6172 6520 6176 6169 6c61 626c  PUs are availabl
-0000d630: 6520 6f6e 2074 6865 206c 6f63 616c 206d  e on the local m
-0000d640: 6163 6869 6e65 2062 7920 6368 6563 6b69  achine by checki
-0000d650: 6e67 0a20 2020 2069 6620 6e76 6964 6961  ng.    if nvidia
-0000d660: 2d73 6d69 2069 7320 696e 7374 616c 6c65  -smi is installe
-0000d670: 6420 616e 6420 7265 7475 726e 7320 7a65  d and returns ze
-0000d680: 726f 2072 6574 7572 6e20 636f 6465 2e0a  ro return code..
-0000d690: 0a20 2020 2052 6574 7572 6e73 2054 7275  .    Returns Tru
-0000d6a0: 6520 6966 206e 7669 6469 612d 736d 6920  e if nvidia-smi 
-0000d6b0: 6973 2069 6e73 7461 6c6c 6564 2061 6e64  is installed and
-0000d6c0: 2072 6574 7572 6e73 207a 6572 6f20 7265   returns zero re
-0000d6d0: 7475 726e 2063 6f64 652c 0a20 2020 2046  turn code,.    F
-0000d6e0: 616c 7365 2069 6620 6e6f 742e 0a20 2020  alse if not..   
-0000d6f0: 2022 2222 0a20 2020 2069 735f 6675 6e63   """.    is_func
-0000d700: 7469 6f6e 616c 203d 2046 616c 7365 0a20  tional = False. 
-0000d710: 2020 2069 6e73 7461 6c6c 6174 696f 6e5f     installation_
-0000d720: 6368 6563 6b20 3d20 7375 6270 726f 6365  check = subproce
-0000d730: 7373 2e72 756e 285b 2777 6869 6368 272c  ss.run(['which',
-0000d740: 2027 6e76 6964 6961 2d73 6d69 275d 2c0a   'nvidia-smi'],.
+0000d270: 2020 2020 2020 7374 6465 7272 3d73 7464        stderr=std
+0000d280: 6f75 7420 2b20 7374 6465 7272 290a 0a20  out + stderr).. 
+0000d290: 2020 2020 2020 2069 6620 7275 6e5f 7273         if run_rs
+0000d2a0: 796e 633a 0a20 2020 2020 2020 2020 2020  ync:.           
+0000d2b0: 2061 7373 6572 7420 736f 7572 6365 2069   assert source i
+0000d2c0: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2020  s not None.     
+0000d2d0: 2020 2020 2020 2023 2054 4f44 4f28 7a68         # TODO(zh
+0000d2e0: 7775 293a 204f 7074 696d 697a 6520 666f  wu): Optimize fo
+0000d2f0: 7220 6c61 7267 6520 616d 6f75 6e74 206f  r large amount o
+0000d300: 6620 6669 6c65 732e 0a20 2020 2020 2020  f files..       
+0000d310: 2020 2020 2023 207a 6970 202f 2074 7261       # zip / tra
+0000d320: 6e73 6665 7220 2f20 756e 7a69 700a 2020  nsfer / unzip.  
+0000d330: 2020 2020 2020 2020 2020 7275 6e6e 6572            runner
+0000d340: 2e72 7379 6e63 280a 2020 2020 2020 2020  .rsync(.        
+0000d350: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+0000d360: 6f75 7263 652c 0a20 2020 2020 2020 2020  ource,.         
+0000d370: 2020 2020 2020 2074 6172 6765 743d 7461         target=ta
+0000d380: 7267 6574 2c0a 2020 2020 2020 2020 2020  rget,.          
+0000d390: 2020 2020 2020 7570 3d54 7275 652c 0a20        up=True,. 
+0000d3a0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0000d3b0: 6f67 5f70 6174 683d 6c6f 675f 7061 7468  og_path=log_path
+0000d3c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000d3d0: 2020 7374 7265 616d 5f6c 6f67 733d 7374    stream_logs=st
+0000d3e0: 7265 616d 5f6c 6f67 732c 0a20 2020 2020  ream_logs,.     
+0000d3f0: 2020 2020 2020 2029 0a0a 2020 2020 6e75         )..    nu
+0000d400: 6d5f 6e6f 6465 7320 3d20 6c65 6e28 7275  m_nodes = len(ru
+0000d410: 6e6e 6572 7329 0a20 2020 2070 6c75 7261  nners).    plura
+0000d420: 6c20 3d20 2773 2720 6966 206e 756d 5f6e  l = 's' if num_n
+0000d430: 6f64 6573 203e 2031 2065 6c73 6520 2727  odes > 1 else ''
+0000d440: 0a20 2020 206d 6573 7361 6765 203d 2028  .    message = (
+0000d450: 6627 7b66 6f72 652e 4359 414e 7d7b 6163  f'{fore.CYAN}{ac
+0000d460: 7469 6f6e 5f6d 6573 7361 6765 7d20 2874  tion_message} (t
+0000d470: 6f20 7b6e 756d 5f6e 6f64 6573 7d20 6e6f  o {num_nodes} no
+0000d480: 6465 7b70 6c75 7261 6c7d 2927 0a20 2020  de{plural})'.   
+0000d490: 2020 2020 2020 2020 2020 2020 6627 3a20              f': 
+0000d4a0: 7b73 7479 6c65 2e42 5249 4748 547d 7b6f  {style.BRIGHT}{o
+0000d4b0: 7269 6769 6e5f 736f 7572 6365 7d7b 7374  rigin_source}{st
+0000d4c0: 796c 652e 5245 5345 545f 414c 4c7d 202d  yle.RESET_ALL} -
+0000d4d0: 3e20 270a 2020 2020 2020 2020 2020 2020  > '.            
+0000d4e0: 2020 2066 277b 7374 796c 652e 4252 4947     f'{style.BRIG
+0000d4f0: 4854 7d7b 7461 7267 6574 7d7b 7374 796c  HT}{target}{styl
+0000d500: 652e 5245 5345 545f 414c 4c7d 2729 0a20  e.RESET_ALL}'). 
+0000d510: 2020 206c 6f67 6765 722e 696e 666f 286d     logger.info(m
+0000d520: 6573 7361 6765 290a 2020 2020 7769 7468  essage).    with
+0000d530: 2072 6963 685f 7574 696c 732e 7361 6665   rich_utils.safe
+0000d540: 5f73 7461 7475 7328 6627 5b62 6f6c 6420  _status(f'[bold 
+0000d550: 6379 616e 5d7b 6163 7469 6f6e 5f6d 6573  cyan]{action_mes
+0000d560: 7361 6765 7d5b 2f5d 2729 3a0a 2020 2020  sage}[/]'):.    
+0000d570: 2020 2020 7375 6270 726f 6365 7373 5f75      subprocess_u
+0000d580: 7469 6c73 2e72 756e 5f69 6e5f 7061 7261  tils.run_in_para
+0000d590: 6c6c 656c 285f 7379 6e63 5f6e 6f64 652c  llel(_sync_node,
+0000d5a0: 2072 756e 6e65 7273 290a 0a0a 6465 6620   runners)...def 
+0000d5b0: 6368 6563 6b5f 6c6f 6361 6c5f 6770 7573  check_local_gpus
+0000d5c0: 2829 202d 3e20 626f 6f6c 3a0a 2020 2020  () -> bool:.    
+0000d5d0: 2222 2243 6865 636b 7320 6966 2047 5055  """Checks if GPU
+0000d5e0: 7320 6172 6520 6176 6169 6c61 626c 6520  s are available 
+0000d5f0: 6c6f 6361 6c6c 792e 0a0a 2020 2020 5265  locally...    Re
+0000d600: 7475 726e 7320 7768 6574 6865 7220 4750  turns whether GP
+0000d610: 5573 2061 7265 2061 7661 696c 6162 6c65  Us are available
+0000d620: 206f 6e20 7468 6520 6c6f 6361 6c20 6d61   on the local ma
+0000d630: 6368 696e 6520 6279 2063 6865 636b 696e  chine by checkin
+0000d640: 670a 2020 2020 6966 206e 7669 6469 612d  g.    if nvidia-
+0000d650: 736d 6920 6973 2069 6e73 7461 6c6c 6564  smi is installed
+0000d660: 2061 6e64 2072 6574 7572 6e73 207a 6572   and returns zer
+0000d670: 6f20 7265 7475 726e 2063 6f64 652e 0a0a  o return code...
+0000d680: 2020 2020 5265 7475 726e 7320 5472 7565      Returns True
+0000d690: 2069 6620 6e76 6964 6961 2d73 6d69 2069   if nvidia-smi i
+0000d6a0: 7320 696e 7374 616c 6c65 6420 616e 6420  s installed and 
+0000d6b0: 7265 7475 726e 7320 7a65 726f 2072 6574  returns zero ret
+0000d6c0: 7572 6e20 636f 6465 2c0a 2020 2020 4661  urn code,.    Fa
+0000d6d0: 6c73 6520 6966 206e 6f74 2e0a 2020 2020  lse if not..    
+0000d6e0: 2222 220a 2020 2020 6973 5f66 756e 6374  """.    is_funct
+0000d6f0: 696f 6e61 6c20 3d20 4661 6c73 650a 2020  ional = False.  
+0000d700: 2020 696e 7374 616c 6c61 7469 6f6e 5f63    installation_c
+0000d710: 6865 636b 203d 2073 7562 7072 6f63 6573  heck = subproces
+0000d720: 732e 7275 6e28 5b27 7768 6963 6827 2c20  s.run(['which', 
+0000d730: 276e 7669 6469 612d 736d 6927 5d2c 0a20  'nvidia-smi'],. 
+0000d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000d750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d770: 2020 2020 2020 2020 7374 646f 7574 3d73          stdout=s
-0000d780: 7562 7072 6f63 6573 732e 4445 564e 554c  ubprocess.DEVNUL
-0000d790: 4c2c 0a20 2020 2020 2020 2020 2020 2020  L,.             
-0000d7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d7b0: 2020 2020 2020 2020 2020 2073 7464 6572             stder
-0000d7c0: 723d 7375 6270 726f 6365 7373 2e44 4556  r=subprocess.DEV
-0000d7d0: 4e55 4c4c 2c0a 2020 2020 2020 2020 2020  NULL,.          
-0000d7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d7f0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-0000d800: 6563 6b3d 4661 6c73 6529 0a20 2020 2069  eck=False).    i
-0000d810: 735f 696e 7374 616c 6c65 6420 3d20 696e  s_installed = in
-0000d820: 7374 616c 6c61 7469 6f6e 5f63 6865 636b  stallation_check
-0000d830: 2e72 6574 7572 6e63 6f64 6520 3d3d 2030  .returncode == 0
-0000d840: 0a20 2020 2069 6620 6973 5f69 6e73 7461  .    if is_insta
-0000d850: 6c6c 6564 3a0a 2020 2020 2020 2020 6578  lled:.        ex
-0000d860: 6563 7574 696f 6e5f 6368 6563 6b20 3d20  ecution_check = 
-0000d870: 7375 6270 726f 6365 7373 2e72 756e 285b  subprocess.run([
-0000d880: 276e 7669 6469 612d 736d 6927 5d2c 0a20  'nvidia-smi'],. 
+0000d760: 2020 2020 2020 2073 7464 6f75 743d 7375         stdout=su
+0000d770: 6270 726f 6365 7373 2e44 4556 4e55 4c4c  bprocess.DEVNULL
+0000d780: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d7a0: 2020 2020 2020 2020 2020 7374 6465 7272            stderr
+0000d7b0: 3d73 7562 7072 6f63 6573 732e 4445 564e  =subprocess.DEVN
+0000d7c0: 554c 4c2c 0a20 2020 2020 2020 2020 2020  ULL,.           
+0000d7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d7e0: 2020 2020 2020 2020 2020 2020 2063 6865               che
+0000d7f0: 636b 3d46 616c 7365 290a 2020 2020 6973  ck=False).    is
+0000d800: 5f69 6e73 7461 6c6c 6564 203d 2069 6e73  _installed = ins
+0000d810: 7461 6c6c 6174 696f 6e5f 6368 6563 6b2e  tallation_check.
+0000d820: 7265 7475 726e 636f 6465 203d 3d20 300a  returncode == 0.
+0000d830: 2020 2020 6966 2069 735f 696e 7374 616c      if is_instal
+0000d840: 6c65 643a 0a20 2020 2020 2020 2065 7865  led:.        exe
+0000d850: 6375 7469 6f6e 5f63 6865 636b 203d 2073  cution_check = s
+0000d860: 7562 7072 6f63 6573 732e 7275 6e28 5b27  ubprocess.run(['
+0000d870: 6e76 6964 6961 2d73 6d69 275d 2c0a 2020  nvidia-smi'],.  
+0000d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8b0: 2020 2020 2020 2020 7374 646f 7574 3d73          stdout=s
-0000d8c0: 7562 7072 6f63 6573 732e 4445 564e 554c  ubprocess.DEVNUL
-0000d8d0: 4c2c 0a20 2020 2020 2020 2020 2020 2020  L,.             
-0000d8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8f0: 2020 2020 2020 2020 2020 2020 7374 6465              stde
-0000d900: 7272 3d73 7562 7072 6f63 6573 732e 4445  rr=subprocess.DE
-0000d910: 564e 554c 4c2c 0a20 2020 2020 2020 2020  VNULL,.         
-0000d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d940: 6368 6563 6b3d 4661 6c73 6529 0a20 2020  check=False).   
-0000d950: 2020 2020 2069 735f 6675 6e63 7469 6f6e       is_function
-0000d960: 616c 203d 2065 7865 6375 7469 6f6e 5f63  al = execution_c
-0000d970: 6865 636b 2e72 6574 7572 6e63 6f64 6520  heck.returncode 
-0000d980: 3d3d 2030 0a20 2020 2072 6574 7572 6e20  == 0.    return 
-0000d990: 6973 5f66 756e 6374 696f 6e61 6c0a 0a0a  is_functional...
-0000d9a0: 6465 6620 6765 6e65 7261 7465 5f63 6c75  def generate_clu
-0000d9b0: 7374 6572 5f6e 616d 6528 293a 0a20 2020  ster_name():.   
-0000d9c0: 2023 2054 4f44 4f3a 2063 6861 6e67 6520   # TODO: change 
-0000d9d0: 7468 6973 2049 4420 666f 726d 6174 7469  this ID formatti
-0000d9e0: 6e67 2074 6f20 736f 6d65 7468 696e 6720  ng to something 
-0000d9f0: 6d6f 7265 2070 6c65 6173 616e 742e 0a20  more pleasant.. 
-0000da00: 2020 2023 2055 7365 7220 6e61 6d65 2069     # User name i
-0000da10: 7320 6865 6c70 6675 6c20 696e 206e 6f6e  s helpful in non
-0000da20: 2d69 736f 6c61 7465 6420 6163 636f 756e  -isolated accoun
-0000da30: 7473 2c20 652e 672e 2c20 4743 502c 2041  ts, e.g., GCP, A
-0000da40: 7a75 7265 2e0a 2020 2020 7265 7475 726e  zure..    return
-0000da50: 2066 2773 6b79 2d7b 7575 6964 2e75 7569   f'sky-{uuid.uui
-0000da60: 6434 2829 2e68 6578 5b3a 345d 7d2d 7b63  d4().hex[:4]}-{c
-0000da70: 6f6d 6d6f 6e5f 7574 696c 732e 6765 745f  ommon_utils.get_
-0000da80: 636c 6561 6e65 645f 7573 6572 6e61 6d65  cleaned_username
-0000da90: 2829 7d27 0a0a 0a64 6566 205f 7175 6572  ()}'...def _quer
-0000daa0: 795f 6865 6164 5f69 705f 7769 7468 5f72  y_head_ip_with_r
-0000dab0: 6574 7269 6573 2863 6c75 7374 6572 5f79  etries(cluster_y
-0000dac0: 616d 6c3a 2073 7472 2c0a 2020 2020 2020  aml: str,.      
-0000dad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dae0: 2020 2020 2020 2020 2020 6d61 785f 6174            max_at
-0000daf0: 7465 6d70 7473 3a20 696e 7420 3d20 3129  tempts: int = 1)
-0000db00: 202d 3e20 7374 723a 0a20 2020 2022 2222   -> str:.    """
-0000db10: 5265 7475 726e 7320 7468 6520 4950 206f  Returns the IP o
-0000db20: 6620 7468 6520 6865 6164 206e 6f64 6520  f the head node 
-0000db30: 6279 2071 7565 7279 696e 6720 7468 6520  by querying the 
-0000db40: 636c 6f75 642e 0a0a 2020 2020 5261 6973  cloud...    Rais
-0000db50: 6573 3a0a 2020 2020 2020 6578 6365 7074  es:.      except
-0000db60: 696f 6e73 2e46 6574 6368 4950 4572 726f  ions.FetchIPErro
-0000db70: 723a 2069 6620 7765 2066 6169 6c65 6420  r: if we failed 
-0000db80: 746f 2067 6574 2074 6865 2068 6561 6420  to get the head 
-0000db90: 4950 2e0a 2020 2020 2222 220a 2020 2020  IP..    """.    
-0000dba0: 6261 636b 6f66 6620 3d20 636f 6d6d 6f6e  backoff = common
-0000dbb0: 5f75 7469 6c73 2e42 6163 6b6f 6666 2869  _utils.Backoff(i
-0000dbc0: 6e69 7469 616c 5f62 6163 6b6f 6666 3d35  nitial_backoff=5
-0000dbd0: 2c20 6d61 785f 6261 636b 6f66 665f 6661  , max_backoff_fa
-0000dbe0: 6374 6f72 3d35 290a 2020 2020 666f 7220  ctor=5).    for 
-0000dbf0: 6920 696e 2072 616e 6765 286d 6178 5f61  i in range(max_a
-0000dc00: 7474 656d 7074 7329 3a0a 2020 2020 2020  ttempts):.      
-0000dc10: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000dc20: 2020 2066 756c 6c5f 636c 7573 7465 725f     full_cluster_
-0000dc30: 7961 6d6c 203d 2073 7472 2870 6174 686c  yaml = str(pathl
-0000dc40: 6962 2e50 6174 6828 636c 7573 7465 725f  ib.Path(cluster_
-0000dc50: 7961 6d6c 292e 6578 7061 6e64 7573 6572  yaml).expanduser
-0000dc60: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-0000dc70: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
-0000dc80: 5f75 7469 6c73 2e72 756e 280a 2020 2020  _utils.run(.    
-0000dc90: 2020 2020 2020 2020 2020 2020 6627 7261              f'ra
-0000dca0: 7920 6765 742d 6865 6164 2d69 7020 7b66  y get-head-ip {f
-0000dcb0: 756c 6c5f 636c 7573 7465 725f 7961 6d6c  ull_cluster_yaml
-0000dcc0: 2172 7d27 2c0a 2020 2020 2020 2020 2020  !r}',.          
-0000dcd0: 2020 2020 2020 7374 646f 7574 3d73 7562        stdout=sub
-0000dce0: 7072 6f63 6573 732e 5049 5045 2c0a 2020  process.PIPE,.  
-0000dcf0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0000dd00: 6465 7272 3d73 7562 7072 6f63 6573 732e  derr=subprocess.
-0000dd10: 4445 564e 554c 4c29 2e73 7464 6f75 742e  DEVNULL).stdout.
-0000dd20: 6465 636f 6465 2829 2e73 7472 6970 2829  decode().strip()
-0000dd30: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
-0000dd40: 645f 6970 5f6c 6973 7420 3d20 7265 2e66  d_ip_list = re.f
-0000dd50: 696e 6461 6c6c 2849 505f 4144 4452 5f52  indall(IP_ADDR_R
-0000dd60: 4547 4558 2c20 6f75 7429 0a20 2020 2020  EGEX, out).     
-0000dd70: 2020 2020 2020 2069 6620 6c65 6e28 6865         if len(he
-0000dd80: 6164 5f69 705f 6c69 7374 2920 3e20 313a  ad_ip_list) > 1:
-0000dd90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dda0: 2023 2054 6869 7320 636f 756c 6420 6265   # This could be
-0000ddb0: 2074 7269 6767 6572 6564 2069 6620 652e   triggered if e.
-0000ddc0: 672e 2c20 736f 6d65 206c 6f67 6769 6e67  g., some logging
-0000ddd0: 2069 7320 6164 6465 6420 696e 0a20 2020   is added in.   
-0000dde0: 2020 2020 2020 2020 2020 2020 2023 2073               # s
-0000ddf0: 6b79 7069 6c6f 745f 636f 6e66 6967 2c20  kypilot_config, 
-0000de00: 6120 6d6f 6475 6c65 2074 6861 7420 6861  a module that ha
-0000de10: 7320 736f 6d65 2063 6f64 6520 6578 6563  s some code exec
-0000de20: 7574 6564 0a20 2020 2020 2020 2020 2020  uted.           
-0000de30: 2020 2020 2023 2077 6865 6e65 7665 7220       # whenever 
-0000de40: 6073 6b79 6020 6973 2069 6d70 6f72 7465  `sky` is importe
-0000de50: 642e 0a20 2020 2020 2020 2020 2020 2020  d..             
-0000de60: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
-0000de70: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0000de80: 2020 2020 2020 2027 4465 7465 6374 6564         'Detected
-0000de90: 206d 6f72 6520 7468 616e 2031 2049 5020   more than 1 IP 
-0000dea0: 6672 6f6d 2074 6865 206f 7574 7075 7420  from the output 
-0000deb0: 6f66 2027 0a20 2020 2020 2020 2020 2020  of '.           
-0000dec0: 2020 2020 2020 2020 2027 7468 6520 6072           'the `r
-0000ded0: 6179 2067 6574 2d68 6561 642d 6970 6020  ay get-head-ip` 
-0000dee0: 636f 6d6d 616e 642e 2054 6869 7320 636f  command. This co
-0000def0: 756c 6420 270a 2020 2020 2020 2020 2020  uld '.          
-0000df00: 2020 2020 2020 2020 2020 2768 6170 7065            'happe
-0000df10: 6e20 6966 2074 6865 7265 2069 7320 6578  n if there is ex
-0000df20: 7472 6120 6f75 7470 7574 2066 726f 6d20  tra output from 
-0000df30: 6974 2c20 270a 2020 2020 2020 2020 2020  it, '.          
-0000df40: 2020 2020 2020 2020 2020 2777 6869 6368            'which
-0000df50: 2073 686f 756c 6420 6265 2069 6e73 7065   should be inspe
-0000df60: 6374 6564 2062 656c 6f77 2e5c 6e50 726f  cted below.\nPro
-0000df70: 6365 6564 696e 6720 7769 7468 2027 0a20  ceeding with '. 
-0000df80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000df90: 2020 2066 2774 6865 206c 6173 7420 6465     f'the last de
-0000dfa0: 7465 6374 6564 2049 5020 287b 6865 6164  tected IP ({head
-0000dfb0: 5f69 705f 6c69 7374 5b2d 315d 7d29 2061  _ip_list[-1]}) a
-0000dfc0: 7320 6865 6164 2049 502e 270a 2020 2020  s head IP.'.    
-0000dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dfe0: 6627 5c6e 3d3d 204f 7574 7075 7420 3d3d  f'\n== Output ==
-0000dff0: 5c6e 7b6f 7574 7d27 0a20 2020 2020 2020  \n{out}'.       
-0000e000: 2020 2020 2020 2020 2020 2020 2066 275c               f'\
-0000e010: 6e3d 3d20 4f75 7470 7574 2065 6e64 7320  n== Output ends 
-0000e020: 3d3d 2729 0a20 2020 2020 2020 2020 2020  ==').           
-0000e030: 2020 2020 2068 6561 645f 6970 5f6c 6973       head_ip_lis
-0000e040: 7420 3d20 6865 6164 5f69 705f 6c69 7374  t = head_ip_list
-0000e050: 5b2d 313a 5d0a 2020 2020 2020 2020 2020  [-1:].          
-0000e060: 2020 6173 7365 7274 2031 203d 3d20 6c65    assert 1 == le
-0000e070: 6e28 6865 6164 5f69 705f 6c69 7374 292c  n(head_ip_list),
-0000e080: 2028 6f75 742c 2068 6561 645f 6970 5f6c   (out, head_ip_l
-0000e090: 6973 7429 0a20 2020 2020 2020 2020 2020  ist).           
-0000e0a0: 2068 6561 645f 6970 203d 2068 6561 645f   head_ip = head_
-0000e0b0: 6970 5f6c 6973 745b 305d 0a20 2020 2020  ip_list[0].     
-0000e0c0: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
-0000e0d0: 2020 2020 2065 7863 6570 7420 7375 6270       except subp
-0000e0e0: 726f 6365 7373 2e43 616c 6c65 6450 726f  rocess.CalledPro
-0000e0f0: 6365 7373 4572 726f 7220 6173 2065 3a0a  cessError as e:.
-0000e100: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0000e110: 203d 3d20 6d61 785f 6174 7465 6d70 7473   == max_attempts
-0000e120: 202d 2031 3a0a 2020 2020 2020 2020 2020   - 1:.          
-0000e130: 2020 2020 2020 7261 6973 6520 6578 6365        raise exce
-0000e140: 7074 696f 6e73 2e46 6574 6368 4950 4572  ptions.FetchIPEr
-0000e150: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0000e160: 2020 2020 2020 2020 2072 6561 736f 6e3d           reason=
-0000e170: 6578 6365 7074 696f 6e73 2e46 6574 6368  exceptions.Fetch
-0000e180: 4950 4572 726f 722e 5265 6173 6f6e 2e48  IPError.Reason.H
-0000e190: 4541 4429 2066 726f 6d20 650a 2020 2020  EAD) from e.    
-0000e1a0: 2020 2020 2020 2020 2320 5265 7472 7920          # Retry 
-0000e1b0: 6966 2074 6865 2063 6c75 7374 6572 2069  if the cluster i
-0000e1c0: 7320 6e6f 7420 7570 2079 6574 2e0a 2020  s not up yet..  
-0000e1d0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0000e1e0: 2e64 6562 7567 2827 5265 7472 7969 6e67  .debug('Retrying
-0000e1f0: 2074 6f20 6765 7420 6865 6164 2069 702e   to get head ip.
-0000e200: 2729 0a20 2020 2020 2020 2020 2020 2074  ').            t
-0000e210: 696d 652e 736c 6565 7028 6261 636b 6f66  ime.sleep(backof
-0000e220: 662e 6375 7272 656e 745f 6261 636b 6f66  f.current_backof
-0000e230: 6628 2929 0a20 2020 2072 6574 7572 6e20  f()).    return 
-0000e240: 6865 6164 5f69 700a 0a0a 4074 696d 656c  head_ip...@timel
-0000e250: 696e 652e 6576 656e 740a 6465 6620 6765  ine.event.def ge
-0000e260: 745f 6e6f 6465 5f69 7073 2863 6c75 7374  t_node_ips(clust
-0000e270: 6572 5f79 616d 6c3a 2073 7472 2c0a 2020  er_yaml: str,.  
-0000e280: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000e290: 7870 6563 7465 645f 6e75 6d5f 6e6f 6465  xpected_num_node
-0000e2a0: 733a 2069 6e74 2c0a 2020 2020 2020 2020  s: int,.        
-0000e2b0: 2020 2020 2020 2020 2068 6561 645f 6970           head_ip
-0000e2c0: 5f6d 6178 5f61 7474 656d 7074 733a 2069  _max_attempts: i
-0000e2d0: 6e74 203d 2031 2c0a 2020 2020 2020 2020  nt = 1,.        
-0000e2e0: 2020 2020 2020 2020 2077 6f72 6b65 725f           worker_
-0000e2f0: 6970 5f6d 6178 5f61 7474 656d 7074 733a  ip_max_attempts:
-0000e300: 2069 6e74 203d 2031 2c0a 2020 2020 2020   int = 1,.      
-0000e310: 2020 2020 2020 2020 2020 2067 6574 5f69             get_i
-0000e320: 6e74 6572 6e61 6c5f 6970 733a 2062 6f6f  nternal_ips: boo
-0000e330: 6c20 3d20 4661 6c73 6529 202d 3e20 4c69  l = False) -> Li
-0000e340: 7374 5b73 7472 5d3a 0a20 2020 2022 2222  st[str]:.    """
-0000e350: 5265 7475 726e 7320 7468 6520 4950 7320  Returns the IPs 
-0000e360: 6f66 2061 6c6c 206e 6f64 6573 2069 6e20  of all nodes in 
-0000e370: 7468 6520 636c 7573 7465 722c 2077 6974  the cluster, wit
-0000e380: 6820 6865 6164 206e 6f64 6520 6174 2066  h head node at f
-0000e390: 726f 6e74 2e0a 0a20 2020 2041 7267 733a  ront...    Args:
-0000e3a0: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
-0000e3b0: 5f79 616d 6c3a 2050 6174 6820 746f 2074  _yaml: Path to t
-0000e3c0: 6865 2063 6c75 7374 6572 2079 616d 6c2e  he cluster yaml.
-0000e3d0: 0a20 2020 2020 2020 2065 7870 6563 7465  .        expecte
-0000e3e0: 645f 6e75 6d5f 6e6f 6465 733a 2045 7870  d_num_nodes: Exp
-0000e3f0: 6563 7465 6420 6e75 6d62 6572 206f 6620  ected number of 
-0000e400: 6e6f 6465 7320 696e 2074 6865 2063 6c75  nodes in the clu
-0000e410: 7374 6572 2e0a 2020 2020 2020 2020 6865  ster..        he
-0000e420: 6164 5f69 705f 6d61 785f 6174 7465 6d70  ad_ip_max_attemp
-0000e430: 7473 3a20 4d61 7820 6174 7465 6d70 7473  ts: Max attempts
-0000e440: 2074 6f20 6765 7420 6865 6164 2069 702e   to get head ip.
-0000e450: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-0000e460: 6970 5f6d 6178 5f61 7474 656d 7074 733a  ip_max_attempts:
-0000e470: 204d 6178 2061 7474 656d 7074 7320 746f   Max attempts to
-0000e480: 2067 6574 2077 6f72 6b65 7220 6970 732e   get worker ips.
-0000e490: 0a20 2020 2020 2020 2067 6574 5f69 6e74  .        get_int
-0000e4a0: 6572 6e61 6c5f 6970 733a 2057 6865 7468  ernal_ips: Wheth
-0000e4b0: 6572 2074 6f20 6765 7420 696e 7465 726e  er to get intern
-0000e4c0: 616c 2049 5073 2e20 5768 656e 2046 616c  al IPs. When Fal
-0000e4d0: 7365 2c20 6974 2069 7320 7374 696c 6c0a  se, it is still.
-0000e4e0: 2020 2020 2020 2020 2020 2020 706f 7373              poss
-0000e4f0: 6962 6c65 2074 6f20 6765 7420 696e 7465  ible to get inte
-0000e500: 726e 616c 2049 5073 2069 6620 7468 6520  rnal IPs if the 
-0000e510: 636c 7573 7465 7220 646f 6573 206e 6f74  cluster does not
-0000e520: 2068 6176 6520 6578 7465 726e 616c 0a20   have external. 
-0000e530: 2020 2020 2020 2020 2020 2049 5073 2e0a             IPs..
-0000e540: 0a20 2020 2052 6169 7365 733a 0a20 2020  .    Raises:.   
-0000e550: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
-0000e560: 4665 7463 6849 5045 7272 6f72 3a20 6966  FetchIPError: if
-0000e570: 2077 6520 6661 696c 6564 2074 6f20 6765   we failed to ge
-0000e580: 7420 7468 6520 4950 732e 2065 2e72 6561  t the IPs. e.rea
-0000e590: 736f 6e20 6973 0a20 2020 2020 2020 2020  son is.         
-0000e5a0: 2020 2048 4541 4420 6f72 2057 4f52 4b45     HEAD or WORKE
-0000e5b0: 522e 0a20 2020 2022 2222 0a20 2020 2072  R..    """.    r
-0000e5c0: 6179 5f63 6f6e 6669 6720 3d20 636f 6d6d  ay_config = comm
-0000e5d0: 6f6e 5f75 7469 6c73 2e72 6561 645f 7961  on_utils.read_ya
-0000e5e0: 6d6c 2863 6c75 7374 6572 5f79 616d 6c29  ml(cluster_yaml)
-0000e5f0: 0a20 2020 2023 2055 7365 2074 6865 206e  .    # Use the n
-0000e600: 6577 2070 726f 7669 7369 6f6e 6572 2066  ew provisioner f
-0000e610: 6f72 2041 5753 2e0a 2020 2020 7072 6f76  or AWS..    prov
-0000e620: 6964 6572 5f6e 616d 6520 3d20 636c 7573  ider_name = clus
-0000e630: 7465 725f 7961 6d6c 5f75 7469 6c73 2e67  ter_yaml_utils.g
-0000e640: 6574 5f70 726f 7669 6465 725f 6e61 6d65  et_provider_name
-0000e650: 2872 6179 5f63 6f6e 6669 6729 0a20 2020  (ray_config).   
-0000e660: 2063 6c6f 7564 203d 2063 6c6f 7564 5f72   cloud = cloud_r
-0000e670: 6567 6973 7472 792e 434c 4f55 445f 5245  egistry.CLOUD_RE
-0000e680: 4749 5354 5259 2e66 726f 6d5f 7374 7228  GISTRY.from_str(
-0000e690: 7072 6f76 6964 6572 5f6e 616d 6529 0a20  provider_name). 
-0000e6a0: 2020 2061 7373 6572 7420 636c 6f75 6420     assert cloud 
-0000e6b0: 6973 206e 6f74 204e 6f6e 652c 2070 726f  is not None, pro
-0000e6c0: 7669 6465 725f 6e61 6d65 0a0a 2020 2020  vider_name..    
-0000e6d0: 6966 2063 6c6f 7564 2e50 524f 5649 5349  if cloud.PROVISI
-0000e6e0: 4f4e 4552 5f56 4552 5349 4f4e 203e 3d20  ONER_VERSION >= 
-0000e6f0: 636c 6f75 6473 2e50 726f 7669 7369 6f6e  clouds.Provision
-0000e700: 6572 5665 7273 696f 6e2e 534b 5950 494c  erVersion.SKYPIL
-0000e710: 4f54 3a0a 2020 2020 2020 2020 7472 793a  OT:.        try:
-0000e720: 0a20 2020 2020 2020 2020 2020 206d 6574  .            met
-0000e730: 6164 6174 6120 3d20 7072 6f76 6973 696f  adata = provisio
-0000e740: 6e5f 6c69 622e 6765 745f 636c 7573 7465  n_lib.get_cluste
-0000e750: 725f 696e 666f 280a 2020 2020 2020 2020  r_info(.        
-0000e760: 2020 2020 2020 2020 7072 6f76 6964 6572          provider
-0000e770: 5f6e 616d 652c 2072 6179 5f63 6f6e 6669  _name, ray_confi
-0000e780: 675b 2770 726f 7669 6465 7227 5d2e 6765  g['provider'].ge
-0000e790: 7428 2772 6567 696f 6e27 292c 0a20 2020  t('region'),.   
-0000e7a0: 2020 2020 2020 2020 2020 2020 2072 6179               ray
-0000e7b0: 5f63 6f6e 6669 675b 2763 6c75 7374 6572  _config['cluster
-0000e7c0: 5f6e 616d 6527 5d2c 2072 6179 5f63 6f6e  _name'], ray_con
-0000e7d0: 6669 675b 2770 726f 7669 6465 7227 5d29  fig['provider'])
-0000e7e0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0000e7f0: 4578 6365 7074 696f 6e20 6173 2065 3a20  Exception as e: 
-0000e800: 2023 2070 796c 696e 743a 2064 6973 6162   # pylint: disab
-0000e810: 6c65 3d62 726f 6164 2d65 7863 6570 740a  le=broad-except.
-0000e820: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-0000e830: 6973 2063 6f75 6c64 2068 6170 7065 6e20  is could happen 
-0000e840: 7768 656e 2074 6865 2056 4d20 6973 206e  when the VM is n
-0000e850: 6f74 2066 756c 6c79 206c 6175 6e63 6865  ot fully launche
-0000e860: 642c 2061 6e64 2061 2075 7365 720a 2020  d, and a user.  
-0000e870: 2020 2020 2020 2020 2020 2320 6973 2074            # is t
-0000e880: 7279 696e 6720 746f 2074 6572 6d69 6e61  rying to termina
-0000e890: 7465 2069 7420 7769 7468 2060 736b 7920  te it with `sky 
-0000e8a0: 646f 776e 602e 0a20 2020 2020 2020 2020  down`..         
-0000e8b0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-0000e8c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e8d0: 2027 4661 696c 6564 2074 6f20 6765 7420   'Failed to get 
-0000e8e0: 636c 7573 7465 7220 696e 666f 2066 6f72  cluster info for
-0000e8f0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0000e900: 2020 2066 277b 7261 795f 636f 6e66 6967     f'{ray_config
-0000e910: 5b22 636c 7573 7465 725f 6e61 6d65 225d  ["cluster_name"]
-0000e920: 7d20 6672 6f6d 2074 6865 206e 6577 2070  } from the new p
-0000e930: 726f 7669 7369 6f6e 6572 2027 0a20 2020  rovisioner '.   
-0000e940: 2020 2020 2020 2020 2020 2020 2066 2777               f'w
-0000e950: 6974 6820 7b63 6f6d 6d6f 6e5f 7574 696c  ith {common_util
-0000e960: 732e 666f 726d 6174 5f65 7863 6570 7469  s.format_excepti
-0000e970: 6f6e 2865 297d 2e27 290a 2020 2020 2020  on(e)}.').      
-0000e980: 2020 2020 2020 7261 6973 6520 6578 6365        raise exce
-0000e990: 7074 696f 6e73 2e46 6574 6368 4950 4572  ptions.FetchIPEr
-0000e9a0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0000e9b0: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
-0000e9c0: 4665 7463 6849 5045 7272 6f72 2e52 6561  FetchIPError.Rea
-0000e9d0: 736f 6e2e 4845 4144 2920 6672 6f6d 2065  son.HEAD) from e
-0000e9e0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-0000e9f0: 6d65 7461 6461 7461 2e69 6e73 7461 6e63  metadata.instanc
-0000ea00: 6573 2920 3c20 6578 7065 6374 6564 5f6e  es) < expected_n
-0000ea10: 756d 5f6e 6f64 6573 3a0a 2020 2020 2020  um_nodes:.      
-0000ea20: 2020 2020 2020 2320 5369 6d75 6c61 7465        # Simulate
-0000ea30: 2074 6865 2065 7863 6570 7469 6f6e 2077   the exception w
-0000ea40: 6865 6e20 5261 7920 6865 6164 206e 6f64  hen Ray head nod
-0000ea50: 6520 6973 206e 6f74 2075 702e 0a20 2020  e is not up..   
-0000ea60: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
-0000ea70: 7863 6570 7469 6f6e 732e 4665 7463 6849  xceptions.FetchI
-0000ea80: 5045 7272 6f72 2865 7863 6570 7469 6f6e  PError(exception
-0000ea90: 732e 4665 7463 6849 5045 7272 6f72 2e52  s.FetchIPError.R
-0000eaa0: 6561 736f 6e2e 4845 4144 290a 2020 2020  eason.HEAD).    
-0000eab0: 2020 2020 7265 7475 726e 206d 6574 6164      return metad
-0000eac0: 6174 612e 6765 745f 6665 6173 6962 6c65  ata.get_feasible
-0000ead0: 5f69 7073 2867 6574 5f69 6e74 6572 6e61  _ips(get_interna
-0000eae0: 6c5f 6970 7329 0a0a 2020 2020 6966 2067  l_ips)..    if g
-0000eaf0: 6574 5f69 6e74 6572 6e61 6c5f 6970 733a  et_internal_ips:
-0000eb00: 0a20 2020 2020 2020 2077 6974 6820 7465  .        with te
-0000eb10: 6d70 6669 6c65 2e4e 616d 6564 5465 6d70  mpfile.NamedTemp
-0000eb20: 6f72 6172 7946 696c 6528 6d6f 6465 3d27  oraryFile(mode='
-0000eb30: 7727 2c20 6465 6c65 7465 3d46 616c 7365  w', delete=False
-0000eb40: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-0000eb50: 2020 2020 7261 795f 636f 6e66 6967 5b27      ray_config['
-0000eb60: 7072 6f76 6964 6572 275d 5b27 7573 655f  provider']['use_
-0000eb70: 696e 7465 726e 616c 5f69 7073 275d 203d  internal_ips'] =
-0000eb80: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-0000eb90: 2020 7961 6d6c 2e64 756d 7028 7261 795f    yaml.dump(ray_
-0000eba0: 636f 6e66 6967 2c20 6629 0a20 2020 2020  config, f).     
-0000ebb0: 2020 2020 2020 2063 6c75 7374 6572 5f79         cluster_y
-0000ebc0: 616d 6c20 3d20 662e 6e61 6d65 0a0a 2020  aml = f.name..  
-0000ebd0: 2020 2320 4368 6563 6b20 7468 6520 6e65    # Check the ne
-0000ebe0: 7477 6f72 6b20 636f 6e6e 6563 7469 6f6e  twork connection
-0000ebf0: 2066 6972 7374 2074 6f20 6176 6f69 6420   first to avoid 
-0000ec00: 6c6f 6e67 2068 616e 6769 6e67 2074 696d  long hanging tim
-0000ec10: 6520 666f 720a 2020 2020 2320 7261 7920  e for.    # ray 
-0000ec20: 6765 742d 6865 6164 2d69 7020 6265 6c6f  get-head-ip belo
-0000ec30: 772c 2069 6620 6120 6c6f 6e67 2d6c 6173  w, if a long-las
-0000ec40: 7469 6e67 206e 6574 776f 726b 2063 6f6e  ting network con
-0000ec50: 6e65 6374 696f 6e20 6661 696c 7572 650a  nection failure.
-0000ec60: 2020 2020 2320 6861 7070 656e 732e 0a20      # happens.. 
-0000ec70: 2020 2063 6865 636b 5f6e 6574 776f 726b     check_network
-0000ec80: 5f63 6f6e 6e65 6374 696f 6e28 290a 2020  _connection().  
-0000ec90: 2020 6865 6164 5f69 7020 3d20 5f71 7565    head_ip = _que
-0000eca0: 7279 5f68 6561 645f 6970 5f77 6974 685f  ry_head_ip_with_
-0000ecb0: 7265 7472 6965 7328 636c 7573 7465 725f  retries(cluster_
-0000ecc0: 7961 6d6c 2c0a 2020 2020 2020 2020 2020  yaml,.          
-0000ecd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ece0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ecf0: 6d61 785f 6174 7465 6d70 7473 3d68 6561  max_attempts=hea
-0000ed00: 645f 6970 5f6d 6178 5f61 7474 656d 7074  d_ip_max_attempt
-0000ed10: 7329 0a20 2020 2068 6561 645f 6970 5f6c  s).    head_ip_l
-0000ed20: 6973 7420 3d20 5b68 6561 645f 6970 5d0a  ist = [head_ip].
-0000ed30: 2020 2020 6966 2065 7870 6563 7465 645f      if expected_
-0000ed40: 6e75 6d5f 6e6f 6465 7320 3e20 313a 0a20  num_nodes > 1:. 
-0000ed50: 2020 2020 2020 2062 6163 6b6f 6666 203d         backoff =
-0000ed60: 2063 6f6d 6d6f 6e5f 7574 696c 732e 4261   common_utils.Ba
-0000ed70: 636b 6f66 6628 696e 6974 6961 6c5f 6261  ckoff(initial_ba
-0000ed80: 636b 6f66 663d 352c 206d 6178 5f62 6163  ckoff=5, max_bac
-0000ed90: 6b6f 6666 5f66 6163 746f 723d 3529 0a0a  koff_factor=5)..
-0000eda0: 2020 2020 2020 2020 666f 7220 7265 7472          for retr
-0000edb0: 795f 636e 7420 696e 2072 616e 6765 2877  y_cnt in range(w
-0000edc0: 6f72 6b65 725f 6970 5f6d 6178 5f61 7474  orker_ip_max_att
-0000edd0: 656d 7074 7329 3a0a 2020 2020 2020 2020  empts):.        
-0000ede0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000edf0: 2020 2020 2020 2020 2066 756c 6c5f 636c           full_cl
-0000ee00: 7573 7465 725f 7961 6d6c 203d 2073 7472  uster_yaml = str
-0000ee10: 2870 6174 686c 6962 2e50 6174 6828 636c  (pathlib.Path(cl
-0000ee20: 7573 7465 725f 7961 6d6c 292e 6578 7061  uster_yaml).expa
-0000ee30: 6e64 7573 6572 2829 290a 2020 2020 2020  nduser()).      
-0000ee40: 2020 2020 2020 2020 2020 7072 6f63 203d            proc =
-0000ee50: 2073 7562 7072 6f63 6573 735f 7574 696c   subprocess_util
-0000ee60: 732e 7275 6e28 0a20 2020 2020 2020 2020  s.run(.         
-0000ee70: 2020 2020 2020 2020 2020 2066 2772 6179             f'ray
-0000ee80: 2067 6574 2d77 6f72 6b65 722d 6970 7320   get-worker-ips 
-0000ee90: 7b66 756c 6c5f 636c 7573 7465 725f 7961  {full_cluster_ya
-0000eea0: 6d6c 2172 7d27 2c0a 2020 2020 2020 2020  ml!r}',.        
-0000eeb0: 2020 2020 2020 2020 2020 2020 7374 646f              stdo
-0000eec0: 7574 3d73 7562 7072 6f63 6573 732e 5049  ut=subprocess.PI
-0000eed0: 5045 2c0a 2020 2020 2020 2020 2020 2020  PE,.            
-0000eee0: 2020 2020 2020 2020 7374 6465 7272 3d73          stderr=s
-0000eef0: 7562 7072 6f63 6573 732e 5049 5045 290a  ubprocess.PIPE).
-0000ef00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef10: 6f75 7420 3d20 7072 6f63 2e73 7464 6f75  out = proc.stdou
-0000ef20: 742e 6465 636f 6465 2829 0a20 2020 2020  t.decode().     
-0000ef30: 2020 2020 2020 2020 2020 2062 7265 616b             break
-0000ef40: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0000ef50: 6570 7420 7375 6270 726f 6365 7373 2e43  ept subprocess.C
-0000ef60: 616c 6c65 6450 726f 6365 7373 4572 726f  alledProcessErro
-0000ef70: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
-0000ef80: 2020 2020 2020 2020 6966 2072 6574 7279          if retry
-0000ef90: 5f63 6e74 203d 3d20 776f 726b 6572 5f69  _cnt == worker_i
-0000efa0: 705f 6d61 785f 6174 7465 6d70 7473 202d  p_max_attempts -
-0000efb0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-0000efc0: 2020 2020 2020 2020 7261 6973 6520 6578          raise ex
-0000efd0: 6365 7074 696f 6e73 2e46 6574 6368 4950  ceptions.FetchIP
-0000efe0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0000eff0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000f000: 7863 6570 7469 6f6e 732e 4665 7463 6849  xceptions.FetchI
-0000f010: 5045 7272 6f72 2e52 6561 736f 6e2e 574f  PError.Reason.WO
-0000f020: 524b 4552 2920 6672 6f6d 2065 0a20 2020  RKER) from e.   
-0000f030: 2020 2020 2020 2020 2020 2020 2023 2052               # R
-0000f040: 6574 7279 2069 6620 7468 6520 7373 6820  etry if the ssh 
-0000f050: 6973 206e 6f74 2072 6561 6479 2066 6f72  is not ready for
-0000f060: 2074 6865 2077 6f72 6b65 7273 2079 6574   the workers yet
-0000f070: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000f080: 2020 6261 636b 6f66 665f 7469 6d65 203d    backoff_time =
-0000f090: 2062 6163 6b6f 6666 2e63 7572 7265 6e74   backoff.current
-0000f0a0: 5f62 6163 6b6f 6666 2829 0a20 2020 2020  _backoff().     
-0000f0b0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0000f0c0: 722e 6465 6275 6728 2752 6574 7279 696e  r.debug('Retryin
-0000f0d0: 6720 746f 2067 6574 2077 6f72 6b65 7220  g to get worker 
-0000f0e0: 6970 2027 0a20 2020 2020 2020 2020 2020  ip '.           
-0000f0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f100: 2020 6627 5b7b 7265 7472 795f 636e 747d    f'[{retry_cnt}
-0000f110: 2f7b 776f 726b 6572 5f69 705f 6d61 785f  /{worker_ip_max_
-0000f120: 6174 7465 6d70 7473 7d5d 2069 6e20 270a  attempts}] in '.
-0000f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f140: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
-0000f150: 6261 636b 6f66 665f 7469 6d65 7d20 7365  backoff_time} se
-0000f160: 636f 6e64 732e 2729 0a20 2020 2020 2020  conds.').       
-0000f170: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
-0000f180: 6565 7028 6261 636b 6f66 665f 7469 6d65  eep(backoff_time
-0000f190: 290a 2020 2020 2020 2020 776f 726b 6572  ).        worker
-0000f1a0: 5f69 7073 203d 2072 652e 6669 6e64 616c  _ips = re.findal
-0000f1b0: 6c28 4950 5f41 4444 525f 5245 4745 582c  l(IP_ADDR_REGEX,
-0000f1c0: 206f 7574 290a 2020 2020 2020 2020 6966   out).        if
-0000f1d0: 206c 656e 2877 6f72 6b65 725f 6970 7329   len(worker_ips)
-0000f1e0: 2021 3d20 6578 7065 6374 6564 5f6e 756d   != expected_num
-0000f1f0: 5f6e 6f64 6573 202d 2031 3a0a 2020 2020  _nodes - 1:.    
-0000f200: 2020 2020 2020 2020 6e20 3d20 6578 7065          n = expe
-0000f210: 6374 6564 5f6e 756d 5f6e 6f64 6573 202d  cted_num_nodes -
-0000f220: 2031 0a20 2020 2020 2020 2020 2020 2069   1.            i
-0000f230: 6620 6c65 6e28 776f 726b 6572 5f69 7073  f len(worker_ips
-0000f240: 2920 3e20 6e3a 0a20 2020 2020 2020 2020  ) > n:.         
-0000f250: 2020 2020 2020 2023 2054 6869 7320 636f         # This co
-0000f260: 756c 6420 6265 2074 7269 6767 6572 6564  uld be triggered
-0000f270: 2069 6620 652e 672e 2c20 736f 6d65 206c   if e.g., some l
-0000f280: 6f67 6769 6e67 2069 7320 6164 6465 6420  ogging is added 
-0000f290: 696e 0a20 2020 2020 2020 2020 2020 2020  in.             
-0000f2a0: 2020 2023 2073 6b79 7069 6c6f 745f 636f     # skypilot_co
-0000f2b0: 6e66 6967 2c20 6120 6d6f 6475 6c65 2074  nfig, a module t
-0000f2c0: 6861 7420 6861 7320 736f 6d65 2063 6f64  hat has some cod
-0000f2d0: 6520 6578 6563 7574 6564 2077 6865 6e65  e executed whene
-0000f2e0: 7665 720a 2020 2020 2020 2020 2020 2020  ver.            
-0000f2f0: 2020 2020 2320 6073 6b79 6020 6973 2069      # `sky` is i
-0000f300: 6d70 6f72 7465 642e 0a20 2020 2020 2020  mported..       
-0000f310: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0000f320: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
-0000f330: 2020 2020 2020 2020 2020 2020 2066 2745               f'E
-0000f340: 7870 6563 7465 6420 7b6e 7d20 776f 726b  xpected {n} work
-0000f350: 6572 2049 5028 7329 3b20 666f 756e 6420  er IP(s); found 
-0000f360: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000f370: 2020 2020 2020 6627 7b6c 656e 2877 6f72        f'{len(wor
-0000f380: 6b65 725f 6970 7329 7d3a 207b 776f 726b  ker_ips)}: {work
-0000f390: 6572 5f69 7073 7d27 0a20 2020 2020 2020  er_ips}'.       
-0000f3a0: 2020 2020 2020 2020 2020 2020 2027 5c6e               '\n
-0000f3b0: 5468 6973 2063 6f75 6c64 2068 6170 7065  This could happe
-0000f3c0: 6e20 6966 2074 6865 7265 2069 7320 6578  n if there is ex
-0000f3d0: 7472 6120 6f75 7470 7574 2066 726f 6d20  tra output from 
-0000f3e0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000f3f0: 2020 2020 2020 2760 7261 7920 6765 742d        '`ray get-
-0000f400: 776f 726b 6572 2d69 7073 602c 2077 6869  worker-ips`, whi
-0000f410: 6368 2073 686f 756c 6420 6265 2069 6e73  ch should be ins
-0000f420: 7065 6374 6564 2062 656c 6f77 2e27 0a20  pected below.'. 
-0000f430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f440: 2020 2066 275c 6e3d 3d20 4f75 7470 7574     f'\n== Output
-0000f450: 203d 3d5c 6e7b 6f75 747d 270a 2020 2020   ==\n{out}'.    
-0000f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f470: 6627 5c6e 3d3d 204f 7574 7075 7420 656e  f'\n== Output en
-0000f480: 6473 203d 3d27 290a 2020 2020 2020 2020  ds ==').        
-0000f490: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
-0000f4a0: 6172 6e69 6e67 2866 275c 6e50 726f 6365  arning(f'\nProce
-0000f4b0: 6564 696e 6720 7769 7468 2074 6865 206c  eding with the l
-0000f4c0: 6173 7420 7b6e 7d20 270a 2020 2020 2020  ast {n} '.      
-0000f4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f4e0: 2020 2020 2020 2020 2066 2764 6574 6563           f'detec
-0000f4f0: 7465 6420 4950 2873 293a 207b 776f 726b  ted IP(s): {work
-0000f500: 6572 5f69 7073 5b2d 6e3a 5d7d 2e27 290a  er_ips[-n:]}.').
-0000f510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f520: 776f 726b 6572 5f69 7073 203d 2077 6f72  worker_ips = wor
-0000f530: 6b65 725f 6970 735b 2d6e 3a5d 0a20 2020  ker_ips[-n:].   
-0000f540: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0000f550: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000f560: 6169 7365 2065 7863 6570 7469 6f6e 732e  aise exceptions.
-0000f570: 4665 7463 6849 5045 7272 6f72 280a 2020  FetchIPError(.  
-0000f580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f590: 2020 6578 6365 7074 696f 6e73 2e46 6574    exceptions.Fet
-0000f5a0: 6368 4950 4572 726f 722e 5265 6173 6f6e  chIPError.Reason
-0000f5b0: 2e57 4f52 4b45 5229 0a20 2020 2065 6c73  .WORKER).    els
-0000f5c0: 653a 0a20 2020 2020 2020 2077 6f72 6b65  e:.        worke
-0000f5d0: 725f 6970 7320 3d20 5b5d 0a20 2020 2072  r_ips = [].    r
-0000f5e0: 6574 7572 6e20 6865 6164 5f69 705f 6c69  eturn head_ip_li
-0000f5f0: 7374 202b 2077 6f72 6b65 725f 6970 730a  st + worker_ips.
-0000f600: 0a0a 6465 6620 6368 6563 6b5f 6e65 7477  ..def check_netw
-0000f610: 6f72 6b5f 636f 6e6e 6563 7469 6f6e 2829  ork_connection()
-0000f620: 3a0a 2020 2020 2320 546f 6c65 7261 7465  :.    # Tolerate
-0000f630: 2033 2072 6574 7269 6573 2061 7320 6974   3 retries as it
-0000f640: 2069 7320 6f62 7365 7276 6564 2074 6861   is observed tha
-0000f650: 7420 636f 6e6e 6563 7469 6f6e 7320 6361  t connections ca
-0000f660: 6e20 6661 696c 2e0a 2020 2020 6164 6170  n fail..    adap
-0000f670: 7465 7220 3d20 6164 6170 7465 7273 2e48  ter = adapters.H
-0000f680: 5454 5041 6461 7074 6572 286d 6178 5f72  TTPAdapter(max_r
-0000f690: 6574 7269 6573 3d72 6574 7279 5f6c 6962  etries=retry_lib
-0000f6a0: 2e52 6574 7279 2874 6f74 616c 3d33 2929  .Retry(total=3))
-0000f6b0: 0a20 2020 2068 7474 7020 3d20 7265 7175  .    http = requ
-0000f6c0: 6573 7473 2e53 6573 7369 6f6e 2829 0a20  ests.Session(). 
-0000f6d0: 2020 2068 7474 702e 6d6f 756e 7428 2768     http.mount('h
-0000f6e0: 7474 7073 3a2f 2f27 2c20 6164 6170 7465  ttps://', adapte
-0000f6f0: 7229 0a20 2020 2068 7474 702e 6d6f 756e  r).    http.moun
-0000f700: 7428 2768 7474 703a 2f2f 272c 2061 6461  t('http://', ada
-0000f710: 7074 6572 290a 2020 2020 666f 7220 692c  pter).    for i,
-0000f720: 2069 7020 696e 2065 6e75 6d65 7261 7465   ip in enumerate
-0000f730: 285f 5445 5354 5f49 505f 4c49 5354 293a  (_TEST_IP_LIST):
-0000f740: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0000f750: 2020 2020 2020 2020 2020 6874 7470 2e68            http.h
-0000f760: 6561 6428 6970 2c20 7469 6d65 6f75 743d  ead(ip, timeout=
-0000f770: 3329 0a20 2020 2020 2020 2020 2020 2072  3).            r
-0000f780: 6574 7572 6e0a 2020 2020 2020 2020 6578  eturn.        ex
-0000f790: 6365 7074 2028 7265 7175 6573 7473 2e54  cept (requests.T
-0000f7a0: 696d 656f 7574 2c20 7265 7175 6573 7473  imeout, requests
-0000f7b0: 2e65 7863 6570 7469 6f6e 732e 436f 6e6e  .exceptions.Conn
-0000f7c0: 6563 7469 6f6e 4572 726f 7229 2061 7320  ectionError) as 
-0000f7d0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-0000f7e0: 6620 6920 3d3d 206c 656e 285f 5445 5354  f i == len(_TEST
-0000f7f0: 5f49 505f 4c49 5354 2920 2d20 313a 0a20  _IP_LIST) - 1:. 
-0000f800: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000f810: 6169 7365 2065 7863 6570 7469 6f6e 732e  aise exceptions.
-0000f820: 4e65 7477 6f72 6b45 7272 6f72 2827 436f  NetworkError('Co
-0000f830: 756c 6420 6e6f 7420 7265 6672 6573 6820  uld not refresh 
-0000f840: 7468 6520 636c 7573 7465 722e 2027 0a20  the cluster. '. 
+0000d8a0: 2020 2020 2020 2073 7464 6f75 743d 7375         stdout=su
+0000d8b0: 6270 726f 6365 7373 2e44 4556 4e55 4c4c  bprocess.DEVNULL
+0000d8c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8e0: 2020 2020 2020 2020 2020 2073 7464 6572             stder
+0000d8f0: 723d 7375 6270 726f 6365 7373 2e44 4556  r=subprocess.DEV
+0000d900: 4e55 4c4c 2c0a 2020 2020 2020 2020 2020  NULL,.          
+0000d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d920: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000d930: 6865 636b 3d46 616c 7365 290a 2020 2020  heck=False).    
+0000d940: 2020 2020 6973 5f66 756e 6374 696f 6e61      is_functiona
+0000d950: 6c20 3d20 6578 6563 7574 696f 6e5f 6368  l = execution_ch
+0000d960: 6563 6b2e 7265 7475 726e 636f 6465 203d  eck.returncode =
+0000d970: 3d20 300a 2020 2020 7265 7475 726e 2069  = 0.    return i
+0000d980: 735f 6675 6e63 7469 6f6e 616c 0a0a 0a64  s_functional...d
+0000d990: 6566 2067 656e 6572 6174 655f 636c 7573  ef generate_clus
+0000d9a0: 7465 725f 6e61 6d65 2829 3a0a 2020 2020  ter_name():.    
+0000d9b0: 2320 544f 444f 3a20 6368 616e 6765 2074  # TODO: change t
+0000d9c0: 6869 7320 4944 2066 6f72 6d61 7474 696e  his ID formattin
+0000d9d0: 6720 746f 2073 6f6d 6574 6869 6e67 206d  g to something m
+0000d9e0: 6f72 6520 706c 6561 7361 6e74 2e0a 2020  ore pleasant..  
+0000d9f0: 2020 2320 5573 6572 206e 616d 6520 6973    # User name is
+0000da00: 2068 656c 7066 756c 2069 6e20 6e6f 6e2d   helpful in non-
+0000da10: 6973 6f6c 6174 6564 2061 6363 6f75 6e74  isolated account
+0000da20: 732c 2065 2e67 2e2c 2047 4350 2c20 417a  s, e.g., GCP, Az
+0000da30: 7572 652e 0a20 2020 2072 6574 7572 6e20  ure..    return 
+0000da40: 6627 736b 792d 7b75 7569 642e 7575 6964  f'sky-{uuid.uuid
+0000da50: 3428 292e 6865 785b 3a34 5d7d 2d7b 636f  4().hex[:4]}-{co
+0000da60: 6d6d 6f6e 5f75 7469 6c73 2e67 6574 5f63  mmon_utils.get_c
+0000da70: 6c65 616e 6564 5f75 7365 726e 616d 6528  leaned_username(
+0000da80: 297d 270a 0a0a 6465 6620 5f71 7565 7279  )}'...def _query
+0000da90: 5f68 6561 645f 6970 5f77 6974 685f 7265  _head_ip_with_re
+0000daa0: 7472 6965 7328 636c 7573 7465 725f 7961  tries(cluster_ya
+0000dab0: 6d6c 3a20 7374 722c 0a20 2020 2020 2020  ml: str,.       
+0000dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dad0: 2020 2020 2020 2020 206d 6178 5f61 7474           max_att
+0000dae0: 656d 7074 733a 2069 6e74 203d 2031 2920  empts: int = 1) 
+0000daf0: 2d3e 2073 7472 3a0a 2020 2020 2222 2252  -> str:.    """R
+0000db00: 6574 7572 6e73 2074 6865 2049 5020 6f66  eturns the IP of
+0000db10: 2074 6865 2068 6561 6420 6e6f 6465 2062   the head node b
+0000db20: 7920 7175 6572 7969 6e67 2074 6865 2063  y querying the c
+0000db30: 6c6f 7564 2e0a 0a20 2020 2052 6169 7365  loud...    Raise
+0000db40: 733a 0a20 2020 2020 2065 7863 6570 7469  s:.      excepti
+0000db50: 6f6e 732e 4665 7463 6849 5045 7272 6f72  ons.FetchIPError
+0000db60: 3a20 6966 2077 6520 6661 696c 6564 2074  : if we failed t
+0000db70: 6f20 6765 7420 7468 6520 6865 6164 2049  o get the head I
+0000db80: 502e 0a20 2020 2022 2222 0a20 2020 2062  P..    """.    b
+0000db90: 6163 6b6f 6666 203d 2063 6f6d 6d6f 6e5f  ackoff = common_
+0000dba0: 7574 696c 732e 4261 636b 6f66 6628 696e  utils.Backoff(in
+0000dbb0: 6974 6961 6c5f 6261 636b 6f66 663d 352c  itial_backoff=5,
+0000dbc0: 206d 6178 5f62 6163 6b6f 6666 5f66 6163   max_backoff_fac
+0000dbd0: 746f 723d 3529 0a20 2020 2066 6f72 2069  tor=5).    for i
+0000dbe0: 2069 6e20 7261 6e67 6528 6d61 785f 6174   in range(max_at
+0000dbf0: 7465 6d70 7473 293a 0a20 2020 2020 2020  tempts):.       
+0000dc00: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0000dc10: 2020 6675 6c6c 5f63 6c75 7374 6572 5f79    full_cluster_y
+0000dc20: 616d 6c20 3d20 7374 7228 7061 7468 6c69  aml = str(pathli
+0000dc30: 622e 5061 7468 2863 6c75 7374 6572 5f79  b.Path(cluster_y
+0000dc40: 616d 6c29 2e65 7870 616e 6475 7365 7228  aml).expanduser(
+0000dc50: 2929 0a20 2020 2020 2020 2020 2020 206f  )).            o
+0000dc60: 7574 203d 2073 7562 7072 6f63 6573 735f  ut = subprocess_
+0000dc70: 7574 696c 732e 7275 6e28 0a20 2020 2020  utils.run(.     
+0000dc80: 2020 2020 2020 2020 2020 2066 2772 6179             f'ray
+0000dc90: 2067 6574 2d68 6561 642d 6970 207b 6675   get-head-ip {fu
+0000dca0: 6c6c 5f63 6c75 7374 6572 5f79 616d 6c21  ll_cluster_yaml!
+0000dcb0: 727d 272c 0a20 2020 2020 2020 2020 2020  r}',.           
+0000dcc0: 2020 2020 2073 7464 6f75 743d 7375 6270       stdout=subp
+0000dcd0: 726f 6365 7373 2e50 4950 452c 0a20 2020  rocess.PIPE,.   
+0000dce0: 2020 2020 2020 2020 2020 2020 2073 7464               std
+0000dcf0: 6572 723d 7375 6270 726f 6365 7373 2e44  err=subprocess.D
+0000dd00: 4556 4e55 4c4c 292e 7374 646f 7574 2e64  EVNULL).stdout.d
+0000dd10: 6563 6f64 6528 292e 7374 7269 7028 290a  ecode().strip().
+0000dd20: 2020 2020 2020 2020 2020 2020 6865 6164              head
+0000dd30: 5f69 705f 6c69 7374 203d 2072 652e 6669  _ip_list = re.fi
+0000dd40: 6e64 616c 6c28 4950 5f41 4444 525f 5245  ndall(IP_ADDR_RE
+0000dd50: 4745 582c 206f 7574 290a 2020 2020 2020  GEX, out).      
+0000dd60: 2020 2020 2020 6966 206c 656e 2868 6561        if len(hea
+0000dd70: 645f 6970 5f6c 6973 7429 203e 2031 3a0a  d_ip_list) > 1:.
+0000dd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd90: 2320 5468 6973 2063 6f75 6c64 2062 6520  # This could be 
+0000dda0: 7472 6967 6765 7265 6420 6966 2065 2e67  triggered if e.g
+0000ddb0: 2e2c 2073 6f6d 6520 6c6f 6767 696e 6720  ., some logging 
+0000ddc0: 6973 2061 6464 6564 2069 6e0a 2020 2020  is added in.    
+0000ddd0: 2020 2020 2020 2020 2020 2020 2320 736b              # sk
+0000dde0: 7970 696c 6f74 5f63 6f6e 6669 672c 2061  ypilot_config, a
+0000ddf0: 206d 6f64 756c 6520 7468 6174 2068 6173   module that has
+0000de00: 2073 6f6d 6520 636f 6465 2065 7865 6375   some code execu
+0000de10: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+0000de20: 2020 2020 2320 7768 656e 6576 6572 2060      # whenever `
+0000de30: 736b 7960 2069 7320 696d 706f 7274 6564  sky` is imported
+0000de40: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000de50: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+0000de60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000de70: 2020 2020 2020 2744 6574 6563 7465 6420        'Detected 
+0000de80: 6d6f 7265 2074 6861 6e20 3120 4950 2066  more than 1 IP f
+0000de90: 726f 6d20 7468 6520 6f75 7470 7574 206f  rom the output o
+0000dea0: 6620 270a 2020 2020 2020 2020 2020 2020  f '.            
+0000deb0: 2020 2020 2020 2020 2774 6865 2060 7261          'the `ra
+0000dec0: 7920 6765 742d 6865 6164 2d69 7060 2063  y get-head-ip` c
+0000ded0: 6f6d 6d61 6e64 2e20 5468 6973 2063 6f75  ommand. This cou
+0000dee0: 6c64 2027 0a20 2020 2020 2020 2020 2020  ld '.           
+0000def0: 2020 2020 2020 2020 2027 6861 7070 656e           'happen
+0000df00: 2069 6620 7468 6572 6520 6973 2065 7874   if there is ext
+0000df10: 7261 206f 7574 7075 7420 6672 6f6d 2069  ra output from i
+0000df20: 742c 2027 0a20 2020 2020 2020 2020 2020  t, '.           
+0000df30: 2020 2020 2020 2020 2027 7768 6963 6820           'which 
+0000df40: 7368 6f75 6c64 2062 6520 696e 7370 6563  should be inspec
+0000df50: 7465 6420 6265 6c6f 772e 5c6e 5072 6f63  ted below.\nProc
+0000df60: 6565 6469 6e67 2077 6974 6820 270a 2020  eeding with '.  
+0000df70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df80: 2020 6627 7468 6520 6c61 7374 2064 6574    f'the last det
+0000df90: 6563 7465 6420 4950 2028 7b68 6561 645f  ected IP ({head_
+0000dfa0: 6970 5f6c 6973 745b 2d31 5d7d 2920 6173  ip_list[-1]}) as
+0000dfb0: 2068 6561 6420 4950 2e27 0a20 2020 2020   head IP.'.     
+0000dfc0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000dfd0: 275c 6e3d 3d20 4f75 7470 7574 203d 3d5c  '\n== Output ==\
+0000dfe0: 6e7b 6f75 747d 270a 2020 2020 2020 2020  n{out}'.        
+0000dff0: 2020 2020 2020 2020 2020 2020 6627 5c6e              f'\n
+0000e000: 3d3d 204f 7574 7075 7420 656e 6473 203d  == Output ends =
+0000e010: 3d27 290a 2020 2020 2020 2020 2020 2020  =').            
+0000e020: 2020 2020 6865 6164 5f69 705f 6c69 7374      head_ip_list
+0000e030: 203d 2068 6561 645f 6970 5f6c 6973 745b   = head_ip_list[
+0000e040: 2d31 3a5d 0a20 2020 2020 2020 2020 2020  -1:].           
+0000e050: 2061 7373 6572 7420 3120 3d3d 206c 656e   assert 1 == len
+0000e060: 2868 6561 645f 6970 5f6c 6973 7429 2c20  (head_ip_list), 
+0000e070: 286f 7574 2c20 6865 6164 5f69 705f 6c69  (out, head_ip_li
+0000e080: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
+0000e090: 6865 6164 5f69 7020 3d20 6865 6164 5f69  head_ip = head_i
+0000e0a0: 705f 6c69 7374 5b30 5d0a 2020 2020 2020  p_list[0].      
+0000e0b0: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
+0000e0c0: 2020 2020 6578 6365 7074 2073 7562 7072      except subpr
+0000e0d0: 6f63 6573 732e 4361 6c6c 6564 5072 6f63  ocess.CalledProc
+0000e0e0: 6573 7345 7272 6f72 2061 7320 653a 0a20  essError as e:. 
+0000e0f0: 2020 2020 2020 2020 2020 2069 6620 6920             if i 
+0000e100: 3d3d 206d 6178 5f61 7474 656d 7074 7320  == max_attempts 
+0000e110: 2d20 313a 0a20 2020 2020 2020 2020 2020  - 1:.           
+0000e120: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
+0000e130: 7469 6f6e 732e 4665 7463 6849 5045 7272  tions.FetchIPErr
+0000e140: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000e150: 2020 2020 2020 2020 7265 6173 6f6e 3d65          reason=e
+0000e160: 7863 6570 7469 6f6e 732e 4665 7463 6849  xceptions.FetchI
+0000e170: 5045 7272 6f72 2e52 6561 736f 6e2e 4845  PError.Reason.HE
+0000e180: 4144 2920 6672 6f6d 2065 0a20 2020 2020  AD) from e.     
+0000e190: 2020 2020 2020 2023 2052 6574 7279 2069         # Retry i
+0000e1a0: 6620 7468 6520 636c 7573 7465 7220 6973  f the cluster is
+0000e1b0: 206e 6f74 2075 7020 7965 742e 0a20 2020   not up yet..   
+0000e1c0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0000e1d0: 6465 6275 6728 2752 6574 7279 696e 6720  debug('Retrying 
+0000e1e0: 746f 2067 6574 2068 6561 6420 6970 2e27  to get head ip.'
+0000e1f0: 290a 2020 2020 2020 2020 2020 2020 7469  ).            ti
+0000e200: 6d65 2e73 6c65 6570 2862 6163 6b6f 6666  me.sleep(backoff
+0000e210: 2e63 7572 7265 6e74 5f62 6163 6b6f 6666  .current_backoff
+0000e220: 2829 290a 2020 2020 7265 7475 726e 2068  ()).    return h
+0000e230: 6561 645f 6970 0a0a 0a40 7469 6d65 6c69  ead_ip...@timeli
+0000e240: 6e65 2e65 7665 6e74 0a64 6566 2067 6574  ne.event.def get
+0000e250: 5f6e 6f64 655f 6970 7328 636c 7573 7465  _node_ips(cluste
+0000e260: 725f 7961 6d6c 3a20 7374 722c 0a20 2020  r_yaml: str,.   
+0000e270: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0000e280: 7065 6374 6564 5f6e 756d 5f6e 6f64 6573  pected_num_nodes
+0000e290: 3a20 696e 742c 0a20 2020 2020 2020 2020  : int,.         
+0000e2a0: 2020 2020 2020 2020 6865 6164 5f69 705f          head_ip_
+0000e2b0: 6d61 785f 6174 7465 6d70 7473 3a20 696e  max_attempts: in
+0000e2c0: 7420 3d20 312c 0a20 2020 2020 2020 2020  t = 1,.         
+0000e2d0: 2020 2020 2020 2020 776f 726b 6572 5f69          worker_i
+0000e2e0: 705f 6d61 785f 6174 7465 6d70 7473 3a20  p_max_attempts: 
+0000e2f0: 696e 7420 3d20 312c 0a20 2020 2020 2020  int = 1,.       
+0000e300: 2020 2020 2020 2020 2020 6765 745f 696e            get_in
+0000e310: 7465 726e 616c 5f69 7073 3a20 626f 6f6c  ternal_ips: bool
+0000e320: 203d 2046 616c 7365 2920 2d3e 204c 6973   = False) -> Lis
+0000e330: 745b 7374 725d 3a0a 2020 2020 2222 2252  t[str]:.    """R
+0000e340: 6574 7572 6e73 2074 6865 2049 5073 206f  eturns the IPs o
+0000e350: 6620 616c 6c20 6e6f 6465 7320 696e 2074  f all nodes in t
+0000e360: 6865 2063 6c75 7374 6572 2c20 7769 7468  he cluster, with
+0000e370: 2068 6561 6420 6e6f 6465 2061 7420 6672   head node at fr
+0000e380: 6f6e 742e 0a0a 2020 2020 4172 6773 3a0a  ont...    Args:.
+0000e390: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
+0000e3a0: 7961 6d6c 3a20 5061 7468 2074 6f20 7468  yaml: Path to th
+0000e3b0: 6520 636c 7573 7465 7220 7961 6d6c 2e0a  e cluster yaml..
+0000e3c0: 2020 2020 2020 2020 6578 7065 6374 6564          expected
+0000e3d0: 5f6e 756d 5f6e 6f64 6573 3a20 4578 7065  _num_nodes: Expe
+0000e3e0: 6374 6564 206e 756d 6265 7220 6f66 206e  cted number of n
+0000e3f0: 6f64 6573 2069 6e20 7468 6520 636c 7573  odes in the clus
+0000e400: 7465 722e 0a20 2020 2020 2020 2068 6561  ter..        hea
+0000e410: 645f 6970 5f6d 6178 5f61 7474 656d 7074  d_ip_max_attempt
+0000e420: 733a 204d 6178 2061 7474 656d 7074 7320  s: Max attempts 
+0000e430: 746f 2067 6574 2068 6561 6420 6970 2e0a  to get head ip..
+0000e440: 2020 2020 2020 2020 776f 726b 6572 5f69          worker_i
+0000e450: 705f 6d61 785f 6174 7465 6d70 7473 3a20  p_max_attempts: 
+0000e460: 4d61 7820 6174 7465 6d70 7473 2074 6f20  Max attempts to 
+0000e470: 6765 7420 776f 726b 6572 2069 7073 2e0a  get worker ips..
+0000e480: 2020 2020 2020 2020 6765 745f 696e 7465          get_inte
+0000e490: 726e 616c 5f69 7073 3a20 5768 6574 6865  rnal_ips: Whethe
+0000e4a0: 7220 746f 2067 6574 2069 6e74 6572 6e61  r to get interna
+0000e4b0: 6c20 4950 732e 2057 6865 6e20 4661 6c73  l IPs. When Fals
+0000e4c0: 652c 2069 7420 6973 2073 7469 6c6c 0a20  e, it is still. 
+0000e4d0: 2020 2020 2020 2020 2020 2070 6f73 7369             possi
+0000e4e0: 626c 6520 746f 2067 6574 2069 6e74 6572  ble to get inter
+0000e4f0: 6e61 6c20 4950 7320 6966 2074 6865 2063  nal IPs if the c
+0000e500: 6c75 7374 6572 2064 6f65 7320 6e6f 7420  luster does not 
+0000e510: 6861 7665 2065 7874 6572 6e61 6c0a 2020  have external.  
+0000e520: 2020 2020 2020 2020 2020 4950 732e 0a0a            IPs...
+0000e530: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+0000e540: 2020 2020 6578 6365 7074 696f 6e73 2e46      exceptions.F
+0000e550: 6574 6368 4950 4572 726f 723a 2069 6620  etchIPError: if 
+0000e560: 7765 2066 6169 6c65 6420 746f 2067 6574  we failed to get
+0000e570: 2074 6865 2049 5073 2e20 652e 7265 6173   the IPs. e.reas
+0000e580: 6f6e 2069 730a 2020 2020 2020 2020 2020  on is.          
+0000e590: 2020 4845 4144 206f 7220 574f 524b 4552    HEAD or WORKER
+0000e5a0: 2e0a 2020 2020 2222 220a 2020 2020 7261  ..    """.    ra
+0000e5b0: 795f 636f 6e66 6967 203d 2063 6f6d 6d6f  y_config = commo
+0000e5c0: 6e5f 7574 696c 732e 7265 6164 5f79 616d  n_utils.read_yam
+0000e5d0: 6c28 636c 7573 7465 725f 7961 6d6c 290a  l(cluster_yaml).
+0000e5e0: 2020 2020 2320 5573 6520 7468 6520 6e65      # Use the ne
+0000e5f0: 7720 7072 6f76 6973 696f 6e65 7220 666f  w provisioner fo
+0000e600: 7220 4157 532e 0a20 2020 2070 726f 7669  r AWS..    provi
+0000e610: 6465 725f 6e61 6d65 203d 2063 6c75 7374  der_name = clust
+0000e620: 6572 5f79 616d 6c5f 7574 696c 732e 6765  er_yaml_utils.ge
+0000e630: 745f 7072 6f76 6964 6572 5f6e 616d 6528  t_provider_name(
+0000e640: 7261 795f 636f 6e66 6967 290a 2020 2020  ray_config).    
+0000e650: 636c 6f75 6420 3d20 636c 6f75 645f 7265  cloud = cloud_re
+0000e660: 6769 7374 7279 2e43 4c4f 5544 5f52 4547  gistry.CLOUD_REG
+0000e670: 4953 5452 592e 6672 6f6d 5f73 7472 2870  ISTRY.from_str(p
+0000e680: 726f 7669 6465 725f 6e61 6d65 290a 2020  rovider_name).  
+0000e690: 2020 6173 7365 7274 2063 6c6f 7564 2069    assert cloud i
+0000e6a0: 7320 6e6f 7420 4e6f 6e65 2c20 7072 6f76  s not None, prov
+0000e6b0: 6964 6572 5f6e 616d 650a 0a20 2020 2069  ider_name..    i
+0000e6c0: 6620 636c 6f75 642e 5052 4f56 4953 494f  f cloud.PROVISIO
+0000e6d0: 4e45 525f 5645 5253 494f 4e20 3e3d 2063  NER_VERSION >= c
+0000e6e0: 6c6f 7564 732e 5072 6f76 6973 696f 6e65  louds.Provisione
+0000e6f0: 7256 6572 7369 6f6e 2e53 4b59 5049 4c4f  rVersion.SKYPILO
+0000e700: 543a 0a20 2020 2020 2020 2074 7279 3a0a  T:.        try:.
+0000e710: 2020 2020 2020 2020 2020 2020 6d65 7461              meta
+0000e720: 6461 7461 203d 2070 726f 7669 7369 6f6e  data = provision
+0000e730: 5f6c 6962 2e67 6574 5f63 6c75 7374 6572  _lib.get_cluster
+0000e740: 5f69 6e66 6f28 0a20 2020 2020 2020 2020  _info(.         
+0000e750: 2020 2020 2020 2070 726f 7669 6465 725f         provider_
+0000e760: 6e61 6d65 2c20 7261 795f 636f 6e66 6967  name, ray_config
+0000e770: 5b27 7072 6f76 6964 6572 275d 2e67 6574  ['provider'].get
+0000e780: 2827 7265 6769 6f6e 2729 2c0a 2020 2020  ('region'),.    
+0000e790: 2020 2020 2020 2020 2020 2020 7261 795f              ray_
+0000e7a0: 636f 6e66 6967 5b27 636c 7573 7465 725f  config['cluster_
+0000e7b0: 6e61 6d65 275d 2c20 7261 795f 636f 6e66  name'], ray_conf
+0000e7c0: 6967 5b27 7072 6f76 6964 6572 275d 290a  ig['provider']).
+0000e7d0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0000e7e0: 7863 6570 7469 6f6e 2061 7320 653a 2020  xception as e:  
+0000e7f0: 2320 7079 6c69 6e74 3a20 6469 7361 626c  # pylint: disabl
+0000e800: 653d 6272 6f61 642d 6578 6365 7074 0a20  e=broad-except. 
+0000e810: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
+0000e820: 7320 636f 756c 6420 6861 7070 656e 2077  s could happen w
+0000e830: 6865 6e20 7468 6520 564d 2069 7320 6e6f  hen the VM is no
+0000e840: 7420 6675 6c6c 7920 6c61 756e 6368 6564  t fully launched
+0000e850: 2c20 616e 6420 6120 7573 6572 0a20 2020  , and a user.   
+0000e860: 2020 2020 2020 2020 2023 2069 7320 7472           # is tr
+0000e870: 7969 6e67 2074 6f20 7465 726d 696e 6174  ying to terminat
+0000e880: 6520 6974 2077 6974 6820 6073 6b79 2064  e it with `sky d
+0000e890: 6f77 6e60 2e0a 2020 2020 2020 2020 2020  own`..          
+0000e8a0: 2020 6c6f 6767 6572 2e64 6562 7567 280a    logger.debug(.
+0000e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e8c0: 2746 6169 6c65 6420 746f 2067 6574 2063  'Failed to get c
+0000e8d0: 6c75 7374 6572 2069 6e66 6f20 666f 7220  luster info for 
+0000e8e0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0000e8f0: 2020 6627 7b72 6179 5f63 6f6e 6669 675b    f'{ray_config[
+0000e900: 2263 6c75 7374 6572 5f6e 616d 6522 5d7d  "cluster_name"]}
+0000e910: 2066 726f 6d20 7468 6520 6e65 7720 7072   from the new pr
+0000e920: 6f76 6973 696f 6e65 7220 270a 2020 2020  ovisioner '.    
+0000e930: 2020 2020 2020 2020 2020 2020 6627 7769              f'wi
+0000e940: 7468 207b 636f 6d6d 6f6e 5f75 7469 6c73  th {common_utils
+0000e950: 2e66 6f72 6d61 745f 6578 6365 7074 696f  .format_exceptio
+0000e960: 6e28 6529 7d2e 2729 0a20 2020 2020 2020  n(e)}.').       
+0000e970: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
+0000e980: 7469 6f6e 732e 4665 7463 6849 5045 7272  tions.FetchIPErr
+0000e990: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000e9a0: 2020 2020 6578 6365 7074 696f 6e73 2e46      exceptions.F
+0000e9b0: 6574 6368 4950 4572 726f 722e 5265 6173  etchIPError.Reas
+0000e9c0: 6f6e 2e48 4541 4429 2066 726f 6d20 650a  on.HEAD) from e.
+0000e9d0: 2020 2020 2020 2020 6966 206c 656e 286d          if len(m
+0000e9e0: 6574 6164 6174 612e 696e 7374 616e 6365  etadata.instance
+0000e9f0: 7329 203c 2065 7870 6563 7465 645f 6e75  s) < expected_nu
+0000ea00: 6d5f 6e6f 6465 733a 0a20 2020 2020 2020  m_nodes:.       
+0000ea10: 2020 2020 2023 2053 696d 756c 6174 6520       # Simulate 
+0000ea20: 7468 6520 6578 6365 7074 696f 6e20 7768  the exception wh
+0000ea30: 656e 2052 6179 2068 6561 6420 6e6f 6465  en Ray head node
+0000ea40: 2069 7320 6e6f 7420 7570 2e0a 2020 2020   is not up..    
+0000ea50: 2020 2020 2020 2020 7261 6973 6520 6578          raise ex
+0000ea60: 6365 7074 696f 6e73 2e46 6574 6368 4950  ceptions.FetchIP
+0000ea70: 4572 726f 7228 6578 6365 7074 696f 6e73  Error(exceptions
+0000ea80: 2e46 6574 6368 4950 4572 726f 722e 5265  .FetchIPError.Re
+0000ea90: 6173 6f6e 2e48 4541 4429 0a20 2020 2020  ason.HEAD).     
+0000eaa0: 2020 2072 6574 7572 6e20 6d65 7461 6461     return metada
+0000eab0: 7461 2e67 6574 5f66 6561 7369 626c 655f  ta.get_feasible_
+0000eac0: 6970 7328 6765 745f 696e 7465 726e 616c  ips(get_internal
+0000ead0: 5f69 7073 290a 0a20 2020 2069 6620 6765  _ips)..    if ge
+0000eae0: 745f 696e 7465 726e 616c 5f69 7073 3a0a  t_internal_ips:.
+0000eaf0: 2020 2020 2020 2020 7769 7468 2074 656d          with tem
+0000eb00: 7066 696c 652e 4e61 6d65 6454 656d 706f  pfile.NamedTempo
+0000eb10: 7261 7279 4669 6c65 286d 6f64 653d 2777  raryFile(mode='w
+0000eb20: 272c 2064 656c 6574 653d 4661 6c73 6529  ', delete=False)
+0000eb30: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
+0000eb40: 2020 2072 6179 5f63 6f6e 6669 675b 2770     ray_config['p
+0000eb50: 726f 7669 6465 7227 5d5b 2775 7365 5f69  rovider']['use_i
+0000eb60: 6e74 6572 6e61 6c5f 6970 7327 5d20 3d20  nternal_ips'] = 
+0000eb70: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+0000eb80: 2079 616d 6c2e 6475 6d70 2872 6179 5f63   yaml.dump(ray_c
+0000eb90: 6f6e 6669 672c 2066 290a 2020 2020 2020  onfig, f).      
+0000eba0: 2020 2020 2020 636c 7573 7465 725f 7961        cluster_ya
+0000ebb0: 6d6c 203d 2066 2e6e 616d 650a 0a20 2020  ml = f.name..   
+0000ebc0: 2023 2043 6865 636b 2074 6865 206e 6574   # Check the net
+0000ebd0: 776f 726b 2063 6f6e 6e65 6374 696f 6e20  work connection 
+0000ebe0: 6669 7273 7420 746f 2061 766f 6964 206c  first to avoid l
+0000ebf0: 6f6e 6720 6861 6e67 696e 6720 7469 6d65  ong hanging time
+0000ec00: 2066 6f72 0a20 2020 2023 2072 6179 2067   for.    # ray g
+0000ec10: 6574 2d68 6561 642d 6970 2062 656c 6f77  et-head-ip below
+0000ec20: 2c20 6966 2061 206c 6f6e 672d 6c61 7374  , if a long-last
+0000ec30: 696e 6720 6e65 7477 6f72 6b20 636f 6e6e  ing network conn
+0000ec40: 6563 7469 6f6e 2066 6169 6c75 7265 0a20  ection failure. 
+0000ec50: 2020 2023 2068 6170 7065 6e73 2e0a 2020     # happens..  
+0000ec60: 2020 6368 6563 6b5f 6e65 7477 6f72 6b5f    check_network_
+0000ec70: 636f 6e6e 6563 7469 6f6e 2829 0a20 2020  connection().   
+0000ec80: 2068 6561 645f 6970 203d 205f 7175 6572   head_ip = _quer
+0000ec90: 795f 6865 6164 5f69 705f 7769 7468 5f72  y_head_ip_with_r
+0000eca0: 6574 7269 6573 2863 6c75 7374 6572 5f79  etries(cluster_y
+0000ecb0: 616d 6c2c 0a20 2020 2020 2020 2020 2020  aml,.           
+0000ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ecd0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000ece0: 6178 5f61 7474 656d 7074 733d 6865 6164  ax_attempts=head
+0000ecf0: 5f69 705f 6d61 785f 6174 7465 6d70 7473  _ip_max_attempts
+0000ed00: 290a 2020 2020 6865 6164 5f69 705f 6c69  ).    head_ip_li
+0000ed10: 7374 203d 205b 6865 6164 5f69 705d 0a20  st = [head_ip]. 
+0000ed20: 2020 2069 6620 6578 7065 6374 6564 5f6e     if expected_n
+0000ed30: 756d 5f6e 6f64 6573 203e 2031 3a0a 2020  um_nodes > 1:.  
+0000ed40: 2020 2020 2020 6261 636b 6f66 6620 3d20        backoff = 
+0000ed50: 636f 6d6d 6f6e 5f75 7469 6c73 2e42 6163  common_utils.Bac
+0000ed60: 6b6f 6666 2869 6e69 7469 616c 5f62 6163  koff(initial_bac
+0000ed70: 6b6f 6666 3d35 2c20 6d61 785f 6261 636b  koff=5, max_back
+0000ed80: 6f66 665f 6661 6374 6f72 3d35 290a 0a20  off_factor=5).. 
+0000ed90: 2020 2020 2020 2066 6f72 2072 6574 7279         for retry
+0000eda0: 5f63 6e74 2069 6e20 7261 6e67 6528 776f  _cnt in range(wo
+0000edb0: 726b 6572 5f69 705f 6d61 785f 6174 7465  rker_ip_max_atte
+0000edc0: 6d70 7473 293a 0a20 2020 2020 2020 2020  mpts):.         
+0000edd0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000ede0: 2020 2020 2020 2020 6675 6c6c 5f63 6c75          full_clu
+0000edf0: 7374 6572 5f79 616d 6c20 3d20 7374 7228  ster_yaml = str(
+0000ee00: 7061 7468 6c69 622e 5061 7468 2863 6c75  pathlib.Path(clu
+0000ee10: 7374 6572 5f79 616d 6c29 2e65 7870 616e  ster_yaml).expan
+0000ee20: 6475 7365 7228 2929 0a20 2020 2020 2020  duser()).       
+0000ee30: 2020 2020 2020 2020 2070 726f 6320 3d20           proc = 
+0000ee40: 7375 6270 726f 6365 7373 5f75 7469 6c73  subprocess_utils
+0000ee50: 2e72 756e 280a 2020 2020 2020 2020 2020  .run(.          
+0000ee60: 2020 2020 2020 2020 2020 6627 7261 7920            f'ray 
+0000ee70: 6765 742d 776f 726b 6572 2d69 7073 207b  get-worker-ips {
+0000ee80: 6675 6c6c 5f63 6c75 7374 6572 5f79 616d  full_cluster_yam
+0000ee90: 6c21 727d 272c 0a20 2020 2020 2020 2020  l!r}',.         
+0000eea0: 2020 2020 2020 2020 2020 2073 7464 6f75             stdou
+0000eeb0: 743d 7375 6270 726f 6365 7373 2e50 4950  t=subprocess.PIP
+0000eec0: 452c 0a20 2020 2020 2020 2020 2020 2020  E,.             
+0000eed0: 2020 2020 2020 2073 7464 6572 723d 7375         stderr=su
+0000eee0: 6270 726f 6365 7373 2e50 4950 4529 0a20  bprocess.PIPE). 
+0000eef0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000ef00: 7574 203d 2070 726f 632e 7374 646f 7574  ut = proc.stdout
+0000ef10: 2e64 6563 6f64 6528 290a 2020 2020 2020  .decode().      
+0000ef20: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+0000ef30: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0000ef40: 7074 2073 7562 7072 6f63 6573 732e 4361  pt subprocess.Ca
+0000ef50: 6c6c 6564 5072 6f63 6573 7345 7272 6f72  lledProcessError
+0000ef60: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+0000ef70: 2020 2020 2020 2069 6620 7265 7472 795f         if retry_
+0000ef80: 636e 7420 3d3d 2077 6f72 6b65 725f 6970  cnt == worker_ip
+0000ef90: 5f6d 6178 5f61 7474 656d 7074 7320 2d20  _max_attempts - 
+0000efa0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+0000efb0: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
+0000efc0: 6570 7469 6f6e 732e 4665 7463 6849 5045  eptions.FetchIPE
+0000efd0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000efe0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0000eff0: 6365 7074 696f 6e73 2e46 6574 6368 4950  ceptions.FetchIP
+0000f000: 4572 726f 722e 5265 6173 6f6e 2e57 4f52  Error.Reason.WOR
+0000f010: 4b45 5229 2066 726f 6d20 650a 2020 2020  KER) from e.    
+0000f020: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+0000f030: 7472 7920 6966 2074 6865 2073 7368 2069  try if the ssh i
+0000f040: 7320 6e6f 7420 7265 6164 7920 666f 7220  s not ready for 
+0000f050: 7468 6520 776f 726b 6572 7320 7965 742e  the workers yet.
+0000f060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f070: 2062 6163 6b6f 6666 5f74 696d 6520 3d20   backoff_time = 
+0000f080: 6261 636b 6f66 662e 6375 7272 656e 745f  backoff.current_
+0000f090: 6261 636b 6f66 6628 290a 2020 2020 2020  backoff().      
+0000f0a0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0000f0b0: 2e64 6562 7567 2827 5265 7472 7969 6e67  .debug('Retrying
+0000f0c0: 2074 6f20 6765 7420 776f 726b 6572 2069   to get worker i
+0000f0d0: 7020 270a 2020 2020 2020 2020 2020 2020  p '.            
+0000f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0f0: 2066 275b 7b72 6574 7279 5f63 6e74 7d2f   f'[{retry_cnt}/
+0000f100: 7b77 6f72 6b65 725f 6970 5f6d 6178 5f61  {worker_ip_max_a
+0000f110: 7474 656d 7074 737d 5d20 696e 2027 0a20  ttempts}] in '. 
+0000f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f130: 2020 2020 2020 2020 2020 2020 6627 7b62              f'{b
+0000f140: 6163 6b6f 6666 5f74 696d 657d 2073 6563  ackoff_time} sec
+0000f150: 6f6e 6473 2e27 290a 2020 2020 2020 2020  onds.').        
+0000f160: 2020 2020 2020 2020 7469 6d65 2e73 6c65          time.sle
+0000f170: 6570 2862 6163 6b6f 6666 5f74 696d 6529  ep(backoff_time)
+0000f180: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
+0000f190: 6970 7320 3d20 7265 2e66 696e 6461 6c6c  ips = re.findall
+0000f1a0: 2849 505f 4144 4452 5f52 4547 4558 2c20  (IP_ADDR_REGEX, 
+0000f1b0: 6f75 7429 0a20 2020 2020 2020 2069 6620  out).        if 
+0000f1c0: 6c65 6e28 776f 726b 6572 5f69 7073 2920  len(worker_ips) 
+0000f1d0: 213d 2065 7870 6563 7465 645f 6e75 6d5f  != expected_num_
+0000f1e0: 6e6f 6465 7320 2d20 313a 0a20 2020 2020  nodes - 1:.     
+0000f1f0: 2020 2020 2020 206e 203d 2065 7870 6563         n = expec
+0000f200: 7465 645f 6e75 6d5f 6e6f 6465 7320 2d20  ted_num_nodes - 
+0000f210: 310a 2020 2020 2020 2020 2020 2020 6966  1.            if
+0000f220: 206c 656e 2877 6f72 6b65 725f 6970 7329   len(worker_ips)
+0000f230: 203e 206e 3a0a 2020 2020 2020 2020 2020   > n:.          
+0000f240: 2020 2020 2020 2320 5468 6973 2063 6f75        # This cou
+0000f250: 6c64 2062 6520 7472 6967 6765 7265 6420  ld be triggered 
+0000f260: 6966 2065 2e67 2e2c 2073 6f6d 6520 6c6f  if e.g., some lo
+0000f270: 6767 696e 6720 6973 2061 6464 6564 2069  gging is added i
+0000f280: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+0000f290: 2020 2320 736b 7970 696c 6f74 5f63 6f6e    # skypilot_con
+0000f2a0: 6669 672c 2061 206d 6f64 756c 6520 7468  fig, a module th
+0000f2b0: 6174 2068 6173 2073 6f6d 6520 636f 6465  at has some code
+0000f2c0: 2065 7865 6375 7465 6420 7768 656e 6576   executed whenev
+0000f2d0: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
+0000f2e0: 2020 2023 2060 736b 7960 2069 7320 696d     # `sky` is im
+0000f2f0: 706f 7274 6564 2e0a 2020 2020 2020 2020  ported..        
+0000f300: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
+0000f310: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
+0000f320: 2020 2020 2020 2020 2020 2020 6627 4578              f'Ex
+0000f330: 7065 6374 6564 207b 6e7d 2077 6f72 6b65  pected {n} worke
+0000f340: 7220 4950 2873 293b 2066 6f75 6e64 2027  r IP(s); found '
+0000f350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f360: 2020 2020 2066 277b 6c65 6e28 776f 726b       f'{len(work
+0000f370: 6572 5f69 7073 297d 3a20 7b77 6f72 6b65  er_ips)}: {worke
+0000f380: 725f 6970 737d 270a 2020 2020 2020 2020  r_ips}'.        
+0000f390: 2020 2020 2020 2020 2020 2020 275c 6e54              '\nT
+0000f3a0: 6869 7320 636f 756c 6420 6861 7070 656e  his could happen
+0000f3b0: 2069 6620 7468 6572 6520 6973 2065 7874   if there is ext
+0000f3c0: 7261 206f 7574 7075 7420 6672 6f6d 2027  ra output from '
+0000f3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f3e0: 2020 2020 2027 6072 6179 2067 6574 2d77       '`ray get-w
+0000f3f0: 6f72 6b65 722d 6970 7360 2c20 7768 6963  orker-ips`, whic
+0000f400: 6820 7368 6f75 6c64 2062 6520 696e 7370  h should be insp
+0000f410: 6563 7465 6420 6265 6c6f 772e 270a 2020  ected below.'.  
+0000f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f430: 2020 6627 5c6e 3d3d 204f 7574 7075 7420    f'\n== Output 
+0000f440: 3d3d 5c6e 7b6f 7574 7d27 0a20 2020 2020  ==\n{out}'.     
+0000f450: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000f460: 275c 6e3d 3d20 4f75 7470 7574 2065 6e64  '\n== Output end
+0000f470: 7320 3d3d 2729 0a20 2020 2020 2020 2020  s ==').         
+0000f480: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
+0000f490: 726e 696e 6728 6627 5c6e 5072 6f63 6565  rning(f'\nProcee
+0000f4a0: 6469 6e67 2077 6974 6820 7468 6520 6c61  ding with the la
+0000f4b0: 7374 207b 6e7d 2027 0a20 2020 2020 2020  st {n} '.       
+0000f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f4d0: 2020 2020 2020 2020 6627 6465 7465 6374          f'detect
+0000f4e0: 6564 2049 5028 7329 3a20 7b77 6f72 6b65  ed IP(s): {worke
+0000f4f0: 725f 6970 735b 2d6e 3a5d 7d2e 2729 0a20  r_ips[-n:]}.'). 
+0000f500: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0000f510: 6f72 6b65 725f 6970 7320 3d20 776f 726b  orker_ips = work
+0000f520: 6572 5f69 7073 5b2d 6e3a 5d0a 2020 2020  er_ips[-n:].    
+0000f530: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000f540: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000f550: 6973 6520 6578 6365 7074 696f 6e73 2e46  ise exceptions.F
+0000f560: 6574 6368 4950 4572 726f 7228 0a20 2020  etchIPError(.   
+0000f570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f580: 2065 7863 6570 7469 6f6e 732e 4665 7463   exceptions.Fetc
+0000f590: 6849 5045 7272 6f72 2e52 6561 736f 6e2e  hIPError.Reason.
+0000f5a0: 574f 524b 4552 290a 2020 2020 656c 7365  WORKER).    else
+0000f5b0: 3a0a 2020 2020 2020 2020 776f 726b 6572  :.        worker
+0000f5c0: 5f69 7073 203d 205b 5d0a 2020 2020 7265  _ips = [].    re
+0000f5d0: 7475 726e 2068 6561 645f 6970 5f6c 6973  turn head_ip_lis
+0000f5e0: 7420 2b20 776f 726b 6572 5f69 7073 0a0a  t + worker_ips..
+0000f5f0: 0a64 6566 2063 6865 636b 5f6e 6574 776f  .def check_netwo
+0000f600: 726b 5f63 6f6e 6e65 6374 696f 6e28 293a  rk_connection():
+0000f610: 0a20 2020 2023 2054 6f6c 6572 6174 6520  .    # Tolerate 
+0000f620: 3320 7265 7472 6965 7320 6173 2069 7420  3 retries as it 
+0000f630: 6973 206f 6273 6572 7665 6420 7468 6174  is observed that
+0000f640: 2063 6f6e 6e65 6374 696f 6e73 2063 616e   connections can
+0000f650: 2066 6169 6c2e 0a20 2020 2061 6461 7074   fail..    adapt
+0000f660: 6572 203d 2061 6461 7074 6572 732e 4854  er = adapters.HT
+0000f670: 5450 4164 6170 7465 7228 6d61 785f 7265  TPAdapter(max_re
+0000f680: 7472 6965 733d 7265 7472 795f 6c69 622e  tries=retry_lib.
+0000f690: 5265 7472 7928 746f 7461 6c3d 3329 290a  Retry(total=3)).
+0000f6a0: 2020 2020 6874 7470 203d 2072 6571 7565      http = reque
+0000f6b0: 7374 732e 5365 7373 696f 6e28 290a 2020  sts.Session().  
+0000f6c0: 2020 6874 7470 2e6d 6f75 6e74 2827 6874    http.mount('ht
+0000f6d0: 7470 733a 2f2f 272c 2061 6461 7074 6572  tps://', adapter
+0000f6e0: 290a 2020 2020 6874 7470 2e6d 6f75 6e74  ).    http.mount
+0000f6f0: 2827 6874 7470 3a2f 2f27 2c20 6164 6170  ('http://', adap
+0000f700: 7465 7229 0a20 2020 2066 6f72 2069 2c20  ter).    for i, 
+0000f710: 6970 2069 6e20 656e 756d 6572 6174 6528  ip in enumerate(
+0000f720: 5f54 4553 545f 4950 5f4c 4953 5429 3a0a  _TEST_IP_LIST):.
+0000f730: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000f740: 2020 2020 2020 2020 2068 7474 702e 6865           http.he
+0000f750: 6164 2869 702c 2074 696d 656f 7574 3d33  ad(ip, timeout=3
+0000f760: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0000f770: 7475 726e 0a20 2020 2020 2020 2065 7863  turn.        exc
+0000f780: 6570 7420 2872 6571 7565 7374 732e 5469  ept (requests.Ti
+0000f790: 6d65 6f75 742c 2072 6571 7565 7374 732e  meout, requests.
+0000f7a0: 6578 6365 7074 696f 6e73 2e43 6f6e 6e65  exceptions.Conne
+0000f7b0: 6374 696f 6e45 7272 6f72 2920 6173 2065  ctionError) as e
+0000f7c0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0000f7d0: 2069 203d 3d20 6c65 6e28 5f54 4553 545f   i == len(_TEST_
+0000f7e0: 4950 5f4c 4953 5429 202d 2031 3a0a 2020  IP_LIST) - 1:.  
+0000f7f0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000f800: 6973 6520 6578 6365 7074 696f 6e73 2e4e  ise exceptions.N
+0000f810: 6574 776f 726b 4572 726f 7228 2743 6f75  etworkError('Cou
+0000f820: 6c64 206e 6f74 2072 6566 7265 7368 2074  ld not refresh t
+0000f830: 6865 2063 6c75 7374 6572 2e20 270a 2020  he cluster. '.  
+0000f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000f850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f870: 2020 2020 2020 2020 2020 2020 2027 4e65               'Ne
-0000f880: 7477 6f72 6b20 7365 656d 7320 646f 776e  twork seems down
-0000f890: 2e27 2920 6672 6f6d 2065 0a0a 0a64 6566  .') from e...def
-0000f8a0: 2063 6865 636b 5f6f 776e 6572 5f69 6465   check_owner_ide
-0000f8b0: 6e74 6974 7928 636c 7573 7465 725f 6e61  ntity(cluster_na
-0000f8c0: 6d65 3a20 7374 7229 202d 3e20 4e6f 6e65  me: str) -> None
-0000f8d0: 3a0a 2020 2020 2222 2243 6865 636b 2069  :.    """Check i
-0000f8e0: 6620 6375 7272 656e 7420 7573 6572 2069  f current user i
-0000f8f0: 7320 7468 6520 7361 6d65 2061 7320 7468  s the same as th
-0000f900: 6520 7573 6572 2077 686f 2063 7265 6174  e user who creat
-0000f910: 6564 2074 6865 2063 6c75 7374 6572 2e0a  ed the cluster..
-0000f920: 0a20 2020 2052 6169 7365 733a 0a20 2020  .    Raises:.   
-0000f930: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
-0000f940: 436c 7573 7465 724f 776e 6572 4964 656e  ClusterOwnerIden
-0000f950: 7469 7479 4d69 736d 6174 6368 4572 726f  tityMismatchErro
-0000f960: 723a 2069 6620 7468 6520 6375 7272 656e  r: if the curren
-0000f970: 7420 7573 6572 2069 730a 2020 2020 2020  t user is.      
-0000f980: 2020 2020 6e6f 7420 7468 6520 7361 6d65      not the same
-0000f990: 2061 7320 7468 6520 7573 6572 2077 686f   as the user who
-0000f9a0: 2063 7265 6174 6564 2074 6865 2063 6c75   created the clu
-0000f9b0: 7374 6572 2e0a 2020 2020 2020 2020 6578  ster..        ex
-0000f9c0: 6365 7074 696f 6e73 2e43 6c6f 7564 5573  ceptions.CloudUs
-0000f9d0: 6572 4964 656e 7469 7479 4572 726f 723a  erIdentityError:
-0000f9e0: 2069 6620 7765 2066 6169 6c20 746f 2067   if we fail to g
-0000f9f0: 6574 2074 6865 2063 7572 7265 6e74 2075  et the current u
-0000fa00: 7365 720a 2020 2020 2020 2020 2020 6964  ser.          id
-0000fa10: 656e 7469 7479 2e0a 2020 2020 2222 220a  entity..    """.
-0000fa20: 2020 2020 6966 2065 6e76 5f6f 7074 696f      if env_optio
-0000fa30: 6e73 2e4f 7074 696f 6e73 2e53 4b49 505f  ns.Options.SKIP_
-0000fa40: 434c 4f55 445f 4944 454e 5449 5459 5f43  CLOUD_IDENTITY_C
-0000fa50: 4845 434b 2e67 6574 2829 3a0a 2020 2020  HECK.get():.    
-0000fa60: 2020 2020 7265 7475 726e 0a20 2020 2072      return.    r
-0000fa70: 6563 6f72 6420 3d20 676c 6f62 616c 5f75  ecord = global_u
-0000fa80: 7365 725f 7374 6174 652e 6765 745f 636c  ser_state.get_cl
-0000fa90: 7573 7465 725f 6672 6f6d 5f6e 616d 6528  uster_from_name(
-0000faa0: 636c 7573 7465 725f 6e61 6d65 290a 2020  cluster_name).  
-0000fab0: 2020 6966 2072 6563 6f72 6420 6973 204e    if record is N
-0000fac0: 6f6e 653a 0a20 2020 2020 2020 2072 6574  one:.        ret
-0000fad0: 7572 6e0a 2020 2020 6861 6e64 6c65 203d  urn.    handle =
-0000fae0: 2072 6563 6f72 645b 2768 616e 646c 6527   record['handle'
-0000faf0: 5d0a 2020 2020 6966 206e 6f74 2069 7369  ].    if not isi
-0000fb00: 6e73 7461 6e63 6528 6861 6e64 6c65 2c20  nstance(handle, 
-0000fb10: 6261 636b 656e 6473 2e43 6c6f 7564 566d  backends.CloudVm
-0000fb20: 5261 7952 6573 6f75 7263 6548 616e 646c  RayResourceHandl
-0000fb30: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
-0000fb40: 726e 0a0a 2020 2020 636c 6f75 6420 3d20  rn..    cloud = 
-0000fb50: 6861 6e64 6c65 2e6c 6175 6e63 6865 645f  handle.launched_
-0000fb60: 7265 736f 7572 6365 732e 636c 6f75 640a  resources.cloud.
-0000fb70: 2020 2020 6375 7272 656e 745f 7573 6572      current_user
-0000fb80: 5f69 6465 6e74 6974 7920 3d20 636c 6f75  _identity = clou
-0000fb90: 642e 6765 745f 6375 7272 656e 745f 7573  d.get_current_us
-0000fba0: 6572 5f69 6465 6e74 6974 7928 290a 2020  er_identity().  
-0000fbb0: 2020 6f77 6e65 725f 6964 656e 7469 7479    owner_identity
-0000fbc0: 203d 2072 6563 6f72 645b 276f 776e 6572   = record['owner
-0000fbd0: 275d 0a20 2020 2069 6620 6375 7272 656e  '].    if curren
-0000fbe0: 745f 7573 6572 5f69 6465 6e74 6974 7920  t_user_identity 
-0000fbf0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0000fc00: 2023 2053 6b69 7020 7468 6520 6368 6563   # Skip the chec
-0000fc10: 6b20 6966 2074 6865 2063 6c6f 7564 2064  k if the cloud d
-0000fc20: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-0000fc30: 7573 6572 2069 6465 6e74 6974 792e 0a20  user identity.. 
-0000fc40: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-0000fc50: 2020 2320 5468 6520 7573 6572 2069 6465    # The user ide
-0000fc60: 6e74 6974 7920 6361 6e20 6265 204e 6f6e  ntity can be Non
-0000fc70: 652c 2069 6620 7468 6520 636c 7573 7465  e, if the cluste
-0000fc80: 7220 6973 2063 7265 6174 6564 2062 7920  r is created by 
-0000fc90: 616e 206f 6c64 6572 0a20 2020 2023 2076  an older.    # v
-0000fca0: 6572 7369 6f6e 206f 6620 536b 7950 696c  ersion of SkyPil
-0000fcb0: 6f74 2e20 496e 2074 6861 7420 6361 7365  ot. In that case
-0000fcc0: 2c20 7765 2073 6574 2074 6865 2075 7365  , we set the use
-0000fcd0: 7220 6964 656e 7469 7479 2074 6f20 7468  r identity to th
-0000fce0: 650a 2020 2020 2320 6375 7272 656e 7420  e.    # current 
-0000fcf0: 6f6e 652e 0a20 2020 2023 204e 4f54 453a  one..    # NOTE:
-0000fd00: 2061 2075 7365 7220 7768 6f20 7570 6772   a user who upgr
-0000fd10: 6164 6573 2053 6b79 5069 6c6f 7420 616e  ades SkyPilot an
-0000fd20: 6420 7377 6974 6368 6573 2074 6f20 6120  d switches to a 
-0000fd30: 6e65 7720 636c 6f75 6420 6964 656e 7469  new cloud identi
-0000fd40: 7479 0a20 2020 2023 2069 6d6d 6564 6961  ty.    # immedia
-0000fd50: 7465 6c79 2077 6974 686f 7574 2060 736b  tely without `sk
-0000fd60: 7920 7374 6174 7573 202d 2d72 6566 7265  y status --refre
-0000fd70: 7368 6020 6669 7273 742c 2077 696c 6c20  sh` first, will 
-0000fd80: 6361 7573 6520 6120 6c65 616b 6167 650a  cause a leakage.
-0000fd90: 2020 2020 2320 6f66 2074 6865 2065 7869      # of the exi
-0000fda0: 7374 696e 6720 636c 7573 7465 722e 2057  sting cluster. W
-0000fdb0: 6520 6465 656d 2074 6869 7320 616e 2061  e deem this an a
-0000fdc0: 6363 6570 7461 626c 6520 7472 6164 656f  cceptable tradeo
-0000fdd0: 6666 206d 6169 6e6c 790a 2020 2020 2320  ff mainly.    # 
-0000fde0: 6265 6361 7573 6520 6d75 6c74 692d 6964  because multi-id
-0000fdf0: 656e 7469 7479 2069 7320 6e6f 7420 636f  entity is not co
-0000fe00: 6d6d 6f6e 2028 6174 206c 6561 7374 2061  mmon (at least a
-0000fe10: 7420 7468 6520 6d6f 6d65 6e74 292e 0a20  t the moment).. 
-0000fe20: 2020 2069 6620 6f77 6e65 725f 6964 656e     if owner_iden
-0000fe30: 7469 7479 2069 7320 4e6f 6e65 3a0a 2020  tity is None:.  
-0000fe40: 2020 2020 2020 676c 6f62 616c 5f75 7365        global_use
-0000fe50: 725f 7374 6174 652e 7365 745f 6f77 6e65  r_state.set_owne
-0000fe60: 725f 6964 656e 7469 7479 5f66 6f72 5f63  r_identity_for_c
-0000fe70: 6c75 7374 6572 280a 2020 2020 2020 2020  luster(.        
-0000fe80: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
-0000fe90: 2c20 6375 7272 656e 745f 7573 6572 5f69  , current_user_i
-0000fea0: 6465 6e74 6974 7929 0a20 2020 2065 6c73  dentity).    els
-0000feb0: 653a 0a20 2020 2020 2020 2061 7373 6572  e:.        asser
-0000fec0: 7420 6973 696e 7374 616e 6365 286f 776e  t isinstance(own
-0000fed0: 6572 5f69 6465 6e74 6974 792c 206c 6973  er_identity, lis
-0000fee0: 7429 0a20 2020 2020 2020 2023 2049 7420  t).        # It 
-0000fef0: 6973 204f 4b20 6966 2074 6865 206f 776e  is OK if the own
-0000ff00: 6572 2069 6465 6e74 6974 7920 6973 2073  er identity is s
-0000ff10: 686f 7274 6572 2c20 7768 6963 6820 7769  horter, which wi
-0000ff20: 6c6c 2068 6170 7065 6e20 7768 656e 0a20  ll happen when. 
-0000ff30: 2020 2020 2020 2023 2074 6865 2063 6c75         # the clu
-0000ff40: 7374 6572 2069 7320 6c61 756e 6368 6564  ster is launched
-0000ff50: 2062 6566 6f72 6520 2331 3830 382e 2049   before #1808. I
-0000ff60: 6e20 7468 6174 2063 6173 652c 2077 6520  n that case, we 
-0000ff70: 6f6e 6c79 2063 6865 636b 0a20 2020 2020  only check.     
-0000ff80: 2020 2023 2074 6865 2073 616d 6520 6c65     # the same le
-0000ff90: 6e67 7468 2028 7a69 7020 7769 6c6c 2073  ngth (zip will s
-0000ffa0: 746f 7020 6174 2074 6865 2073 686f 7274  top at the short
-0000ffb0: 6572 206f 6e65 292e 0a20 2020 2020 2020  er one)..       
-0000ffc0: 2066 6f72 2069 2c20 286f 776e 6572 2c0a   for i, (owner,.
-0000ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ffe0: 6375 7272 656e 7429 2069 6e20 656e 756d  current) in enum
-0000fff0: 6572 6174 6528 7a69 7028 6f77 6e65 725f  erate(zip(owner_
-00010000: 6964 656e 7469 7479 2c0a 2020 2020 2020  identity,.      
+0000f860: 2020 2020 2020 2020 2020 2020 274e 6574              'Net
+0000f870: 776f 726b 2073 6565 6d73 2064 6f77 6e2e  work seems down.
+0000f880: 2729 2066 726f 6d20 650a 0a0a 6465 6620  ') from e...def 
+0000f890: 6368 6563 6b5f 6f77 6e65 725f 6964 656e  check_owner_iden
+0000f8a0: 7469 7479 2863 6c75 7374 6572 5f6e 616d  tity(cluster_nam
+0000f8b0: 653a 2073 7472 2920 2d3e 204e 6f6e 653a  e: str) -> None:
+0000f8c0: 0a20 2020 2022 2222 4368 6563 6b20 6966  .    """Check if
+0000f8d0: 2063 7572 7265 6e74 2075 7365 7220 6973   current user is
+0000f8e0: 2074 6865 2073 616d 6520 6173 2074 6865   the same as the
+0000f8f0: 2075 7365 7220 7768 6f20 6372 6561 7465   user who create
+0000f900: 6420 7468 6520 636c 7573 7465 722e 0a0a  d the cluster...
+0000f910: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+0000f920: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
+0000f930: 6c75 7374 6572 4f77 6e65 7249 6465 6e74  lusterOwnerIdent
+0000f940: 6974 794d 6973 6d61 7463 6845 7272 6f72  ityMismatchError
+0000f950: 3a20 6966 2074 6865 2063 7572 7265 6e74  : if the current
+0000f960: 2075 7365 7220 6973 0a20 2020 2020 2020   user is.       
+0000f970: 2020 206e 6f74 2074 6865 2073 616d 6520     not the same 
+0000f980: 6173 2074 6865 2075 7365 7220 7768 6f20  as the user who 
+0000f990: 6372 6561 7465 6420 7468 6520 636c 7573  created the clus
+0000f9a0: 7465 722e 0a20 2020 2020 2020 2065 7863  ter..        exc
+0000f9b0: 6570 7469 6f6e 732e 436c 6f75 6455 7365  eptions.CloudUse
+0000f9c0: 7249 6465 6e74 6974 7945 7272 6f72 3a20  rIdentityError: 
+0000f9d0: 6966 2077 6520 6661 696c 2074 6f20 6765  if we fail to ge
+0000f9e0: 7420 7468 6520 6375 7272 656e 7420 7573  t the current us
+0000f9f0: 6572 0a20 2020 2020 2020 2020 2069 6465  er.          ide
+0000fa00: 6e74 6974 792e 0a20 2020 2022 2222 0a20  ntity..    """. 
+0000fa10: 2020 2069 6620 656e 765f 6f70 7469 6f6e     if env_option
+0000fa20: 732e 4f70 7469 6f6e 732e 534b 4950 5f43  s.Options.SKIP_C
+0000fa30: 4c4f 5544 5f49 4445 4e54 4954 595f 4348  LOUD_IDENTITY_CH
+0000fa40: 4543 4b2e 6765 7428 293a 0a20 2020 2020  ECK.get():.     
+0000fa50: 2020 2072 6574 7572 6e0a 2020 2020 7265     return.    re
+0000fa60: 636f 7264 203d 2067 6c6f 6261 6c5f 7573  cord = global_us
+0000fa70: 6572 5f73 7461 7465 2e67 6574 5f63 6c75  er_state.get_clu
+0000fa80: 7374 6572 5f66 726f 6d5f 6e61 6d65 2863  ster_from_name(c
+0000fa90: 6c75 7374 6572 5f6e 616d 6529 0a20 2020  luster_name).   
+0000faa0: 2069 6620 7265 636f 7264 2069 7320 4e6f   if record is No
+0000fab0: 6e65 3a0a 2020 2020 2020 2020 7265 7475  ne:.        retu
+0000fac0: 726e 0a20 2020 2068 616e 646c 6520 3d20  rn.    handle = 
+0000fad0: 7265 636f 7264 5b27 6861 6e64 6c65 275d  record['handle']
+0000fae0: 0a20 2020 2069 6620 6e6f 7420 6973 696e  .    if not isin
+0000faf0: 7374 616e 6365 2868 616e 646c 652c 2062  stance(handle, b
+0000fb00: 6163 6b65 6e64 732e 436c 6f75 6456 6d52  ackends.CloudVmR
+0000fb10: 6179 5265 736f 7572 6365 4861 6e64 6c65  ayResourceHandle
+0000fb20: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+0000fb30: 6e0a 0a20 2020 2063 6c6f 7564 203d 2068  n..    cloud = h
+0000fb40: 616e 646c 652e 6c61 756e 6368 6564 5f72  andle.launched_r
+0000fb50: 6573 6f75 7263 6573 2e63 6c6f 7564 0a20  esources.cloud. 
+0000fb60: 2020 2063 7572 7265 6e74 5f75 7365 725f     current_user_
+0000fb70: 6964 656e 7469 7479 203d 2063 6c6f 7564  identity = cloud
+0000fb80: 2e67 6574 5f63 7572 7265 6e74 5f75 7365  .get_current_use
+0000fb90: 725f 6964 656e 7469 7479 2829 0a20 2020  r_identity().   
+0000fba0: 206f 776e 6572 5f69 6465 6e74 6974 7920   owner_identity 
+0000fbb0: 3d20 7265 636f 7264 5b27 6f77 6e65 7227  = record['owner'
+0000fbc0: 5d0a 2020 2020 6966 2063 7572 7265 6e74  ].    if current
+0000fbd0: 5f75 7365 725f 6964 656e 7469 7479 2069  _user_identity i
+0000fbe0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000fbf0: 2320 536b 6970 2074 6865 2063 6865 636b  # Skip the check
+0000fc00: 2069 6620 7468 6520 636c 6f75 6420 646f   if the cloud do
+0000fc10: 6573 206e 6f74 2073 7570 706f 7274 2075  es not support u
+0000fc20: 7365 7220 6964 656e 7469 7479 2e0a 2020  ser identity..  
+0000fc30: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0000fc40: 2023 2054 6865 2075 7365 7220 6964 656e   # The user iden
+0000fc50: 7469 7479 2063 616e 2062 6520 4e6f 6e65  tity can be None
+0000fc60: 2c20 6966 2074 6865 2063 6c75 7374 6572  , if the cluster
+0000fc70: 2069 7320 6372 6561 7465 6420 6279 2061   is created by a
+0000fc80: 6e20 6f6c 6465 720a 2020 2020 2320 7665  n older.    # ve
+0000fc90: 7273 696f 6e20 6f66 2053 6b79 5069 6c6f  rsion of SkyPilo
+0000fca0: 742e 2049 6e20 7468 6174 2063 6173 652c  t. In that case,
+0000fcb0: 2077 6520 7365 7420 7468 6520 7573 6572   we set the user
+0000fcc0: 2069 6465 6e74 6974 7920 746f 2074 6865   identity to the
+0000fcd0: 0a20 2020 2023 2063 7572 7265 6e74 206f  .    # current o
+0000fce0: 6e65 2e0a 2020 2020 2320 4e4f 5445 3a20  ne..    # NOTE: 
+0000fcf0: 6120 7573 6572 2077 686f 2075 7067 7261  a user who upgra
+0000fd00: 6465 7320 536b 7950 696c 6f74 2061 6e64  des SkyPilot and
+0000fd10: 2073 7769 7463 6865 7320 746f 2061 206e   switches to a n
+0000fd20: 6577 2063 6c6f 7564 2069 6465 6e74 6974  ew cloud identit
+0000fd30: 790a 2020 2020 2320 696d 6d65 6469 6174  y.    # immediat
+0000fd40: 656c 7920 7769 7468 6f75 7420 6073 6b79  ely without `sky
+0000fd50: 2073 7461 7475 7320 2d2d 7265 6672 6573   status --refres
+0000fd60: 6860 2066 6972 7374 2c20 7769 6c6c 2063  h` first, will c
+0000fd70: 6175 7365 2061 206c 6561 6b61 6765 0a20  ause a leakage. 
+0000fd80: 2020 2023 206f 6620 7468 6520 6578 6973     # of the exis
+0000fd90: 7469 6e67 2063 6c75 7374 6572 2e20 5765  ting cluster. We
+0000fda0: 2064 6565 6d20 7468 6973 2061 6e20 6163   deem this an ac
+0000fdb0: 6365 7074 6162 6c65 2074 7261 6465 6f66  ceptable tradeof
+0000fdc0: 6620 6d61 696e 6c79 0a20 2020 2023 2062  f mainly.    # b
+0000fdd0: 6563 6175 7365 206d 756c 7469 2d69 6465  ecause multi-ide
+0000fde0: 6e74 6974 7920 6973 206e 6f74 2063 6f6d  ntity is not com
+0000fdf0: 6d6f 6e20 2861 7420 6c65 6173 7420 6174  mon (at least at
+0000fe00: 2074 6865 206d 6f6d 656e 7429 2e0a 2020   the moment)..  
+0000fe10: 2020 6966 206f 776e 6572 5f69 6465 6e74    if owner_ident
+0000fe20: 6974 7920 6973 204e 6f6e 653a 0a20 2020  ity is None:.   
+0000fe30: 2020 2020 2067 6c6f 6261 6c5f 7573 6572       global_user
+0000fe40: 5f73 7461 7465 2e73 6574 5f6f 776e 6572  _state.set_owner
+0000fe50: 5f69 6465 6e74 6974 795f 666f 725f 636c  _identity_for_cl
+0000fe60: 7573 7465 7228 0a20 2020 2020 2020 2020  uster(.         
+0000fe70: 2020 2063 6c75 7374 6572 5f6e 616d 652c     cluster_name,
+0000fe80: 2063 7572 7265 6e74 5f75 7365 725f 6964   current_user_id
+0000fe90: 656e 7469 7479 290a 2020 2020 656c 7365  entity).    else
+0000fea0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+0000feb0: 2069 7369 6e73 7461 6e63 6528 6f77 6e65   isinstance(owne
+0000fec0: 725f 6964 656e 7469 7479 2c20 6c69 7374  r_identity, list
+0000fed0: 290a 2020 2020 2020 2020 2320 4974 2069  ).        # It i
+0000fee0: 7320 4f4b 2069 6620 7468 6520 6f77 6e65  s OK if the owne
+0000fef0: 7220 6964 656e 7469 7479 2069 7320 7368  r identity is sh
+0000ff00: 6f72 7465 722c 2077 6869 6368 2077 696c  orter, which wil
+0000ff10: 6c20 6861 7070 656e 2077 6865 6e0a 2020  l happen when.  
+0000ff20: 2020 2020 2020 2320 7468 6520 636c 7573        # the clus
+0000ff30: 7465 7220 6973 206c 6175 6e63 6865 6420  ter is launched 
+0000ff40: 6265 666f 7265 2023 3138 3038 2e20 496e  before #1808. In
+0000ff50: 2074 6861 7420 6361 7365 2c20 7765 206f   that case, we o
+0000ff60: 6e6c 7920 6368 6563 6b0a 2020 2020 2020  nly check.      
+0000ff70: 2020 2320 7468 6520 7361 6d65 206c 656e    # the same len
+0000ff80: 6774 6820 287a 6970 2077 696c 6c20 7374  gth (zip will st
+0000ff90: 6f70 2061 7420 7468 6520 7368 6f72 7465  op at the shorte
+0000ffa0: 7220 6f6e 6529 2e0a 2020 2020 2020 2020  r one)..        
+0000ffb0: 666f 7220 692c 2028 6f77 6e65 722c 0a20  for i, (owner,. 
+0000ffc0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000ffd0: 7572 7265 6e74 2920 696e 2065 6e75 6d65  urrent) in enume
+0000ffe0: 7261 7465 287a 6970 286f 776e 6572 5f69  rate(zip(owner_i
+0000fff0: 6465 6e74 6974 792c 0a20 2020 2020 2020  dentity,.       
+00010000: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00010010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010030: 2020 2020 6375 7272 656e 745f 7573 6572      current_user
-00010040: 5f69 6465 6e74 6974 7929 293a 0a20 2020  _identity)):.   
-00010050: 2020 2020 2020 2020 2023 2043 6c65 616e           # Clean
-00010060: 2075 7020 7468 6520 6f77 6e65 7220 6964   up the owner id
-00010070: 656e 7469 7920 666f 7220 7468 6520 6261  entiy for the ba
-00010080: 636b 736c 6173 6820 616e 6420 6e65 776c  ckslash and newl
-00010090: 696e 6573 2c20 6361 7573 6564 0a20 2020  ines, caused.   
-000100a0: 2020 2020 2020 2020 2023 2062 7920 7468           # by th
-000100b0: 6520 636c 6f75 6420 434c 4920 6f75 7470  e cloud CLI outp
-000100c0: 7574 2c20 652e 672e 2067 636c 6f75 642e  ut, e.g. gcloud.
-000100d0: 0a20 2020 2020 2020 2020 2020 206f 776e  .            own
-000100e0: 6572 203d 206f 776e 6572 2e72 6570 6c61  er = owner.repla
-000100f0: 6365 2827 5c6e 272c 2027 2729 2e72 6570  ce('\n', '').rep
-00010100: 6c61 6365 2827 5c5c 272c 2027 2729 0a20  lace('\\', ''). 
-00010110: 2020 2020 2020 2020 2020 2069 6620 6f77             if ow
-00010120: 6e65 7220 3d3d 2063 7572 7265 6e74 3a0a  ner == current:.
-00010130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010140: 6966 2069 2021 3d20 303a 0a20 2020 2020  if i != 0:.     
-00010150: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00010160: 6f67 6765 722e 7761 726e 696e 6728 0a20  ogger.warning(. 
-00010170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010180: 2020 2020 2020 2066 2754 6865 2063 6c75         f'The clu
-00010190: 7374 6572 2077 6173 206f 776e 6564 2062  ster was owned b
-000101a0: 7920 7b6f 776e 6572 5f69 6465 6e74 6974  y {owner_identit
-000101b0: 797d 2c20 6275 7420 270a 2020 2020 2020  y}, but '.      
-000101c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101d0: 2020 6627 6120 6e65 7720 6964 656e 7469    f'a new identi
-000101e0: 7479 207b 6375 7272 656e 745f 7573 6572  ty {current_user
-000101f0: 5f69 6465 6e74 6974 797d 2069 7320 6163  _identity} is ac
-00010200: 7469 7661 7465 642e 2057 6520 7374 696c  tivated. We stil
-00010210: 6c20 270a 2020 2020 2020 2020 2020 2020  l '.            
-00010220: 2020 2020 2020 2020 2020 2020 2761 6c6c              'all
-00010230: 6f77 2074 6865 206f 7065 7261 7469 6f6e  ow the operation
-00010240: 2061 7320 7468 6520 7477 6f20 6964 656e   as the two iden
-00010250: 7469 7469 6573 2061 7265 206c 696b 656c  tities are likel
-00010260: 7920 746f 2068 6176 6520 270a 2020 2020  y to have '.    
-00010270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010280: 2020 2020 2774 6865 2073 616d 6520 6163      'the same ac
-00010290: 6365 7373 2074 6f20 7468 6520 636c 7573  cess to the clus
-000102a0: 7465 722e 2050 6c65 6173 6520 6265 2061  ter. Please be a
-000102b0: 7761 7265 2074 6861 7420 7468 6973 2063  ware that this c
-000102c0: 616e 2027 0a20 2020 2020 2020 2020 2020  an '.           
-000102d0: 2020 2020 2020 2020 2020 2020 2027 6361               'ca
-000102e0: 7573 6520 756e 6578 7065 6374 6564 2063  use unexpected c
-000102f0: 6c75 7374 6572 206c 6561 6b61 6765 2069  luster leakage i
-00010300: 6620 7468 6520 7477 6f20 6964 656e 7469  f the two identi
-00010310: 7469 6573 2061 7265 206e 6f74 2027 0a20  ties are not '. 
-00010320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010330: 2020 2020 2020 2027 6163 7475 616c 6c79         'actually
-00010340: 2065 7175 6976 616c 656e 7420 2865 2e67   equivalent (e.g
-00010350: 2e2c 2062 656c 6f6e 6720 746f 2074 6865  ., belong to the
-00010360: 2073 616d 6520 7065 7273 6f6e 292e 270a   same person).'.
-00010370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010380: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00010390: 2020 2020 2020 6966 2069 2021 3d20 3020        if i != 0 
-000103a0: 6f72 206c 656e 286f 776e 6572 5f69 6465  or len(owner_ide
-000103b0: 6e74 6974 7929 2021 3d20 6c65 6e28 6375  ntity) != len(cu
-000103c0: 7272 656e 745f 7573 6572 5f69 6465 6e74  rrent_user_ident
-000103d0: 6974 7929 3a0a 2020 2020 2020 2020 2020  ity):.          
-000103e0: 2020 2020 2020 2020 2020 2320 5765 2075            # We u
-000103f0: 7064 6174 6520 7468 6520 6f77 6e65 7220  pdate the owner 
-00010400: 6f66 2061 2063 6c75 7374 6572 2c20 7768  of a cluster, wh
-00010410: 656e 3a0a 2020 2020 2020 2020 2020 2020  en:.            
-00010420: 2020 2020 2020 2020 2320 312e 2054 6865          # 1. The
-00010430: 2073 7472 6963 7465 7374 2069 6465 6e74   strictest ident
-00010440: 7479 2028 692e 652e 2074 6865 2066 6972  ty (i.e. the fir
-00010450: 7374 206f 6e65 2920 646f 6573 206e 6f74  st one) does not
-00010460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010470: 2020 2020 2023 206d 6174 6368 2c20 6275       # match, bu
-00010480: 7420 7468 6520 6c61 7474 6572 206f 6e65  t the latter one
-00010490: 7320 6d61 7463 682e 0a20 2020 2020 2020  s match..       
-000104a0: 2020 2020 2020 2020 2020 2020 2023 2032               # 2
-000104b0: 2e20 5468 6520 6c65 6e67 7468 206f 6620  . The length of 
-000104c0: 7468 6520 7477 6f20 6964 656e 7469 7469  the two identiti
-000104d0: 6573 2061 7265 2064 6966 6665 7265 6e74  es are different
-000104e0: 2c20 7768 6963 680a 2020 2020 2020 2020  , which.        
-000104f0: 2020 2020 2020 2020 2020 2020 2320 7769              # wi
-00010500: 6c6c 206f 6e6c 7920 6861 7070 656e 2077  ll only happen w
-00010510: 6865 6e20 7468 6520 636c 7573 7465 7220  hen the cluster 
-00010520: 6973 206c 6175 6e63 6865 6420 6265 666f  is launched befo
-00010530: 7265 2023 3138 3038 2e0a 2020 2020 2020  re #1808..      
-00010540: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00010550: 5570 6461 7465 2074 6865 2075 7365 7220  Update the user 
-00010560: 6964 656e 7469 7479 2074 6f20 6176 6f69  identity to avoi
-00010570: 6420 7368 6f77 696e 6720 7468 6520 7761  d showing the wa
-00010580: 726e 696e 6720 6162 6f76 650a 2020 2020  rning above.    
-00010590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105a0: 2320 6167 6169 6e2e 0a20 2020 2020 2020  # again..       
-000105b0: 2020 2020 2020 2020 2020 2020 2067 6c6f               glo
-000105c0: 6261 6c5f 7573 6572 5f73 7461 7465 2e73  bal_user_state.s
-000105d0: 6574 5f6f 776e 6572 5f69 6465 6e74 6974  et_owner_identit
-000105e0: 795f 666f 725f 636c 7573 7465 7228 0a20  y_for_cluster(. 
-000105f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010600: 2020 2020 2020 2063 6c75 7374 6572 5f6e         cluster_n
-00010610: 616d 652c 2063 7572 7265 6e74 5f75 7365  ame, current_use
-00010620: 725f 6964 656e 7469 7479 290a 2020 2020  r_identity).    
-00010630: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00010640: 726e 2020 2320 5468 6520 7573 6572 2069  rn  # The user i
-00010650: 6465 6e74 6974 7920 6d61 7463 6865 732e  dentity matches.
-00010660: 0a20 2020 2020 2020 2077 6974 6820 7578  .        with ux
-00010670: 5f75 7469 6c73 2e70 7269 6e74 5f65 7863  _utils.print_exc
-00010680: 6570 7469 6f6e 5f6e 6f5f 7472 6163 6562  eption_no_traceb
-00010690: 6163 6b28 293a 0a20 2020 2020 2020 2020  ack():.         
-000106a0: 2020 2072 6169 7365 2065 7863 6570 7469     raise excepti
-000106b0: 6f6e 732e 436c 7573 7465 724f 776e 6572  ons.ClusterOwner
-000106c0: 4964 656e 7469 7479 4d69 736d 6174 6368  IdentityMismatch
-000106d0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-000106e0: 2020 2020 2020 2066 277b 636c 7573 7465         f'{cluste
-000106f0: 725f 6e61 6d65 2172 7d20 287b 636c 6f75  r_name!r} ({clou
-00010700: 647d 2920 6973 206f 776e 6564 2062 7920  d}) is owned by 
-00010710: 6163 636f 756e 7420 270a 2020 2020 2020  account '.      
-00010720: 2020 2020 2020 2020 2020 6627 7b6f 776e            f'{own
-00010730: 6572 5f69 6465 6e74 6974 7921 727d 2c20  er_identity!r}, 
-00010740: 6275 7420 7468 6520 6163 7469 7661 7465  but the activate
-00010750: 6420 6163 636f 756e 7420 270a 2020 2020  d account '.    
-00010760: 2020 2020 2020 2020 2020 2020 6627 6973              f'is
-00010770: 207b 6375 7272 656e 745f 7573 6572 5f69   {current_user_i
-00010780: 6465 6e74 6974 7921 727d 2e27 290a 0a0a  dentity!r}.')...
-00010790: 6465 6620 7461 675f 6669 6c74 6572 5f66  def tag_filter_f
-000107a0: 6f72 5f63 6c75 7374 6572 2863 6c75 7374  or_cluster(clust
-000107b0: 6572 5f6e 616d 653a 2073 7472 2920 2d3e  er_name: str) ->
-000107c0: 2044 6963 745b 7374 722c 2073 7472 5d3a   Dict[str, str]:
-000107d0: 0a20 2020 2022 2222 5265 7475 726e 7320  .    """Returns 
-000107e0: 6120 7461 6720 6669 6c74 6572 2066 6f72  a tag filter for
-000107f0: 2074 6865 2063 6c75 7374 6572 2e22 2222   the cluster."""
-00010800: 0a20 2020 2072 6574 7572 6e20 7b0a 2020  .    return {.  
-00010810: 2020 2020 2020 2772 6179 2d63 6c75 7374        'ray-clust
-00010820: 6572 2d6e 616d 6527 3a20 636c 7573 7465  er-name': cluste
-00010830: 725f 6e61 6d65 2c0a 2020 2020 7d0a 0a0a  r_name,.    }...
-00010840: 6465 6620 5f71 7565 7279 5f63 6c75 7374  def _query_clust
-00010850: 6572 5f73 7461 7475 735f 7669 615f 636c  er_status_via_cl
-00010860: 6f75 645f 6170 6928 0a20 2020 2068 616e  oud_api(.    han
-00010870: 646c 653a 2027 636c 6f75 645f 766d 5f72  dle: 'cloud_vm_r
-00010880: 6179 5f62 6163 6b65 6e64 2e43 6c6f 7564  ay_backend.Cloud
-00010890: 566d 5261 7952 6573 6f75 7263 6548 616e  VmRayResourceHan
-000108a0: 646c 6527 0a29 202d 3e20 4c69 7374 5b73  dle'.) -> List[s
-000108b0: 7461 7475 735f 6c69 622e 436c 7573 7465  tatus_lib.Cluste
-000108c0: 7253 7461 7475 735d 3a0a 2020 2020 2222  rStatus]:.    ""
-000108d0: 2252 6574 7572 6e73 2074 6865 2073 7461  "Returns the sta
-000108e0: 7475 7320 6f66 2074 6865 2063 6c75 7374  tus of the clust
-000108f0: 6572 2e0a 0a20 2020 2052 6169 7365 733a  er...    Raises:
-00010900: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
-00010910: 6f6e 732e 436c 7573 7465 7253 7461 7475  ons.ClusterStatu
-00010920: 7346 6574 6368 696e 6745 7272 6f72 3a20  sFetchingError: 
-00010930: 7468 6520 636c 7573 7465 7220 7374 6174  the cluster stat
-00010940: 7573 2063 616e 6e6f 7420 6265 0a20 2020  us cannot be.   
-00010950: 2020 2020 2020 2066 6574 6368 6564 2066         fetched f
-00010960: 726f 6d20 7468 6520 636c 6f75 6420 7072  rom the cloud pr
-00010970: 6f76 6964 6572 2e0a 2020 2020 2222 220a  ovider..    """.
-00010980: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
-00010990: 5f6f 6e5f 636c 6f75 6420 3d20 6861 6e64  _on_cloud = hand
-000109a0: 6c65 2e63 6c75 7374 6572 5f6e 616d 655f  le.cluster_name_
-000109b0: 6f6e 5f63 6c6f 7564 0a20 2020 2063 6c75  on_cloud.    clu
-000109c0: 7374 6572 5f6e 616d 655f 696e 5f68 696e  ster_name_in_hin
-000109d0: 7420 3d20 636f 6d6d 6f6e 5f75 7469 6c73  t = common_utils
-000109e0: 2e63 6c75 7374 6572 5f6e 616d 655f 696e  .cluster_name_in
-000109f0: 5f68 696e 7428 0a20 2020 2020 2020 2068  _hint(.        h
-00010a00: 616e 646c 652e 636c 7573 7465 725f 6e61  andle.cluster_na
-00010a10: 6d65 2c20 636c 7573 7465 725f 6e61 6d65  me, cluster_name
-00010a20: 5f6f 6e5f 636c 6f75 6429 0a20 2020 2023  _on_cloud).    #
-00010a30: 2055 7365 2072 6567 696f 6e20 616e 6420   Use region and 
-00010a40: 7a6f 6e65 2066 726f 6d20 7468 6520 636c  zone from the cl
-00010a50: 7573 7465 7220 636f 6e66 6967 2c20 696e  uster config, in
-00010a60: 7374 6561 6420 6f66 2074 6865 0a20 2020  stead of the.   
-00010a70: 2023 2068 616e 646c 652e 6c61 756e 6368   # handle.launch
-00010a80: 6564 5f72 6573 6f75 7263 6573 2c20 6265  ed_resources, be
-00010a90: 6361 7573 6520 7468 6520 6c61 7474 6572  cause the latter
-00010aa0: 206d 6179 206e 6f74 2062 6520 7365 740a   may not be set.
-00010ab0: 2020 2020 2320 636f 7272 6563 746c 7920      # correctly 
-00010ac0: 7965 742e 0a20 2020 2072 6179 5f63 6f6e  yet..    ray_con
-00010ad0: 6669 6720 3d20 636f 6d6d 6f6e 5f75 7469  fig = common_uti
-00010ae0: 6c73 2e72 6561 645f 7961 6d6c 2868 616e  ls.read_yaml(han
-00010af0: 646c 652e 636c 7573 7465 725f 7961 6d6c  dle.cluster_yaml
-00010b00: 290a 2020 2020 7072 6f76 6964 6572 5f63  ).    provider_c
-00010b10: 6f6e 6669 6720 3d20 7261 795f 636f 6e66  onfig = ray_conf
-00010b20: 6967 5b27 7072 6f76 6964 6572 275d 0a0a  ig['provider']..
-00010b30: 2020 2020 2320 5175 6572 7920 7468 6520      # Query the 
-00010b40: 636c 6f75 6420 7072 6f76 6964 6572 2e0a  cloud provider..
-00010b50: 2020 2020 2320 544f 444f 2873 7571 7561      # TODO(suqua
-00010b60: 726b 293a 206d 6f76 6520 696d 706c 656d  rk): move implem
-00010b70: 656e 7461 7469 6f6e 7320 6f66 206d 6f72  entations of mor
-00010b80: 6520 636c 6f75 6473 2068 6572 650a 2020  e clouds here.  
-00010b90: 2020 636c 6f75 6420 3d20 6861 6e64 6c65    cloud = handle
-00010ba0: 2e6c 6175 6e63 6865 645f 7265 736f 7572  .launched_resour
-00010bb0: 6365 732e 636c 6f75 640a 2020 2020 6173  ces.cloud.    as
-00010bc0: 7365 7274 2063 6c6f 7564 2069 7320 6e6f  sert cloud is no
-00010bd0: 7420 4e6f 6e65 2c20 6861 6e64 6c65 0a20  t None, handle. 
-00010be0: 2020 2069 6620 636c 6f75 642e 5354 4154     if cloud.STAT
-00010bf0: 5553 5f56 4552 5349 4f4e 203e 3d20 636c  US_VERSION >= cl
-00010c00: 6f75 6473 2e53 7461 7475 7356 6572 7369  ouds.StatusVersi
-00010c10: 6f6e 2e53 4b59 5049 4c4f 543a 0a20 2020  on.SKYPILOT:.   
-00010c20: 2020 2020 2063 6c6f 7564 5f6e 616d 6520       cloud_name 
-00010c30: 3d20 7265 7072 2868 616e 646c 652e 6c61  = repr(handle.la
-00010c40: 756e 6368 6564 5f72 6573 6f75 7263 6573  unched_resources
-00010c50: 2e63 6c6f 7564 290a 2020 2020 2020 2020  .cloud).        
-00010c60: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00010c70: 206e 6f64 655f 7374 6174 7573 5f64 6963   node_status_dic
-00010c80: 7420 3d20 7072 6f76 6973 696f 6e5f 6c69  t = provision_li
-00010c90: 622e 7175 6572 795f 696e 7374 616e 6365  b.query_instance
-00010ca0: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00010cb0: 2020 2063 6c6f 7564 5f6e 616d 652c 2063     cloud_name, c
-00010cc0: 6c75 7374 6572 5f6e 616d 655f 6f6e 5f63  luster_name_on_c
-00010cd0: 6c6f 7564 2c20 7072 6f76 6964 6572 5f63  loud, provider_c
-00010ce0: 6f6e 6669 6729 0a20 2020 2020 2020 2020  onfig).         
-00010cf0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-00010d00: 6627 5175 6572 7969 6e67 207b 636c 6f75  f'Querying {clou
-00010d10: 645f 6e61 6d65 7d20 636c 7573 7465 7220  d_name} cluster 
-00010d20: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00010d30: 2020 2020 2020 2020 2020 2066 277b 636c             f'{cl
-00010d40: 7573 7465 725f 6e61 6d65 5f69 6e5f 6869  uster_name_in_hi
-00010d50: 6e74 7d20 270a 2020 2020 2020 2020 2020  nt} '.          
-00010d60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00010d70: 2773 7461 7475 733a 5c6e 7b70 7072 696e  'status:\n{pprin
-00010d80: 742e 7066 6f72 6d61 7428 6e6f 6465 5f73  t.pformat(node_s
-00010d90: 7461 7475 735f 6469 6374 297d 2729 0a20  tatus_dict)}'). 
-00010da0: 2020 2020 2020 2020 2020 206e 6f64 655f             node_
-00010db0: 7374 6174 7573 6573 203d 206c 6973 7428  statuses = list(
-00010dc0: 6e6f 6465 5f73 7461 7475 735f 6469 6374  node_status_dict
-00010dd0: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
-00010de0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00010df0: 696f 6e20 6173 2065 3a20 2023 2070 796c  ion as e:  # pyl
-00010e00: 696e 743a 2064 6973 6162 6c65 3d62 726f  int: disable=bro
-00010e10: 6164 2d65 7863 6570 740a 2020 2020 2020  ad-except.      
-00010e20: 2020 2020 2020 7769 7468 2075 785f 7574        with ux_ut
-00010e30: 696c 732e 7072 696e 745f 6578 6365 7074  ils.print_except
-00010e40: 696f 6e5f 6e6f 5f74 7261 6365 6261 636b  ion_no_traceback
-00010e50: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00010e60: 2020 2020 7261 6973 6520 6578 6365 7074      raise except
-00010e70: 696f 6e73 2e43 6c75 7374 6572 5374 6174  ions.ClusterStat
-00010e80: 7573 4665 7463 6869 6e67 4572 726f 7228  usFetchingError(
-00010e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010ea0: 2020 2020 2066 2746 6169 6c65 6420 746f       f'Failed to
-00010eb0: 2071 7565 7279 207b 636c 6f75 645f 6e61   query {cloud_na
-00010ec0: 6d65 7d20 636c 7573 7465 7220 270a 2020  me} cluster '.  
-00010ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ee0: 2020 6627 7b63 6c75 7374 6572 5f6e 616d    f'{cluster_nam
-00010ef0: 655f 696e 5f68 696e 747d 2027 0a20 2020  e_in_hint} '.   
-00010f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f10: 2066 2773 7461 7475 733a 207b 636f 6d6d   f'status: {comm
-00010f20: 6f6e 5f75 7469 6c73 2e66 6f72 6d61 745f  on_utils.format_
-00010f30: 6578 6365 7074 696f 6e28 652c 2075 7365  exception(e, use
-00010f40: 5f62 7261 636b 6574 3d54 7275 6529 7d27  _bracket=True)}'
-00010f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010f60: 2029 0a20 2020 2065 6c73 653a 0a20 2020   ).    else:.   
-00010f70: 2020 2020 2072 6567 696f 6e20 3d20 7072       region = pr
-00010f80: 6f76 6964 6572 5f63 6f6e 6669 672e 6765  ovider_config.ge
-00010f90: 7428 2772 6567 696f 6e27 2920 6f72 2070  t('region') or p
-00010fa0: 726f 7669 6465 725f 636f 6e66 6967 2e67  rovider_config.g
-00010fb0: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
-00010fc0: 276c 6f63 6174 696f 6e27 290a 2020 2020  'location').    
-00010fd0: 2020 2020 7a6f 6e65 203d 2072 6179 5f63      zone = ray_c
-00010fe0: 6f6e 6669 675b 2770 726f 7669 6465 7227  onfig['provider'
-00010ff0: 5d2e 6765 7428 2761 7661 696c 6162 696c  ].get('availabil
-00011000: 6974 795f 7a6f 6e65 2729 0a20 2020 2020  ity_zone').     
-00011010: 2020 206e 6f64 655f 7374 6174 7573 6573     node_statuses
-00011020: 203d 2063 6c6f 7564 2e71 7565 7279 5f73   = cloud.query_s
-00011030: 7461 7475 7328 0a20 2020 2020 2020 2020  tatus(.         
-00011040: 2020 2063 6c75 7374 6572 5f6e 616d 655f     cluster_name_
-00011050: 6f6e 5f63 6c6f 7564 2c0a 2020 2020 2020  on_cloud,.      
-00011060: 2020 2020 2020 7461 675f 6669 6c74 6572        tag_filter
-00011070: 5f66 6f72 5f63 6c75 7374 6572 2863 6c75  _for_cluster(clu
-00011080: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
-00011090: 7564 292c 2072 6567 696f 6e2c 207a 6f6e  ud), region, zon
-000110a0: 6529 0a20 2020 2072 6574 7572 6e20 6e6f  e).    return no
-000110b0: 6465 5f73 7461 7475 7365 730a 0a0a 6465  de_statuses...de
-000110c0: 6620 6368 6563 6b5f 6361 6e5f 636c 6f6e  f check_can_clon
-000110d0: 655f 6469 736b 5f61 6e64 5f6f 7665 7272  e_disk_and_overr
-000110e0: 6964 655f 7461 736b 280a 2020 2020 636c  ide_task(.    cl
-000110f0: 7573 7465 725f 6e61 6d65 3a20 7374 722c  uster_name: str,
-00011100: 2074 6172 6765 745f 636c 7573 7465 725f   target_cluster_
-00011110: 6e61 6d65 3a20 4f70 7469 6f6e 616c 5b73  name: Optional[s
-00011120: 7472 5d2c 2074 6173 6b3a 2027 7461 736b  tr], task: 'task
-00011130: 5f6c 6962 2e54 6173 6b27 0a29 202d 3e20  _lib.Task'.) -> 
-00011140: 5475 706c 655b 2774 6173 6b5f 6c69 622e  Tuple['task_lib.
-00011150: 5461 736b 272c 2027 636c 6f75 645f 766d  Task', 'cloud_vm
-00011160: 5f72 6179 5f62 6163 6b65 6e64 2e43 6c6f  _ray_backend.Clo
-00011170: 7564 566d 5261 7952 6573 6f75 7263 6548  udVmRayResourceH
-00011180: 616e 646c 6527 5d3a 0a20 2020 2022 2222  andle']:.    """
-00011190: 4368 6563 6b20 6966 2074 6865 2074 6173  Check if the tas
-000111a0: 6b20 6973 2063 6f6d 7061 7469 626c 6520  k is compatible 
-000111b0: 746f 2063 6c6f 6e65 2064 6973 6b20 6672  to clone disk fr
-000111c0: 6f6d 2074 6865 2073 6f75 7263 6520 636c  om the source cl
-000111d0: 7573 7465 722e 0a0a 2020 2020 4172 6773  uster...    Args
-000111e0: 3a0a 2020 2020 2020 2020 636c 7573 7465  :.        cluste
-000111f0: 725f 6e61 6d65 3a20 5468 6520 6e61 6d65  r_name: The name
-00011200: 206f 6620 7468 6520 636c 7573 7465 7220   of the cluster 
-00011210: 746f 2063 6c6f 6e65 2064 6973 6b20 6672  to clone disk fr
-00011220: 6f6d 2e0a 2020 2020 2020 2020 7461 7267  om..        targ
-00011230: 6574 5f63 6c75 7374 6572 5f6e 616d 653a  et_cluster_name:
-00011240: 2054 6865 206e 616d 6520 6f66 2074 6865   The name of the
-00011250: 2074 6172 6765 7420 636c 7573 7465 722e   target cluster.
-00011260: 0a20 2020 2020 2020 2074 6173 6b3a 2054  .        task: T
-00011270: 6865 2074 6173 6b20 746f 2063 6865 636b  he task to check
-00011280: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-00011290: 2020 2020 2020 2020 5468 6520 7461 736b          The task
-000112a0: 2074 6f20 7573 6520 616e 6420 7468 6520   to use and the 
-000112b0: 7265 736f 7572 6365 2068 616e 646c 6520  resource handle 
-000112c0: 6f66 2074 6865 2073 6f75 7263 6520 636c  of the source cl
-000112d0: 7573 7465 722e 0a0a 2020 2020 5261 6973  uster...    Rais
-000112e0: 6573 3a0a 2020 2020 2020 2020 5661 6c75  es:.        Valu
-000112f0: 6545 7272 6f72 3a20 4966 2074 6865 2073  eError: If the s
-00011300: 6f75 7263 6520 636c 7573 7465 7220 646f  ource cluster do
-00011310: 6573 206e 6f74 2065 7869 7374 2e0a 2020  es not exist..  
-00011320: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
-00011330: 2e4e 6f74 5375 7070 6f72 7465 6445 7272  .NotSupportedErr
-00011340: 6f72 3a20 4966 2074 6865 2073 6f75 7263  or: If the sourc
-00011350: 6520 636c 7573 7465 7220 6973 206e 6f74  e cluster is not
-00011360: 2076 616c 6964 206f 7220 7468 650a 2020   valid or the.  
-00011370: 2020 2020 2020 2020 2020 7461 736b 2069            task i
-00011380: 7320 6e6f 7420 636f 6d70 6174 6962 6c65  s not compatible
-00011390: 2074 6f20 636c 6f6e 6520 6469 736b 2066   to clone disk f
-000113a0: 726f 6d20 7468 6520 736f 7572 6365 2063  rom the source c
-000113b0: 6c75 7374 6572 2e0a 2020 2020 2222 220a  luster..    """.
-000113c0: 2020 2020 736f 7572 6365 5f63 6c75 7374      source_clust
-000113d0: 6572 5f73 7461 7475 732c 2068 616e 646c  er_status, handl
-000113e0: 6520 3d20 7265 6672 6573 685f 636c 7573  e = refresh_clus
-000113f0: 7465 725f 7374 6174 7573 5f68 616e 646c  ter_status_handl
-00011400: 6528 636c 7573 7465 725f 6e61 6d65 290a  e(cluster_name).
-00011410: 2020 2020 6966 2073 6f75 7263 655f 636c      if source_cl
-00011420: 7573 7465 725f 7374 6174 7573 2069 7320  uster_status is 
-00011430: 4e6f 6e65 3a0a 2020 2020 2020 2020 7769  None:.        wi
-00011440: 7468 2075 785f 7574 696c 732e 7072 696e  th ux_utils.prin
-00011450: 745f 6578 6365 7074 696f 6e5f 6e6f 5f74  t_exception_no_t
-00011460: 7261 6365 6261 636b 2829 3a0a 2020 2020  raceback():.    
-00011470: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00011480: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
-00011490: 2020 2020 2020 2020 2020 6627 4361 6e6e            f'Cann
-000114a0: 6f74 2066 696e 6420 636c 7573 7465 7220  ot find cluster 
-000114b0: 7b63 6c75 7374 6572 5f6e 616d 6521 727d  {cluster_name!r}
-000114c0: 2074 6f20 636c 6f6e 6520 6469 736b 2066   to clone disk f
-000114d0: 726f 6d2e 2729 0a0a 2020 2020 6966 206e  rom.')..    if n
-000114e0: 6f74 2069 7369 6e73 7461 6e63 6528 6861  ot isinstance(ha
-000114f0: 6e64 6c65 2c20 6261 636b 656e 6473 2e43  ndle, backends.C
-00011500: 6c6f 7564 566d 5261 7952 6573 6f75 7263  loudVmRayResourc
-00011510: 6548 616e 646c 6529 3a0a 2020 2020 2020  eHandle):.      
-00011520: 2020 7769 7468 2075 785f 7574 696c 732e    with ux_utils.
-00011530: 7072 696e 745f 6578 6365 7074 696f 6e5f  print_exception_
-00011540: 6e6f 5f74 7261 6365 6261 636b 2829 3a0a  no_traceback():.
-00011550: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00011560: 6520 6578 6365 7074 696f 6e73 2e4e 6f74  e exceptions.Not
-00011570: 5375 7070 6f72 7465 6445 7272 6f72 280a  SupportedError(.
-00011580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011590: 6627 4361 6e6e 6f74 2063 6c6f 6e65 2064  f'Cannot clone d
-000115a0: 6973 6b20 6672 6f6d 2061 206e 6f6e 2d63  isk from a non-c
-000115b0: 6c6f 7564 2063 6c75 7374 6572 207b 636c  loud cluster {cl
-000115c0: 7573 7465 725f 6e61 6d65 2172 7d2e 2729  uster_name!r}.')
-000115d0: 0a0a 2020 2020 6966 2073 6f75 7263 655f  ..    if source_
-000115e0: 636c 7573 7465 725f 7374 6174 7573 2021  cluster_status !
-000115f0: 3d20 7374 6174 7573 5f6c 6962 2e43 6c75  = status_lib.Clu
-00011600: 7374 6572 5374 6174 7573 2e53 544f 5050  sterStatus.STOPP
-00011610: 4544 3a0a 2020 2020 2020 2020 7769 7468  ED:.        with
-00011620: 2075 785f 7574 696c 732e 7072 696e 745f   ux_utils.print_
-00011630: 6578 6365 7074 696f 6e5f 6e6f 5f74 7261  exception_no_tra
-00011640: 6365 6261 636b 2829 3a0a 2020 2020 2020  ceback():.      
-00011650: 2020 2020 2020 7261 6973 6520 6578 6365        raise exce
-00011660: 7074 696f 6e73 2e4e 6f74 5375 7070 6f72  ptions.NotSuppor
-00011670: 7465 6445 7272 6f72 280a 2020 2020 2020  tedError(.      
-00011680: 2020 2020 2020 2020 2020 6627 4361 6e6e            f'Cann
-00011690: 6f74 2063 6c6f 6e65 2064 6973 6b20 6672  ot clone disk fr
-000116a0: 6f6d 2063 6c75 7374 6572 207b 636c 7573  om cluster {clus
-000116b0: 7465 725f 6e61 6d65 2172 7d20 270a 2020  ter_name!r} '.  
-000116c0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-000116d0: 287b 736f 7572 6365 5f63 6c75 7374 6572  ({source_cluster
-000116e0: 5f73 7461 7475 7321 727d 292e 2050 6c65  _status!r}). Ple
-000116f0: 6173 6520 7374 6f70 2074 6865 2027 0a20  ase stop the '. 
-00011700: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00011710: 2763 6c75 7374 6572 2066 6972 7374 3a20  'cluster first: 
-00011720: 736b 7920 7374 6f70 207b 636c 7573 7465  sky stop {cluste
-00011730: 725f 6e61 6d65 7d27 290a 0a20 2020 2069  r_name}')..    i
-00011740: 6620 7461 7267 6574 5f63 6c75 7374 6572  f target_cluster
-00011750: 5f6e 616d 6520 6973 206e 6f74 204e 6f6e  _name is not Non
-00011760: 653a 0a20 2020 2020 2020 2074 6172 6765  e:.        targe
-00011770: 745f 636c 7573 7465 725f 7374 6174 7573  t_cluster_status
-00011780: 2c20 5f20 3d20 7265 6672 6573 685f 636c  , _ = refresh_cl
-00011790: 7573 7465 725f 7374 6174 7573 5f68 616e  uster_status_han
-000117a0: 646c 6528 0a20 2020 2020 2020 2020 2020  dle(.           
-000117b0: 2074 6172 6765 745f 636c 7573 7465 725f   target_cluster_
-000117c0: 6e61 6d65 290a 2020 2020 2020 2020 6966  name).        if
-000117d0: 2074 6172 6765 745f 636c 7573 7465 725f   target_cluster_
-000117e0: 7374 6174 7573 2069 7320 6e6f 7420 4e6f  status is not No
-000117f0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00011800: 7769 7468 2075 785f 7574 696c 732e 7072  with ux_utils.pr
-00011810: 696e 745f 6578 6365 7074 696f 6e5f 6e6f  int_exception_no
-00011820: 5f74 7261 6365 6261 636b 2829 3a0a 2020  _traceback():.  
-00011830: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00011840: 6973 6520 6578 6365 7074 696f 6e73 2e4e  ise exceptions.N
-00011850: 6f74 5375 7070 6f72 7465 6445 7272 6f72  otSupportedError
-00011860: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00011870: 2020 2020 2020 6627 5468 6520 7461 7267        f'The targ
-00011880: 6574 2063 6c75 7374 6572 207b 7461 7267  et cluster {targ
-00011890: 6574 5f63 6c75 7374 6572 5f6e 616d 6521  et_cluster_name!
-000118a0: 727d 2061 6c72 6561 6479 2065 7869 7374  r} already exist
-000118b0: 732e 2043 6c6f 6e69 6e67 2027 0a20 2020  s. Cloning '.   
-000118c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000118d0: 2027 6469 736b 2069 7320 6f6e 6c79 2073   'disk is only s
-000118e0: 7570 706f 7274 6564 2077 6865 6e20 6372  upported when cr
-000118f0: 6561 7469 6e67 2061 206e 6577 2063 6c75  eating a new clu
-00011900: 7374 6572 2e20 546f 2066 6978 3a20 7370  ster. To fix: sp
-00011910: 6563 6966 7920 270a 2020 2020 2020 2020  ecify '.        
-00011920: 2020 2020 2020 2020 2020 2020 2761 206e              'a n
-00011930: 6577 2074 6172 6765 7420 636c 7573 7465  ew target cluste
-00011940: 7220 6e61 6d65 2e27 290a 0a20 2020 206e  r name.')..    n
-00011950: 6577 5f74 6173 6b5f 7265 736f 7572 6365  ew_task_resource
-00011960: 7320 3d20 5b5d 0a20 2020 206f 7269 6769  s = [].    origi
-00011970: 6e61 6c5f 636c 6f75 6420 3d20 6861 6e64  nal_cloud = hand
-00011980: 6c65 2e6c 6175 6e63 6865 645f 7265 736f  le.launched_reso
-00011990: 7572 6365 732e 636c 6f75 640a 2020 2020  urces.cloud.    
-000119a0: 6f72 6967 696e 616c 5f63 6c6f 7564 2e63  original_cloud.c
-000119b0: 6865 636b 5f66 6561 7475 7265 735f 6172  heck_features_ar
-000119c0: 655f 7375 7070 6f72 7465 6428 0a20 2020  e_supported(.   
-000119d0: 2020 2020 2068 616e 646c 652e 6c61 756e       handle.laun
-000119e0: 6368 6564 5f72 6573 6f75 7263 6573 2c0a  ched_resources,.
-000119f0: 2020 2020 2020 2020 7b63 6c6f 7564 732e          {clouds.
-00011a00: 436c 6f75 6449 6d70 6c65 6d65 6e74 6174  CloudImplementat
-00011a10: 696f 6e46 6561 7475 7265 732e 434c 4f4e  ionFeatures.CLON
-00011a20: 455f 4449 534b 5f46 524f 4d5f 434c 5553  E_DISK_FROM_CLUS
-00011a30: 5445 527d 290a 0a20 2020 2061 7373 6572  TER})..    asser
-00011a40: 7420 6f72 6967 696e 616c 5f63 6c6f 7564  t original_cloud
-00011a50: 2069 7320 6e6f 7420 4e6f 6e65 2c20 6861   is not None, ha
-00011a60: 6e64 6c65 2e6c 6175 6e63 6865 645f 7265  ndle.launched_re
-00011a70: 736f 7572 6365 730a 2020 2020 6861 735f  sources.    has_
-00011a80: 6f76 6572 7269 6465 203d 2046 616c 7365  override = False
-00011a90: 0a20 2020 2068 6173 5f64 6973 6b5f 7369  .    has_disk_si
-00011aa0: 7a65 5f6d 6574 203d 2046 616c 7365 0a20  ze_met = False. 
-00011ab0: 2020 2068 6173 5f63 6c6f 7564 5f6d 6574     has_cloud_met
-00011ac0: 203d 2046 616c 7365 0a20 2020 2066 6f72   = False.    for
-00011ad0: 2074 6173 6b5f 7265 736f 7572 6365 7320   task_resources 
-00011ae0: 696e 2074 6173 6b2e 7265 736f 7572 6365  in task.resource
-00011af0: 733a 0a20 2020 2020 2020 2069 6620 6861  s:.        if ha
-00011b00: 6e64 6c65 2e6c 6175 6e63 6865 645f 7265  ndle.launched_re
-00011b10: 736f 7572 6365 732e 6469 736b 5f73 697a  sources.disk_siz
-00011b20: 6520 3e20 7461 736b 5f72 6573 6f75 7263  e > task_resourc
-00011b30: 6573 2e64 6973 6b5f 7369 7a65 3a0a 2020  es.disk_size:.  
-00011b40: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-00011b50: 7461 7267 6574 2063 6c75 7374 6572 2773  target cluster's
-00011b60: 2064 6973 6b20 7368 6f75 6c64 2062 6520   disk should be 
-00011b70: 6174 206c 6561 7374 2061 7320 6c61 7267  at least as larg
-00011b80: 6520 6173 2074 6865 2073 6f75 7263 652e  e as the source.
-00011b90: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00011ba0: 7469 6e75 650a 2020 2020 2020 2020 6861  tinue.        ha
-00011bb0: 735f 6469 736b 5f73 697a 655f 6d65 7420  s_disk_size_met 
-00011bc0: 3d20 5472 7565 0a20 2020 2020 2020 2069  = True.        i
-00011bd0: 6620 7461 736b 5f72 6573 6f75 7263 6573  f task_resources
-00011be0: 2e63 6c6f 7564 2069 7320 6e6f 7420 4e6f  .cloud is not No
-00011bf0: 6e65 2061 6e64 206e 6f74 206f 7269 6769  ne and not origi
-00011c00: 6e61 6c5f 636c 6f75 642e 6973 5f73 616d  nal_cloud.is_sam
-00011c10: 655f 636c 6f75 6428 0a20 2020 2020 2020  e_cloud(.       
-00011c20: 2020 2020 2020 2020 2074 6173 6b5f 7265           task_re
-00011c30: 736f 7572 6365 732e 636c 6f75 6429 3a0a  sources.cloud):.
-00011c40: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00011c50: 696e 7565 0a20 2020 2020 2020 2068 6173  inue.        has
-00011c60: 5f63 6c6f 7564 5f6d 6574 203d 2054 7275  _cloud_met = Tru
-00011c70: 650a 0a20 2020 2020 2020 206f 7665 7272  e..        overr
-00011c80: 6964 655f 7061 7261 6d20 3d20 7b7d 0a20  ide_param = {}. 
-00011c90: 2020 2020 2020 2069 6620 7461 736b 5f72         if task_r
-00011ca0: 6573 6f75 7263 6573 2e63 6c6f 7564 2069  esources.cloud i
-00011cb0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00011cc0: 2020 2020 6f76 6572 7269 6465 5f70 6172      override_par
-00011cd0: 616d 5b27 636c 6f75 6427 5d20 3d20 6f72  am['cloud'] = or
-00011ce0: 6967 696e 616c 5f63 6c6f 7564 0a20 2020  iginal_cloud.   
-00011cf0: 2020 2020 2069 6620 7461 736b 5f72 6573       if task_res
-00011d00: 6f75 7263 6573 2e72 6567 696f 6e20 6973  ources.region is
-00011d10: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00011d20: 2020 206f 7665 7272 6964 655f 7061 7261     override_para
-00011d30: 6d5b 2772 6567 696f 6e27 5d20 3d20 6861  m['region'] = ha
-00011d40: 6e64 6c65 2e6c 6175 6e63 6865 645f 7265  ndle.launched_re
-00011d50: 736f 7572 6365 732e 7265 6769 6f6e 0a0a  sources.region..
-00011d60: 2020 2020 2020 2020 6966 206f 7665 7272          if overr
-00011d70: 6964 655f 7061 7261 6d3a 0a20 2020 2020  ide_param:.     
-00011d80: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-00011d90: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
-00011da0: 2020 2020 6627 4e6f 2063 6c6f 7564 2f72      f'No cloud/r
-00011db0: 6567 696f 6e20 7370 6563 6966 6965 6420  egion specified 
-00011dc0: 666f 7220 7468 6520 7461 736b 207b 7461  for the task {ta
-00011dd0: 736b 5f72 6573 6f75 7263 6573 7d2e 2055  sk_resources}. U
-00011de0: 7369 6e67 2074 6865 2073 616d 6520 7265  sing the same re
-00011df0: 6769 6f6e 2027 0a20 2020 2020 2020 2020  gion '.         
-00011e00: 2020 2020 2020 2066 2761 7320 736f 7572         f'as sour
-00011e10: 6365 2063 6c75 7374 6572 207b 636c 7573  ce cluster {clus
-00011e20: 7465 725f 6e61 6d65 2172 7d3a 2027 0a20  ter_name!r}: '. 
-00011e30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00011e40: 277b 6861 6e64 6c65 2e6c 6175 6e63 6865  '{handle.launche
-00011e50: 645f 7265 736f 7572 6365 732e 636c 6f75  d_resources.clou
-00011e60: 647d 270a 2020 2020 2020 2020 2020 2020  d}'.            
-00011e70: 2020 2020 6627 287b 6861 6e64 6c65 2e6c      f'({handle.l
-00011e80: 6175 6e63 6865 645f 7265 736f 7572 6365  aunched_resource
-00011e90: 732e 7265 6769 6f6e 7d29 2e27 290a 2020  s.region}).').  
-00011ea0: 2020 2020 2020 2020 2020 6861 735f 6f76            has_ov
-00011eb0: 6572 7269 6465 203d 2054 7275 650a 2020  erride = True.  
-00011ec0: 2020 2020 2020 7461 736b 5f72 6573 6f75        task_resou
-00011ed0: 7263 6573 203d 2074 6173 6b5f 7265 736f  rces = task_reso
-00011ee0: 7572 6365 732e 636f 7079 282a 2a6f 7665  urces.copy(**ove
-00011ef0: 7272 6964 655f 7061 7261 6d29 0a20 2020  rride_param).   
-00011f00: 2020 2020 206e 6577 5f74 6173 6b5f 7265       new_task_re
-00011f10: 736f 7572 6365 732e 6170 7065 6e64 2874  sources.append(t
-00011f20: 6173 6b5f 7265 736f 7572 6365 7329 0a0a  ask_resources)..
-00011f30: 2020 2020 6966 206e 6f74 206e 6577 5f74      if not new_t
-00011f40: 6173 6b5f 7265 736f 7572 6365 733a 0a20  ask_resources:. 
-00011f50: 2020 2020 2020 2069 6620 6e6f 7420 6861         if not ha
-00011f60: 735f 6469 736b 5f73 697a 655f 6d65 743a  s_disk_size_met:
-00011f70: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-00011f80: 6820 7578 5f75 7469 6c73 2e70 7269 6e74  h ux_utils.print
-00011f90: 5f65 7863 6570 7469 6f6e 5f6e 6f5f 7472  _exception_no_tr
-00011fa0: 6163 6562 6163 6b28 293a 0a20 2020 2020  aceback():.     
-00011fb0: 2020 2020 2020 2020 2020 2074 6172 6765             targe
-00011fc0: 745f 636c 7573 7465 725f 6e61 6d65 5f73  t_cluster_name_s
-00011fd0: 7472 203d 2066 2720 7b74 6172 6765 745f  tr = f' {target_
-00011fe0: 636c 7573 7465 725f 6e61 6d65 2172 7d27  cluster_name!r}'
-00011ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012000: 2069 6620 7461 7267 6574 5f63 6c75 7374   if target_clust
-00012010: 6572 5f6e 616d 6520 6973 204e 6f6e 653a  er_name is None:
-00012020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012030: 2020 2020 2074 6172 6765 745f 636c 7573       target_clus
-00012040: 7465 725f 6e61 6d65 5f73 7472 203d 2027  ter_name_str = '
-00012050: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00012060: 2020 7261 6973 6520 6578 6365 7074 696f    raise exceptio
-00012070: 6e73 2e4e 6f74 5375 7070 6f72 7465 6445  ns.NotSupportedE
-00012080: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00012090: 2020 2020 2020 2020 2020 6627 5468 6520            f'The 
-000120a0: 7461 7267 6574 2063 6c75 7374 6572 7b74  target cluster{t
-000120b0: 6172 6765 745f 636c 7573 7465 725f 6e61  arget_cluster_na
-000120c0: 6d65 5f73 7472 7d20 7368 6f75 6c64 2068  me_str} should h
-000120d0: 6176 6520 6120 6469 736b 2073 697a 6520  ave a disk size 
-000120e0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-000120f0: 2020 2020 2020 6627 6f66 2061 7420 6c65        f'of at le
-00012100: 6173 7420 7b68 616e 646c 652e 6c61 756e  ast {handle.laun
-00012110: 6368 6564 5f72 6573 6f75 7263 6573 2e64  ched_resources.d
-00012120: 6973 6b5f 7369 7a65 7d20 4742 2074 6f20  isk_size} GB to 
-00012130: 636c 6f6e 6520 7468 6520 270a 2020 2020  clone the '.    
-00012140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012150: 6627 6469 736b 2066 726f 6d20 7b63 6c75  f'disk from {clu
-00012160: 7374 6572 5f6e 616d 6521 727d 2e27 290a  ster_name!r}.').
-00012170: 2020 2020 2020 2020 6966 206e 6f74 2068          if not h
-00012180: 6173 5f63 6c6f 7564 5f6d 6574 3a0a 2020  as_cloud_met:.  
-00012190: 2020 2020 2020 2020 2020 7461 736b 5f72            task_r
-000121a0: 6573 6f75 7263 6573 5f63 6c6f 7564 5f73  esources_cloud_s
-000121b0: 7472 203d 2027 5b27 202b 2027 2c27 2e6a  tr = '[' + ','.j
-000121c0: 6f69 6e28 0a20 2020 2020 2020 2020 2020  oin(.           
-000121d0: 2020 2020 205b 6627 7b72 6573 2e63 6c6f       [f'{res.clo
-000121e0: 7564 7d27 2066 6f72 2072 6573 2069 6e20  ud}' for res in 
-000121f0: 7461 736b 2e72 6573 6f75 7263 6573 5d29  task.resources])
-00012200: 202b 2027 5d27 0a20 2020 2020 2020 2020   + ']'.         
-00012210: 2020 2074 6173 6b5f 7265 736f 7572 6365     task_resource
-00012220: 735f 7374 7220 3d20 275b 2720 2b20 272c  s_str = '[' + ',
-00012230: 272e 6a6f 696e 280a 2020 2020 2020 2020  '.join(.        
-00012240: 2020 2020 2020 2020 5b66 277b 7265 737d          [f'{res}
-00012250: 2720 666f 7220 7265 7320 696e 2074 6173  ' for res in tas
-00012260: 6b2e 7265 736f 7572 6365 735d 2920 2b20  k.resources]) + 
-00012270: 275d 270a 2020 2020 2020 2020 2020 2020  ']'.            
-00012280: 7769 7468 2075 785f 7574 696c 732e 7072  with ux_utils.pr
-00012290: 696e 745f 6578 6365 7074 696f 6e5f 6e6f  int_exception_no
-000122a0: 5f74 7261 6365 6261 636b 2829 3a0a 2020  _traceback():.  
-000122b0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-000122c0: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
-000122d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122e0: 2020 2020 6627 4361 6e6e 6f74 2063 6c6f      f'Cannot clo
-000122f0: 6e65 2064 6973 6b20 6163 726f 7373 2063  ne disk across c
-00012300: 6c6f 7564 2066 726f 6d20 7b6f 7269 6769  loud from {origi
-00012310: 6e61 6c5f 636c 6f75 647d 2074 6f20 270a  nal_cloud} to '.
-00012320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012330: 2020 2020 6627 7b74 6173 6b5f 7265 736f      f'{task_reso
-00012340: 7572 6365 735f 636c 6f75 645f 7374 727d  urces_cloud_str}
-00012350: 2066 6f72 2072 6573 6f75 7263 6573 207b   for resources {
-00012360: 7461 736b 5f72 6573 6f75 7263 6573 5f73  task_resources_s
-00012370: 7472 7d2e 270a 2020 2020 2020 2020 2020  tr}.'.          
-00012380: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00012390: 6173 7365 7274 2046 616c 7365 2c20 2753  assert False, 'S
-000123a0: 686f 756c 6420 6e6f 7420 7265 6163 6820  hould not reach 
-000123b0: 6865 7265 2e27 0a20 2020 2023 2073 6574  here.'.    # set
-000123c0: 2074 6865 206e 6577 5f74 6173 6b5f 7265   the new_task_re
-000123d0: 736f 7572 6365 7320 746f 2062 6520 7468  sources to be th
-000123e0: 6520 7361 6d65 2074 7970 6520 286c 6973  e same type (lis
-000123f0: 7420 6f72 2073 6574 2920 6173 2074 6865  t or set) as the
-00012400: 0a20 2020 2023 206f 7269 6769 6e61 6c20  .    # original 
-00012410: 7461 736b 2e72 6573 6f75 7263 6573 0a20  task.resources. 
-00012420: 2020 2069 6620 6861 735f 6f76 6572 7269     if has_overri
-00012430: 6465 3a0a 2020 2020 2020 2020 7461 736b  de:.        task
-00012440: 2e73 6574 5f72 6573 6f75 7263 6573 2874  .set_resources(t
-00012450: 7970 6528 7461 736b 2e72 6573 6f75 7263  ype(task.resourc
-00012460: 6573 2928 6e65 775f 7461 736b 5f72 6573  es)(new_task_res
-00012470: 6f75 7263 6573 2929 0a20 2020 2020 2020  ources)).       
-00012480: 2023 2052 6573 6574 2074 6865 2062 6573   # Reset the bes
-00012490: 745f 7265 736f 7572 6365 7320 746f 2074  t_resources to t
-000124a0: 7269 6765 7220 7265 2d6f 7074 696d 697a  riger re-optimiz
-000124b0: 6174 696f 6e0a 2020 2020 2020 2020 2320  ation.        # 
-000124c0: 6c61 7465 722c 2073 6f20 7468 6174 2074  later, so that t
-000124d0: 6865 206e 6577 2074 6173 6b5f 7265 736f  he new task_reso
-000124e0: 7572 6365 7320 7769 6c6c 2062 6520 7573  urces will be us
-000124f0: 6564 2e0a 2020 2020 2020 2020 7461 736b  ed..        task
-00012500: 2e62 6573 745f 7265 736f 7572 6365 7320  .best_resources 
-00012510: 3d20 4e6f 6e65 0a20 2020 2072 6574 7572  = None.    retur
-00012520: 6e20 7461 736b 2c20 6861 6e64 6c65 0a0a  n task, handle..
-00012530: 0a64 6566 205f 7570 6461 7465 5f63 6c75  .def _update_clu
-00012540: 7374 6572 5f73 7461 7475 735f 6e6f 5f6c  ster_status_no_l
-00012550: 6f63 6b28 0a20 2020 2020 2020 2063 6c75  ock(.        clu
-00012560: 7374 6572 5f6e 616d 653a 2073 7472 2920  ster_name: str) 
-00012570: 2d3e 204f 7074 696f 6e61 6c5b 4469 6374  -> Optional[Dict
-00012580: 5b73 7472 2c20 416e 795d 5d3a 0a20 2020  [str, Any]]:.   
-00012590: 2022 2222 5570 6461 7465 7320 7468 6520   """Updates the 
-000125a0: 7374 6174 7573 206f 6620 7468 6520 636c  status of the cl
-000125b0: 7573 7465 722e 0a0a 2020 2020 5261 6973  uster...    Rais
-000125c0: 6573 3a0a 2020 2020 2020 2020 6578 6365  es:.        exce
-000125d0: 7074 696f 6e73 2e43 6c75 7374 6572 5374  ptions.ClusterSt
-000125e0: 6174 7573 4665 7463 6869 6e67 4572 726f  atusFetchingErro
-000125f0: 723a 2074 6865 2063 6c75 7374 6572 2073  r: the cluster s
-00012600: 7461 7475 7320 6361 6e6e 6f74 2062 650a  tatus cannot be.
-00012610: 2020 2020 2020 2020 2020 6665 7463 6865            fetche
-00012620: 6420 6672 6f6d 2074 6865 2063 6c6f 7564  d from the cloud
-00012630: 2070 726f 7669 6465 722e 0a20 2020 2022   provider..    "
-00012640: 2222 0a20 2020 2072 6563 6f72 6420 3d20  "".    record = 
-00012650: 676c 6f62 616c 5f75 7365 725f 7374 6174  global_user_stat
-00012660: 652e 6765 745f 636c 7573 7465 725f 6672  e.get_cluster_fr
-00012670: 6f6d 5f6e 616d 6528 636c 7573 7465 725f  om_name(cluster_
-00012680: 6e61 6d65 290a 2020 2020 6966 2072 6563  name).    if rec
-00012690: 6f72 6420 6973 204e 6f6e 653a 0a20 2020  ord is None:.   
-000126a0: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-000126b0: 0a20 2020 2068 616e 646c 6520 3d20 7265  .    handle = re
-000126c0: 636f 7264 5b27 6861 6e64 6c65 275d 0a20  cord['handle']. 
-000126d0: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
-000126e0: 616e 6365 2868 616e 646c 652c 2062 6163  ance(handle, bac
-000126f0: 6b65 6e64 732e 436c 6f75 6456 6d52 6179  kends.CloudVmRay
-00012700: 5265 736f 7572 6365 4861 6e64 6c65 293a  ResourceHandle):
-00012710: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00012720: 7265 636f 7264 0a20 2020 2063 6c75 7374  record.    clust
-00012730: 6572 5f6e 616d 6520 3d20 6861 6e64 6c65  er_name = handle
-00012740: 2e63 6c75 7374 6572 5f6e 616d 650a 0a20  .cluster_name.. 
-00012750: 2020 206e 6f64 655f 7374 6174 7573 6573     node_statuses
-00012760: 203d 205f 7175 6572 795f 636c 7573 7465   = _query_cluste
-00012770: 725f 7374 6174 7573 5f76 6961 5f63 6c6f  r_status_via_clo
-00012780: 7564 5f61 7069 2868 616e 646c 6529 0a0a  ud_api(handle)..
-00012790: 2020 2020 616c 6c5f 6e6f 6465 735f 7570      all_nodes_up
-000127a0: 203d 2028 616c 6c28 0a20 2020 2020 2020   = (all(.       
-000127b0: 2073 7461 7475 7320 3d3d 2073 7461 7475   status == statu
-000127c0: 735f 6c69 622e 436c 7573 7465 7253 7461  s_lib.ClusterSta
-000127d0: 7475 732e 5550 2066 6f72 2073 7461 7475  tus.UP for statu
-000127e0: 7320 696e 206e 6f64 655f 7374 6174 7573  s in node_status
-000127f0: 6573 2920 616e 640a 2020 2020 2020 2020  es) and.        
-00012800: 2020 2020 2020 2020 2020 2020 6c65 6e28              len(
-00012810: 6e6f 6465 5f73 7461 7475 7365 7329 203d  node_statuses) =
-00012820: 3d20 6861 6e64 6c65 2e6c 6175 6e63 6865  = handle.launche
-00012830: 645f 6e6f 6465 7329 0a0a 2020 2020 6465  d_nodes)..    de
-00012840: 6620 7275 6e5f 7261 795f 7374 6174 7573  f run_ray_status
-00012850: 5f74 6f5f 6368 6563 6b5f 7261 795f 636c  _to_check_ray_cl
-00012860: 7573 7465 725f 6865 616c 7468 7928 2920  uster_healthy() 
-00012870: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
-00012880: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00012890: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
-000128a0: 5468 6973 2066 756e 6374 696f 6e20 6361  This function ca
-000128b0: 6e6e 6f74 2064 6973 7469 6e67 7569 7368  nnot distinguish
-000128c0: 2074 7261 6e73 6965 6e74 206e 6574 776f   transient netwo
-000128d0: 726b 0a20 2020 2020 2020 2020 2020 2023  rk.            #
-000128e0: 2065 7272 6f72 2069 6e20 7261 7927 7320   error in ray's 
-000128f0: 6765 7420 4950 7320 7673 2e20 7261 7920  get IPs vs. ray 
-00012900: 7275 6e74 696d 6520 6661 696c 696e 672e  runtime failing.
-00012910: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00012920: 4e4f 5445 3a20 6665 7463 6869 6e67 2074  NOTE: fetching t
-00012930: 6865 2049 5073 2069 7320 7665 7279 2073  he IPs is very s
-00012940: 6c6f 7720 6173 2069 7420 6361 6c6c 7320  low as it calls 
-00012950: 696e 746f 0a20 2020 2020 2020 2020 2020  into.           
-00012960: 2023 2060 7261 7920 6765 7420 6865 6164   # `ray get head
-00012970: 2d69 702f 776f 726b 6572 2d69 7073 602e  -ip/worker-ips`.
-00012980: 2055 7369 6e67 2063 6163 6865 6420 4950   Using cached IP
-00012990: 7320 6973 2073 6166 6520 6265 6361 7573  s is safe becaus
-000129a0: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-000129b0: 696e 2074 6865 2077 6f72 7374 2063 6173  in the worst cas
-000129c0: 6520 7765 2074 696d 6520 6f75 7420 696e  e we time out in
-000129d0: 2074 6865 2060 7261 7920 7374 6174 7573   the `ray status
-000129e0: 6020 5353 4820 636f 6d6d 616e 640a 2020  ` SSH command.  
-000129f0: 2020 2020 2020 2020 2020 2320 6265 6c6f            # belo
-00012a00: 772e 0a20 2020 2020 2020 2020 2020 2065  w..            e
-00012a10: 7874 6572 6e61 6c5f 6970 7320 3d20 6861  xternal_ips = ha
-00012a20: 6e64 6c65 2e63 6163 6865 645f 6578 7465  ndle.cached_exte
-00012a30: 726e 616c 5f69 7073 0a20 2020 2020 2020  rnal_ips.       
-00012a40: 2020 2020 2023 2054 6869 7320 6861 7070       # This happ
-00012a50: 656e 7320 7768 656e 2075 7365 7220 696e  ens when user in
-00012a60: 7465 7272 7570 7420 7468 6520 6073 6b79  terrupt the `sky
-00012a70: 206c 6175 6e63 6860 2070 726f 6365 7373   launch` process
-00012a80: 2062 6566 6f72 650a 2020 2020 2020 2020   before.        
-00012a90: 2020 2020 2320 7468 6520 6669 7273 7420      # the first 
-00012aa0: 7469 6d65 2072 6573 6f75 7263 6573 2068  time resources h
-00012ab0: 616e 646c 6520 6973 2077 7269 7474 656e  andle is written
-00012ac0: 2062 6163 6b20 746f 206c 6f63 616c 2064   back to local d
-00012ad0: 6174 6162 6173 652e 0a20 2020 2020 2020  atabase..       
-00012ae0: 2020 2020 2023 2054 6869 7320 6973 2068       # This is h
-00012af0: 656c 7066 756c 2077 6865 6e20 7573 6572  elpful when user
-00012b00: 2069 6e74 6572 7275 7074 2061 6674 6572   interrupt after
-00012b10: 2074 6865 2070 726f 7669 7369 6f6e 2069   the provision i
-00012b20: 7320 646f 6e65 0a20 2020 2020 2020 2020  s done.         
-00012b30: 2020 2023 2061 6e64 2062 6566 6f72 6520     # and before 
-00012b40: 7468 6520 736b 796c 6574 2069 7320 7265  the skylet is re
-00012b50: 7374 6172 7465 642e 2041 6674 6572 2023  started. After #
-00012b60: 3233 3034 2069 7320 6d65 7267 6564 2c20  2304 is merged, 
-00012b70: 7468 6973 0a20 2020 2020 2020 2020 2020  this.           
-00012b80: 2023 2068 656c 7073 206b 6565 7020 7468   # helps keep th
-00012b90: 6520 636c 7573 7465 7220 7374 6174 7573  e cluster status
-00012ba0: 2074 6f20 494e 4954 2061 6674 6572 2060   to INIT after `
-00012bb0: 736b 7920 7374 6174 7573 202d 7260 2c20  sky status -r`, 
-00012bc0: 736f 0a20 2020 2020 2020 2020 2020 2023  so.            #
-00012bd0: 2075 7365 7220 7769 6c6c 2062 6520 6e6f   user will be no
-00012be0: 7469 6669 6564 2074 6861 7420 616e 7920  tified that any 
-00012bf0: 6175 746f 2073 746f 702f 646f 776e 206d  auto stop/down m
-00012c00: 6967 6874 206e 6f74 2062 650a 2020 2020  ight not be.    
-00012c10: 2020 2020 2020 2020 2320 7472 6967 6765          # trigge
-00012c20: 7265 642e 0a20 2020 2020 2020 2020 2020  red..           
-00012c30: 2069 6620 6578 7465 726e 616c 5f69 7073   if external_ips
-00012c40: 2069 7320 4e6f 6e65 206f 7220 6c65 6e28   is None or len(
-00012c50: 6578 7465 726e 616c 5f69 7073 2920 3d3d  external_ips) ==
-00012c60: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00012c70: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-00012c80: 2866 2752 6566 7265 7368 696e 6720 7374  (f'Refreshing st
-00012c90: 6174 7573 2028 7b63 6c75 7374 6572 5f6e  atus ({cluster_n
-00012ca0: 616d 6521 727d 293a 204e 6f20 6361 6368  ame!r}): No cach
-00012cb0: 6564 2027 0a20 2020 2020 2020 2020 2020  ed '.           
-00012cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012cd0: 2020 6627 4950 7320 666f 756e 642e 2048    f'IPs found. H
-00012ce0: 616e 646c 653a 207b 6861 6e64 6c65 7d27  andle: {handle}'
-00012cf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00012d00: 2020 7261 6973 6520 6578 6365 7074 696f    raise exceptio
-00012d10: 6e73 2e46 6574 6368 4950 4572 726f 7228  ns.FetchIPError(
-00012d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012d30: 2020 2020 2072 6561 736f 6e3d 6578 6365       reason=exce
-00012d40: 7074 696f 6e73 2e46 6574 6368 4950 4572  ptions.FetchIPEr
-00012d50: 726f 722e 5265 6173 6f6e 2e48 4541 4429  ror.Reason.HEAD)
-00012d60: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00012d70: 506f 7465 6e74 6961 6c6c 7920 7265 6672  Potentially refr
-00012d80: 6573 6820 7468 6520 6578 7465 726e 616c  esh the external
-00012d90: 2053 5348 2070 6f72 7473 2c20 696e 2063   SSH ports, in c
-00012da0: 6173 6520 7468 6520 6578 6973 7469 6e67  ase the existing
-00012db0: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
-00012dc0: 6c75 7374 6572 2062 6566 6f72 6520 2332  luster before #2
-00012dd0: 3439 3120 7761 7320 6c61 756e 6368 6564  491 was launched
-00012de0: 2077 6974 686f 7574 2065 7874 6572 6e61   without externa
-00012df0: 6c20 5353 4820 706f 7274 730a 2020 2020  l SSH ports.    
-00012e00: 2020 2020 2020 2020 2320 6361 6368 6564          # cached
-00012e10: 2e0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
-00012e20: 7465 726e 616c 5f73 7368 5f70 6f72 7473  ternal_ssh_ports
-00012e30: 203d 2068 616e 646c 652e 6578 7465 726e   = handle.extern
-00012e40: 616c 5f73 7368 5f70 6f72 7473 2829 0a20  al_ssh_ports(). 
-00012e50: 2020 2020 2020 2020 2020 2068 6561 645f             head_
-00012e60: 7373 685f 706f 7274 203d 2065 7874 6572  ssh_port = exter
-00012e70: 6e61 6c5f 7373 685f 706f 7274 735b 305d  nal_ssh_ports[0]
-00012e80: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00012e90: 4368 6563 6b20 6966 2072 6179 2063 6c75  Check if ray clu
-00012ea0: 7374 6572 2073 7461 7475 7320 6973 2068  ster status is h
-00012eb0: 6561 6c74 6879 2e0a 2020 2020 2020 2020  ealthy..        
-00012ec0: 2020 2020 7373 685f 6372 6564 656e 7469      ssh_credenti
-00012ed0: 616c 7320 3d20 7373 685f 6372 6564 656e  als = ssh_creden
-00012ee0: 7469 616c 5f66 726f 6d5f 7961 6d6c 2868  tial_from_yaml(h
-00012ef0: 616e 646c 652e 636c 7573 7465 725f 7961  andle.cluster_ya
-00012f00: 6d6c 2c0a 2020 2020 2020 2020 2020 2020  ml,.            
+00010020: 2020 2063 7572 7265 6e74 5f75 7365 725f     current_user_
+00010030: 6964 656e 7469 7479 2929 3a0a 2020 2020  identity)):.    
+00010040: 2020 2020 2020 2020 2320 436c 6561 6e20          # Clean 
+00010050: 7570 2074 6865 206f 776e 6572 2069 6465  up the owner ide
+00010060: 6e74 6979 2066 6f72 2074 6865 2062 6163  ntiy for the bac
+00010070: 6b73 6c61 7368 2061 6e64 206e 6577 6c69  kslash and newli
+00010080: 6e65 732c 2063 6175 7365 640a 2020 2020  nes, caused.    
+00010090: 2020 2020 2020 2020 2320 6279 2074 6865          # by the
+000100a0: 2063 6c6f 7564 2043 4c49 206f 7574 7075   cloud CLI outpu
+000100b0: 742c 2065 2e67 2e20 6763 6c6f 7564 2e0a  t, e.g. gcloud..
+000100c0: 2020 2020 2020 2020 2020 2020 6f77 6e65              owne
+000100d0: 7220 3d20 6f77 6e65 722e 7265 706c 6163  r = owner.replac
+000100e0: 6528 275c 6e27 2c20 2727 292e 7265 706c  e('\n', '').repl
+000100f0: 6163 6528 275c 5c27 2c20 2727 290a 2020  ace('\\', '').  
+00010100: 2020 2020 2020 2020 2020 6966 206f 776e            if own
+00010110: 6572 203d 3d20 6375 7272 656e 743a 0a20  er == current:. 
+00010120: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00010130: 6620 6920 213d 2030 3a0a 2020 2020 2020  f i != 0:.      
+00010140: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00010150: 6767 6572 2e77 6172 6e69 6e67 280a 2020  gger.warning(.  
+00010160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010170: 2020 2020 2020 6627 5468 6520 636c 7573        f'The clus
+00010180: 7465 7220 7761 7320 6f77 6e65 6420 6279  ter was owned by
+00010190: 207b 6f77 6e65 725f 6964 656e 7469 7479   {owner_identity
+000101a0: 7d2c 2062 7574 2027 0a20 2020 2020 2020  }, but '.       
+000101b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000101c0: 2066 2761 206e 6577 2069 6465 6e74 6974   f'a new identit
+000101d0: 7920 7b63 7572 7265 6e74 5f75 7365 725f  y {current_user_
+000101e0: 6964 656e 7469 7479 7d20 6973 2061 6374  identity} is act
+000101f0: 6976 6174 6564 2e20 5765 2073 7469 6c6c  ivated. We still
+00010200: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00010210: 2020 2020 2020 2020 2020 2027 616c 6c6f             'allo
+00010220: 7720 7468 6520 6f70 6572 6174 696f 6e20  w the operation 
+00010230: 6173 2074 6865 2074 776f 2069 6465 6e74  as the two ident
+00010240: 6974 6965 7320 6172 6520 6c69 6b65 6c79  ities are likely
+00010250: 2074 6f20 6861 7665 2027 0a20 2020 2020   to have '.     
+00010260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010270: 2020 2027 7468 6520 7361 6d65 2061 6363     'the same acc
+00010280: 6573 7320 746f 2074 6865 2063 6c75 7374  ess to the clust
+00010290: 6572 2e20 506c 6561 7365 2062 6520 6177  er. Please be aw
+000102a0: 6172 6520 7468 6174 2074 6869 7320 6361  are that this ca
+000102b0: 6e20 270a 2020 2020 2020 2020 2020 2020  n '.            
+000102c0: 2020 2020 2020 2020 2020 2020 2763 6175              'cau
+000102d0: 7365 2075 6e65 7870 6563 7465 6420 636c  se unexpected cl
+000102e0: 7573 7465 7220 6c65 616b 6167 6520 6966  uster leakage if
+000102f0: 2074 6865 2074 776f 2069 6465 6e74 6974   the two identit
+00010300: 6965 7320 6172 6520 6e6f 7420 270a 2020  ies are not '.  
+00010310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010320: 2020 2020 2020 2761 6374 7561 6c6c 7920        'actually 
+00010330: 6571 7569 7661 6c65 6e74 2028 652e 672e  equivalent (e.g.
+00010340: 2c20 6265 6c6f 6e67 2074 6f20 7468 6520  , belong to the 
+00010350: 7361 6d65 2070 6572 736f 6e29 2e27 0a20  same person).'. 
+00010360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010370: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00010380: 2020 2020 2069 6620 6920 213d 2030 206f       if i != 0 o
+00010390: 7220 6c65 6e28 6f77 6e65 725f 6964 656e  r len(owner_iden
+000103a0: 7469 7479 2920 213d 206c 656e 2863 7572  tity) != len(cur
+000103b0: 7265 6e74 5f75 7365 725f 6964 656e 7469  rent_user_identi
+000103c0: 7479 293a 0a20 2020 2020 2020 2020 2020  ty):.           
+000103d0: 2020 2020 2020 2020 2023 2057 6520 7570           # We up
+000103e0: 6461 7465 2074 6865 206f 776e 6572 206f  date the owner o
+000103f0: 6620 6120 636c 7573 7465 722c 2077 6865  f a cluster, whe
+00010400: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+00010410: 2020 2020 2020 2023 2031 2e20 5468 6520         # 1. The 
+00010420: 7374 7269 6374 6573 7420 6964 656e 7474  strictest identt
+00010430: 7920 2869 2e65 2e20 7468 6520 6669 7273  y (i.e. the firs
+00010440: 7420 6f6e 6529 2064 6f65 7320 6e6f 740a  t one) does not.
+00010450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010460: 2020 2020 2320 6d61 7463 682c 2062 7574      # match, but
+00010470: 2074 6865 206c 6174 7465 7220 6f6e 6573   the latter ones
+00010480: 206d 6174 6368 2e0a 2020 2020 2020 2020   match..        
+00010490: 2020 2020 2020 2020 2020 2020 2320 322e              # 2.
+000104a0: 2054 6865 206c 656e 6774 6820 6f66 2074   The length of t
+000104b0: 6865 2074 776f 2069 6465 6e74 6974 6965  he two identitie
+000104c0: 7320 6172 6520 6469 6666 6572 656e 742c  s are different,
+000104d0: 2077 6869 6368 0a20 2020 2020 2020 2020   which.         
+000104e0: 2020 2020 2020 2020 2020 2023 2077 696c             # wil
+000104f0: 6c20 6f6e 6c79 2068 6170 7065 6e20 7768  l only happen wh
+00010500: 656e 2074 6865 2063 6c75 7374 6572 2069  en the cluster i
+00010510: 7320 6c61 756e 6368 6564 2062 6566 6f72  s launched befor
+00010520: 6520 2331 3830 382e 0a20 2020 2020 2020  e #1808..       
+00010530: 2020 2020 2020 2020 2020 2020 2023 2055               # U
+00010540: 7064 6174 6520 7468 6520 7573 6572 2069  pdate the user i
+00010550: 6465 6e74 6974 7920 746f 2061 766f 6964  dentity to avoid
+00010560: 2073 686f 7769 6e67 2074 6865 2077 6172   showing the war
+00010570: 6e69 6e67 2061 626f 7665 0a20 2020 2020  ning above.     
+00010580: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00010590: 2061 6761 696e 2e0a 2020 2020 2020 2020   again..        
+000105a0: 2020 2020 2020 2020 2020 2020 676c 6f62              glob
+000105b0: 616c 5f75 7365 725f 7374 6174 652e 7365  al_user_state.se
+000105c0: 745f 6f77 6e65 725f 6964 656e 7469 7479  t_owner_identity
+000105d0: 5f66 6f72 5f63 6c75 7374 6572 280a 2020  _for_cluster(.  
+000105e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000105f0: 2020 2020 2020 636c 7573 7465 725f 6e61        cluster_na
+00010600: 6d65 2c20 6375 7272 656e 745f 7573 6572  me, current_user
+00010610: 5f69 6465 6e74 6974 7929 0a20 2020 2020  _identity).     
+00010620: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00010630: 6e20 2023 2054 6865 2075 7365 7220 6964  n  # The user id
+00010640: 656e 7469 7479 206d 6174 6368 6573 2e0a  entity matches..
+00010650: 2020 2020 2020 2020 7769 7468 2075 785f          with ux_
+00010660: 7574 696c 732e 7072 696e 745f 6578 6365  utils.print_exce
+00010670: 7074 696f 6e5f 6e6f 5f74 7261 6365 6261  ption_no_traceba
+00010680: 636b 2829 3a0a 2020 2020 2020 2020 2020  ck():.          
+00010690: 2020 7261 6973 6520 6578 6365 7074 696f    raise exceptio
+000106a0: 6e73 2e43 6c75 7374 6572 4f77 6e65 7249  ns.ClusterOwnerI
+000106b0: 6465 6e74 6974 794d 6973 6d61 7463 6845  dentityMismatchE
+000106c0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+000106d0: 2020 2020 2020 6627 7b63 6c75 7374 6572        f'{cluster
+000106e0: 5f6e 616d 6521 727d 2028 7b63 6c6f 7564  _name!r} ({cloud
+000106f0: 7d29 2069 7320 6f77 6e65 6420 6279 2061  }) is owned by a
+00010700: 6363 6f75 6e74 2027 0a20 2020 2020 2020  ccount '.       
+00010710: 2020 2020 2020 2020 2066 277b 6f77 6e65           f'{owne
+00010720: 725f 6964 656e 7469 7479 2172 7d2c 2062  r_identity!r}, b
+00010730: 7574 2074 6865 2061 6374 6976 6174 6564  ut the activated
+00010740: 2061 6363 6f75 6e74 2027 0a20 2020 2020   account '.     
+00010750: 2020 2020 2020 2020 2020 2066 2769 7320             f'is 
+00010760: 7b63 7572 7265 6e74 5f75 7365 725f 6964  {current_user_id
+00010770: 656e 7469 7479 2172 7d2e 2729 0a0a 0a64  entity!r}.')...d
+00010780: 6566 2074 6167 5f66 696c 7465 725f 666f  ef tag_filter_fo
+00010790: 725f 636c 7573 7465 7228 636c 7573 7465  r_cluster(cluste
+000107a0: 725f 6e61 6d65 3a20 7374 7229 202d 3e20  r_name: str) -> 
+000107b0: 4469 6374 5b73 7472 2c20 7374 725d 3a0a  Dict[str, str]:.
+000107c0: 2020 2020 2222 2252 6574 7572 6e73 2061      """Returns a
+000107d0: 2074 6167 2066 696c 7465 7220 666f 7220   tag filter for 
+000107e0: 7468 6520 636c 7573 7465 722e 2222 220a  the cluster.""".
+000107f0: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
+00010800: 2020 2020 2027 7261 792d 636c 7573 7465       'ray-cluste
+00010810: 722d 6e61 6d65 273a 2063 6c75 7374 6572  r-name': cluster
+00010820: 5f6e 616d 652c 0a20 2020 207d 0a0a 0a64  _name,.    }...d
+00010830: 6566 205f 7175 6572 795f 636c 7573 7465  ef _query_cluste
+00010840: 725f 7374 6174 7573 5f76 6961 5f63 6c6f  r_status_via_clo
+00010850: 7564 5f61 7069 280a 2020 2020 6861 6e64  ud_api(.    hand
+00010860: 6c65 3a20 2763 6c6f 7564 5f76 6d5f 7261  le: 'cloud_vm_ra
+00010870: 795f 6261 636b 656e 642e 436c 6f75 6456  y_backend.CloudV
+00010880: 6d52 6179 5265 736f 7572 6365 4861 6e64  mRayResourceHand
+00010890: 6c65 270a 2920 2d3e 204c 6973 745b 7374  le'.) -> List[st
+000108a0: 6174 7573 5f6c 6962 2e43 6c75 7374 6572  atus_lib.Cluster
+000108b0: 5374 6174 7573 5d3a 0a20 2020 2022 2222  Status]:.    """
+000108c0: 5265 7475 726e 7320 7468 6520 7374 6174  Returns the stat
+000108d0: 7573 206f 6620 7468 6520 636c 7573 7465  us of the cluste
+000108e0: 722e 0a0a 2020 2020 5261 6973 6573 3a0a  r...    Raises:.
+000108f0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
+00010900: 6e73 2e43 6c75 7374 6572 5374 6174 7573  ns.ClusterStatus
+00010910: 4665 7463 6869 6e67 4572 726f 723a 2074  FetchingError: t
+00010920: 6865 2063 6c75 7374 6572 2073 7461 7475  he cluster statu
+00010930: 7320 6361 6e6e 6f74 2062 650a 2020 2020  s cannot be.    
+00010940: 2020 2020 2020 6665 7463 6865 6420 6672        fetched fr
+00010950: 6f6d 2074 6865 2063 6c6f 7564 2070 726f  om the cloud pro
+00010960: 7669 6465 722e 0a20 2020 2022 2222 0a20  vider..    """. 
+00010970: 2020 2063 6c75 7374 6572 5f6e 616d 655f     cluster_name_
+00010980: 6f6e 5f63 6c6f 7564 203d 2068 616e 646c  on_cloud = handl
+00010990: 652e 636c 7573 7465 725f 6e61 6d65 5f6f  e.cluster_name_o
+000109a0: 6e5f 636c 6f75 640a 2020 2020 636c 7573  n_cloud.    clus
+000109b0: 7465 725f 6e61 6d65 5f69 6e5f 6869 6e74  ter_name_in_hint
+000109c0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+000109d0: 636c 7573 7465 725f 6e61 6d65 5f69 6e5f  cluster_name_in_
+000109e0: 6869 6e74 280a 2020 2020 2020 2020 6861  hint(.        ha
+000109f0: 6e64 6c65 2e63 6c75 7374 6572 5f6e 616d  ndle.cluster_nam
+00010a00: 652c 2063 6c75 7374 6572 5f6e 616d 655f  e, cluster_name_
+00010a10: 6f6e 5f63 6c6f 7564 290a 2020 2020 2320  on_cloud).    # 
+00010a20: 5573 6520 7265 6769 6f6e 2061 6e64 207a  Use region and z
+00010a30: 6f6e 6520 6672 6f6d 2074 6865 2063 6c75  one from the clu
+00010a40: 7374 6572 2063 6f6e 6669 672c 2069 6e73  ster config, ins
+00010a50: 7465 6164 206f 6620 7468 650a 2020 2020  tead of the.    
+00010a60: 2320 6861 6e64 6c65 2e6c 6175 6e63 6865  # handle.launche
+00010a70: 645f 7265 736f 7572 6365 732c 2062 6563  d_resources, bec
+00010a80: 6175 7365 2074 6865 206c 6174 7465 7220  ause the latter 
+00010a90: 6d61 7920 6e6f 7420 6265 2073 6574 0a20  may not be set. 
+00010aa0: 2020 2023 2063 6f72 7265 6374 6c79 2079     # correctly y
+00010ab0: 6574 2e0a 2020 2020 7261 795f 636f 6e66  et..    ray_conf
+00010ac0: 6967 203d 2063 6f6d 6d6f 6e5f 7574 696c  ig = common_util
+00010ad0: 732e 7265 6164 5f79 616d 6c28 6861 6e64  s.read_yaml(hand
+00010ae0: 6c65 2e63 6c75 7374 6572 5f79 616d 6c29  le.cluster_yaml)
+00010af0: 0a20 2020 2070 726f 7669 6465 725f 636f  .    provider_co
+00010b00: 6e66 6967 203d 2072 6179 5f63 6f6e 6669  nfig = ray_confi
+00010b10: 675b 2770 726f 7669 6465 7227 5d0a 0a20  g['provider'].. 
+00010b20: 2020 2023 2051 7565 7279 2074 6865 2063     # Query the c
+00010b30: 6c6f 7564 2070 726f 7669 6465 722e 0a20  loud provider.. 
+00010b40: 2020 2023 2054 4f44 4f28 7375 7175 6172     # TODO(suquar
+00010b50: 6b29 3a20 6d6f 7665 2069 6d70 6c65 6d65  k): move impleme
+00010b60: 6e74 6174 696f 6e73 206f 6620 6d6f 7265  ntations of more
+00010b70: 2063 6c6f 7564 7320 6865 7265 0a20 2020   clouds here.   
+00010b80: 2063 6c6f 7564 203d 2068 616e 646c 652e   cloud = handle.
+00010b90: 6c61 756e 6368 6564 5f72 6573 6f75 7263  launched_resourc
+00010ba0: 6573 2e63 6c6f 7564 0a20 2020 2061 7373  es.cloud.    ass
+00010bb0: 6572 7420 636c 6f75 6420 6973 206e 6f74  ert cloud is not
+00010bc0: 204e 6f6e 652c 2068 616e 646c 650a 2020   None, handle.  
+00010bd0: 2020 6966 2063 6c6f 7564 2e53 5441 5455    if cloud.STATU
+00010be0: 535f 5645 5253 494f 4e20 3e3d 2063 6c6f  S_VERSION >= clo
+00010bf0: 7564 732e 5374 6174 7573 5665 7273 696f  uds.StatusVersio
+00010c00: 6e2e 534b 5950 494c 4f54 3a0a 2020 2020  n.SKYPILOT:.    
+00010c10: 2020 2020 636c 6f75 645f 6e61 6d65 203d      cloud_name =
+00010c20: 2072 6570 7228 6861 6e64 6c65 2e6c 6175   repr(handle.lau
+00010c30: 6e63 6865 645f 7265 736f 7572 6365 732e  nched_resources.
+00010c40: 636c 6f75 6429 0a20 2020 2020 2020 2074  cloud).        t
+00010c50: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00010c60: 6e6f 6465 5f73 7461 7475 735f 6469 6374  node_status_dict
+00010c70: 203d 2070 726f 7669 7369 6f6e 5f6c 6962   = provision_lib
+00010c80: 2e71 7565 7279 5f69 6e73 7461 6e63 6573  .query_instances
+00010c90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00010ca0: 2020 636c 6f75 645f 6e61 6d65 2c20 636c    cloud_name, cl
+00010cb0: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
+00010cc0: 6f75 642c 2070 726f 7669 6465 725f 636f  oud, provider_co
+00010cd0: 6e66 6967 290a 2020 2020 2020 2020 2020  nfig).          
+00010ce0: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
+00010cf0: 2751 7565 7279 696e 6720 7b63 6c6f 7564  'Querying {cloud
+00010d00: 5f6e 616d 657d 2063 6c75 7374 6572 2027  _name} cluster '
+00010d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010d20: 2020 2020 2020 2020 2020 6627 7b63 6c75            f'{clu
+00010d30: 7374 6572 5f6e 616d 655f 696e 5f68 696e  ster_name_in_hin
+00010d40: 747d 2027 0a20 2020 2020 2020 2020 2020  t} '.           
+00010d50: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00010d60: 7374 6174 7573 3a5c 6e7b 7070 7269 6e74  status:\n{pprint
+00010d70: 2e70 666f 726d 6174 286e 6f64 655f 7374  .pformat(node_st
+00010d80: 6174 7573 5f64 6963 7429 7d27 290a 2020  atus_dict)}').  
+00010d90: 2020 2020 2020 2020 2020 6e6f 6465 5f73            node_s
+00010da0: 7461 7475 7365 7320 3d20 6c69 7374 286e  tatuses = list(n
+00010db0: 6f64 655f 7374 6174 7573 5f64 6963 742e  ode_status_dict.
+00010dc0: 7661 6c75 6573 2829 290a 2020 2020 2020  values()).      
+00010dd0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00010de0: 6f6e 2061 7320 653a 2020 2320 7079 6c69  on as e:  # pyli
+00010df0: 6e74 3a20 6469 7361 626c 653d 6272 6f61  nt: disable=broa
+00010e00: 642d 6578 6365 7074 0a20 2020 2020 2020  d-except.       
+00010e10: 2020 2020 2077 6974 6820 7578 5f75 7469       with ux_uti
+00010e20: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
+00010e30: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
+00010e40: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00010e50: 2020 2072 6169 7365 2065 7863 6570 7469     raise excepti
+00010e60: 6f6e 732e 436c 7573 7465 7253 7461 7475  ons.ClusterStatu
+00010e70: 7346 6574 6368 696e 6745 7272 6f72 280a  sFetchingError(.
+00010e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e90: 2020 2020 6627 4661 696c 6564 2074 6f20      f'Failed to 
+00010ea0: 7175 6572 7920 7b63 6c6f 7564 5f6e 616d  query {cloud_nam
+00010eb0: 657d 2063 6c75 7374 6572 2027 0a20 2020  e} cluster '.   
+00010ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ed0: 2066 277b 636c 7573 7465 725f 6e61 6d65   f'{cluster_name
+00010ee0: 5f69 6e5f 6869 6e74 7d20 270a 2020 2020  _in_hint} '.    
+00010ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f00: 6627 7374 6174 7573 3a20 7b63 6f6d 6d6f  f'status: {commo
+00010f10: 6e5f 7574 696c 732e 666f 726d 6174 5f65  n_utils.format_e
+00010f20: 7863 6570 7469 6f6e 2865 2c20 7573 655f  xception(e, use_
+00010f30: 6272 6163 6b65 743d 5472 7565 297d 270a  bracket=True)}'.
+00010f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f50: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00010f60: 2020 2020 7265 6769 6f6e 203d 2070 726f      region = pro
+00010f70: 7669 6465 725f 636f 6e66 6967 2e67 6574  vider_config.get
+00010f80: 2827 7265 6769 6f6e 2729 206f 7220 7072  ('region') or pr
+00010f90: 6f76 6964 6572 5f63 6f6e 6669 672e 6765  ovider_config.ge
+00010fa0: 7428 0a20 2020 2020 2020 2020 2020 2027  t(.            '
+00010fb0: 6c6f 6361 7469 6f6e 2729 0a20 2020 2020  location').     
+00010fc0: 2020 207a 6f6e 6520 3d20 7261 795f 636f     zone = ray_co
+00010fd0: 6e66 6967 5b27 7072 6f76 6964 6572 275d  nfig['provider']
+00010fe0: 2e67 6574 2827 6176 6169 6c61 6269 6c69  .get('availabili
+00010ff0: 7479 5f7a 6f6e 6527 290a 2020 2020 2020  ty_zone').      
+00011000: 2020 6e6f 6465 5f73 7461 7475 7365 7320    node_statuses 
+00011010: 3d20 636c 6f75 642e 7175 6572 795f 7374  = cloud.query_st
+00011020: 6174 7573 280a 2020 2020 2020 2020 2020  atus(.          
+00011030: 2020 636c 7573 7465 725f 6e61 6d65 5f6f    cluster_name_o
+00011040: 6e5f 636c 6f75 642c 0a20 2020 2020 2020  n_cloud,.       
+00011050: 2020 2020 2074 6167 5f66 696c 7465 725f       tag_filter_
+00011060: 666f 725f 636c 7573 7465 7228 636c 7573  for_cluster(clus
+00011070: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
+00011080: 6429 2c20 7265 6769 6f6e 2c20 7a6f 6e65  d), region, zone
+00011090: 290a 2020 2020 7265 7475 726e 206e 6f64  ).    return nod
+000110a0: 655f 7374 6174 7573 6573 0a0a 0a64 6566  e_statuses...def
+000110b0: 2063 6865 636b 5f63 616e 5f63 6c6f 6e65   check_can_clone
+000110c0: 5f64 6973 6b5f 616e 645f 6f76 6572 7269  _disk_and_overri
+000110d0: 6465 5f74 6173 6b28 0a20 2020 2063 6c75  de_task(.    clu
+000110e0: 7374 6572 5f6e 616d 653a 2073 7472 2c20  ster_name: str, 
+000110f0: 7461 7267 6574 5f63 6c75 7374 6572 5f6e  target_cluster_n
+00011100: 616d 653a 204f 7074 696f 6e61 6c5b 7374  ame: Optional[st
+00011110: 725d 2c20 7461 736b 3a20 2774 6173 6b5f  r], task: 'task_
+00011120: 6c69 622e 5461 736b 270a 2920 2d3e 2054  lib.Task'.) -> T
+00011130: 7570 6c65 5b27 7461 736b 5f6c 6962 2e54  uple['task_lib.T
+00011140: 6173 6b27 2c20 2763 6c6f 7564 5f76 6d5f  ask', 'cloud_vm_
+00011150: 7261 795f 6261 636b 656e 642e 436c 6f75  ray_backend.Clou
+00011160: 6456 6d52 6179 5265 736f 7572 6365 4861  dVmRayResourceHa
+00011170: 6e64 6c65 275d 3a0a 2020 2020 2222 2243  ndle']:.    """C
+00011180: 6865 636b 2069 6620 7468 6520 7461 736b  heck if the task
+00011190: 2069 7320 636f 6d70 6174 6962 6c65 2074   is compatible t
+000111a0: 6f20 636c 6f6e 6520 6469 736b 2066 726f  o clone disk fro
+000111b0: 6d20 7468 6520 736f 7572 6365 2063 6c75  m the source clu
+000111c0: 7374 6572 2e0a 0a20 2020 2041 7267 733a  ster...    Args:
+000111d0: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
+000111e0: 5f6e 616d 653a 2054 6865 206e 616d 6520  _name: The name 
+000111f0: 6f66 2074 6865 2063 6c75 7374 6572 2074  of the cluster t
+00011200: 6f20 636c 6f6e 6520 6469 736b 2066 726f  o clone disk fro
+00011210: 6d2e 0a20 2020 2020 2020 2074 6172 6765  m..        targe
+00011220: 745f 636c 7573 7465 725f 6e61 6d65 3a20  t_cluster_name: 
+00011230: 5468 6520 6e61 6d65 206f 6620 7468 6520  The name of the 
+00011240: 7461 7267 6574 2063 6c75 7374 6572 2e0a  target cluster..
+00011250: 2020 2020 2020 2020 7461 736b 3a20 5468          task: Th
+00011260: 6520 7461 736b 2074 6f20 6368 6563 6b2e  e task to check.
+00011270: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+00011280: 2020 2020 2020 2054 6865 2074 6173 6b20         The task 
+00011290: 746f 2075 7365 2061 6e64 2074 6865 2072  to use and the r
+000112a0: 6573 6f75 7263 6520 6861 6e64 6c65 206f  esource handle o
+000112b0: 6620 7468 6520 736f 7572 6365 2063 6c75  f the source clu
+000112c0: 7374 6572 2e0a 0a20 2020 2052 6169 7365  ster...    Raise
+000112d0: 733a 0a20 2020 2020 2020 2056 616c 7565  s:.        Value
+000112e0: 4572 726f 723a 2049 6620 7468 6520 736f  Error: If the so
+000112f0: 7572 6365 2063 6c75 7374 6572 2064 6f65  urce cluster doe
+00011300: 7320 6e6f 7420 6578 6973 742e 0a20 2020  s not exist..   
+00011310: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
+00011320: 4e6f 7453 7570 706f 7274 6564 4572 726f  NotSupportedErro
+00011330: 723a 2049 6620 7468 6520 736f 7572 6365  r: If the source
+00011340: 2063 6c75 7374 6572 2069 7320 6e6f 7420   cluster is not 
+00011350: 7661 6c69 6420 6f72 2074 6865 0a20 2020  valid or the.   
+00011360: 2020 2020 2020 2020 2074 6173 6b20 6973           task is
+00011370: 206e 6f74 2063 6f6d 7061 7469 626c 6520   not compatible 
+00011380: 746f 2063 6c6f 6e65 2064 6973 6b20 6672  to clone disk fr
+00011390: 6f6d 2074 6865 2073 6f75 7263 6520 636c  om the source cl
+000113a0: 7573 7465 722e 0a20 2020 2022 2222 0a20  uster..    """. 
+000113b0: 2020 2073 6f75 7263 655f 636c 7573 7465     source_cluste
+000113c0: 725f 7374 6174 7573 2c20 6861 6e64 6c65  r_status, handle
+000113d0: 203d 2072 6566 7265 7368 5f63 6c75 7374   = refresh_clust
+000113e0: 6572 5f73 7461 7475 735f 6861 6e64 6c65  er_status_handle
+000113f0: 2863 6c75 7374 6572 5f6e 616d 6529 0a20  (cluster_name). 
+00011400: 2020 2069 6620 736f 7572 6365 5f63 6c75     if source_clu
+00011410: 7374 6572 5f73 7461 7475 7320 6973 204e  ster_status is N
+00011420: 6f6e 653a 0a20 2020 2020 2020 2077 6974  one:.        wit
+00011430: 6820 7578 5f75 7469 6c73 2e70 7269 6e74  h ux_utils.print
+00011440: 5f65 7863 6570 7469 6f6e 5f6e 6f5f 7472  _exception_no_tr
+00011450: 6163 6562 6163 6b28 293a 0a20 2020 2020  aceback():.     
+00011460: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00011470: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
+00011480: 2020 2020 2020 2020 2066 2743 616e 6e6f           f'Canno
+00011490: 7420 6669 6e64 2063 6c75 7374 6572 207b  t find cluster {
+000114a0: 636c 7573 7465 725f 6e61 6d65 2172 7d20  cluster_name!r} 
+000114b0: 746f 2063 6c6f 6e65 2064 6973 6b20 6672  to clone disk fr
+000114c0: 6f6d 2e27 290a 0a20 2020 2069 6620 6e6f  om.')..    if no
+000114d0: 7420 6973 696e 7374 616e 6365 2868 616e  t isinstance(han
+000114e0: 646c 652c 2062 6163 6b65 6e64 732e 436c  dle, backends.Cl
+000114f0: 6f75 6456 6d52 6179 5265 736f 7572 6365  oudVmRayResource
+00011500: 4861 6e64 6c65 293a 0a20 2020 2020 2020  Handle):.       
+00011510: 2077 6974 6820 7578 5f75 7469 6c73 2e70   with ux_utils.p
+00011520: 7269 6e74 5f65 7863 6570 7469 6f6e 5f6e  rint_exception_n
+00011530: 6f5f 7472 6163 6562 6163 6b28 293a 0a20  o_traceback():. 
+00011540: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00011550: 2065 7863 6570 7469 6f6e 732e 4e6f 7453   exceptions.NotS
+00011560: 7570 706f 7274 6564 4572 726f 7228 0a20  upportedError(. 
+00011570: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00011580: 2743 616e 6e6f 7420 636c 6f6e 6520 6469  'Cannot clone di
+00011590: 736b 2066 726f 6d20 6120 6e6f 6e2d 636c  sk from a non-cl
+000115a0: 6f75 6420 636c 7573 7465 7220 7b63 6c75  oud cluster {clu
+000115b0: 7374 6572 5f6e 616d 6521 727d 2e27 290a  ster_name!r}.').
+000115c0: 0a20 2020 2069 6620 736f 7572 6365 5f63  .    if source_c
+000115d0: 6c75 7374 6572 5f73 7461 7475 7320 213d  luster_status !=
+000115e0: 2073 7461 7475 735f 6c69 622e 436c 7573   status_lib.Clus
+000115f0: 7465 7253 7461 7475 732e 5354 4f50 5045  terStatus.STOPPE
+00011600: 443a 0a20 2020 2020 2020 2077 6974 6820  D:.        with 
+00011610: 7578 5f75 7469 6c73 2e70 7269 6e74 5f65  ux_utils.print_e
+00011620: 7863 6570 7469 6f6e 5f6e 6f5f 7472 6163  xception_no_trac
+00011630: 6562 6163 6b28 293a 0a20 2020 2020 2020  eback():.       
+00011640: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
+00011650: 7469 6f6e 732e 4e6f 7453 7570 706f 7274  tions.NotSupport
+00011660: 6564 4572 726f 7228 0a20 2020 2020 2020  edError(.       
+00011670: 2020 2020 2020 2020 2066 2743 616e 6e6f           f'Canno
+00011680: 7420 636c 6f6e 6520 6469 736b 2066 726f  t clone disk fro
+00011690: 6d20 636c 7573 7465 7220 7b63 6c75 7374  m cluster {clust
+000116a0: 6572 5f6e 616d 6521 727d 2027 0a20 2020  er_name!r} '.   
+000116b0: 2020 2020 2020 2020 2020 2020 2066 2728               f'(
+000116c0: 7b73 6f75 7263 655f 636c 7573 7465 725f  {source_cluster_
+000116d0: 7374 6174 7573 2172 7d29 2e20 506c 6561  status!r}). Plea
+000116e0: 7365 2073 746f 7020 7468 6520 270a 2020  se stop the '.  
+000116f0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00011700: 636c 7573 7465 7220 6669 7273 743a 2073  cluster first: s
+00011710: 6b79 2073 746f 7020 7b63 6c75 7374 6572  ky stop {cluster
+00011720: 5f6e 616d 657d 2729 0a0a 2020 2020 6966  _name}')..    if
+00011730: 2074 6172 6765 745f 636c 7573 7465 725f   target_cluster_
+00011740: 6e61 6d65 2069 7320 6e6f 7420 4e6f 6e65  name is not None
+00011750: 3a0a 2020 2020 2020 2020 7461 7267 6574  :.        target
+00011760: 5f63 6c75 7374 6572 5f73 7461 7475 732c  _cluster_status,
+00011770: 205f 203d 2072 6566 7265 7368 5f63 6c75   _ = refresh_clu
+00011780: 7374 6572 5f73 7461 7475 735f 6861 6e64  ster_status_hand
+00011790: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
+000117a0: 7461 7267 6574 5f63 6c75 7374 6572 5f6e  target_cluster_n
+000117b0: 616d 6529 0a20 2020 2020 2020 2069 6620  ame).        if 
+000117c0: 7461 7267 6574 5f63 6c75 7374 6572 5f73  target_cluster_s
+000117d0: 7461 7475 7320 6973 206e 6f74 204e 6f6e  tatus is not Non
+000117e0: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
+000117f0: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
+00011800: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
+00011810: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
+00011820: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00011830: 7365 2065 7863 6570 7469 6f6e 732e 4e6f  se exceptions.No
+00011840: 7453 7570 706f 7274 6564 4572 726f 7228  tSupportedError(
+00011850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011860: 2020 2020 2066 2754 6865 2074 6172 6765       f'The targe
+00011870: 7420 636c 7573 7465 7220 7b74 6172 6765  t cluster {targe
+00011880: 745f 636c 7573 7465 725f 6e61 6d65 2172  t_cluster_name!r
+00011890: 7d20 616c 7265 6164 7920 6578 6973 7473  } already exists
+000118a0: 2e20 436c 6f6e 696e 6720 270a 2020 2020  . Cloning '.    
+000118b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000118c0: 2764 6973 6b20 6973 206f 6e6c 7920 7375  'disk is only su
+000118d0: 7070 6f72 7465 6420 7768 656e 2063 7265  pported when cre
+000118e0: 6174 696e 6720 6120 6e65 7720 636c 7573  ating a new clus
+000118f0: 7465 722e 2054 6f20 6669 783a 2073 7065  ter. To fix: spe
+00011900: 6369 6679 2027 0a20 2020 2020 2020 2020  cify '.         
+00011910: 2020 2020 2020 2020 2020 2027 6120 6e65             'a ne
+00011920: 7720 7461 7267 6574 2063 6c75 7374 6572  w target cluster
+00011930: 206e 616d 652e 2729 0a0a 2020 2020 6e65   name.')..    ne
+00011940: 775f 7461 736b 5f72 6573 6f75 7263 6573  w_task_resources
+00011950: 203d 205b 5d0a 2020 2020 6f72 6967 696e   = [].    origin
+00011960: 616c 5f63 6c6f 7564 203d 2068 616e 646c  al_cloud = handl
+00011970: 652e 6c61 756e 6368 6564 5f72 6573 6f75  e.launched_resou
+00011980: 7263 6573 2e63 6c6f 7564 0a20 2020 206f  rces.cloud.    o
+00011990: 7269 6769 6e61 6c5f 636c 6f75 642e 6368  riginal_cloud.ch
+000119a0: 6563 6b5f 6665 6174 7572 6573 5f61 7265  eck_features_are
+000119b0: 5f73 7570 706f 7274 6564 280a 2020 2020  _supported(.    
+000119c0: 2020 2020 6861 6e64 6c65 2e6c 6175 6e63      handle.launc
+000119d0: 6865 645f 7265 736f 7572 6365 732c 0a20  hed_resources,. 
+000119e0: 2020 2020 2020 207b 636c 6f75 6473 2e43         {clouds.C
+000119f0: 6c6f 7564 496d 706c 656d 656e 7461 7469  loudImplementati
+00011a00: 6f6e 4665 6174 7572 6573 2e43 4c4f 4e45  onFeatures.CLONE
+00011a10: 5f44 4953 4b5f 4652 4f4d 5f43 4c55 5354  _DISK_FROM_CLUST
+00011a20: 4552 7d29 0a0a 2020 2020 6173 7365 7274  ER})..    assert
+00011a30: 206f 7269 6769 6e61 6c5f 636c 6f75 6420   original_cloud 
+00011a40: 6973 206e 6f74 204e 6f6e 652c 2068 616e  is not None, han
+00011a50: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
+00011a60: 6f75 7263 6573 0a20 2020 2068 6173 5f6f  ources.    has_o
+00011a70: 7665 7272 6964 6520 3d20 4661 6c73 650a  verride = False.
+00011a80: 2020 2020 6861 735f 6469 736b 5f73 697a      has_disk_siz
+00011a90: 655f 6d65 7420 3d20 4661 6c73 650a 2020  e_met = False.  
+00011aa0: 2020 6861 735f 636c 6f75 645f 6d65 7420    has_cloud_met 
+00011ab0: 3d20 4661 6c73 650a 2020 2020 666f 7220  = False.    for 
+00011ac0: 7461 736b 5f72 6573 6f75 7263 6573 2069  task_resources i
+00011ad0: 6e20 7461 736b 2e72 6573 6f75 7263 6573  n task.resources
+00011ae0: 3a0a 2020 2020 2020 2020 6966 2068 616e  :.        if han
+00011af0: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
+00011b00: 6f75 7263 6573 2e64 6973 6b5f 7369 7a65  ources.disk_size
+00011b10: 203e 2074 6173 6b5f 7265 736f 7572 6365   > task_resource
+00011b20: 732e 6469 736b 5f73 697a 653a 0a20 2020  s.disk_size:.   
+00011b30: 2020 2020 2020 2020 2023 2054 6865 2074           # The t
+00011b40: 6172 6765 7420 636c 7573 7465 7227 7320  arget cluster's 
+00011b50: 6469 736b 2073 686f 756c 6420 6265 2061  disk should be a
+00011b60: 7420 6c65 6173 7420 6173 206c 6172 6765  t least as large
+00011b70: 2061 7320 7468 6520 736f 7572 6365 2e0a   as the source..
+00011b80: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00011b90: 696e 7565 0a20 2020 2020 2020 2068 6173  inue.        has
+00011ba0: 5f64 6973 6b5f 7369 7a65 5f6d 6574 203d  _disk_size_met =
+00011bb0: 2054 7275 650a 2020 2020 2020 2020 6966   True.        if
+00011bc0: 2074 6173 6b5f 7265 736f 7572 6365 732e   task_resources.
+00011bd0: 636c 6f75 6420 6973 206e 6f74 204e 6f6e  cloud is not Non
+00011be0: 6520 616e 6420 6e6f 7420 6f72 6967 696e  e and not origin
+00011bf0: 616c 5f63 6c6f 7564 2e69 735f 7361 6d65  al_cloud.is_same
+00011c00: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
+00011c10: 2020 2020 2020 2020 7461 736b 5f72 6573          task_res
+00011c20: 6f75 7263 6573 2e63 6c6f 7564 293a 0a20  ources.cloud):. 
+00011c30: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00011c40: 6e75 650a 2020 2020 2020 2020 6861 735f  nue.        has_
+00011c50: 636c 6f75 645f 6d65 7420 3d20 5472 7565  cloud_met = True
+00011c60: 0a0a 2020 2020 2020 2020 6f76 6572 7269  ..        overri
+00011c70: 6465 5f70 6172 616d 203d 207b 7d0a 2020  de_param = {}.  
+00011c80: 2020 2020 2020 6966 2074 6173 6b5f 7265        if task_re
+00011c90: 736f 7572 6365 732e 636c 6f75 6420 6973  sources.cloud is
+00011ca0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00011cb0: 2020 206f 7665 7272 6964 655f 7061 7261     override_para
+00011cc0: 6d5b 2763 6c6f 7564 275d 203d 206f 7269  m['cloud'] = ori
+00011cd0: 6769 6e61 6c5f 636c 6f75 640a 2020 2020  ginal_cloud.    
+00011ce0: 2020 2020 6966 2074 6173 6b5f 7265 736f      if task_reso
+00011cf0: 7572 6365 732e 7265 6769 6f6e 2069 7320  urces.region is 
+00011d00: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00011d10: 2020 6f76 6572 7269 6465 5f70 6172 616d    override_param
+00011d20: 5b27 7265 6769 6f6e 275d 203d 2068 616e  ['region'] = han
+00011d30: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
+00011d40: 6f75 7263 6573 2e72 6567 696f 6e0a 0a20  ources.region.. 
+00011d50: 2020 2020 2020 2069 6620 6f76 6572 7269         if overri
+00011d60: 6465 5f70 6172 616d 3a0a 2020 2020 2020  de_param:.      
+00011d70: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+00011d80: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
+00011d90: 2020 2066 274e 6f20 636c 6f75 642f 7265     f'No cloud/re
+00011da0: 6769 6f6e 2073 7065 6369 6669 6564 2066  gion specified f
+00011db0: 6f72 2074 6865 2074 6173 6b20 7b74 6173  or the task {tas
+00011dc0: 6b5f 7265 736f 7572 6365 737d 2e20 5573  k_resources}. Us
+00011dd0: 696e 6720 7468 6520 7361 6d65 2072 6567  ing the same reg
+00011de0: 696f 6e20 270a 2020 2020 2020 2020 2020  ion '.          
+00011df0: 2020 2020 2020 6627 6173 2073 6f75 7263        f'as sourc
+00011e00: 6520 636c 7573 7465 7220 7b63 6c75 7374  e cluster {clust
+00011e10: 6572 5f6e 616d 6521 727d 3a20 270a 2020  er_name!r}: '.  
+00011e20: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00011e30: 7b68 616e 646c 652e 6c61 756e 6368 6564  {handle.launched
+00011e40: 5f72 6573 6f75 7263 6573 2e63 6c6f 7564  _resources.cloud
+00011e50: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+00011e60: 2020 2066 2728 7b68 616e 646c 652e 6c61     f'({handle.la
+00011e70: 756e 6368 6564 5f72 6573 6f75 7263 6573  unched_resources
+00011e80: 2e72 6567 696f 6e7d 292e 2729 0a20 2020  .region}).').   
+00011e90: 2020 2020 2020 2020 2068 6173 5f6f 7665           has_ove
+00011ea0: 7272 6964 6520 3d20 5472 7565 0a20 2020  rride = True.   
+00011eb0: 2020 2020 2074 6173 6b5f 7265 736f 7572       task_resour
+00011ec0: 6365 7320 3d20 7461 736b 5f72 6573 6f75  ces = task_resou
+00011ed0: 7263 6573 2e63 6f70 7928 2a2a 6f76 6572  rces.copy(**over
+00011ee0: 7269 6465 5f70 6172 616d 290a 2020 2020  ride_param).    
+00011ef0: 2020 2020 6e65 775f 7461 736b 5f72 6573      new_task_res
+00011f00: 6f75 7263 6573 2e61 7070 656e 6428 7461  ources.append(ta
+00011f10: 736b 5f72 6573 6f75 7263 6573 290a 0a20  sk_resources).. 
+00011f20: 2020 2069 6620 6e6f 7420 6e65 775f 7461     if not new_ta
+00011f30: 736b 5f72 6573 6f75 7263 6573 3a0a 2020  sk_resources:.  
+00011f40: 2020 2020 2020 6966 206e 6f74 2068 6173        if not has
+00011f50: 5f64 6973 6b5f 7369 7a65 5f6d 6574 3a0a  _disk_size_met:.
+00011f60: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00011f70: 2075 785f 7574 696c 732e 7072 696e 745f   ux_utils.print_
+00011f80: 6578 6365 7074 696f 6e5f 6e6f 5f74 7261  exception_no_tra
+00011f90: 6365 6261 636b 2829 3a0a 2020 2020 2020  ceback():.      
+00011fa0: 2020 2020 2020 2020 2020 7461 7267 6574            target
+00011fb0: 5f63 6c75 7374 6572 5f6e 616d 655f 7374  _cluster_name_st
+00011fc0: 7220 3d20 6627 207b 7461 7267 6574 5f63  r = f' {target_c
+00011fd0: 6c75 7374 6572 5f6e 616d 6521 727d 270a  luster_name!r}'.
+00011fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ff0: 6966 2074 6172 6765 745f 636c 7573 7465  if target_cluste
+00012000: 725f 6e61 6d65 2069 7320 4e6f 6e65 3a0a  r_name is None:.
+00012010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012020: 2020 2020 7461 7267 6574 5f63 6c75 7374      target_clust
+00012030: 6572 5f6e 616d 655f 7374 7220 3d20 2727  er_name_str = ''
+00012040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012050: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
+00012060: 732e 4e6f 7453 7570 706f 7274 6564 4572  s.NotSupportedEr
+00012070: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00012080: 2020 2020 2020 2020 2066 2754 6865 2074           f'The t
+00012090: 6172 6765 7420 636c 7573 7465 727b 7461  arget cluster{ta
+000120a0: 7267 6574 5f63 6c75 7374 6572 5f6e 616d  rget_cluster_nam
+000120b0: 655f 7374 727d 2073 686f 756c 6420 6861  e_str} should ha
+000120c0: 7665 2061 2064 6973 6b20 7369 7a65 2027  ve a disk size '
+000120d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000120e0: 2020 2020 2066 276f 6620 6174 206c 6561       f'of at lea
+000120f0: 7374 207b 6861 6e64 6c65 2e6c 6175 6e63  st {handle.launc
+00012100: 6865 645f 7265 736f 7572 6365 732e 6469  hed_resources.di
+00012110: 736b 5f73 697a 657d 2047 4220 746f 2063  sk_size} GB to c
+00012120: 6c6f 6e65 2074 6865 2027 0a20 2020 2020  lone the '.     
+00012130: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00012140: 2764 6973 6b20 6672 6f6d 207b 636c 7573  'disk from {clus
+00012150: 7465 725f 6e61 6d65 2172 7d2e 2729 0a20  ter_name!r}.'). 
+00012160: 2020 2020 2020 2069 6620 6e6f 7420 6861         if not ha
+00012170: 735f 636c 6f75 645f 6d65 743a 0a20 2020  s_cloud_met:.   
+00012180: 2020 2020 2020 2020 2074 6173 6b5f 7265           task_re
+00012190: 736f 7572 6365 735f 636c 6f75 645f 7374  sources_cloud_st
+000121a0: 7220 3d20 275b 2720 2b20 272c 272e 6a6f  r = '[' + ','.jo
+000121b0: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
+000121c0: 2020 2020 5b66 277b 7265 732e 636c 6f75      [f'{res.clou
+000121d0: 647d 2720 666f 7220 7265 7320 696e 2074  d}' for res in t
+000121e0: 6173 6b2e 7265 736f 7572 6365 735d 2920  ask.resources]) 
+000121f0: 2b20 275d 270a 2020 2020 2020 2020 2020  + ']'.          
+00012200: 2020 7461 736b 5f72 6573 6f75 7263 6573    task_resources
+00012210: 5f73 7472 203d 2027 5b27 202b 2027 2c27  _str = '[' + ','
+00012220: 2e6a 6f69 6e28 0a20 2020 2020 2020 2020  .join(.         
+00012230: 2020 2020 2020 205b 6627 7b72 6573 7d27         [f'{res}'
+00012240: 2066 6f72 2072 6573 2069 6e20 7461 736b   for res in task
+00012250: 2e72 6573 6f75 7263 6573 5d29 202b 2027  .resources]) + '
+00012260: 5d27 0a20 2020 2020 2020 2020 2020 2077  ]'.            w
+00012270: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
+00012280: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
+00012290: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
+000122a0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+000122b0: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
+000122c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122d0: 2020 2066 2743 616e 6e6f 7420 636c 6f6e     f'Cannot clon
+000122e0: 6520 6469 736b 2061 6372 6f73 7320 636c  e disk across cl
+000122f0: 6f75 6420 6672 6f6d 207b 6f72 6967 696e  oud from {origin
+00012300: 616c 5f63 6c6f 7564 7d20 746f 2027 0a20  al_cloud} to '. 
+00012310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012320: 2020 2066 277b 7461 736b 5f72 6573 6f75     f'{task_resou
+00012330: 7263 6573 5f63 6c6f 7564 5f73 7472 7d20  rces_cloud_str} 
+00012340: 666f 7220 7265 736f 7572 6365 7320 7b74  for resources {t
+00012350: 6173 6b5f 7265 736f 7572 6365 735f 7374  ask_resources_st
+00012360: 727d 2e27 0a20 2020 2020 2020 2020 2020  r}.'.           
+00012370: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
+00012380: 7373 6572 7420 4661 6c73 652c 2027 5368  ssert False, 'Sh
+00012390: 6f75 6c64 206e 6f74 2072 6561 6368 2068  ould not reach h
+000123a0: 6572 652e 270a 2020 2020 2320 7365 7420  ere.'.    # set 
+000123b0: 7468 6520 6e65 775f 7461 736b 5f72 6573  the new_task_res
+000123c0: 6f75 7263 6573 2074 6f20 6265 2074 6865  ources to be the
+000123d0: 2073 616d 6520 7479 7065 2028 6c69 7374   same type (list
+000123e0: 206f 7220 7365 7429 2061 7320 7468 650a   or set) as the.
+000123f0: 2020 2020 2320 6f72 6967 696e 616c 2074      # original t
+00012400: 6173 6b2e 7265 736f 7572 6365 730a 2020  ask.resources.  
+00012410: 2020 6966 2068 6173 5f6f 7665 7272 6964    if has_overrid
+00012420: 653a 0a20 2020 2020 2020 2074 6173 6b2e  e:.        task.
+00012430: 7365 745f 7265 736f 7572 6365 7328 7479  set_resources(ty
+00012440: 7065 2874 6173 6b2e 7265 736f 7572 6365  pe(task.resource
+00012450: 7329 286e 6577 5f74 6173 6b5f 7265 736f  s)(new_task_reso
+00012460: 7572 6365 7329 290a 2020 2020 2020 2020  urces)).        
+00012470: 2320 5265 7365 7420 7468 6520 6265 7374  # Reset the best
+00012480: 5f72 6573 6f75 7263 6573 2074 6f20 7472  _resources to tr
+00012490: 6967 6572 2072 652d 6f70 7469 6d69 7a61  iger re-optimiza
+000124a0: 7469 6f6e 0a20 2020 2020 2020 2023 206c  tion.        # l
+000124b0: 6174 6572 2c20 736f 2074 6861 7420 7468  ater, so that th
+000124c0: 6520 6e65 7720 7461 736b 5f72 6573 6f75  e new task_resou
+000124d0: 7263 6573 2077 696c 6c20 6265 2075 7365  rces will be use
+000124e0: 642e 0a20 2020 2020 2020 2074 6173 6b2e  d..        task.
+000124f0: 6265 7374 5f72 6573 6f75 7263 6573 203d  best_resources =
+00012500: 204e 6f6e 650a 2020 2020 7265 7475 726e   None.    return
+00012510: 2074 6173 6b2c 2068 616e 646c 650a 0a0a   task, handle...
+00012520: 6465 6620 5f75 7064 6174 655f 636c 7573  def _update_clus
+00012530: 7465 725f 7374 6174 7573 5f6e 6f5f 6c6f  ter_status_no_lo
+00012540: 636b 280a 2020 2020 2020 2020 636c 7573  ck(.        clus
+00012550: 7465 725f 6e61 6d65 3a20 7374 7229 202d  ter_name: str) -
+00012560: 3e20 4f70 7469 6f6e 616c 5b44 6963 745b  > Optional[Dict[
+00012570: 7374 722c 2041 6e79 5d5d 3a0a 2020 2020  str, Any]]:.    
+00012580: 2222 2255 7064 6174 6573 2074 6865 2073  """Updates the s
+00012590: 7461 7475 7320 6f66 2074 6865 2063 6c75  tatus of the clu
+000125a0: 7374 6572 2e0a 0a20 2020 2052 6169 7365  ster...    Raise
+000125b0: 733a 0a20 2020 2020 2020 2065 7863 6570  s:.        excep
+000125c0: 7469 6f6e 732e 436c 7573 7465 7253 7461  tions.ClusterSta
+000125d0: 7475 7346 6574 6368 696e 6745 7272 6f72  tusFetchingError
+000125e0: 3a20 7468 6520 636c 7573 7465 7220 7374  : the cluster st
+000125f0: 6174 7573 2063 616e 6e6f 7420 6265 0a20  atus cannot be. 
+00012600: 2020 2020 2020 2020 2066 6574 6368 6564           fetched
+00012610: 2066 726f 6d20 7468 6520 636c 6f75 6420   from the cloud 
+00012620: 7072 6f76 6964 6572 2e0a 2020 2020 2222  provider..    ""
+00012630: 220a 2020 2020 7265 636f 7264 203d 2067  ".    record = g
+00012640: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
+00012650: 2e67 6574 5f63 6c75 7374 6572 5f66 726f  .get_cluster_fro
+00012660: 6d5f 6e61 6d65 2863 6c75 7374 6572 5f6e  m_name(cluster_n
+00012670: 616d 6529 0a20 2020 2069 6620 7265 636f  ame).    if reco
+00012680: 7264 2069 7320 4e6f 6e65 3a0a 2020 2020  rd is None:.    
+00012690: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
+000126a0: 2020 2020 6861 6e64 6c65 203d 2072 6563      handle = rec
+000126b0: 6f72 645b 2768 616e 646c 6527 5d0a 2020  ord['handle'].  
+000126c0: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+000126d0: 6e63 6528 6861 6e64 6c65 2c20 6261 636b  nce(handle, back
+000126e0: 656e 6473 2e43 6c6f 7564 566d 5261 7952  ends.CloudVmRayR
+000126f0: 6573 6f75 7263 6548 616e 646c 6529 3a0a  esourceHandle):.
+00012700: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00012710: 6563 6f72 640a 2020 2020 636c 7573 7465  ecord.    cluste
+00012720: 725f 6e61 6d65 203d 2068 616e 646c 652e  r_name = handle.
+00012730: 636c 7573 7465 725f 6e61 6d65 0a0a 2020  cluster_name..  
+00012740: 2020 6e6f 6465 5f73 7461 7475 7365 7320    node_statuses 
+00012750: 3d20 5f71 7565 7279 5f63 6c75 7374 6572  = _query_cluster
+00012760: 5f73 7461 7475 735f 7669 615f 636c 6f75  _status_via_clou
+00012770: 645f 6170 6928 6861 6e64 6c65 290a 0a20  d_api(handle).. 
+00012780: 2020 2061 6c6c 5f6e 6f64 6573 5f75 7020     all_nodes_up 
+00012790: 3d20 2861 6c6c 280a 2020 2020 2020 2020  = (all(.        
+000127a0: 7374 6174 7573 203d 3d20 7374 6174 7573  status == status
+000127b0: 5f6c 6962 2e43 6c75 7374 6572 5374 6174  _lib.ClusterStat
+000127c0: 7573 2e55 5020 666f 7220 7374 6174 7573  us.UP for status
+000127d0: 2069 6e20 6e6f 6465 5f73 7461 7475 7365   in node_statuse
+000127e0: 7329 2061 6e64 0a20 2020 2020 2020 2020  s) and.         
+000127f0: 2020 2020 2020 2020 2020 206c 656e 286e             len(n
+00012800: 6f64 655f 7374 6174 7573 6573 2920 3d3d  ode_statuses) ==
+00012810: 2068 616e 646c 652e 6c61 756e 6368 6564   handle.launched
+00012820: 5f6e 6f64 6573 290a 0a20 2020 2064 6566  _nodes)..    def
+00012830: 2072 756e 5f72 6179 5f73 7461 7475 735f   run_ray_status_
+00012840: 746f 5f63 6865 636b 5f72 6179 5f63 6c75  to_check_ray_clu
+00012850: 7374 6572 5f68 6561 6c74 6879 2829 202d  ster_healthy() -
+00012860: 3e20 626f 6f6c 3a0a 2020 2020 2020 2020  > bool:.        
+00012870: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00012880: 2023 2054 4f44 4f28 7a68 7775 293a 2054   # TODO(zhwu): T
+00012890: 6869 7320 6675 6e63 7469 6f6e 2063 616e  his function can
+000128a0: 6e6f 7420 6469 7374 696e 6775 6973 6820  not distinguish 
+000128b0: 7472 616e 7369 656e 7420 6e65 7477 6f72  transient networ
+000128c0: 6b0a 2020 2020 2020 2020 2020 2020 2320  k.            # 
+000128d0: 6572 726f 7220 696e 2072 6179 2773 2067  error in ray's g
+000128e0: 6574 2049 5073 2076 732e 2072 6179 2072  et IPs vs. ray r
+000128f0: 756e 7469 6d65 2066 6169 6c69 6e67 2e0a  untime failing..
+00012900: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
+00012910: 4f54 453a 2066 6574 6368 696e 6720 7468  OTE: fetching th
+00012920: 6520 4950 7320 6973 2076 6572 7920 736c  e IPs is very sl
+00012930: 6f77 2061 7320 6974 2063 616c 6c73 2069  ow as it calls i
+00012940: 6e74 6f0a 2020 2020 2020 2020 2020 2020  nto.            
+00012950: 2320 6072 6179 2067 6574 2068 6561 642d  # `ray get head-
+00012960: 6970 2f77 6f72 6b65 722d 6970 7360 2e20  ip/worker-ips`. 
+00012970: 5573 696e 6720 6361 6368 6564 2049 5073  Using cached IPs
+00012980: 2069 7320 7361 6665 2062 6563 6175 7365   is safe because
+00012990: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
+000129a0: 6e20 7468 6520 776f 7273 7420 6361 7365  n the worst case
+000129b0: 2077 6520 7469 6d65 206f 7574 2069 6e20   we time out in 
+000129c0: 7468 6520 6072 6179 2073 7461 7475 7360  the `ray status`
+000129d0: 2053 5348 2063 6f6d 6d61 6e64 0a20 2020   SSH command.   
+000129e0: 2020 2020 2020 2020 2023 2062 656c 6f77           # below
+000129f0: 2e0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
+00012a00: 7465 726e 616c 5f69 7073 203d 2068 616e  ternal_ips = han
+00012a10: 646c 652e 6361 6368 6564 5f65 7874 6572  dle.cached_exter
+00012a20: 6e61 6c5f 6970 730a 2020 2020 2020 2020  nal_ips.        
+00012a30: 2020 2020 2320 5468 6973 2068 6170 7065      # This happe
+00012a40: 6e73 2077 6865 6e20 7573 6572 2069 6e74  ns when user int
+00012a50: 6572 7275 7074 2074 6865 2060 736b 7920  errupt the `sky 
+00012a60: 6c61 756e 6368 6020 7072 6f63 6573 7320  launch` process 
+00012a70: 6265 666f 7265 0a20 2020 2020 2020 2020  before.         
+00012a80: 2020 2023 2074 6865 2066 6972 7374 2074     # the first t
+00012a90: 696d 6520 7265 736f 7572 6365 7320 6861  ime resources ha
+00012aa0: 6e64 6c65 2069 7320 7772 6974 7465 6e20  ndle is written 
+00012ab0: 6261 636b 2074 6f20 6c6f 6361 6c20 6461  back to local da
+00012ac0: 7461 6261 7365 2e0a 2020 2020 2020 2020  tabase..        
+00012ad0: 2020 2020 2320 5468 6973 2069 7320 6865      # This is he
+00012ae0: 6c70 6675 6c20 7768 656e 2075 7365 7220  lpful when user 
+00012af0: 696e 7465 7272 7570 7420 6166 7465 7220  interrupt after 
+00012b00: 7468 6520 7072 6f76 6973 696f 6e20 6973  the provision is
+00012b10: 2064 6f6e 650a 2020 2020 2020 2020 2020   done.          
+00012b20: 2020 2320 616e 6420 6265 666f 7265 2074    # and before t
+00012b30: 6865 2073 6b79 6c65 7420 6973 2072 6573  he skylet is res
+00012b40: 7461 7274 6564 2e20 4166 7465 7220 2332  tarted. After #2
+00012b50: 3330 3420 6973 206d 6572 6765 642c 2074  304 is merged, t
+00012b60: 6869 730a 2020 2020 2020 2020 2020 2020  his.            
+00012b70: 2320 6865 6c70 7320 6b65 6570 2074 6865  # helps keep the
+00012b80: 2063 6c75 7374 6572 2073 7461 7475 7320   cluster status 
+00012b90: 746f 2049 4e49 5420 6166 7465 7220 6073  to INIT after `s
+00012ba0: 6b79 2073 7461 7475 7320 2d72 602c 2073  ky status -r`, s
+00012bb0: 6f0a 2020 2020 2020 2020 2020 2020 2320  o.            # 
+00012bc0: 7573 6572 2077 696c 6c20 6265 206e 6f74  user will be not
+00012bd0: 6966 6965 6420 7468 6174 2061 6e79 2061  ified that any a
+00012be0: 7574 6f20 7374 6f70 2f64 6f77 6e20 6d69  uto stop/down mi
+00012bf0: 6768 7420 6e6f 7420 6265 0a20 2020 2020  ght not be.     
+00012c00: 2020 2020 2020 2023 2074 7269 6767 6572         # trigger
+00012c10: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00012c20: 6966 2065 7874 6572 6e61 6c5f 6970 7320  if external_ips 
+00012c30: 6973 204e 6f6e 6520 6f72 206c 656e 2865  is None or len(e
+00012c40: 7874 6572 6e61 6c5f 6970 7329 203d 3d20  xternal_ips) == 
+00012c50: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00012c60: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00012c70: 6627 5265 6672 6573 6869 6e67 2073 7461  f'Refreshing sta
+00012c80: 7475 7320 287b 636c 7573 7465 725f 6e61  tus ({cluster_na
+00012c90: 6d65 2172 7d29 3a20 4e6f 2063 6163 6865  me!r}): No cache
+00012ca0: 6420 270a 2020 2020 2020 2020 2020 2020  d '.            
+00012cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012cc0: 2066 2749 5073 2066 6f75 6e64 2e20 4861   f'IPs found. Ha
+00012cd0: 6e64 6c65 3a20 7b68 616e 646c 657d 2729  ndle: {handle}')
+00012ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012cf0: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
+00012d00: 732e 4665 7463 6849 5045 7272 6f72 280a  s.FetchIPError(.
+00012d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d20: 2020 2020 7265 6173 6f6e 3d65 7863 6570      reason=excep
+00012d30: 7469 6f6e 732e 4665 7463 6849 5045 7272  tions.FetchIPErr
+00012d40: 6f72 2e52 6561 736f 6e2e 4845 4144 290a  or.Reason.HEAD).
+00012d50: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
+00012d60: 6f74 656e 7469 616c 6c79 2072 6566 7265  otentially refre
+00012d70: 7368 2074 6865 2065 7874 6572 6e61 6c20  sh the external 
+00012d80: 5353 4820 706f 7274 732c 2069 6e20 6361  SSH ports, in ca
+00012d90: 7365 2074 6865 2065 7869 7374 696e 670a  se the existing.
+00012da0: 2020 2020 2020 2020 2020 2020 2320 636c              # cl
+00012db0: 7573 7465 7220 6265 666f 7265 2023 3234  uster before #24
+00012dc0: 3931 2077 6173 206c 6175 6e63 6865 6420  91 was launched 
+00012dd0: 7769 7468 6f75 7420 6578 7465 726e 616c  without external
+00012de0: 2053 5348 2070 6f72 7473 0a20 2020 2020   SSH ports.     
+00012df0: 2020 2020 2020 2023 2063 6163 6865 642e         # cached.
+00012e00: 0a20 2020 2020 2020 2020 2020 2065 7874  .            ext
+00012e10: 6572 6e61 6c5f 7373 685f 706f 7274 7320  ernal_ssh_ports 
+00012e20: 3d20 6861 6e64 6c65 2e65 7874 6572 6e61  = handle.externa
+00012e30: 6c5f 7373 685f 706f 7274 7328 290a 2020  l_ssh_ports().  
+00012e40: 2020 2020 2020 2020 2020 6865 6164 5f73            head_s
+00012e50: 7368 5f70 6f72 7420 3d20 6578 7465 726e  sh_port = extern
+00012e60: 616c 5f73 7368 5f70 6f72 7473 5b30 5d0a  al_ssh_ports[0].
+00012e70: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+00012e80: 6865 636b 2069 6620 7261 7920 636c 7573  heck if ray clus
+00012e90: 7465 7220 7374 6174 7573 2069 7320 6865  ter status is he
+00012ea0: 616c 7468 792e 0a20 2020 2020 2020 2020  althy..         
+00012eb0: 2020 2073 7368 5f63 7265 6465 6e74 6961     ssh_credentia
+00012ec0: 6c73 203d 2073 7368 5f63 7265 6465 6e74  ls = ssh_credent
+00012ed0: 6961 6c5f 6672 6f6d 5f79 616d 6c28 6861  ial_from_yaml(ha
+00012ee0: 6e64 6c65 2e63 6c75 7374 6572 5f79 616d  ndle.cluster_yam
+00012ef0: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
+00012f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00012f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f30: 2020 2020 2020 2020 2020 2068 616e 646c             handl
-00012f40: 652e 646f 636b 6572 5f75 7365 722c 0a20  e.docker_user,. 
+00012f20: 2020 2020 2020 2020 2020 6861 6e64 6c65            handle
+00012f30: 2e64 6f63 6b65 725f 7573 6572 2c0a 2020  .docker_user,.  
+00012f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00012f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00012f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f80: 2020 2020 2020 6861 6e64 6c65 2e73 7368        handle.ssh
-00012f90: 5f75 7365 7229 0a0a 2020 2020 2020 2020  _user)..        
-00012fa0: 2020 2020 7275 6e6e 6572 203d 2063 6f6d      runner = com
-00012fb0: 6d61 6e64 5f72 756e 6e65 722e 5353 4843  mand_runner.SSHC
-00012fc0: 6f6d 6d61 6e64 5275 6e6e 6572 2865 7874  ommandRunner(ext
-00012fd0: 6572 6e61 6c5f 6970 735b 305d 2c0a 2020  ernal_ips[0],.  
+00012f70: 2020 2020 2068 616e 646c 652e 7373 685f       handle.ssh_
+00012f80: 7573 6572 290a 0a20 2020 2020 2020 2020  user)..         
+00012f90: 2020 2072 756e 6e65 7220 3d20 636f 6d6d     runner = comm
+00012fa0: 616e 645f 7275 6e6e 6572 2e53 5348 436f  and_runner.SSHCo
+00012fb0: 6d6d 616e 6452 756e 6e65 7228 6578 7465  mmandRunner(exte
+00012fc0: 726e 616c 5f69 7073 5b30 5d2c 0a20 2020  rnal_ips[0],.   
+00012fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00012fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00012ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013010: 2020 202a 2a73 7368 5f63 7265 6465 6e74     **ssh_credent
-00013020: 6961 6c73 2c0a 2020 2020 2020 2020 2020  ials,.          
+00013000: 2020 2a2a 7373 685f 6372 6564 656e 7469    **ssh_credenti
+00013010: 616c 732c 0a20 2020 2020 2020 2020 2020  als,.           
+00013020: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00013030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013050: 2020 2020 2020 2020 2020 2070 6f72 743d             port=
-00013060: 6865 6164 5f73 7368 5f70 6f72 7429 0a20  head_ssh_port). 
-00013070: 2020 2020 2020 2020 2020 2072 632c 206f             rc, o
-00013080: 7574 7075 742c 2073 7464 6572 7220 3d20  utput, stderr = 
-00013090: 7275 6e6e 6572 2e72 756e 280a 2020 2020  runner.run(.    
-000130a0: 2020 2020 2020 2020 2020 2020 696e 7374              inst
-000130b0: 616e 6365 5f73 6574 7570 2e52 4159 5f53  ance_setup.RAY_S
-000130c0: 5441 5455 535f 5749 5448 5f53 4b59 5f52  TATUS_WITH_SKY_R
-000130d0: 4159 5f50 4f52 545f 434f 4d4d 414e 442c  AY_PORT_COMMAND,
-000130e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000130f0: 2073 7472 6561 6d5f 6c6f 6773 3d46 616c   stream_logs=Fal
-00013100: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-00013110: 2020 2020 7265 7175 6972 655f 6f75 7470      require_outp
-00013120: 7574 733d 5472 7565 2c0a 2020 2020 2020  uts=True,.      
-00013130: 2020 2020 2020 2020 2020 7365 7061 7261            separa
-00013140: 7465 5f73 7464 6572 723d 5472 7565 290a  te_stderr=True).
-00013150: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-00013160: 633a 0a20 2020 2020 2020 2020 2020 2020  c:.             
-00013170: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-00013180: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-00013190: 2020 2020 2020 2020 2020 2066 2752 6566             f'Ref
-000131a0: 7265 7368 696e 6720 7374 6174 7573 2028  reshing status (
-000131b0: 7b63 6c75 7374 6572 5f6e 616d 6521 727d  {cluster_name!r}
-000131c0: 293a 2046 6169 6c65 6420 746f 2063 6865  ): Failed to che
-000131d0: 636b 2027 0a20 2020 2020 2020 2020 2020  ck '.           
-000131e0: 2020 2020 2020 2020 2066 2772 6179 2063           f'ray c
-000131f0: 6c75 7374 6572 5c27 7320 6865 616c 7468  luster\'s health
-00013200: 696e 6573 7320 7769 7468 2027 0a20 2020  iness with '.   
-00013210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013220: 2066 277b 696e 7374 616e 6365 5f73 6574   f'{instance_set
-00013230: 7570 2e52 4159 5f53 5441 5455 535f 5749  up.RAY_STATUS_WI
-00013240: 5448 5f53 4b59 5f52 4159 5f50 4f52 545f  TH_SKY_RAY_PORT_
-00013250: 434f 4d4d 414e 447d 2e5c 6e27 0a20 2020  COMMAND}.\n'.   
-00013260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013270: 2066 272d 2d20 7374 646f 7574 202d 2d5c   f'-- stdout --\
-00013280: 6e7b 6f75 7470 7574 7d5c 6e2d 2d20 7374  n{output}\n-- st
-00013290: 6465 7272 202d 2d5c 6e7b 7374 6465 7272  derr --\n{stderr
-000132a0: 7d27 290a 0a20 2020 2020 2020 2020 2020  }')..           
-000132b0: 2072 6561 6479 5f68 6561 642c 2072 6561   ready_head, rea
-000132c0: 6479 5f77 6f72 6b65 7273 203d 205f 636f  dy_workers = _co
-000132d0: 756e 745f 6865 616c 7468 795f 6e6f 6465  unt_healthy_node
-000132e0: 735f 6672 6f6d 5f72 6179 286f 7574 7075  s_from_ray(outpu
-000132f0: 7429 0a20 2020 2020 2020 2020 2020 2074  t).            t
-00013300: 6f74 616c 5f6e 6f64 6573 203d 2068 616e  otal_nodes = han
-00013310: 646c 652e 6c61 756e 6368 6564 5f6e 6f64  dle.launched_nod
-00013320: 6573 202a 2068 616e 646c 652e 6e75 6d5f  es * handle.num_
-00013330: 6970 735f 7065 725f 6e6f 6465 0a20 2020  ips_per_node.   
-00013340: 2020 2020 2020 2020 2069 6620 7265 6164           if read
-00013350: 795f 6865 6164 202b 2072 6561 6479 5f77  y_head + ready_w
-00013360: 6f72 6b65 7273 203d 3d20 746f 7461 6c5f  orkers == total_
-00013370: 6e6f 6465 733a 0a20 2020 2020 2020 2020  nodes:.         
-00013380: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-00013390: 7565 0a20 2020 2020 2020 2020 2020 2072  ue.            r
-000133a0: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
-000133b0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-000133c0: 2020 2066 2752 6566 7265 7368 696e 6720     f'Refreshing 
-000133d0: 7374 6174 7573 2028 7b63 6c75 7374 6572  status ({cluster
-000133e0: 5f6e 616d 6521 727d 293a 2072 6179 2073  _name!r}): ray s
-000133f0: 7461 7475 7320 6e6f 7420 7368 6f77 696e  tatus not showin
-00013400: 6720 270a 2020 2020 2020 2020 2020 2020  g '.            
-00013410: 2020 2020 6627 616c 6c20 6e6f 6465 7320      f'all nodes 
-00013420: 287b 7265 6164 795f 6865 6164 202b 2072  ({ready_head + r
-00013430: 6561 6479 5f77 6f72 6b65 7273 7d2f 270a  eady_workers}/'.
-00013440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013450: 6627 7b74 6f74 616c 5f6e 6f64 6573 7d29  f'{total_nodes})
-00013460: 3b20 6f75 7470 7574 3a20 7b6f 7574 7075  ; output: {outpu
-00013470: 747d 3b20 7374 6465 7272 3a20 7b73 7464  t}; stderr: {std
-00013480: 6572 727d 2729 0a20 2020 2020 2020 2065  err}').        e
-00013490: 7863 6570 7420 6578 6365 7074 696f 6e73  xcept exceptions
-000134a0: 2e46 6574 6368 4950 4572 726f 723a 0a20  .FetchIPError:. 
-000134b0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-000134c0: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
-000134d0: 2020 2020 2020 2020 2066 2752 6566 7265           f'Refre
-000134e0: 7368 696e 6720 7374 6174 7573 2028 7b63  shing status ({c
-000134f0: 6c75 7374 6572 5f6e 616d 6521 727d 2920  luster_name!r}) 
-00013500: 6661 696c 6564 2074 6f20 6765 7420 4950  failed to get IP
-00013510: 732e 2729 0a20 2020 2020 2020 2065 7863  s.').        exc
-00013520: 6570 7420 5275 6e74 696d 6545 7272 6f72  ept RuntimeError
-00013530: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-00013540: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-00013550: 7374 7228 6529 290a 2020 2020 2020 2020  str(e)).        
-00013560: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00013570: 2061 7320 653a 2020 2320 7079 6c69 6e74   as e:  # pylint
-00013580: 3a20 6469 7361 626c 653d 6272 6f61 642d  : disable=broad-
-00013590: 6578 6365 7074 0a20 2020 2020 2020 2020  except.         
-000135a0: 2020 2023 2054 6869 7320 6361 6e20 6265     # This can be
-000135b0: 2072 6169 7365 6420 6279 2060 6578 7465   raised by `exte
-000135c0: 726e 616c 5f73 7368 5f70 6f72 7473 2829  rnal_ssh_ports()
-000135d0: 602c 2064 7565 2074 6f20 7468 650a 2020  `, due to the.  
-000135e0: 2020 2020 2020 2020 2020 2320 756e 6465            # unde
-000135f0: 726c 7969 6e67 2063 616c 6c20 746f 206b  rlying call to k
-00013600: 7562 6572 6e65 7465 7320 4150 492e 0a20  ubernetes API.. 
-00013610: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00013620: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
-00013630: 2020 2020 2020 2020 2066 2752 6566 7265           f'Refre
-00013640: 7368 696e 6720 7374 6174 7573 2028 7b63  shing status ({c
-00013650: 6c75 7374 6572 5f6e 616d 6521 727d 2920  luster_name!r}) 
-00013660: 6661 696c 6564 3a20 270a 2020 2020 2020  failed: '.      
-00013670: 2020 2020 2020 2020 2020 6627 7b63 6f6d            f'{com
-00013680: 6d6f 6e5f 7574 696c 732e 666f 726d 6174  mon_utils.format
-00013690: 5f65 7863 6570 7469 6f6e 2865 2c20 7573  _exception(e, us
-000136a0: 655f 6272 6163 6b65 743d 5472 7565 297d  e_bracket=True)}
-000136b0: 2729 0a20 2020 2020 2020 2072 6574 7572  ').        retur
-000136c0: 6e20 4661 6c73 650a 0a20 2020 2023 2044  n False..    # D
-000136d0: 6574 6572 6d69 6e69 6e67 2069 6620 7468  etermining if th
-000136e0: 6520 636c 7573 7465 7220 6973 2068 6561  e cluster is hea
-000136f0: 6c74 6879 2028 5550 293a 0a20 2020 2023  lthy (UP):.    #
-00013700: 0a20 2020 2023 2046 6f72 206e 6f6e 2d73  .    # For non-s
-00013710: 706f 7420 636c 7573 7465 7273 3a20 4966  pot clusters: If
-00013720: 2072 6179 2073 7461 7475 7320 7368 6f77   ray status show
-00013730: 7320 616c 6c20 6e6f 6465 7320 6172 6520  s all nodes are 
-00013740: 6865 616c 7468 792c 2069 7420 6973 0a20  healthy, it is. 
-00013750: 2020 2023 2073 6166 6520 746f 2073 6574     # safe to set
-00013760: 2074 6865 2073 7461 7475 7320 746f 2055   the status to U
-00013770: 5020 6173 2073 7461 7274 696e 6720 7261  P as starting ra
-00013780: 7920 6973 2074 6865 2066 696e 616c 2073  y is the final s
-00013790: 7465 7020 6f66 2073 6b79 0a20 2020 2023  tep of sky.    #
-000137a0: 206c 6175 6e63 682e 2042 7574 2077 6520   launch. But we 
-000137b0: 666f 756e 6420 7468 6174 2072 6179 2073  found that ray s
-000137c0: 7461 7475 7320 6973 2077 6179 2074 6f6f  tatus is way too
-000137d0: 2073 6c6f 7720 2873 6565 204e 4f54 4520   slow (see NOTE 
-000137e0: 6265 6c6f 7729 2073 6f0a 2020 2020 2320  below) so.    # 
-000137f0: 7765 2061 6c77 6179 7320 7175 6572 7920  we always query 
-00013800: 7468 6520 636c 6f75 6420 7072 6f76 6964  the cloud provid
-00013810: 6572 2066 6972 7374 2077 6869 6368 2069  er first which i
-00013820: 7320 6661 7374 6572 2e0a 2020 2020 230a  s faster..    #.
-00013830: 2020 2020 2320 466f 7220 7370 6f74 2063      # For spot c
-00013840: 6c75 7374 6572 733a 2074 6865 2061 626f  lusters: the abo
-00013850: 7665 2063 616e 2062 6520 756e 7361 6665  ve can be unsafe
-00013860: 2062 6563 6175 7365 2074 6865 2052 6179   because the Ray
-00013870: 2063 6c75 7374 6572 206d 6179 0a20 2020   cluster may.   
-00013880: 2023 2072 656d 6169 6e20 6865 616c 7468   # remain health
-00013890: 7920 666f 7220 6120 7768 696c 6520 6265  y for a while be
-000138a0: 666f 7265 2074 6865 2063 6c6f 7564 2063  fore the cloud c
-000138b0: 6f6d 706c 6574 656c 7920 7072 6565 6d70  ompletely preemp
-000138c0: 7473 2074 6865 2056 4d73 2e0a 2020 2020  ts the VMs..    
-000138d0: 2320 5765 2068 6176 6520 6d69 7469 6761  # We have mitiga
-000138e0: 7465 6420 7468 6973 2062 7920 6167 6169  ted this by agai
-000138f0: 6e20 6669 7273 7420 7175 6572 7969 6e67  n first querying
-00013900: 2074 6865 2056 4d20 7374 6174 6520 6672   the VM state fr
-00013910: 6f6d 2074 6865 2063 6c6f 7564 0a20 2020  om the cloud.   
-00013920: 2023 2070 726f 7669 6465 722e 0a20 2020   # provider..   
-00013930: 2069 6620 616c 6c5f 6e6f 6465 735f 7570   if all_nodes_up
-00013940: 2061 6e64 2072 756e 5f72 6179 5f73 7461   and run_ray_sta
-00013950: 7475 735f 746f 5f63 6865 636b 5f72 6179  tus_to_check_ray
-00013960: 5f63 6c75 7374 6572 5f68 6561 6c74 6879  _cluster_healthy
-00013970: 2829 3a0a 2020 2020 2020 2020 2320 4e4f  ():.        # NO
-00013980: 5445 3a20 616c 6c5f 6e6f 6465 735f 7570  TE: all_nodes_up
-00013990: 2063 616c 6375 6c61 7469 6f6e 2069 7320   calculation is 
-000139a0: 6661 7374 2064 7565 2074 6f20 6361 6c6c  fast due to call
-000139b0: 696e 6720 636c 6f75 6420 434c 493b 0a20  ing cloud CLI;. 
-000139c0: 2020 2020 2020 2023 2072 756e 5f72 6179         # run_ray
-000139d0: 5f73 7461 7475 735f 746f 5f63 6865 636b  _status_to_check
-000139e0: 5f61 6c6c 5f6e 6f64 6573 5f75 7028 2920  _all_nodes_up() 
-000139f0: 6973 2073 6c6f 7720 6475 6520 746f 2063  is slow due to c
-00013a00: 616c 6c69 6e67 2060 7261 7920 6765 740a  alling `ray get.
-00013a10: 2020 2020 2020 2020 2320 6865 6164 2d69          # head-i
-00013a20: 702f 776f 726b 6572 2d69 7073 602e 0a20  p/worker-ips`.. 
-00013a30: 2020 2020 2020 2072 6563 6f72 645b 2773         record['s
-00013a40: 7461 7475 7327 5d20 3d20 7374 6174 7573  tatus'] = status
-00013a50: 5f6c 6962 2e43 6c75 7374 6572 5374 6174  _lib.ClusterStat
-00013a60: 7573 2e55 500a 2020 2020 2020 2020 676c  us.UP.        gl
-00013a70: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
-00013a80: 6164 645f 6f72 5f75 7064 6174 655f 636c  add_or_update_cl
-00013a90: 7573 7465 7228 636c 7573 7465 725f 6e61  uster(cluster_na
-00013aa0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00013040: 2020 2020 2020 2020 2020 706f 7274 3d68            port=h
+00013050: 6561 645f 7373 685f 706f 7274 290a 2020  ead_ssh_port).  
+00013060: 2020 2020 2020 2020 2020 7263 2c20 6f75            rc, ou
+00013070: 7470 7574 2c20 7374 6465 7272 203d 2072  tput, stderr = r
+00013080: 756e 6e65 722e 7275 6e28 0a20 2020 2020  unner.run(.     
+00013090: 2020 2020 2020 2020 2020 2069 6e73 7461             insta
+000130a0: 6e63 655f 7365 7475 702e 5241 595f 5354  nce_setup.RAY_ST
+000130b0: 4154 5553 5f57 4954 485f 534b 595f 5241  ATUS_WITH_SKY_RA
+000130c0: 595f 504f 5254 5f43 4f4d 4d41 4e44 2c0a  Y_PORT_COMMAND,.
+000130d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000130e0: 7374 7265 616d 5f6c 6f67 733d 4661 6c73  stream_logs=Fals
+000130f0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00013100: 2020 2072 6571 7569 7265 5f6f 7574 7075     require_outpu
+00013110: 7473 3d54 7275 652c 0a20 2020 2020 2020  ts=True,.       
+00013120: 2020 2020 2020 2020 2073 6570 6172 6174           separat
+00013130: 655f 7374 6465 7272 3d54 7275 6529 0a20  e_stderr=True). 
+00013140: 2020 2020 2020 2020 2020 2069 6620 7263             if rc
+00013150: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00013160: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+00013170: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00013180: 2020 2020 2020 2020 2020 6627 5265 6672            f'Refr
+00013190: 6573 6869 6e67 2073 7461 7475 7320 287b  eshing status ({
+000131a0: 636c 7573 7465 725f 6e61 6d65 2172 7d29  cluster_name!r})
+000131b0: 3a20 4661 696c 6564 2074 6f20 6368 6563  : Failed to chec
+000131c0: 6b20 270a 2020 2020 2020 2020 2020 2020  k '.            
+000131d0: 2020 2020 2020 2020 6627 7261 7920 636c          f'ray cl
+000131e0: 7573 7465 725c 2773 2068 6561 6c74 6869  uster\'s healthi
+000131f0: 6e65 7373 2077 6974 6820 270a 2020 2020  ness with '.    
+00013200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013210: 6627 7b69 6e73 7461 6e63 655f 7365 7475  f'{instance_setu
+00013220: 702e 5241 595f 5354 4154 5553 5f57 4954  p.RAY_STATUS_WIT
+00013230: 485f 534b 595f 5241 595f 504f 5254 5f43  H_SKY_RAY_PORT_C
+00013240: 4f4d 4d41 4e44 7d2e 5c6e 270a 2020 2020  OMMAND}.\n'.    
+00013250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013260: 6627 2d2d 2073 7464 6f75 7420 2d2d 5c6e  f'-- stdout --\n
+00013270: 7b6f 7574 7075 747d 5c6e 2d2d 2073 7464  {output}\n-- std
+00013280: 6572 7220 2d2d 5c6e 7b73 7464 6572 727d  err --\n{stderr}
+00013290: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+000132a0: 7265 6164 795f 6865 6164 2c20 7265 6164  ready_head, read
+000132b0: 795f 776f 726b 6572 7320 3d20 5f63 6f75  y_workers = _cou
+000132c0: 6e74 5f68 6561 6c74 6879 5f6e 6f64 6573  nt_healthy_nodes
+000132d0: 5f66 726f 6d5f 7261 7928 6f75 7470 7574  _from_ray(output
+000132e0: 290a 2020 2020 2020 2020 2020 2020 746f  ).            to
+000132f0: 7461 6c5f 6e6f 6465 7320 3d20 6861 6e64  tal_nodes = hand
+00013300: 6c65 2e6c 6175 6e63 6865 645f 6e6f 6465  le.launched_node
+00013310: 7320 2a20 6861 6e64 6c65 2e6e 756d 5f69  s * handle.num_i
+00013320: 7073 5f70 6572 5f6e 6f64 650a 2020 2020  ps_per_node.    
+00013330: 2020 2020 2020 2020 6966 2072 6561 6479          if ready
+00013340: 5f68 6561 6420 2b20 7265 6164 795f 776f  _head + ready_wo
+00013350: 726b 6572 7320 3d3d 2074 6f74 616c 5f6e  rkers == total_n
+00013360: 6f64 6573 3a0a 2020 2020 2020 2020 2020  odes:.          
+00013370: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+00013380: 650a 2020 2020 2020 2020 2020 2020 7261  e.            ra
+00013390: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
+000133a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000133b0: 2020 6627 5265 6672 6573 6869 6e67 2073    f'Refreshing s
+000133c0: 7461 7475 7320 287b 636c 7573 7465 725f  tatus ({cluster_
+000133d0: 6e61 6d65 2172 7d29 3a20 7261 7920 7374  name!r}): ray st
+000133e0: 6174 7573 206e 6f74 2073 686f 7769 6e67  atus not showing
+000133f0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00013400: 2020 2066 2761 6c6c 206e 6f64 6573 2028     f'all nodes (
+00013410: 7b72 6561 6479 5f68 6561 6420 2b20 7265  {ready_head + re
+00013420: 6164 795f 776f 726b 6572 737d 2f27 0a20  ady_workers}/'. 
+00013430: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00013440: 277b 746f 7461 6c5f 6e6f 6465 737d 293b  '{total_nodes});
+00013450: 206f 7574 7075 743a 207b 6f75 7470 7574   output: {output
+00013460: 7d3b 2073 7464 6572 723a 207b 7374 6465  }; stderr: {stde
+00013470: 7272 7d27 290a 2020 2020 2020 2020 6578  rr}').        ex
+00013480: 6365 7074 2065 7863 6570 7469 6f6e 732e  cept exceptions.
+00013490: 4665 7463 6849 5045 7272 6f72 3a0a 2020  FetchIPError:.  
+000134a0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+000134b0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+000134c0: 2020 2020 2020 2020 6627 5265 6672 6573          f'Refres
+000134d0: 6869 6e67 2073 7461 7475 7320 287b 636c  hing status ({cl
+000134e0: 7573 7465 725f 6e61 6d65 2172 7d29 2066  uster_name!r}) f
+000134f0: 6169 6c65 6420 746f 2067 6574 2049 5073  ailed to get IPs
+00013500: 2e27 290a 2020 2020 2020 2020 6578 6365  .').        exce
+00013510: 7074 2052 756e 7469 6d65 4572 726f 7220  pt RuntimeError 
+00013520: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00013530: 2020 6c6f 6767 6572 2e64 6562 7567 2873    logger.debug(s
+00013540: 7472 2865 2929 0a20 2020 2020 2020 2065  tr(e)).        e
+00013550: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00013560: 6173 2065 3a20 2023 2070 796c 696e 743a  as e:  # pylint:
+00013570: 2064 6973 6162 6c65 3d62 726f 6164 2d65   disable=broad-e
+00013580: 7863 6570 740a 2020 2020 2020 2020 2020  xcept.          
+00013590: 2020 2320 5468 6973 2063 616e 2062 6520    # This can be 
+000135a0: 7261 6973 6564 2062 7920 6065 7874 6572  raised by `exter
+000135b0: 6e61 6c5f 7373 685f 706f 7274 7328 2960  nal_ssh_ports()`
+000135c0: 2c20 6475 6520 746f 2074 6865 0a20 2020  , due to the.   
+000135d0: 2020 2020 2020 2020 2023 2075 6e64 6572           # under
+000135e0: 6c79 696e 6720 6361 6c6c 2074 6f20 6b75  lying call to ku
+000135f0: 6265 726e 6574 6573 2041 5049 2e0a 2020  bernetes API..  
+00013600: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00013610: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00013620: 2020 2020 2020 2020 6627 5265 6672 6573          f'Refres
+00013630: 6869 6e67 2073 7461 7475 7320 287b 636c  hing status ({cl
+00013640: 7573 7465 725f 6e61 6d65 2172 7d29 2066  uster_name!r}) f
+00013650: 6169 6c65 643a 2027 0a20 2020 2020 2020  ailed: '.       
+00013660: 2020 2020 2020 2020 2066 277b 636f 6d6d           f'{comm
+00013670: 6f6e 5f75 7469 6c73 2e66 6f72 6d61 745f  on_utils.format_
+00013680: 6578 6365 7074 696f 6e28 652c 2075 7365  exception(e, use
+00013690: 5f62 7261 636b 6574 3d54 7275 6529 7d27  _bracket=True)}'
+000136a0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+000136b0: 2046 616c 7365 0a0a 2020 2020 2320 4465   False..    # De
+000136c0: 7465 726d 696e 696e 6720 6966 2074 6865  termining if the
+000136d0: 2063 6c75 7374 6572 2069 7320 6865 616c   cluster is heal
+000136e0: 7468 7920 2855 5029 3a0a 2020 2020 230a  thy (UP):.    #.
+000136f0: 2020 2020 2320 466f 7220 6e6f 6e2d 7370      # For non-sp
+00013700: 6f74 2063 6c75 7374 6572 733a 2049 6620  ot clusters: If 
+00013710: 7261 7920 7374 6174 7573 2073 686f 7773  ray status shows
+00013720: 2061 6c6c 206e 6f64 6573 2061 7265 2068   all nodes are h
+00013730: 6561 6c74 6879 2c20 6974 2069 730a 2020  ealthy, it is.  
+00013740: 2020 2320 7361 6665 2074 6f20 7365 7420    # safe to set 
+00013750: 7468 6520 7374 6174 7573 2074 6f20 5550  the status to UP
+00013760: 2061 7320 7374 6172 7469 6e67 2072 6179   as starting ray
+00013770: 2069 7320 7468 6520 6669 6e61 6c20 7374   is the final st
+00013780: 6570 206f 6620 736b 790a 2020 2020 2320  ep of sky.    # 
+00013790: 6c61 756e 6368 2e20 4275 7420 7765 2066  launch. But we f
+000137a0: 6f75 6e64 2074 6861 7420 7261 7920 7374  ound that ray st
+000137b0: 6174 7573 2069 7320 7761 7920 746f 6f20  atus is way too 
+000137c0: 736c 6f77 2028 7365 6520 4e4f 5445 2062  slow (see NOTE b
+000137d0: 656c 6f77 2920 736f 0a20 2020 2023 2077  elow) so.    # w
+000137e0: 6520 616c 7761 7973 2071 7565 7279 2074  e always query t
+000137f0: 6865 2063 6c6f 7564 2070 726f 7669 6465  he cloud provide
+00013800: 7220 6669 7273 7420 7768 6963 6820 6973  r first which is
+00013810: 2066 6173 7465 722e 0a20 2020 2023 0a20   faster..    #. 
+00013820: 2020 2023 2046 6f72 2073 706f 7420 636c     # For spot cl
+00013830: 7573 7465 7273 3a20 7468 6520 6162 6f76  usters: the abov
+00013840: 6520 6361 6e20 6265 2075 6e73 6166 6520  e can be unsafe 
+00013850: 6265 6361 7573 6520 7468 6520 5261 7920  because the Ray 
+00013860: 636c 7573 7465 7220 6d61 790a 2020 2020  cluster may.    
+00013870: 2320 7265 6d61 696e 2068 6561 6c74 6879  # remain healthy
+00013880: 2066 6f72 2061 2077 6869 6c65 2062 6566   for a while bef
+00013890: 6f72 6520 7468 6520 636c 6f75 6420 636f  ore the cloud co
+000138a0: 6d70 6c65 7465 6c79 2070 7265 656d 7074  mpletely preempt
+000138b0: 7320 7468 6520 564d 732e 0a20 2020 2023  s the VMs..    #
+000138c0: 2057 6520 6861 7665 206d 6974 6967 6174   We have mitigat
+000138d0: 6564 2074 6869 7320 6279 2061 6761 696e  ed this by again
+000138e0: 2066 6972 7374 2071 7565 7279 696e 6720   first querying 
+000138f0: 7468 6520 564d 2073 7461 7465 2066 726f  the VM state fro
+00013900: 6d20 7468 6520 636c 6f75 640a 2020 2020  m the cloud.    
+00013910: 2320 7072 6f76 6964 6572 2e0a 2020 2020  # provider..    
+00013920: 6966 2061 6c6c 5f6e 6f64 6573 5f75 7020  if all_nodes_up 
+00013930: 616e 6420 7275 6e5f 7261 795f 7374 6174  and run_ray_stat
+00013940: 7573 5f74 6f5f 6368 6563 6b5f 7261 795f  us_to_check_ray_
+00013950: 636c 7573 7465 725f 6865 616c 7468 7928  cluster_healthy(
+00013960: 293a 0a20 2020 2020 2020 2023 204e 4f54  ):.        # NOT
+00013970: 453a 2061 6c6c 5f6e 6f64 6573 5f75 7020  E: all_nodes_up 
+00013980: 6361 6c63 756c 6174 696f 6e20 6973 2066  calculation is f
+00013990: 6173 7420 6475 6520 746f 2063 616c 6c69  ast due to calli
+000139a0: 6e67 2063 6c6f 7564 2043 4c49 3b0a 2020  ng cloud CLI;.  
+000139b0: 2020 2020 2020 2320 7275 6e5f 7261 795f        # run_ray_
+000139c0: 7374 6174 7573 5f74 6f5f 6368 6563 6b5f  status_to_check_
+000139d0: 616c 6c5f 6e6f 6465 735f 7570 2829 2069  all_nodes_up() i
+000139e0: 7320 736c 6f77 2064 7565 2074 6f20 6361  s slow due to ca
+000139f0: 6c6c 696e 6720 6072 6179 2067 6574 0a20  lling `ray get. 
+00013a00: 2020 2020 2020 2023 2068 6561 642d 6970         # head-ip
+00013a10: 2f77 6f72 6b65 722d 6970 7360 2e0a 2020  /worker-ips`..  
+00013a20: 2020 2020 2020 7265 636f 7264 5b27 7374        record['st
+00013a30: 6174 7573 275d 203d 2073 7461 7475 735f  atus'] = status_
+00013a40: 6c69 622e 436c 7573 7465 7253 7461 7475  lib.ClusterStatu
+00013a50: 732e 5550 0a20 2020 2020 2020 2067 6c6f  s.UP.        glo
+00013a60: 6261 6c5f 7573 6572 5f73 7461 7465 2e61  bal_user_state.a
+00013a70: 6464 5f6f 725f 7570 6461 7465 5f63 6c75  dd_or_update_clu
+00013a80: 7374 6572 2863 6c75 7374 6572 5f6e 616d  ster(cluster_nam
+00013a90: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00013aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00013ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ad0: 2020 2020 6861 6e64 6c65 2c0a 2020 2020      handle,.    
+00013ac0: 2020 2068 616e 646c 652c 0a20 2020 2020     handle,.     
+00013ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00013ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b00: 2020 2020 2020 2020 2020 2020 7265 7175              requ
-00013b10: 6573 7465 645f 7265 736f 7572 6365 733d  ested_resources=
-00013b20: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00013af0: 2020 2020 2020 2020 2020 2072 6571 7565             reque
+00013b00: 7374 6564 5f72 6573 6f75 7263 6573 3d4e  sted_resources=N
+00013b10: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00013b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00013b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b50: 2020 2020 2020 7265 6164 793d 5472 7565        ready=True
-00013b60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013b40: 2020 2020 2072 6561 6479 3d54 7275 652c       ready=True,
+00013b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00013b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b90: 2020 6973 5f6c 6175 6e63 683d 4661 6c73    is_launch=Fals
-00013ba0: 6529 0a20 2020 2020 2020 2072 6574 7572  e).        retur
-00013bb0: 6e20 7265 636f 7264 0a0a 2020 2020 2320  n record..    # 
-00013bc0: 416c 6c20 6361 7365 7320 6265 6c6f 7720  All cases below 
-00013bd0: 6172 6520 7472 616e 7369 7469 6f6e 696e  are transitionin
-00013be0: 6720 7468 6520 636c 7573 7465 7220 746f  g the cluster to
-00013bf0: 206e 6f6e 2d55 5020 7374 6174 6573 2e0a   non-UP states..
-00013c00: 2020 2020 6966 206c 656e 286e 6f64 655f      if len(node_
-00013c10: 7374 6174 7573 6573 2920 3e20 6861 6e64  statuses) > hand
-00013c20: 6c65 2e6c 6175 6e63 6865 645f 6e6f 6465  le.launched_node
-00013c30: 733a 0a20 2020 2020 2020 2023 2055 6e65  s:.        # Une
-00013c40: 7870 6563 7465 643a 2069 6e20 7468 6520  xpected: in the 
-00013c50: 7175 6572 6965 6420 7265 6769 6f6e 206d  queried region m
-00013c60: 6f72 6520 7468 616e 2031 2063 6c75 7374  ore than 1 clust
-00013c70: 6572 2077 6974 6820 7468 6520 7361 6d65  er with the same
-00013c80: 0a20 2020 2020 2020 2023 2063 6f6e 7374  .        # const
-00013c90: 7275 6374 6564 206e 616d 6520 7461 6720  ructed name tag 
-00013ca0: 7265 7475 726e 6564 2e20 5468 6973 2077  returned. This w
-00013cb0: 696c 6c20 7479 7069 6361 6c6c 7920 6e6f  ill typically no
-00013cc0: 7420 6861 7070 656e 2075 6e6c 6573 730a  t happen unless.
-00013cd0: 2020 2020 2020 2020 2320 7573 6572 7320          # users 
-00013ce0: 6d61 6e75 616c 6c79 2063 7265 6174 6520  manually create 
-00013cf0: 6120 636c 7573 7465 7220 7769 7468 2074  a cluster with t
-00013d00: 6861 7420 636f 6e73 7472 7563 7465 6420  hat constructed 
-00013d10: 6e61 6d65 206f 7220 7468 6572 650a 2020  name or there.  
-00013d20: 2020 2020 2020 2320 7761 7320 6120 7265        # was a re
-00013d30: 736f 7572 6365 206c 6561 6b20 6361 7573  source leak caus
-00013d40: 6564 2062 7920 6469 6666 6572 656e 7420  ed by different 
-00013d50: 6c61 756e 6368 2068 6173 6820 6265 666f  launch hash befo
-00013d60: 7265 2023 3136 3731 0a20 2020 2020 2020  re #1671.       
-00013d70: 2023 2077 6173 206d 6572 6765 642e 0a20   # was merged.. 
-00013d80: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
-00013d90: 2023 2028 5465 6368 6e69 6361 6c6c 7920   # (Technically 
-00013da0: 7370 6561 6b69 6e67 2c20 6576 656e 2069  speaking, even i
-00013db0: 6620 7265 7475 726e 6564 206e 756d 206e  f returned num n
-00013dc0: 6f64 6573 203c 3d20 6e75 6d0a 2020 2020  odes <= num.    
-00013dd0: 2020 2020 2320 6861 6e64 6c65 2e6c 6175      # handle.lau
-00013de0: 6e63 6865 645f 6e6f 6465 7329 2c20 6e6f  nched_nodes), no
-00013df0: 7420 696e 636c 7564 696e 6720 7468 6520  t including the 
-00013e00: 6c61 756e 6368 2068 6173 6820 636f 756c  launch hash coul
-00013e10: 6420 6d65 616e 2074 6865 0a20 2020 2020  d mean the.     
-00013e20: 2020 2023 2072 6574 7572 6e65 6420 6e6f     # returned no
-00013e30: 6465 7320 636f 6e74 6169 6e20 736f 6d65  des contain some
-00013e40: 206e 6f64 6573 2074 6861 7420 646f 206e   nodes that do n
-00013e50: 6f74 2062 656c 6f6e 6720 746f 2074 6865  ot belong to the
-00013e60: 206c 6f67 6963 616c 0a20 2020 2020 2020   logical.       
-00013e70: 2023 2073 6b79 7069 6c6f 7420 636c 7573   # skypilot clus
-00013e80: 7465 722e 2044 6f65 736e 2774 2073 6565  ter. Doesn't see
-00013e90: 6d20 746f 2062 6520 6120 676f 6f64 2077  m to be a good w
-00013ea0: 6179 2074 6f20 6861 6e64 6c65 2074 6869  ay to handle thi
-00013eb0: 7320 666f 720a 2020 2020 2020 2020 2320  s for.        # 
-00013ec0: 6e6f 773f 290a 2020 2020 2020 2020 230a  now?).        #.
-00013ed0: 2020 2020 2020 2020 2320 5765 2068 6176          # We hav
-00013ee0: 6520 6e6f 7420 6578 7065 7269 656e 6365  e not experience
-00013ef0: 6420 7468 6520 6162 6f76 653b 2061 6464  d the above; add
-00013f00: 696e 6720 6173 2061 2073 6166 6567 7561  ing as a safegua
-00013f10: 7264 2e0a 2020 2020 2020 2020 230a 2020  rd..        #.  
-00013f20: 2020 2020 2020 2320 5369 6e63 6520 7765        # Since we
-00013f30: 2066 6169 6c65 6420 746f 2072 6566 7265   failed to refre
-00013f40: 7368 2c20 7261 6973 6520 7468 6520 7374  sh, raise the st
-00013f50: 6174 7573 2066 6574 6368 696e 6720 6572  atus fetching er
-00013f60: 726f 722e 0a20 2020 2020 2020 2077 6974  ror..        wit
-00013f70: 6820 7578 5f75 7469 6c73 2e70 7269 6e74  h ux_utils.print
-00013f80: 5f65 7863 6570 7469 6f6e 5f6e 6f5f 7472  _exception_no_tr
-00013f90: 6163 6562 6163 6b28 293a 0a20 2020 2020  aceback():.     
-00013fa0: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
-00013fb0: 6570 7469 6f6e 732e 436c 7573 7465 7253  eptions.ClusterS
-00013fc0: 7461 7475 7346 6574 6368 696e 6745 7272  tatusFetchingErr
-00013fd0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00013fe0: 2020 2020 6627 466f 756e 6420 7b6c 656e      f'Found {len
-00013ff0: 286e 6f64 655f 7374 6174 7573 6573 297d  (node_statuses)}
-00014000: 206e 6f64 6528 7329 2077 6974 6820 7468   node(s) with th
-00014010: 6520 7361 6d65 2063 6c75 7374 6572 206e  e same cluster n
-00014020: 616d 6527 0a20 2020 2020 2020 2020 2020  ame'.           
-00014030: 2020 2020 2066 2720 7461 6720 696e 2074       f' tag in t
-00014040: 6865 2063 6c6f 7564 2070 726f 7669 6465  he cloud provide
-00014050: 7220 666f 7220 636c 7573 7465 7220 7b63  r for cluster {c
-00014060: 6c75 7374 6572 5f6e 616d 6521 727d 2c20  luster_name!r}, 
-00014070: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00014080: 2020 6627 7768 6963 6820 7368 6f75 6c64    f'which should
-00014090: 2068 6176 6520 7b68 616e 646c 652e 6c61   have {handle.la
-000140a0: 756e 6368 6564 5f6e 6f64 6573 7d20 6e6f  unched_nodes} no
-000140b0: 6465 732e 2054 6869 7320 270a 2020 2020  des. This '.    
-000140c0: 2020 2020 2020 2020 2020 2020 6627 6e6f              f'no
-000140d0: 726d 616c 6c79 2073 686f 756c 6420 6e6f  rmally should no
-000140e0: 7420 6861 7070 656e 2e20 7b63 6f6c 6f72  t happen. {color
-000140f0: 616d 612e 466f 7265 2e52 4544 7d50 6c65  ama.Fore.RED}Ple
-00014100: 6173 6520 6368 6563 6b20 270a 2020 2020  ase check '.    
-00014110: 2020 2020 2020 2020 2020 2020 2774 6865              'the
-00014120: 2063 6c6f 7564 2063 6f6e 736f 6c65 2061   cloud console a
-00014130: 6e64 2066 6978 2061 6e79 2070 6f73 7369  nd fix any possi
-00014140: 626c 6520 7265 736f 7572 6365 7320 6c65  ble resources le
-00014150: 616b 6167 6520 270a 2020 2020 2020 2020  akage '.        
-00014160: 2020 2020 2020 2020 2728 652e 672e 2c20          '(e.g., 
-00014170: 6966 2074 6865 7265 2061 7265 2061 6e79  if there are any
-00014180: 2073 746f 7070 6564 206e 6f64 6573 2061   stopped nodes a
-00014190: 6e64 2074 6865 7920 646f 206e 6f74 2068  nd they do not h
-000141a0: 6176 6520 270a 2020 2020 2020 2020 2020  ave '.          
-000141b0: 2020 2020 2020 2764 6174 6120 6f72 2061        'data or a
-000141c0: 7265 2075 6e68 6561 6c74 6879 2c20 7465  re unhealthy, te
-000141d0: 726d 696e 6174 6520 7468 656d 292e 270a  rminate them).'.
-000141e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000141f0: 6627 7b63 6f6c 6f72 616d 612e 5374 796c  f'{colorama.Styl
-00014200: 652e 5245 5345 545f 414c 4c7d 2729 0a20  e.RESET_ALL}'). 
-00014210: 2020 2061 7373 6572 7420 6c65 6e28 6e6f     assert len(no
-00014220: 6465 5f73 7461 7475 7365 7329 203c 3d20  de_statuses) <= 
-00014230: 6861 6e64 6c65 2e6c 6175 6e63 6865 645f  handle.launched_
-00014240: 6e6f 6465 730a 0a20 2020 2023 2049 6620  nodes..    # If 
-00014250: 7468 6520 6e6f 6465 5f73 7461 7475 7365  the node_statuse
-00014260: 7320 6973 2065 6d70 7479 2c20 616c 6c20  s is empty, all 
-00014270: 7468 6520 6e6f 6465 7320 6172 6520 7465  the nodes are te
-00014280: 726d 696e 6174 6564 2e20 5765 2063 616e  rminated. We can
-00014290: 0a20 2020 2023 2073 6166 656c 7920 7365  .    # safely se
-000142a0: 7420 7468 6520 636c 7573 7465 7220 7374  t the cluster st
-000142b0: 6174 7573 2074 6f20 5445 524d 494e 4154  atus to TERMINAT
-000142c0: 4544 2e20 5468 6973 2068 616e 646c 6573  ED. This handles
-000142d0: 2074 6865 2065 6467 6520 6361 7365 0a20   the edge case. 
-000142e0: 2020 2023 2077 6865 7265 2074 6865 2063     # where the c
-000142f0: 6c75 7374 6572 2069 7320 7465 726d 696e  luster is termin
-00014300: 6174 6564 2062 7920 7468 6520 7573 6572  ated by the user
-00014310: 206d 616e 7561 6c6c 7920 7468 726f 7567   manually throug
-00014320: 6820 7468 6520 5549 2e0a 2020 2020 746f  h the UI..    to
-00014330: 5f74 6572 6d69 6e61 7465 203d 206e 6f74  _terminate = not
-00014340: 206e 6f64 655f 7374 6174 7573 6573 0a0a   node_statuses..
-00014350: 2020 2020 2320 4120 636c 7573 7465 7220      # A cluster 
-00014360: 6973 2063 6f6e 7369 6465 7265 6420 2261  is considered "a
-00014370: 626e 6f72 6d61 6c22 2c20 6966 206e 6f74  bnormal", if not
-00014380: 2061 6c6c 206e 6f64 6573 2061 7265 2054   all nodes are T
-00014390: 4552 4d49 4e41 5445 4420 6f72 0a20 2020  ERMINATED or.   
-000143a0: 2023 206e 6f74 2061 6c6c 206e 6f64 6573   # not all nodes
-000143b0: 2061 7265 2053 544f 5050 4544 2e20 5765   are STOPPED. We
-000143c0: 2063 6865 636b 2074 6861 7420 7769 7468   check that with
-000143d0: 2074 6865 2066 6f6c 6c6f 7769 6e67 206c   the following l
-000143e0: 6f67 6963 3a0a 2020 2020 2320 2020 2a20  ogic:.    #   * 
-000143f0: 4e6f 7420 616c 6c20 6e6f 6465 7320 6172  Not all nodes ar
-00014400: 6520 7465 726d 696e 6174 6564 2061 6e64  e terminated and
-00014410: 2074 6865 7265 2773 2061 7420 6c65 6173   there's at leas
-00014420: 7420 6f6e 6520 6e6f 6465 0a20 2020 2023  t one node.    #
-00014430: 2020 2020 2074 6572 6d69 6e61 7465 643b       terminated;
-00014440: 206f 720a 2020 2020 2320 2020 2a20 416e   or.    #   * An
-00014450: 7920 6f66 2074 6865 206e 6f6e 2d54 4552  y of the non-TER
-00014460: 4d49 4e41 5445 4420 6e6f 6465 7320 6973  MINATED nodes is
-00014470: 2069 6e20 6120 6e6f 6e2d 5354 4f50 5045   in a non-STOPPE
-00014480: 4420 7374 6174 7573 2e0a 2020 2020 230a  D status..    #.
-00014490: 2020 2020 2320 5468 6973 2069 6e63 6c75      # This inclu
-000144a0: 6465 7320 7468 6573 6520 7370 6563 6961  des these specia
-000144b0: 6c20 6361 7365 733a 0a20 2020 2023 2020  l cases:.    #  
-000144c0: 202a 2041 6c6c 2073 746f 7070 6564 2061   * All stopped a
-000144d0: 7265 2063 6f6e 7369 6465 7265 6420 6e6f  re considered no
-000144e0: 726d 616c 2061 6e64 2077 696c 6c20 6265  rmal and will be
-000144f0: 2063 6c65 616e 6564 2075 7020 6174 2074   cleaned up at t
-00014500: 6865 2065 6e64 0a20 2020 2023 2020 2020  he end.    #    
-00014510: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
-00014520: 2e0a 2020 2020 2320 2020 2a20 536f 6d65  ..    #   * Some
-00014530: 206f 6620 7468 6520 6e6f 6465 7320 5550   of the nodes UP
-00014540: 2073 686f 756c 6420 6265 2063 6f6e 7369   should be consi
-00014550: 6465 7265 6420 6162 6e6f 726d 616c 2c20  dered abnormal, 
-00014560: 6265 6361 7573 6520 7468 6520 7261 790a  because the ray.
-00014570: 2020 2020 2320 2020 2020 636c 7573 7465      #     cluste
-00014580: 7220 6973 2070 726f 6261 626c 7920 646f  r is probably do
-00014590: 776e 2e0a 2020 2020 2320 2020 2a20 5468  wn..    #   * Th
-000145a0: 6520 636c 7573 7465 7220 6973 2070 6172  e cluster is par
-000145b0: 7469 616c 6c79 2074 6572 6d69 6e61 7465  tially terminate
-000145c0: 6420 6f72 2073 746f 7070 6564 2073 686f  d or stopped sho
-000145d0: 756c 6420 6265 2063 6f6e 7369 6465 7265  uld be considere
-000145e0: 640a 2020 2020 2320 2020 2020 6162 6e6f  d.    #     abno
-000145f0: 726d 616c 2e0a 2020 2020 230a 2020 2020  rmal..    #.    
-00014600: 2320 416e 2061 626e 6f72 6d61 6c20 636c  # An abnormal cl
-00014610: 7573 7465 7220 7769 6c6c 2074 7261 6e73  uster will trans
-00014620: 6974 696f 6e20 746f 2049 4e49 5420 616e  ition to INIT an
-00014630: 6420 6861 7665 2061 6e79 2061 7574 6f73  d have any autos
-00014640: 746f 7020 7365 7474 696e 670a 2020 2020  top setting.    
-00014650: 2320 7265 7365 7420 2875 6e6c 6573 7320  # reset (unless 
-00014660: 6974 2773 2061 7574 6f73 746f 7070 696e  it's autostoppin
-00014670: 672f 6175 746f 646f 776e 696e 6729 2e0a  g/autodowning)..
-00014680: 2020 2020 6973 5f61 626e 6f72 6d61 6c20      is_abnormal 
-00014690: 3d20 2828 3020 3c20 6c65 6e28 6e6f 6465  = ((0 < len(node
-000146a0: 5f73 7461 7475 7365 7329 203c 2068 616e  _statuses) < han
-000146b0: 646c 652e 6c61 756e 6368 6564 5f6e 6f64  dle.launched_nod
-000146c0: 6573 2920 6f72 2061 6e79 280a 2020 2020  es) or any(.    
-000146d0: 2020 2020 7374 6174 7573 2021 3d20 7374      status != st
-000146e0: 6174 7573 5f6c 6962 2e43 6c75 7374 6572  atus_lib.Cluster
-000146f0: 5374 6174 7573 2e53 544f 5050 4544 2066  Status.STOPPED f
-00014700: 6f72 2073 7461 7475 7320 696e 206e 6f64  or status in nod
-00014710: 655f 7374 6174 7573 6573 2929 0a20 2020  e_statuses)).   
-00014720: 2069 6620 6973 5f61 626e 6f72 6d61 6c3a   if is_abnormal:
-00014730: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-00014740: 6465 6275 6728 2754 6865 2063 6c75 7374  debug('The clust
-00014750: 6572 2069 7320 6162 6e6f 726d 616c 2e20  er is abnormal. 
-00014760: 5365 7474 696e 6720 746f 2049 4e49 5420  Setting to INIT 
-00014770: 7374 6174 7573 2e20 270a 2020 2020 2020  status. '.      
-00014780: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00014790: 276e 6f64 655f 7374 6174 7573 6573 3a20  'node_statuses: 
-000147a0: 7b6e 6f64 655f 7374 6174 7573 6573 7d27  {node_statuses}'
-000147b0: 290a 2020 2020 2020 2020 6261 636b 656e  ).        backen
-000147c0: 6420 3d20 6765 745f 6261 636b 656e 645f  d = get_backend_
-000147d0: 6672 6f6d 5f68 616e 646c 6528 6861 6e64  from_handle(hand
-000147e0: 6c65 290a 2020 2020 2020 2020 6966 2069  le).        if i
-000147f0: 7369 6e73 7461 6e63 6528 6261 636b 656e  sinstance(backen
-00014800: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-00014810: 2020 2020 2020 2020 2062 6163 6b65 6e64           backend
-00014820: 732e 436c 6f75 6456 6d52 6179 4261 636b  s.CloudVmRayBack
-00014830: 656e 6429 2061 6e64 2072 6563 6f72 645b  end) and record[
-00014840: 2761 7574 6f73 746f 7027 5d20 3e3d 2030  'autostop'] >= 0
-00014850: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00014860: 206e 6f74 2062 6163 6b65 6e64 2e69 735f   not backend.is_
-00014870: 6465 6669 6e69 7465 6c79 5f61 7574 6f73  definitely_autos
-00014880: 746f 7070 696e 6728 6861 6e64 6c65 2c0a  topping(handle,.
+00013b80: 2069 735f 6c61 756e 6368 3d46 616c 7365   is_launch=False
+00013b90: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00013ba0: 2072 6563 6f72 640a 0a20 2020 2023 2041   record..    # A
+00013bb0: 6c6c 2063 6173 6573 2062 656c 6f77 2061  ll cases below a
+00013bc0: 7265 2074 7261 6e73 6974 696f 6e69 6e67  re transitioning
+00013bd0: 2074 6865 2063 6c75 7374 6572 2074 6f20   the cluster to 
+00013be0: 6e6f 6e2d 5550 2073 7461 7465 732e 0a20  non-UP states.. 
+00013bf0: 2020 2069 6620 6c65 6e28 6e6f 6465 5f73     if len(node_s
+00013c00: 7461 7475 7365 7329 203e 2068 616e 646c  tatuses) > handl
+00013c10: 652e 6c61 756e 6368 6564 5f6e 6f64 6573  e.launched_nodes
+00013c20: 3a0a 2020 2020 2020 2020 2320 556e 6578  :.        # Unex
+00013c30: 7065 6374 6564 3a20 696e 2074 6865 2071  pected: in the q
+00013c40: 7565 7269 6564 2072 6567 696f 6e20 6d6f  ueried region mo
+00013c50: 7265 2074 6861 6e20 3120 636c 7573 7465  re than 1 cluste
+00013c60: 7220 7769 7468 2074 6865 2073 616d 650a  r with the same.
+00013c70: 2020 2020 2020 2020 2320 636f 6e73 7472          # constr
+00013c80: 7563 7465 6420 6e61 6d65 2074 6167 2072  ucted name tag r
+00013c90: 6574 7572 6e65 642e 2054 6869 7320 7769  eturned. This wi
+00013ca0: 6c6c 2074 7970 6963 616c 6c79 206e 6f74  ll typically not
+00013cb0: 2068 6170 7065 6e20 756e 6c65 7373 0a20   happen unless. 
+00013cc0: 2020 2020 2020 2023 2075 7365 7273 206d         # users m
+00013cd0: 616e 7561 6c6c 7920 6372 6561 7465 2061  anually create a
+00013ce0: 2063 6c75 7374 6572 2077 6974 6820 7468   cluster with th
+00013cf0: 6174 2063 6f6e 7374 7275 6374 6564 206e  at constructed n
+00013d00: 616d 6520 6f72 2074 6865 7265 0a20 2020  ame or there.   
+00013d10: 2020 2020 2023 2077 6173 2061 2072 6573       # was a res
+00013d20: 6f75 7263 6520 6c65 616b 2063 6175 7365  ource leak cause
+00013d30: 6420 6279 2064 6966 6665 7265 6e74 206c  d by different l
+00013d40: 6175 6e63 6820 6861 7368 2062 6566 6f72  aunch hash befor
+00013d50: 6520 2331 3637 310a 2020 2020 2020 2020  e #1671.        
+00013d60: 2320 7761 7320 6d65 7267 6564 2e0a 2020  # was merged..  
+00013d70: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
+00013d80: 2320 2854 6563 686e 6963 616c 6c79 2073  # (Technically s
+00013d90: 7065 616b 696e 672c 2065 7665 6e20 6966  peaking, even if
+00013da0: 2072 6574 7572 6e65 6420 6e75 6d20 6e6f   returned num no
+00013db0: 6465 7320 3c3d 206e 756d 0a20 2020 2020  des <= num.     
+00013dc0: 2020 2023 2068 616e 646c 652e 6c61 756e     # handle.laun
+00013dd0: 6368 6564 5f6e 6f64 6573 292c 206e 6f74  ched_nodes), not
+00013de0: 2069 6e63 6c75 6469 6e67 2074 6865 206c   including the l
+00013df0: 6175 6e63 6820 6861 7368 2063 6f75 6c64  aunch hash could
+00013e00: 206d 6561 6e20 7468 650a 2020 2020 2020   mean the.      
+00013e10: 2020 2320 7265 7475 726e 6564 206e 6f64    # returned nod
+00013e20: 6573 2063 6f6e 7461 696e 2073 6f6d 6520  es contain some 
+00013e30: 6e6f 6465 7320 7468 6174 2064 6f20 6e6f  nodes that do no
+00013e40: 7420 6265 6c6f 6e67 2074 6f20 7468 6520  t belong to the 
+00013e50: 6c6f 6769 6361 6c0a 2020 2020 2020 2020  logical.        
+00013e60: 2320 736b 7970 696c 6f74 2063 6c75 7374  # skypilot clust
+00013e70: 6572 2e20 446f 6573 6e27 7420 7365 656d  er. Doesn't seem
+00013e80: 2074 6f20 6265 2061 2067 6f6f 6420 7761   to be a good wa
+00013e90: 7920 746f 2068 616e 646c 6520 7468 6973  y to handle this
+00013ea0: 2066 6f72 0a20 2020 2020 2020 2023 206e   for.        # n
+00013eb0: 6f77 3f29 0a20 2020 2020 2020 2023 0a20  ow?).        #. 
+00013ec0: 2020 2020 2020 2023 2057 6520 6861 7665         # We have
+00013ed0: 206e 6f74 2065 7870 6572 6965 6e63 6564   not experienced
+00013ee0: 2074 6865 2061 626f 7665 3b20 6164 6469   the above; addi
+00013ef0: 6e67 2061 7320 6120 7361 6665 6775 6172  ng as a safeguar
+00013f00: 642e 0a20 2020 2020 2020 2023 0a20 2020  d..        #.   
+00013f10: 2020 2020 2023 2053 696e 6365 2077 6520       # Since we 
+00013f20: 6661 696c 6564 2074 6f20 7265 6672 6573  failed to refres
+00013f30: 682c 2072 6169 7365 2074 6865 2073 7461  h, raise the sta
+00013f40: 7475 7320 6665 7463 6869 6e67 2065 7272  tus fetching err
+00013f50: 6f72 2e0a 2020 2020 2020 2020 7769 7468  or..        with
+00013f60: 2075 785f 7574 696c 732e 7072 696e 745f   ux_utils.print_
+00013f70: 6578 6365 7074 696f 6e5f 6e6f 5f74 7261  exception_no_tra
+00013f80: 6365 6261 636b 2829 3a0a 2020 2020 2020  ceback():.      
+00013f90: 2020 2020 2020 7261 6973 6520 6578 6365        raise exce
+00013fa0: 7074 696f 6e73 2e43 6c75 7374 6572 5374  ptions.ClusterSt
+00013fb0: 6174 7573 4665 7463 6869 6e67 4572 726f  atusFetchingErro
+00013fc0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00013fd0: 2020 2066 2746 6f75 6e64 207b 6c65 6e28     f'Found {len(
+00013fe0: 6e6f 6465 5f73 7461 7475 7365 7329 7d20  node_statuses)} 
+00013ff0: 6e6f 6465 2873 2920 7769 7468 2074 6865  node(s) with the
+00014000: 2073 616d 6520 636c 7573 7465 7220 6e61   same cluster na
+00014010: 6d65 270a 2020 2020 2020 2020 2020 2020  me'.            
+00014020: 2020 2020 6627 2074 6167 2069 6e20 7468      f' tag in th
+00014030: 6520 636c 6f75 6420 7072 6f76 6964 6572  e cloud provider
+00014040: 2066 6f72 2063 6c75 7374 6572 207b 636c   for cluster {cl
+00014050: 7573 7465 725f 6e61 6d65 2172 7d2c 2027  uster_name!r}, '
+00014060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014070: 2066 2777 6869 6368 2073 686f 756c 6420   f'which should 
+00014080: 6861 7665 207b 6861 6e64 6c65 2e6c 6175  have {handle.lau
+00014090: 6e63 6865 645f 6e6f 6465 737d 206e 6f64  nched_nodes} nod
+000140a0: 6573 2e20 5468 6973 2027 0a20 2020 2020  es. This '.     
+000140b0: 2020 2020 2020 2020 2020 2066 276e 6f72             f'nor
+000140c0: 6d61 6c6c 7920 7368 6f75 6c64 206e 6f74  mally should not
+000140d0: 2068 6170 7065 6e2e 207b 636f 6c6f 7261   happen. {colora
+000140e0: 6d61 2e46 6f72 652e 5245 447d 506c 6561  ma.Fore.RED}Plea
+000140f0: 7365 2063 6865 636b 2027 0a20 2020 2020  se check '.     
+00014100: 2020 2020 2020 2020 2020 2027 7468 6520             'the 
+00014110: 636c 6f75 6420 636f 6e73 6f6c 6520 616e  cloud console an
+00014120: 6420 6669 7820 616e 7920 706f 7373 6962  d fix any possib
+00014130: 6c65 2072 6573 6f75 7263 6573 206c 6561  le resources lea
+00014140: 6b61 6765 2027 0a20 2020 2020 2020 2020  kage '.         
+00014150: 2020 2020 2020 2027 2865 2e67 2e2c 2069         '(e.g., i
+00014160: 6620 7468 6572 6520 6172 6520 616e 7920  f there are any 
+00014170: 7374 6f70 7065 6420 6e6f 6465 7320 616e  stopped nodes an
+00014180: 6420 7468 6579 2064 6f20 6e6f 7420 6861  d they do not ha
+00014190: 7665 2027 0a20 2020 2020 2020 2020 2020  ve '.           
+000141a0: 2020 2020 2027 6461 7461 206f 7220 6172       'data or ar
+000141b0: 6520 756e 6865 616c 7468 792c 2074 6572  e unhealthy, ter
+000141c0: 6d69 6e61 7465 2074 6865 6d29 2e27 0a20  minate them).'. 
+000141d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000141e0: 277b 636f 6c6f 7261 6d61 2e53 7479 6c65  '{colorama.Style
+000141f0: 2e52 4553 4554 5f41 4c4c 7d27 290a 2020  .RESET_ALL}').  
+00014200: 2020 6173 7365 7274 206c 656e 286e 6f64    assert len(nod
+00014210: 655f 7374 6174 7573 6573 2920 3c3d 2068  e_statuses) <= h
+00014220: 616e 646c 652e 6c61 756e 6368 6564 5f6e  andle.launched_n
+00014230: 6f64 6573 0a0a 2020 2020 2320 4966 2074  odes..    # If t
+00014240: 6865 206e 6f64 655f 7374 6174 7573 6573  he node_statuses
+00014250: 2069 7320 656d 7074 792c 2061 6c6c 2074   is empty, all t
+00014260: 6865 206e 6f64 6573 2061 7265 2074 6572  he nodes are ter
+00014270: 6d69 6e61 7465 642e 2057 6520 6361 6e0a  minated. We can.
+00014280: 2020 2020 2320 7361 6665 6c79 2073 6574      # safely set
+00014290: 2074 6865 2063 6c75 7374 6572 2073 7461   the cluster sta
+000142a0: 7475 7320 746f 2054 4552 4d49 4e41 5445  tus to TERMINATE
+000142b0: 442e 2054 6869 7320 6861 6e64 6c65 7320  D. This handles 
+000142c0: 7468 6520 6564 6765 2063 6173 650a 2020  the edge case.  
+000142d0: 2020 2320 7768 6572 6520 7468 6520 636c    # where the cl
+000142e0: 7573 7465 7220 6973 2074 6572 6d69 6e61  uster is termina
+000142f0: 7465 6420 6279 2074 6865 2075 7365 7220  ted by the user 
+00014300: 6d61 6e75 616c 6c79 2074 6872 6f75 6768  manually through
+00014310: 2074 6865 2055 492e 0a20 2020 2074 6f5f   the UI..    to_
+00014320: 7465 726d 696e 6174 6520 3d20 6e6f 7420  terminate = not 
+00014330: 6e6f 6465 5f73 7461 7475 7365 730a 0a20  node_statuses.. 
+00014340: 2020 2023 2041 2063 6c75 7374 6572 2069     # A cluster i
+00014350: 7320 636f 6e73 6964 6572 6564 2022 6162  s considered "ab
+00014360: 6e6f 726d 616c 222c 2069 6620 6e6f 7420  normal", if not 
+00014370: 616c 6c20 6e6f 6465 7320 6172 6520 5445  all nodes are TE
+00014380: 524d 494e 4154 4544 206f 720a 2020 2020  RMINATED or.    
+00014390: 2320 6e6f 7420 616c 6c20 6e6f 6465 7320  # not all nodes 
+000143a0: 6172 6520 5354 4f50 5045 442e 2057 6520  are STOPPED. We 
+000143b0: 6368 6563 6b20 7468 6174 2077 6974 6820  check that with 
+000143c0: 7468 6520 666f 6c6c 6f77 696e 6720 6c6f  the following lo
+000143d0: 6769 633a 0a20 2020 2023 2020 202a 204e  gic:.    #   * N
+000143e0: 6f74 2061 6c6c 206e 6f64 6573 2061 7265  ot all nodes are
+000143f0: 2074 6572 6d69 6e61 7465 6420 616e 6420   terminated and 
+00014400: 7468 6572 6527 7320 6174 206c 6561 7374  there's at least
+00014410: 206f 6e65 206e 6f64 650a 2020 2020 2320   one node.    # 
+00014420: 2020 2020 7465 726d 696e 6174 6564 3b20      terminated; 
+00014430: 6f72 0a20 2020 2023 2020 202a 2041 6e79  or.    #   * Any
+00014440: 206f 6620 7468 6520 6e6f 6e2d 5445 524d   of the non-TERM
+00014450: 494e 4154 4544 206e 6f64 6573 2069 7320  INATED nodes is 
+00014460: 696e 2061 206e 6f6e 2d53 544f 5050 4544  in a non-STOPPED
+00014470: 2073 7461 7475 732e 0a20 2020 2023 0a20   status..    #. 
+00014480: 2020 2023 2054 6869 7320 696e 636c 7564     # This includ
+00014490: 6573 2074 6865 7365 2073 7065 6369 616c  es these special
+000144a0: 2063 6173 6573 3a0a 2020 2020 2320 2020   cases:.    #   
+000144b0: 2a20 416c 6c20 7374 6f70 7065 6420 6172  * All stopped ar
+000144c0: 6520 636f 6e73 6964 6572 6564 206e 6f72  e considered nor
+000144d0: 6d61 6c20 616e 6420 7769 6c6c 2062 6520  mal and will be 
+000144e0: 636c 6561 6e65 6420 7570 2061 7420 7468  cleaned up at th
+000144f0: 6520 656e 640a 2020 2020 2320 2020 2020  e end.    #     
+00014500: 6f66 2074 6865 2066 756e 6374 696f 6e2e  of the function.
+00014510: 0a20 2020 2023 2020 202a 2053 6f6d 6520  .    #   * Some 
+00014520: 6f66 2074 6865 206e 6f64 6573 2055 5020  of the nodes UP 
+00014530: 7368 6f75 6c64 2062 6520 636f 6e73 6964  should be consid
+00014540: 6572 6564 2061 626e 6f72 6d61 6c2c 2062  ered abnormal, b
+00014550: 6563 6175 7365 2074 6865 2072 6179 0a20  ecause the ray. 
+00014560: 2020 2023 2020 2020 2063 6c75 7374 6572     #     cluster
+00014570: 2069 7320 7072 6f62 6162 6c79 2064 6f77   is probably dow
+00014580: 6e2e 0a20 2020 2023 2020 202a 2054 6865  n..    #   * The
+00014590: 2063 6c75 7374 6572 2069 7320 7061 7274   cluster is part
+000145a0: 6961 6c6c 7920 7465 726d 696e 6174 6564  ially terminated
+000145b0: 206f 7220 7374 6f70 7065 6420 7368 6f75   or stopped shou
+000145c0: 6c64 2062 6520 636f 6e73 6964 6572 6564  ld be considered
+000145d0: 0a20 2020 2023 2020 2020 2061 626e 6f72  .    #     abnor
+000145e0: 6d61 6c2e 0a20 2020 2023 0a20 2020 2023  mal..    #.    #
+000145f0: 2041 6e20 6162 6e6f 726d 616c 2063 6c75   An abnormal clu
+00014600: 7374 6572 2077 696c 6c20 7472 616e 7369  ster will transi
+00014610: 7469 6f6e 2074 6f20 494e 4954 2061 6e64  tion to INIT and
+00014620: 2068 6176 6520 616e 7920 6175 746f 7374   have any autost
+00014630: 6f70 2073 6574 7469 6e67 0a20 2020 2023  op setting.    #
+00014640: 2072 6573 6574 2028 756e 6c65 7373 2069   reset (unless i
+00014650: 7427 7320 6175 746f 7374 6f70 7069 6e67  t's autostopping
+00014660: 2f61 7574 6f64 6f77 6e69 6e67 292e 0a20  /autodowning).. 
+00014670: 2020 2069 735f 6162 6e6f 726d 616c 203d     is_abnormal =
+00014680: 2028 2830 203c 206c 656e 286e 6f64 655f   ((0 < len(node_
+00014690: 7374 6174 7573 6573 2920 3c20 6861 6e64  statuses) < hand
+000146a0: 6c65 2e6c 6175 6e63 6865 645f 6e6f 6465  le.launched_node
+000146b0: 7329 206f 7220 616e 7928 0a20 2020 2020  s) or any(.     
+000146c0: 2020 2073 7461 7475 7320 213d 2073 7461     status != sta
+000146d0: 7475 735f 6c69 622e 436c 7573 7465 7253  tus_lib.ClusterS
+000146e0: 7461 7475 732e 5354 4f50 5045 4420 666f  tatus.STOPPED fo
+000146f0: 7220 7374 6174 7573 2069 6e20 6e6f 6465  r status in node
+00014700: 5f73 7461 7475 7365 7329 290a 2020 2020  _statuses)).    
+00014710: 6966 2069 735f 6162 6e6f 726d 616c 3a0a  if is_abnormal:.
+00014720: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+00014730: 6562 7567 2827 5468 6520 636c 7573 7465  ebug('The cluste
+00014740: 7220 6973 2061 626e 6f72 6d61 6c2e 2053  r is abnormal. S
+00014750: 6574 7469 6e67 2074 6f20 494e 4954 2073  etting to INIT s
+00014760: 7461 7475 732e 2027 0a20 2020 2020 2020  tatus. '.       
+00014770: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00014780: 6e6f 6465 5f73 7461 7475 7365 733a 207b  node_statuses: {
+00014790: 6e6f 6465 5f73 7461 7475 7365 737d 2729  node_statuses}')
+000147a0: 0a20 2020 2020 2020 2062 6163 6b65 6e64  .        backend
+000147b0: 203d 2067 6574 5f62 6163 6b65 6e64 5f66   = get_backend_f
+000147c0: 726f 6d5f 6861 6e64 6c65 2868 616e 646c  rom_handle(handl
+000147d0: 6529 0a20 2020 2020 2020 2069 6620 6973  e).        if is
+000147e0: 696e 7374 616e 6365 2862 6163 6b65 6e64  instance(backend
+000147f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014800: 2020 2020 2020 2020 6261 636b 656e 6473          backends
+00014810: 2e43 6c6f 7564 566d 5261 7942 6163 6b65  .CloudVmRayBacke
+00014820: 6e64 2920 616e 6420 7265 636f 7264 5b27  nd) and record['
+00014830: 6175 746f 7374 6f70 275d 203e 3d20 303a  autostop'] >= 0:
+00014840: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00014850: 6e6f 7420 6261 636b 656e 642e 6973 5f64  not backend.is_d
+00014860: 6566 696e 6974 656c 795f 6175 746f 7374  efinitely_autost
+00014870: 6f70 7069 6e67 2868 616e 646c 652c 0a20  opping(handle,. 
+00014880: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00014890: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000148a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148c0: 2020 2020 2020 7374 7265 616d 5f6c 6f67        stream_log
-000148d0: 733d 4661 6c73 6529 3a0a 2020 2020 2020  s=False):.      
-000148e0: 2020 2020 2020 2020 2020 2320 4672 6965            # Frie
-000148f0: 6e64 6c79 2068 696e 742e 0a20 2020 2020  ndly hint..     
-00014900: 2020 2020 2020 2020 2020 2061 7574 6f73             autos
-00014910: 746f 7020 3d20 7265 636f 7264 5b27 6175  top = record['au
-00014920: 746f 7374 6f70 275d 0a20 2020 2020 2020  tostop'].       
-00014930: 2020 2020 2020 2020 206d 6179 6265 5f64           maybe_d
-00014940: 6f77 6e5f 7374 7220 3d20 2720 2d2d 646f  own_str = ' --do
-00014950: 776e 2720 6966 2072 6563 6f72 645b 2774  wn' if record['t
-00014960: 6f5f 646f 776e 275d 2065 6c73 6520 2727  o_down'] else ''
-00014970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014980: 206e 6f75 6e20 3d20 2761 7574 6f64 6f77   noun = 'autodow
-00014990: 6e27 2069 6620 7265 636f 7264 5b27 746f  n' if record['to
-000149a0: 5f64 6f77 6e27 5d20 656c 7365 2027 6175  _down'] else 'au
-000149b0: 746f 7374 6f70 270a 0a20 2020 2020 2020  tostop'..       
-000149c0: 2020 2020 2020 2020 2023 2052 6573 6574           # Reset
-000149d0: 2074 6865 2061 7574 6f73 746f 7070 696e   the autostoppin
-000149e0: 6720 6173 2074 6865 2063 6c75 7374 6572  g as the cluster
-000149f0: 2069 7320 6162 6e6f 726d 616c 2c20 616e   is abnormal, an
-00014a00: 6420 6d61 790a 2020 2020 2020 2020 2020  d may.          
-00014a10: 2020 2020 2020 2320 6e6f 7420 636f 7272        # not corr
-00014a20: 6563 746c 7920 6175 746f 7374 6f70 2e20  ectly autostop. 
-00014a30: 5265 7365 7474 696e 6720 7468 6520 6175  Resetting the au
-00014a40: 746f 7374 6f70 2077 696c 6c20 6c65 740a  tostop will let.
-00014a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a60: 2320 7468 6520 7573 6572 206b 6e6f 7720  # the user know 
-00014a70: 7468 6174 2074 6865 2061 7574 6f73 746f  that the autosto
-00014a80: 7020 6d61 7920 6e6f 7420 6861 7070 656e  p may not happen
-00014a90: 2074 6f20 6176 6f69 640a 2020 2020 2020   to avoid.      
-00014aa0: 2020 2020 2020 2020 2020 2320 6c65 616b            # leak
-00014ab0: 6167 6573 2066 726f 6d20 7468 6520 6173  ages from the as
-00014ac0: 7375 6d70 7469 6f6e 2074 6861 7420 7468  sumption that th
-00014ad0: 6520 636c 7573 7465 7220 7769 6c6c 2061  e cluster will a
-00014ae0: 7574 6f73 746f 702e 0a20 2020 2020 2020  utostop..       
-00014af0: 2020 2020 2020 2020 2073 7563 6365 7373           success
-00014b00: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00014b10: 2020 2020 2020 2020 7265 7365 745f 6c6f          reset_lo
-00014b20: 6361 6c5f 6175 746f 7374 6f70 203d 2054  cal_autostop = T
-00014b30: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-00014b40: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00014b50: 2020 2020 2020 2020 2020 2020 2062 6163               bac
-00014b60: 6b65 6e64 2e73 6574 5f61 7574 6f73 746f  kend.set_autosto
-00014b70: 7028 6861 6e64 6c65 2c20 2d31 2c20 7374  p(handle, -1, st
-00014b80: 7265 616d 5f6c 6f67 733d 4661 6c73 6529  ream_logs=False)
-00014b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014ba0: 2065 7863 6570 7420 6578 6365 7074 696f   except exceptio
-00014bb0: 6e73 2e43 6f6d 6d61 6e64 4572 726f 7220  ns.CommandError 
-00014bc0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-00014bd0: 2020 2020 2020 2020 2020 7375 6363 6573            succes
-00014be0: 7320 3d20 4661 6c73 650a 2020 2020 2020  s = False.      
-00014bf0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00014c00: 2065 2e72 6574 7572 6e63 6f64 6520 3d3d   e.returncode ==
-00014c10: 2032 3535 3a0a 2020 2020 2020 2020 2020   255:.          
-00014c20: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00014c30: 6767 6572 2e64 6562 7567 2866 2754 6865  gger.debug(f'The
-00014c40: 2063 6c75 7374 6572 2069 7320 6c69 6b65   cluster is like
-00014c50: 6c79 207b 6e6f 756e 7d65 642e 2729 0a20  ly {noun}ed.'). 
-00014c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c70: 2020 2020 2020 2072 6573 6574 5f6c 6f63         reset_loc
-00014c80: 616c 5f61 7574 6f73 746f 7020 3d20 4661  al_autostop = Fa
-00014c90: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-00014ca0: 2020 2020 6578 6365 7074 2028 4578 6365      except (Exce
-00014cb0: 7074 696f 6e2c 2053 7973 7465 6d45 7869  ption, SystemExi
-00014cc0: 7429 2061 7320 653a 2020 2320 7079 6c69  t) as e:  # pyli
-00014cd0: 6e74 3a20 6469 7361 626c 653d 6272 6f61  nt: disable=broa
-00014ce0: 642d 6578 6365 7074 0a20 2020 2020 2020  d-except.       
-00014cf0: 2020 2020 2020 2020 2020 2020 2073 7563               suc
-00014d00: 6365 7373 203d 2046 616c 7365 0a20 2020  cess = False.   
-00014d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d20: 206c 6f67 6765 722e 6465 6275 6728 6627   logger.debug(f'
-00014d30: 4661 696c 6564 2074 6f20 7265 7365 7420  Failed to reset 
-00014d40: 6175 746f 7374 6f70 2e20 4475 6520 746f  autostop. Due to
-00014d50: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00014d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d70: 2020 2020 6627 7b63 6f6d 6d6f 6e5f 7574      f'{common_ut
-00014d80: 696c 732e 666f 726d 6174 5f65 7863 6570  ils.format_excep
-00014d90: 7469 6f6e 2865 297d 2729 0a20 2020 2020  tion(e)}').     
-00014da0: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-00014db0: 7365 745f 6c6f 6361 6c5f 6175 746f 7374  set_local_autost
-00014dc0: 6f70 3a0a 2020 2020 2020 2020 2020 2020  op:.            
-00014dd0: 2020 2020 2020 2020 676c 6f62 616c 5f75          global_u
-00014de0: 7365 725f 7374 6174 652e 7365 745f 636c  ser_state.set_cl
-00014df0: 7573 7465 725f 6175 746f 7374 6f70 5f76  uster_autostop_v
-00014e00: 616c 7565 280a 2020 2020 2020 2020 2020  alue(.          
-00014e10: 2020 2020 2020 2020 2020 2020 2020 6861                ha
-00014e20: 6e64 6c65 2e63 6c75 7374 6572 5f6e 616d  ndle.cluster_nam
-00014e30: 652c 202d 312c 2074 6f5f 646f 776e 3d46  e, -1, to_down=F
-00014e40: 616c 7365 290a 0a20 2020 2020 2020 2020  alse)..         
-00014e50: 2020 2020 2020 2069 6620 7375 6363 6573         if succes
-00014e60: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00014e70: 2020 2020 2020 206f 7065 7261 7469 6f6e         operation
-00014e80: 5f73 7472 203d 2028 6627 4361 6e63 656c  _str = (f'Cancel
-00014e90: 6564 207b 6e6f 756e 7d20 6f6e 2074 6865  ed {noun} on the
-00014ea0: 2063 6c75 7374 6572 2027 0a20 2020 2020   cluster '.     
-00014eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ed0: 6627 7b63 6c75 7374 6572 5f6e 616d 6521  f'{cluster_name!
-00014ee0: 727d 2729 0a20 2020 2020 2020 2020 2020  r}').           
-00014ef0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00014f00: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00014f10: 7065 7261 7469 6f6e 5f73 7472 203d 2028  peration_str = (
-00014f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014f30: 2020 2020 2020 2020 2066 2741 7474 656d           f'Attem
-00014f40: 7074 6564 2074 6f20 6361 6e63 656c 207b  pted to cancel {
-00014f50: 6e6f 756e 7d20 6f6e 2074 6865 2027 0a20  noun} on the '. 
-00014f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f70: 2020 2020 2020 2066 2763 6c75 7374 6572         f'cluster
-00014f80: 207b 636c 7573 7465 725f 6e61 6d65 2172   {cluster_name!r
-00014f90: 7d20 7769 7468 2062 6573 7420 6566 666f  } with best effo
-00014fa0: 7274 2729 0a20 2020 2020 2020 2020 2020  rt').           
-00014fb0: 2020 2020 2079 656c 6c6f 7720 3d20 636f       yellow = co
-00014fc0: 6c6f 7261 6d61 2e46 6f72 652e 5945 4c4c  lorama.Fore.YELL
-00014fd0: 4f57 0a20 2020 2020 2020 2020 2020 2020  OW.             
-00014fe0: 2020 2062 7269 6768 7420 3d20 636f 6c6f     bright = colo
-00014ff0: 7261 6d61 2e53 7479 6c65 2e42 5249 4748  rama.Style.BRIGH
-00015000: 540a 2020 2020 2020 2020 2020 2020 2020  T.              
-00015010: 2020 7265 7365 7420 3d20 636f 6c6f 7261    reset = colora
-00015020: 6d61 2e53 7479 6c65 2e52 4553 4554 5f41  ma.Style.RESET_A
-00015030: 4c4c 0a20 2020 2020 2020 2020 2020 2020  LL.             
-00015040: 2020 2075 785f 7574 696c 732e 636f 6e73     ux_utils.cons
-00015050: 6f6c 655f 6e65 776c 696e 6528 290a 2020  ole_newline().  
-00015060: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00015070: 6767 6572 2e77 6172 6e69 6e67 280a 2020  gger.warning(.  
-00015080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015090: 2020 6627 7b79 656c 6c6f 777d 7b6f 7065    f'{yellow}{ope
-000150a0: 7261 7469 6f6e 5f73 7472 7d2c 2073 696e  ration_str}, sin
-000150b0: 6365 2069 7420 6973 2066 6f75 6e64 2074  ce it is found t
-000150c0: 6f20 6265 2069 6e20 616e 2027 0a20 2020  o be in an '.   
-000150d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000150e0: 2066 2761 626e 6f72 6d61 6c20 7374 6174   f'abnormal stat
-000150f0: 652e 2054 6f20 6669 782c 2074 7279 2072  e. To fix, try r
-00015100: 756e 6e69 6e67 3a20 7b72 6573 6574 7d7b  unning: {reset}{
-00015110: 6272 6967 6874 7d73 6b79 2027 0a20 2020  bright}sky '.   
-00015120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015130: 2066 2773 7461 7274 202d 6620 2d69 207b   f'start -f -i {
-00015140: 6175 746f 7374 6f70 7d7b 6d61 7962 655f  autostop}{maybe_
-00015150: 646f 776e 5f73 7472 7d20 7b63 6c75 7374  down_str} {clust
-00015160: 6572 5f6e 616d 657d 270a 2020 2020 2020  er_name}'.      
-00015170: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00015180: 7b72 6573 6574 7d27 290a 2020 2020 2020  {reset}').      
-00015190: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000151a0: 2020 2020 2020 2020 2020 2020 7578 5f75              ux_u
-000151b0: 7469 6c73 2e63 6f6e 736f 6c65 5f6e 6577  tils.console_new
-000151c0: 6c69 6e65 2829 0a20 2020 2020 2020 2020  line().         
-000151d0: 2020 2020 2020 206f 7065 7261 7469 6f6e         operation
-000151e0: 5f73 7472 203d 2027 6175 746f 646f 776e  _str = 'autodown
-000151f0: 696e 6727 2069 6620 7265 636f 7264 5b0a  ing' if record[.
-00015200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015210: 2020 2020 2774 6f5f 646f 776e 275d 2065      'to_down'] e
-00015220: 6c73 6520 2761 7574 6f73 746f 7070 696e  lse 'autostoppin
-00015230: 6727 0a20 2020 2020 2020 2020 2020 2020  g'.             
-00015240: 2020 206c 6f67 6765 722e 696e 666f 280a     logger.info(.
-00015250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015260: 2020 2020 6627 436c 7573 7465 7220 7b63      f'Cluster {c
-00015270: 6c75 7374 6572 5f6e 616d 6521 727d 2069  luster_name!r} i
-00015280: 7320 7b6f 7065 7261 7469 6f6e 5f73 7472  s {operation_str
-00015290: 7d2e 2053 6574 7469 6e67 2074 6f20 270a  }. Setting to '.
-000152a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152b0: 2020 2020 2749 4e49 5420 7374 6174 7573      'INIT status
-000152c0: 3b20 7472 7920 7265 6672 6573 6820 6167  ; try refresh ag
-000152d0: 6169 6e20 696e 2061 2077 6869 6c65 2e27  ain in a while.'
-000152e0: 290a 0a20 2020 2020 2020 2023 2049 6620  )..        # If 
-000152f0: 7468 6520 7573 6572 2073 7461 7274 7320  the user starts 
-00015300: 7061 7274 206f 6620 6120 5354 4f50 5045  part of a STOPPE
-00015310: 4420 636c 7573 7465 722c 2077 6520 7374  D cluster, we st
-00015320: 696c 6c20 6e65 6564 2061 2073 7461 7475  ill need a statu
-00015330: 730a 2020 2020 2020 2020 2320 746f 2072  s.        # to r
-00015340: 6570 7265 7365 6e74 2074 6865 2061 626e  epresent the abn
-00015350: 6f72 6d61 6c20 7374 6174 7573 2e20 466f  ormal status. Fo
-00015360: 7220 7370 6f74 2063 6c75 7374 6572 2c20  r spot cluster, 
-00015370: 6974 2063 616e 2061 6c73 6f0a 2020 2020  it can also.    
-00015380: 2020 2020 2320 7265 7072 6573 656e 7420      # represent 
-00015390: 7468 6174 2074 6865 2063 6c75 7374 6572  that the cluster
-000153a0: 2069 7320 7061 7274 6961 6c6c 7920 7072   is partially pr
-000153b0: 6565 6d70 7465 642e 0a20 2020 2020 2020  eempted..       
-000153c0: 2023 2054 4f44 4f28 7a68 7775 293a 2074   # TODO(zhwu): t
-000153d0: 6865 2064 6566 696e 6974 696f 6e20 6f66  he definition of
-000153e0: 2049 4e49 5420 7368 6f75 6c64 2062 6520   INIT should be 
-000153f0: 6175 6469 7465 642f 6368 616e 6765 642e  audited/changed.
-00015400: 0a20 2020 2020 2020 2023 2041 6464 696e  .        # Addin
-00015410: 6720 6120 6e65 7720 7374 6174 7573 2055  g a new status U
-00015420: 4e48 4541 4c54 4859 2066 6f72 2061 626e  NHEALTHY for abn
-00015430: 6f72 6d61 6c20 7374 6174 7573 2063 616e  ormal status can
-00015440: 2062 6520 6120 6368 6f69 6365 2e0a 2020   be a choice..  
-00015450: 2020 2020 2020 676c 6f62 616c 5f75 7365        global_use
-00015460: 725f 7374 6174 652e 6164 645f 6f72 5f75  r_state.add_or_u
-00015470: 7064 6174 655f 636c 7573 7465 7228 636c  pdate_cluster(cl
-00015480: 7573 7465 725f 6e61 6d65 2c0a 2020 2020  uster_name,.    
+000148b0: 2020 2020 2073 7472 6561 6d5f 6c6f 6773       stream_logs
+000148c0: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
+000148d0: 2020 2020 2020 2020 2023 2046 7269 656e           # Frien
+000148e0: 646c 7920 6869 6e74 2e0a 2020 2020 2020  dly hint..      
+000148f0: 2020 2020 2020 2020 2020 6175 746f 7374            autost
+00014900: 6f70 203d 2072 6563 6f72 645b 2761 7574  op = record['aut
+00014910: 6f73 746f 7027 5d0a 2020 2020 2020 2020  ostop'].        
+00014920: 2020 2020 2020 2020 6d61 7962 655f 646f          maybe_do
+00014930: 776e 5f73 7472 203d 2027 202d 2d64 6f77  wn_str = ' --dow
+00014940: 6e27 2069 6620 7265 636f 7264 5b27 746f  n' if record['to
+00014950: 5f64 6f77 6e27 5d20 656c 7365 2027 270a  _down'] else ''.
+00014960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014970: 6e6f 756e 203d 2027 6175 746f 646f 776e  noun = 'autodown
+00014980: 2720 6966 2072 6563 6f72 645b 2774 6f5f  ' if record['to_
+00014990: 646f 776e 275d 2065 6c73 6520 2761 7574  down'] else 'aut
+000149a0: 6f73 746f 7027 0a0a 2020 2020 2020 2020  ostop'..        
+000149b0: 2020 2020 2020 2020 2320 5265 7365 7420          # Reset 
+000149c0: 7468 6520 6175 746f 7374 6f70 7069 6e67  the autostopping
+000149d0: 2061 7320 7468 6520 636c 7573 7465 7220   as the cluster 
+000149e0: 6973 2061 626e 6f72 6d61 6c2c 2061 6e64  is abnormal, and
+000149f0: 206d 6179 0a20 2020 2020 2020 2020 2020   may.           
+00014a00: 2020 2020 2023 206e 6f74 2063 6f72 7265       # not corre
+00014a10: 6374 6c79 2061 7574 6f73 746f 702e 2052  ctly autostop. R
+00014a20: 6573 6574 7469 6e67 2074 6865 2061 7574  esetting the aut
+00014a30: 6f73 746f 7020 7769 6c6c 206c 6574 0a20  ostop will let. 
+00014a40: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00014a50: 2074 6865 2075 7365 7220 6b6e 6f77 2074   the user know t
+00014a60: 6861 7420 7468 6520 6175 746f 7374 6f70  hat the autostop
+00014a70: 206d 6179 206e 6f74 2068 6170 7065 6e20   may not happen 
+00014a80: 746f 2061 766f 6964 0a20 2020 2020 2020  to avoid.       
+00014a90: 2020 2020 2020 2020 2023 206c 6561 6b61           # leaka
+00014aa0: 6765 7320 6672 6f6d 2074 6865 2061 7373  ges from the ass
+00014ab0: 756d 7074 696f 6e20 7468 6174 2074 6865  umption that the
+00014ac0: 2063 6c75 7374 6572 2077 696c 6c20 6175   cluster will au
+00014ad0: 746f 7374 6f70 2e0a 2020 2020 2020 2020  tostop..        
+00014ae0: 2020 2020 2020 2020 7375 6363 6573 7320          success 
+00014af0: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
+00014b00: 2020 2020 2020 2072 6573 6574 5f6c 6f63         reset_loc
+00014b10: 616c 5f61 7574 6f73 746f 7020 3d20 5472  al_autostop = Tr
+00014b20: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00014b30: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00014b40: 2020 2020 2020 2020 2020 2020 6261 636b              back
+00014b50: 656e 642e 7365 745f 6175 746f 7374 6f70  end.set_autostop
+00014b60: 2868 616e 646c 652c 202d 312c 2073 7472  (handle, -1, str
+00014b70: 6561 6d5f 6c6f 6773 3d46 616c 7365 290a  eam_logs=False).
+00014b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b90: 6578 6365 7074 2065 7863 6570 7469 6f6e  except exception
+00014ba0: 732e 436f 6d6d 616e 6445 7272 6f72 2061  s.CommandError a
+00014bb0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+00014bc0: 2020 2020 2020 2020 2073 7563 6365 7373           success
+00014bd0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+00014be0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00014bf0: 652e 7265 7475 726e 636f 6465 203d 3d20  e.returncode == 
+00014c00: 3235 353a 0a20 2020 2020 2020 2020 2020  255:.           
+00014c10: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00014c20: 6765 722e 6465 6275 6728 6627 5468 6520  ger.debug(f'The 
+00014c30: 636c 7573 7465 7220 6973 206c 696b 656c  cluster is likel
+00014c40: 7920 7b6e 6f75 6e7d 6564 2e27 290a 2020  y {noun}ed.').  
+00014c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c60: 2020 2020 2020 7265 7365 745f 6c6f 6361        reset_loca
+00014c70: 6c5f 6175 746f 7374 6f70 203d 2046 616c  l_autostop = Fal
+00014c80: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+00014c90: 2020 2065 7863 6570 7420 2845 7863 6570     except (Excep
+00014ca0: 7469 6f6e 2c20 5379 7374 656d 4578 6974  tion, SystemExit
+00014cb0: 2920 6173 2065 3a20 2023 2070 796c 696e  ) as e:  # pylin
+00014cc0: 743a 2064 6973 6162 6c65 3d62 726f 6164  t: disable=broad
+00014cd0: 2d65 7863 6570 740a 2020 2020 2020 2020  -except.        
+00014ce0: 2020 2020 2020 2020 2020 2020 7375 6363              succ
+00014cf0: 6573 7320 3d20 4661 6c73 650a 2020 2020  ess = False.    
+00014d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014d10: 6c6f 6767 6572 2e64 6562 7567 2866 2746  logger.debug(f'F
+00014d20: 6169 6c65 6420 746f 2072 6573 6574 2061  ailed to reset a
+00014d30: 7574 6f73 746f 702e 2044 7565 2074 6f20  utostop. Due to 
+00014d40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00014d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014d60: 2020 2066 277b 636f 6d6d 6f6e 5f75 7469     f'{common_uti
+00014d70: 6c73 2e66 6f72 6d61 745f 6578 6365 7074  ls.format_except
+00014d80: 696f 6e28 6529 7d27 290a 2020 2020 2020  ion(e)}').      
+00014d90: 2020 2020 2020 2020 2020 6966 2072 6573            if res
+00014da0: 6574 5f6c 6f63 616c 5f61 7574 6f73 746f  et_local_autosto
+00014db0: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
+00014dc0: 2020 2020 2020 2067 6c6f 6261 6c5f 7573         global_us
+00014dd0: 6572 5f73 7461 7465 2e73 6574 5f63 6c75  er_state.set_clu
+00014de0: 7374 6572 5f61 7574 6f73 746f 705f 7661  ster_autostop_va
+00014df0: 6c75 6528 0a20 2020 2020 2020 2020 2020  lue(.           
+00014e00: 2020 2020 2020 2020 2020 2020 2068 616e               han
+00014e10: 646c 652e 636c 7573 7465 725f 6e61 6d65  dle.cluster_name
+00014e20: 2c20 2d31 2c20 746f 5f64 6f77 6e3d 4661  , -1, to_down=Fa
+00014e30: 6c73 6529 0a0a 2020 2020 2020 2020 2020  lse)..          
+00014e40: 2020 2020 2020 6966 2073 7563 6365 7373        if success
+00014e50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014e60: 2020 2020 2020 6f70 6572 6174 696f 6e5f        operation_
+00014e70: 7374 7220 3d20 2866 2743 616e 6365 6c65  str = (f'Cancele
+00014e80: 6420 7b6e 6f75 6e7d 206f 6e20 7468 6520  d {noun} on the 
+00014e90: 636c 7573 7465 7220 270a 2020 2020 2020  cluster '.      
+00014ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014eb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00014ec0: 277b 636c 7573 7465 725f 6e61 6d65 2172  '{cluster_name!r
+00014ed0: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
+00014ee0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00014ef0: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+00014f00: 6572 6174 696f 6e5f 7374 7220 3d20 280a  eration_str = (.
+00014f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f20: 2020 2020 2020 2020 6627 4174 7465 6d70          f'Attemp
+00014f30: 7465 6420 746f 2063 616e 6365 6c20 7b6e  ted to cancel {n
+00014f40: 6f75 6e7d 206f 6e20 7468 6520 270a 2020  oun} on the '.  
+00014f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f60: 2020 2020 2020 6627 636c 7573 7465 7220        f'cluster 
+00014f70: 7b63 6c75 7374 6572 5f6e 616d 6521 727d  {cluster_name!r}
+00014f80: 2077 6974 6820 6265 7374 2065 6666 6f72   with best effor
+00014f90: 7427 290a 2020 2020 2020 2020 2020 2020  t').            
+00014fa0: 2020 2020 7965 6c6c 6f77 203d 2063 6f6c      yellow = col
+00014fb0: 6f72 616d 612e 466f 7265 2e59 454c 4c4f  orama.Fore.YELLO
+00014fc0: 570a 2020 2020 2020 2020 2020 2020 2020  W.              
+00014fd0: 2020 6272 6967 6874 203d 2063 6f6c 6f72    bright = color
+00014fe0: 616d 612e 5374 796c 652e 4252 4947 4854  ama.Style.BRIGHT
+00014ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015000: 2072 6573 6574 203d 2063 6f6c 6f72 616d   reset = coloram
+00015010: 612e 5374 796c 652e 5245 5345 545f 414c  a.Style.RESET_AL
+00015020: 4c0a 2020 2020 2020 2020 2020 2020 2020  L.              
+00015030: 2020 7578 5f75 7469 6c73 2e63 6f6e 736f    ux_utils.conso
+00015040: 6c65 5f6e 6577 6c69 6e65 2829 0a20 2020  le_newline().   
+00015050: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00015060: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+00015070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015080: 2066 277b 7965 6c6c 6f77 7d7b 6f70 6572   f'{yellow}{oper
+00015090: 6174 696f 6e5f 7374 727d 2c20 7369 6e63  ation_str}, sinc
+000150a0: 6520 6974 2069 7320 666f 756e 6420 746f  e it is found to
+000150b0: 2062 6520 696e 2061 6e20 270a 2020 2020   be in an '.    
+000150c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000150d0: 6627 6162 6e6f 726d 616c 2073 7461 7465  f'abnormal state
+000150e0: 2e20 546f 2066 6978 2c20 7472 7920 7275  . To fix, try ru
+000150f0: 6e6e 696e 673a 207b 7265 7365 747d 7b62  nning: {reset}{b
+00015100: 7269 6768 747d 736b 7920 270a 2020 2020  right}sky '.    
+00015110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015120: 6627 7374 6172 7420 2d66 202d 6920 7b61  f'start -f -i {a
+00015130: 7574 6f73 746f 707d 7b6d 6179 6265 5f64  utostop}{maybe_d
+00015140: 6f77 6e5f 7374 727d 207b 636c 7573 7465  own_str} {cluste
+00015150: 725f 6e61 6d65 7d27 0a20 2020 2020 2020  r_name}'.       
+00015160: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+00015170: 7265 7365 747d 2729 0a20 2020 2020 2020  reset}').       
+00015180: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00015190: 2020 2020 2020 2020 2020 2075 785f 7574             ux_ut
+000151a0: 696c 732e 636f 6e73 6f6c 655f 6e65 776c  ils.console_newl
+000151b0: 696e 6528 290a 2020 2020 2020 2020 2020  ine().          
+000151c0: 2020 2020 2020 6f70 6572 6174 696f 6e5f        operation_
+000151d0: 7374 7220 3d20 2761 7574 6f64 6f77 6e69  str = 'autodowni
+000151e0: 6e67 2720 6966 2072 6563 6f72 645b 0a20  ng' if record[. 
+000151f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015200: 2020 2027 746f 5f64 6f77 6e27 5d20 656c     'to_down'] el
+00015210: 7365 2027 6175 746f 7374 6f70 7069 6e67  se 'autostopping
+00015220: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00015230: 2020 6c6f 6767 6572 2e69 6e66 6f28 0a20    logger.info(. 
+00015240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015250: 2020 2066 2743 6c75 7374 6572 207b 636c     f'Cluster {cl
+00015260: 7573 7465 725f 6e61 6d65 2172 7d20 6973  uster_name!r} is
+00015270: 207b 6f70 6572 6174 696f 6e5f 7374 727d   {operation_str}
+00015280: 2e20 5365 7474 696e 6720 746f 2027 0a20  . Setting to '. 
+00015290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000152a0: 2020 2027 494e 4954 2073 7461 7475 733b     'INIT status;
+000152b0: 2074 7279 2072 6566 7265 7368 2061 6761   try refresh aga
+000152c0: 696e 2069 6e20 6120 7768 696c 652e 2729  in in a while.')
+000152d0: 0a0a 2020 2020 2020 2020 2320 4966 2074  ..        # If t
+000152e0: 6865 2075 7365 7220 7374 6172 7473 2070  he user starts p
+000152f0: 6172 7420 6f66 2061 2053 544f 5050 4544  art of a STOPPED
+00015300: 2063 6c75 7374 6572 2c20 7765 2073 7469   cluster, we sti
+00015310: 6c6c 206e 6565 6420 6120 7374 6174 7573  ll need a status
+00015320: 0a20 2020 2020 2020 2023 2074 6f20 7265  .        # to re
+00015330: 7072 6573 656e 7420 7468 6520 6162 6e6f  present the abno
+00015340: 726d 616c 2073 7461 7475 732e 2046 6f72  rmal status. For
+00015350: 2073 706f 7420 636c 7573 7465 722c 2069   spot cluster, i
+00015360: 7420 6361 6e20 616c 736f 0a20 2020 2020  t can also.     
+00015370: 2020 2023 2072 6570 7265 7365 6e74 2074     # represent t
+00015380: 6861 7420 7468 6520 636c 7573 7465 7220  hat the cluster 
+00015390: 6973 2070 6172 7469 616c 6c79 2070 7265  is partially pre
+000153a0: 656d 7074 6564 2e0a 2020 2020 2020 2020  empted..        
+000153b0: 2320 544f 444f 287a 6877 7529 3a20 7468  # TODO(zhwu): th
+000153c0: 6520 6465 6669 6e69 7469 6f6e 206f 6620  e definition of 
+000153d0: 494e 4954 2073 686f 756c 6420 6265 2061  INIT should be a
+000153e0: 7564 6974 6564 2f63 6861 6e67 6564 2e0a  udited/changed..
+000153f0: 2020 2020 2020 2020 2320 4164 6469 6e67          # Adding
+00015400: 2061 206e 6577 2073 7461 7475 7320 554e   a new status UN
+00015410: 4845 414c 5448 5920 666f 7220 6162 6e6f  HEALTHY for abno
+00015420: 726d 616c 2073 7461 7475 7320 6361 6e20  rmal status can 
+00015430: 6265 2061 2063 686f 6963 652e 0a20 2020  be a choice..   
+00015440: 2020 2020 2067 6c6f 6261 6c5f 7573 6572       global_user
+00015450: 5f73 7461 7465 2e61 6464 5f6f 725f 7570  _state.add_or_up
+00015460: 6461 7465 5f63 6c75 7374 6572 2863 6c75  date_cluster(clu
+00015470: 7374 6572 5f6e 616d 652c 0a20 2020 2020  ster_name,.     
+00015480: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154b0: 2020 2020 2020 2020 2020 2020 6861 6e64              hand
-000154c0: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
+000154a0: 2020 2020 2020 2020 2020 2068 616e 646c             handl
+000154b0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000154c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000154d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154f0: 2020 2020 7265 7175 6573 7465 645f 7265      requested_re
-00015500: 736f 7572 6365 733d 4e6f 6e65 2c0a 2020  sources=None,.  
+000154e0: 2020 2072 6571 7565 7374 6564 5f72 6573     requested_res
+000154f0: 6f75 7263 6573 3d4e 6f6e 652c 0a20 2020  ources=None,.   
+00015500: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015530: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00015540: 6164 793d 4661 6c73 652c 0a20 2020 2020  ady=False,.     
+00015520: 2020 2020 2020 2020 2020 2020 2072 6561               rea
+00015530: 6479 3d46 616c 7365 2c0a 2020 2020 2020  dy=False,.      
+00015540: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015570: 2020 2020 2020 2020 2020 2069 735f 6c61             is_la
-00015580: 756e 6368 3d46 616c 7365 290a 2020 2020  unch=False).    
-00015590: 2020 2020 7265 7475 726e 2067 6c6f 6261      return globa
-000155a0: 6c5f 7573 6572 5f73 7461 7465 2e67 6574  l_user_state.get
-000155b0: 5f63 6c75 7374 6572 5f66 726f 6d5f 6e61  _cluster_from_na
-000155c0: 6d65 2863 6c75 7374 6572 5f6e 616d 6529  me(cluster_name)
-000155d0: 0a20 2020 2023 204e 6f77 2069 735f 6162  .    # Now is_ab
-000155e0: 6e6f 726d 616c 2069 7320 4661 6c73 653a  normal is False:
-000155f0: 2065 6974 6865 7220 6e6f 6465 5f73 7461   either node_sta
-00015600: 7475 7365 7320 6973 2065 6d70 7479 206f  tuses is empty o
-00015610: 7220 616c 6c20 6e6f 6465 7320 6172 650a  r all nodes are.
-00015620: 2020 2020 2320 5354 4f50 5045 442e 0a20      # STOPPED.. 
-00015630: 2020 2062 6163 6b65 6e64 203d 2062 6163     backend = bac
-00015640: 6b65 6e64 732e 436c 6f75 6456 6d52 6179  kends.CloudVmRay
-00015650: 4261 636b 656e 6428 290a 2020 2020 6261  Backend().    ba
-00015660: 636b 656e 642e 706f 7374 5f74 6561 7264  ckend.post_teard
-00015670: 6f77 6e5f 636c 6561 6e75 7028 6861 6e64  own_cleanup(hand
-00015680: 6c65 2c20 7465 726d 696e 6174 653d 746f  le, terminate=to
-00015690: 5f74 6572 6d69 6e61 7465 2c20 7075 7267  _terminate, purg
-000156a0: 653d 4661 6c73 6529 0a20 2020 2072 6574  e=False).    ret
-000156b0: 7572 6e20 676c 6f62 616c 5f75 7365 725f  urn global_user_
-000156c0: 7374 6174 652e 6765 745f 636c 7573 7465  state.get_cluste
-000156d0: 725f 6672 6f6d 5f6e 616d 6528 636c 7573  r_from_name(clus
-000156e0: 7465 725f 6e61 6d65 290a 0a0a 6465 6620  ter_name)...def 
-000156f0: 5f75 7064 6174 655f 636c 7573 7465 725f  _update_cluster_
-00015700: 7374 6174 7573 280a 2020 2020 636c 7573  status(.    clus
-00015710: 7465 725f 6e61 6d65 3a20 7374 722c 0a20  ter_name: str,. 
-00015720: 2020 2061 6371 7569 7265 5f70 6572 5f63     acquire_per_c
-00015730: 6c75 7374 6572 5f73 7461 7475 735f 6c6f  luster_status_lo
-00015740: 636b 3a20 626f 6f6c 2c0a 2020 2020 636c  ck: bool,.    cl
-00015750: 7573 7465 725f 7374 6174 7573 5f6c 6f63  uster_status_loc
-00015760: 6b5f 7469 6d65 6f75 743a 2069 6e74 203d  k_timeout: int =
-00015770: 2043 4c55 5354 4552 5f53 5441 5455 535f   CLUSTER_STATUS_
-00015780: 4c4f 434b 5f54 494d 454f 5554 5f53 4543  LOCK_TIMEOUT_SEC
-00015790: 4f4e 4453 0a29 202d 3e20 4f70 7469 6f6e  ONDS.) -> Option
-000157a0: 616c 5b44 6963 745b 7374 722c 2041 6e79  al[Dict[str, Any
-000157b0: 5d5d 3a0a 2020 2020 2222 2255 7064 6174  ]]:.    """Updat
-000157c0: 6520 7468 6520 636c 7573 7465 7220 7374  e the cluster st
-000157d0: 6174 7573 2e0a 0a20 2020 2054 6865 2063  atus...    The c
-000157e0: 6c75 7374 6572 2073 7461 7475 7320 6973  luster status is
-000157f0: 2075 7064 6174 6564 2062 7920 6368 6563   updated by chec
-00015800: 6b69 6e67 2072 6179 2063 6c75 7374 6572  king ray cluster
-00015810: 2061 6e64 2072 6561 6c20 7374 6174 7573   and real status
-00015820: 2066 726f 6d0a 2020 2020 636c 6f75 642e   from.    cloud.
-00015830: 0a0a 2020 2020 5468 6520 6675 6e63 7469  ..    The functi
-00015840: 6f6e 2077 696c 6c20 7570 6461 7465 2074  on will update t
-00015850: 6865 2063 6163 6865 6420 636c 7573 7465  he cached cluste
-00015860: 7220 7374 6174 7573 2069 6e20 7468 6520  r status in the 
-00015870: 676c 6f62 616c 2073 7461 7465 2e20 466f  global state. Fo
-00015880: 720a 2020 2020 7468 6520 6465 7369 676e  r.    the design
-00015890: 206f 6620 7468 6520 636c 7573 7465 7220   of the cluster 
-000158a0: 7374 6174 7573 2061 6e64 2074 7261 6e73  status and trans
-000158b0: 6974 696f 6e2c 2070 6c65 6173 6520 7265  ition, please re
-000158c0: 6665 7220 746f 2074 6865 0a20 2020 2073  fer to the.    s
-000158d0: 6b79 2f64 6573 6967 6e5f 646f 6373 2f63  ky/design_docs/c
-000158e0: 6c75 7374 6572 5f73 7461 7475 732e 6d64  luster_status.md
-000158f0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-00015900: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
-00015910: 3a20 5468 6520 6e61 6d65 206f 6620 7468  : The name of th
-00015920: 6520 636c 7573 7465 722e 0a20 2020 2020  e cluster..     
-00015930: 2020 2061 6371 7569 7265 5f70 6572 5f63     acquire_per_c
-00015940: 6c75 7374 6572 5f73 7461 7475 735f 6c6f  luster_status_lo
-00015950: 636b 3a20 5768 6574 6865 7220 746f 2061  ck: Whether to a
-00015960: 6371 7569 7265 2074 6865 2070 6572 2d63  cquire the per-c
-00015970: 6c75 7374 6572 206c 6f63 6b0a 2020 2020  luster lock.    
-00015980: 2020 2020 2020 6265 666f 7265 2075 7064        before upd
-00015990: 6174 696e 6720 7468 6520 7374 6174 7573  ating the status
-000159a0: 2e0a 2020 2020 2020 2020 636c 7573 7465  ..        cluste
-000159b0: 725f 7374 6174 7573 5f6c 6f63 6b5f 7469  r_status_lock_ti
-000159c0: 6d65 6f75 743a 2054 6865 2074 696d 656f  meout: The timeo
-000159d0: 7574 2074 6f20 6163 7175 6972 6520 7468  ut to acquire th
-000159e0: 6520 7065 722d 636c 7573 7465 720a 2020  e per-cluster.  
-000159f0: 2020 2020 2020 2020 6c6f 636b 2e0a 0a20          lock... 
-00015a00: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00015a10: 2020 2020 4966 2074 6865 2063 6c75 7374      If the clust
-00015a20: 6572 2069 7320 7465 726d 696e 6174 6564  er is terminated
-00015a30: 206f 7220 646f 6573 206e 6f74 2065 7869   or does not exi
-00015a40: 7374 2c20 7265 7475 726e 204e 6f6e 652e  st, return None.
-00015a50: 204f 7468 6572 7769 7365 0a20 2020 2020   Otherwise.     
-00015a60: 2020 2072 6574 7572 6e73 2074 6865 2069     returns the i
-00015a70: 6e70 7574 2072 6563 6f72 6420 7769 7468  nput record with
-00015a80: 2073 7461 7475 7320 616e 6420 6861 6e64   status and hand
-00015a90: 6c65 2070 6f74 656e 7469 616c 6c79 2075  le potentially u
-00015aa0: 7064 6174 6564 2e0a 0a20 2020 2052 6169  pdated...    Rai
-00015ab0: 7365 733a 0a20 2020 2020 2020 2065 7863  ses:.        exc
-00015ac0: 6570 7469 6f6e 732e 436c 7573 7465 724f  eptions.ClusterO
-00015ad0: 776e 6572 4964 656e 7469 7479 4d69 736d  wnerIdentityMism
-00015ae0: 6174 6368 4572 726f 723a 2069 6620 7468  atchError: if th
-00015af0: 6520 6375 7272 656e 7420 7573 6572 2069  e current user i
-00015b00: 730a 2020 2020 2020 2020 2020 6e6f 7420  s.          not 
-00015b10: 7468 6520 7361 6d65 2061 7320 7468 6520  the same as the 
-00015b20: 7573 6572 2077 686f 2063 7265 6174 6564  user who created
-00015b30: 2074 6865 2063 6c75 7374 6572 2e0a 2020   the cluster..  
-00015b40: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
-00015b50: 2e43 6c6f 7564 5573 6572 4964 656e 7469  .CloudUserIdenti
-00015b60: 7479 4572 726f 723a 2069 6620 7765 2066  tyError: if we f
-00015b70: 6169 6c20 746f 2067 6574 2074 6865 2063  ail to get the c
-00015b80: 7572 7265 6e74 2075 7365 720a 2020 2020  urrent user.    
-00015b90: 2020 2020 2020 6964 656e 7469 7479 2e0a        identity..
-00015ba0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-00015bb0: 6e73 2e43 6c75 7374 6572 5374 6174 7573  ns.ClusterStatus
-00015bc0: 4665 7463 6869 6e67 4572 726f 723a 2074  FetchingError: t
-00015bd0: 6865 2063 6c75 7374 6572 2073 7461 7475  he cluster statu
-00015be0: 7320 6361 6e6e 6f74 2062 650a 2020 2020  s cannot be.    
-00015bf0: 2020 2020 2020 6665 7463 6865 6420 6672        fetched fr
-00015c00: 6f6d 2074 6865 2063 6c6f 7564 2070 726f  om the cloud pro
-00015c10: 7669 6465 7220 6f72 2074 6865 7265 2061  vider or there a
-00015c20: 7265 206c 6561 6b65 6420 6e6f 6465 7320  re leaked nodes 
-00015c30: 6361 7573 696e 670a 2020 2020 2020 2020  causing.        
-00015c40: 2020 7468 6520 6e6f 6465 206e 756d 6265    the node numbe
-00015c50: 7220 6c61 7267 6572 2074 6861 6e20 6578  r larger than ex
-00015c60: 7065 6374 6564 2e0a 2020 2020 2222 220a  pected..    """.
-00015c70: 2020 2020 6966 206e 6f74 2061 6371 7569      if not acqui
-00015c80: 7265 5f70 6572 5f63 6c75 7374 6572 5f73  re_per_cluster_s
-00015c90: 7461 7475 735f 6c6f 636b 3a0a 2020 2020  tatus_lock:.    
-00015ca0: 2020 2020 7265 7475 726e 205f 7570 6461      return _upda
-00015cb0: 7465 5f63 6c75 7374 6572 5f73 7461 7475  te_cluster_statu
-00015cc0: 735f 6e6f 5f6c 6f63 6b28 636c 7573 7465  s_no_lock(cluste
-00015cd0: 725f 6e61 6d65 290a 0a20 2020 2074 7279  r_name)..    try
-00015ce0: 3a0a 2020 2020 2020 2020 7769 7468 2066  :.        with f
-00015cf0: 696c 656c 6f63 6b2e 4669 6c65 4c6f 636b  ilelock.FileLock
-00015d00: 2843 4c55 5354 4552 5f53 5441 5455 535f  (CLUSTER_STATUS_
-00015d10: 4c4f 434b 5f50 4154 482e 666f 726d 6174  LOCK_PATH.format
-00015d20: 2863 6c75 7374 6572 5f6e 616d 6529 2c0a  (cluster_name),.
-00015d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d40: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00015d50: 696d 656f 7574 3d63 6c75 7374 6572 5f73  imeout=cluster_s
-00015d60: 7461 7475 735f 6c6f 636b 5f74 696d 656f  tatus_lock_timeo
-00015d70: 7574 293a 0a20 2020 2020 2020 2020 2020  ut):.           
-00015d80: 2072 6574 7572 6e20 5f75 7064 6174 655f   return _update_
-00015d90: 636c 7573 7465 725f 7374 6174 7573 5f6e  cluster_status_n
-00015da0: 6f5f 6c6f 636b 2863 6c75 7374 6572 5f6e  o_lock(cluster_n
-00015db0: 616d 6529 0a20 2020 2065 7863 6570 7420  ame).    except 
-00015dc0: 6669 6c65 6c6f 636b 2e54 696d 656f 7574  filelock.Timeout
-00015dd0: 3a0a 2020 2020 2020 2020 6c6f 6767 6572  :.        logger
-00015de0: 2e64 6562 7567 2827 5265 6672 6573 6869  .debug('Refreshi
-00015df0: 6e67 2073 7461 7475 733a 2046 6169 6c65  ng status: Faile
-00015e00: 6420 6765 7420 7468 6520 6c6f 636b 2066  d get the lock f
-00015e10: 6f72 2063 6c75 7374 6572 2027 0a20 2020  or cluster '.   
-00015e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e30: 2020 6627 7b63 6c75 7374 6572 5f6e 616d    f'{cluster_nam
-00015e40: 6521 727d 2e20 5573 696e 6720 7468 6520  e!r}. Using the 
-00015e50: 6361 6368 6564 2073 7461 7475 732e 2729  cached status.')
-00015e60: 0a20 2020 2020 2020 2072 6563 6f72 6420  .        record 
-00015e70: 3d20 676c 6f62 616c 5f75 7365 725f 7374  = global_user_st
-00015e80: 6174 652e 6765 745f 636c 7573 7465 725f  ate.get_cluster_
-00015e90: 6672 6f6d 5f6e 616d 6528 636c 7573 7465  from_name(cluste
-00015ea0: 725f 6e61 6d65 290a 2020 2020 2020 2020  r_name).        
-00015eb0: 7265 7475 726e 2072 6563 6f72 640a 0a0a  return record...
-00015ec0: 6465 6620 7265 6672 6573 685f 636c 7573  def refresh_clus
-00015ed0: 7465 725f 7265 636f 7264 280a 2020 2020  ter_record(.    
-00015ee0: 636c 7573 7465 725f 6e61 6d65 3a20 7374  cluster_name: st
-00015ef0: 722c 0a20 2020 202a 2c0a 2020 2020 666f  r,.    *,.    fo
-00015f00: 7263 655f 7265 6672 6573 685f 7374 6174  rce_refresh_stat
-00015f10: 7573 6573 3a20 4f70 7469 6f6e 616c 5b53  uses: Optional[S
-00015f20: 6574 5b73 7461 7475 735f 6c69 622e 436c  et[status_lib.Cl
-00015f30: 7573 7465 7253 7461 7475 735d 5d20 3d20  usterStatus]] = 
-00015f40: 4e6f 6e65 2c0a 2020 2020 6163 7175 6972  None,.    acquir
-00015f50: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
-00015f60: 6174 7573 5f6c 6f63 6b3a 2062 6f6f 6c20  atus_lock: bool 
-00015f70: 3d20 5472 7565 2c0a 2020 2020 636c 7573  = True,.    clus
-00015f80: 7465 725f 7374 6174 7573 5f6c 6f63 6b5f  ter_status_lock_
-00015f90: 7469 6d65 6f75 743a 2069 6e74 203d 2043  timeout: int = C
-00015fa0: 4c55 5354 4552 5f53 5441 5455 535f 4c4f  LUSTER_STATUS_LO
-00015fb0: 434b 5f54 494d 454f 5554 5f53 4543 4f4e  CK_TIMEOUT_SECON
-00015fc0: 4453 0a29 202d 3e20 4f70 7469 6f6e 616c  DS.) -> Optional
-00015fd0: 5b44 6963 745b 7374 722c 2041 6e79 5d5d  [Dict[str, Any]]
-00015fe0: 3a0a 2020 2020 2222 2252 6566 7265 7368  :.    """Refresh
-00015ff0: 2074 6865 2063 6c75 7374 6572 2c20 616e   the cluster, an
-00016000: 6420 7265 7475 726e 2074 6865 2070 6f73  d return the pos
-00016010: 7369 626c 7920 7570 6461 7465 6420 7265  sibly updated re
-00016020: 636f 7264 2e0a 0a20 2020 2054 6869 7320  cord...    This 
-00016030: 6675 6e63 7469 6f6e 2077 696c 6c20 616c  function will al
-00016040: 736f 2063 6865 636b 2074 6865 206f 776e  so check the own
-00016050: 6572 2069 6465 6e74 6974 7920 6f66 2074  er identity of t
-00016060: 6865 2063 6c75 7374 6572 2c20 616e 6420  he cluster, and 
-00016070: 7261 6973 650a 2020 2020 6578 6365 7074  raise.    except
-00016080: 696f 6e73 2069 6620 7468 6520 6375 7272  ions if the curr
-00016090: 656e 7420 7573 6572 2069 7320 6e6f 7420  ent user is not 
-000160a0: 7468 6520 7361 6d65 2061 7320 7468 6520  the same as the 
-000160b0: 7573 6572 2077 686f 2063 7265 6174 6564  user who created
-000160c0: 2074 6865 0a20 2020 2063 6c75 7374 6572   the.    cluster
-000160d0: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-000160e0: 2020 2020 2063 6c75 7374 6572 5f6e 616d       cluster_nam
-000160f0: 653a 2054 6865 206e 616d 6520 6f66 2074  e: The name of t
-00016100: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
-00016110: 2020 2020 666f 7263 655f 7265 6672 6573      force_refres
-00016120: 685f 7374 6174 7573 6573 3a20 6966 2073  h_statuses: if s
-00016130: 7065 6369 6669 6564 2c20 7265 6672 6573  pecified, refres
-00016140: 6820 7468 6520 636c 7573 7465 7220 6966  h the cluster if
-00016150: 2069 7420 6861 7320 6f6e 6520 6f66 0a20   it has one of. 
-00016160: 2020 2020 2020 2020 2074 6865 2073 7065           the spe
-00016170: 6369 6669 6564 2073 7461 7475 7365 732e  cified statuses.
-00016180: 2041 6464 6974 696f 6e61 6c6c 792c 2063   Additionally, c
-00016190: 6c75 7374 6572 7320 7361 7469 7366 7969  lusters satisfyi
-000161a0: 6e67 2074 6865 0a20 2020 2020 2020 2020  ng the.         
-000161b0: 2066 6f6c 6c6f 7769 6e67 2063 6f6e 6469   following condi
-000161c0: 7469 6f6e 7320 7769 6c6c 2061 6c77 6179  tions will alway
-000161d0: 7320 6265 2072 6566 7265 7368 6564 206e  s be refreshed n
-000161e0: 6f20 6d61 7474 6572 2074 6865 0a20 2020  o matter the.   
-000161f0: 2020 2020 2020 2061 7267 756d 656e 7420         argument 
-00016200: 6973 2073 7065 6369 6669 6564 206f 7220  is specified or 
-00016210: 6e6f 743a 0a20 2020 2020 2020 2020 2020  not:.           
-00016220: 2031 2e20 6973 2061 2073 706f 7420 636c   1. is a spot cl
-00016230: 7573 7465 722c 206f 720a 2020 2020 2020  uster, or.      
-00016240: 2020 2020 2020 322e 2069 7320 6120 6e6f        2. is a no
-00016250: 6e2d 7370 6f74 2063 6c75 7374 6572 2c20  n-spot cluster, 
-00016260: 6973 206e 6f74 2053 544f 5050 4544 2c20  is not STOPPED, 
-00016270: 616e 6420 6175 746f 7374 6f70 2069 7320  and autostop is 
-00016280: 7365 742e 0a20 2020 2020 2020 2061 6371  set..        acq
-00016290: 7569 7265 5f70 6572 5f63 6c75 7374 6572  uire_per_cluster
-000162a0: 5f73 7461 7475 735f 6c6f 636b 3a20 5768  _status_lock: Wh
-000162b0: 6574 6865 7220 746f 2061 6371 7569 7265  ether to acquire
-000162c0: 2074 6865 2070 6572 2d63 6c75 7374 6572   the per-cluster
-000162d0: 206c 6f63 6b0a 2020 2020 2020 2020 2020   lock.          
-000162e0: 6265 666f 7265 2075 7064 6174 696e 6720  before updating 
-000162f0: 7468 6520 7374 6174 7573 2e0a 2020 2020  the status..    
-00016300: 2020 2020 636c 7573 7465 725f 7374 6174      cluster_stat
-00016310: 7573 5f6c 6f63 6b5f 7469 6d65 6f75 743a  us_lock_timeout:
-00016320: 2054 6865 2074 696d 656f 7574 2074 6f20   The timeout to 
-00016330: 6163 7175 6972 6520 7468 6520 7065 722d  acquire the per-
-00016340: 636c 7573 7465 720a 2020 2020 2020 2020  cluster.        
-00016350: 2020 6c6f 636b 2e20 4966 2074 696d 656f    lock. If timeo
-00016360: 7574 2c20 7468 6520 6675 6e63 7469 6f6e  ut, the function
-00016370: 2077 696c 6c20 7573 6520 7468 6520 6361   will use the ca
-00016380: 6368 6564 2073 7461 7475 732e 0a0a 2020  ched status...  
-00016390: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-000163a0: 2020 2049 6620 7468 6520 636c 7573 7465     If the cluste
-000163b0: 7220 6973 2074 6572 6d69 6e61 7465 6420  r is terminated 
-000163c0: 6f72 2064 6f65 7320 6e6f 7420 6578 6973  or does not exis
-000163d0: 742c 2072 6574 7572 6e20 4e6f 6e65 2e0a  t, return None..
-000163e0: 2020 2020 2020 2020 4f74 6865 7277 6973          Otherwis
-000163f0: 6520 7265 7475 726e 7320 7468 6520 636c  e returns the cl
-00016400: 7573 7465 7220 7265 636f 7264 2e0a 0a20  uster record... 
-00016410: 2020 2052 6169 7365 733a 0a20 2020 2020     Raises:.     
-00016420: 2020 2065 7863 6570 7469 6f6e 732e 436c     exceptions.Cl
-00016430: 7573 7465 724f 776e 6572 4964 656e 7469  usterOwnerIdenti
-00016440: 7479 4d69 736d 6174 6368 4572 726f 723a  tyMismatchError:
-00016450: 2069 6620 7468 6520 6375 7272 656e 7420   if the current 
-00016460: 7573 6572 2069 730a 2020 2020 2020 2020  user is.        
-00016470: 2020 6e6f 7420 7468 6520 7361 6d65 2061    not the same a
-00016480: 7320 7468 6520 7573 6572 2077 686f 2063  s the user who c
-00016490: 7265 6174 6564 2074 6865 2063 6c75 7374  reated the clust
-000164a0: 6572 2e0a 2020 2020 2020 2020 6578 6365  er..        exce
-000164b0: 7074 696f 6e73 2e43 6c6f 7564 5573 6572  ptions.CloudUser
-000164c0: 4964 656e 7469 7479 4572 726f 723a 2069  IdentityError: i
-000164d0: 6620 7765 2066 6169 6c20 746f 2067 6574  f we fail to get
-000164e0: 2074 6865 2063 7572 7265 6e74 2075 7365   the current use
-000164f0: 720a 2020 2020 2020 2020 2020 6964 656e  r.          iden
-00016500: 7469 7479 2e0a 2020 2020 2020 2020 6578  tity..        ex
-00016510: 6365 7074 696f 6e73 2e43 6c75 7374 6572  ceptions.Cluster
-00016520: 5374 6174 7573 4665 7463 6869 6e67 4572  StatusFetchingEr
-00016530: 726f 723a 2074 6865 2063 6c75 7374 6572  ror: the cluster
-00016540: 2073 7461 7475 7320 6361 6e6e 6f74 2062   status cannot b
-00016550: 650a 2020 2020 2020 2020 2020 6665 7463  e.          fetc
-00016560: 6865 6420 6672 6f6d 2074 6865 2063 6c6f  hed from the clo
-00016570: 7564 2070 726f 7669 6465 7220 6f72 2074  ud provider or t
-00016580: 6865 7265 2061 7265 206c 6561 6b65 6420  here are leaked 
-00016590: 6e6f 6465 7320 6361 7573 696e 670a 2020  nodes causing.  
-000165a0: 2020 2020 2020 2020 7468 6520 6e6f 6465          the node
-000165b0: 206e 756d 6265 7220 6c61 7267 6572 2074   number larger t
-000165c0: 6861 6e20 6578 7065 6374 6564 2e0a 2020  han expected..  
-000165d0: 2020 2222 220a 0a20 2020 2072 6563 6f72    """..    recor
-000165e0: 6420 3d20 676c 6f62 616c 5f75 7365 725f  d = global_user_
-000165f0: 7374 6174 652e 6765 745f 636c 7573 7465  state.get_cluste
-00016600: 725f 6672 6f6d 5f6e 616d 6528 636c 7573  r_from_name(clus
-00016610: 7465 725f 6e61 6d65 290a 2020 2020 6966  ter_name).    if
-00016620: 2072 6563 6f72 6420 6973 204e 6f6e 653a   record is None:
-00016630: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00016640: 4e6f 6e65 0a20 2020 2063 6865 636b 5f6f  None.    check_o
-00016650: 776e 6572 5f69 6465 6e74 6974 7928 636c  wner_identity(cl
-00016660: 7573 7465 725f 6e61 6d65 290a 0a20 2020  uster_name)..   
-00016670: 2068 616e 646c 6520 3d20 7265 636f 7264   handle = record
-00016680: 5b27 6861 6e64 6c65 275d 0a20 2020 2069  ['handle'].    i
-00016690: 6620 6973 696e 7374 616e 6365 2868 616e  f isinstance(han
-000166a0: 646c 652c 2062 6163 6b65 6e64 732e 436c  dle, backends.Cl
-000166b0: 6f75 6456 6d52 6179 5265 736f 7572 6365  oudVmRayResource
-000166c0: 4861 6e64 6c65 293a 0a20 2020 2020 2020  Handle):.       
-000166d0: 2075 7365 5f73 706f 7420 3d20 6861 6e64   use_spot = hand
-000166e0: 6c65 2e6c 6175 6e63 6865 645f 7265 736f  le.launched_reso
-000166f0: 7572 6365 732e 7573 655f 7370 6f74 0a20  urces.use_spot. 
-00016700: 2020 2020 2020 2068 6173 5f61 7574 6f73         has_autos
-00016710: 746f 7020 3d20 2872 6563 6f72 645b 2773  top = (record['s
-00016720: 7461 7475 7327 5d20 213d 2073 7461 7475  tatus'] != statu
-00016730: 735f 6c69 622e 436c 7573 7465 7253 7461  s_lib.ClusterSta
-00016740: 7475 732e 5354 4f50 5045 4420 616e 640a  tus.STOPPED and.
-00016750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016760: 2020 2020 2020 2020 7265 636f 7264 5b27          record['
-00016770: 6175 746f 7374 6f70 275d 203e 3d20 3029  autostop'] >= 0)
-00016780: 0a20 2020 2020 2020 2066 6f72 6365 5f72  .        force_r
-00016790: 6566 7265 7368 5f66 6f72 5f63 6c75 7374  efresh_for_clust
-000167a0: 6572 203d 2028 666f 7263 655f 7265 6672  er = (force_refr
-000167b0: 6573 685f 7374 6174 7573 6573 2069 7320  esh_statuses is 
-000167c0: 6e6f 7420 4e6f 6e65 2061 6e64 0a20 2020  not None and.   
+00015560: 2020 2020 2020 2020 2020 6973 5f6c 6175            is_lau
+00015570: 6e63 683d 4661 6c73 6529 0a20 2020 2020  nch=False).     
+00015580: 2020 2072 6574 7572 6e20 676c 6f62 616c     return global
+00015590: 5f75 7365 725f 7374 6174 652e 6765 745f  _user_state.get_
+000155a0: 636c 7573 7465 725f 6672 6f6d 5f6e 616d  cluster_from_nam
+000155b0: 6528 636c 7573 7465 725f 6e61 6d65 290a  e(cluster_name).
+000155c0: 2020 2020 2320 4e6f 7720 6973 5f61 626e      # Now is_abn
+000155d0: 6f72 6d61 6c20 6973 2046 616c 7365 3a20  ormal is False: 
+000155e0: 6569 7468 6572 206e 6f64 655f 7374 6174  either node_stat
+000155f0: 7573 6573 2069 7320 656d 7074 7920 6f72  uses is empty or
+00015600: 2061 6c6c 206e 6f64 6573 2061 7265 0a20   all nodes are. 
+00015610: 2020 2023 2053 544f 5050 4544 2e0a 2020     # STOPPED..  
+00015620: 2020 6261 636b 656e 6420 3d20 6261 636b    backend = back
+00015630: 656e 6473 2e43 6c6f 7564 566d 5261 7942  ends.CloudVmRayB
+00015640: 6163 6b65 6e64 2829 0a20 2020 2062 6163  ackend().    bac
+00015650: 6b65 6e64 2e70 6f73 745f 7465 6172 646f  kend.post_teardo
+00015660: 776e 5f63 6c65 616e 7570 2868 616e 646c  wn_cleanup(handl
+00015670: 652c 2074 6572 6d69 6e61 7465 3d74 6f5f  e, terminate=to_
+00015680: 7465 726d 696e 6174 652c 2070 7572 6765  terminate, purge
+00015690: 3d46 616c 7365 290a 2020 2020 7265 7475  =False).    retu
+000156a0: 726e 2067 6c6f 6261 6c5f 7573 6572 5f73  rn global_user_s
+000156b0: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
+000156c0: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
+000156d0: 6572 5f6e 616d 6529 0a0a 0a64 6566 205f  er_name)...def _
+000156e0: 7570 6461 7465 5f63 6c75 7374 6572 5f73  update_cluster_s
+000156f0: 7461 7475 7328 0a20 2020 2063 6c75 7374  tatus(.    clust
+00015700: 6572 5f6e 616d 653a 2073 7472 2c0a 2020  er_name: str,.  
+00015710: 2020 6163 7175 6972 655f 7065 725f 636c    acquire_per_cl
+00015720: 7573 7465 725f 7374 6174 7573 5f6c 6f63  uster_status_loc
+00015730: 6b3a 2062 6f6f 6c2c 0a20 2020 2063 6c75  k: bool,.    clu
+00015740: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
+00015750: 5f74 696d 656f 7574 3a20 696e 7420 3d20  _timeout: int = 
+00015760: 434c 5553 5445 525f 5354 4154 5553 5f4c  CLUSTER_STATUS_L
+00015770: 4f43 4b5f 5449 4d45 4f55 545f 5345 434f  OCK_TIMEOUT_SECO
+00015780: 4e44 530a 2920 2d3e 204f 7074 696f 6e61  NDS.) -> Optiona
+00015790: 6c5b 4469 6374 5b73 7472 2c20 416e 795d  l[Dict[str, Any]
+000157a0: 5d3a 0a20 2020 2022 2222 5570 6461 7465  ]:.    """Update
+000157b0: 2074 6865 2063 6c75 7374 6572 2073 7461   the cluster sta
+000157c0: 7475 732e 0a0a 2020 2020 5468 6520 636c  tus...    The cl
+000157d0: 7573 7465 7220 7374 6174 7573 2069 7320  uster status is 
+000157e0: 7570 6461 7465 6420 6279 2063 6865 636b  updated by check
+000157f0: 696e 6720 7261 7920 636c 7573 7465 7220  ing ray cluster 
+00015800: 616e 6420 7265 616c 2073 7461 7475 7320  and real status 
+00015810: 6672 6f6d 0a20 2020 2063 6c6f 7564 2e0a  from.    cloud..
+00015820: 0a20 2020 2054 6865 2066 756e 6374 696f  .    The functio
+00015830: 6e20 7769 6c6c 2075 7064 6174 6520 7468  n will update th
+00015840: 6520 6361 6368 6564 2063 6c75 7374 6572  e cached cluster
+00015850: 2073 7461 7475 7320 696e 2074 6865 2067   status in the g
+00015860: 6c6f 6261 6c20 7374 6174 652e 2046 6f72  lobal state. For
+00015870: 0a20 2020 2074 6865 2064 6573 6967 6e20  .    the design 
+00015880: 6f66 2074 6865 2063 6c75 7374 6572 2073  of the cluster s
+00015890: 7461 7475 7320 616e 6420 7472 616e 7369  tatus and transi
+000158a0: 7469 6f6e 2c20 706c 6561 7365 2072 6566  tion, please ref
+000158b0: 6572 2074 6f20 7468 650a 2020 2020 736b  er to the.    sk
+000158c0: 792f 6465 7369 676e 5f64 6f63 732f 636c  y/design_docs/cl
+000158d0: 7573 7465 725f 7374 6174 7573 2e6d 640a  uster_status.md.
+000158e0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+000158f0: 2020 2063 6c75 7374 6572 5f6e 616d 653a     cluster_name:
+00015900: 2054 6865 206e 616d 6520 6f66 2074 6865   The name of the
+00015910: 2063 6c75 7374 6572 2e0a 2020 2020 2020   cluster..      
+00015920: 2020 6163 7175 6972 655f 7065 725f 636c    acquire_per_cl
+00015930: 7573 7465 725f 7374 6174 7573 5f6c 6f63  uster_status_loc
+00015940: 6b3a 2057 6865 7468 6572 2074 6f20 6163  k: Whether to ac
+00015950: 7175 6972 6520 7468 6520 7065 722d 636c  quire the per-cl
+00015960: 7573 7465 7220 6c6f 636b 0a20 2020 2020  uster lock.     
+00015970: 2020 2020 2062 6566 6f72 6520 7570 6461       before upda
+00015980: 7469 6e67 2074 6865 2073 7461 7475 732e  ting the status.
+00015990: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
+000159a0: 5f73 7461 7475 735f 6c6f 636b 5f74 696d  _status_lock_tim
+000159b0: 656f 7574 3a20 5468 6520 7469 6d65 6f75  eout: The timeou
+000159c0: 7420 746f 2061 6371 7569 7265 2074 6865  t to acquire the
+000159d0: 2070 6572 2d63 6c75 7374 6572 0a20 2020   per-cluster.   
+000159e0: 2020 2020 2020 206c 6f63 6b2e 0a0a 2020         lock...  
+000159f0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+00015a00: 2020 2049 6620 7468 6520 636c 7573 7465     If the cluste
+00015a10: 7220 6973 2074 6572 6d69 6e61 7465 6420  r is terminated 
+00015a20: 6f72 2064 6f65 7320 6e6f 7420 6578 6973  or does not exis
+00015a30: 742c 2072 6574 7572 6e20 4e6f 6e65 2e20  t, return None. 
+00015a40: 4f74 6865 7277 6973 650a 2020 2020 2020  Otherwise.      
+00015a50: 2020 7265 7475 726e 7320 7468 6520 696e    returns the in
+00015a60: 7075 7420 7265 636f 7264 2077 6974 6820  put record with 
+00015a70: 7374 6174 7573 2061 6e64 2068 616e 646c  status and handl
+00015a80: 6520 706f 7465 6e74 6961 6c6c 7920 7570  e potentially up
+00015a90: 6461 7465 642e 0a0a 2020 2020 5261 6973  dated...    Rais
+00015aa0: 6573 3a0a 2020 2020 2020 2020 6578 6365  es:.        exce
+00015ab0: 7074 696f 6e73 2e43 6c75 7374 6572 4f77  ptions.ClusterOw
+00015ac0: 6e65 7249 6465 6e74 6974 794d 6973 6d61  nerIdentityMisma
+00015ad0: 7463 6845 7272 6f72 3a20 6966 2074 6865  tchError: if the
+00015ae0: 2063 7572 7265 6e74 2075 7365 7220 6973   current user is
+00015af0: 0a20 2020 2020 2020 2020 206e 6f74 2074  .          not t
+00015b00: 6865 2073 616d 6520 6173 2074 6865 2075  he same as the u
+00015b10: 7365 7220 7768 6f20 6372 6561 7465 6420  ser who created 
+00015b20: 7468 6520 636c 7573 7465 722e 0a20 2020  the cluster..   
+00015b30: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
+00015b40: 436c 6f75 6455 7365 7249 6465 6e74 6974  CloudUserIdentit
+00015b50: 7945 7272 6f72 3a20 6966 2077 6520 6661  yError: if we fa
+00015b60: 696c 2074 6f20 6765 7420 7468 6520 6375  il to get the cu
+00015b70: 7272 656e 7420 7573 6572 0a20 2020 2020  rrent user.     
+00015b80: 2020 2020 2069 6465 6e74 6974 792e 0a20       identity.. 
+00015b90: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
+00015ba0: 732e 436c 7573 7465 7253 7461 7475 7346  s.ClusterStatusF
+00015bb0: 6574 6368 696e 6745 7272 6f72 3a20 7468  etchingError: th
+00015bc0: 6520 636c 7573 7465 7220 7374 6174 7573  e cluster status
+00015bd0: 2063 616e 6e6f 7420 6265 0a20 2020 2020   cannot be.     
+00015be0: 2020 2020 2066 6574 6368 6564 2066 726f       fetched fro
+00015bf0: 6d20 7468 6520 636c 6f75 6420 7072 6f76  m the cloud prov
+00015c00: 6964 6572 206f 7220 7468 6572 6520 6172  ider or there ar
+00015c10: 6520 6c65 616b 6564 206e 6f64 6573 2063  e leaked nodes c
+00015c20: 6175 7369 6e67 0a20 2020 2020 2020 2020  ausing.         
+00015c30: 2074 6865 206e 6f64 6520 6e75 6d62 6572   the node number
+00015c40: 206c 6172 6765 7220 7468 616e 2065 7870   larger than exp
+00015c50: 6563 7465 642e 0a20 2020 2022 2222 0a20  ected..    """. 
+00015c60: 2020 2069 6620 6e6f 7420 6163 7175 6972     if not acquir
+00015c70: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
+00015c80: 6174 7573 5f6c 6f63 6b3a 0a20 2020 2020  atus_lock:.     
+00015c90: 2020 2072 6574 7572 6e20 5f75 7064 6174     return _updat
+00015ca0: 655f 636c 7573 7465 725f 7374 6174 7573  e_cluster_status
+00015cb0: 5f6e 6f5f 6c6f 636b 2863 6c75 7374 6572  _no_lock(cluster
+00015cc0: 5f6e 616d 6529 0a0a 2020 2020 7472 793a  _name)..    try:
+00015cd0: 0a20 2020 2020 2020 2077 6974 6820 6669  .        with fi
+00015ce0: 6c65 6c6f 636b 2e46 696c 654c 6f63 6b28  lelock.FileLock(
+00015cf0: 434c 5553 5445 525f 5354 4154 5553 5f4c  CLUSTER_STATUS_L
+00015d00: 4f43 4b5f 5041 5448 2e66 6f72 6d61 7428  OCK_PATH.format(
+00015d10: 636c 7573 7465 725f 6e61 6d65 292c 0a20  cluster_name),. 
+00015d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d30: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+00015d40: 6d65 6f75 743d 636c 7573 7465 725f 7374  meout=cluster_st
+00015d50: 6174 7573 5f6c 6f63 6b5f 7469 6d65 6f75  atus_lock_timeou
+00015d60: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+00015d70: 7265 7475 726e 205f 7570 6461 7465 5f63  return _update_c
+00015d80: 6c75 7374 6572 5f73 7461 7475 735f 6e6f  luster_status_no
+00015d90: 5f6c 6f63 6b28 636c 7573 7465 725f 6e61  _lock(cluster_na
+00015da0: 6d65 290a 2020 2020 6578 6365 7074 2066  me).    except f
+00015db0: 696c 656c 6f63 6b2e 5469 6d65 6f75 743a  ilelock.Timeout:
+00015dc0: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+00015dd0: 6465 6275 6728 2752 6566 7265 7368 696e  debug('Refreshin
+00015de0: 6720 7374 6174 7573 3a20 4661 696c 6564  g status: Failed
+00015df0: 2067 6574 2074 6865 206c 6f63 6b20 666f   get the lock fo
+00015e00: 7220 636c 7573 7465 7220 270a 2020 2020  r cluster '.    
+00015e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e20: 2066 277b 636c 7573 7465 725f 6e61 6d65   f'{cluster_name
+00015e30: 2172 7d2e 2055 7369 6e67 2074 6865 2063  !r}. Using the c
+00015e40: 6163 6865 6420 7374 6174 7573 2e27 290a  ached status.').
+00015e50: 2020 2020 2020 2020 7265 636f 7264 203d          record =
+00015e60: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
+00015e70: 7465 2e67 6574 5f63 6c75 7374 6572 5f66  te.get_cluster_f
+00015e80: 726f 6d5f 6e61 6d65 2863 6c75 7374 6572  rom_name(cluster
+00015e90: 5f6e 616d 6529 0a20 2020 2020 2020 2072  _name).        r
+00015ea0: 6574 7572 6e20 7265 636f 7264 0a0a 0a64  eturn record...d
+00015eb0: 6566 2072 6566 7265 7368 5f63 6c75 7374  ef refresh_clust
+00015ec0: 6572 5f72 6563 6f72 6428 0a20 2020 2063  er_record(.    c
+00015ed0: 6c75 7374 6572 5f6e 616d 653a 2073 7472  luster_name: str
+00015ee0: 2c0a 2020 2020 2a2c 0a20 2020 2066 6f72  ,.    *,.    for
+00015ef0: 6365 5f72 6566 7265 7368 5f73 7461 7475  ce_refresh_statu
+00015f00: 7365 733a 204f 7074 696f 6e61 6c5b 5365  ses: Optional[Se
+00015f10: 745b 7374 6174 7573 5f6c 6962 2e43 6c75  t[status_lib.Clu
+00015f20: 7374 6572 5374 6174 7573 5d5d 203d 204e  sterStatus]] = N
+00015f30: 6f6e 652c 0a20 2020 2061 6371 7569 7265  one,.    acquire
+00015f40: 5f70 6572 5f63 6c75 7374 6572 5f73 7461  _per_cluster_sta
+00015f50: 7475 735f 6c6f 636b 3a20 626f 6f6c 203d  tus_lock: bool =
+00015f60: 2054 7275 652c 0a20 2020 2063 6c75 7374   True,.    clust
+00015f70: 6572 5f73 7461 7475 735f 6c6f 636b 5f74  er_status_lock_t
+00015f80: 696d 656f 7574 3a20 696e 7420 3d20 434c  imeout: int = CL
+00015f90: 5553 5445 525f 5354 4154 5553 5f4c 4f43  USTER_STATUS_LOC
+00015fa0: 4b5f 5449 4d45 4f55 545f 5345 434f 4e44  K_TIMEOUT_SECOND
+00015fb0: 530a 2920 2d3e 204f 7074 696f 6e61 6c5b  S.) -> Optional[
+00015fc0: 4469 6374 5b73 7472 2c20 416e 795d 5d3a  Dict[str, Any]]:
+00015fd0: 0a20 2020 2022 2222 5265 6672 6573 6820  .    """Refresh 
+00015fe0: 7468 6520 636c 7573 7465 722c 2061 6e64  the cluster, and
+00015ff0: 2072 6574 7572 6e20 7468 6520 706f 7373   return the poss
+00016000: 6962 6c79 2075 7064 6174 6564 2072 6563  ibly updated rec
+00016010: 6f72 642e 0a0a 2020 2020 5468 6973 2066  ord...    This f
+00016020: 756e 6374 696f 6e20 7769 6c6c 2061 6c73  unction will als
+00016030: 6f20 6368 6563 6b20 7468 6520 6f77 6e65  o check the owne
+00016040: 7220 6964 656e 7469 7479 206f 6620 7468  r identity of th
+00016050: 6520 636c 7573 7465 722c 2061 6e64 2072  e cluster, and r
+00016060: 6169 7365 0a20 2020 2065 7863 6570 7469  aise.    excepti
+00016070: 6f6e 7320 6966 2074 6865 2063 7572 7265  ons if the curre
+00016080: 6e74 2075 7365 7220 6973 206e 6f74 2074  nt user is not t
+00016090: 6865 2073 616d 6520 6173 2074 6865 2075  he same as the u
+000160a0: 7365 7220 7768 6f20 6372 6561 7465 6420  ser who created 
+000160b0: 7468 650a 2020 2020 636c 7573 7465 722e  the.    cluster.
+000160c0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+000160d0: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
+000160e0: 3a20 5468 6520 6e61 6d65 206f 6620 7468  : The name of th
+000160f0: 6520 636c 7573 7465 722e 0a20 2020 2020  e cluster..     
+00016100: 2020 2066 6f72 6365 5f72 6566 7265 7368     force_refresh
+00016110: 5f73 7461 7475 7365 733a 2069 6620 7370  _statuses: if sp
+00016120: 6563 6966 6965 642c 2072 6566 7265 7368  ecified, refresh
+00016130: 2074 6865 2063 6c75 7374 6572 2069 6620   the cluster if 
+00016140: 6974 2068 6173 206f 6e65 206f 660a 2020  it has one of.  
+00016150: 2020 2020 2020 2020 7468 6520 7370 6563          the spec
+00016160: 6966 6965 6420 7374 6174 7573 6573 2e20  ified statuses. 
+00016170: 4164 6469 7469 6f6e 616c 6c79 2c20 636c  Additionally, cl
+00016180: 7573 7465 7273 2073 6174 6973 6679 696e  usters satisfyin
+00016190: 6720 7468 650a 2020 2020 2020 2020 2020  g the.          
+000161a0: 666f 6c6c 6f77 696e 6720 636f 6e64 6974  following condit
+000161b0: 696f 6e73 2077 696c 6c20 616c 7761 7973  ions will always
+000161c0: 2062 6520 7265 6672 6573 6865 6420 6e6f   be refreshed no
+000161d0: 206d 6174 7465 7220 7468 650a 2020 2020   matter the.    
+000161e0: 2020 2020 2020 6172 6775 6d65 6e74 2069        argument i
+000161f0: 7320 7370 6563 6966 6965 6420 6f72 206e  s specified or n
+00016200: 6f74 3a0a 2020 2020 2020 2020 2020 2020  ot:.            
+00016210: 312e 2069 7320 6120 7370 6f74 2063 6c75  1. is a spot clu
+00016220: 7374 6572 2c20 6f72 0a20 2020 2020 2020  ster, or.       
+00016230: 2020 2020 2032 2e20 6973 2061 206e 6f6e       2. is a non
+00016240: 2d73 706f 7420 636c 7573 7465 722c 2069  -spot cluster, i
+00016250: 7320 6e6f 7420 5354 4f50 5045 442c 2061  s not STOPPED, a
+00016260: 6e64 2061 7574 6f73 746f 7020 6973 2073  nd autostop is s
+00016270: 6574 2e0a 2020 2020 2020 2020 6163 7175  et..        acqu
+00016280: 6972 655f 7065 725f 636c 7573 7465 725f  ire_per_cluster_
+00016290: 7374 6174 7573 5f6c 6f63 6b3a 2057 6865  status_lock: Whe
+000162a0: 7468 6572 2074 6f20 6163 7175 6972 6520  ther to acquire 
+000162b0: 7468 6520 7065 722d 636c 7573 7465 7220  the per-cluster 
+000162c0: 6c6f 636b 0a20 2020 2020 2020 2020 2062  lock.          b
+000162d0: 6566 6f72 6520 7570 6461 7469 6e67 2074  efore updating t
+000162e0: 6865 2073 7461 7475 732e 0a20 2020 2020  he status..     
+000162f0: 2020 2063 6c75 7374 6572 5f73 7461 7475     cluster_statu
+00016300: 735f 6c6f 636b 5f74 696d 656f 7574 3a20  s_lock_timeout: 
+00016310: 5468 6520 7469 6d65 6f75 7420 746f 2061  The timeout to a
+00016320: 6371 7569 7265 2074 6865 2070 6572 2d63  cquire the per-c
+00016330: 6c75 7374 6572 0a20 2020 2020 2020 2020  luster.         
+00016340: 206c 6f63 6b2e 2049 6620 7469 6d65 6f75   lock. If timeou
+00016350: 742c 2074 6865 2066 756e 6374 696f 6e20  t, the function 
+00016360: 7769 6c6c 2075 7365 2074 6865 2063 6163  will use the cac
+00016370: 6865 6420 7374 6174 7573 2e0a 0a20 2020  hed status...   
+00016380: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00016390: 2020 4966 2074 6865 2063 6c75 7374 6572    If the cluster
+000163a0: 2069 7320 7465 726d 696e 6174 6564 206f   is terminated o
+000163b0: 7220 646f 6573 206e 6f74 2065 7869 7374  r does not exist
+000163c0: 2c20 7265 7475 726e 204e 6f6e 652e 0a20  , return None.. 
+000163d0: 2020 2020 2020 204f 7468 6572 7769 7365         Otherwise
+000163e0: 2072 6574 7572 6e73 2074 6865 2063 6c75   returns the clu
+000163f0: 7374 6572 2072 6563 6f72 642e 0a0a 2020  ster record...  
+00016400: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
+00016410: 2020 6578 6365 7074 696f 6e73 2e43 6c75    exceptions.Clu
+00016420: 7374 6572 4f77 6e65 7249 6465 6e74 6974  sterOwnerIdentit
+00016430: 794d 6973 6d61 7463 6845 7272 6f72 3a20  yMismatchError: 
+00016440: 6966 2074 6865 2063 7572 7265 6e74 2075  if the current u
+00016450: 7365 7220 6973 0a20 2020 2020 2020 2020  ser is.         
+00016460: 206e 6f74 2074 6865 2073 616d 6520 6173   not the same as
+00016470: 2074 6865 2075 7365 7220 7768 6f20 6372   the user who cr
+00016480: 6561 7465 6420 7468 6520 636c 7573 7465  eated the cluste
+00016490: 722e 0a20 2020 2020 2020 2065 7863 6570  r..        excep
+000164a0: 7469 6f6e 732e 436c 6f75 6455 7365 7249  tions.CloudUserI
+000164b0: 6465 6e74 6974 7945 7272 6f72 3a20 6966  dentityError: if
+000164c0: 2077 6520 6661 696c 2074 6f20 6765 7420   we fail to get 
+000164d0: 7468 6520 6375 7272 656e 7420 7573 6572  the current user
+000164e0: 0a20 2020 2020 2020 2020 2069 6465 6e74  .          ident
+000164f0: 6974 792e 0a20 2020 2020 2020 2065 7863  ity..        exc
+00016500: 6570 7469 6f6e 732e 436c 7573 7465 7253  eptions.ClusterS
+00016510: 7461 7475 7346 6574 6368 696e 6745 7272  tatusFetchingErr
+00016520: 6f72 3a20 7468 6520 636c 7573 7465 7220  or: the cluster 
+00016530: 7374 6174 7573 2063 616e 6e6f 7420 6265  status cannot be
+00016540: 0a20 2020 2020 2020 2020 2066 6574 6368  .          fetch
+00016550: 6564 2066 726f 6d20 7468 6520 636c 6f75  ed from the clou
+00016560: 6420 7072 6f76 6964 6572 206f 7220 7468  d provider or th
+00016570: 6572 6520 6172 6520 6c65 616b 6564 206e  ere are leaked n
+00016580: 6f64 6573 2063 6175 7369 6e67 0a20 2020  odes causing.   
+00016590: 2020 2020 2020 2074 6865 206e 6f64 6520         the node 
+000165a0: 6e75 6d62 6572 206c 6172 6765 7220 7468  number larger th
+000165b0: 616e 2065 7870 6563 7465 642e 0a20 2020  an expected..   
+000165c0: 2022 2222 0a0a 2020 2020 7265 636f 7264   """..    record
+000165d0: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
+000165e0: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
+000165f0: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
+00016600: 6572 5f6e 616d 6529 0a20 2020 2069 6620  er_name).    if 
+00016610: 7265 636f 7264 2069 7320 4e6f 6e65 3a0a  record is None:.
+00016620: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+00016630: 6f6e 650a 2020 2020 6368 6563 6b5f 6f77  one.    check_ow
+00016640: 6e65 725f 6964 656e 7469 7479 2863 6c75  ner_identity(clu
+00016650: 7374 6572 5f6e 616d 6529 0a0a 2020 2020  ster_name)..    
+00016660: 6861 6e64 6c65 203d 2072 6563 6f72 645b  handle = record[
+00016670: 2768 616e 646c 6527 5d0a 2020 2020 6966  'handle'].    if
+00016680: 2069 7369 6e73 7461 6e63 6528 6861 6e64   isinstance(hand
+00016690: 6c65 2c20 6261 636b 656e 6473 2e43 6c6f  le, backends.Clo
+000166a0: 7564 566d 5261 7952 6573 6f75 7263 6548  udVmRayResourceH
+000166b0: 616e 646c 6529 3a0a 2020 2020 2020 2020  andle):.        
+000166c0: 7573 655f 7370 6f74 203d 2068 616e 646c  use_spot = handl
+000166d0: 652e 6c61 756e 6368 6564 5f72 6573 6f75  e.launched_resou
+000166e0: 7263 6573 2e75 7365 5f73 706f 740a 2020  rces.use_spot.  
+000166f0: 2020 2020 2020 6861 735f 6175 746f 7374        has_autost
+00016700: 6f70 203d 2028 7265 636f 7264 5b27 7374  op = (record['st
+00016710: 6174 7573 275d 2021 3d20 7374 6174 7573  atus'] != status
+00016720: 5f6c 6962 2e43 6c75 7374 6572 5374 6174  _lib.ClusterStat
+00016730: 7573 2e53 544f 5050 4544 2061 6e64 0a20  us.STOPPED and. 
+00016740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016750: 2020 2020 2020 2072 6563 6f72 645b 2761         record['a
+00016760: 7574 6f73 746f 7027 5d20 3e3d 2030 290a  utostop'] >= 0).
+00016770: 2020 2020 2020 2020 666f 7263 655f 7265          force_re
+00016780: 6672 6573 685f 666f 725f 636c 7573 7465  fresh_for_cluste
+00016790: 7220 3d20 2866 6f72 6365 5f72 6566 7265  r = (force_refre
+000167a0: 7368 5f73 7461 7475 7365 7320 6973 206e  sh_statuses is n
+000167b0: 6f74 204e 6f6e 6520 616e 640a 2020 2020  ot None and.    
+000167c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000167d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000167e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000167f0: 2020 7265 636f 7264 5b27 7374 6174 7573    record['status
-00016800: 275d 2069 6e20 666f 7263 655f 7265 6672  '] in force_refr
-00016810: 6573 685f 7374 6174 7573 6573 290a 2020  esh_statuses).  
-00016820: 2020 2020 2020 6966 2066 6f72 6365 5f72        if force_r
-00016830: 6566 7265 7368 5f66 6f72 5f63 6c75 7374  efresh_for_clust
-00016840: 6572 206f 7220 6861 735f 6175 746f 7374  er or has_autost
-00016850: 6f70 206f 7220 7573 655f 7370 6f74 3a0a  op or use_spot:.
-00016860: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-00016870: 7264 203d 205f 7570 6461 7465 5f63 6c75  rd = _update_clu
-00016880: 7374 6572 5f73 7461 7475 7328 0a20 2020  ster_status(.   
-00016890: 2020 2020 2020 2020 2020 2020 2063 6c75               clu
-000168a0: 7374 6572 5f6e 616d 652c 0a20 2020 2020  ster_name,.     
-000168b0: 2020 2020 2020 2020 2020 2061 6371 7569             acqui
-000168c0: 7265 5f70 6572 5f63 6c75 7374 6572 5f73  re_per_cluster_s
-000168d0: 7461 7475 735f 6c6f 636b 3d61 6371 7569  tatus_lock=acqui
-000168e0: 7265 5f70 6572 5f63 6c75 7374 6572 5f73  re_per_cluster_s
-000168f0: 7461 7475 735f 6c6f 636b 2c0a 2020 2020  tatus_lock,.    
-00016900: 2020 2020 2020 2020 2020 2020 636c 7573              clus
-00016910: 7465 725f 7374 6174 7573 5f6c 6f63 6b5f  ter_status_lock_
-00016920: 7469 6d65 6f75 743d 636c 7573 7465 725f  timeout=cluster_
-00016930: 7374 6174 7573 5f6c 6f63 6b5f 7469 6d65  status_lock_time
-00016940: 6f75 7429 0a20 2020 2072 6574 7572 6e20  out).    return 
-00016950: 7265 636f 7264 0a0a 0a40 7469 6d65 6c69  record...@timeli
-00016960: 6e65 2e65 7665 6e74 0a64 6566 2072 6566  ne.event.def ref
-00016970: 7265 7368 5f63 6c75 7374 6572 5f73 7461  resh_cluster_sta
-00016980: 7475 735f 6861 6e64 6c65 280a 2020 2020  tus_handle(.    
-00016990: 636c 7573 7465 725f 6e61 6d65 3a20 7374  cluster_name: st
-000169a0: 722c 0a20 2020 202a 2c0a 2020 2020 666f  r,.    *,.    fo
-000169b0: 7263 655f 7265 6672 6573 685f 7374 6174  rce_refresh_stat
-000169c0: 7573 6573 3a20 4f70 7469 6f6e 616c 5b53  uses: Optional[S
-000169d0: 6574 5b73 7461 7475 735f 6c69 622e 436c  et[status_lib.Cl
-000169e0: 7573 7465 7253 7461 7475 735d 5d20 3d20  usterStatus]] = 
-000169f0: 4e6f 6e65 2c0a 2020 2020 6163 7175 6972  None,.    acquir
-00016a00: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
-00016a10: 6174 7573 5f6c 6f63 6b3a 2062 6f6f 6c20  atus_lock: bool 
-00016a20: 3d20 5472 7565 2c0a 2020 2020 636c 7573  = True,.    clus
-00016a30: 7465 725f 7374 6174 7573 5f6c 6f63 6b5f  ter_status_lock_
-00016a40: 7469 6d65 6f75 743a 2069 6e74 203d 2043  timeout: int = C
-00016a50: 4c55 5354 4552 5f53 5441 5455 535f 4c4f  LUSTER_STATUS_LO
-00016a60: 434b 5f54 494d 454f 5554 5f53 4543 4f4e  CK_TIMEOUT_SECON
-00016a70: 4453 0a29 202d 3e20 5475 706c 655b 4f70  DS.) -> Tuple[Op
-00016a80: 7469 6f6e 616c 5b73 7461 7475 735f 6c69  tional[status_li
-00016a90: 622e 436c 7573 7465 7253 7461 7475 735d  b.ClusterStatus]
-00016aa0: 2c0a 2020 2020 2020 2020 2020 204f 7074  ,.           Opt
-00016ab0: 696f 6e61 6c5b 6261 636b 656e 6473 2e52  ional[backends.R
-00016ac0: 6573 6f75 7263 6548 616e 646c 655d 5d3a  esourceHandle]]:
-00016ad0: 0a20 2020 2022 2222 5265 6672 6573 6820  .    """Refresh 
-00016ae0: 7468 6520 636c 7573 7465 722c 2061 6e64  the cluster, and
-00016af0: 2072 6574 7572 6e20 7468 6520 706f 7373   return the poss
-00016b00: 6962 6c79 2075 7064 6174 6564 2073 7461  ibly updated sta
-00016b10: 7475 7320 616e 6420 6861 6e64 6c65 2e0a  tus and handle..
-00016b20: 0a20 2020 2054 6869 7320 6973 2061 2077  .    This is a w
-00016b30: 7261 7070 6572 206f 6620 7265 6672 6573  rapper of refres
-00016b40: 685f 636c 7573 7465 725f 7265 636f 7264  h_cluster_record
-00016b50: 2c20 7768 6963 6820 7265 7475 726e 7320  , which returns 
-00016b60: 7468 6520 7374 6174 7573 2061 6e64 0a20  the status and. 
-00016b70: 2020 2068 616e 646c 6520 6f66 2074 6865     handle of the
-00016b80: 2063 6c75 7374 6572 2e0a 2020 2020 506c   cluster..    Pl
-00016b90: 6561 7365 2072 6566 6572 2074 6f20 7468  ease refer to th
-00016ba0: 6520 646f 6373 7472 696e 6720 6f66 2072  e docstring of r
-00016bb0: 6566 7265 7368 5f63 6c75 7374 6572 5f72  efresh_cluster_r
-00016bc0: 6563 6f72 6420 666f 7220 7468 6520 6465  ecord for the de
-00016bd0: 7461 696c 732e 0a20 2020 2022 2222 0a20  tails..    """. 
-00016be0: 2020 2072 6563 6f72 6420 3d20 7265 6672     record = refr
-00016bf0: 6573 685f 636c 7573 7465 725f 7265 636f  esh_cluster_reco
-00016c00: 7264 280a 2020 2020 2020 2020 636c 7573  rd(.        clus
-00016c10: 7465 725f 6e61 6d65 2c0a 2020 2020 2020  ter_name,.      
-00016c20: 2020 666f 7263 655f 7265 6672 6573 685f    force_refresh_
-00016c30: 7374 6174 7573 6573 3d66 6f72 6365 5f72  statuses=force_r
-00016c40: 6566 7265 7368 5f73 7461 7475 7365 732c  efresh_statuses,
-00016c50: 0a20 2020 2020 2020 2061 6371 7569 7265  .        acquire
-00016c60: 5f70 6572 5f63 6c75 7374 6572 5f73 7461  _per_cluster_sta
-00016c70: 7475 735f 6c6f 636b 3d61 6371 7569 7265  tus_lock=acquire
-00016c80: 5f70 6572 5f63 6c75 7374 6572 5f73 7461  _per_cluster_sta
-00016c90: 7475 735f 6c6f 636b 2c0a 2020 2020 2020  tus_lock,.      
-00016ca0: 2020 636c 7573 7465 725f 7374 6174 7573    cluster_status
-00016cb0: 5f6c 6f63 6b5f 7469 6d65 6f75 743d 636c  _lock_timeout=cl
-00016cc0: 7573 7465 725f 7374 6174 7573 5f6c 6f63  uster_status_loc
-00016cd0: 6b5f 7469 6d65 6f75 7429 0a20 2020 2069  k_timeout).    i
-00016ce0: 6620 7265 636f 7264 2069 7320 4e6f 6e65  f record is None
-00016cf0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00016d00: 204e 6f6e 652c 204e 6f6e 650a 2020 2020   None, None.    
-00016d10: 7265 7475 726e 2072 6563 6f72 645b 2773  return record['s
-00016d20: 7461 7475 7327 5d2c 2072 6563 6f72 645b  tatus'], record[
-00016d30: 2768 616e 646c 6527 5d0a 0a0a 2320 3d3d  'handle']...# ==
+000167e0: 2072 6563 6f72 645b 2773 7461 7475 7327   record['status'
+000167f0: 5d20 696e 2066 6f72 6365 5f72 6566 7265  ] in force_refre
+00016800: 7368 5f73 7461 7475 7365 7329 0a20 2020  sh_statuses).   
+00016810: 2020 2020 2069 6620 666f 7263 655f 7265       if force_re
+00016820: 6672 6573 685f 666f 725f 636c 7573 7465  fresh_for_cluste
+00016830: 7220 6f72 2068 6173 5f61 7574 6f73 746f  r or has_autosto
+00016840: 7020 6f72 2075 7365 5f73 706f 743a 0a20  p or use_spot:. 
+00016850: 2020 2020 2020 2020 2020 2072 6563 6f72             recor
+00016860: 6420 3d20 5f75 7064 6174 655f 636c 7573  d = _update_clus
+00016870: 7465 725f 7374 6174 7573 280a 2020 2020  ter_status(.    
+00016880: 2020 2020 2020 2020 2020 2020 636c 7573              clus
+00016890: 7465 725f 6e61 6d65 2c0a 2020 2020 2020  ter_name,.      
+000168a0: 2020 2020 2020 2020 2020 6163 7175 6972            acquir
+000168b0: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
+000168c0: 6174 7573 5f6c 6f63 6b3d 6163 7175 6972  atus_lock=acquir
+000168d0: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
+000168e0: 6174 7573 5f6c 6f63 6b2c 0a20 2020 2020  atus_lock,.     
+000168f0: 2020 2020 2020 2020 2020 2063 6c75 7374             clust
+00016900: 6572 5f73 7461 7475 735f 6c6f 636b 5f74  er_status_lock_t
+00016910: 696d 656f 7574 3d63 6c75 7374 6572 5f73  imeout=cluster_s
+00016920: 7461 7475 735f 6c6f 636b 5f74 696d 656f  tatus_lock_timeo
+00016930: 7574 290a 2020 2020 7265 7475 726e 2072  ut).    return r
+00016940: 6563 6f72 640a 0a0a 4074 696d 656c 696e  ecord...@timelin
+00016950: 652e 6576 656e 740a 6465 6620 7265 6672  e.event.def refr
+00016960: 6573 685f 636c 7573 7465 725f 7374 6174  esh_cluster_stat
+00016970: 7573 5f68 616e 646c 6528 0a20 2020 2063  us_handle(.    c
+00016980: 6c75 7374 6572 5f6e 616d 653a 2073 7472  luster_name: str
+00016990: 2c0a 2020 2020 2a2c 0a20 2020 2066 6f72  ,.    *,.    for
+000169a0: 6365 5f72 6566 7265 7368 5f73 7461 7475  ce_refresh_statu
+000169b0: 7365 733a 204f 7074 696f 6e61 6c5b 5365  ses: Optional[Se
+000169c0: 745b 7374 6174 7573 5f6c 6962 2e43 6c75  t[status_lib.Clu
+000169d0: 7374 6572 5374 6174 7573 5d5d 203d 204e  sterStatus]] = N
+000169e0: 6f6e 652c 0a20 2020 2061 6371 7569 7265  one,.    acquire
+000169f0: 5f70 6572 5f63 6c75 7374 6572 5f73 7461  _per_cluster_sta
+00016a00: 7475 735f 6c6f 636b 3a20 626f 6f6c 203d  tus_lock: bool =
+00016a10: 2054 7275 652c 0a20 2020 2063 6c75 7374   True,.    clust
+00016a20: 6572 5f73 7461 7475 735f 6c6f 636b 5f74  er_status_lock_t
+00016a30: 696d 656f 7574 3a20 696e 7420 3d20 434c  imeout: int = CL
+00016a40: 5553 5445 525f 5354 4154 5553 5f4c 4f43  USTER_STATUS_LOC
+00016a50: 4b5f 5449 4d45 4f55 545f 5345 434f 4e44  K_TIMEOUT_SECOND
+00016a60: 530a 2920 2d3e 2054 7570 6c65 5b4f 7074  S.) -> Tuple[Opt
+00016a70: 696f 6e61 6c5b 7374 6174 7573 5f6c 6962  ional[status_lib
+00016a80: 2e43 6c75 7374 6572 5374 6174 7573 5d2c  .ClusterStatus],
+00016a90: 0a20 2020 2020 2020 2020 2020 4f70 7469  .           Opti
+00016aa0: 6f6e 616c 5b62 6163 6b65 6e64 732e 5265  onal[backends.Re
+00016ab0: 736f 7572 6365 4861 6e64 6c65 5d5d 3a0a  sourceHandle]]:.
+00016ac0: 2020 2020 2222 2252 6566 7265 7368 2074      """Refresh t
+00016ad0: 6865 2063 6c75 7374 6572 2c20 616e 6420  he cluster, and 
+00016ae0: 7265 7475 726e 2074 6865 2070 6f73 7369  return the possi
+00016af0: 626c 7920 7570 6461 7465 6420 7374 6174  bly updated stat
+00016b00: 7573 2061 6e64 2068 616e 646c 652e 0a0a  us and handle...
+00016b10: 2020 2020 5468 6973 2069 7320 6120 7772      This is a wr
+00016b20: 6170 7065 7220 6f66 2072 6566 7265 7368  apper of refresh
+00016b30: 5f63 6c75 7374 6572 5f72 6563 6f72 642c  _cluster_record,
+00016b40: 2077 6869 6368 2072 6574 7572 6e73 2074   which returns t
+00016b50: 6865 2073 7461 7475 7320 616e 640a 2020  he status and.  
+00016b60: 2020 6861 6e64 6c65 206f 6620 7468 6520    handle of the 
+00016b70: 636c 7573 7465 722e 0a20 2020 2050 6c65  cluster..    Ple
+00016b80: 6173 6520 7265 6665 7220 746f 2074 6865  ase refer to the
+00016b90: 2064 6f63 7374 7269 6e67 206f 6620 7265   docstring of re
+00016ba0: 6672 6573 685f 636c 7573 7465 725f 7265  fresh_cluster_re
+00016bb0: 636f 7264 2066 6f72 2074 6865 2064 6574  cord for the det
+00016bc0: 6169 6c73 2e0a 2020 2020 2222 220a 2020  ails..    """.  
+00016bd0: 2020 7265 636f 7264 203d 2072 6566 7265    record = refre
+00016be0: 7368 5f63 6c75 7374 6572 5f72 6563 6f72  sh_cluster_recor
+00016bf0: 6428 0a20 2020 2020 2020 2063 6c75 7374  d(.        clust
+00016c00: 6572 5f6e 616d 652c 0a20 2020 2020 2020  er_name,.       
+00016c10: 2066 6f72 6365 5f72 6566 7265 7368 5f73   force_refresh_s
+00016c20: 7461 7475 7365 733d 666f 7263 655f 7265  tatuses=force_re
+00016c30: 6672 6573 685f 7374 6174 7573 6573 2c0a  fresh_statuses,.
+00016c40: 2020 2020 2020 2020 6163 7175 6972 655f          acquire_
+00016c50: 7065 725f 636c 7573 7465 725f 7374 6174  per_cluster_stat
+00016c60: 7573 5f6c 6f63 6b3d 6163 7175 6972 655f  us_lock=acquire_
+00016c70: 7065 725f 636c 7573 7465 725f 7374 6174  per_cluster_stat
+00016c80: 7573 5f6c 6f63 6b2c 0a20 2020 2020 2020  us_lock,.       
+00016c90: 2063 6c75 7374 6572 5f73 7461 7475 735f   cluster_status_
+00016ca0: 6c6f 636b 5f74 696d 656f 7574 3d63 6c75  lock_timeout=clu
+00016cb0: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
+00016cc0: 5f74 696d 656f 7574 290a 2020 2020 6966  _timeout).    if
+00016cd0: 2072 6563 6f72 6420 6973 204e 6f6e 653a   record is None:
+00016ce0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00016cf0: 4e6f 6e65 2c20 4e6f 6e65 0a20 2020 2072  None, None.    r
+00016d00: 6574 7572 6e20 7265 636f 7264 5b27 7374  eturn record['st
+00016d10: 6174 7573 275d 2c20 7265 636f 7264 5b27  atus'], record['
+00016d20: 6861 6e64 6c65 275d 0a0a 0a23 203d 3d3d  handle']...# ===
+00016d30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 00016d40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00016d50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00016d60: 3d3d 3d0a 0a0a 4074 7970 696e 672e 6f76  ===...@typing.ov
-00016d70: 6572 6c6f 6164 0a64 6566 2063 6865 636b  erload.def check
-00016d80: 5f63 6c75 7374 6572 5f61 7661 696c 6162  _cluster_availab
-00016d90: 6c65 280a 2020 2020 636c 7573 7465 725f  le(.    cluster_
-00016da0: 6e61 6d65 3a20 7374 722c 0a20 2020 202a  name: str,.    *
-00016db0: 2c0a 2020 2020 6f70 6572 6174 696f 6e3a  ,.    operation:
-00016dc0: 2073 7472 2c0a 2020 2020 6368 6563 6b5f   str,.    check_
-00016dd0: 636c 6f75 645f 766d 5f72 6179 5f62 6163  cloud_vm_ray_bac
-00016de0: 6b65 6e64 3a20 4c69 7465 7261 6c5b 5472  kend: Literal[Tr
-00016df0: 7565 5d20 3d20 5472 7565 2c0a 2020 2020  ue] = True,.    
-00016e00: 6472 7972 756e 3a20 626f 6f6c 203d 202e  dryrun: bool = .
-00016e10: 2e2e 2c0a 2920 2d3e 2027 636c 6f75 645f  ..,.) -> 'cloud_
-00016e20: 766d 5f72 6179 5f62 6163 6b65 6e64 2e43  vm_ray_backend.C
-00016e30: 6c6f 7564 566d 5261 7952 6573 6f75 7263  loudVmRayResourc
-00016e40: 6548 616e 646c 6527 3a0a 2020 2020 2e2e  eHandle':.    ..
-00016e50: 2e0a 0a0a 4074 7970 696e 672e 6f76 6572  ....@typing.over
-00016e60: 6c6f 6164 0a64 6566 2063 6865 636b 5f63  load.def check_c
-00016e70: 6c75 7374 6572 5f61 7661 696c 6162 6c65  luster_available
-00016e80: 280a 2020 2020 636c 7573 7465 725f 6e61  (.    cluster_na
-00016e90: 6d65 3a20 7374 722c 0a20 2020 202a 2c0a  me: str,.    *,.
-00016ea0: 2020 2020 6f70 6572 6174 696f 6e3a 2073      operation: s
-00016eb0: 7472 2c0a 2020 2020 6368 6563 6b5f 636c  tr,.    check_cl
-00016ec0: 6f75 645f 766d 5f72 6179 5f62 6163 6b65  oud_vm_ray_backe
-00016ed0: 6e64 3a20 4c69 7465 7261 6c5b 4661 6c73  nd: Literal[Fals
-00016ee0: 655d 2c0a 2020 2020 6472 7972 756e 3a20  e],.    dryrun: 
-00016ef0: 626f 6f6c 203d 202e 2e2e 2c0a 2920 2d3e  bool = ...,.) ->
-00016f00: 2062 6163 6b65 6e64 732e 5265 736f 7572   backends.Resour
-00016f10: 6365 4861 6e64 6c65 3a0a 2020 2020 2e2e  ceHandle:.    ..
-00016f20: 2e0a 0a0a 6465 6620 6368 6563 6b5f 636c  ....def check_cl
-00016f30: 7573 7465 725f 6176 6169 6c61 626c 6528  uster_available(
-00016f40: 0a20 2020 2063 6c75 7374 6572 5f6e 616d  .    cluster_nam
-00016f50: 653a 2073 7472 2c0a 2020 2020 2a2c 0a20  e: str,.    *,. 
-00016f60: 2020 206f 7065 7261 7469 6f6e 3a20 7374     operation: st
-00016f70: 722c 0a20 2020 2063 6865 636b 5f63 6c6f  r,.    check_clo
-00016f80: 7564 5f76 6d5f 7261 795f 6261 636b 656e  ud_vm_ray_backen
-00016f90: 643a 2062 6f6f 6c20 3d20 5472 7565 2c0a  d: bool = True,.
-00016fa0: 2020 2020 6472 7972 756e 3a20 626f 6f6c      dryrun: bool
-00016fb0: 203d 2046 616c 7365 2c0a 2920 2d3e 2062   = False,.) -> b
-00016fc0: 6163 6b65 6e64 732e 5265 736f 7572 6365  ackends.Resource
-00016fd0: 4861 6e64 6c65 3a0a 2020 2020 2222 2243  Handle:.    """C
-00016fe0: 6865 636b 2069 6620 7468 6520 636c 7573  heck if the clus
-00016ff0: 7465 7220 6973 2061 7661 696c 6162 6c65  ter is available
-00017000: 2e0a 0a20 2020 2052 6169 7365 733a 0a20  ...    Raises:. 
-00017010: 2020 2020 2020 2056 616c 7565 4572 726f         ValueErro
-00017020: 723a 2069 6620 7468 6520 636c 7573 7465  r: if the cluste
-00017030: 7220 646f 6573 206e 6f74 2065 7869 7374  r does not exist
-00017040: 2e0a 2020 2020 2020 2020 6578 6365 7074  ..        except
-00017050: 696f 6e73 2e43 6c75 7374 6572 4e6f 7455  ions.ClusterNotU
-00017060: 7045 7272 6f72 3a20 6966 2074 6865 2063  pError: if the c
-00017070: 6c75 7374 6572 2069 7320 6e6f 7420 5550  luster is not UP
-00017080: 2e0a 2020 2020 2020 2020 6578 6365 7074  ..        except
-00017090: 696f 6e73 2e4e 6f74 5375 7070 6f72 7465  ions.NotSupporte
-000170a0: 6445 7272 6f72 3a20 6966 2074 6865 2063  dError: if the c
-000170b0: 6c75 7374 6572 2069 7320 6e6f 7420 6261  luster is not ba
-000170c0: 7365 6420 6f6e 0a20 2020 2020 2020 2020  sed on.         
-000170d0: 2043 6c6f 7564 566d 5261 7942 6163 6b65   CloudVmRayBacke
-000170e0: 6e64 2e0a 2020 2020 2020 2020 6578 6365  nd..        exce
-000170f0: 7074 696f 6e73 2e43 6c75 7374 6572 4f77  ptions.ClusterOw
-00017100: 6e65 7249 6465 6e74 6974 794d 6973 6d61  nerIdentityMisma
-00017110: 7463 6845 7272 6f72 3a20 6966 2074 6865  tchError: if the
-00017120: 2063 7572 7265 6e74 2075 7365 7220 6973   current user is
-00017130: 0a20 2020 2020 2020 2020 206e 6f74 2074  .          not t
-00017140: 6865 2073 616d 6520 6173 2074 6865 2075  he same as the u
-00017150: 7365 7220 7768 6f20 6372 6561 7465 6420  ser who created 
-00017160: 7468 6520 636c 7573 7465 722e 0a20 2020  the cluster..   
-00017170: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
-00017180: 436c 6f75 6455 7365 7249 6465 6e74 6974  CloudUserIdentit
-00017190: 7945 7272 6f72 3a20 6966 2077 6520 6661  yError: if we fa
-000171a0: 696c 2074 6f20 6765 7420 7468 6520 6375  il to get the cu
-000171b0: 7272 656e 7420 7573 6572 0a20 2020 2020  rrent user.     
-000171c0: 2020 2020 2069 6465 6e74 6974 792e 0a20       identity.. 
-000171d0: 2020 2022 2222 0a20 2020 2072 6563 6f72     """.    recor
-000171e0: 6420 3d20 676c 6f62 616c 5f75 7365 725f  d = global_user_
-000171f0: 7374 6174 652e 6765 745f 636c 7573 7465  state.get_cluste
-00017200: 725f 6672 6f6d 5f6e 616d 6528 636c 7573  r_from_name(clus
-00017210: 7465 725f 6e61 6d65 290a 2020 2020 6966  ter_name).    if
-00017220: 2064 7279 7275 6e3a 0a20 2020 2020 2020   dryrun:.       
-00017230: 2061 7373 6572 7420 7265 636f 7264 2069   assert record i
-00017240: 7320 6e6f 7420 4e6f 6e65 2c20 636c 7573  s not None, clus
-00017250: 7465 725f 6e61 6d65 0a20 2020 2020 2020  ter_name.       
-00017260: 2072 6574 7572 6e20 7265 636f 7264 5b27   return record['
-00017270: 6861 6e64 6c65 275d 0a0a 2020 2020 7072  handle']..    pr
-00017280: 6576 696f 7573 5f63 6c75 7374 6572 5f73  evious_cluster_s
-00017290: 7461 7475 7320 3d20 4e6f 6e65 0a20 2020  tatus = None.   
-000172a0: 2069 6620 7265 636f 7264 2069 7320 6e6f   if record is no
-000172b0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000172c0: 7072 6576 696f 7573 5f63 6c75 7374 6572  previous_cluster
-000172d0: 5f73 7461 7475 7320 3d20 7265 636f 7264  _status = record
-000172e0: 5b27 7374 6174 7573 275d 0a0a 2020 2020  ['status']..    
-000172f0: 7472 793a 0a20 2020 2020 2020 2063 6c75  try:.        clu
-00017300: 7374 6572 5f73 7461 7475 732c 2068 616e  ster_status, han
-00017310: 646c 6520 3d20 7265 6672 6573 685f 636c  dle = refresh_cl
-00017320: 7573 7465 725f 7374 6174 7573 5f68 616e  uster_status_han
-00017330: 646c 6528 636c 7573 7465 725f 6e61 6d65  dle(cluster_name
-00017340: 290a 2020 2020 6578 6365 7074 2065 7863  ).    except exc
-00017350: 6570 7469 6f6e 732e 436c 7573 7465 7253  eptions.ClusterS
-00017360: 7461 7475 7346 6574 6368 696e 6745 7272  tatusFetchingErr
-00017370: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
-00017380: 2023 2046 6169 6c65 6420 746f 2072 6566   # Failed to ref
-00017390: 7265 7368 2074 6865 2063 6c75 7374 6572  resh the cluster
-000173a0: 2073 7461 7475 7320 6973 206e 6f74 2066   status is not f
-000173b0: 6174 616c 2065 7272 6f72 2061 7320 7468  atal error as th
-000173c0: 6520 6361 6c6c 6572 730a 2020 2020 2020  e callers.      
-000173d0: 2020 2320 6361 6e20 7374 696c 6c20 6265    # can still be
-000173e0: 2064 6f6e 6520 6279 206f 6e6c 7920 7573   done by only us
-000173f0: 696e 6720 7373 682c 2062 7574 2074 6865  ing ssh, but the
-00017400: 2073 7368 2063 616e 2068 616e 6720 6966   ssh can hang if
-00017410: 2074 6865 0a20 2020 2020 2020 2023 2063   the.        # c
-00017420: 6c75 7374 6572 2069 7320 6e6f 7420 7570  luster is not up
-00017430: 2028 652e 672e 2c20 6175 746f 7374 6f70   (e.g., autostop
-00017440: 7065 6429 2e0a 0a20 2020 2020 2020 2023  ped)...        #
-00017450: 2057 6520 646f 206e 6f74 2063 6174 6368   We do not catch
-00017460: 2074 6865 2065 7863 6570 7469 6f6e 2066   the exception f
-00017470: 6f72 2063 6c6f 7564 2069 6465 6e74 6974  or cloud identit
-00017480: 7920 6368 6563 6b69 6e67 2066 6f72 206e  y checking for n
-00017490: 6f77 2c20 696e 0a20 2020 2020 2020 2023  ow, in.        #
-000174a0: 206f 7264 6572 2074 6f20 6469 7361 626c   order to disabl
-000174b0: 6520 616c 6c20 6f70 6572 6174 696f 6e73  e all operations
-000174c0: 206f 6e20 636c 7573 7465 7273 2063 7265   on clusters cre
-000174d0: 6174 6564 2062 7920 616e 6f74 6865 7220  ated by another 
-000174e0: 7573 6572 0a20 2020 2020 2020 2023 2069  user.        # i
-000174f0: 6465 6e74 6974 792e 2020 5468 6174 2077  dentity.  That w
-00017500: 696c 6c20 6d61 6b65 2074 6865 2064 6573  ill make the des
-00017510: 6967 6e20 7369 6d70 6c65 7220 616e 6420  ign simpler and 
-00017520: 6561 7369 6572 2074 6f0a 2020 2020 2020  easier to.      
-00017530: 2020 2320 756e 6465 7273 7461 6e64 2c20    # understand, 
-00017540: 6275 7420 6974 206d 6967 6874 2062 6520  but it might be 
-00017550: 7573 6566 756c 2074 6f20 616c 6c6f 7720  useful to allow 
-00017560: 7468 6520 7573 6572 2074 6f20 7573 650a  the user to use.
-00017570: 2020 2020 2020 2020 2320 6f70 6572 6174          # operat
-00017580: 696f 6e73 2074 6861 7420 6f6e 6c79 2069  ions that only i
-00017590: 6e76 6f6c 7665 2073 7368 2028 652e 672e  nvolve ssh (e.g.
-000175a0: 2c20 736b 7920 6578 6563 2c20 736b 7920  , sky exec, sky 
-000175b0: 6c6f 6773 2c20 6574 6329 2065 7665 6e0a  logs, etc) even.
-000175c0: 2020 2020 2020 2020 2320 6966 2074 6865          # if the
-000175d0: 2075 7365 7220 6973 206e 6f74 2074 6865   user is not the
-000175e0: 206f 776e 6572 206f 6620 7468 6520 636c   owner of the cl
-000175f0: 7573 7465 722e 0a20 2020 2020 2020 2075  uster..        u
-00017600: 785f 7574 696c 732e 636f 6e73 6f6c 655f  x_utils.console_
-00017610: 6e65 776c 696e 6528 290a 2020 2020 2020  newline().      
-00017620: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
-00017630: 280a 2020 2020 2020 2020 2020 2020 6627  (.            f'
-00017640: 4661 696c 6564 2074 6f20 7265 6672 6573  Failed to refres
-00017650: 6820 7468 6520 7374 6174 7573 2066 6f72  h the status for
-00017660: 2063 6c75 7374 6572 207b 636c 7573 7465   cluster {cluste
-00017670: 725f 6e61 6d65 2172 7d2e 2049 7420 6973  r_name!r}. It is
-00017680: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-00017690: 276e 6f74 2066 6174 616c 2c20 6275 7420  'not fatal, but 
-000176a0: 7b6f 7065 7261 7469 6f6e 7d20 6d69 6768  {operation} migh
-000176b0: 7420 6861 6e67 2069 6620 7468 6520 636c  t hang if the cl
-000176c0: 7573 7465 7220 6973 206e 6f74 2075 702e  uster is not up.
-000176d0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-000176e0: 6627 4465 7461 696c 6564 2072 6561 736f  f'Detailed reaso
-000176f0: 6e3a 207b 657d 2729 0a20 2020 2020 2020  n: {e}').       
-00017700: 2069 6620 7265 636f 7264 2069 7320 4e6f   if record is No
-00017710: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00017720: 636c 7573 7465 725f 7374 6174 7573 2c20  cluster_status, 
-00017730: 6861 6e64 6c65 203d 204e 6f6e 652c 204e  handle = None, N
-00017740: 6f6e 650a 2020 2020 2020 2020 656c 7365  one.        else
-00017750: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-00017760: 7573 7465 725f 7374 6174 7573 2c20 6861  uster_status, ha
-00017770: 6e64 6c65 203d 2072 6563 6f72 645b 2773  ndle = record['s
-00017780: 7461 7475 7327 5d2c 2072 6563 6f72 645b  tatus'], record[
-00017790: 2768 616e 646c 6527 5d0a 0a20 2020 2062  'handle']..    b
-000177a0: 7269 6768 7420 3d20 636f 6c6f 7261 6d61  right = colorama
-000177b0: 2e53 7479 6c65 2e42 5249 4748 540a 2020  .Style.BRIGHT.  
-000177c0: 2020 7265 7365 7420 3d20 636f 6c6f 7261    reset = colora
-000177d0: 6d61 2e53 7479 6c65 2e52 4553 4554 5f41  ma.Style.RESET_A
-000177e0: 4c4c 0a20 2020 2069 6620 6861 6e64 6c65  LL.    if handle
-000177f0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00017800: 2020 6966 2070 7265 7669 6f75 735f 636c    if previous_cl
-00017810: 7573 7465 725f 7374 6174 7573 2069 7320  uster_status is 
-00017820: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00017830: 2020 6572 726f 725f 6d73 6720 3d20 6627    error_msg = f'
-00017840: 436c 7573 7465 7220 7b63 6c75 7374 6572  Cluster {cluster
-00017850: 5f6e 616d 6521 727d 2064 6f65 7320 6e6f  _name!r} does no
-00017860: 7420 6578 6973 742e 270a 2020 2020 2020  t exist.'.      
-00017870: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00017880: 2020 2020 6572 726f 725f 6d73 6720 3d20      error_msg = 
-00017890: 2866 2743 6c75 7374 6572 207b 636c 7573  (f'Cluster {clus
-000178a0: 7465 725f 6e61 6d65 2172 7d20 6e6f 7420  ter_name!r} not 
-000178b0: 666f 756e 6420 6f6e 2074 6865 2063 6c6f  found on the clo
-000178c0: 7564 2027 0a20 2020 2020 2020 2020 2020  ud '.           
-000178d0: 2020 2020 2020 2020 2020 2020 2020 2770                'p
-000178e0: 726f 7669 6465 722e 2729 0a20 2020 2020  rovider.').     
-000178f0: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
-00017900: 636f 7264 2069 7320 6e6f 7420 4e6f 6e65  cord is not None
-00017910: 2c20 7072 6576 696f 7573 5f63 6c75 7374  , previous_clust
-00017920: 6572 5f73 7461 7475 730a 2020 2020 2020  er_status.      
-00017930: 2020 2020 2020 6163 7469 6f6e 7320 3d20        actions = 
-00017940: 5b5d 0a20 2020 2020 2020 2020 2020 2069  [].            i
-00017950: 6620 7265 636f 7264 5b27 6861 6e64 6c65  f record['handle
-00017960: 275d 2e6c 6175 6e63 6865 645f 7265 736f  '].launched_reso
-00017970: 7572 6365 732e 7573 655f 7370 6f74 3a0a  urces.use_spot:.
-00017980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017990: 6163 7469 6f6e 732e 6170 7065 6e64 2827  actions.append('
-000179a0: 7072 6565 6d70 7465 6427 290a 2020 2020  preempted').    
-000179b0: 2020 2020 2020 2020 6966 2072 6563 6f72          if recor
-000179c0: 645b 2761 7574 6f73 746f 7027 5d20 3e20  d['autostop'] > 
-000179d0: 3020 616e 6420 7265 636f 7264 5b27 746f  0 and record['to
-000179e0: 5f64 6f77 6e27 5d3a 0a20 2020 2020 2020  _down']:.       
-000179f0: 2020 2020 2020 2020 2061 6374 696f 6e73           actions
-00017a00: 2e61 7070 656e 6428 2761 7574 6f64 6f77  .append('autodow
-00017a10: 6e65 6427 290a 2020 2020 2020 2020 2020  ned').          
-00017a20: 2020 6163 7469 6f6e 732e 6170 7065 6e64    actions.append
-00017a30: 2827 6d61 6e75 616c 6c79 2074 6572 6d69  ('manually termi
-00017a40: 6e61 7465 6420 696e 2063 6f6e 736f 6c65  nated in console
-00017a50: 2729 0a20 2020 2020 2020 2020 2020 2069  ').            i
-00017a60: 6620 6c65 6e28 6163 7469 6f6e 7329 203e  f len(actions) >
-00017a70: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00017a80: 2020 2020 6163 7469 6f6e 735b 2d31 5d20      actions[-1] 
-00017a90: 3d20 276f 7220 2720 2b20 6163 7469 6f6e  = 'or ' + action
-00017aa0: 735b 2d31 5d0a 2020 2020 2020 2020 2020  s[-1].          
-00017ab0: 2020 6163 7469 6f6e 735f 7374 7220 3d20    actions_str = 
-00017ac0: 272c 2027 2e6a 6f69 6e28 6163 7469 6f6e  ', '.join(action
-00017ad0: 7329 0a20 2020 2020 2020 2020 2020 206d  s).            m
-00017ae0: 6573 7361 6765 203d 2066 2720 4974 2077  essage = f' It w
-00017af0: 6173 206c 696b 656c 7920 7b61 6374 696f  as likely {actio
-00017b00: 6e73 5f73 7472 7d2e 270a 2020 2020 2020  ns_str}.'.      
-00017b10: 2020 2020 2020 6966 206c 656e 2861 6374        if len(act
-00017b20: 696f 6e73 2920 3e20 313a 0a20 2020 2020  ions) > 1:.     
-00017b30: 2020 2020 2020 2020 2020 206d 6573 7361             messa
-00017b40: 6765 203d 206d 6573 7361 6765 2e72 6570  ge = message.rep
-00017b50: 6c61 6365 2827 6c69 6b65 6c79 272c 2027  lace('likely', '
-00017b60: 6569 7468 6572 2729 0a20 2020 2020 2020  either').       
-00017b70: 2020 2020 2065 7272 6f72 5f6d 7367 202b       error_msg +
-00017b80: 3d20 6d65 7373 6167 650a 0a20 2020 2020  = message..     
-00017b90: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
-00017ba0: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
-00017bb0: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
-00017bc0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00017bd0: 7365 2056 616c 7565 4572 726f 7228 6627  se ValueError(f'
-00017be0: 7b63 6f6c 6f72 616d 612e 466f 7265 2e59  {colorama.Fore.Y
-00017bf0: 454c 4c4f 577d 7b65 7272 6f72 5f6d 7367  ELLOW}{error_msg
-00017c00: 7d7b 7265 7365 747d 2729 0a20 2020 2061  }{reset}').    a
-00017c10: 7373 6572 7420 636c 7573 7465 725f 7374  ssert cluster_st
-00017c20: 6174 7573 2069 7320 6e6f 7420 4e6f 6e65  atus is not None
-00017c30: 2c20 2768 616e 646c 6520 6973 206e 6f74  , 'handle is not
-00017c40: 204e 6f6e 6520 6275 7420 7374 6174 7573   None but status
-00017c50: 2069 7320 4e6f 6e65 270a 2020 2020 6261   is None'.    ba
-00017c60: 636b 656e 6420 3d20 6765 745f 6261 636b  ckend = get_back
-00017c70: 656e 645f 6672 6f6d 5f68 616e 646c 6528  end_from_handle(
-00017c80: 6861 6e64 6c65 290a 2020 2020 6966 2063  handle).    if c
-00017c90: 6865 636b 5f63 6c6f 7564 5f76 6d5f 7261  heck_cloud_vm_ra
-00017ca0: 795f 6261 636b 656e 6420 616e 6420 6e6f  y_backend and no
-00017cb0: 7420 6973 696e 7374 616e 6365 280a 2020  t isinstance(.  
-00017cc0: 2020 2020 2020 2020 2020 6261 636b 656e            backen
-00017cd0: 642c 2062 6163 6b65 6e64 732e 436c 6f75  d, backends.Clou
-00017ce0: 6456 6d52 6179 4261 636b 656e 6429 3a0a  dVmRayBackend):.
-00017cf0: 2020 2020 2020 2020 7769 7468 2075 785f          with ux_
-00017d00: 7574 696c 732e 7072 696e 745f 6578 6365  utils.print_exce
-00017d10: 7074 696f 6e5f 6e6f 5f74 7261 6365 6261  ption_no_traceba
-00017d20: 636b 2829 3a0a 2020 2020 2020 2020 2020  ck():.          
-00017d30: 2020 7261 6973 6520 6578 6365 7074 696f    raise exceptio
-00017d40: 6e73 2e4e 6f74 5375 7070 6f72 7465 6445  ns.NotSupportedE
-00017d50: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00017d60: 2020 2020 2020 6627 7b63 6f6c 6f72 616d        f'{coloram
-00017d70: 612e 466f 7265 2e59 454c 4c4f 577d 7b6f  a.Fore.YELLOW}{o
-00017d80: 7065 7261 7469 6f6e 2e63 6170 6974 616c  peration.capital
-00017d90: 697a 6528 297d 3a20 736b 6970 7065 6420  ize()}: skipped 
-00017da0: 666f 7220 270a 2020 2020 2020 2020 2020  for '.          
-00017db0: 2020 2020 2020 6627 636c 7573 7465 7220        f'cluster 
-00017dc0: 7b63 6c75 7374 6572 5f6e 616d 6521 727d  {cluster_name!r}
-00017dd0: 2e20 4974 2069 7320 6f6e 6c79 2073 7570  . It is only sup
-00017de0: 706f 7274 6564 2062 7920 6261 636b 656e  ported by backen
-00017df0: 643a 2027 0a20 2020 2020 2020 2020 2020  d: '.           
-00017e00: 2020 2020 2066 277b 6261 636b 656e 6473       f'{backends
-00017e10: 2e43 6c6f 7564 566d 5261 7942 6163 6b65  .CloudVmRayBacke
-00017e20: 6e64 2e4e 414d 457d 2e27 0a20 2020 2020  nd.NAME}.'.     
-00017e30: 2020 2020 2020 2020 2020 2066 277b 7265             f'{re
-00017e40: 7365 747d 2729 0a20 2020 2069 6620 636c  set}').    if cl
-00017e50: 7573 7465 725f 7374 6174 7573 2021 3d20  uster_status != 
-00017e60: 7374 6174 7573 5f6c 6962 2e43 6c75 7374  status_lib.Clust
-00017e70: 6572 5374 6174 7573 2e55 503a 0a20 2020  erStatus.UP:.   
-00017e80: 2020 2020 2077 6974 6820 7578 5f75 7469       with ux_uti
-00017e90: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
-00017ea0: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
-00017eb0: 293a 0a20 2020 2020 2020 2020 2020 2068  ):.            h
-00017ec0: 696e 745f 666f 725f 696e 6974 203d 2027  int_for_init = '
-00017ed0: 270a 2020 2020 2020 2020 2020 2020 6966  '.            if
-00017ee0: 2063 6c75 7374 6572 5f73 7461 7475 7320   cluster_status 
-00017ef0: 3d3d 2073 7461 7475 735f 6c69 622e 436c  == status_lib.Cl
-00017f00: 7573 7465 7253 7461 7475 732e 494e 4954  usterStatus.INIT
-00017f10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017f20: 2020 6869 6e74 5f66 6f72 5f69 6e69 7420    hint_for_init 
-00017f30: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00017f40: 2020 2020 2020 2020 6627 7b72 6573 6574          f'{reset
-00017f50: 7d20 5761 6974 2066 6f72 2061 206c 6175  } Wait for a lau
-00017f60: 6e63 6820 746f 2066 696e 6973 682c 206f  nch to finish, o
-00017f70: 7220 7573 6520 7468 6973 2063 6f6d 6d61  r use this comma
-00017f80: 6e64 2027 0a20 2020 2020 2020 2020 2020  nd '.           
-00017f90: 2020 2020 2020 2020 2066 2774 6f20 7472           f'to tr
-00017fa0: 7920 746f 2074 7261 6e73 6974 696f 6e20  y to transition 
-00017fb0: 7468 6520 636c 7573 7465 7220 746f 2055  the cluster to U
-00017fc0: 503a 207b 6272 6967 6874 7d73 6b79 2027  P: {bright}sky '
-00017fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017fe0: 2020 2020 2066 2773 7461 7274 207b 636c       f'start {cl
-00017ff0: 7573 7465 725f 6e61 6d65 7d7b 7265 7365  uster_name}{rese
-00018000: 747d 2729 0a20 2020 2020 2020 2020 2020  t}').           
-00018010: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
-00018020: 732e 436c 7573 7465 724e 6f74 5570 4572  s.ClusterNotUpEr
-00018030: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00018040: 2020 2020 2066 277b 636f 6c6f 7261 6d61       f'{colorama
-00018050: 2e46 6f72 652e 5945 4c4c 4f57 7d7b 6f70  .Fore.YELLOW}{op
-00018060: 6572 6174 696f 6e2e 6361 7069 7461 6c69  eration.capitali
-00018070: 7a65 2829 7d3a 2073 6b69 7070 6564 2066  ze()}: skipped f
-00018080: 6f72 2027 0a20 2020 2020 2020 2020 2020  or '.           
-00018090: 2020 2020 2066 2763 6c75 7374 6572 207b       f'cluster {
-000180a0: 636c 7573 7465 725f 6e61 6d65 2172 7d20  cluster_name!r} 
-000180b0: 2873 7461 7475 733a 207b 636c 7573 7465  (status: {cluste
-000180c0: 725f 7374 6174 7573 2e76 616c 7565 7d29  r_status.value})
-000180d0: 2e20 270a 2020 2020 2020 2020 2020 2020  . '.            
-000180e0: 2020 2020 2749 7420 6973 206f 6e6c 7920      'It is only 
-000180f0: 616c 6c6f 7765 6420 666f 7220 270a 2020  allowed for '.  
-00018100: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00018110: 7b73 7461 7475 735f 6c69 622e 436c 7573  {status_lib.Clus
-00018120: 7465 7253 7461 7475 732e 5550 2e76 616c  terStatus.UP.val
-00018130: 7565 7d20 636c 7573 7465 7273 2e27 0a20  ue} clusters.'. 
-00018140: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00018150: 277b 6869 6e74 5f66 6f72 5f69 6e69 747d  '{hint_for_init}
-00018160: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00018170: 2020 6627 7b72 6573 6574 7d27 2c0a 2020    f'{reset}',.  
-00018180: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-00018190: 7573 7465 725f 7374 6174 7573 3d63 6c75  uster_status=clu
-000181a0: 7374 6572 5f73 7461 7475 732c 0a20 2020  ster_status,.   
-000181b0: 2020 2020 2020 2020 2020 2020 2068 616e               han
-000181c0: 646c 653d 6861 6e64 6c65 290a 0a20 2020  dle=handle)..   
-000181d0: 2069 6620 6861 6e64 6c65 2e68 6561 645f   if handle.head_
-000181e0: 6970 2069 7320 4e6f 6e65 3a0a 2020 2020  ip is None:.    
-000181f0: 2020 2020 7769 7468 2075 785f 7574 696c      with ux_util
-00018200: 732e 7072 696e 745f 6578 6365 7074 696f  s.print_exceptio
-00018210: 6e5f 6e6f 5f74 7261 6365 6261 636b 2829  n_no_traceback()
-00018220: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00018230: 6973 6520 6578 6365 7074 696f 6e73 2e43  ise exceptions.C
-00018240: 6c75 7374 6572 4e6f 7455 7045 7272 6f72  lusterNotUpError
-00018250: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00018260: 2020 6627 436c 7573 7465 7220 7b63 6c75    f'Cluster {clu
-00018270: 7374 6572 5f6e 616d 6521 727d 2068 6173  ster_name!r} has
-00018280: 2062 6565 6e20 7374 6f70 7065 6420 6f72   been stopped or
-00018290: 206e 6f74 2070 726f 7065 726c 7920 270a   not properly '.
-000182a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000182b0: 2773 6574 2075 702e 2050 6c65 6173 6520  'set up. Please 
-000182c0: 7265 2d6c 6175 6e63 6820 6974 2077 6974  re-launch it wit
-000182d0: 6820 6073 6b79 2073 7461 7274 602e 272c  h `sky start`.',
-000182e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000182f0: 2063 6c75 7374 6572 5f73 7461 7475 733d   cluster_status=
-00018300: 636c 7573 7465 725f 7374 6174 7573 2c0a  cluster_status,.
-00018310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018320: 6861 6e64 6c65 3d68 616e 646c 6529 0a20  handle=handle). 
-00018330: 2020 2072 6574 7572 6e20 6861 6e64 6c65     return handle
-00018340: 0a0a 0a23 2054 4f44 4f28 7469 616e 293a  ...# TODO(tian):
-00018350: 2052 6566 6163 746f 7220 746f 2063 6f6e   Refactor to con
-00018360: 7472 6f6c 6c65 725f 7574 696c 732e 2043  troller_utils. C
-00018370: 7572 7265 6e74 2062 6c6f 636b 6572 3a20  urrent blocker: 
-00018380: 6369 7263 756c 6172 2069 6d70 6f72 742e  circular import.
-00018390: 0a64 6566 2069 735f 636f 6e74 726f 6c6c  .def is_controll
-000183a0: 6572 5f61 6363 6573 7369 626c 6528 0a20  er_accessible(. 
-000183b0: 2020 2063 6f6e 7472 6f6c 6c65 725f 7479     controller_ty
-000183c0: 7065 3a20 636f 6e74 726f 6c6c 6572 5f75  pe: controller_u
-000183d0: 7469 6c73 2e43 6f6e 7472 6f6c 6c65 7273  tils.Controllers
-000183e0: 2c0a 2020 2020 7374 6f70 7065 645f 6d65  ,.    stopped_me
-000183f0: 7373 6167 653a 2073 7472 2c0a 2020 2020  ssage: str,.    
-00018400: 6e6f 6e5f 6578 6973 7465 6e74 5f6d 6573  non_existent_mes
-00018410: 7361 6765 3a20 4f70 7469 6f6e 616c 5b73  sage: Optional[s
-00018420: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-00018430: 6578 6974 5f69 665f 6e6f 745f 6163 6365  exit_if_not_acce
-00018440: 7373 6962 6c65 3a20 626f 6f6c 203d 2046  ssible: bool = F
-00018450: 616c 7365 2c0a 2920 2d3e 2027 6261 636b  alse,.) -> 'back
-00018460: 656e 6473 2e43 6c6f 7564 566d 5261 7952  ends.CloudVmRayR
-00018470: 6573 6f75 7263 6548 616e 646c 6527 3a0a  esourceHandle':.
-00018480: 2020 2020 2222 2243 6865 636b 2069 6620      """Check if 
-00018490: 7468 6520 7370 6f74 2f73 6572 7665 2063  the spot/serve c
-000184a0: 6f6e 7472 6f6c 6c65 7220 6973 2075 702e  ontroller is up.
-000184b0: 0a0a 2020 2020 5468 6520 636f 6e74 726f  ..    The contro
-000184c0: 6c6c 6572 2069 7320 6163 6365 7373 6962  ller is accessib
-000184d0: 6c65 2077 6865 6e20 6974 2069 7320 696e  le when it is in
-000184e0: 2055 5020 6f72 2049 4e49 5420 7374 6174   UP or INIT stat
-000184f0: 652c 2061 6e64 2074 6865 2073 7368 0a20  e, and the ssh. 
-00018500: 2020 2063 6f6e 6e65 6374 696f 6e20 6973     connection is
-00018510: 2073 7563 6365 7373 6675 6c2e 0a0a 2020   successful...  
-00018520: 2020 4974 2063 616e 2062 6520 7573 6564    It can be used
-00018530: 2074 6f20 6368 6563 6b20 6966 2074 6865   to check if the
-00018540: 2063 6f6e 7472 6f6c 6c65 7220 6973 2061   controller is a
-00018550: 6363 6573 7369 626c 6520 2873 696e 6365  ccessible (since
-00018560: 2074 6865 2061 7574 6f73 746f 700a 2020   the autostop.  
-00018570: 2020 6973 2073 6574 2066 6f72 2074 6865    is set for the
-00018580: 2063 6f6e 7472 6f6c 6c65 7229 2062 6566   controller) bef
-00018590: 6f72 6520 7468 6520 7370 6f74 2f73 6572  ore the spot/ser
-000185a0: 7665 2063 6f6d 6d61 6e64 7320 696e 7465  ve commands inte
-000185b0: 7261 6374 2077 6974 6820 7468 650a 2020  ract with the.  
-000185c0: 2020 636f 6e74 726f 6c6c 6572 2e0a 0a20    controller... 
-000185d0: 2020 2043 6c75 7374 6572 4e6f 7455 7045     ClusterNotUpE
-000185e0: 7272 6f72 2077 696c 6c20 6265 2072 6169  rror will be rai
-000185f0: 7365 6420 7768 656e 6576 6572 2074 6865  sed whenever the
-00018600: 2063 6f6e 7472 6f6c 6c65 7220 6361 6e6e   controller cann
-00018610: 6f74 2062 6520 6163 6365 7373 6564 2e0a  ot be accessed..
-00018620: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-00018630: 2020 2074 7970 653a 2054 7970 6520 6f66     type: Type of
-00018640: 2074 6865 2063 6f6e 7472 6f6c 6c65 722e   the controller.
-00018650: 0a20 2020 2020 2020 2073 746f 7070 6564  .        stopped
-00018660: 5f6d 6573 7361 6765 3a20 4d65 7373 6167  _message: Messag
-00018670: 6520 746f 2070 7269 6e74 2069 6620 7468  e to print if th
-00018680: 6520 636f 6e74 726f 6c6c 6572 2069 7320  e controller is 
-00018690: 5354 4f50 5045 442e 0a20 2020 2020 2020  STOPPED..       
-000186a0: 206e 6f6e 5f65 7869 7374 656e 745f 6d65   non_existent_me
-000186b0: 7373 6167 653a 204d 6573 7361 6765 2074  ssage: Message t
-000186c0: 6f20 7368 6f77 2069 6620 7468 6520 636f  o show if the co
-000186d0: 6e74 726f 6c6c 6572 2064 6f65 7320 6e6f  ntroller does no
-000186e0: 7420 6578 6973 742e 0a20 2020 2020 2020  t exist..       
-000186f0: 2065 7869 745f 6966 5f6e 6f74 5f61 6363   exit_if_not_acc
-00018700: 6573 7369 626c 653a 2057 6865 7468 6572  essible: Whether
-00018710: 2074 6f20 6578 6974 2064 6972 6563 746c   to exit directl
-00018720: 7920 6966 2074 6865 2063 6f6e 7472 6f6c  y if the control
-00018730: 6c65 7220 6973 206e 6f74 0a20 2020 2020  ler is not.     
-00018740: 2020 2020 2061 6363 6573 7369 626c 652e       accessible.
-00018750: 2049 6620 4661 6c73 652c 2074 6865 2066   If False, the f
-00018760: 756e 6374 696f 6e20 7769 6c6c 2072 6169  unction will rai
-00018770: 7365 2043 6c75 7374 6572 4e6f 7455 7045  se ClusterNotUpE
-00018780: 7272 6f72 2e0a 0a20 2020 2052 6574 7572  rror...    Retur
-00018790: 6e73 3a0a 2020 2020 2020 2020 6861 6e64  ns:.        hand
-000187a0: 6c65 3a20 5468 6520 5265 736f 7572 6365  le: The Resource
-000187b0: 4861 6e64 6c65 206f 6620 7468 6520 636f  Handle of the co
-000187c0: 6e74 726f 6c6c 6572 2e0a 0a20 2020 2052  ntroller...    R
-000187d0: 6169 7365 733a 0a20 2020 2020 2020 2065  aises:.        e
-000187e0: 7863 6570 7469 6f6e 732e 436c 7573 7465  xceptions.Cluste
-000187f0: 724f 776e 6572 4964 656e 7469 7479 4d69  rOwnerIdentityMi
-00018800: 736d 6174 6368 4572 726f 723a 2069 6620  smatchError: if 
-00018810: 7468 6520 6375 7272 656e 7420 7573 6572  the current user
-00018820: 2069 7320 6e6f 740a 2020 2020 2020 2020   is not.        
-00018830: 2020 7468 6520 7361 6d65 2061 7320 7468    the same as th
-00018840: 6520 7573 6572 2077 686f 2063 7265 6174  e user who creat
-00018850: 6564 2074 6865 2063 6c75 7374 6572 2e0a  ed the cluster..
-00018860: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-00018870: 6e73 2e43 6c6f 7564 5573 6572 4964 656e  ns.CloudUserIden
-00018880: 7469 7479 4572 726f 723a 2069 6620 7765  tityError: if we
-00018890: 2066 6169 6c20 746f 2067 6574 2074 6865   fail to get the
-000188a0: 2063 7572 7265 6e74 2075 7365 720a 2020   current user.  
-000188b0: 2020 2020 2020 2020 6964 656e 7469 7479          identity
-000188c0: 2e0a 2020 2020 2020 2020 6578 6365 7074  ..        except
-000188d0: 696f 6e73 2e43 6c75 7374 6572 4e6f 7455  ions.ClusterNotU
-000188e0: 7045 7272 6f72 3a20 6966 2074 6865 2063  pError: if the c
-000188f0: 6f6e 7472 6f6c 6c65 7220 6973 206e 6f74  ontroller is not
-00018900: 2061 6363 6573 7369 626c 652c 206f 720a   accessible, or.
-00018910: 2020 2020 2020 2020 2020 6661 696c 6564            failed
-00018920: 2074 6f20 6265 2063 6f6e 6e65 6374 6564   to be connected
-00018930: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
-00018940: 206e 6f6e 5f65 7869 7374 656e 745f 6d65   non_existent_me
-00018950: 7373 6167 6520 6973 204e 6f6e 653a 0a20  ssage is None:. 
-00018960: 2020 2020 2020 206e 6f6e 5f65 7869 7374         non_exist
-00018970: 656e 745f 6d65 7373 6167 6520 3d20 280a  ent_message = (.
-00018980: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00018990: 726f 6c6c 6572 5f74 7970 652e 7661 6c75  roller_type.valu
-000189a0: 652e 6465 6661 756c 745f 6869 6e74 5f69  e.default_hint_i
-000189b0: 665f 6e6f 6e5f 6578 6973 7465 6e74 290a  f_non_existent).
-000189c0: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
-000189d0: 203d 2063 6f6e 7472 6f6c 6c65 725f 7479   = controller_ty
-000189e0: 7065 2e76 616c 7565 2e63 6c75 7374 6572  pe.value.cluster
-000189f0: 5f6e 616d 650a 2020 2020 636f 6e74 726f  _name.    contro
-00018a00: 6c6c 6572 5f6e 616d 6520 3d20 636f 6e74  ller_name = cont
-00018a10: 726f 6c6c 6572 5f74 7970 652e 7661 6c75  roller_type.valu
-00018a20: 652e 6e61 6d65 2e72 6570 6c61 6365 2827  e.name.replace('
-00018a30: 2063 6f6e 7472 6f6c 6c65 7227 2c20 2727   controller', ''
-00018a40: 290a 2020 2020 6e65 6564 5f63 6f6e 6e65  ).    need_conne
-00018a50: 6374 696f 6e5f 6368 6563 6b20 3d20 4661  ction_check = Fa
-00018a60: 6c73 650a 2020 2020 636f 6e74 726f 6c6c  lse.    controll
-00018a70: 6572 5f73 7461 7475 732c 2068 616e 646c  er_status, handl
-00018a80: 6520 3d20 4e6f 6e65 2c20 4e6f 6e65 0a20  e = None, None. 
-00018a90: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00018aa0: 2320 5365 7420 666f 7263 655f 7265 6672  # Set force_refr
-00018ab0: 6573 685f 7374 6174 7573 6573 3d5b 494e  esh_statuses=[IN
-00018ac0: 4954 5d20 746f 206d 616b 6520 7375 7265  IT] to make sure
-00018ad0: 2074 6865 2072 6566 7265 7368 2068 6170   the refresh hap
-00018ae0: 7065 6e73 0a20 2020 2020 2020 2023 2077  pens.        # w
-00018af0: 6865 6e20 7468 6520 636f 6e74 726f 6c6c  hen the controll
-00018b00: 6572 2069 7320 494e 4954 2f55 5020 2874  er is INIT/UP (t
-00018b10: 7269 6767 6572 6564 2069 6e20 7468 6573  riggered in thes
-00018b20: 6520 7374 6174 7573 6573 2061 7320 7468  e statuses as th
-00018b30: 650a 2020 2020 2020 2020 2320 6175 746f  e.        # auto
-00018b40: 7374 6f70 2069 7320 616c 7761 7973 2073  stop is always s
-00018b50: 6574 2066 6f72 2074 6865 2063 6f6e 7472  et for the contr
-00018b60: 6f6c 6c65 7229 2e20 5468 6520 636f 6e74  oller). The cont
-00018b70: 726f 6c6c 6572 2063 616e 2062 6520 696e  roller can be in
-00018b80: 0a20 2020 2020 2020 2023 2066 6f6c 6c6f  .        # follo
-00018b90: 7769 6e67 2063 6173 6573 3a0a 2020 2020  wing cases:.    
-00018ba0: 2020 2020 2320 2a20 2855 502c 2061 7574      # * (UP, aut
-00018bb0: 6f73 746f 7020 7365 7429 3a20 6974 2077  ostop set): it w
-00018bc0: 696c 6c20 6265 2072 6566 7265 7368 6564  ill be refreshed
-00018bd0: 2077 6974 686f 7574 2066 6f72 6365 5f72   without force_r
-00018be0: 6566 7265 7368 2073 6574 2e0a 2020 2020  efresh set..    
-00018bf0: 2020 2020 2320 2a20 2855 502c 206e 6f20      # * (UP, no 
-00018c00: 6175 746f 7374 6f70 293a 2076 6572 7920  autostop): very 
-00018c10: 7261 7265 2028 6120 7573 6572 2063 7472  rare (a user ctr
-00018c20: 6c2d 6320 7768 656e 2074 6865 2063 6f6e  l-c when the con
-00018c30: 7472 6f6c 6c65 7220 6973 0a20 2020 2020  troller is.     
-00018c40: 2020 2023 2020 206c 6175 6e63 6869 6e67     #   launching
-00018c50: 292c 2064 6f65 7320 6e6f 7420 6d61 7474  ), does not matt
-00018c60: 6572 2069 6620 7265 6672 6573 6820 6f72  er if refresh or
-00018c70: 206e 6f74 2c20 7369 6e63 6520 6e6f 2061   not, since no a
-00018c80: 7574 6f73 746f 702e 2057 650a 2020 2020  utostop. We.    
-00018c90: 2020 2020 2320 2020 646f 6e27 7420 696e      #   don't in
-00018ca0: 636c 7564 6520 5550 2069 6e20 666f 7263  clude UP in forc
-00018cb0: 655f 7265 6672 6573 685f 7374 6174 7573  e_refresh_status
-00018cc0: 6573 2074 6f20 6176 6f69 6420 6f76 6572  es to avoid over
-00018cd0: 6865 6164 732e 0a20 2020 2020 2020 2023  heads..        #
-00018ce0: 202a 2028 494e 4954 2c20 6175 746f 7374   * (INIT, autost
-00018cf0: 6f70 2073 6574 290a 2020 2020 2020 2020  op set).        
-00018d00: 2320 2a20 2849 4e49 542c 206e 6f20 6175  # * (INIT, no au
-00018d10: 746f 7374 6f70 293a 2076 6572 7920 7261  tostop): very ra
-00018d20: 7265 2028 5f75 7064 6174 655f 636c 7573  re (_update_clus
-00018d30: 7465 725f 7374 6174 7573 5f6e 6f5f 6c6f  ter_status_no_lo
-00018d40: 636b 206d 6179 0a20 2020 2020 2020 2023  ck may.        #
-00018d50: 2020 2072 6573 6574 206c 6f63 616c 2061     reset local a
-00018d60: 7574 6f73 746f 7020 636f 6e66 6967 292c  utostop config),
-00018d70: 2062 7574 2066 6f72 6365 5f72 6566 7265   but force_refre
-00018d80: 7368 2077 696c 6c20 6d61 6b65 2073 7572  sh will make sur
-00018d90: 650a 2020 2020 2020 2020 2320 2020 7374  e.        #   st
-00018da0: 6174 7573 2069 7320 7265 6672 6573 6865  atus is refreshe
-00018db0: 642e 0a20 2020 2020 2020 2023 0a20 2020  d..        #.   
-00018dc0: 2020 2020 2023 2057 6520 6176 6f69 6473       # We avoids
-00018dd0: 2075 6e6e 6563 6573 7361 7279 2063 6f73   unnecessary cos
-00018de0: 746c 7920 7265 6672 6573 6820 7768 656e  tly refresh when
-00018df0: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
-00018e00: 6973 2061 6c72 6561 6479 0a20 2020 2020  is already.     
-00018e10: 2020 2023 2053 544f 5050 4544 2e20 5468     # STOPPED. Th
-00018e20: 6973 206f 7074 696d 697a 6174 696f 6e20  is optimization 
-00018e30: 6973 2062 6173 6564 206f 6e20 7468 6520  is based on the 
-00018e40: 6173 7375 6d70 7469 6f6e 2074 6861 7420  assumption that 
-00018e50: 7468 6520 7573 6572 0a20 2020 2020 2020  the user.       
-00018e60: 2023 2077 696c 6c20 6e6f 7420 7374 6172   # will not star
-00018e70: 7420 7468 6520 636f 6e74 726f 6c6c 6572  t the controller
-00018e80: 206d 616e 7561 6c6c 7920 6672 6f6d 2074   manually from t
-00018e90: 6865 2063 6c6f 7564 2063 6f6e 736f 6c65  he cloud console
-00018ea0: 2e0a 2020 2020 2020 2020 230a 2020 2020  ..        #.    
-00018eb0: 2020 2020 2320 5468 6520 6163 7175 6972      # The acquir
-00018ec0: 655f 6c6f 636b 5f74 696d 656f 7574 2069  e_lock_timeout i
-00018ed0: 7320 7365 7420 746f 2030 2074 6f20 6176  s set to 0 to av
-00018ee0: 6f69 6420 6861 6e67 696e 6720 7468 6520  oid hanging the 
-00018ef0: 636f 6d6d 616e 6420 7768 656e 0a20 2020  command when.   
-00018f00: 2020 2020 2023 206d 756c 7469 706c 6520       # multiple 
-00018f10: 7370 6f74 5f6c 6175 6e63 6820 636f 6d6d  spot_launch comm
-00018f20: 616e 6473 2061 7265 2072 756e 6e69 6e67  ands are running
-00018f30: 2061 7420 7468 6520 7361 6d65 2074 696d   at the same tim
-00018f40: 652e 204f 7572 206c 6174 6572 0a20 2020  e. Our later.   
-00018f50: 2020 2020 2023 2063 6f64 6520 7769 6c6c       # code will
-00018f60: 2063 6865 636b 2069 6620 7468 6520 636f   check if the co
-00018f70: 6e74 726f 6c6c 6572 2069 7320 6163 6365  ntroller is acce
-00018f80: 7373 6962 6c65 2062 7920 6469 7265 6374  ssible by direct
-00018f90: 6c79 2063 6865 636b 696e 670a 2020 2020  ly checking.    
-00018fa0: 2020 2020 2320 7468 6520 7373 6820 636f      # the ssh co
-00018fb0: 6e6e 6563 7469 6f6e 2074 6f20 7468 6520  nnection to the 
-00018fc0: 636f 6e74 726f 6c6c 6572 2c20 6966 2069  controller, if i
-00018fd0: 7420 6661 696c 7320 746f 2067 6574 2061  t fails to get a
-00018fe0: 6363 7572 6174 650a 2020 2020 2020 2020  ccurate.        
-00018ff0: 2320 7374 6174 7573 206f 6620 7468 6520  # status of the 
-00019000: 636f 6e74 726f 6c6c 6572 2e0a 2020 2020  controller..    
-00019010: 2020 2020 636f 6e74 726f 6c6c 6572 5f73      controller_s
-00019020: 7461 7475 732c 2068 616e 646c 6520 3d20  tatus, handle = 
-00019030: 7265 6672 6573 685f 636c 7573 7465 725f  refresh_cluster_
-00019040: 7374 6174 7573 5f68 616e 646c 6528 0a20  status_handle(. 
-00019050: 2020 2020 2020 2020 2020 2063 6c75 7374             clust
-00019060: 6572 5f6e 616d 652c 0a20 2020 2020 2020  er_name,.       
-00019070: 2020 2020 2066 6f72 6365 5f72 6566 7265       force_refre
-00019080: 7368 5f73 7461 7475 7365 733d 5b73 7461  sh_statuses=[sta
-00019090: 7475 735f 6c69 622e 436c 7573 7465 7253  tus_lib.ClusterS
-000190a0: 7461 7475 732e 494e 4954 5d2c 0a20 2020  tatus.INIT],.   
-000190b0: 2020 2020 2020 2020 2063 6c75 7374 6572           cluster
-000190c0: 5f73 7461 7475 735f 6c6f 636b 5f74 696d  _status_lock_tim
-000190d0: 656f 7574 3d30 290a 2020 2020 6578 6365  eout=0).    exce
-000190e0: 7074 2065 7863 6570 7469 6f6e 732e 436c  pt exceptions.Cl
-000190f0: 7573 7465 7253 7461 7475 7346 6574 6368  usterStatusFetch
-00019100: 696e 6745 7272 6f72 2061 7320 653a 0a20  ingError as e:. 
-00019110: 2020 2020 2020 2023 2057 6520 646f 206e         # We do n
-00019120: 6f74 2063 6174 6368 2074 6865 2065 7863  ot catch the exc
-00019130: 6570 7469 6f6e 7320 7265 6c61 7465 6420  eptions related 
-00019140: 746f 2074 6865 2063 6c75 7374 6572 206f  to the cluster o
-00019150: 776e 6572 2069 6465 6e74 6974 790a 2020  wner identity.  
-00019160: 2020 2020 2020 2320 6d69 736d 6174 6368        # mismatch
-00019170: 2c20 706c 6561 7365 2072 6566 6572 2074  , please refer t
-00019180: 6f20 7468 6520 636f 6d6d 656e 7420 696e  o the comment in
-00019190: 0a20 2020 2020 2020 2023 2060 6261 636b  .        # `back
-000191a0: 656e 645f 7574 696c 732e 6368 6563 6b5f  end_utils.check_
-000191b0: 636c 7573 7465 725f 6176 6169 6c61 626c  cluster_availabl
-000191c0: 6560 2e0a 2020 2020 2020 2020 6c6f 6767  e`..        logg
-000191d0: 6572 2e77 6172 6e69 6e67 280a 2020 2020  er.warning(.    
-000191e0: 2020 2020 2020 2020 2746 6169 6c65 6420          'Failed 
-000191f0: 746f 2067 6574 2074 6865 2073 7461 7475  to get the statu
-00019200: 7320 6f66 2074 6865 2063 6f6e 7472 6f6c  s of the control
-00019210: 6c65 722e 2049 7420 6973 206e 6f74 2027  ler. It is not '
-00019220: 0a20 2020 2020 2020 2020 2020 2066 2766  .            f'f
-00019230: 6174 616c 2c20 6275 7420 7b63 6f6e 7472  atal, but {contr
-00019240: 6f6c 6c65 725f 6e61 6d65 7d20 636f 6d6d  oller_name} comm
-00019250: 616e 6473 2f63 616c 6c73 206d 6179 2068  ands/calls may h
-00019260: 616e 6720 6f72 2072 6574 7572 6e20 270a  ang or return '.
-00019270: 2020 2020 2020 2020 2020 2020 2773 7461              'sta
-00019280: 6c65 2069 6e66 6f72 6d61 7469 6f6e 2c20  le information, 
-00019290: 7768 656e 2074 6865 2063 6f6e 7472 6f6c  when the control
-000192a0: 6c65 7220 6973 206e 6f74 2075 702e 5c6e  ler is not up.\n
-000192b0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-000192c0: 2020 4465 7461 696c 733a 207b 636f 6d6d    Details: {comm
-000192d0: 6f6e 5f75 7469 6c73 2e66 6f72 6d61 745f  on_utils.format_
-000192e0: 6578 6365 7074 696f 6e28 652c 2075 7365  exception(e, use
-000192f0: 5f62 7261 636b 6574 3d54 7275 6529 7d27  _bracket=True)}'
-00019300: 290a 2020 2020 2020 2020 7265 636f 7264  ).        record
-00019310: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
-00019320: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
-00019330: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
-00019340: 6572 5f6e 616d 6529 0a20 2020 2020 2020  er_name).       
-00019350: 2069 6620 7265 636f 7264 2069 7320 6e6f   if record is no
-00019360: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00019370: 2020 2020 636f 6e74 726f 6c6c 6572 5f73      controller_s
-00019380: 7461 7475 732c 2068 616e 646c 6520 3d20  tatus, handle = 
-00019390: 7265 636f 7264 5b27 7374 6174 7573 275d  record['status']
-000193a0: 2c20 7265 636f 7264 5b27 6861 6e64 6c65  , record['handle
-000193b0: 275d 0a20 2020 2020 2020 2020 2020 2023  '].            #
-000193c0: 2057 6520 6368 6563 6b20 7468 6520 636f   We check the co
-000193d0: 6e6e 6563 7469 6f6e 2065 7665 6e20 6966  nnection even if
-000193e0: 2074 6865 2063 6c75 7374 6572 2068 6173   the cluster has
-000193f0: 2061 2063 6163 6865 6420 7374 6174 7573   a cached status
-00019400: 2055 500a 2020 2020 2020 2020 2020 2020   UP.            
-00019410: 2320 746f 206d 616b 6520 7375 7265 2074  # to make sure t
-00019420: 6865 2063 6f6e 7472 6f6c 6c65 7220 6973  he controller is
-00019430: 2061 6374 7561 6c6c 7920 6163 6365 7373   actually access
-00019440: 6962 6c65 2c20 6173 2074 6865 2063 6163  ible, as the cac
-00019450: 6865 640a 2020 2020 2020 2020 2020 2020  hed.            
-00019460: 2320 7374 6174 7573 206d 6967 6874 2062  # status might b
-00019470: 6520 7374 616c 652e 0a20 2020 2020 2020  e stale..       
-00019480: 2020 2020 206e 6565 645f 636f 6e6e 6563       need_connec
-00019490: 7469 6f6e 5f63 6865 636b 203d 2054 7275  tion_check = Tru
-000194a0: 650a 0a20 2020 2065 7272 6f72 5f6d 7367  e..    error_msg
-000194b0: 203d 204e 6f6e 650a 2020 2020 6966 2063   = None.    if c
-000194c0: 6f6e 7472 6f6c 6c65 725f 7374 6174 7573  ontroller_status
-000194d0: 203d 3d20 7374 6174 7573 5f6c 6962 2e43   == status_lib.C
-000194e0: 6c75 7374 6572 5374 6174 7573 2e53 544f  lusterStatus.STO
-000194f0: 5050 4544 3a0a 2020 2020 2020 2020 6572  PPED:.        er
-00019500: 726f 725f 6d73 6720 3d20 7374 6f70 7065  ror_msg = stoppe
-00019510: 645f 6d65 7373 6167 650a 2020 2020 656c  d_message.    el
-00019520: 6966 2063 6f6e 7472 6f6c 6c65 725f 7374  if controller_st
-00019530: 6174 7573 2069 7320 4e6f 6e65 206f 7220  atus is None or 
-00019540: 6861 6e64 6c65 2069 7320 4e6f 6e65 206f  handle is None o
-00019550: 7220 6861 6e64 6c65 2e68 6561 645f 6970  r handle.head_ip
-00019560: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00019570: 2020 2320 5765 2063 6865 636b 2074 6865    # We check the
-00019580: 2063 6f6e 7472 6f6c 6c65 7220 6973 2053   controller is S
-00019590: 544f 5050 4544 2062 6566 6f72 6520 7468  TOPPED before th
-000195a0: 6520 6368 6563 6b20 666f 7220 6861 6e64  e check for hand
-000195b0: 6c65 2e68 6561 645f 6970 0a20 2020 2020  le.head_ip.     
-000195c0: 2020 2023 204e 6f6e 6520 6265 6361 7573     # None becaus
-000195d0: 6520 7768 656e 2074 6865 2063 6f6e 7472  e when the contr
-000195e0: 6f6c 6c65 7220 6973 2053 544f 5050 4544  oller is STOPPED
-000195f0: 2c20 6861 6e64 6c65 2e68 6561 645f 6970  , handle.head_ip
-00019600: 2063 616e 2061 6c73 6f0a 2020 2020 2020   can also.      
-00019610: 2020 2320 6265 204e 6f6e 652c 2062 7574    # be None, but
-00019620: 2077 6520 6f6e 6c79 2077 616e 7420 746f   we only want to
-00019630: 2063 6174 6368 2074 6865 2063 6173 6520   catch the case 
-00019640: 7768 656e 2074 6865 2063 6f6e 7472 6f6c  when the control
-00019650: 6c65 7220 6973 0a20 2020 2020 2020 2023  ler is.        #
-00019660: 2062 6569 6e67 2070 726f 7669 7369 6f6e   being provision
-00019670: 6564 2061 7420 7468 6520 6669 7273 7420  ed at the first 
-00019680: 7469 6d65 2061 6e64 2068 6176 6520 6e6f  time and have no
-00019690: 2068 6561 645f 6970 2e0a 2020 2020 2020   head_ip..      
-000196a0: 2020 6572 726f 725f 6d73 6720 3d20 6e6f    error_msg = no
-000196b0: 6e5f 6578 6973 7465 6e74 5f6d 6573 7361  n_existent_messa
-000196c0: 6765 0a20 2020 2065 6c69 6620 2863 6f6e  ge.    elif (con
-000196d0: 7472 6f6c 6c65 725f 7374 6174 7573 203d  troller_status =
-000196e0: 3d20 7374 6174 7573 5f6c 6962 2e43 6c75  = status_lib.Clu
-000196f0: 7374 6572 5374 6174 7573 2e49 4e49 5420  sterStatus.INIT 
-00019700: 6f72 0a20 2020 2020 2020 2020 206e 6565  or.          nee
-00019710: 645f 636f 6e6e 6563 7469 6f6e 5f63 6865  d_connection_che
-00019720: 636b 293a 0a20 2020 2020 2020 2023 2043  ck):.        # C
-00019730: 6865 636b 2073 7368 2063 6f6e 6e65 6374  heck ssh connect
-00019740: 696f 6e20 6966 2028 3129 2063 6f6e 7472  ion if (1) contr
-00019750: 6f6c 6c65 7220 6973 2069 6e20 494e 4954  oller is in INIT
-00019760: 2073 7461 7465 2c20 6f72 2028 3229 2077   state, or (2) w
-00019770: 6520 6661 696c 6564 2074 6f20 6665 7463  e failed to fetc
-00019780: 6820 7468 650a 2020 2020 2020 2020 2320  h the.        # 
-00019790: 7374 6174 7573 2c20 626f 7468 206f 6620  status, both of 
-000197a0: 7768 6963 6820 6361 6e20 6861 7070 656e  which can happen
-000197b0: 2077 6865 6e20 636f 6e74 726f 6c6c 6572   when controller
-000197c0: 2773 2073 7461 7475 7320 6c6f 636b 2069  's status lock i
-000197d0: 7320 6865 6c64 2062 7920 616e 6f74 6865  s held by anothe
-000197e0: 7220 6073 6b79 2073 706f 7420 6c61 756e  r `sky spot laun
-000197f0: 6368 6020 6f72 0a20 2020 2020 2020 2023  ch` or.        #
-00019800: 2060 736b 7920 7365 7276 6520 7570 602e   `sky serve up`.
-00019810: 2049 6620 7765 2068 6176 65c2 a063 6f6e   If we have..con
-00019820: 7472 6f6c 6c65 7227 7320 6865 6164 5f69  troller's head_i
-00019830: 7020 6176 6169 6c61 626c 6520 616e 6420  p available and 
-00019840: 6974 2069 7320 7373 682d 7265 6163 6861  it is ssh-reacha
-00019850: 626c 652c 0a20 2020 2020 2020 2023 2077  ble,.        # w
-00019860: 6520 6361 6e20 616c 6c6f 7720 6163 6365  e can allow acce
-00019870: 7373 2074 6f20 7468 6520 636f 6e74 726f  ss to the contro
-00019880: 6c6c 6572 2e0a 2020 2020 2020 2020 7373  ller..        ss
-00019890: 685f 6372 6564 656e 7469 616c 7320 3d20  h_credentials = 
-000198a0: 7373 685f 6372 6564 656e 7469 616c 5f66  ssh_credential_f
-000198b0: 726f 6d5f 7961 6d6c 2868 616e 646c 652e  rom_yaml(handle.
-000198c0: 636c 7573 7465 725f 7961 6d6c 2c0a 2020  cluster_yaml,.  
+00016d50: 3d3d 0a0a 0a40 7479 7069 6e67 2e6f 7665  ==...@typing.ove
+00016d60: 726c 6f61 640a 6465 6620 6368 6563 6b5f  rload.def check_
+00016d70: 636c 7573 7465 725f 6176 6169 6c61 626c  cluster_availabl
+00016d80: 6528 0a20 2020 2063 6c75 7374 6572 5f6e  e(.    cluster_n
+00016d90: 616d 653a 2073 7472 2c0a 2020 2020 2a2c  ame: str,.    *,
+00016da0: 0a20 2020 206f 7065 7261 7469 6f6e 3a20  .    operation: 
+00016db0: 7374 722c 0a20 2020 2063 6865 636b 5f63  str,.    check_c
+00016dc0: 6c6f 7564 5f76 6d5f 7261 795f 6261 636b  loud_vm_ray_back
+00016dd0: 656e 643a 204c 6974 6572 616c 5b54 7275  end: Literal[Tru
+00016de0: 655d 203d 2054 7275 652c 0a20 2020 2064  e] = True,.    d
+00016df0: 7279 7275 6e3a 2062 6f6f 6c20 3d20 2e2e  ryrun: bool = ..
+00016e00: 2e2c 0a29 202d 3e20 2763 6c6f 7564 5f76  .,.) -> 'cloud_v
+00016e10: 6d5f 7261 795f 6261 636b 656e 642e 436c  m_ray_backend.Cl
+00016e20: 6f75 6456 6d52 6179 5265 736f 7572 6365  oudVmRayResource
+00016e30: 4861 6e64 6c65 273a 0a20 2020 202e 2e2e  Handle':.    ...
+00016e40: 0a0a 0a40 7479 7069 6e67 2e6f 7665 726c  ...@typing.overl
+00016e50: 6f61 640a 6465 6620 6368 6563 6b5f 636c  oad.def check_cl
+00016e60: 7573 7465 725f 6176 6169 6c61 626c 6528  uster_available(
+00016e70: 0a20 2020 2063 6c75 7374 6572 5f6e 616d  .    cluster_nam
+00016e80: 653a 2073 7472 2c0a 2020 2020 2a2c 0a20  e: str,.    *,. 
+00016e90: 2020 206f 7065 7261 7469 6f6e 3a20 7374     operation: st
+00016ea0: 722c 0a20 2020 2063 6865 636b 5f63 6c6f  r,.    check_clo
+00016eb0: 7564 5f76 6d5f 7261 795f 6261 636b 656e  ud_vm_ray_backen
+00016ec0: 643a 204c 6974 6572 616c 5b46 616c 7365  d: Literal[False
+00016ed0: 5d2c 0a20 2020 2064 7279 7275 6e3a 2062  ],.    dryrun: b
+00016ee0: 6f6f 6c20 3d20 2e2e 2e2c 0a29 202d 3e20  ool = ...,.) -> 
+00016ef0: 6261 636b 656e 6473 2e52 6573 6f75 7263  backends.Resourc
+00016f00: 6548 616e 646c 653a 0a20 2020 202e 2e2e  eHandle:.    ...
+00016f10: 0a0a 0a64 6566 2063 6865 636b 5f63 6c75  ...def check_clu
+00016f20: 7374 6572 5f61 7661 696c 6162 6c65 280a  ster_available(.
+00016f30: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
+00016f40: 3a20 7374 722c 0a20 2020 202a 2c0a 2020  : str,.    *,.  
+00016f50: 2020 6f70 6572 6174 696f 6e3a 2073 7472    operation: str
+00016f60: 2c0a 2020 2020 6368 6563 6b5f 636c 6f75  ,.    check_clou
+00016f70: 645f 766d 5f72 6179 5f62 6163 6b65 6e64  d_vm_ray_backend
+00016f80: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
+00016f90: 2020 2064 7279 7275 6e3a 2062 6f6f 6c20     dryrun: bool 
+00016fa0: 3d20 4661 6c73 652c 0a29 202d 3e20 6261  = False,.) -> ba
+00016fb0: 636b 656e 6473 2e52 6573 6f75 7263 6548  ckends.ResourceH
+00016fc0: 616e 646c 653a 0a20 2020 2022 2222 4368  andle:.    """Ch
+00016fd0: 6563 6b20 6966 2074 6865 2063 6c75 7374  eck if the clust
+00016fe0: 6572 2069 7320 6176 6169 6c61 626c 652e  er is available.
+00016ff0: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
+00017000: 2020 2020 2020 5661 6c75 6545 7272 6f72        ValueError
+00017010: 3a20 6966 2074 6865 2063 6c75 7374 6572  : if the cluster
+00017020: 2064 6f65 7320 6e6f 7420 6578 6973 742e   does not exist.
+00017030: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
+00017040: 6f6e 732e 436c 7573 7465 724e 6f74 5570  ons.ClusterNotUp
+00017050: 4572 726f 723a 2069 6620 7468 6520 636c  Error: if the cl
+00017060: 7573 7465 7220 6973 206e 6f74 2055 502e  uster is not UP.
+00017070: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
+00017080: 6f6e 732e 4e6f 7453 7570 706f 7274 6564  ons.NotSupported
+00017090: 4572 726f 723a 2069 6620 7468 6520 636c  Error: if the cl
+000170a0: 7573 7465 7220 6973 206e 6f74 2062 6173  uster is not bas
+000170b0: 6564 206f 6e0a 2020 2020 2020 2020 2020  ed on.          
+000170c0: 436c 6f75 6456 6d52 6179 4261 636b 656e  CloudVmRayBacken
+000170d0: 642e 0a20 2020 2020 2020 2065 7863 6570  d..        excep
+000170e0: 7469 6f6e 732e 436c 7573 7465 724f 776e  tions.ClusterOwn
+000170f0: 6572 4964 656e 7469 7479 4d69 736d 6174  erIdentityMismat
+00017100: 6368 4572 726f 723a 2069 6620 7468 6520  chError: if the 
+00017110: 6375 7272 656e 7420 7573 6572 2069 730a  current user is.
+00017120: 2020 2020 2020 2020 2020 6e6f 7420 7468            not th
+00017130: 6520 7361 6d65 2061 7320 7468 6520 7573  e same as the us
+00017140: 6572 2077 686f 2063 7265 6174 6564 2074  er who created t
+00017150: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
+00017160: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
+00017170: 6c6f 7564 5573 6572 4964 656e 7469 7479  loudUserIdentity
+00017180: 4572 726f 723a 2069 6620 7765 2066 6169  Error: if we fai
+00017190: 6c20 746f 2067 6574 2074 6865 2063 7572  l to get the cur
+000171a0: 7265 6e74 2075 7365 720a 2020 2020 2020  rent user.      
+000171b0: 2020 2020 6964 656e 7469 7479 2e0a 2020      identity..  
+000171c0: 2020 2222 220a 2020 2020 7265 636f 7264    """.    record
+000171d0: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
+000171e0: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
+000171f0: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
+00017200: 6572 5f6e 616d 6529 0a20 2020 2069 6620  er_name).    if 
+00017210: 6472 7972 756e 3a0a 2020 2020 2020 2020  dryrun:.        
+00017220: 6173 7365 7274 2072 6563 6f72 6420 6973  assert record is
+00017230: 206e 6f74 204e 6f6e 652c 2063 6c75 7374   not None, clust
+00017240: 6572 5f6e 616d 650a 2020 2020 2020 2020  er_name.        
+00017250: 7265 7475 726e 2072 6563 6f72 645b 2768  return record['h
+00017260: 616e 646c 6527 5d0a 0a20 2020 2070 7265  andle']..    pre
+00017270: 7669 6f75 735f 636c 7573 7465 725f 7374  vious_cluster_st
+00017280: 6174 7573 203d 204e 6f6e 650a 2020 2020  atus = None.    
+00017290: 6966 2072 6563 6f72 6420 6973 206e 6f74  if record is not
+000172a0: 204e 6f6e 653a 0a20 2020 2020 2020 2070   None:.        p
+000172b0: 7265 7669 6f75 735f 636c 7573 7465 725f  revious_cluster_
+000172c0: 7374 6174 7573 203d 2072 6563 6f72 645b  status = record[
+000172d0: 2773 7461 7475 7327 5d0a 0a20 2020 2074  'status']..    t
+000172e0: 7279 3a0a 2020 2020 2020 2020 636c 7573  ry:.        clus
+000172f0: 7465 725f 7374 6174 7573 2c20 6861 6e64  ter_status, hand
+00017300: 6c65 203d 2072 6566 7265 7368 5f63 6c75  le = refresh_clu
+00017310: 7374 6572 5f73 7461 7475 735f 6861 6e64  ster_status_hand
+00017320: 6c65 2863 6c75 7374 6572 5f6e 616d 6529  le(cluster_name)
+00017330: 0a20 2020 2065 7863 6570 7420 6578 6365  .    except exce
+00017340: 7074 696f 6e73 2e43 6c75 7374 6572 5374  ptions.ClusterSt
+00017350: 6174 7573 4665 7463 6869 6e67 4572 726f  atusFetchingErro
+00017360: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
+00017370: 2320 4661 696c 6564 2074 6f20 7265 6672  # Failed to refr
+00017380: 6573 6820 7468 6520 636c 7573 7465 7220  esh the cluster 
+00017390: 7374 6174 7573 2069 7320 6e6f 7420 6661  status is not fa
+000173a0: 7461 6c20 6572 726f 7220 6173 2074 6865  tal error as the
+000173b0: 2063 616c 6c65 7273 0a20 2020 2020 2020   callers.       
+000173c0: 2023 2063 616e 2073 7469 6c6c 2062 6520   # can still be 
+000173d0: 646f 6e65 2062 7920 6f6e 6c79 2075 7369  done by only usi
+000173e0: 6e67 2073 7368 2c20 6275 7420 7468 6520  ng ssh, but the 
+000173f0: 7373 6820 6361 6e20 6861 6e67 2069 6620  ssh can hang if 
+00017400: 7468 650a 2020 2020 2020 2020 2320 636c  the.        # cl
+00017410: 7573 7465 7220 6973 206e 6f74 2075 7020  uster is not up 
+00017420: 2865 2e67 2e2c 2061 7574 6f73 746f 7070  (e.g., autostopp
+00017430: 6564 292e 0a0a 2020 2020 2020 2020 2320  ed)...        # 
+00017440: 5765 2064 6f20 6e6f 7420 6361 7463 6820  We do not catch 
+00017450: 7468 6520 6578 6365 7074 696f 6e20 666f  the exception fo
+00017460: 7220 636c 6f75 6420 6964 656e 7469 7479  r cloud identity
+00017470: 2063 6865 636b 696e 6720 666f 7220 6e6f   checking for no
+00017480: 772c 2069 6e0a 2020 2020 2020 2020 2320  w, in.        # 
+00017490: 6f72 6465 7220 746f 2064 6973 6162 6c65  order to disable
+000174a0: 2061 6c6c 206f 7065 7261 7469 6f6e 7320   all operations 
+000174b0: 6f6e 2063 6c75 7374 6572 7320 6372 6561  on clusters crea
+000174c0: 7465 6420 6279 2061 6e6f 7468 6572 2075  ted by another u
+000174d0: 7365 720a 2020 2020 2020 2020 2320 6964  ser.        # id
+000174e0: 656e 7469 7479 2e20 2054 6861 7420 7769  entity.  That wi
+000174f0: 6c6c 206d 616b 6520 7468 6520 6465 7369  ll make the desi
+00017500: 676e 2073 696d 706c 6572 2061 6e64 2065  gn simpler and e
+00017510: 6173 6965 7220 746f 0a20 2020 2020 2020  asier to.       
+00017520: 2023 2075 6e64 6572 7374 616e 642c 2062   # understand, b
+00017530: 7574 2069 7420 6d69 6768 7420 6265 2075  ut it might be u
+00017540: 7365 6675 6c20 746f 2061 6c6c 6f77 2074  seful to allow t
+00017550: 6865 2075 7365 7220 746f 2075 7365 0a20  he user to use. 
+00017560: 2020 2020 2020 2023 206f 7065 7261 7469         # operati
+00017570: 6f6e 7320 7468 6174 206f 6e6c 7920 696e  ons that only in
+00017580: 766f 6c76 6520 7373 6820 2865 2e67 2e2c  volve ssh (e.g.,
+00017590: 2073 6b79 2065 7865 632c 2073 6b79 206c   sky exec, sky l
+000175a0: 6f67 732c 2065 7463 2920 6576 656e 0a20  ogs, etc) even. 
+000175b0: 2020 2020 2020 2023 2069 6620 7468 6520         # if the 
+000175c0: 7573 6572 2069 7320 6e6f 7420 7468 6520  user is not the 
+000175d0: 6f77 6e65 7220 6f66 2074 6865 2063 6c75  owner of the clu
+000175e0: 7374 6572 2e0a 2020 2020 2020 2020 7578  ster..        ux
+000175f0: 5f75 7469 6c73 2e63 6f6e 736f 6c65 5f6e  _utils.console_n
+00017600: 6577 6c69 6e65 2829 0a20 2020 2020 2020  ewline().       
+00017610: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+00017620: 0a20 2020 2020 2020 2020 2020 2066 2746  .            f'F
+00017630: 6169 6c65 6420 746f 2072 6566 7265 7368  ailed to refresh
+00017640: 2074 6865 2073 7461 7475 7320 666f 7220   the status for 
+00017650: 636c 7573 7465 7220 7b63 6c75 7374 6572  cluster {cluster
+00017660: 5f6e 616d 6521 727d 2e20 4974 2069 7320  _name!r}. It is 
+00017670: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00017680: 6e6f 7420 6661 7461 6c2c 2062 7574 207b  not fatal, but {
+00017690: 6f70 6572 6174 696f 6e7d 206d 6967 6874  operation} might
+000176a0: 2068 616e 6720 6966 2074 6865 2063 6c75   hang if the clu
+000176b0: 7374 6572 2069 7320 6e6f 7420 7570 2e5c  ster is not up.\
+000176c0: 6e27 0a20 2020 2020 2020 2020 2020 2066  n'.            f
+000176d0: 2744 6574 6169 6c65 6420 7265 6173 6f6e  'Detailed reason
+000176e0: 3a20 7b65 7d27 290a 2020 2020 2020 2020  : {e}').        
+000176f0: 6966 2072 6563 6f72 6420 6973 204e 6f6e  if record is Non
+00017700: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
+00017710: 6c75 7374 6572 5f73 7461 7475 732c 2068  luster_status, h
+00017720: 616e 646c 6520 3d20 4e6f 6e65 2c20 4e6f  andle = None, No
+00017730: 6e65 0a20 2020 2020 2020 2065 6c73 653a  ne.        else:
+00017740: 0a20 2020 2020 2020 2020 2020 2063 6c75  .            clu
+00017750: 7374 6572 5f73 7461 7475 732c 2068 616e  ster_status, han
+00017760: 646c 6520 3d20 7265 636f 7264 5b27 7374  dle = record['st
+00017770: 6174 7573 275d 2c20 7265 636f 7264 5b27  atus'], record['
+00017780: 6861 6e64 6c65 275d 0a0a 2020 2020 6272  handle']..    br
+00017790: 6967 6874 203d 2063 6f6c 6f72 616d 612e  ight = colorama.
+000177a0: 5374 796c 652e 4252 4947 4854 0a20 2020  Style.BRIGHT.   
+000177b0: 2072 6573 6574 203d 2063 6f6c 6f72 616d   reset = coloram
+000177c0: 612e 5374 796c 652e 5245 5345 545f 414c  a.Style.RESET_AL
+000177d0: 4c0a 2020 2020 6966 2068 616e 646c 6520  L.    if handle 
+000177e0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+000177f0: 2069 6620 7072 6576 696f 7573 5f63 6c75   if previous_clu
+00017800: 7374 6572 5f73 7461 7475 7320 6973 204e  ster_status is N
+00017810: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00017820: 2065 7272 6f72 5f6d 7367 203d 2066 2743   error_msg = f'C
+00017830: 6c75 7374 6572 207b 636c 7573 7465 725f  luster {cluster_
+00017840: 6e61 6d65 2172 7d20 646f 6573 206e 6f74  name!r} does not
+00017850: 2065 7869 7374 2e27 0a20 2020 2020 2020   exist.'.       
+00017860: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00017870: 2020 2065 7272 6f72 5f6d 7367 203d 2028     error_msg = (
+00017880: 6627 436c 7573 7465 7220 7b63 6c75 7374  f'Cluster {clust
+00017890: 6572 5f6e 616d 6521 727d 206e 6f74 2066  er_name!r} not f
+000178a0: 6f75 6e64 206f 6e20 7468 6520 636c 6f75  ound on the clou
+000178b0: 6420 270a 2020 2020 2020 2020 2020 2020  d '.            
+000178c0: 2020 2020 2020 2020 2020 2020 2027 7072               'pr
+000178d0: 6f76 6964 6572 2e27 290a 2020 2020 2020  ovider.').      
+000178e0: 2020 2020 2020 6173 7365 7274 2072 6563        assert rec
+000178f0: 6f72 6420 6973 206e 6f74 204e 6f6e 652c  ord is not None,
+00017900: 2070 7265 7669 6f75 735f 636c 7573 7465   previous_cluste
+00017910: 725f 7374 6174 7573 0a20 2020 2020 2020  r_status.       
+00017920: 2020 2020 2061 6374 696f 6e73 203d 205b       actions = [
+00017930: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+00017940: 2072 6563 6f72 645b 2768 616e 646c 6527   record['handle'
+00017950: 5d2e 6c61 756e 6368 6564 5f72 6573 6f75  ].launched_resou
+00017960: 7263 6573 2e75 7365 5f73 706f 743a 0a20  rces.use_spot:. 
+00017970: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00017980: 6374 696f 6e73 2e61 7070 656e 6428 2770  ctions.append('p
+00017990: 7265 656d 7074 6564 2729 0a20 2020 2020  reempted').     
+000179a0: 2020 2020 2020 2069 6620 7265 636f 7264         if record
+000179b0: 5b27 6175 746f 7374 6f70 275d 203e 2030  ['autostop'] > 0
+000179c0: 2061 6e64 2072 6563 6f72 645b 2774 6f5f   and record['to_
+000179d0: 646f 776e 275d 3a0a 2020 2020 2020 2020  down']:.        
+000179e0: 2020 2020 2020 2020 6163 7469 6f6e 732e          actions.
+000179f0: 6170 7065 6e64 2827 6175 746f 646f 776e  append('autodown
+00017a00: 6564 2729 0a20 2020 2020 2020 2020 2020  ed').           
+00017a10: 2061 6374 696f 6e73 2e61 7070 656e 6428   actions.append(
+00017a20: 276d 616e 7561 6c6c 7920 7465 726d 696e  'manually termin
+00017a30: 6174 6564 2069 6e20 636f 6e73 6f6c 6527  ated in console'
+00017a40: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00017a50: 206c 656e 2861 6374 696f 6e73 2920 3e20   len(actions) > 
+00017a60: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00017a70: 2020 2061 6374 696f 6e73 5b2d 315d 203d     actions[-1] =
+00017a80: 2027 6f72 2027 202b 2061 6374 696f 6e73   'or ' + actions
+00017a90: 5b2d 315d 0a20 2020 2020 2020 2020 2020  [-1].           
+00017aa0: 2061 6374 696f 6e73 5f73 7472 203d 2027   actions_str = '
+00017ab0: 2c20 272e 6a6f 696e 2861 6374 696f 6e73  , '.join(actions
+00017ac0: 290a 2020 2020 2020 2020 2020 2020 6d65  ).            me
+00017ad0: 7373 6167 6520 3d20 6627 2049 7420 7761  ssage = f' It wa
+00017ae0: 7320 6c69 6b65 6c79 207b 6163 7469 6f6e  s likely {action
+00017af0: 735f 7374 727d 2e27 0a20 2020 2020 2020  s_str}.'.       
+00017b00: 2020 2020 2069 6620 6c65 6e28 6163 7469       if len(acti
+00017b10: 6f6e 7329 203e 2031 3a0a 2020 2020 2020  ons) > 1:.      
+00017b20: 2020 2020 2020 2020 2020 6d65 7373 6167            messag
+00017b30: 6520 3d20 6d65 7373 6167 652e 7265 706c  e = message.repl
+00017b40: 6163 6528 276c 696b 656c 7927 2c20 2765  ace('likely', 'e
+00017b50: 6974 6865 7227 290a 2020 2020 2020 2020  ither').        
+00017b60: 2020 2020 6572 726f 725f 6d73 6720 2b3d      error_msg +=
+00017b70: 206d 6573 7361 6765 0a0a 2020 2020 2020   message..      
+00017b80: 2020 7769 7468 2075 785f 7574 696c 732e    with ux_utils.
+00017b90: 7072 696e 745f 6578 6365 7074 696f 6e5f  print_exception_
+00017ba0: 6e6f 5f74 7261 6365 6261 636b 2829 3a0a  no_traceback():.
+00017bb0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00017bc0: 6520 5661 6c75 6545 7272 6f72 2866 277b  e ValueError(f'{
+00017bd0: 636f 6c6f 7261 6d61 2e46 6f72 652e 5945  colorama.Fore.YE
+00017be0: 4c4c 4f57 7d7b 6572 726f 725f 6d73 677d  LLOW}{error_msg}
+00017bf0: 7b72 6573 6574 7d27 290a 2020 2020 6173  {reset}').    as
+00017c00: 7365 7274 2063 6c75 7374 6572 5f73 7461  sert cluster_sta
+00017c10: 7475 7320 6973 206e 6f74 204e 6f6e 652c  tus is not None,
+00017c20: 2027 6861 6e64 6c65 2069 7320 6e6f 7420   'handle is not 
+00017c30: 4e6f 6e65 2062 7574 2073 7461 7475 7320  None but status 
+00017c40: 6973 204e 6f6e 6527 0a20 2020 2062 6163  is None'.    bac
+00017c50: 6b65 6e64 203d 2067 6574 5f62 6163 6b65  kend = get_backe
+00017c60: 6e64 5f66 726f 6d5f 6861 6e64 6c65 2868  nd_from_handle(h
+00017c70: 616e 646c 6529 0a20 2020 2069 6620 6368  andle).    if ch
+00017c80: 6563 6b5f 636c 6f75 645f 766d 5f72 6179  eck_cloud_vm_ray
+00017c90: 5f62 6163 6b65 6e64 2061 6e64 206e 6f74  _backend and not
+00017ca0: 2069 7369 6e73 7461 6e63 6528 0a20 2020   isinstance(.   
+00017cb0: 2020 2020 2020 2020 2062 6163 6b65 6e64           backend
+00017cc0: 2c20 6261 636b 656e 6473 2e43 6c6f 7564  , backends.Cloud
+00017cd0: 566d 5261 7942 6163 6b65 6e64 293a 0a20  VmRayBackend):. 
+00017ce0: 2020 2020 2020 2077 6974 6820 7578 5f75         with ux_u
+00017cf0: 7469 6c73 2e70 7269 6e74 5f65 7863 6570  tils.print_excep
+00017d00: 7469 6f6e 5f6e 6f5f 7472 6163 6562 6163  tion_no_tracebac
+00017d10: 6b28 293a 0a20 2020 2020 2020 2020 2020  k():.           
+00017d20: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
+00017d30: 732e 4e6f 7453 7570 706f 7274 6564 4572  s.NotSupportedEr
+00017d40: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00017d50: 2020 2020 2066 277b 636f 6c6f 7261 6d61       f'{colorama
+00017d60: 2e46 6f72 652e 5945 4c4c 4f57 7d7b 6f70  .Fore.YELLOW}{op
+00017d70: 6572 6174 696f 6e2e 6361 7069 7461 6c69  eration.capitali
+00017d80: 7a65 2829 7d3a 2073 6b69 7070 6564 2066  ze()}: skipped f
+00017d90: 6f72 2027 0a20 2020 2020 2020 2020 2020  or '.           
+00017da0: 2020 2020 2066 2763 6c75 7374 6572 207b       f'cluster {
+00017db0: 636c 7573 7465 725f 6e61 6d65 2172 7d2e  cluster_name!r}.
+00017dc0: 2049 7420 6973 206f 6e6c 7920 7375 7070   It is only supp
+00017dd0: 6f72 7465 6420 6279 2062 6163 6b65 6e64  orted by backend
+00017de0: 3a20 270a 2020 2020 2020 2020 2020 2020  : '.            
+00017df0: 2020 2020 6627 7b62 6163 6b65 6e64 732e      f'{backends.
+00017e00: 436c 6f75 6456 6d52 6179 4261 636b 656e  CloudVmRayBacken
+00017e10: 642e 4e41 4d45 7d2e 270a 2020 2020 2020  d.NAME}.'.      
+00017e20: 2020 2020 2020 2020 2020 6627 7b72 6573            f'{res
+00017e30: 6574 7d27 290a 2020 2020 6966 2063 6c75  et}').    if clu
+00017e40: 7374 6572 5f73 7461 7475 7320 213d 2073  ster_status != s
+00017e50: 7461 7475 735f 6c69 622e 436c 7573 7465  tatus_lib.Cluste
+00017e60: 7253 7461 7475 732e 5550 3a0a 2020 2020  rStatus.UP:.    
+00017e70: 2020 2020 7769 7468 2075 785f 7574 696c      with ux_util
+00017e80: 732e 7072 696e 745f 6578 6365 7074 696f  s.print_exceptio
+00017e90: 6e5f 6e6f 5f74 7261 6365 6261 636b 2829  n_no_traceback()
+00017ea0: 3a0a 2020 2020 2020 2020 2020 2020 6869  :.            hi
+00017eb0: 6e74 5f66 6f72 5f69 6e69 7420 3d20 2727  nt_for_init = ''
+00017ec0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00017ed0: 636c 7573 7465 725f 7374 6174 7573 203d  cluster_status =
+00017ee0: 3d20 7374 6174 7573 5f6c 6962 2e43 6c75  = status_lib.Clu
+00017ef0: 7374 6572 5374 6174 7573 2e49 4e49 543a  sterStatus.INIT:
+00017f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017f10: 2068 696e 745f 666f 725f 696e 6974 203d   hint_for_init =
+00017f20: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00017f30: 2020 2020 2020 2066 277b 7265 7365 747d         f'{reset}
+00017f40: 2057 6169 7420 666f 7220 6120 6c61 756e   Wait for a laun
+00017f50: 6368 2074 6f20 6669 6e69 7368 2c20 6f72  ch to finish, or
+00017f60: 2075 7365 2074 6869 7320 636f 6d6d 616e   use this comman
+00017f70: 6420 270a 2020 2020 2020 2020 2020 2020  d '.            
+00017f80: 2020 2020 2020 2020 6627 746f 2074 7279          f'to try
+00017f90: 2074 6f20 7472 616e 7369 7469 6f6e 2074   to transition t
+00017fa0: 6865 2063 6c75 7374 6572 2074 6f20 5550  he cluster to UP
+00017fb0: 3a20 7b62 7269 6768 747d 736b 7920 270a  : {bright}sky '.
+00017fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017fd0: 2020 2020 6627 7374 6172 7420 7b63 6c75      f'start {clu
+00017fe0: 7374 6572 5f6e 616d 657d 7b72 6573 6574  ster_name}{reset
+00017ff0: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
+00018000: 7261 6973 6520 6578 6365 7074 696f 6e73  raise exceptions
+00018010: 2e43 6c75 7374 6572 4e6f 7455 7045 7272  .ClusterNotUpErr
+00018020: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00018030: 2020 2020 6627 7b63 6f6c 6f72 616d 612e      f'{colorama.
+00018040: 466f 7265 2e59 454c 4c4f 577d 7b6f 7065  Fore.YELLOW}{ope
+00018050: 7261 7469 6f6e 2e63 6170 6974 616c 697a  ration.capitaliz
+00018060: 6528 297d 3a20 736b 6970 7065 6420 666f  e()}: skipped fo
+00018070: 7220 270a 2020 2020 2020 2020 2020 2020  r '.            
+00018080: 2020 2020 6627 636c 7573 7465 7220 7b63      f'cluster {c
+00018090: 6c75 7374 6572 5f6e 616d 6521 727d 2028  luster_name!r} (
+000180a0: 7374 6174 7573 3a20 7b63 6c75 7374 6572  status: {cluster
+000180b0: 5f73 7461 7475 732e 7661 6c75 657d 292e  _status.value}).
+000180c0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000180d0: 2020 2027 4974 2069 7320 6f6e 6c79 2061     'It is only a
+000180e0: 6c6c 6f77 6564 2066 6f72 2027 0a20 2020  llowed for '.   
+000180f0: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+00018100: 7374 6174 7573 5f6c 6962 2e43 6c75 7374  status_lib.Clust
+00018110: 6572 5374 6174 7573 2e55 502e 7661 6c75  erStatus.UP.valu
+00018120: 657d 2063 6c75 7374 6572 732e 270a 2020  e} clusters.'.  
+00018130: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00018140: 7b68 696e 745f 666f 725f 696e 6974 7d27  {hint_for_init}'
+00018150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018160: 2066 277b 7265 7365 747d 272c 0a20 2020   f'{reset}',.   
+00018170: 2020 2020 2020 2020 2020 2020 2063 6c75               clu
+00018180: 7374 6572 5f73 7461 7475 733d 636c 7573  ster_status=clus
+00018190: 7465 725f 7374 6174 7573 2c0a 2020 2020  ter_status,.    
+000181a0: 2020 2020 2020 2020 2020 2020 6861 6e64              hand
+000181b0: 6c65 3d68 616e 646c 6529 0a0a 2020 2020  le=handle)..    
+000181c0: 6966 2068 616e 646c 652e 6865 6164 5f69  if handle.head_i
+000181d0: 7020 6973 204e 6f6e 653a 0a20 2020 2020  p is None:.     
+000181e0: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
+000181f0: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
+00018200: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
+00018210: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00018220: 7365 2065 7863 6570 7469 6f6e 732e 436c  se exceptions.Cl
+00018230: 7573 7465 724e 6f74 5570 4572 726f 7228  usterNotUpError(
+00018240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018250: 2066 2743 6c75 7374 6572 207b 636c 7573   f'Cluster {clus
+00018260: 7465 725f 6e61 6d65 2172 7d20 6861 7320  ter_name!r} has 
+00018270: 6265 656e 2073 746f 7070 6564 206f 7220  been stopped or 
+00018280: 6e6f 7420 7072 6f70 6572 6c79 2027 0a20  not properly '. 
+00018290: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000182a0: 7365 7420 7570 2e20 506c 6561 7365 2072  set up. Please r
+000182b0: 652d 6c61 756e 6368 2069 7420 7769 7468  e-launch it with
+000182c0: 2060 736b 7920 7374 6172 7460 2e27 2c0a   `sky start`.',.
+000182d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000182e0: 636c 7573 7465 725f 7374 6174 7573 3d63  cluster_status=c
+000182f0: 6c75 7374 6572 5f73 7461 7475 732c 0a20  luster_status,. 
+00018300: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00018310: 616e 646c 653d 6861 6e64 6c65 290a 2020  andle=handle).  
+00018320: 2020 7265 7475 726e 2068 616e 646c 650a    return handle.
+00018330: 0a0a 2320 544f 444f 2874 6961 6e29 3a20  ..# TODO(tian): 
+00018340: 5265 6661 6374 6f72 2074 6f20 636f 6e74  Refactor to cont
+00018350: 726f 6c6c 6572 5f75 7469 6c73 2e20 4375  roller_utils. Cu
+00018360: 7272 656e 7420 626c 6f63 6b65 723a 2063  rrent blocker: c
+00018370: 6972 6375 6c61 7220 696d 706f 7274 2e0a  ircular import..
+00018380: 6465 6620 6973 5f63 6f6e 7472 6f6c 6c65  def is_controlle
+00018390: 725f 6163 6365 7373 6962 6c65 280a 2020  r_accessible(.  
+000183a0: 2020 636f 6e74 726f 6c6c 6572 5f74 7970    controller_typ
+000183b0: 653a 2063 6f6e 7472 6f6c 6c65 725f 7574  e: controller_ut
+000183c0: 696c 732e 436f 6e74 726f 6c6c 6572 732c  ils.Controllers,
+000183d0: 0a20 2020 2073 746f 7070 6564 5f6d 6573  .    stopped_mes
+000183e0: 7361 6765 3a20 7374 722c 0a20 2020 206e  sage: str,.    n
+000183f0: 6f6e 5f65 7869 7374 656e 745f 6d65 7373  on_existent_mess
+00018400: 6167 653a 204f 7074 696f 6e61 6c5b 7374  age: Optional[st
+00018410: 725d 203d 204e 6f6e 652c 0a20 2020 2065  r] = None,.    e
+00018420: 7869 745f 6966 5f6e 6f74 5f61 6363 6573  xit_if_not_acces
+00018430: 7369 626c 653a 2062 6f6f 6c20 3d20 4661  sible: bool = Fa
+00018440: 6c73 652c 0a29 202d 3e20 2762 6163 6b65  lse,.) -> 'backe
+00018450: 6e64 732e 436c 6f75 6456 6d52 6179 5265  nds.CloudVmRayRe
+00018460: 736f 7572 6365 4861 6e64 6c65 273a 0a20  sourceHandle':. 
+00018470: 2020 2022 2222 4368 6563 6b20 6966 2074     """Check if t
+00018480: 6865 2073 706f 742f 7365 7276 6520 636f  he spot/serve co
+00018490: 6e74 726f 6c6c 6572 2069 7320 7570 2e0a  ntroller is up..
+000184a0: 0a20 2020 2054 6865 2063 6f6e 7472 6f6c  .    The control
+000184b0: 6c65 7220 6973 2061 6363 6573 7369 626c  ler is accessibl
+000184c0: 6520 7768 656e 2069 7420 6973 2069 6e20  e when it is in 
+000184d0: 5550 206f 7220 494e 4954 2073 7461 7465  UP or INIT state
+000184e0: 2c20 616e 6420 7468 6520 7373 680a 2020  , and the ssh.  
+000184f0: 2020 636f 6e6e 6563 7469 6f6e 2069 7320    connection is 
+00018500: 7375 6363 6573 7366 756c 2e0a 0a20 2020  successful...   
+00018510: 2049 7420 6361 6e20 6265 2075 7365 6420   It can be used 
+00018520: 746f 2063 6865 636b 2069 6620 7468 6520  to check if the 
+00018530: 636f 6e74 726f 6c6c 6572 2069 7320 6163  controller is ac
+00018540: 6365 7373 6962 6c65 2028 7369 6e63 6520  cessible (since 
+00018550: 7468 6520 6175 746f 7374 6f70 0a20 2020  the autostop.   
+00018560: 2069 7320 7365 7420 666f 7220 7468 6520   is set for the 
+00018570: 636f 6e74 726f 6c6c 6572 2920 6265 666f  controller) befo
+00018580: 7265 2074 6865 2073 706f 742f 7365 7276  re the spot/serv
+00018590: 6520 636f 6d6d 616e 6473 2069 6e74 6572  e commands inter
+000185a0: 6163 7420 7769 7468 2074 6865 0a20 2020  act with the.   
+000185b0: 2063 6f6e 7472 6f6c 6c65 722e 0a0a 2020   controller...  
+000185c0: 2020 436c 7573 7465 724e 6f74 5570 4572    ClusterNotUpEr
+000185d0: 726f 7220 7769 6c6c 2062 6520 7261 6973  ror will be rais
+000185e0: 6564 2077 6865 6e65 7665 7220 7468 6520  ed whenever the 
+000185f0: 636f 6e74 726f 6c6c 6572 2063 616e 6e6f  controller canno
+00018600: 7420 6265 2061 6363 6573 7365 642e 0a0a  t be accessed...
+00018610: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00018620: 2020 7479 7065 3a20 5479 7065 206f 6620    type: Type of 
+00018630: 7468 6520 636f 6e74 726f 6c6c 6572 2e0a  the controller..
+00018640: 2020 2020 2020 2020 7374 6f70 7065 645f          stopped_
+00018650: 6d65 7373 6167 653a 204d 6573 7361 6765  message: Message
+00018660: 2074 6f20 7072 696e 7420 6966 2074 6865   to print if the
+00018670: 2063 6f6e 7472 6f6c 6c65 7220 6973 2053   controller is S
+00018680: 544f 5050 4544 2e0a 2020 2020 2020 2020  TOPPED..        
+00018690: 6e6f 6e5f 6578 6973 7465 6e74 5f6d 6573  non_existent_mes
+000186a0: 7361 6765 3a20 4d65 7373 6167 6520 746f  sage: Message to
+000186b0: 2073 686f 7720 6966 2074 6865 2063 6f6e   show if the con
+000186c0: 7472 6f6c 6c65 7220 646f 6573 206e 6f74  troller does not
+000186d0: 2065 7869 7374 2e0a 2020 2020 2020 2020   exist..        
+000186e0: 6578 6974 5f69 665f 6e6f 745f 6163 6365  exit_if_not_acce
+000186f0: 7373 6962 6c65 3a20 5768 6574 6865 7220  ssible: Whether 
+00018700: 746f 2065 7869 7420 6469 7265 6374 6c79  to exit directly
+00018710: 2069 6620 7468 6520 636f 6e74 726f 6c6c   if the controll
+00018720: 6572 2069 7320 6e6f 740a 2020 2020 2020  er is not.      
+00018730: 2020 2020 6163 6365 7373 6962 6c65 2e20      accessible. 
+00018740: 4966 2046 616c 7365 2c20 7468 6520 6675  If False, the fu
+00018750: 6e63 7469 6f6e 2077 696c 6c20 7261 6973  nction will rais
+00018760: 6520 436c 7573 7465 724e 6f74 5570 4572  e ClusterNotUpEr
+00018770: 726f 722e 0a0a 2020 2020 5265 7475 726e  ror...    Return
+00018780: 733a 0a20 2020 2020 2020 2068 616e 646c  s:.        handl
+00018790: 653a 2054 6865 2052 6573 6f75 7263 6548  e: The ResourceH
+000187a0: 616e 646c 6520 6f66 2074 6865 2063 6f6e  andle of the con
+000187b0: 7472 6f6c 6c65 722e 0a0a 2020 2020 5261  troller...    Ra
+000187c0: 6973 6573 3a0a 2020 2020 2020 2020 6578  ises:.        ex
+000187d0: 6365 7074 696f 6e73 2e43 6c75 7374 6572  ceptions.Cluster
+000187e0: 4f77 6e65 7249 6465 6e74 6974 794d 6973  OwnerIdentityMis
+000187f0: 6d61 7463 6845 7272 6f72 3a20 6966 2074  matchError: if t
+00018800: 6865 2063 7572 7265 6e74 2075 7365 7220  he current user 
+00018810: 6973 206e 6f74 0a20 2020 2020 2020 2020  is not.         
+00018820: 2074 6865 2073 616d 6520 6173 2074 6865   the same as the
+00018830: 2075 7365 7220 7768 6f20 6372 6561 7465   user who create
+00018840: 6420 7468 6520 636c 7573 7465 722e 0a20  d the cluster.. 
+00018850: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
+00018860: 732e 436c 6f75 6455 7365 7249 6465 6e74  s.CloudUserIdent
+00018870: 6974 7945 7272 6f72 3a20 6966 2077 6520  ityError: if we 
+00018880: 6661 696c 2074 6f20 6765 7420 7468 6520  fail to get the 
+00018890: 6375 7272 656e 7420 7573 6572 0a20 2020  current user.   
+000188a0: 2020 2020 2020 2069 6465 6e74 6974 792e         identity.
+000188b0: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
+000188c0: 6f6e 732e 436c 7573 7465 724e 6f74 5570  ons.ClusterNotUp
+000188d0: 4572 726f 723a 2069 6620 7468 6520 636f  Error: if the co
+000188e0: 6e74 726f 6c6c 6572 2069 7320 6e6f 7420  ntroller is not 
+000188f0: 6163 6365 7373 6962 6c65 2c20 6f72 0a20  accessible, or. 
+00018900: 2020 2020 2020 2020 2066 6169 6c65 6420           failed 
+00018910: 746f 2062 6520 636f 6e6e 6563 7465 642e  to be connected.
+00018920: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+00018930: 6e6f 6e5f 6578 6973 7465 6e74 5f6d 6573  non_existent_mes
+00018940: 7361 6765 2069 7320 4e6f 6e65 3a0a 2020  sage is None:.  
+00018950: 2020 2020 2020 6e6f 6e5f 6578 6973 7465        non_existe
+00018960: 6e74 5f6d 6573 7361 6765 203d 2028 0a20  nt_message = (. 
+00018970: 2020 2020 2020 2020 2020 2063 6f6e 7472             contr
+00018980: 6f6c 6c65 725f 7479 7065 2e76 616c 7565  oller_type.value
+00018990: 2e64 6566 6175 6c74 5f68 696e 745f 6966  .default_hint_if
+000189a0: 5f6e 6f6e 5f65 7869 7374 656e 7429 0a20  _non_existent). 
+000189b0: 2020 2063 6c75 7374 6572 5f6e 616d 6520     cluster_name 
+000189c0: 3d20 636f 6e74 726f 6c6c 6572 5f74 7970  = controller_typ
+000189d0: 652e 7661 6c75 652e 636c 7573 7465 725f  e.value.cluster_
+000189e0: 6e61 6d65 0a20 2020 2063 6f6e 7472 6f6c  name.    control
+000189f0: 6c65 725f 6e61 6d65 203d 2063 6f6e 7472  ler_name = contr
+00018a00: 6f6c 6c65 725f 7479 7065 2e76 616c 7565  oller_type.value
+00018a10: 2e6e 616d 652e 7265 706c 6163 6528 2720  .name.replace(' 
+00018a20: 636f 6e74 726f 6c6c 6572 272c 2027 2729  controller', '')
+00018a30: 0a20 2020 206e 6565 645f 636f 6e6e 6563  .    need_connec
+00018a40: 7469 6f6e 5f63 6865 636b 203d 2046 616c  tion_check = Fal
+00018a50: 7365 0a20 2020 2063 6f6e 7472 6f6c 6c65  se.    controlle
+00018a60: 725f 7374 6174 7573 2c20 6861 6e64 6c65  r_status, handle
+00018a70: 203d 204e 6f6e 652c 204e 6f6e 650a 2020   = None, None.  
+00018a80: 2020 7472 793a 0a20 2020 2020 2020 2023    try:.        #
+00018a90: 2053 6574 2066 6f72 6365 5f72 6566 7265   Set force_refre
+00018aa0: 7368 5f73 7461 7475 7365 733d 5b49 4e49  sh_statuses=[INI
+00018ab0: 545d 2074 6f20 6d61 6b65 2073 7572 6520  T] to make sure 
+00018ac0: 7468 6520 7265 6672 6573 6820 6861 7070  the refresh happ
+00018ad0: 656e 730a 2020 2020 2020 2020 2320 7768  ens.        # wh
+00018ae0: 656e 2074 6865 2063 6f6e 7472 6f6c 6c65  en the controlle
+00018af0: 7220 6973 2049 4e49 542f 5550 2028 7472  r is INIT/UP (tr
+00018b00: 6967 6765 7265 6420 696e 2074 6865 7365  iggered in these
+00018b10: 2073 7461 7475 7365 7320 6173 2074 6865   statuses as the
+00018b20: 0a20 2020 2020 2020 2023 2061 7574 6f73  .        # autos
+00018b30: 746f 7020 6973 2061 6c77 6179 7320 7365  top is always se
+00018b40: 7420 666f 7220 7468 6520 636f 6e74 726f  t for the contro
+00018b50: 6c6c 6572 292e 2054 6865 2063 6f6e 7472  ller). The contr
+00018b60: 6f6c 6c65 7220 6361 6e20 6265 2069 6e0a  oller can be in.
+00018b70: 2020 2020 2020 2020 2320 666f 6c6c 6f77          # follow
+00018b80: 696e 6720 6361 7365 733a 0a20 2020 2020  ing cases:.     
+00018b90: 2020 2023 202a 2028 5550 2c20 6175 746f     # * (UP, auto
+00018ba0: 7374 6f70 2073 6574 293a 2069 7420 7769  stop set): it wi
+00018bb0: 6c6c 2062 6520 7265 6672 6573 6865 6420  ll be refreshed 
+00018bc0: 7769 7468 6f75 7420 666f 7263 655f 7265  without force_re
+00018bd0: 6672 6573 6820 7365 742e 0a20 2020 2020  fresh set..     
+00018be0: 2020 2023 202a 2028 5550 2c20 6e6f 2061     # * (UP, no a
+00018bf0: 7574 6f73 746f 7029 3a20 7665 7279 2072  utostop): very r
+00018c00: 6172 6520 2861 2075 7365 7220 6374 726c  are (a user ctrl
+00018c10: 2d63 2077 6865 6e20 7468 6520 636f 6e74  -c when the cont
+00018c20: 726f 6c6c 6572 2069 730a 2020 2020 2020  roller is.      
+00018c30: 2020 2320 2020 6c61 756e 6368 696e 6729    #   launching)
+00018c40: 2c20 646f 6573 206e 6f74 206d 6174 7465  , does not matte
+00018c50: 7220 6966 2072 6566 7265 7368 206f 7220  r if refresh or 
+00018c60: 6e6f 742c 2073 696e 6365 206e 6f20 6175  not, since no au
+00018c70: 746f 7374 6f70 2e20 5765 0a20 2020 2020  tostop. We.     
+00018c80: 2020 2023 2020 2064 6f6e 2774 2069 6e63     #   don't inc
+00018c90: 6c75 6465 2055 5020 696e 2066 6f72 6365  lude UP in force
+00018ca0: 5f72 6566 7265 7368 5f73 7461 7475 7365  _refresh_statuse
+00018cb0: 7320 746f 2061 766f 6964 206f 7665 7268  s to avoid overh
+00018cc0: 6561 6473 2e0a 2020 2020 2020 2020 2320  eads..        # 
+00018cd0: 2a20 2849 4e49 542c 2061 7574 6f73 746f  * (INIT, autosto
+00018ce0: 7020 7365 7429 0a20 2020 2020 2020 2023  p set).        #
+00018cf0: 202a 2028 494e 4954 2c20 6e6f 2061 7574   * (INIT, no aut
+00018d00: 6f73 746f 7029 3a20 7665 7279 2072 6172  ostop): very rar
+00018d10: 6520 285f 7570 6461 7465 5f63 6c75 7374  e (_update_clust
+00018d20: 6572 5f73 7461 7475 735f 6e6f 5f6c 6f63  er_status_no_loc
+00018d30: 6b20 6d61 790a 2020 2020 2020 2020 2320  k may.        # 
+00018d40: 2020 7265 7365 7420 6c6f 6361 6c20 6175    reset local au
+00018d50: 746f 7374 6f70 2063 6f6e 6669 6729 2c20  tostop config), 
+00018d60: 6275 7420 666f 7263 655f 7265 6672 6573  but force_refres
+00018d70: 6820 7769 6c6c 206d 616b 6520 7375 7265  h will make sure
+00018d80: 0a20 2020 2020 2020 2023 2020 2073 7461  .        #   sta
+00018d90: 7475 7320 6973 2072 6566 7265 7368 6564  tus is refreshed
+00018da0: 2e0a 2020 2020 2020 2020 230a 2020 2020  ..        #.    
+00018db0: 2020 2020 2320 5765 2061 766f 6964 7320      # We avoids 
+00018dc0: 756e 6e65 6365 7373 6172 7920 636f 7374  unnecessary cost
+00018dd0: 6c79 2072 6566 7265 7368 2077 6865 6e20  ly refresh when 
+00018de0: 7468 6520 636f 6e74 726f 6c6c 6572 2069  the controller i
+00018df0: 7320 616c 7265 6164 790a 2020 2020 2020  s already.      
+00018e00: 2020 2320 5354 4f50 5045 442e 2054 6869    # STOPPED. Thi
+00018e10: 7320 6f70 7469 6d69 7a61 7469 6f6e 2069  s optimization i
+00018e20: 7320 6261 7365 6420 6f6e 2074 6865 2061  s based on the a
+00018e30: 7373 756d 7074 696f 6e20 7468 6174 2074  ssumption that t
+00018e40: 6865 2075 7365 720a 2020 2020 2020 2020  he user.        
+00018e50: 2320 7769 6c6c 206e 6f74 2073 7461 7274  # will not start
+00018e60: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
+00018e70: 6d61 6e75 616c 6c79 2066 726f 6d20 7468  manually from th
+00018e80: 6520 636c 6f75 6420 636f 6e73 6f6c 652e  e cloud console.
+00018e90: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
+00018ea0: 2020 2023 2054 6865 2061 6371 7569 7265     # The acquire
+00018eb0: 5f6c 6f63 6b5f 7469 6d65 6f75 7420 6973  _lock_timeout is
+00018ec0: 2073 6574 2074 6f20 3020 746f 2061 766f   set to 0 to avo
+00018ed0: 6964 2068 616e 6769 6e67 2074 6865 2063  id hanging the c
+00018ee0: 6f6d 6d61 6e64 2077 6865 6e0a 2020 2020  ommand when.    
+00018ef0: 2020 2020 2320 6d75 6c74 6970 6c65 2073      # multiple s
+00018f00: 706f 745f 6c61 756e 6368 2063 6f6d 6d61  pot_launch comma
+00018f10: 6e64 7320 6172 6520 7275 6e6e 696e 6720  nds are running 
+00018f20: 6174 2074 6865 2073 616d 6520 7469 6d65  at the same time
+00018f30: 2e20 4f75 7220 6c61 7465 720a 2020 2020  . Our later.    
+00018f40: 2020 2020 2320 636f 6465 2077 696c 6c20      # code will 
+00018f50: 6368 6563 6b20 6966 2074 6865 2063 6f6e  check if the con
+00018f60: 7472 6f6c 6c65 7220 6973 2061 6363 6573  troller is acces
+00018f70: 7369 626c 6520 6279 2064 6972 6563 746c  sible by directl
+00018f80: 7920 6368 6563 6b69 6e67 0a20 2020 2020  y checking.     
+00018f90: 2020 2023 2074 6865 2073 7368 2063 6f6e     # the ssh con
+00018fa0: 6e65 6374 696f 6e20 746f 2074 6865 2063  nection to the c
+00018fb0: 6f6e 7472 6f6c 6c65 722c 2069 6620 6974  ontroller, if it
+00018fc0: 2066 6169 6c73 2074 6f20 6765 7420 6163   fails to get ac
+00018fd0: 6375 7261 7465 0a20 2020 2020 2020 2023  curate.        #
+00018fe0: 2073 7461 7475 7320 6f66 2074 6865 2063   status of the c
+00018ff0: 6f6e 7472 6f6c 6c65 722e 0a20 2020 2020  ontroller..     
+00019000: 2020 2063 6f6e 7472 6f6c 6c65 725f 7374     controller_st
+00019010: 6174 7573 2c20 6861 6e64 6c65 203d 2072  atus, handle = r
+00019020: 6566 7265 7368 5f63 6c75 7374 6572 5f73  efresh_cluster_s
+00019030: 7461 7475 735f 6861 6e64 6c65 280a 2020  tatus_handle(.  
+00019040: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
+00019050: 725f 6e61 6d65 2c0a 2020 2020 2020 2020  r_name,.        
+00019060: 2020 2020 666f 7263 655f 7265 6672 6573      force_refres
+00019070: 685f 7374 6174 7573 6573 3d5b 7374 6174  h_statuses=[stat
+00019080: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
+00019090: 6174 7573 2e49 4e49 545d 2c0a 2020 2020  atus.INIT],.    
+000190a0: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
+000190b0: 7374 6174 7573 5f6c 6f63 6b5f 7469 6d65  status_lock_time
+000190c0: 6f75 743d 3029 0a20 2020 2065 7863 6570  out=0).    excep
+000190d0: 7420 6578 6365 7074 696f 6e73 2e43 6c75  t exceptions.Clu
+000190e0: 7374 6572 5374 6174 7573 4665 7463 6869  sterStatusFetchi
+000190f0: 6e67 4572 726f 7220 6173 2065 3a0a 2020  ngError as e:.  
+00019100: 2020 2020 2020 2320 5765 2064 6f20 6e6f        # We do no
+00019110: 7420 6361 7463 6820 7468 6520 6578 6365  t catch the exce
+00019120: 7074 696f 6e73 2072 656c 6174 6564 2074  ptions related t
+00019130: 6f20 7468 6520 636c 7573 7465 7220 6f77  o the cluster ow
+00019140: 6e65 7220 6964 656e 7469 7479 0a20 2020  ner identity.   
+00019150: 2020 2020 2023 206d 6973 6d61 7463 682c       # mismatch,
+00019160: 2070 6c65 6173 6520 7265 6665 7220 746f   please refer to
+00019170: 2074 6865 2063 6f6d 6d65 6e74 2069 6e0a   the comment in.
+00019180: 2020 2020 2020 2020 2320 6062 6163 6b65          # `backe
+00019190: 6e64 5f75 7469 6c73 2e63 6865 636b 5f63  nd_utils.check_c
+000191a0: 6c75 7374 6572 5f61 7661 696c 6162 6c65  luster_available
+000191b0: 602e 0a20 2020 2020 2020 206c 6f67 6765  `..        logge
+000191c0: 722e 7761 726e 696e 6728 0a20 2020 2020  r.warning(.     
+000191d0: 2020 2020 2020 2027 4661 696c 6564 2074         'Failed t
+000191e0: 6f20 6765 7420 7468 6520 7374 6174 7573  o get the status
+000191f0: 206f 6620 7468 6520 636f 6e74 726f 6c6c   of the controll
+00019200: 6572 2e20 4974 2069 7320 6e6f 7420 270a  er. It is not '.
+00019210: 2020 2020 2020 2020 2020 2020 6627 6661              f'fa
+00019220: 7461 6c2c 2062 7574 207b 636f 6e74 726f  tal, but {contro
+00019230: 6c6c 6572 5f6e 616d 657d 2063 6f6d 6d61  ller_name} comma
+00019240: 6e64 732f 6361 6c6c 7320 6d61 7920 6861  nds/calls may ha
+00019250: 6e67 206f 7220 7265 7475 726e 2027 0a20  ng or return '. 
+00019260: 2020 2020 2020 2020 2020 2027 7374 616c             'stal
+00019270: 6520 696e 666f 726d 6174 696f 6e2c 2077  e information, w
+00019280: 6865 6e20 7468 6520 636f 6e74 726f 6c6c  hen the controll
+00019290: 6572 2069 7320 6e6f 7420 7570 2e5c 6e27  er is not up.\n'
+000192a0: 0a20 2020 2020 2020 2020 2020 2066 2720  .            f' 
+000192b0: 2044 6574 6169 6c73 3a20 7b63 6f6d 6d6f   Details: {commo
+000192c0: 6e5f 7574 696c 732e 666f 726d 6174 5f65  n_utils.format_e
+000192d0: 7863 6570 7469 6f6e 2865 2c20 7573 655f  xception(e, use_
+000192e0: 6272 6163 6b65 743d 5472 7565 297d 2729  bracket=True)}')
+000192f0: 0a20 2020 2020 2020 2072 6563 6f72 6420  .        record 
+00019300: 3d20 676c 6f62 616c 5f75 7365 725f 7374  = global_user_st
+00019310: 6174 652e 6765 745f 636c 7573 7465 725f  ate.get_cluster_
+00019320: 6672 6f6d 5f6e 616d 6528 636c 7573 7465  from_name(cluste
+00019330: 725f 6e61 6d65 290a 2020 2020 2020 2020  r_name).        
+00019340: 6966 2072 6563 6f72 6420 6973 206e 6f74  if record is not
+00019350: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00019360: 2020 2063 6f6e 7472 6f6c 6c65 725f 7374     controller_st
+00019370: 6174 7573 2c20 6861 6e64 6c65 203d 2072  atus, handle = r
+00019380: 6563 6f72 645b 2773 7461 7475 7327 5d2c  ecord['status'],
+00019390: 2072 6563 6f72 645b 2768 616e 646c 6527   record['handle'
+000193a0: 5d0a 2020 2020 2020 2020 2020 2020 2320  ].            # 
+000193b0: 5765 2063 6865 636b 2074 6865 2063 6f6e  We check the con
+000193c0: 6e65 6374 696f 6e20 6576 656e 2069 6620  nection even if 
+000193d0: 7468 6520 636c 7573 7465 7220 6861 7320  the cluster has 
+000193e0: 6120 6361 6368 6564 2073 7461 7475 7320  a cached status 
+000193f0: 5550 0a20 2020 2020 2020 2020 2020 2023  UP.            #
+00019400: 2074 6f20 6d61 6b65 2073 7572 6520 7468   to make sure th
+00019410: 6520 636f 6e74 726f 6c6c 6572 2069 7320  e controller is 
+00019420: 6163 7475 616c 6c79 2061 6363 6573 7369  actually accessi
+00019430: 626c 652c 2061 7320 7468 6520 6361 6368  ble, as the cach
+00019440: 6564 0a20 2020 2020 2020 2020 2020 2023  ed.            #
+00019450: 2073 7461 7475 7320 6d69 6768 7420 6265   status might be
+00019460: 2073 7461 6c65 2e0a 2020 2020 2020 2020   stale..        
+00019470: 2020 2020 6e65 6564 5f63 6f6e 6e65 6374      need_connect
+00019480: 696f 6e5f 6368 6563 6b20 3d20 5472 7565  ion_check = True
+00019490: 0a0a 2020 2020 6572 726f 725f 6d73 6720  ..    error_msg 
+000194a0: 3d20 4e6f 6e65 0a20 2020 2069 6620 636f  = None.    if co
+000194b0: 6e74 726f 6c6c 6572 5f73 7461 7475 7320  ntroller_status 
+000194c0: 3d3d 2073 7461 7475 735f 6c69 622e 436c  == status_lib.Cl
+000194d0: 7573 7465 7253 7461 7475 732e 5354 4f50  usterStatus.STOP
+000194e0: 5045 443a 0a20 2020 2020 2020 2065 7272  PED:.        err
+000194f0: 6f72 5f6d 7367 203d 2073 746f 7070 6564  or_msg = stopped
+00019500: 5f6d 6573 7361 6765 0a20 2020 2065 6c69  _message.    eli
+00019510: 6620 636f 6e74 726f 6c6c 6572 5f73 7461  f controller_sta
+00019520: 7475 7320 6973 204e 6f6e 6520 6f72 2068  tus is None or h
+00019530: 616e 646c 6520 6973 204e 6f6e 6520 6f72  andle is None or
+00019540: 2068 616e 646c 652e 6865 6164 5f69 7020   handle.head_ip 
+00019550: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00019560: 2023 2057 6520 6368 6563 6b20 7468 6520   # We check the 
+00019570: 636f 6e74 726f 6c6c 6572 2069 7320 5354  controller is ST
+00019580: 4f50 5045 4420 6265 666f 7265 2074 6865  OPPED before the
+00019590: 2063 6865 636b 2066 6f72 2068 616e 646c   check for handl
+000195a0: 652e 6865 6164 5f69 700a 2020 2020 2020  e.head_ip.      
+000195b0: 2020 2320 4e6f 6e65 2062 6563 6175 7365    # None because
+000195c0: 2077 6865 6e20 7468 6520 636f 6e74 726f   when the contro
+000195d0: 6c6c 6572 2069 7320 5354 4f50 5045 442c  ller is STOPPED,
+000195e0: 2068 616e 646c 652e 6865 6164 5f69 7020   handle.head_ip 
+000195f0: 6361 6e20 616c 736f 0a20 2020 2020 2020  can also.       
+00019600: 2023 2062 6520 4e6f 6e65 2c20 6275 7420   # be None, but 
+00019610: 7765 206f 6e6c 7920 7761 6e74 2074 6f20  we only want to 
+00019620: 6361 7463 6820 7468 6520 6361 7365 2077  catch the case w
+00019630: 6865 6e20 7468 6520 636f 6e74 726f 6c6c  hen the controll
+00019640: 6572 2069 730a 2020 2020 2020 2020 2320  er is.        # 
+00019650: 6265 696e 6720 7072 6f76 6973 696f 6e65  being provisione
+00019660: 6420 6174 2074 6865 2066 6972 7374 2074  d at the first t
+00019670: 696d 6520 616e 6420 6861 7665 206e 6f20  ime and have no 
+00019680: 6865 6164 5f69 702e 0a20 2020 2020 2020  head_ip..       
+00019690: 2065 7272 6f72 5f6d 7367 203d 206e 6f6e   error_msg = non
+000196a0: 5f65 7869 7374 656e 745f 6d65 7373 6167  _existent_messag
+000196b0: 650a 2020 2020 656c 6966 2028 636f 6e74  e.    elif (cont
+000196c0: 726f 6c6c 6572 5f73 7461 7475 7320 3d3d  roller_status ==
+000196d0: 2073 7461 7475 735f 6c69 622e 436c 7573   status_lib.Clus
+000196e0: 7465 7253 7461 7475 732e 494e 4954 206f  terStatus.INIT o
+000196f0: 720a 2020 2020 2020 2020 2020 6e65 6564  r.          need
+00019700: 5f63 6f6e 6e65 6374 696f 6e5f 6368 6563  _connection_chec
+00019710: 6b29 3a0a 2020 2020 2020 2020 2320 4368  k):.        # Ch
+00019720: 6563 6b20 7373 6820 636f 6e6e 6563 7469  eck ssh connecti
+00019730: 6f6e 2069 6620 2831 2920 636f 6e74 726f  on if (1) contro
+00019740: 6c6c 6572 2069 7320 696e 2049 4e49 5420  ller is in INIT 
+00019750: 7374 6174 652c 206f 7220 2832 2920 7765  state, or (2) we
+00019760: 2066 6169 6c65 6420 746f 2066 6574 6368   failed to fetch
+00019770: 2074 6865 0a20 2020 2020 2020 2023 2073   the.        # s
+00019780: 7461 7475 732c 2062 6f74 6820 6f66 2077  tatus, both of w
+00019790: 6869 6368 2063 616e 2068 6170 7065 6e20  hich can happen 
+000197a0: 7768 656e 2063 6f6e 7472 6f6c 6c65 7227  when controller'
+000197b0: 7320 7374 6174 7573 206c 6f63 6b20 6973  s status lock is
+000197c0: 2068 656c 6420 6279 2061 6e6f 7468 6572   held by another
+000197d0: 2060 736b 7920 7370 6f74 206c 6175 6e63   `sky spot launc
+000197e0: 6860 206f 720a 2020 2020 2020 2020 2320  h` or.        # 
+000197f0: 6073 6b79 2073 6572 7665 2075 7060 2e20  `sky serve up`. 
+00019800: 4966 2077 6520 6861 7665 c2a0 636f 6e74  If we have..cont
+00019810: 726f 6c6c 6572 2773 2068 6561 645f 6970  roller's head_ip
+00019820: 2061 7661 696c 6162 6c65 2061 6e64 2069   available and i
+00019830: 7420 6973 2073 7368 2d72 6561 6368 6162  t is ssh-reachab
+00019840: 6c65 2c0a 2020 2020 2020 2020 2320 7765  le,.        # we
+00019850: 2063 616e 2061 6c6c 6f77 2061 6363 6573   can allow acces
+00019860: 7320 746f 2074 6865 2063 6f6e 7472 6f6c  s to the control
+00019870: 6c65 722e 0a20 2020 2020 2020 2073 7368  ler..        ssh
+00019880: 5f63 7265 6465 6e74 6961 6c73 203d 2073  _credentials = s
+00019890: 7368 5f63 7265 6465 6e74 6961 6c5f 6672  sh_credential_fr
+000198a0: 6f6d 5f79 616d 6c28 6861 6e64 6c65 2e63  om_yaml(handle.c
+000198b0: 6c75 7374 6572 5f79 616d 6c2c 0a20 2020  luster_yaml,.   
+000198c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000198d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000198e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000198f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019900: 2068 616e 646c 652e 646f 636b 6572 5f75   handle.docker_u
-00019910: 7365 722c 0a20 2020 2020 2020 2020 2020  ser,.           
+000198f0: 6861 6e64 6c65 2e64 6f63 6b65 725f 7573  handle.docker_us
+00019900: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+00019910: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00019920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019940: 2020 2020 2020 2020 6861 6e64 6c65 2e73          handle.s
-00019950: 7368 5f75 7365 7229 0a0a 2020 2020 2020  sh_user)..      
-00019960: 2020 7275 6e6e 6572 203d 2063 6f6d 6d61    runner = comma
-00019970: 6e64 5f72 756e 6e65 722e 5353 4843 6f6d  nd_runner.SSHCom
-00019980: 6d61 6e64 5275 6e6e 6572 2868 616e 646c  mandRunner(handl
-00019990: 652e 6865 6164 5f69 702c 0a20 2020 2020  e.head_ip,.     
+00019930: 2020 2020 2020 2068 616e 646c 652e 7373         handle.ss
+00019940: 685f 7573 6572 290a 0a20 2020 2020 2020  h_user)..       
+00019950: 2072 756e 6e65 7220 3d20 636f 6d6d 616e   runner = comman
+00019960: 645f 7275 6e6e 6572 2e53 5348 436f 6d6d  d_runner.SSHComm
+00019970: 616e 6452 756e 6e65 7228 6861 6e64 6c65  andRunner(handle
+00019980: 2e68 6561 645f 6970 2c0a 2020 2020 2020  .head_ip,.      
+00019990: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000199a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000199b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000199c0: 2020 2020 2020 2020 2020 2020 2a2a 7373              **ss
-000199d0: 685f 6372 6564 656e 7469 616c 732c 0a20  h_credentials,. 
+000199b0: 2020 2020 2020 2020 2020 202a 2a73 7368             **ssh
+000199c0: 5f63 7265 6465 6e74 6961 6c73 2c0a 2020  _credentials,.  
+000199d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000199e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000199f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a10: 706f 7274 3d68 616e 646c 652e 6865 6164  port=handle.head
-00019a20: 5f73 7368 5f70 6f72 7429 0a20 2020 2020  _ssh_port).     
-00019a30: 2020 2069 6620 6e6f 7420 7275 6e6e 6572     if not runner
-00019a40: 2e63 6865 636b 5f63 6f6e 6e65 6374 696f  .check_connectio
-00019a50: 6e28 293a 0a20 2020 2020 2020 2020 2020  n():.           
-00019a60: 2065 7272 6f72 5f6d 7367 203d 2063 6f6e   error_msg = con
-00019a70: 7472 6f6c 6c65 725f 7479 7065 2e76 616c  troller_type.val
-00019a80: 7565 2e63 6f6e 6e65 6374 696f 6e5f 6572  ue.connection_er
-00019a90: 726f 725f 6869 6e74 0a20 2020 2065 6c73  ror_hint.    els
-00019aa0: 653a 0a20 2020 2020 2020 2061 7373 6572  e:.        asser
-00019ab0: 7420 636f 6e74 726f 6c6c 6572 5f73 7461  t controller_sta
-00019ac0: 7475 7320 3d3d 2073 7461 7475 735f 6c69  tus == status_li
-00019ad0: 622e 436c 7573 7465 7253 7461 7475 732e  b.ClusterStatus.
-00019ae0: 5550 2c20 6861 6e64 6c65 0a0a 2020 2020  UP, handle..    
-00019af0: 6966 2065 7272 6f72 5f6d 7367 2069 7320  if error_msg is 
-00019b00: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00019b10: 2020 6966 2065 7869 745f 6966 5f6e 6f74    if exit_if_not
-00019b20: 5f61 6363 6573 7369 626c 653a 0a20 2020  _accessible:.   
-00019b30: 2020 2020 2020 2020 2073 6b79 5f6c 6f67           sky_log
-00019b40: 6769 6e67 2e70 7269 6e74 2865 7272 6f72  ging.print(error
-00019b50: 5f6d 7367 290a 2020 2020 2020 2020 2020  _msg).          
-00019b60: 2020 7379 732e 6578 6974 2831 290a 2020    sys.exit(1).  
-00019b70: 2020 2020 2020 7769 7468 2075 785f 7574        with ux_ut
-00019b80: 696c 732e 7072 696e 745f 6578 6365 7074  ils.print_except
-00019b90: 696f 6e5f 6e6f 5f74 7261 6365 6261 636b  ion_no_traceback
-00019ba0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00019bb0: 7261 6973 6520 6578 6365 7074 696f 6e73  raise exceptions
-00019bc0: 2e43 6c75 7374 6572 4e6f 7455 7045 7272  .ClusterNotUpErr
-00019bd0: 6f72 2865 7272 6f72 5f6d 7367 2c0a 2020  or(error_msg,.  
+000199f0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00019a00: 6f72 743d 6861 6e64 6c65 2e68 6561 645f  ort=handle.head_
+00019a10: 7373 685f 706f 7274 290a 2020 2020 2020  ssh_port).      
+00019a20: 2020 6966 206e 6f74 2072 756e 6e65 722e    if not runner.
+00019a30: 6368 6563 6b5f 636f 6e6e 6563 7469 6f6e  check_connection
+00019a40: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00019a50: 6572 726f 725f 6d73 6720 3d20 636f 6e74  error_msg = cont
+00019a60: 726f 6c6c 6572 5f74 7970 652e 7661 6c75  roller_type.valu
+00019a70: 652e 636f 6e6e 6563 7469 6f6e 5f65 7272  e.connection_err
+00019a80: 6f72 5f68 696e 740a 2020 2020 656c 7365  or_hint.    else
+00019a90: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+00019aa0: 2063 6f6e 7472 6f6c 6c65 725f 7374 6174   controller_stat
+00019ab0: 7573 203d 3d20 7374 6174 7573 5f6c 6962  us == status_lib
+00019ac0: 2e43 6c75 7374 6572 5374 6174 7573 2e55  .ClusterStatus.U
+00019ad0: 502c 2068 616e 646c 650a 0a20 2020 2069  P, handle..    i
+00019ae0: 6620 6572 726f 725f 6d73 6720 6973 206e  f error_msg is n
+00019af0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00019b00: 2069 6620 6578 6974 5f69 665f 6e6f 745f   if exit_if_not_
+00019b10: 6163 6365 7373 6962 6c65 3a0a 2020 2020  accessible:.    
+00019b20: 2020 2020 2020 2020 736b 795f 6c6f 6767          sky_logg
+00019b30: 696e 672e 7072 696e 7428 6572 726f 725f  ing.print(error_
+00019b40: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
+00019b50: 2073 7973 2e65 7869 7428 3129 0a20 2020   sys.exit(1).   
+00019b60: 2020 2020 2077 6974 6820 7578 5f75 7469       with ux_uti
+00019b70: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
+00019b80: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
+00019b90: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00019ba0: 6169 7365 2065 7863 6570 7469 6f6e 732e  aise exceptions.
+00019bb0: 436c 7573 7465 724e 6f74 5570 4572 726f  ClusterNotUpErro
+00019bc0: 7228 6572 726f 725f 6d73 672c 0a20 2020  r(error_msg,.   
+00019bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00019be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c00: 2020 2020 2020 2020 2020 2020 2063 6c75               clu
-00019c10: 7374 6572 5f73 7461 7475 733d 636f 6e74  ster_status=cont
-00019c20: 726f 6c6c 6572 5f73 7461 7475 732c 0a20  roller_status,. 
+00019bf0: 2020 2020 2020 2020 2020 2020 636c 7573              clus
+00019c00: 7465 725f 7374 6174 7573 3d63 6f6e 7472  ter_status=contr
+00019c10: 6f6c 6c65 725f 7374 6174 7573 2c0a 2020  oller_status,.  
+00019c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00019c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c50: 2020 2020 2020 2020 2020 2020 2020 6861                ha
-00019c60: 6e64 6c65 3d68 616e 646c 6529 0a20 2020  ndle=handle).   
-00019c70: 2061 7373 6572 7420 6861 6e64 6c65 2069   assert handle i
-00019c80: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2068  s not None and h
-00019c90: 616e 646c 652e 6865 6164 5f69 7020 6973  andle.head_ip is
-00019ca0: 206e 6f74 204e 6f6e 652c 2028 0a20 2020   not None, (.   
-00019cb0: 2020 2020 2068 616e 646c 652c 2063 6f6e       handle, con
-00019cc0: 7472 6f6c 6c65 725f 7374 6174 7573 290a  troller_status).
-00019cd0: 2020 2020 7265 7475 726e 2068 616e 646c      return handl
-00019ce0: 650a 0a0a 636c 6173 7320 436c 6f75 6446  e...class CloudF
-00019cf0: 696c 7465 7228 656e 756d 2e45 6e75 6d29  ilter(enum.Enum)
-00019d00: 3a0a 2020 2020 2320 4669 6c74 6572 2066  :.    # Filter f
-00019d10: 6f72 2061 6c6c 2074 7970 6573 206f 6620  or all types of 
-00019d20: 636c 6f75 6473 2e0a 2020 2020 414c 4c20  clouds..    ALL 
-00019d30: 3d20 2761 6c6c 270a 2020 2020 2320 4669  = 'all'.    # Fi
-00019d40: 6c74 6572 2066 6f72 2053 6b79 2773 206d  lter for Sky's m
-00019d50: 6169 6e20 636c 6f75 6473 2028 6177 732c  ain clouds (aws,
-00019d60: 2067 6370 2c20 617a 7572 652c 2064 6f63   gcp, azure, doc
-00019d70: 6b65 7229 2e0a 2020 2020 434c 4f55 4453  ker)..    CLOUDS
-00019d80: 5f41 4e44 5f44 4f43 4b45 5220 3d20 2763  _AND_DOCKER = 'c
-00019d90: 6c6f 7564 732d 616e 642d 646f 636b 6572  louds-and-docker
-00019da0: 270a 2020 2020 2320 4669 6c74 6572 2066  '.    # Filter f
-00019db0: 6f72 206f 6e6c 7920 6c6f 6361 6c20 636c  or only local cl
-00019dc0: 6f75 6473 2e0a 2020 2020 4c4f 4341 4c20  ouds..    LOCAL 
-00019dd0: 3d20 276c 6f63 616c 270a 0a0a 6465 6620  = 'local'...def 
-00019de0: 6765 745f 636c 7573 7465 7273 280a 2020  get_clusters(.  
-00019df0: 2020 696e 636c 7564 655f 636f 6e74 726f    include_contro
-00019e00: 6c6c 6572 3a20 626f 6f6c 2c0a 2020 2020  ller: bool,.    
-00019e10: 7265 6672 6573 683a 2062 6f6f 6c2c 0a20  refresh: bool,. 
-00019e20: 2020 2063 6c75 7374 6572 5f6e 616d 6573     cluster_names
-00019e30: 3a20 4f70 7469 6f6e 616c 5b55 6e69 6f6e  : Optional[Union
-00019e40: 5b73 7472 2c20 4c69 7374 5b73 7472 5d5d  [str, List[str]]
-00019e50: 5d20 3d20 4e6f 6e65 2c0a 2920 2d3e 204c  ] = None,.) -> L
-00019e60: 6973 745b 4469 6374 5b73 7472 2c20 416e  ist[Dict[str, An
-00019e70: 795d 5d3a 0a20 2020 2022 2222 5265 7475  y]]:.    """Retu
-00019e80: 726e 7320 6120 6c69 7374 206f 6620 6361  rns a list of ca
-00019e90: 6368 6564 206f 7220 6f70 7469 6f6e 616c  ched or optional
-00019ea0: 6c79 2072 6566 7265 7368 6564 2063 6c75  ly refreshed clu
-00019eb0: 7374 6572 2072 6563 6f72 6473 2e0a 0a20  ster records... 
-00019ec0: 2020 2043 6f6d 6273 2074 6872 6f75 6768     Combs through
-00019ed0: 2074 6865 2064 6174 6162 6173 6520 2869   the database (i
-00019ee0: 6e20 7e2f 2e73 6b79 2f73 7461 7465 2e64  n ~/.sky/state.d
-00019ef0: 6229 2074 6f20 6765 7420 6120 6c69 7374  b) to get a list
-00019f00: 206f 6620 7265 636f 7264 730a 2020 2020   of records.    
-00019f10: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
-00019f20: 206c 6175 6e63 6865 6420 636c 7573 7465   launched cluste
-00019f30: 7273 2028 6669 6c74 6572 6564 2062 7920  rs (filtered by 
-00019f40: 6063 6c75 7374 6572 5f6e 616d 6573 6020  `cluster_names` 
-00019f50: 6966 2069 7420 6973 0a20 2020 2073 7065  if it is.    spe
-00019f60: 6369 6669 6564 292e 2054 6865 2072 6566  cified). The ref
-00019f70: 7265 7368 2066 6c61 6720 6361 6e20 6265  resh flag can be
-00019f80: 2075 7365 6420 746f 2066 6f72 6365 2061   used to force a
-00019f90: 2072 6566 7265 7368 206f 6620 7468 6520   refresh of the 
-00019fa0: 7374 6174 7573 0a20 2020 206f 6620 7468  status.    of th
-00019fb0: 6520 636c 7573 7465 7273 2e0a 0a20 2020  e clusters...   
-00019fc0: 2041 7267 733a 0a20 2020 2020 2020 2069   Args:.        i
-00019fd0: 6e63 6c75 6465 5f63 6f6e 7472 6f6c 6c65  nclude_controlle
-00019fe0: 723a 2057 6865 7468 6572 2074 6f20 696e  r: Whether to in
-00019ff0: 636c 7564 6520 636f 6e74 726f 6c6c 6572  clude controller
-0001a000: 732c 2065 2e67 2e20 7370 6f74 2063 6f6e  s, e.g. spot con
-0001a010: 7472 6f6c 6c65 720a 2020 2020 2020 2020  troller.        
-0001a020: 2020 2020 6f72 2073 6b79 2073 6572 7665      or sky serve
-0001a030: 2063 6f6e 7472 6f6c 6c65 722e 0a20 2020   controller..   
-0001a040: 2020 2020 2072 6566 7265 7368 3a20 5768       refresh: Wh
-0001a050: 6574 6865 7220 746f 2072 6566 7265 7368  ether to refresh
-0001a060: 2074 6865 2073 7461 7475 7320 6f66 2074   the status of t
-0001a070: 6865 2063 6c75 7374 6572 732e 2028 5265  he clusters. (Re
-0001a080: 6672 6573 6869 6e67 2077 696c 6c0a 2020  freshing will.  
-0001a090: 2020 2020 2020 2020 2020 7365 7420 7468            set th
-0001a0a0: 6520 7374 6174 7573 2074 6f20 5354 4f50  e status to STOP
-0001a0b0: 5045 4420 6966 2074 6865 2063 6c75 7374  PED if the clust
-0001a0c0: 6572 2063 616e 6e6f 7420 6265 2070 696e  er cannot be pin
-0001a0d0: 6765 642e 290a 2020 2020 2020 2020 636c  ged.).        cl
-0001a0e0: 6f75 645f 6669 6c74 6572 3a20 5365 7473  oud_filter: Sets
-0001a0f0: 2077 6869 6368 2063 6c6f 7564 7320 746f   which clouds to
-0001a100: 2066 696c 6572 2074 6872 6f75 6768 2066   filer through f
-0001a110: 726f 6d20 7468 6520 676c 6f62 616c 2075  rom the global u
-0001a120: 7365 720a 2020 2020 2020 2020 2020 2020  ser.            
-0001a130: 7374 6174 652e 2053 7570 706f 7274 7320  state. Supports 
-0001a140: 7468 7265 6520 7661 6c75 6573 2c20 2761  three values, 'a
-0001a150: 6c6c 2720 666f 7220 616c 6c20 636c 6f75  ll' for all clou
-0001a160: 6473 2c20 2770 7562 6c69 6327 2066 6f72  ds, 'public' for
-0001a170: 0a20 2020 2020 2020 2020 2020 2070 7562  .            pub
-0001a180: 6c69 6320 636c 6f75 6473 206f 6e6c 792c  lic clouds only,
-0001a190: 2061 6e64 2027 6c6f 6361 6c27 2066 6f72   and 'local' for
-0001a1a0: 206f 6e6c 7920 6c6f 6361 6c20 636c 6f75   only local clou
-0001a1b0: 6473 2e0a 2020 2020 2020 2020 636c 7573  ds..        clus
-0001a1c0: 7465 725f 6e61 6d65 733a 2049 6620 7072  ter_names: If pr
-0001a1d0: 6f76 6964 6564 2c20 6f6e 6c79 2072 6574  ovided, only ret
-0001a1e0: 7572 6e20 7265 636f 7264 7320 666f 7220  urn records for 
-0001a1f0: 7468 6520 6769 7665 6e20 636c 7573 7465  the given cluste
-0001a200: 720a 2020 2020 2020 2020 2020 2020 6e61  r.            na
-0001a210: 6d65 732e 0a0a 2020 2020 5265 7475 726e  mes...    Return
-0001a220: 733a 0a20 2020 2020 2020 2041 206c 6973  s:.        A lis
-0001a230: 7420 6f66 2063 6c75 7374 6572 2072 6563  t of cluster rec
-0001a240: 6f72 6473 2e20 4966 2074 6865 2063 6c75  ords. If the clu
-0001a250: 7374 6572 2064 6f65 7320 6e6f 7420 6578  ster does not ex
-0001a260: 6973 7420 6f72 2068 6173 2062 6565 6e0a  ist or has been.
-0001a270: 2020 2020 2020 2020 7465 726d 696e 6174          terminat
-0001a280: 6564 2c20 7468 6520 7265 636f 7264 2077  ed, the record w
-0001a290: 696c 6c20 6265 206f 6d69 7474 6564 2066  ill be omitted f
-0001a2a0: 726f 6d20 7468 6520 7265 7475 726e 6564  rom the returned
-0001a2b0: 206c 6973 742e 0a20 2020 2022 2222 0a20   list..    """. 
-0001a2c0: 2020 2072 6563 6f72 6473 203d 2067 6c6f     records = glo
-0001a2d0: 6261 6c5f 7573 6572 5f73 7461 7465 2e67  bal_user_state.g
-0001a2e0: 6574 5f63 6c75 7374 6572 7328 290a 0a20  et_clusters().. 
-0001a2f0: 2020 2069 6620 6e6f 7420 696e 636c 7564     if not includ
-0001a300: 655f 636f 6e74 726f 6c6c 6572 3a0a 2020  e_controller:.  
-0001a310: 2020 2020 2020 7265 636f 7264 7320 3d20        records = 
-0001a320: 5b0a 2020 2020 2020 2020 2020 2020 7265  [.            re
-0001a330: 636f 7264 2066 6f72 2072 6563 6f72 6420  cord for record 
-0001a340: 696e 2072 6563 6f72 6473 0a20 2020 2020  in records.     
-0001a350: 2020 2020 2020 2069 6620 636f 6e74 726f         if contro
-0001a360: 6c6c 6572 5f75 7469 6c73 2e43 6f6e 7472  ller_utils.Contr
-0001a370: 6f6c 6c65 7273 2e66 726f 6d5f 6e61 6d65  ollers.from_name
-0001a380: 2872 6563 6f72 645b 276e 616d 6527 5d29  (record['name'])
-0001a390: 2069 7320 4e6f 6e65 0a20 2020 2020 2020   is None.       
-0001a3a0: 205d 0a0a 2020 2020 7965 6c6c 6f77 203d   ]..    yellow =
-0001a3b0: 2063 6f6c 6f72 616d 612e 466f 7265 2e59   colorama.Fore.Y
-0001a3c0: 454c 4c4f 570a 2020 2020 6272 6967 6874  ELLOW.    bright
-0001a3d0: 203d 2063 6f6c 6f72 616d 612e 5374 796c   = colorama.Styl
-0001a3e0: 652e 4252 4947 4854 0a20 2020 2072 6573  e.BRIGHT.    res
-0001a3f0: 6574 203d 2063 6f6c 6f72 616d 612e 5374  et = colorama.St
-0001a400: 796c 652e 5245 5345 545f 414c 4c0a 0a20  yle.RESET_ALL.. 
-0001a410: 2020 2069 6620 636c 7573 7465 725f 6e61     if cluster_na
-0001a420: 6d65 7320 6973 206e 6f74 204e 6f6e 653a  mes is not None:
-0001a430: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0001a440: 7374 616e 6365 2863 6c75 7374 6572 5f6e  stance(cluster_n
-0001a450: 616d 6573 2c20 7374 7229 3a0a 2020 2020  ames, str):.    
-0001a460: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
-0001a470: 6e61 6d65 7320 3d20 5b63 6c75 7374 6572  names = [cluster
-0001a480: 5f6e 616d 6573 5d0a 2020 2020 2020 2020  _names].        
-0001a490: 6e65 775f 7265 636f 7264 7320 3d20 5b5d  new_records = []
-0001a4a0: 0a20 2020 2020 2020 206e 6f74 5f65 7869  .        not_exi
-0001a4b0: 7374 5f63 6c75 7374 6572 5f6e 616d 6573  st_cluster_names
-0001a4c0: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
-0001a4d0: 7220 636c 7573 7465 725f 6e61 6d65 2069  r cluster_name i
-0001a4e0: 6e20 636c 7573 7465 725f 6e61 6d65 733a  n cluster_names:
-0001a4f0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0001a500: 2072 6563 6f72 6420 696e 2072 6563 6f72   record in recor
-0001a510: 6473 3a0a 2020 2020 2020 2020 2020 2020  ds:.            
-0001a520: 2020 2020 6966 2072 6563 6f72 645b 276e      if record['n
-0001a530: 616d 6527 5d20 3d3d 2063 6c75 7374 6572  ame'] == cluster
-0001a540: 5f6e 616d 653a 0a20 2020 2020 2020 2020  _name:.         
-0001a550: 2020 2020 2020 2020 2020 206e 6577 5f72             new_r
-0001a560: 6563 6f72 6473 2e61 7070 656e 6428 7265  ecords.append(re
-0001a570: 636f 7264 290a 2020 2020 2020 2020 2020  cord).          
-0001a580: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-0001a590: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0001a5a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001a5b0: 2020 6e6f 745f 6578 6973 745f 636c 7573    not_exist_clus
-0001a5c0: 7465 725f 6e61 6d65 732e 6170 7065 6e64  ter_names.append
-0001a5d0: 2863 6c75 7374 6572 5f6e 616d 6529 0a20  (cluster_name). 
-0001a5e0: 2020 2020 2020 2069 6620 6e6f 745f 6578         if not_ex
-0001a5f0: 6973 745f 636c 7573 7465 725f 6e61 6d65  ist_cluster_name
-0001a600: 733a 0a20 2020 2020 2020 2020 2020 2063  s:.            c
-0001a610: 6c75 7374 6572 735f 7374 7220 3d20 272c  lusters_str = ',
-0001a620: 2027 2e6a 6f69 6e28 6e6f 745f 6578 6973   '.join(not_exis
-0001a630: 745f 636c 7573 7465 725f 6e61 6d65 7329  t_cluster_names)
-0001a640: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-0001a650: 6765 722e 696e 666f 2866 2743 6c75 7374  ger.info(f'Clust
-0001a660: 6572 2873 2920 6e6f 7420 666f 756e 643a  er(s) not found:
-0001a670: 207b 6272 6967 6874 7d7b 636c 7573 7465   {bright}{cluste
-0001a680: 7273 5f73 7472 7d7b 7265 7365 747d 2e27  rs_str}{reset}.'
-0001a690: 290a 2020 2020 2020 2020 7265 636f 7264  ).        record
-0001a6a0: 7320 3d20 6e65 775f 7265 636f 7264 730a  s = new_records.
-0001a6b0: 0a20 2020 2069 6620 6e6f 7420 7265 6672  .    if not refr
-0001a6c0: 6573 683a 0a20 2020 2020 2020 2072 6574  esh:.        ret
-0001a6d0: 7572 6e20 7265 636f 7264 730a 0a20 2020  urn records..   
-0001a6e0: 2070 6c75 7261 6c20 3d20 2773 2720 6966   plural = 's' if
-0001a6f0: 206c 656e 2872 6563 6f72 6473 2920 3e20   len(records) > 
-0001a700: 3120 656c 7365 2027 270a 2020 2020 7072  1 else ''.    pr
-0001a710: 6f67 7265 7373 203d 2072 6963 685f 7072  ogress = rich_pr
-0001a720: 6f67 7265 7373 2e50 726f 6772 6573 7328  ogress.Progress(
-0001a730: 7472 616e 7369 656e 743d 5472 7565 2c0a  transient=True,.
+00019c40: 2020 2020 2020 2020 2020 2020 2068 616e               han
+00019c50: 646c 653d 6861 6e64 6c65 290a 2020 2020  dle=handle).    
+00019c60: 6173 7365 7274 2068 616e 646c 6520 6973  assert handle is
+00019c70: 206e 6f74 204e 6f6e 6520 616e 6420 6861   not None and ha
+00019c80: 6e64 6c65 2e68 6561 645f 6970 2069 7320  ndle.head_ip is 
+00019c90: 6e6f 7420 4e6f 6e65 2c20 280a 2020 2020  not None, (.    
+00019ca0: 2020 2020 6861 6e64 6c65 2c20 636f 6e74      handle, cont
+00019cb0: 726f 6c6c 6572 5f73 7461 7475 7329 0a20  roller_status). 
+00019cc0: 2020 2072 6574 7572 6e20 6861 6e64 6c65     return handle
+00019cd0: 0a0a 0a63 6c61 7373 2043 6c6f 7564 4669  ...class CloudFi
+00019ce0: 6c74 6572 2865 6e75 6d2e 456e 756d 293a  lter(enum.Enum):
+00019cf0: 0a20 2020 2023 2046 696c 7465 7220 666f  .    # Filter fo
+00019d00: 7220 616c 6c20 7479 7065 7320 6f66 2063  r all types of c
+00019d10: 6c6f 7564 732e 0a20 2020 2041 4c4c 203d  louds..    ALL =
+00019d20: 2027 616c 6c27 0a20 2020 2023 2046 696c   'all'.    # Fil
+00019d30: 7465 7220 666f 7220 536b 7927 7320 6d61  ter for Sky's ma
+00019d40: 696e 2063 6c6f 7564 7320 2861 7773 2c20  in clouds (aws, 
+00019d50: 6763 702c 2061 7a75 7265 2c20 646f 636b  gcp, azure, dock
+00019d60: 6572 292e 0a20 2020 2043 4c4f 5544 535f  er)..    CLOUDS_
+00019d70: 414e 445f 444f 434b 4552 203d 2027 636c  AND_DOCKER = 'cl
+00019d80: 6f75 6473 2d61 6e64 2d64 6f63 6b65 7227  ouds-and-docker'
+00019d90: 0a20 2020 2023 2046 696c 7465 7220 666f  .    # Filter fo
+00019da0: 7220 6f6e 6c79 206c 6f63 616c 2063 6c6f  r only local clo
+00019db0: 7564 732e 0a20 2020 204c 4f43 414c 203d  uds..    LOCAL =
+00019dc0: 2027 6c6f 6361 6c27 0a0a 0a64 6566 2067   'local'...def g
+00019dd0: 6574 5f63 6c75 7374 6572 7328 0a20 2020  et_clusters(.   
+00019de0: 2069 6e63 6c75 6465 5f63 6f6e 7472 6f6c   include_control
+00019df0: 6c65 723a 2062 6f6f 6c2c 0a20 2020 2072  ler: bool,.    r
+00019e00: 6566 7265 7368 3a20 626f 6f6c 2c0a 2020  efresh: bool,.  
+00019e10: 2020 636c 7573 7465 725f 6e61 6d65 733a    cluster_names:
+00019e20: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
+00019e30: 7374 722c 204c 6973 745b 7374 725d 5d5d  str, List[str]]]
+00019e40: 203d 204e 6f6e 652c 0a29 202d 3e20 4c69   = None,.) -> Li
+00019e50: 7374 5b44 6963 745b 7374 722c 2041 6e79  st[Dict[str, Any
+00019e60: 5d5d 3a0a 2020 2020 2222 2252 6574 7572  ]]:.    """Retur
+00019e70: 6e73 2061 206c 6973 7420 6f66 2063 6163  ns a list of cac
+00019e80: 6865 6420 6f72 206f 7074 696f 6e61 6c6c  hed or optionall
+00019e90: 7920 7265 6672 6573 6865 6420 636c 7573  y refreshed clus
+00019ea0: 7465 7220 7265 636f 7264 732e 0a0a 2020  ter records...  
+00019eb0: 2020 436f 6d62 7320 7468 726f 7567 6820    Combs through 
+00019ec0: 7468 6520 6461 7461 6261 7365 2028 696e  the database (in
+00019ed0: 207e 2f2e 736b 792f 7374 6174 652e 6462   ~/.sky/state.db
+00019ee0: 2920 746f 2067 6574 2061 206c 6973 7420  ) to get a list 
+00019ef0: 6f66 2072 6563 6f72 6473 0a20 2020 2063  of records.    c
+00019f00: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
+00019f10: 6c61 756e 6368 6564 2063 6c75 7374 6572  launched cluster
+00019f20: 7320 2866 696c 7465 7265 6420 6279 2060  s (filtered by `
+00019f30: 636c 7573 7465 725f 6e61 6d65 7360 2069  cluster_names` i
+00019f40: 6620 6974 2069 730a 2020 2020 7370 6563  f it is.    spec
+00019f50: 6966 6965 6429 2e20 5468 6520 7265 6672  ified). The refr
+00019f60: 6573 6820 666c 6167 2063 616e 2062 6520  esh flag can be 
+00019f70: 7573 6564 2074 6f20 666f 7263 6520 6120  used to force a 
+00019f80: 7265 6672 6573 6820 6f66 2074 6865 2073  refresh of the s
+00019f90: 7461 7475 730a 2020 2020 6f66 2074 6865  tatus.    of the
+00019fa0: 2063 6c75 7374 6572 732e 0a0a 2020 2020   clusters...    
+00019fb0: 4172 6773 3a0a 2020 2020 2020 2020 696e  Args:.        in
+00019fc0: 636c 7564 655f 636f 6e74 726f 6c6c 6572  clude_controller
+00019fd0: 3a20 5768 6574 6865 7220 746f 2069 6e63  : Whether to inc
+00019fe0: 6c75 6465 2063 6f6e 7472 6f6c 6c65 7273  lude controllers
+00019ff0: 2c20 652e 672e 2073 706f 7420 636f 6e74  , e.g. spot cont
+0001a000: 726f 6c6c 6572 0a20 2020 2020 2020 2020  roller.         
+0001a010: 2020 206f 7220 736b 7920 7365 7276 6520     or sky serve 
+0001a020: 636f 6e74 726f 6c6c 6572 2e0a 2020 2020  controller..    
+0001a030: 2020 2020 7265 6672 6573 683a 2057 6865      refresh: Whe
+0001a040: 7468 6572 2074 6f20 7265 6672 6573 6820  ther to refresh 
+0001a050: 7468 6520 7374 6174 7573 206f 6620 7468  the status of th
+0001a060: 6520 636c 7573 7465 7273 2e20 2852 6566  e clusters. (Ref
+0001a070: 7265 7368 696e 6720 7769 6c6c 0a20 2020  reshing will.   
+0001a080: 2020 2020 2020 2020 2073 6574 2074 6865           set the
+0001a090: 2073 7461 7475 7320 746f 2053 544f 5050   status to STOPP
+0001a0a0: 4544 2069 6620 7468 6520 636c 7573 7465  ED if the cluste
+0001a0b0: 7220 6361 6e6e 6f74 2062 6520 7069 6e67  r cannot be ping
+0001a0c0: 6564 2e29 0a20 2020 2020 2020 2063 6c6f  ed.).        clo
+0001a0d0: 7564 5f66 696c 7465 723a 2053 6574 7320  ud_filter: Sets 
+0001a0e0: 7768 6963 6820 636c 6f75 6473 2074 6f20  which clouds to 
+0001a0f0: 6669 6c65 7220 7468 726f 7567 6820 6672  filer through fr
+0001a100: 6f6d 2074 6865 2067 6c6f 6261 6c20 7573  om the global us
+0001a110: 6572 0a20 2020 2020 2020 2020 2020 2073  er.            s
+0001a120: 7461 7465 2e20 5375 7070 6f72 7473 2074  tate. Supports t
+0001a130: 6872 6565 2076 616c 7565 732c 2027 616c  hree values, 'al
+0001a140: 6c27 2066 6f72 2061 6c6c 2063 6c6f 7564  l' for all cloud
+0001a150: 732c 2027 7075 626c 6963 2720 666f 720a  s, 'public' for.
+0001a160: 2020 2020 2020 2020 2020 2020 7075 626c              publ
+0001a170: 6963 2063 6c6f 7564 7320 6f6e 6c79 2c20  ic clouds only, 
+0001a180: 616e 6420 276c 6f63 616c 2720 666f 7220  and 'local' for 
+0001a190: 6f6e 6c79 206c 6f63 616c 2063 6c6f 7564  only local cloud
+0001a1a0: 732e 0a20 2020 2020 2020 2063 6c75 7374  s..        clust
+0001a1b0: 6572 5f6e 616d 6573 3a20 4966 2070 726f  er_names: If pro
+0001a1c0: 7669 6465 642c 206f 6e6c 7920 7265 7475  vided, only retu
+0001a1d0: 726e 2072 6563 6f72 6473 2066 6f72 2074  rn records for t
+0001a1e0: 6865 2067 6976 656e 2063 6c75 7374 6572  he given cluster
+0001a1f0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0001a200: 6573 2e0a 0a20 2020 2052 6574 7572 6e73  es...    Returns
+0001a210: 3a0a 2020 2020 2020 2020 4120 6c69 7374  :.        A list
+0001a220: 206f 6620 636c 7573 7465 7220 7265 636f   of cluster reco
+0001a230: 7264 732e 2049 6620 7468 6520 636c 7573  rds. If the clus
+0001a240: 7465 7220 646f 6573 206e 6f74 2065 7869  ter does not exi
+0001a250: 7374 206f 7220 6861 7320 6265 656e 0a20  st or has been. 
+0001a260: 2020 2020 2020 2074 6572 6d69 6e61 7465         terminate
+0001a270: 642c 2074 6865 2072 6563 6f72 6420 7769  d, the record wi
+0001a280: 6c6c 2062 6520 6f6d 6974 7465 6420 6672  ll be omitted fr
+0001a290: 6f6d 2074 6865 2072 6574 7572 6e65 6420  om the returned 
+0001a2a0: 6c69 7374 2e0a 2020 2020 2222 220a 2020  list..    """.  
+0001a2b0: 2020 7265 636f 7264 7320 3d20 676c 6f62    records = glob
+0001a2c0: 616c 5f75 7365 725f 7374 6174 652e 6765  al_user_state.ge
+0001a2d0: 745f 636c 7573 7465 7273 2829 0a0a 2020  t_clusters()..  
+0001a2e0: 2020 6966 206e 6f74 2069 6e63 6c75 6465    if not include
+0001a2f0: 5f63 6f6e 7472 6f6c 6c65 723a 0a20 2020  _controller:.   
+0001a300: 2020 2020 2072 6563 6f72 6473 203d 205b       records = [
+0001a310: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+0001a320: 6f72 6420 666f 7220 7265 636f 7264 2069  ord for record i
+0001a330: 6e20 7265 636f 7264 730a 2020 2020 2020  n records.      
+0001a340: 2020 2020 2020 6966 2063 6f6e 7472 6f6c        if control
+0001a350: 6c65 725f 7574 696c 732e 436f 6e74 726f  ler_utils.Contro
+0001a360: 6c6c 6572 732e 6672 6f6d 5f6e 616d 6528  llers.from_name(
+0001a370: 7265 636f 7264 5b27 6e61 6d65 275d 2920  record['name']) 
+0001a380: 6973 204e 6f6e 650a 2020 2020 2020 2020  is None.        
+0001a390: 5d0a 0a20 2020 2079 656c 6c6f 7720 3d20  ]..    yellow = 
+0001a3a0: 636f 6c6f 7261 6d61 2e46 6f72 652e 5945  colorama.Fore.YE
+0001a3b0: 4c4c 4f57 0a20 2020 2062 7269 6768 7420  LLOW.    bright 
+0001a3c0: 3d20 636f 6c6f 7261 6d61 2e53 7479 6c65  = colorama.Style
+0001a3d0: 2e42 5249 4748 540a 2020 2020 7265 7365  .BRIGHT.    rese
+0001a3e0: 7420 3d20 636f 6c6f 7261 6d61 2e53 7479  t = colorama.Sty
+0001a3f0: 6c65 2e52 4553 4554 5f41 4c4c 0a0a 2020  le.RESET_ALL..  
+0001a400: 2020 6966 2063 6c75 7374 6572 5f6e 616d    if cluster_nam
+0001a410: 6573 2069 7320 6e6f 7420 4e6f 6e65 3a0a  es is not None:.
+0001a420: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0001a430: 7461 6e63 6528 636c 7573 7465 725f 6e61  tance(cluster_na
+0001a440: 6d65 732c 2073 7472 293a 0a20 2020 2020  mes, str):.     
+0001a450: 2020 2020 2020 2063 6c75 7374 6572 5f6e         cluster_n
+0001a460: 616d 6573 203d 205b 636c 7573 7465 725f  ames = [cluster_
+0001a470: 6e61 6d65 735d 0a20 2020 2020 2020 206e  names].        n
+0001a480: 6577 5f72 6563 6f72 6473 203d 205b 5d0a  ew_records = [].
+0001a490: 2020 2020 2020 2020 6e6f 745f 6578 6973          not_exis
+0001a4a0: 745f 636c 7573 7465 725f 6e61 6d65 7320  t_cluster_names 
+0001a4b0: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
+0001a4c0: 2063 6c75 7374 6572 5f6e 616d 6520 696e   cluster_name in
+0001a4d0: 2063 6c75 7374 6572 5f6e 616d 6573 3a0a   cluster_names:.
+0001a4e0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0001a4f0: 7265 636f 7264 2069 6e20 7265 636f 7264  record in record
+0001a500: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0001a510: 2020 2069 6620 7265 636f 7264 5b27 6e61     if record['na
+0001a520: 6d65 275d 203d 3d20 636c 7573 7465 725f  me'] == cluster_
+0001a530: 6e61 6d65 3a0a 2020 2020 2020 2020 2020  name:.          
+0001a540: 2020 2020 2020 2020 2020 6e65 775f 7265            new_re
+0001a550: 636f 7264 732e 6170 7065 6e64 2872 6563  cords.append(rec
+0001a560: 6f72 6429 0a20 2020 2020 2020 2020 2020  ord).           
+0001a570: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
+0001a580: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001a590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a5a0: 206e 6f74 5f65 7869 7374 5f63 6c75 7374   not_exist_clust
+0001a5b0: 6572 5f6e 616d 6573 2e61 7070 656e 6428  er_names.append(
+0001a5c0: 636c 7573 7465 725f 6e61 6d65 290a 2020  cluster_name).  
+0001a5d0: 2020 2020 2020 6966 206e 6f74 5f65 7869        if not_exi
+0001a5e0: 7374 5f63 6c75 7374 6572 5f6e 616d 6573  st_cluster_names
+0001a5f0: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+0001a600: 7573 7465 7273 5f73 7472 203d 2027 2c20  usters_str = ', 
+0001a610: 272e 6a6f 696e 286e 6f74 5f65 7869 7374  '.join(not_exist
+0001a620: 5f63 6c75 7374 6572 5f6e 616d 6573 290a  _cluster_names).
+0001a630: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0001a640: 6572 2e69 6e66 6f28 6627 436c 7573 7465  er.info(f'Cluste
+0001a650: 7228 7329 206e 6f74 2066 6f75 6e64 3a20  r(s) not found: 
+0001a660: 7b62 7269 6768 747d 7b63 6c75 7374 6572  {bright}{cluster
+0001a670: 735f 7374 727d 7b72 6573 6574 7d2e 2729  s_str}{reset}.')
+0001a680: 0a20 2020 2020 2020 2072 6563 6f72 6473  .        records
+0001a690: 203d 206e 6577 5f72 6563 6f72 6473 0a0a   = new_records..
+0001a6a0: 2020 2020 6966 206e 6f74 2072 6566 7265      if not refre
+0001a6b0: 7368 3a0a 2020 2020 2020 2020 7265 7475  sh:.        retu
+0001a6c0: 726e 2072 6563 6f72 6473 0a0a 2020 2020  rn records..    
+0001a6d0: 706c 7572 616c 203d 2027 7327 2069 6620  plural = 's' if 
+0001a6e0: 6c65 6e28 7265 636f 7264 7329 203e 2031  len(records) > 1
+0001a6f0: 2065 6c73 6520 2727 0a20 2020 2070 726f   else ''.    pro
+0001a700: 6772 6573 7320 3d20 7269 6368 5f70 726f  gress = rich_pro
+0001a710: 6772 6573 732e 5072 6f67 7265 7373 2874  gress.Progress(t
+0001a720: 7261 6e73 6965 6e74 3d54 7275 652c 0a20  ransient=True,. 
+0001a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a760: 2020 2020 2020 7265 6469 7265 6374 5f73        redirect_s
-0001a770: 7464 6f75 743d 4661 6c73 652c 0a20 2020  tdout=False,.   
+0001a750: 2020 2020 2072 6564 6972 6563 745f 7374       redirect_st
+0001a760: 646f 7574 3d46 616c 7365 2c0a 2020 2020  dout=False,.    
+0001a770: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a7a0: 2020 2072 6564 6972 6563 745f 7374 6465     redirect_stde
-0001a7b0: 7272 3d46 616c 7365 290a 2020 2020 7461  rr=False).    ta
-0001a7c0: 736b 203d 2070 726f 6772 6573 732e 6164  sk = progress.ad
-0001a7d0: 645f 7461 736b 280a 2020 2020 2020 2020  d_task(.        
-0001a7e0: 6627 5b62 6f6c 6420 6379 616e 5d52 6566  f'[bold cyan]Ref
-0001a7f0: 7265 7368 696e 6720 7374 6174 7573 2066  reshing status f
-0001a800: 6f72 207b 6c65 6e28 7265 636f 7264 7329  or {len(records)
-0001a810: 7d20 636c 7573 7465 727b 706c 7572 616c  } cluster{plural
-0001a820: 7d5b 2f5d 272c 0a20 2020 2020 2020 2074  }[/]',.        t
-0001a830: 6f74 616c 3d6c 656e 2872 6563 6f72 6473  otal=len(records
-0001a840: 2929 0a0a 2020 2020 6465 6620 5f72 6566  ))..    def _ref
-0001a850: 7265 7368 5f63 6c75 7374 6572 2863 6c75  resh_cluster(clu
-0001a860: 7374 6572 5f6e 616d 6529 3a0a 2020 2020  ster_name):.    
-0001a870: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0001a880: 2020 2020 2072 6563 6f72 6420 3d20 7265       record = re
-0001a890: 6672 6573 685f 636c 7573 7465 725f 7265  fresh_cluster_re
-0001a8a0: 636f 7264 280a 2020 2020 2020 2020 2020  cord(.          
-0001a8b0: 2020 2020 2020 636c 7573 7465 725f 6e61        cluster_na
-0001a8c0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-0001a8d0: 2020 2020 666f 7263 655f 7265 6672 6573      force_refres
-0001a8e0: 685f 7374 6174 7573 6573 3d73 6574 2873  h_statuses=set(s
-0001a8f0: 7461 7475 735f 6c69 622e 436c 7573 7465  tatus_lib.Cluste
-0001a900: 7253 7461 7475 7329 2c0a 2020 2020 2020  rStatus),.      
-0001a910: 2020 2020 2020 2020 2020 6163 7175 6972            acquir
-0001a920: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
-0001a930: 6174 7573 5f6c 6f63 6b3d 5472 7565 290a  atus_lock=True).
-0001a940: 2020 2020 2020 2020 6578 6365 7074 2028          except (
-0001a950: 6578 6365 7074 696f 6e73 2e43 6c75 7374  exceptions.Clust
-0001a960: 6572 5374 6174 7573 4665 7463 6869 6e67  erStatusFetching
-0001a970: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
-0001a980: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
-0001a990: 732e 436c 6f75 6455 7365 7249 6465 6e74  s.CloudUserIdent
-0001a9a0: 6974 7945 7272 6f72 2c0a 2020 2020 2020  ityError,.      
-0001a9b0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0001a9c0: 696f 6e73 2e43 6c75 7374 6572 4f77 6e65  ions.ClusterOwne
-0001a9d0: 7249 6465 6e74 6974 794d 6973 6d61 7463  rIdentityMismatc
-0001a9e0: 6845 7272 6f72 2920 6173 2065 3a0a 2020  hError) as e:.  
-0001a9f0: 2020 2020 2020 2020 2020 2320 446f 206e            # Do n
-0001aa00: 6f74 2066 6169 6c20 7468 6520 656e 7469  ot fail the enti
-0001aa10: 7265 2072 6566 7265 7368 2070 726f 6365  re refresh proce
-0001aa20: 7373 2e20 5468 6520 6361 6c6c 6572 2077  ss. The caller w
-0001aa30: 696c 6c0a 2020 2020 2020 2020 2020 2020  ill.            
-0001aa40: 2320 6861 6e64 6c65 2074 6865 2027 554e  # handle the 'UN
-0001aa50: 4b4e 4f57 4e27 2073 7461 7475 732c 2061  KNOWN' status, a
-0001aa60: 6e64 2063 6f6c 6c65 6374 2074 6865 2065  nd collect the e
-0001aa70: 7272 6f72 7320 696e 746f 0a20 2020 2020  rrors into.     
-0001aa80: 2020 2020 2020 2023 2061 2074 6162 6c65         # a table
-0001aa90: 2e0a 2020 2020 2020 2020 2020 2020 7265  ..            re
-0001aaa0: 636f 7264 203d 207b 2773 7461 7475 7327  cord = {'status'
-0001aab0: 3a20 2755 4e4b 4e4f 574e 272c 2027 6572  : 'UNKNOWN', 'er
-0001aac0: 726f 7227 3a20 657d 0a20 2020 2020 2020  ror': e}.       
-0001aad0: 2070 726f 6772 6573 732e 7570 6461 7465   progress.update
-0001aae0: 2874 6173 6b2c 2061 6476 616e 6365 3d31  (task, advance=1
-0001aaf0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0001ab00: 2072 6563 6f72 640a 0a20 2020 2063 6c75   record..    clu
-0001ab10: 7374 6572 5f6e 616d 6573 203d 205b 7265  ster_names = [re
-0001ab20: 636f 7264 5b27 6e61 6d65 275d 2066 6f72  cord['name'] for
-0001ab30: 2072 6563 6f72 6420 696e 2072 6563 6f72   record in recor
-0001ab40: 6473 5d0a 2020 2020 7769 7468 2070 726f  ds].    with pro
-0001ab50: 6772 6573 733a 0a20 2020 2020 2020 2075  gress:.        u
-0001ab60: 7064 6174 6564 5f72 6563 6f72 6473 203d  pdated_records =
-0001ab70: 2073 7562 7072 6f63 6573 735f 7574 696c   subprocess_util
-0001ab80: 732e 7275 6e5f 696e 5f70 6172 616c 6c65  s.run_in_paralle
-0001ab90: 6c28 0a20 2020 2020 2020 2020 2020 205f  l(.            _
-0001aba0: 7265 6672 6573 685f 636c 7573 7465 722c  refresh_cluster,
-0001abb0: 2063 6c75 7374 6572 5f6e 616d 6573 290a   cluster_names).
-0001abc0: 0a20 2020 2023 2053 686f 7720 696e 666f  .    # Show info
-0001abd0: 726d 6174 696f 6e20 666f 7220 7265 6d6f  rmation for remo
-0001abe0: 7665 6420 636c 7573 7465 7273 2e0a 2020  ved clusters..  
-0001abf0: 2020 6b65 7074 5f72 6563 6f72 6473 203d    kept_records =
-0001ac00: 205b 5d0a 2020 2020 6175 746f 646f 776e   [].    autodown
-0001ac10: 5f63 6c75 7374 6572 732c 2072 656d 6169  _clusters, remai
-0001ac20: 6e69 6e67 5f63 6c75 7374 6572 732c 2066  ning_clusters, f
-0001ac30: 6169 6c65 645f 636c 7573 7465 7273 203d  ailed_clusters =
-0001ac40: 205b 5d2c 205b 5d2c 205b 5d0a 2020 2020   [], [], [].    
-0001ac50: 666f 7220 692c 2072 6563 6f72 6420 696e  for i, record in
-0001ac60: 2065 6e75 6d65 7261 7465 2872 6563 6f72   enumerate(recor
-0001ac70: 6473 293a 0a20 2020 2020 2020 2069 6620  ds):.        if 
-0001ac80: 7570 6461 7465 645f 7265 636f 7264 735b  updated_records[
-0001ac90: 695d 2069 7320 4e6f 6e65 3a0a 2020 2020  i] is None:.    
-0001aca0: 2020 2020 2020 2020 6966 2072 6563 6f72          if recor
-0001acb0: 645b 2774 6f5f 646f 776e 275d 3a0a 2020  d['to_down']:.  
-0001acc0: 2020 2020 2020 2020 2020 2020 2020 6175                au
-0001acd0: 746f 646f 776e 5f63 6c75 7374 6572 732e  todown_clusters.
-0001ace0: 6170 7065 6e64 2863 6c75 7374 6572 5f6e  append(cluster_n
-0001acf0: 616d 6573 5b69 5d29 0a20 2020 2020 2020  ames[i]).       
-0001ad00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001ad10: 2020 2020 2020 2020 2020 2072 656d 6169             remai
-0001ad20: 6e69 6e67 5f63 6c75 7374 6572 732e 6170  ning_clusters.ap
-0001ad30: 7065 6e64 2863 6c75 7374 6572 5f6e 616d  pend(cluster_nam
-0001ad40: 6573 5b69 5d29 0a20 2020 2020 2020 2065  es[i]).        e
-0001ad50: 6c69 6620 7570 6461 7465 645f 7265 636f  lif updated_reco
-0001ad60: 7264 735b 695d 5b27 7374 6174 7573 275d  rds[i]['status']
-0001ad70: 203d 3d20 2755 4e4b 4e4f 574e 273a 0a20   == 'UNKNOWN':. 
-0001ad80: 2020 2020 2020 2020 2020 2066 6169 6c65             faile
-0001ad90: 645f 636c 7573 7465 7273 2e61 7070 656e  d_clusters.appen
-0001ada0: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-0001adb0: 2020 2028 636c 7573 7465 725f 6e61 6d65     (cluster_name
-0001adc0: 735b 695d 2c20 7570 6461 7465 645f 7265  s[i], updated_re
-0001add0: 636f 7264 735b 695d 5b27 6572 726f 7227  cords[i]['error'
-0001ade0: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
-0001adf0: 2320 4b65 6570 2074 6865 206f 7269 6769  # Keep the origi
-0001ae00: 6e61 6c20 7265 636f 7264 2069 6620 7468  nal record if th
-0001ae10: 6520 7374 6174 7573 2069 7320 756e 6b6e  e status is unkn
-0001ae20: 6f77 6e2c 0a20 2020 2020 2020 2020 2020  own,.           
-0001ae30: 2023 2073 6f20 7468 6174 2074 6865 2075   # so that the u
-0001ae40: 7365 7220 6361 6e20 7374 696c 6c20 7365  ser can still se
-0001ae50: 6520 7468 6520 636c 7573 7465 722e 0a20  e the cluster.. 
-0001ae60: 2020 2020 2020 2020 2020 206b 6570 745f             kept_
-0001ae70: 7265 636f 7264 732e 6170 7065 6e64 2872  records.append(r
-0001ae80: 6563 6f72 6429 0a20 2020 2020 2020 2065  ecord).        e
-0001ae90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001aea0: 206b 6570 745f 7265 636f 7264 732e 6170   kept_records.ap
-0001aeb0: 7065 6e64 2875 7064 6174 6564 5f72 6563  pend(updated_rec
-0001aec0: 6f72 6473 5b69 5d29 0a0a 2020 2020 6966  ords[i])..    if
-0001aed0: 2061 7574 6f64 6f77 6e5f 636c 7573 7465   autodown_cluste
-0001aee0: 7273 3a0a 2020 2020 2020 2020 706c 7572  rs:.        plur
-0001aef0: 616c 203d 2027 7327 2069 6620 6c65 6e28  al = 's' if len(
-0001af00: 6175 746f 646f 776e 5f63 6c75 7374 6572  autodown_cluster
-0001af10: 7329 203e 2031 2065 6c73 6520 2727 0a20  s) > 1 else ''. 
-0001af20: 2020 2020 2020 2063 6c75 7374 6572 5f73         cluster_s
-0001af30: 7472 203d 2027 2c20 272e 6a6f 696e 2861  tr = ', '.join(a
-0001af40: 7574 6f64 6f77 6e5f 636c 7573 7465 7273  utodown_clusters
-0001af50: 290a 2020 2020 2020 2020 6c6f 6767 6572  ).        logger
-0001af60: 2e69 6e66 6f28 6627 4175 746f 646f 776e  .info(f'Autodown
-0001af70: 6564 2063 6c75 7374 6572 7b70 6c75 7261  ed cluster{plura
-0001af80: 6c7d 3a20 270a 2020 2020 2020 2020 2020  l}: '.          
-0001af90: 2020 2020 2020 2020 2020 6627 7b62 7269            f'{bri
-0001afa0: 6768 747d 7b63 6c75 7374 6572 5f73 7472  ght}{cluster_str
-0001afb0: 7d7b 7265 7365 747d 2729 0a20 2020 2069  }{reset}').    i
-0001afc0: 6620 7265 6d61 696e 696e 675f 636c 7573  f remaining_clus
-0001afd0: 7465 7273 3a0a 2020 2020 2020 2020 706c  ters:.        pl
-0001afe0: 7572 616c 203d 2027 7327 2069 6620 6c65  ural = 's' if le
-0001aff0: 6e28 7265 6d61 696e 696e 675f 636c 7573  n(remaining_clus
-0001b000: 7465 7273 2920 3e20 3120 656c 7365 2027  ters) > 1 else '
-0001b010: 270a 2020 2020 2020 2020 636c 7573 7465  '.        cluste
-0001b020: 725f 7374 7220 3d20 272c 2027 2e6a 6f69  r_str = ', '.joi
-0001b030: 6e28 6e61 6d65 2066 6f72 206e 616d 6520  n(name for name 
-0001b040: 696e 2072 656d 6169 6e69 6e67 5f63 6c75  in remaining_clu
-0001b050: 7374 6572 7329 0a20 2020 2020 2020 206c  sters).        l
-0001b060: 6f67 6765 722e 7761 726e 696e 6728 6627  ogger.warning(f'
-0001b070: 7b79 656c 6c6f 777d 436c 7573 7465 727b  {yellow}Cluster{
-0001b080: 706c 7572 616c 7d20 7465 726d 696e 6174  plural} terminat
-0001b090: 6564 206f 6e20 270a 2020 2020 2020 2020  ed on '.        
-0001b0a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001b0b0: 2774 6865 2063 6c6f 7564 3a20 7b72 6573  'the cloud: {res
-0001b0c0: 6574 7d7b 6272 6967 6874 7d7b 636c 7573  et}{bright}{clus
-0001b0d0: 7465 725f 7374 727d 7b72 6573 6574 7d27  ter_str}{reset}'
-0001b0e0: 290a 0a20 2020 2069 6620 6661 696c 6564  )..    if failed
-0001b0f0: 5f63 6c75 7374 6572 733a 0a20 2020 2020  _clusters:.     
-0001b100: 2020 2070 6c75 7261 6c20 3d20 2773 2720     plural = 's' 
-0001b110: 6966 206c 656e 2866 6169 6c65 645f 636c  if len(failed_cl
-0001b120: 7573 7465 7273 2920 3e20 3120 656c 7365  usters) > 1 else
-0001b130: 2027 270a 2020 2020 2020 2020 6c6f 6767   ''.        logg
-0001b140: 6572 2e77 6172 6e69 6e67 2866 277b 7965  er.warning(f'{ye
-0001b150: 6c6c 6f77 7d46 6169 6c65 6420 746f 2072  llow}Failed to r
-0001b160: 6566 7265 7368 2073 7461 7475 7320 666f  efresh status fo
-0001b170: 7220 270a 2020 2020 2020 2020 2020 2020  r '.            
-0001b180: 2020 2020 2020 2020 2020 2066 277b 6c65             f'{le
-0001b190: 6e28 6661 696c 6564 5f63 6c75 7374 6572  n(failed_cluster
-0001b1a0: 7329 7d20 636c 7573 7465 727b 706c 7572  s)} cluster{plur
-0001b1b0: 616c 7d3a 7b72 6573 6574 7d27 290a 2020  al}:{reset}').  
-0001b1c0: 2020 2020 2020 666f 7220 636c 7573 7465        for cluste
-0001b1d0: 725f 6e61 6d65 2c20 6520 696e 2066 6169  r_name, e in fai
-0001b1e0: 6c65 645f 636c 7573 7465 7273 3a0a 2020  led_clusters:.  
-0001b1f0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0001b200: 2e77 6172 6e69 6e67 2866 2720 207b 6272  .warning(f'  {br
-0001b210: 6967 6874 7d7b 636c 7573 7465 725f 6e61  ight}{cluster_na
-0001b220: 6d65 7d7b 7265 7365 747d 3a20 7b65 7d27  me}{reset}: {e}'
-0001b230: 290a 2020 2020 7265 7475 726e 206b 6570  ).    return kep
-0001b240: 745f 7265 636f 7264 730a 0a0a 4074 7970  t_records...@typ
-0001b250: 696e 672e 6f76 6572 6c6f 6164 0a64 6566  ing.overload.def
-0001b260: 2067 6574 5f62 6163 6b65 6e64 5f66 726f   get_backend_fro
-0001b270: 6d5f 6861 6e64 6c65 280a 2020 2020 6861  m_handle(.    ha
-0001b280: 6e64 6c65 3a20 2763 6c6f 7564 5f76 6d5f  ndle: 'cloud_vm_
-0001b290: 7261 795f 6261 636b 656e 642e 436c 6f75  ray_backend.Clou
-0001b2a0: 6456 6d52 6179 5265 736f 7572 6365 4861  dVmRayResourceHa
-0001b2b0: 6e64 6c65 270a 2920 2d3e 2027 636c 6f75  ndle'.) -> 'clou
-0001b2c0: 645f 766d 5f72 6179 5f62 6163 6b65 6e64  d_vm_ray_backend
-0001b2d0: 2e43 6c6f 7564 566d 5261 7942 6163 6b65  .CloudVmRayBacke
-0001b2e0: 6e64 273a 0a20 2020 202e 2e2e 0a0a 0a40  nd':.    ......@
-0001b2f0: 7479 7069 6e67 2e6f 7665 726c 6f61 640a  typing.overload.
-0001b300: 6465 6620 6765 745f 6261 636b 656e 645f  def get_backend_
-0001b310: 6672 6f6d 5f68 616e 646c 6528 0a20 2020  from_handle(.   
-0001b320: 2068 616e 646c 653a 2027 6c6f 6361 6c5f   handle: 'local_
-0001b330: 646f 636b 6572 5f62 6163 6b65 6e64 2e4c  docker_backend.L
-0001b340: 6f63 616c 446f 636b 6572 5265 736f 7572  ocalDockerResour
-0001b350: 6365 4861 6e64 6c65 270a 2920 2d3e 2027  ceHandle'.) -> '
-0001b360: 6c6f 6361 6c5f 646f 636b 6572 5f62 6163  local_docker_bac
-0001b370: 6b65 6e64 2e4c 6f63 616c 446f 636b 6572  kend.LocalDocker
-0001b380: 4261 636b 656e 6427 3a0a 2020 2020 2e2e  Backend':.    ..
-0001b390: 2e0a 0a0a 4074 7970 696e 672e 6f76 6572  ....@typing.over
-0001b3a0: 6c6f 6164 0a64 6566 2067 6574 5f62 6163  load.def get_bac
-0001b3b0: 6b65 6e64 5f66 726f 6d5f 6861 6e64 6c65  kend_from_handle
-0001b3c0: 280a 2020 2020 2020 2020 6861 6e64 6c65  (.        handle
-0001b3d0: 3a20 6261 636b 656e 6473 2e52 6573 6f75  : backends.Resou
-0001b3e0: 7263 6548 616e 646c 6529 202d 3e20 6261  rceHandle) -> ba
-0001b3f0: 636b 656e 6473 2e42 6163 6b65 6e64 3a0a  ckends.Backend:.
-0001b400: 2020 2020 2e2e 2e0a 0a0a 6465 6620 6765      ......def ge
-0001b410: 745f 6261 636b 656e 645f 6672 6f6d 5f68  t_backend_from_h
-0001b420: 616e 646c 6528 0a20 2020 2020 2020 2068  andle(.        h
-0001b430: 616e 646c 653a 2062 6163 6b65 6e64 732e  andle: backends.
-0001b440: 5265 736f 7572 6365 4861 6e64 6c65 2920  ResourceHandle) 
-0001b450: 2d3e 2062 6163 6b65 6e64 732e 4261 636b  -> backends.Back
-0001b460: 656e 643a 0a20 2020 2022 2222 4765 7473  end:.    """Gets
-0001b470: 2061 2042 6163 6b65 6e64 206f 626a 6563   a Backend objec
-0001b480: 7420 636f 7272 6573 706f 6e64 696e 6720  t corresponding 
-0001b490: 746f 2061 2068 616e 646c 652e 0a0a 2020  to a handle...  
-0001b4a0: 2020 496e 7370 6563 7473 2068 616e 646c    Inspects handl
-0001b4b0: 6520 7479 7065 2074 6f20 696e 6665 7220  e type to infer 
-0001b4c0: 7468 6520 6261 636b 656e 6420 7573 6564  the backend used
-0001b4d0: 2066 6f72 2074 6865 2072 6573 6f75 7263   for the resourc
-0001b4e0: 652e 0a20 2020 2022 2222 0a20 2020 2062  e..    """.    b
-0001b4f0: 6163 6b65 6e64 3a20 6261 636b 656e 6473  ackend: backends
-0001b500: 2e42 6163 6b65 6e64 0a20 2020 2069 6620  .Backend.    if 
-0001b510: 6973 696e 7374 616e 6365 2868 616e 646c  isinstance(handl
-0001b520: 652c 2062 6163 6b65 6e64 732e 436c 6f75  e, backends.Clou
-0001b530: 6456 6d52 6179 5265 736f 7572 6365 4861  dVmRayResourceHa
-0001b540: 6e64 6c65 293a 0a20 2020 2020 2020 2062  ndle):.        b
-0001b550: 6163 6b65 6e64 203d 2062 6163 6b65 6e64  ackend = backend
-0001b560: 732e 436c 6f75 6456 6d52 6179 4261 636b  s.CloudVmRayBack
-0001b570: 656e 6428 290a 2020 2020 656c 6966 2069  end().    elif i
-0001b580: 7369 6e73 7461 6e63 6528 6861 6e64 6c65  sinstance(handle
-0001b590: 2c20 6261 636b 656e 6473 2e4c 6f63 616c  , backends.Local
-0001b5a0: 446f 636b 6572 5265 736f 7572 6365 4861  DockerResourceHa
-0001b5b0: 6e64 6c65 293a 0a20 2020 2020 2020 2062  ndle):.        b
-0001b5c0: 6163 6b65 6e64 203d 2062 6163 6b65 6e64  ackend = backend
-0001b5d0: 732e 4c6f 6361 6c44 6f63 6b65 7242 6163  s.LocalDockerBac
-0001b5e0: 6b65 6e64 2829 0a20 2020 2065 6c73 653a  kend().    else:
-0001b5f0: 0a20 2020 2020 2020 2072 6169 7365 204e  .        raise N
-0001b600: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
-0001b610: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0001b620: 6627 4861 6e64 6c65 2074 7970 6520 7b74  f'Handle type {t
-0001b630: 7970 6528 6861 6e64 6c65 297d 2069 7320  ype(handle)} is 
-0001b640: 6e6f 7420 7375 7070 6f72 7465 6420 7965  not supported ye
-0001b650: 742e 2729 0a20 2020 2072 6574 7572 6e20  t.').    return 
-0001b660: 6261 636b 656e 640a 0a0a 6465 6620 6765  backend...def ge
-0001b670: 745f 7461 736b 5f64 656d 616e 6473 5f64  t_task_demands_d
-0001b680: 6963 7428 7461 736b 3a20 2774 6173 6b5f  ict(task: 'task_
-0001b690: 6c69 622e 5461 736b 2729 202d 3e20 4469  lib.Task') -> Di
-0001b6a0: 6374 5b73 7472 2c20 666c 6f61 745d 3a0a  ct[str, float]:.
-0001b6b0: 2020 2020 2222 2252 6574 7572 6e73 2074      """Returns t
-0001b6c0: 6865 2072 6573 6f75 7263 6573 2064 6963  he resources dic
-0001b6d0: 7420 6f66 2074 6865 2074 6173 6b2e 0a0a  t of the task...
-0001b6e0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0001b6f0: 2020 2020 2041 2064 6963 7420 6f66 2074       A dict of t
-0001b700: 6865 2072 6573 6f75 7263 6573 206f 6620  he resources of 
-0001b710: 7468 6520 7461 736b 2e20 5468 6520 6b65  the task. The ke
-0001b720: 7973 2061 7265 2074 6865 2072 6573 6f75  ys are the resou
-0001b730: 7263 6520 6e61 6d65 730a 2020 2020 2020  rce names.      
-0001b740: 2020 616e 6420 7468 6520 7661 6c75 6573    and the values
-0001b750: 2061 7265 2074 6865 206e 756d 6265 7220   are the number 
-0001b760: 6f66 2074 6865 2072 6573 6f75 7263 6573  of the resources
-0001b770: 2e20 4974 2061 6c77 6179 7320 636f 6e74  . It always cont
-0001b780: 6169 6e73 0a20 2020 2020 2020 2074 6865  ains.        the
-0001b790: 2043 5055 2072 6573 6f75 7263 6520 2874   CPU resource (t
-0001b7a0: 6f20 636f 6e74 726f 6c20 7468 6520 6d61  o control the ma
-0001b7b0: 7869 6d75 6d20 6e75 6d62 6572 206f 6620  ximum number of 
-0001b7c0: 7461 736b 7329 2c20 616e 640a 2020 2020  tasks), and.    
-0001b7d0: 2020 2020 6f70 7469 6f6e 616c 6c79 2061      optionally a
-0001b7e0: 6363 656c 6572 6174 6f72 2064 656d 616e  ccelerator deman
-0001b7f0: 6473 2e0a 2020 2020 2222 220a 2020 2020  ds..    """.    
-0001b800: 2320 544f 444f 3a20 4375 7374 6f6d 2043  # TODO: Custom C
-0001b810: 5055 2061 6e64 206f 7468 6572 206d 656d  PU and other mem
-0001b820: 6f72 7920 7265 736f 7572 6365 7320 6172  ory resources ar
-0001b830: 6520 6e6f 7420 7375 7070 6f72 7465 6420  e not supported 
-0001b840: 7965 742e 0a20 2020 2023 2046 6f72 2073  yet..    # For s
-0001b850: 6b79 2073 706f 742f 7365 7276 6520 636f  ky spot/serve co
-0001b860: 6e74 726f 6c6c 6572 2074 6173 6b2c 2077  ntroller task, w
-0001b870: 6520 7365 7420 7468 6520 4350 5520 7265  e set the CPU re
-0001b880: 736f 7572 6365 2074 6f20 6120 736d 616c  source to a smal
-0001b890: 6c65 720a 2020 2020 2320 7661 6c75 6520  ler.    # value 
-0001b8a0: 746f 2073 7570 706f 7274 2061 206c 6172  to support a lar
-0001b8b0: 6765 7220 6e75 6d62 6572 206f 6620 7370  ger number of sp
-0001b8c0: 6f74 206a 6f62 7320 616e 6420 7365 7276  ot jobs and serv
-0001b8d0: 6963 6573 2e0a 2020 2020 7265 736f 7572  ices..    resour
-0001b8e0: 6365 735f 6469 6374 203d 207b 0a20 2020  ces_dict = {.   
-0001b8f0: 2020 2020 2027 4350 5527 3a20 2863 6f6e       'CPU': (con
-0001b900: 7374 616e 7473 2e43 4f4e 5452 4f4c 4c45  stants.CONTROLLE
-0001b910: 525f 5052 4f43 4553 535f 4350 555f 4445  R_PROCESS_CPU_DE
-0001b920: 4d41 4e44 0a20 2020 2020 2020 2020 2020  MAND.           
-0001b930: 2020 2020 2069 6620 7461 736b 2e69 735f       if task.is_
-0001b940: 636f 6e74 726f 6c6c 6572 5f74 6173 6b28  controller_task(
-0001b950: 2920 656c 7365 2044 4546 4155 4c54 5f54  ) else DEFAULT_T
-0001b960: 4153 4b5f 4350 555f 4445 4d41 4e44 290a  ASK_CPU_DEMAND).
-0001b970: 2020 2020 7d0a 2020 2020 6966 2074 6173      }.    if tas
-0001b980: 6b2e 6265 7374 5f72 6573 6f75 7263 6573  k.best_resources
-0001b990: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0001b9a0: 2020 2020 2020 7265 736f 7572 6365 7320        resources 
-0001b9b0: 3d20 7461 736b 2e62 6573 745f 7265 736f  = task.best_reso
-0001b9c0: 7572 6365 730a 2020 2020 656c 7365 3a0a  urces.    else:.
-0001b9d0: 2020 2020 2020 2020 2320 5461 736b 206d          # Task m
-0001b9e0: 6179 2028 652e 672e 2c20 736b 7920 6c61  ay (e.g., sky la
-0001b9f0: 756e 6368 2920 6f72 206d 6179 206e 6f74  unch) or may not
-0001ba00: 2028 652e 672e 2c20 736b 7920 6578 6563   (e.g., sky exec
-0001ba10: 2920 6861 7665 2075 6e64 6572 676f 6e65  ) have undergone
-0001ba20: 0a20 2020 2020 2020 2023 2073 6b79 2e6f  .        # sky.o
-0001ba30: 7074 696d 697a 6528 292c 2073 6f20 6265  ptimize(), so be
-0001ba40: 7374 5f72 6573 6f75 7263 6573 206d 6179  st_resources may
-0001ba50: 2062 6520 4e6f 6e65 2e0a 2020 2020 2020   be None..      
-0001ba60: 2020 6173 7365 7274 206c 656e 2874 6173    assert len(tas
-0001ba70: 6b2e 7265 736f 7572 6365 7329 203d 3d20  k.resources) == 
-0001ba80: 312c 2074 6173 6b2e 7265 736f 7572 6365  1, task.resource
-0001ba90: 730a 2020 2020 2020 2020 7265 736f 7572  s.        resour
-0001baa0: 6365 7320 3d20 6c69 7374 2874 6173 6b2e  ces = list(task.
-0001bab0: 7265 736f 7572 6365 7329 5b30 5d0a 2020  resources)[0].  
-0001bac0: 2020 6966 2072 6573 6f75 7263 6573 2069    if resources i
-0001bad0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2072  s not None and r
-0001bae0: 6573 6f75 7263 6573 2e61 6363 656c 6572  esources.acceler
-0001baf0: 6174 6f72 7320 6973 206e 6f74 204e 6f6e  ators is not Non
-0001bb00: 653a 0a20 2020 2020 2020 2072 6573 6f75  e:.        resou
-0001bb10: 7263 6573 5f64 6963 742e 7570 6461 7465  rces_dict.update
-0001bb20: 2872 6573 6f75 7263 6573 2e61 6363 656c  (resources.accel
-0001bb30: 6572 6174 6f72 7329 0a20 2020 2072 6574  erators).    ret
-0001bb40: 7572 6e20 7265 736f 7572 6365 735f 6469  urn resources_di
-0001bb50: 6374 0a0a 0a64 6566 2067 6574 5f74 6173  ct...def get_tas
-0001bb60: 6b5f 7265 736f 7572 6365 735f 7374 7228  k_resources_str(
-0001bb70: 7461 736b 3a20 2774 6173 6b5f 6c69 622e  task: 'task_lib.
-0001bb80: 5461 736b 2729 202d 3e20 7374 723a 0a20  Task') -> str:. 
-0001bb90: 2020 2022 2222 5265 7475 726e 7320 7468     """Returns th
-0001bba0: 6520 7265 736f 7572 6365 7320 7374 7269  e resources stri
-0001bbb0: 6e67 206f 6620 7468 6520 7461 736b 2e0a  ng of the task..
-0001bbc0: 0a20 2020 2054 6865 2072 6573 6f75 7263  .    The resourc
-0001bbd0: 6573 2073 7472 696e 6720 6973 206f 6e6c  es string is onl
-0001bbe0: 7920 7573 6564 2061 7320 6120 6469 7370  y used as a disp
-0001bbf0: 6c61 7920 7075 7270 6f73 652c 2073 6f20  lay purpose, so 
-0001bc00: 7765 206f 6e6c 7920 7368 6f77 0a20 2020  we only show.   
-0001bc10: 2074 6865 2061 6363 656c 6572 6174 6f72   the accelerator
-0001bc20: 2064 656d 616e 6473 2028 6966 2061 6e79   demands (if any
-0001bc30: 292e 204f 7468 6572 7769 7365 2c20 7468  ). Otherwise, th
-0001bc40: 6520 4350 5520 6465 6d61 6e64 2069 7320  e CPU demand is 
-0001bc50: 7368 6f77 6e2e 0a20 2020 2022 2222 0a20  shown..    """. 
-0001bc60: 2020 2074 6173 6b5f 6370 755f 6465 6d61     task_cpu_dema
-0001bc70: 6e64 203d 2028 636f 6e73 7461 6e74 732e  nd = (constants.
-0001bc80: 434f 4e54 524f 4c4c 4552 5f50 524f 4345  CONTROLLER_PROCE
-0001bc90: 5353 5f43 5055 5f44 454d 414e 4420 6966  SS_CPU_DEMAND if
-0001bca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bcb0: 2020 2020 2020 2020 7461 736b 2e69 735f          task.is_
-0001bcc0: 636f 6e74 726f 6c6c 6572 5f74 6173 6b28  controller_task(
-0001bcd0: 2920 656c 7365 2044 4546 4155 4c54 5f54  ) else DEFAULT_T
-0001bce0: 4153 4b5f 4350 555f 4445 4d41 4e44 290a  ASK_CPU_DEMAND).
-0001bcf0: 2020 2020 6966 2074 6173 6b2e 6265 7374      if task.best
-0001bd00: 5f72 6573 6f75 7263 6573 2069 7320 6e6f  _resources is no
-0001bd10: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0001bd20: 6163 6365 6c65 7261 746f 725f 6469 6374  accelerator_dict
-0001bd30: 203d 2074 6173 6b2e 6265 7374 5f72 6573   = task.best_res
-0001bd40: 6f75 7263 6573 2e61 6363 656c 6572 6174  ources.accelerat
-0001bd50: 6f72 730a 2020 2020 2020 2020 6966 2061  ors.        if a
-0001bd60: 6363 656c 6572 6174 6f72 5f64 6963 7420  ccelerator_dict 
-0001bd70: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0001bd80: 2020 2020 2072 6573 6f75 7263 6573 5f73       resources_s
-0001bd90: 7472 203d 2066 2743 5055 3a7b 7461 736b  tr = f'CPU:{task
-0001bda0: 5f63 7075 5f64 656d 616e 647d 270a 2020  _cpu_demand}'.  
-0001bdb0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001bdc0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-0001bdd0: 735f 7374 7220 3d20 272c 2027 2e6a 6f69  s_str = ', '.joi
-0001bde0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-0001bdf0: 2020 2066 277b 6b7d 3a7b 767d 2720 666f     f'{k}:{v}' fo
-0001be00: 7220 6b2c 2076 2069 6e20 6163 6365 6c65  r k, v in accele
-0001be10: 7261 746f 725f 6469 6374 2e69 7465 6d73  rator_dict.items
-0001be20: 2829 290a 2020 2020 656c 6966 206c 656e  ()).    elif len
-0001be30: 2874 6173 6b2e 7265 736f 7572 6365 7329  (task.resources)
-0001be40: 203d 3d20 313a 0a20 2020 2020 2020 2072   == 1:.        r
-0001be50: 6573 6f75 7263 6573 5f64 6963 7420 3d20  esources_dict = 
-0001be60: 6c69 7374 2874 6173 6b2e 7265 736f 7572  list(task.resour
-0001be70: 6365 7329 5b30 5d2e 6163 6365 6c65 7261  ces)[0].accelera
-0001be80: 746f 7273 0a20 2020 2020 2020 2069 6620  tors.        if 
-0001be90: 7265 736f 7572 6365 735f 6469 6374 2069  resources_dict i
-0001bea0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001beb0: 2020 2020 7265 736f 7572 6365 735f 7374      resources_st
-0001bec0: 7220 3d20 6627 4350 553a 7b74 6173 6b5f  r = f'CPU:{task_
-0001bed0: 6370 755f 6465 6d61 6e64 7d27 0a20 2020  cpu_demand}'.   
-0001bee0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001bef0: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-0001bf00: 5f73 7472 203d 2027 2c20 272e 6a6f 696e  _str = ', '.join
-0001bf10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001bf20: 2020 6627 7b6b 7d3a 7b76 7d27 2066 6f72    f'{k}:{v}' for
-0001bf30: 206b 2c20 7620 696e 2072 6573 6f75 7263   k, v in resourc
-0001bf40: 6573 5f64 6963 742e 6974 656d 7328 2929  es_dict.items())
-0001bf50: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0001bf60: 2020 2072 6573 6f75 7263 655f 6163 6365     resource_acce
-0001bf70: 6c65 7261 746f 7273 203d 205b 5d0a 2020  lerators = [].  
-0001bf80: 2020 2020 2020 666f 7220 7265 736f 7572        for resour
-0001bf90: 6365 2069 6e20 7461 736b 2e72 6573 6f75  ce in task.resou
-0001bfa0: 7263 6573 3a0a 2020 2020 2020 2020 2020  rces:.          
-0001bfb0: 2020 6966 2072 6573 6f75 7263 652e 6163    if resource.ac
-0001bfc0: 6365 6c65 7261 746f 7273 2069 7320 4e6f  celerators is No
-0001bfd0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001bfe0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-0001bff0: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
-0001c000: 7620 696e 2072 6573 6f75 7263 652e 6163  v in resource.ac
-0001c010: 6365 6c65 7261 746f 7273 2e69 7465 6d73  celerators.items
-0001c020: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0001c030: 2020 2020 7265 736f 7572 6365 5f61 6363      resource_acc
-0001c040: 656c 6572 6174 6f72 732e 6170 7065 6e64  elerators.append
-0001c050: 2866 277b 6b7d 3a7b 767d 2729 0a0a 2020  (f'{k}:{v}')..  
-0001c060: 2020 2020 2020 6966 2072 6573 6f75 7263        if resourc
-0001c070: 655f 6163 6365 6c65 7261 746f 7273 3a0a  e_accelerators:.
-0001c080: 2020 2020 2020 2020 2020 2020 7265 736f              reso
-0001c090: 7572 6365 735f 7374 7220 3d20 272c 2027  urces_str = ', '
-0001c0a0: 2e6a 6f69 6e28 7365 7428 7265 736f 7572  .join(set(resour
-0001c0b0: 6365 5f61 6363 656c 6572 6174 6f72 7329  ce_accelerators)
-0001c0c0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0001c0d0: 2020 2020 2020 2020 2020 2020 7265 736f              reso
-0001c0e0: 7572 6365 735f 7374 7220 3d20 6627 4350  urces_str = f'CP
-0001c0f0: 553a 7b74 6173 6b5f 6370 755f 6465 6d61  U:{task_cpu_dema
-0001c100: 6e64 7d27 0a20 2020 2072 6573 6f75 7263  nd}'.    resourc
-0001c110: 6573 5f73 7472 203d 2066 277b 7461 736b  es_str = f'{task
-0001c120: 2e6e 756d 5f6e 6f64 6573 7d78 205b 7b72  .num_nodes}x [{r
-0001c130: 6573 6f75 7263 6573 5f73 7472 7d5d 270a  esources_str}]'.
-0001c140: 2020 2020 7265 7475 726e 2072 6573 6f75      return resou
-0001c150: 7263 6573 5f73 7472 0a0a 0a23 2048 616e  rces_str...# Han
-0001c160: 646c 6520 6374 726c 2d63 0a64 6566 2069  dle ctrl-c.def i
-0001c170: 6e74 6572 7275 7074 5f68 616e 646c 6572  nterrupt_handler
-0001c180: 2873 6967 6e75 6d2c 2066 7261 6d65 293a  (signum, frame):
-0001c190: 0a20 2020 2064 656c 2073 6967 6e75 6d2c  .    del signum,
-0001c1a0: 2066 7261 6d65 0a20 2020 2073 7562 7072   frame.    subpr
-0001c1b0: 6f63 6573 735f 7574 696c 732e 6b69 6c6c  ocess_utils.kill
-0001c1c0: 5f63 6869 6c64 7265 6e5f 7072 6f63 6573  _children_proces
-0001c1d0: 7365 7328 290a 2020 2020 2320 4176 6f69  ses().    # Avoi
-0001c1e0: 6420 7573 696e 6720 6c6f 6767 6572 2068  d using logger h
-0001c1f0: 6572 652c 2061 7320 6974 2077 696c 6c20  ere, as it will 
-0001c200: 7072 696e 7420 7468 6520 7374 6163 6b20  print the stack 
-0001c210: 7472 6163 6520 666f 7220 6272 6f6b 656e  trace for broken
-0001c220: 0a20 2020 2023 2070 6970 652c 2077 6865  .    # pipe, whe
-0001c230: 6e20 7468 6520 6f75 7470 7574 2069 7320  n the output is 
-0001c240: 7069 7065 6420 746f 2061 6e6f 7468 6572  piped to another
-0001c250: 2070 726f 6772 616d 2e0a 2020 2020 7072   program..    pr
-0001c260: 696e 7428 6627 7b63 6f6c 6f72 616d 612e  int(f'{colorama.
-0001c270: 5374 796c 652e 4449 4d7d 5469 703a 2054  Style.DIM}Tip: T
-0001c280: 6865 206a 6f62 2077 696c 6c20 6b65 6570  he job will keep
-0001c290: 2027 0a20 2020 2020 2020 2020 2066 2772   '.          f'r
-0001c2a0: 756e 6e69 6e67 2061 6674 6572 2043 7472  unning after Ctr
-0001c2b0: 6c2d 432e 7b63 6f6c 6f72 616d 612e 5374  l-C.{colorama.St
-0001c2c0: 796c 652e 5245 5345 545f 414c 4c7d 2729  yle.RESET_ALL}')
-0001c2d0: 0a20 2020 2077 6974 6820 7578 5f75 7469  .    with ux_uti
-0001c2e0: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
-0001c2f0: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
-0001c300: 293a 0a20 2020 2020 2020 2072 6169 7365  ):.        raise
-0001c310: 204b 6579 626f 6172 6449 6e74 6572 7275   KeyboardInterru
-0001c320: 7074 2865 7863 6570 7469 6f6e 732e 4b45  pt(exceptions.KE
-0001c330: 5942 4f41 5244 5f49 4e54 4552 5255 5054  YBOARD_INTERRUPT
-0001c340: 5f43 4f44 4529 0a0a 0a23 2048 616e 646c  _CODE)...# Handl
-0001c350: 6520 6374 726c 2d7a 0a64 6566 2073 746f  e ctrl-z.def sto
-0001c360: 705f 6861 6e64 6c65 7228 7369 676e 756d  p_handler(signum
-0001c370: 2c20 6672 616d 6529 3a0a 2020 2020 6465  , frame):.    de
-0001c380: 6c20 7369 676e 756d 2c20 6672 616d 650a  l signum, frame.
-0001c390: 2020 2020 7375 6270 726f 6365 7373 5f75      subprocess_u
-0001c3a0: 7469 6c73 2e6b 696c 6c5f 6368 696c 6472  tils.kill_childr
-0001c3b0: 656e 5f70 726f 6365 7373 6573 2829 0a20  en_processes(). 
-0001c3c0: 2020 2023 2041 766f 6964 2075 7369 6e67     # Avoid using
-0001c3d0: 206c 6f67 6765 7220 6865 7265 2c20 6173   logger here, as
-0001c3e0: 2069 7420 7769 6c6c 2070 7269 6e74 2074   it will print t
-0001c3f0: 6865 2073 7461 636b 2074 7261 6365 2066  he stack trace f
-0001c400: 6f72 2062 726f 6b65 6e0a 2020 2020 2320  or broken.    # 
-0001c410: 7069 7065 2c20 7768 656e 2074 6865 206f  pipe, when the o
-0001c420: 7574 7075 7420 6973 2070 6970 6564 2074  utput is piped t
-0001c430: 6f20 616e 6f74 6865 7220 7072 6f67 7261  o another progra
-0001c440: 6d2e 0a20 2020 2070 7269 6e74 2866 277b  m..    print(f'{
-0001c450: 636f 6c6f 7261 6d61 2e53 7479 6c65 2e44  colorama.Style.D
-0001c460: 494d 7d54 6970 3a20 5468 6520 6a6f 6220  IM}Tip: The job 
-0001c470: 7769 6c6c 206b 6565 7020 270a 2020 2020  will keep '.    
-0001c480: 2020 2020 2020 6627 7275 6e6e 696e 6720        f'running 
-0001c490: 6166 7465 7220 4374 726c 2d5a 2e7b 636f  after Ctrl-Z.{co
-0001c4a0: 6c6f 7261 6d61 2e53 7479 6c65 2e52 4553  lorama.Style.RES
-0001c4b0: 4554 5f41 4c4c 7d27 290a 2020 2020 7769  ET_ALL}').    wi
-0001c4c0: 7468 2075 785f 7574 696c 732e 7072 696e  th ux_utils.prin
-0001c4d0: 745f 6578 6365 7074 696f 6e5f 6e6f 5f74  t_exception_no_t
-0001c4e0: 7261 6365 6261 636b 2829 3a0a 2020 2020  raceback():.    
-0001c4f0: 2020 2020 7261 6973 6520 4b65 7962 6f61      raise Keyboa
-0001c500: 7264 496e 7465 7272 7570 7428 6578 6365  rdInterrupt(exce
-0001c510: 7074 696f 6e73 2e53 4947 5453 5450 5f43  ptions.SIGTSTP_C
-0001c520: 4f44 4529 0a0a 0a64 6566 2072 756e 5f63  ODE)...def run_c
-0001c530: 6f6d 6d61 6e64 5f61 6e64 5f68 616e 646c  ommand_and_handl
-0001c540: 655f 7373 685f 6661 696c 7572 6528 7275  e_ssh_failure(ru
-0001c550: 6e6e 6572 3a20 636f 6d6d 616e 645f 7275  nner: command_ru
-0001c560: 6e6e 6572 2e53 5348 436f 6d6d 616e 6452  nner.SSHCommandR
-0001c570: 756e 6e65 722c 0a20 2020 2020 2020 2020  unner,.         
-0001c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c590: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0001c5a0: 6d6d 616e 643a 2073 7472 2c0a 2020 2020  mmand: str,.    
+0001a790: 2020 7265 6469 7265 6374 5f73 7464 6572    redirect_stder
+0001a7a0: 723d 4661 6c73 6529 0a20 2020 2074 6173  r=False).    tas
+0001a7b0: 6b20 3d20 7072 6f67 7265 7373 2e61 6464  k = progress.add
+0001a7c0: 5f74 6173 6b28 0a20 2020 2020 2020 2066  _task(.        f
+0001a7d0: 275b 626f 6c64 2063 7961 6e5d 5265 6672  '[bold cyan]Refr
+0001a7e0: 6573 6869 6e67 2073 7461 7475 7320 666f  eshing status fo
+0001a7f0: 7220 7b6c 656e 2872 6563 6f72 6473 297d  r {len(records)}
+0001a800: 2063 6c75 7374 6572 7b70 6c75 7261 6c7d   cluster{plural}
+0001a810: 5b2f 5d27 2c0a 2020 2020 2020 2020 746f  [/]',.        to
+0001a820: 7461 6c3d 6c65 6e28 7265 636f 7264 7329  tal=len(records)
+0001a830: 290a 0a20 2020 2064 6566 205f 7265 6672  )..    def _refr
+0001a840: 6573 685f 636c 7573 7465 7228 636c 7573  esh_cluster(clus
+0001a850: 7465 725f 6e61 6d65 293a 0a20 2020 2020  ter_name):.     
+0001a860: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001a870: 2020 2020 7265 636f 7264 203d 2072 6566      record = ref
+0001a880: 7265 7368 5f63 6c75 7374 6572 5f72 6563  resh_cluster_rec
+0001a890: 6f72 6428 0a20 2020 2020 2020 2020 2020  ord(.           
+0001a8a0: 2020 2020 2063 6c75 7374 6572 5f6e 616d       cluster_nam
+0001a8b0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0001a8c0: 2020 2066 6f72 6365 5f72 6566 7265 7368     force_refresh
+0001a8d0: 5f73 7461 7475 7365 733d 7365 7428 7374  _statuses=set(st
+0001a8e0: 6174 7573 5f6c 6962 2e43 6c75 7374 6572  atus_lib.Cluster
+0001a8f0: 5374 6174 7573 292c 0a20 2020 2020 2020  Status),.       
+0001a900: 2020 2020 2020 2020 2061 6371 7569 7265           acquire
+0001a910: 5f70 6572 5f63 6c75 7374 6572 5f73 7461  _per_cluster_sta
+0001a920: 7475 735f 6c6f 636b 3d54 7275 6529 0a20  tus_lock=True). 
+0001a930: 2020 2020 2020 2065 7863 6570 7420 2865         except (e
+0001a940: 7863 6570 7469 6f6e 732e 436c 7573 7465  xceptions.Cluste
+0001a950: 7253 7461 7475 7346 6574 6368 696e 6745  rStatusFetchingE
+0001a960: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
+0001a970: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
+0001a980: 2e43 6c6f 7564 5573 6572 4964 656e 7469  .CloudUserIdenti
+0001a990: 7479 4572 726f 722c 0a20 2020 2020 2020  tyError,.       
+0001a9a0: 2020 2020 2020 2020 2065 7863 6570 7469           excepti
+0001a9b0: 6f6e 732e 436c 7573 7465 724f 776e 6572  ons.ClusterOwner
+0001a9c0: 4964 656e 7469 7479 4d69 736d 6174 6368  IdentityMismatch
+0001a9d0: 4572 726f 7229 2061 7320 653a 0a20 2020  Error) as e:.   
+0001a9e0: 2020 2020 2020 2020 2023 2044 6f20 6e6f           # Do no
+0001a9f0: 7420 6661 696c 2074 6865 2065 6e74 6972  t fail the entir
+0001aa00: 6520 7265 6672 6573 6820 7072 6f63 6573  e refresh proces
+0001aa10: 732e 2054 6865 2063 616c 6c65 7220 7769  s. The caller wi
+0001aa20: 6c6c 0a20 2020 2020 2020 2020 2020 2023  ll.            #
+0001aa30: 2068 616e 646c 6520 7468 6520 2755 4e4b   handle the 'UNK
+0001aa40: 4e4f 574e 2720 7374 6174 7573 2c20 616e  NOWN' status, an
+0001aa50: 6420 636f 6c6c 6563 7420 7468 6520 6572  d collect the er
+0001aa60: 726f 7273 2069 6e74 6f0a 2020 2020 2020  rors into.      
+0001aa70: 2020 2020 2020 2320 6120 7461 626c 652e        # a table.
+0001aa80: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+0001aa90: 6f72 6420 3d20 7b27 7374 6174 7573 273a  ord = {'status':
+0001aaa0: 2027 554e 4b4e 4f57 4e27 2c20 2765 7272   'UNKNOWN', 'err
+0001aab0: 6f72 273a 2065 7d0a 2020 2020 2020 2020  or': e}.        
+0001aac0: 7072 6f67 7265 7373 2e75 7064 6174 6528  progress.update(
+0001aad0: 7461 736b 2c20 6164 7661 6e63 653d 3129  task, advance=1)
+0001aae0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001aaf0: 7265 636f 7264 0a0a 2020 2020 636c 7573  record..    clus
+0001ab00: 7465 725f 6e61 6d65 7320 3d20 5b72 6563  ter_names = [rec
+0001ab10: 6f72 645b 276e 616d 6527 5d20 666f 7220  ord['name'] for 
+0001ab20: 7265 636f 7264 2069 6e20 7265 636f 7264  record in record
+0001ab30: 735d 0a20 2020 2077 6974 6820 7072 6f67  s].    with prog
+0001ab40: 7265 7373 3a0a 2020 2020 2020 2020 7570  ress:.        up
+0001ab50: 6461 7465 645f 7265 636f 7264 7320 3d20  dated_records = 
+0001ab60: 7375 6270 726f 6365 7373 5f75 7469 6c73  subprocess_utils
+0001ab70: 2e72 756e 5f69 6e5f 7061 7261 6c6c 656c  .run_in_parallel
+0001ab80: 280a 2020 2020 2020 2020 2020 2020 5f72  (.            _r
+0001ab90: 6566 7265 7368 5f63 6c75 7374 6572 2c20  efresh_cluster, 
+0001aba0: 636c 7573 7465 725f 6e61 6d65 7329 0a0a  cluster_names)..
+0001abb0: 2020 2020 2320 5368 6f77 2069 6e66 6f72      # Show infor
+0001abc0: 6d61 7469 6f6e 2066 6f72 2072 656d 6f76  mation for remov
+0001abd0: 6564 2063 6c75 7374 6572 732e 0a20 2020  ed clusters..   
+0001abe0: 206b 6570 745f 7265 636f 7264 7320 3d20   kept_records = 
+0001abf0: 5b5d 0a20 2020 2061 7574 6f64 6f77 6e5f  [].    autodown_
+0001ac00: 636c 7573 7465 7273 2c20 7265 6d61 696e  clusters, remain
+0001ac10: 696e 675f 636c 7573 7465 7273 2c20 6661  ing_clusters, fa
+0001ac20: 696c 6564 5f63 6c75 7374 6572 7320 3d20  iled_clusters = 
+0001ac30: 5b5d 2c20 5b5d 2c20 5b5d 0a20 2020 2066  [], [], [].    f
+0001ac40: 6f72 2069 2c20 7265 636f 7264 2069 6e20  or i, record in 
+0001ac50: 656e 756d 6572 6174 6528 7265 636f 7264  enumerate(record
+0001ac60: 7329 3a0a 2020 2020 2020 2020 6966 2075  s):.        if u
+0001ac70: 7064 6174 6564 5f72 6563 6f72 6473 5b69  pdated_records[i
+0001ac80: 5d20 6973 204e 6f6e 653a 0a20 2020 2020  ] is None:.     
+0001ac90: 2020 2020 2020 2069 6620 7265 636f 7264         if record
+0001aca0: 5b27 746f 5f64 6f77 6e27 5d3a 0a20 2020  ['to_down']:.   
+0001acb0: 2020 2020 2020 2020 2020 2020 2061 7574               aut
+0001acc0: 6f64 6f77 6e5f 636c 7573 7465 7273 2e61  odown_clusters.a
+0001acd0: 7070 656e 6428 636c 7573 7465 725f 6e61  ppend(cluster_na
+0001ace0: 6d65 735b 695d 290a 2020 2020 2020 2020  mes[i]).        
+0001acf0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001ad00: 2020 2020 2020 2020 2020 7265 6d61 696e            remain
+0001ad10: 696e 675f 636c 7573 7465 7273 2e61 7070  ing_clusters.app
+0001ad20: 656e 6428 636c 7573 7465 725f 6e61 6d65  end(cluster_name
+0001ad30: 735b 695d 290a 2020 2020 2020 2020 656c  s[i]).        el
+0001ad40: 6966 2075 7064 6174 6564 5f72 6563 6f72  if updated_recor
+0001ad50: 6473 5b69 5d5b 2773 7461 7475 7327 5d20  ds[i]['status'] 
+0001ad60: 3d3d 2027 554e 4b4e 4f57 4e27 3a0a 2020  == 'UNKNOWN':.  
+0001ad70: 2020 2020 2020 2020 2020 6661 696c 6564            failed
+0001ad80: 5f63 6c75 7374 6572 732e 6170 7065 6e64  _clusters.append
+0001ad90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001ada0: 2020 2863 6c75 7374 6572 5f6e 616d 6573    (cluster_names
+0001adb0: 5b69 5d2c 2075 7064 6174 6564 5f72 6563  [i], updated_rec
+0001adc0: 6f72 6473 5b69 5d5b 2765 7272 6f72 275d  ords[i]['error']
+0001add0: 2929 0a20 2020 2020 2020 2020 2020 2023  )).            #
+0001ade0: 204b 6565 7020 7468 6520 6f72 6967 696e   Keep the origin
+0001adf0: 616c 2072 6563 6f72 6420 6966 2074 6865  al record if the
+0001ae00: 2073 7461 7475 7320 6973 2075 6e6b 6e6f   status is unkno
+0001ae10: 776e 2c0a 2020 2020 2020 2020 2020 2020  wn,.            
+0001ae20: 2320 736f 2074 6861 7420 7468 6520 7573  # so that the us
+0001ae30: 6572 2063 616e 2073 7469 6c6c 2073 6565  er can still see
+0001ae40: 2074 6865 2063 6c75 7374 6572 2e0a 2020   the cluster..  
+0001ae50: 2020 2020 2020 2020 2020 6b65 7074 5f72            kept_r
+0001ae60: 6563 6f72 6473 2e61 7070 656e 6428 7265  ecords.append(re
+0001ae70: 636f 7264 290a 2020 2020 2020 2020 656c  cord).        el
+0001ae80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001ae90: 6b65 7074 5f72 6563 6f72 6473 2e61 7070  kept_records.app
+0001aea0: 656e 6428 7570 6461 7465 645f 7265 636f  end(updated_reco
+0001aeb0: 7264 735b 695d 290a 0a20 2020 2069 6620  rds[i])..    if 
+0001aec0: 6175 746f 646f 776e 5f63 6c75 7374 6572  autodown_cluster
+0001aed0: 733a 0a20 2020 2020 2020 2070 6c75 7261  s:.        plura
+0001aee0: 6c20 3d20 2773 2720 6966 206c 656e 2861  l = 's' if len(a
+0001aef0: 7574 6f64 6f77 6e5f 636c 7573 7465 7273  utodown_clusters
+0001af00: 2920 3e20 3120 656c 7365 2027 270a 2020  ) > 1 else ''.  
+0001af10: 2020 2020 2020 636c 7573 7465 725f 7374        cluster_st
+0001af20: 7220 3d20 272c 2027 2e6a 6f69 6e28 6175  r = ', '.join(au
+0001af30: 746f 646f 776e 5f63 6c75 7374 6572 7329  todown_clusters)
+0001af40: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+0001af50: 696e 666f 2866 2741 7574 6f64 6f77 6e65  info(f'Autodowne
+0001af60: 6420 636c 7573 7465 727b 706c 7572 616c  d cluster{plural
+0001af70: 7d3a 2027 0a20 2020 2020 2020 2020 2020  }: '.           
+0001af80: 2020 2020 2020 2020 2066 277b 6272 6967           f'{brig
+0001af90: 6874 7d7b 636c 7573 7465 725f 7374 727d  ht}{cluster_str}
+0001afa0: 7b72 6573 6574 7d27 290a 2020 2020 6966  {reset}').    if
+0001afb0: 2072 656d 6169 6e69 6e67 5f63 6c75 7374   remaining_clust
+0001afc0: 6572 733a 0a20 2020 2020 2020 2070 6c75  ers:.        plu
+0001afd0: 7261 6c20 3d20 2773 2720 6966 206c 656e  ral = 's' if len
+0001afe0: 2872 656d 6169 6e69 6e67 5f63 6c75 7374  (remaining_clust
+0001aff0: 6572 7329 203e 2031 2065 6c73 6520 2727  ers) > 1 else ''
+0001b000: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
+0001b010: 5f73 7472 203d 2027 2c20 272e 6a6f 696e  _str = ', '.join
+0001b020: 286e 616d 6520 666f 7220 6e61 6d65 2069  (name for name i
+0001b030: 6e20 7265 6d61 696e 696e 675f 636c 7573  n remaining_clus
+0001b040: 7465 7273 290a 2020 2020 2020 2020 6c6f  ters).        lo
+0001b050: 6767 6572 2e77 6172 6e69 6e67 2866 277b  gger.warning(f'{
+0001b060: 7965 6c6c 6f77 7d43 6c75 7374 6572 7b70  yellow}Cluster{p
+0001b070: 6c75 7261 6c7d 2074 6572 6d69 6e61 7465  lural} terminate
+0001b080: 6420 6f6e 2027 0a20 2020 2020 2020 2020  d on '.         
+0001b090: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001b0a0: 7468 6520 636c 6f75 643a 207b 7265 7365  the cloud: {rese
+0001b0b0: 747d 7b62 7269 6768 747d 7b63 6c75 7374  t}{bright}{clust
+0001b0c0: 6572 5f73 7472 7d7b 7265 7365 747d 2729  er_str}{reset}')
+0001b0d0: 0a0a 2020 2020 6966 2066 6169 6c65 645f  ..    if failed_
+0001b0e0: 636c 7573 7465 7273 3a0a 2020 2020 2020  clusters:.      
+0001b0f0: 2020 706c 7572 616c 203d 2027 7327 2069    plural = 's' i
+0001b100: 6620 6c65 6e28 6661 696c 6564 5f63 6c75  f len(failed_clu
+0001b110: 7374 6572 7329 203e 2031 2065 6c73 6520  sters) > 1 else 
+0001b120: 2727 0a20 2020 2020 2020 206c 6f67 6765  ''.        logge
+0001b130: 722e 7761 726e 696e 6728 6627 7b79 656c  r.warning(f'{yel
+0001b140: 6c6f 777d 4661 696c 6564 2074 6f20 7265  low}Failed to re
+0001b150: 6672 6573 6820 7374 6174 7573 2066 6f72  fresh status for
+0001b160: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001b170: 2020 2020 2020 2020 2020 6627 7b6c 656e            f'{len
+0001b180: 2866 6169 6c65 645f 636c 7573 7465 7273  (failed_clusters
+0001b190: 297d 2063 6c75 7374 6572 7b70 6c75 7261  )} cluster{plura
+0001b1a0: 6c7d 3a7b 7265 7365 747d 2729 0a20 2020  l}:{reset}').   
+0001b1b0: 2020 2020 2066 6f72 2063 6c75 7374 6572       for cluster
+0001b1c0: 5f6e 616d 652c 2065 2069 6e20 6661 696c  _name, e in fail
+0001b1d0: 6564 5f63 6c75 7374 6572 733a 0a20 2020  ed_clusters:.   
+0001b1e0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0001b1f0: 7761 726e 696e 6728 6627 2020 7b62 7269  warning(f'  {bri
+0001b200: 6768 747d 7b63 6c75 7374 6572 5f6e 616d  ght}{cluster_nam
+0001b210: 657d 7b72 6573 6574 7d3a 207b 657d 2729  e}{reset}: {e}')
+0001b220: 0a20 2020 2072 6574 7572 6e20 6b65 7074  .    return kept
+0001b230: 5f72 6563 6f72 6473 0a0a 0a40 7479 7069  _records...@typi
+0001b240: 6e67 2e6f 7665 726c 6f61 640a 6465 6620  ng.overload.def 
+0001b250: 6765 745f 6261 636b 656e 645f 6672 6f6d  get_backend_from
+0001b260: 5f68 616e 646c 6528 0a20 2020 2068 616e  _handle(.    han
+0001b270: 646c 653a 2027 636c 6f75 645f 766d 5f72  dle: 'cloud_vm_r
+0001b280: 6179 5f62 6163 6b65 6e64 2e43 6c6f 7564  ay_backend.Cloud
+0001b290: 566d 5261 7952 6573 6f75 7263 6548 616e  VmRayResourceHan
+0001b2a0: 646c 6527 0a29 202d 3e20 2763 6c6f 7564  dle'.) -> 'cloud
+0001b2b0: 5f76 6d5f 7261 795f 6261 636b 656e 642e  _vm_ray_backend.
+0001b2c0: 436c 6f75 6456 6d52 6179 4261 636b 656e  CloudVmRayBacken
+0001b2d0: 6427 3a0a 2020 2020 2e2e 2e0a 0a0a 4074  d':.    ......@t
+0001b2e0: 7970 696e 672e 6f76 6572 6c6f 6164 0a64  yping.overload.d
+0001b2f0: 6566 2067 6574 5f62 6163 6b65 6e64 5f66  ef get_backend_f
+0001b300: 726f 6d5f 6861 6e64 6c65 280a 2020 2020  rom_handle(.    
+0001b310: 6861 6e64 6c65 3a20 276c 6f63 616c 5f64  handle: 'local_d
+0001b320: 6f63 6b65 725f 6261 636b 656e 642e 4c6f  ocker_backend.Lo
+0001b330: 6361 6c44 6f63 6b65 7252 6573 6f75 7263  calDockerResourc
+0001b340: 6548 616e 646c 6527 0a29 202d 3e20 276c  eHandle'.) -> 'l
+0001b350: 6f63 616c 5f64 6f63 6b65 725f 6261 636b  ocal_docker_back
+0001b360: 656e 642e 4c6f 6361 6c44 6f63 6b65 7242  end.LocalDockerB
+0001b370: 6163 6b65 6e64 273a 0a20 2020 202e 2e2e  ackend':.    ...
+0001b380: 0a0a 0a40 7479 7069 6e67 2e6f 7665 726c  ...@typing.overl
+0001b390: 6f61 640a 6465 6620 6765 745f 6261 636b  oad.def get_back
+0001b3a0: 656e 645f 6672 6f6d 5f68 616e 646c 6528  end_from_handle(
+0001b3b0: 0a20 2020 2020 2020 2068 616e 646c 653a  .        handle:
+0001b3c0: 2062 6163 6b65 6e64 732e 5265 736f 7572   backends.Resour
+0001b3d0: 6365 4861 6e64 6c65 2920 2d3e 2062 6163  ceHandle) -> bac
+0001b3e0: 6b65 6e64 732e 4261 636b 656e 643a 0a20  kends.Backend:. 
+0001b3f0: 2020 202e 2e2e 0a0a 0a64 6566 2067 6574     ......def get
+0001b400: 5f62 6163 6b65 6e64 5f66 726f 6d5f 6861  _backend_from_ha
+0001b410: 6e64 6c65 280a 2020 2020 2020 2020 6861  ndle(.        ha
+0001b420: 6e64 6c65 3a20 6261 636b 656e 6473 2e52  ndle: backends.R
+0001b430: 6573 6f75 7263 6548 616e 646c 6529 202d  esourceHandle) -
+0001b440: 3e20 6261 636b 656e 6473 2e42 6163 6b65  > backends.Backe
+0001b450: 6e64 3a0a 2020 2020 2222 2247 6574 7320  nd:.    """Gets 
+0001b460: 6120 4261 636b 656e 6420 6f62 6a65 6374  a Backend object
+0001b470: 2063 6f72 7265 7370 6f6e 6469 6e67 2074   corresponding t
+0001b480: 6f20 6120 6861 6e64 6c65 2e0a 0a20 2020  o a handle...   
+0001b490: 2049 6e73 7065 6374 7320 6861 6e64 6c65   Inspects handle
+0001b4a0: 2074 7970 6520 746f 2069 6e66 6572 2074   type to infer t
+0001b4b0: 6865 2062 6163 6b65 6e64 2075 7365 6420  he backend used 
+0001b4c0: 666f 7220 7468 6520 7265 736f 7572 6365  for the resource
+0001b4d0: 2e0a 2020 2020 2222 220a 2020 2020 6261  ..    """.    ba
+0001b4e0: 636b 656e 643a 2062 6163 6b65 6e64 732e  ckend: backends.
+0001b4f0: 4261 636b 656e 640a 2020 2020 6966 2069  Backend.    if i
+0001b500: 7369 6e73 7461 6e63 6528 6861 6e64 6c65  sinstance(handle
+0001b510: 2c20 6261 636b 656e 6473 2e43 6c6f 7564  , backends.Cloud
+0001b520: 566d 5261 7952 6573 6f75 7263 6548 616e  VmRayResourceHan
+0001b530: 646c 6529 3a0a 2020 2020 2020 2020 6261  dle):.        ba
+0001b540: 636b 656e 6420 3d20 6261 636b 656e 6473  ckend = backends
+0001b550: 2e43 6c6f 7564 566d 5261 7942 6163 6b65  .CloudVmRayBacke
+0001b560: 6e64 2829 0a20 2020 2065 6c69 6620 6973  nd().    elif is
+0001b570: 696e 7374 616e 6365 2868 616e 646c 652c  instance(handle,
+0001b580: 2062 6163 6b65 6e64 732e 4c6f 6361 6c44   backends.LocalD
+0001b590: 6f63 6b65 7252 6573 6f75 7263 6548 616e  ockerResourceHan
+0001b5a0: 646c 6529 3a0a 2020 2020 2020 2020 6261  dle):.        ba
+0001b5b0: 636b 656e 6420 3d20 6261 636b 656e 6473  ckend = backends
+0001b5c0: 2e4c 6f63 616c 446f 636b 6572 4261 636b  .LocalDockerBack
+0001b5d0: 656e 6428 290a 2020 2020 656c 7365 3a0a  end().    else:.
+0001b5e0: 2020 2020 2020 2020 7261 6973 6520 4e6f          raise No
+0001b5f0: 7449 6d70 6c65 6d65 6e74 6564 4572 726f  tImplementedErro
+0001b600: 7228 0a20 2020 2020 2020 2020 2020 2066  r(.            f
+0001b610: 2748 616e 646c 6520 7479 7065 207b 7479  'Handle type {ty
+0001b620: 7065 2868 616e 646c 6529 7d20 6973 206e  pe(handle)} is n
+0001b630: 6f74 2073 7570 706f 7274 6564 2079 6574  ot supported yet
+0001b640: 2e27 290a 2020 2020 7265 7475 726e 2062  .').    return b
+0001b650: 6163 6b65 6e64 0a0a 0a64 6566 2067 6574  ackend...def get
+0001b660: 5f74 6173 6b5f 6465 6d61 6e64 735f 6469  _task_demands_di
+0001b670: 6374 2874 6173 6b3a 2027 7461 736b 5f6c  ct(task: 'task_l
+0001b680: 6962 2e54 6173 6b27 2920 2d3e 2044 6963  ib.Task') -> Dic
+0001b690: 745b 7374 722c 2066 6c6f 6174 5d3a 0a20  t[str, float]:. 
+0001b6a0: 2020 2022 2222 5265 7475 726e 7320 7468     """Returns th
+0001b6b0: 6520 7265 736f 7572 6365 7320 6469 6374  e resources dict
+0001b6c0: 206f 6620 7468 6520 7461 736b 2e0a 0a20   of the task... 
+0001b6d0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+0001b6e0: 2020 2020 4120 6469 6374 206f 6620 7468      A dict of th
+0001b6f0: 6520 7265 736f 7572 6365 7320 6f66 2074  e resources of t
+0001b700: 6865 2074 6173 6b2e 2054 6865 206b 6579  he task. The key
+0001b710: 7320 6172 6520 7468 6520 7265 736f 7572  s are the resour
+0001b720: 6365 206e 616d 6573 0a20 2020 2020 2020  ce names.       
+0001b730: 2061 6e64 2074 6865 2076 616c 7565 7320   and the values 
+0001b740: 6172 6520 7468 6520 6e75 6d62 6572 206f  are the number o
+0001b750: 6620 7468 6520 7265 736f 7572 6365 732e  f the resources.
+0001b760: 2049 7420 616c 7761 7973 2063 6f6e 7461   It always conta
+0001b770: 696e 730a 2020 2020 2020 2020 7468 6520  ins.        the 
+0001b780: 4350 5520 7265 736f 7572 6365 2028 746f  CPU resource (to
+0001b790: 2063 6f6e 7472 6f6c 2074 6865 206d 6178   control the max
+0001b7a0: 696d 756d 206e 756d 6265 7220 6f66 2074  imum number of t
+0001b7b0: 6173 6b73 292c 2061 6e64 0a20 2020 2020  asks), and.     
+0001b7c0: 2020 206f 7074 696f 6e61 6c6c 7920 6163     optionally ac
+0001b7d0: 6365 6c65 7261 746f 7220 6465 6d61 6e64  celerator demand
+0001b7e0: 732e 0a20 2020 2022 2222 0a20 2020 2023  s..    """.    #
+0001b7f0: 2054 4f44 4f3a 2043 7573 746f 6d20 4350   TODO: Custom CP
+0001b800: 5520 616e 6420 6f74 6865 7220 6d65 6d6f  U and other memo
+0001b810: 7279 2072 6573 6f75 7263 6573 2061 7265  ry resources are
+0001b820: 206e 6f74 2073 7570 706f 7274 6564 2079   not supported y
+0001b830: 6574 2e0a 2020 2020 2320 466f 7220 736b  et..    # For sk
+0001b840: 7920 7370 6f74 2f73 6572 7665 2063 6f6e  y spot/serve con
+0001b850: 7472 6f6c 6c65 7220 7461 736b 2c20 7765  troller task, we
+0001b860: 2073 6574 2074 6865 2043 5055 2072 6573   set the CPU res
+0001b870: 6f75 7263 6520 746f 2061 2073 6d61 6c6c  ource to a small
+0001b880: 6572 0a20 2020 2023 2076 616c 7565 2074  er.    # value t
+0001b890: 6f20 7375 7070 6f72 7420 6120 6c61 7267  o support a larg
+0001b8a0: 6572 206e 756d 6265 7220 6f66 2073 706f  er number of spo
+0001b8b0: 7420 6a6f 6273 2061 6e64 2073 6572 7669  t jobs and servi
+0001b8c0: 6365 732e 0a20 2020 2072 6573 6f75 7263  ces..    resourc
+0001b8d0: 6573 5f64 6963 7420 3d20 7b0a 2020 2020  es_dict = {.    
+0001b8e0: 2020 2020 2743 5055 273a 2028 636f 6e73      'CPU': (cons
+0001b8f0: 7461 6e74 732e 434f 4e54 524f 4c4c 4552  tants.CONTROLLER
+0001b900: 5f50 524f 4345 5353 5f43 5055 5f44 454d  _PROCESS_CPU_DEM
+0001b910: 414e 440a 2020 2020 2020 2020 2020 2020  AND.            
+0001b920: 2020 2020 6966 2074 6173 6b2e 6973 5f63      if task.is_c
+0001b930: 6f6e 7472 6f6c 6c65 725f 7461 736b 2829  ontroller_task()
+0001b940: 2065 6c73 6520 4445 4641 554c 545f 5441   else DEFAULT_TA
+0001b950: 534b 5f43 5055 5f44 454d 414e 4429 0a20  SK_CPU_DEMAND). 
+0001b960: 2020 207d 0a20 2020 2069 6620 7461 736b     }.    if task
+0001b970: 2e62 6573 745f 7265 736f 7572 6365 7320  .best_resources 
+0001b980: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0001b990: 2020 2020 2072 6573 6f75 7263 6573 203d       resources =
+0001b9a0: 2074 6173 6b2e 6265 7374 5f72 6573 6f75   task.best_resou
+0001b9b0: 7263 6573 0a20 2020 2065 6c73 653a 0a20  rces.    else:. 
+0001b9c0: 2020 2020 2020 2023 2054 6173 6b20 6d61         # Task ma
+0001b9d0: 7920 2865 2e67 2e2c 2073 6b79 206c 6175  y (e.g., sky lau
+0001b9e0: 6e63 6829 206f 7220 6d61 7920 6e6f 7420  nch) or may not 
+0001b9f0: 2865 2e67 2e2c 2073 6b79 2065 7865 6329  (e.g., sky exec)
+0001ba00: 2068 6176 6520 756e 6465 7267 6f6e 650a   have undergone.
+0001ba10: 2020 2020 2020 2020 2320 736b 792e 6f70          # sky.op
+0001ba20: 7469 6d69 7a65 2829 2c20 736f 2062 6573  timize(), so bes
+0001ba30: 745f 7265 736f 7572 6365 7320 6d61 7920  t_resources may 
+0001ba40: 6265 204e 6f6e 652e 0a20 2020 2020 2020  be None..       
+0001ba50: 2061 7373 6572 7420 6c65 6e28 7461 736b   assert len(task
+0001ba60: 2e72 6573 6f75 7263 6573 2920 3d3d 2031  .resources) == 1
+0001ba70: 2c20 7461 736b 2e72 6573 6f75 7263 6573  , task.resources
+0001ba80: 0a20 2020 2020 2020 2072 6573 6f75 7263  .        resourc
+0001ba90: 6573 203d 206c 6973 7428 7461 736b 2e72  es = list(task.r
+0001baa0: 6573 6f75 7263 6573 295b 305d 0a20 2020  esources)[0].   
+0001bab0: 2069 6620 7265 736f 7572 6365 7320 6973   if resources is
+0001bac0: 206e 6f74 204e 6f6e 6520 616e 6420 7265   not None and re
+0001bad0: 736f 7572 6365 732e 6163 6365 6c65 7261  sources.accelera
+0001bae0: 746f 7273 2069 7320 6e6f 7420 4e6f 6e65  tors is not None
+0001baf0: 3a0a 2020 2020 2020 2020 7265 736f 7572  :.        resour
+0001bb00: 6365 735f 6469 6374 2e75 7064 6174 6528  ces_dict.update(
+0001bb10: 7265 736f 7572 6365 732e 6163 6365 6c65  resources.accele
+0001bb20: 7261 746f 7273 290a 2020 2020 7265 7475  rators).    retu
+0001bb30: 726e 2072 6573 6f75 7263 6573 5f64 6963  rn resources_dic
+0001bb40: 740a 0a0a 6465 6620 6765 745f 7461 736b  t...def get_task
+0001bb50: 5f72 6573 6f75 7263 6573 5f73 7472 2874  _resources_str(t
+0001bb60: 6173 6b3a 2027 7461 736b 5f6c 6962 2e54  ask: 'task_lib.T
+0001bb70: 6173 6b27 2920 2d3e 2073 7472 3a0a 2020  ask') -> str:.  
+0001bb80: 2020 2222 2252 6574 7572 6e73 2074 6865    """Returns the
+0001bb90: 2072 6573 6f75 7263 6573 2073 7472 696e   resources strin
+0001bba0: 6720 6f66 2074 6865 2074 6173 6b2e 0a0a  g of the task...
+0001bbb0: 2020 2020 5468 6520 7265 736f 7572 6365      The resource
+0001bbc0: 7320 7374 7269 6e67 2069 7320 6f6e 6c79  s string is only
+0001bbd0: 2075 7365 6420 6173 2061 2064 6973 706c   used as a displ
+0001bbe0: 6179 2070 7572 706f 7365 2c20 736f 2077  ay purpose, so w
+0001bbf0: 6520 6f6e 6c79 2073 686f 770a 2020 2020  e only show.    
+0001bc00: 7468 6520 6163 6365 6c65 7261 746f 7220  the accelerator 
+0001bc10: 6465 6d61 6e64 7320 2869 6620 616e 7929  demands (if any)
+0001bc20: 2e20 4f74 6865 7277 6973 652c 2074 6865  . Otherwise, the
+0001bc30: 2043 5055 2064 656d 616e 6420 6973 2073   CPU demand is s
+0001bc40: 686f 776e 2e0a 2020 2020 2222 220a 2020  hown..    """.  
+0001bc50: 2020 7461 736b 5f63 7075 5f64 656d 616e    task_cpu_deman
+0001bc60: 6420 3d20 2863 6f6e 7374 616e 7473 2e43  d = (constants.C
+0001bc70: 4f4e 5452 4f4c 4c45 525f 5052 4f43 4553  ONTROLLER_PROCES
+0001bc80: 535f 4350 555f 4445 4d41 4e44 2069 660a  S_CPU_DEMAND if.
+0001bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bca0: 2020 2020 2020 2074 6173 6b2e 6973 5f63         task.is_c
+0001bcb0: 6f6e 7472 6f6c 6c65 725f 7461 736b 2829  ontroller_task()
+0001bcc0: 2065 6c73 6520 4445 4641 554c 545f 5441   else DEFAULT_TA
+0001bcd0: 534b 5f43 5055 5f44 454d 414e 4429 0a20  SK_CPU_DEMAND). 
+0001bce0: 2020 2069 6620 7461 736b 2e62 6573 745f     if task.best_
+0001bcf0: 7265 736f 7572 6365 7320 6973 206e 6f74  resources is not
+0001bd00: 204e 6f6e 653a 0a20 2020 2020 2020 2061   None:.        a
+0001bd10: 6363 656c 6572 6174 6f72 5f64 6963 7420  ccelerator_dict 
+0001bd20: 3d20 7461 736b 2e62 6573 745f 7265 736f  = task.best_reso
+0001bd30: 7572 6365 732e 6163 6365 6c65 7261 746f  urces.accelerato
+0001bd40: 7273 0a20 2020 2020 2020 2069 6620 6163  rs.        if ac
+0001bd50: 6365 6c65 7261 746f 725f 6469 6374 2069  celerator_dict i
+0001bd60: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001bd70: 2020 2020 7265 736f 7572 6365 735f 7374      resources_st
+0001bd80: 7220 3d20 6627 4350 553a 7b74 6173 6b5f  r = f'CPU:{task_
+0001bd90: 6370 755f 6465 6d61 6e64 7d27 0a20 2020  cpu_demand}'.   
+0001bda0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001bdb0: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
+0001bdc0: 5f73 7472 203d 2027 2c20 272e 6a6f 696e  _str = ', '.join
+0001bdd0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001bde0: 2020 6627 7b6b 7d3a 7b76 7d27 2066 6f72    f'{k}:{v}' for
+0001bdf0: 206b 2c20 7620 696e 2061 6363 656c 6572   k, v in acceler
+0001be00: 6174 6f72 5f64 6963 742e 6974 656d 7328  ator_dict.items(
+0001be10: 2929 0a20 2020 2065 6c69 6620 6c65 6e28  )).    elif len(
+0001be20: 7461 736b 2e72 6573 6f75 7263 6573 2920  task.resources) 
+0001be30: 3d3d 2031 3a0a 2020 2020 2020 2020 7265  == 1:.        re
+0001be40: 736f 7572 6365 735f 6469 6374 203d 206c  sources_dict = l
+0001be50: 6973 7428 7461 736b 2e72 6573 6f75 7263  ist(task.resourc
+0001be60: 6573 295b 305d 2e61 6363 656c 6572 6174  es)[0].accelerat
+0001be70: 6f72 730a 2020 2020 2020 2020 6966 2072  ors.        if r
+0001be80: 6573 6f75 7263 6573 5f64 6963 7420 6973  esources_dict is
+0001be90: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0001bea0: 2020 2072 6573 6f75 7263 6573 5f73 7472     resources_str
+0001beb0: 203d 2066 2743 5055 3a7b 7461 736b 5f63   = f'CPU:{task_c
+0001bec0: 7075 5f64 656d 616e 647d 270a 2020 2020  pu_demand}'.    
+0001bed0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001bee0: 2020 2020 2020 7265 736f 7572 6365 735f        resources_
+0001bef0: 7374 7220 3d20 272c 2027 2e6a 6f69 6e28  str = ', '.join(
+0001bf00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bf10: 2066 277b 6b7d 3a7b 767d 2720 666f 7220   f'{k}:{v}' for 
+0001bf20: 6b2c 2076 2069 6e20 7265 736f 7572 6365  k, v in resource
+0001bf30: 735f 6469 6374 2e69 7465 6d73 2829 290a  s_dict.items()).
+0001bf40: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001bf50: 2020 7265 736f 7572 6365 5f61 6363 656c    resource_accel
+0001bf60: 6572 6174 6f72 7320 3d20 5b5d 0a20 2020  erators = [].   
+0001bf70: 2020 2020 2066 6f72 2072 6573 6f75 7263       for resourc
+0001bf80: 6520 696e 2074 6173 6b2e 7265 736f 7572  e in task.resour
+0001bf90: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
+0001bfa0: 2069 6620 7265 736f 7572 6365 2e61 6363   if resource.acc
+0001bfb0: 656c 6572 6174 6f72 7320 6973 204e 6f6e  elerators is Non
+0001bfc0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001bfd0: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+0001bfe0: 2020 2020 2020 2020 666f 7220 6b2c 2076          for k, v
+0001bff0: 2069 6e20 7265 736f 7572 6365 2e61 6363   in resource.acc
+0001c000: 656c 6572 6174 6f72 732e 6974 656d 7328  elerators.items(
+0001c010: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001c020: 2020 2072 6573 6f75 7263 655f 6163 6365     resource_acce
+0001c030: 6c65 7261 746f 7273 2e61 7070 656e 6428  lerators.append(
+0001c040: 6627 7b6b 7d3a 7b76 7d27 290a 0a20 2020  f'{k}:{v}')..   
+0001c050: 2020 2020 2069 6620 7265 736f 7572 6365       if resource
+0001c060: 5f61 6363 656c 6572 6174 6f72 733a 0a20  _accelerators:. 
+0001c070: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
+0001c080: 7263 6573 5f73 7472 203d 2027 2c20 272e  rces_str = ', '.
+0001c090: 6a6f 696e 2873 6574 2872 6573 6f75 7263  join(set(resourc
+0001c0a0: 655f 6163 6365 6c65 7261 746f 7273 2929  e_accelerators))
+0001c0b0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001c0c0: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
+0001c0d0: 7263 6573 5f73 7472 203d 2066 2743 5055  rces_str = f'CPU
+0001c0e0: 3a7b 7461 736b 5f63 7075 5f64 656d 616e  :{task_cpu_deman
+0001c0f0: 647d 270a 2020 2020 7265 736f 7572 6365  d}'.    resource
+0001c100: 735f 7374 7220 3d20 6627 7b74 6173 6b2e  s_str = f'{task.
+0001c110: 6e75 6d5f 6e6f 6465 737d 7820 5b7b 7265  num_nodes}x [{re
+0001c120: 736f 7572 6365 735f 7374 727d 5d27 0a20  sources_str}]'. 
+0001c130: 2020 2072 6574 7572 6e20 7265 736f 7572     return resour
+0001c140: 6365 735f 7374 720a 0a0a 2320 4861 6e64  ces_str...# Hand
+0001c150: 6c65 2063 7472 6c2d 630a 6465 6620 696e  le ctrl-c.def in
+0001c160: 7465 7272 7570 745f 6861 6e64 6c65 7228  terrupt_handler(
+0001c170: 7369 676e 756d 2c20 6672 616d 6529 3a0a  signum, frame):.
+0001c180: 2020 2020 6465 6c20 7369 676e 756d 2c20      del signum, 
+0001c190: 6672 616d 650a 2020 2020 7375 6270 726f  frame.    subpro
+0001c1a0: 6365 7373 5f75 7469 6c73 2e6b 696c 6c5f  cess_utils.kill_
+0001c1b0: 6368 696c 6472 656e 5f70 726f 6365 7373  children_process
+0001c1c0: 6573 2829 0a20 2020 2023 2041 766f 6964  es().    # Avoid
+0001c1d0: 2075 7369 6e67 206c 6f67 6765 7220 6865   using logger he
+0001c1e0: 7265 2c20 6173 2069 7420 7769 6c6c 2070  re, as it will p
+0001c1f0: 7269 6e74 2074 6865 2073 7461 636b 2074  rint the stack t
+0001c200: 7261 6365 2066 6f72 2062 726f 6b65 6e0a  race for broken.
+0001c210: 2020 2020 2320 7069 7065 2c20 7768 656e      # pipe, when
+0001c220: 2074 6865 206f 7574 7075 7420 6973 2070   the output is p
+0001c230: 6970 6564 2074 6f20 616e 6f74 6865 7220  iped to another 
+0001c240: 7072 6f67 7261 6d2e 0a20 2020 2070 7269  program..    pri
+0001c250: 6e74 2866 277b 636f 6c6f 7261 6d61 2e53  nt(f'{colorama.S
+0001c260: 7479 6c65 2e44 494d 7d54 6970 3a20 5468  tyle.DIM}Tip: Th
+0001c270: 6520 6a6f 6220 7769 6c6c 206b 6565 7020  e job will keep 
+0001c280: 270a 2020 2020 2020 2020 2020 6627 7275  '.          f'ru
+0001c290: 6e6e 696e 6720 6166 7465 7220 4374 726c  nning after Ctrl
+0001c2a0: 2d43 2e7b 636f 6c6f 7261 6d61 2e53 7479  -C.{colorama.Sty
+0001c2b0: 6c65 2e52 4553 4554 5f41 4c4c 7d27 290a  le.RESET_ALL}').
+0001c2c0: 2020 2020 7769 7468 2075 785f 7574 696c      with ux_util
+0001c2d0: 732e 7072 696e 745f 6578 6365 7074 696f  s.print_exceptio
+0001c2e0: 6e5f 6e6f 5f74 7261 6365 6261 636b 2829  n_no_traceback()
+0001c2f0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+0001c300: 4b65 7962 6f61 7264 496e 7465 7272 7570  KeyboardInterrup
+0001c310: 7428 6578 6365 7074 696f 6e73 2e4b 4559  t(exceptions.KEY
+0001c320: 424f 4152 445f 494e 5445 5252 5550 545f  BOARD_INTERRUPT_
+0001c330: 434f 4445 290a 0a0a 2320 4861 6e64 6c65  CODE)...# Handle
+0001c340: 2063 7472 6c2d 7a0a 6465 6620 7374 6f70   ctrl-z.def stop
+0001c350: 5f68 616e 646c 6572 2873 6967 6e75 6d2c  _handler(signum,
+0001c360: 2066 7261 6d65 293a 0a20 2020 2064 656c   frame):.    del
+0001c370: 2073 6967 6e75 6d2c 2066 7261 6d65 0a20   signum, frame. 
+0001c380: 2020 2073 7562 7072 6f63 6573 735f 7574     subprocess_ut
+0001c390: 696c 732e 6b69 6c6c 5f63 6869 6c64 7265  ils.kill_childre
+0001c3a0: 6e5f 7072 6f63 6573 7365 7328 290a 2020  n_processes().  
+0001c3b0: 2020 2320 4176 6f69 6420 7573 696e 6720    # Avoid using 
+0001c3c0: 6c6f 6767 6572 2068 6572 652c 2061 7320  logger here, as 
+0001c3d0: 6974 2077 696c 6c20 7072 696e 7420 7468  it will print th
+0001c3e0: 6520 7374 6163 6b20 7472 6163 6520 666f  e stack trace fo
+0001c3f0: 7220 6272 6f6b 656e 0a20 2020 2023 2070  r broken.    # p
+0001c400: 6970 652c 2077 6865 6e20 7468 6520 6f75  ipe, when the ou
+0001c410: 7470 7574 2069 7320 7069 7065 6420 746f  tput is piped to
+0001c420: 2061 6e6f 7468 6572 2070 726f 6772 616d   another program
+0001c430: 2e0a 2020 2020 7072 696e 7428 6627 7b63  ..    print(f'{c
+0001c440: 6f6c 6f72 616d 612e 5374 796c 652e 4449  olorama.Style.DI
+0001c450: 4d7d 5469 703a 2054 6865 206a 6f62 2077  M}Tip: The job w
+0001c460: 696c 6c20 6b65 6570 2027 0a20 2020 2020  ill keep '.     
+0001c470: 2020 2020 2066 2772 756e 6e69 6e67 2061       f'running a
+0001c480: 6674 6572 2043 7472 6c2d 5a2e 7b63 6f6c  fter Ctrl-Z.{col
+0001c490: 6f72 616d 612e 5374 796c 652e 5245 5345  orama.Style.RESE
+0001c4a0: 545f 414c 4c7d 2729 0a20 2020 2077 6974  T_ALL}').    wit
+0001c4b0: 6820 7578 5f75 7469 6c73 2e70 7269 6e74  h ux_utils.print
+0001c4c0: 5f65 7863 6570 7469 6f6e 5f6e 6f5f 7472  _exception_no_tr
+0001c4d0: 6163 6562 6163 6b28 293a 0a20 2020 2020  aceback():.     
+0001c4e0: 2020 2072 6169 7365 204b 6579 626f 6172     raise Keyboar
+0001c4f0: 6449 6e74 6572 7275 7074 2865 7863 6570  dInterrupt(excep
+0001c500: 7469 6f6e 732e 5349 4754 5354 505f 434f  tions.SIGTSTP_CO
+0001c510: 4445 290a 0a0a 6465 6620 7275 6e5f 636f  DE)...def run_co
+0001c520: 6d6d 616e 645f 616e 645f 6861 6e64 6c65  mmand_and_handle
+0001c530: 5f73 7368 5f66 6169 6c75 7265 2872 756e  _ssh_failure(run
+0001c540: 6e65 723a 2063 6f6d 6d61 6e64 5f72 756e  ner: command_run
+0001c550: 6e65 722e 5353 4843 6f6d 6d61 6e64 5275  ner.SSHCommandRu
+0001c560: 6e6e 6572 2c0a 2020 2020 2020 2020 2020  nner,.          
+0001c570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c580: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+0001c590: 6d61 6e64 3a20 7374 722c 0a20 2020 2020  mand: str,.     
+0001c5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c5d0: 2020 2066 6169 6c75 7265 5f6d 6573 7361     failure_messa
-0001c5e0: 6765 3a20 7374 7229 202d 3e20 7374 723a  ge: str) -> str:
-0001c5f0: 0a20 2020 2022 2222 5275 6e73 2063 6f6d  .    """Runs com
-0001c600: 6d61 6e64 2072 656d 6f74 656c 7920 616e  mand remotely an
-0001c610: 6420 7265 7475 726e 7320 6f75 7470 7574  d returns output
-0001c620: 2077 6974 6820 7072 6f70 6572 2065 7272   with proper err
-0001c630: 6f72 2068 616e 646c 696e 672e 2222 220a  or handling.""".
-0001c640: 2020 2020 7263 2c20 7374 646f 7574 2c20      rc, stdout, 
-0001c650: 7374 6465 7272 203d 2072 756e 6e65 722e  stderr = runner.
-0001c660: 7275 6e28 636f 6d6d 616e 642c 0a20 2020  run(command,.   
+0001c5c0: 2020 6661 696c 7572 655f 6d65 7373 6167    failure_messag
+0001c5d0: 653a 2073 7472 2920 2d3e 2073 7472 3a0a  e: str) -> str:.
+0001c5e0: 2020 2020 2222 2252 756e 7320 636f 6d6d      """Runs comm
+0001c5f0: 616e 6420 7265 6d6f 7465 6c79 2061 6e64  and remotely and
+0001c600: 2072 6574 7572 6e73 206f 7574 7075 7420   returns output 
+0001c610: 7769 7468 2070 726f 7065 7220 6572 726f  with proper erro
+0001c620: 7220 6861 6e64 6c69 6e67 2e22 2222 0a20  r handling.""". 
+0001c630: 2020 2072 632c 2073 7464 6f75 742c 2073     rc, stdout, s
+0001c640: 7464 6572 7220 3d20 7275 6e6e 6572 2e72  tderr = runner.r
+0001c650: 756e 2863 6f6d 6d61 6e64 2c0a 2020 2020  un(command,.    
+0001c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001c670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c690: 2072 6571 7569 7265 5f6f 7574 7075 7473   require_outputs
-0001c6a0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-0001c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c6c0: 2020 2020 2020 2020 2020 2073 7472 6561             strea
-0001c6d0: 6d5f 6c6f 6773 3d46 616c 7365 290a 2020  m_logs=False).  
-0001c6e0: 2020 6966 2072 6320 3d3d 2032 3535 3a0a    if rc == 255:.
-0001c6f0: 2020 2020 2020 2020 2320 5353 4820 6661          # SSH fa
-0001c700: 696c 6564 0a20 2020 2020 2020 2072 6169  iled.        rai
-0001c710: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
-0001c720: 0a20 2020 2020 2020 2020 2020 2066 2753  .            f'S
-0001c730: 5348 2077 6974 6820 7573 6572 207b 7275  SH with user {ru
-0001c740: 6e6e 6572 2e73 7368 5f75 7365 727d 2061  nner.ssh_user} a
-0001c750: 6e64 206b 6579 207b 7275 6e6e 6572 2e73  nd key {runner.s
-0001c760: 7368 5f70 7269 7661 7465 5f6b 6579 7d20  sh_private_key} 
-0001c770: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-0001c780: 746f 207b 7275 6e6e 6572 2e69 707d 2066  to {runner.ip} f
-0001c790: 6169 6c65 642e 2054 6869 7320 6973 206d  ailed. This is m
-0001c7a0: 6f73 7420 6c69 6b65 6c79 2064 7565 2074  ost likely due t
-0001c7b0: 6f20 696e 636f 7272 6563 7420 270a 2020  o incorrect '.  
-0001c7c0: 2020 2020 2020 2020 2020 2763 7265 6465            'crede
-0001c7d0: 6e74 6961 6c73 206f 7220 696e 636f 7272  ntials or incorr
-0001c7e0: 6563 7420 7065 726d 6973 7369 6f6e 7320  ect permissions 
-0001c7f0: 666f 7220 7468 6520 6b65 7920 6669 6c65  for the key file
-0001c800: 2e20 4368 6563 6b20 270a 2020 2020 2020  . Check '.      
-0001c810: 2020 2020 2020 2779 6f75 7220 6372 6564        'your cred
-0001c820: 656e 7469 616c 7320 616e 6420 7472 7920  entials and try 
-0001c830: 6167 6169 6e2e 2729 0a20 2020 2073 7562  again.').    sub
-0001c840: 7072 6f63 6573 735f 7574 696c 732e 6861  process_utils.ha
-0001c850: 6e64 6c65 5f72 6574 7572 6e63 6f64 6528  ndle_returncode(
-0001c860: 7263 2c0a 2020 2020 2020 2020 2020 2020  rc,.            
-0001c870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c880: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
-0001c890: 6e64 2c0a 2020 2020 2020 2020 2020 2020  nd,.            
-0001c8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c8b0: 2020 2020 2020 2020 2020 2066 6169 6c75             failu
-0001c8c0: 7265 5f6d 6573 7361 6765 2c0a 2020 2020  re_message,.    
+0001c680: 7265 7175 6972 655f 6f75 7470 7574 733d  require_outputs=
+0001c690: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+0001c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c6b0: 2020 2020 2020 2020 2020 7374 7265 616d            stream
+0001c6c0: 5f6c 6f67 733d 4661 6c73 6529 0a20 2020  _logs=False).   
+0001c6d0: 2069 6620 7263 203d 3d20 3235 353a 0a20   if rc == 255:. 
+0001c6e0: 2020 2020 2020 2023 2053 5348 2066 6169         # SSH fai
+0001c6f0: 6c65 640a 2020 2020 2020 2020 7261 6973  led.        rais
+0001c700: 6520 5275 6e74 696d 6545 7272 6f72 280a  e RuntimeError(.
+0001c710: 2020 2020 2020 2020 2020 2020 6627 5353              f'SS
+0001c720: 4820 7769 7468 2075 7365 7220 7b72 756e  H with user {run
+0001c730: 6e65 722e 7373 685f 7573 6572 7d20 616e  ner.ssh_user} an
+0001c740: 6420 6b65 7920 7b72 756e 6e65 722e 7373  d key {runner.ss
+0001c750: 685f 7072 6976 6174 655f 6b65 797d 2027  h_private_key} '
+0001c760: 0a20 2020 2020 2020 2020 2020 2066 2774  .            f't
+0001c770: 6f20 7b72 756e 6e65 722e 6970 7d20 6661  o {runner.ip} fa
+0001c780: 696c 6564 2e20 5468 6973 2069 7320 6d6f  iled. This is mo
+0001c790: 7374 206c 696b 656c 7920 6475 6520 746f  st likely due to
+0001c7a0: 2069 6e63 6f72 7265 6374 2027 0a20 2020   incorrect '.   
+0001c7b0: 2020 2020 2020 2020 2027 6372 6564 656e           'creden
+0001c7c0: 7469 616c 7320 6f72 2069 6e63 6f72 7265  tials or incorre
+0001c7d0: 6374 2070 6572 6d69 7373 696f 6e73 2066  ct permissions f
+0001c7e0: 6f72 2074 6865 206b 6579 2066 696c 652e  or the key file.
+0001c7f0: 2043 6865 636b 2027 0a20 2020 2020 2020   Check '.       
+0001c800: 2020 2020 2027 796f 7572 2063 7265 6465       'your crede
+0001c810: 6e74 6961 6c73 2061 6e64 2074 7279 2061  ntials and try a
+0001c820: 6761 696e 2e27 290a 2020 2020 7375 6270  gain.').    subp
+0001c830: 726f 6365 7373 5f75 7469 6c73 2e68 616e  rocess_utils.han
+0001c840: 646c 655f 7265 7475 726e 636f 6465 2872  dle_returncode(r
+0001c850: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
+0001c860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c870: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
+0001c880: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0001c890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c8a0: 2020 2020 2020 2020 2020 6661 696c 7572            failur
+0001c8b0: 655f 6d65 7373 6167 652c 0a20 2020 2020  e_message,.     
+0001c8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c8f0: 2020 2073 7464 6572 723d 7374 6465 7272     stderr=stderr
-0001c900: 290a 2020 2020 7265 7475 726e 2073 7464  ).    return std
-0001c910: 6f75 740a 0a0a 6465 6620 6368 6563 6b5f  out...def check_
-0001c920: 7273 796e 635f 696e 7374 616c 6c65 6428  rsync_installed(
-0001c930: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-0001c940: 2222 4368 6563 6b73 2069 6620 7273 796e  ""Checks if rsyn
-0001c950: 6320 6973 2069 6e73 7461 6c6c 6564 2e0a  c is installed..
-0001c960: 0a20 2020 2052 6169 7365 733a 0a20 2020  .    Raises:.   
-0001c970: 2020 2020 2052 756e 7469 6d65 4572 726f       RuntimeErro
-0001c980: 723a 2069 6620 7273 796e 6320 6973 206e  r: if rsync is n
-0001c990: 6f74 2069 6e73 7461 6c6c 6564 2069 6e20  ot installed in 
-0001c9a0: 7468 6520 6d61 6368 696e 652e 0a20 2020  the machine..   
-0001c9b0: 2022 2222 0a20 2020 2074 7279 3a0a 2020   """.    try:.  
-0001c9c0: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
-0001c9d0: 2e72 756e 2827 7273 796e 6320 2d2d 7665  .run('rsync --ve
-0001c9e0: 7273 696f 6e27 2c0a 2020 2020 2020 2020  rsion',.        
-0001c9f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001ca00: 6865 6c6c 3d54 7275 652c 0a20 2020 2020  hell=True,.     
-0001ca10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca20: 2020 6368 6563 6b3d 5472 7565 2c0a 2020    check=True,.  
-0001ca30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca40: 2020 2020 2073 7464 6f75 743d 7375 6270       stdout=subp
-0001ca50: 726f 6365 7373 2e50 4950 452c 0a20 2020  rocess.PIPE,.   
-0001ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca70: 2020 2020 7374 6465 7272 3d73 7562 7072      stderr=subpr
-0001ca80: 6f63 6573 732e 5049 5045 290a 2020 2020  ocess.PIPE).    
-0001ca90: 6578 6365 7074 2073 7562 7072 6f63 6573  except subproces
-0001caa0: 732e 4361 6c6c 6564 5072 6f63 6573 7345  s.CalledProcessE
-0001cab0: 7272 6f72 3a0a 2020 2020 2020 2020 7769  rror:.        wi
-0001cac0: 7468 2075 785f 7574 696c 732e 7072 696e  th ux_utils.prin
-0001cad0: 745f 6578 6365 7074 696f 6e5f 6e6f 5f74  t_exception_no_t
-0001cae0: 7261 6365 6261 636b 2829 3a0a 2020 2020  raceback():.    
-0001caf0: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-0001cb00: 6e74 696d 6545 7272 6f72 280a 2020 2020  ntimeError(.    
-0001cb10: 2020 2020 2020 2020 2020 2020 2760 7273              '`rs
-0001cb20: 796e 6360 2069 7320 7265 7175 6972 6564  ync` is required
-0001cb30: 2066 6f72 2070 726f 7669 7369 6f6e 696e   for provisionin
-0001cb40: 6720 616e 6427 0a20 2020 2020 2020 2020  g and'.         
-0001cb50: 2020 2020 2020 2027 2069 7420 6973 206e         ' it is n
-0001cb60: 6f74 2069 6e73 7461 6c6c 6564 2e20 466f  ot installed. Fo
-0001cb70: 7220 4465 6269 616e 2f55 6275 6e74 7520  r Debian/Ubuntu 
-0001cb80: 7379 7374 656d 2c20 270a 2020 2020 2020  system, '.      
-0001cb90: 2020 2020 2020 2020 2020 2769 6e73 7461            'insta
-0001cba0: 6c6c 2069 7420 7769 7468 3a5c 6e27 0a20  ll it with:\n'. 
-0001cbb0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0001cbc0: 2020 2420 7375 646f 2061 7074 2069 6e73    $ sudo apt ins
-0001cbd0: 7461 6c6c 2072 7379 6e63 2729 2066 726f  tall rsync') fro
-0001cbe0: 6d20 4e6f 6e65 0a0a 0a64 6566 2063 6865  m None...def che
-0001cbf0: 636b 5f73 7461 6c65 5f72 756e 7469 6d65  ck_stale_runtime
-0001cc00: 5f6f 6e5f 7265 6d6f 7465 2872 6574 7572  _on_remote(retur
-0001cc10: 6e63 6f64 653a 2069 6e74 2c20 7374 6465  ncode: int, stde
-0001cc20: 7272 3a20 7374 722c 0a20 2020 2020 2020  rr: str,.       
-0001cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc40: 2020 2020 2020 2020 2020 2063 6c75 7374             clust
-0001cc50: 6572 5f6e 616d 653a 2073 7472 2920 2d3e  er_name: str) ->
-0001cc60: 204e 6f6e 653a 0a20 2020 2022 2222 5261   None:.    """Ra
-0001cc70: 6973 6573 2052 756e 7469 6d65 4572 726f  ises RuntimeErro
-0001cc80: 7220 6966 2072 656d 6f74 6520 536b 7950  r if remote SkyP
-0001cc90: 696c 6f74 2072 756e 7469 6d65 206e 6565  ilot runtime nee
-0001cca0: 6473 2074 6f20 6265 2075 7064 6174 6564  ds to be updated
-0001ccb0: 2e0a 0a20 2020 2057 6520 6465 7465 6374  ...    We detect
-0001ccc0: 2074 6869 7320 6279 2070 6172 7369 6e67   this by parsing
-0001ccd0: 2063 6572 7461 696e 2062 6163 6b77 6172   certain backwar
-0001cce0: 642d 696e 636f 6d70 6174 6962 6c65 2065  d-incompatible e
-0001ccf0: 7272 6f72 206d 6573 7361 6765 7320 6672  rror messages fr
-0001cd00: 6f6d 0a20 2020 2060 7374 6465 7272 602e  om.    `stderr`.
-0001cd10: 2054 7970 6963 616c 6c79 2064 7565 2074   Typically due t
-0001cd20: 6f20 7468 6520 6c6f 6361 6c20 636c 6965  o the local clie
-0001cd30: 6e74 2076 6572 7369 6f6e 206a 7573 7420  nt version just 
-0001cd40: 676f 7420 7570 6461 7465 642c 2061 6e64  got updated, and
-0001cd50: 0a20 2020 2074 6865 2072 656d 6f74 6520  .    the remote 
-0001cd60: 7275 6e74 696d 6520 6973 2061 6e20 6f6c  runtime is an ol
-0001cd70: 6465 7220 7665 7273 696f 6e2e 0a20 2020  der version..   
-0001cd80: 2022 2222 0a20 2020 2070 6174 7465 726e   """.    pattern
-0001cd90: 203d 2072 652e 636f 6d70 696c 6528 7227   = re.compile(r'
-0001cda0: 4174 7472 6962 7574 6545 7272 6f72 3a20  AttributeError: 
-0001cdb0: 6d6f 6475 6c65 205c 2773 6b79 5c2e 282e  module \'sky\.(.
-0001cdc0: 2a29 5c27 2068 6173 206e 6f20 270a 2020  *)\' has no '.  
-0001cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cde0: 2020 2020 2020 2072 2761 7474 7269 6275         r'attribu
-0001cdf0: 7465 205c 2728 2e2a 295c 2727 290a 2020  te \'(.*)\'').  
-0001ce00: 2020 6966 2072 6574 7572 6e63 6f64 6520    if returncode 
-0001ce10: 213d 2030 3a0a 2020 2020 2020 2020 6174  != 0:.        at
-0001ce20: 7472 6962 7574 655f 6572 726f 7220 3d20  tribute_error = 
-0001ce30: 7265 2e66 696e 6461 6c6c 2870 6174 7465  re.findall(patte
-0001ce40: 726e 2c20 7374 6465 7272 290a 2020 2020  rn, stderr).    
-0001ce50: 2020 2020 6966 2061 7474 7269 6275 7465      if attribute
-0001ce60: 5f65 7272 6f72 3a0a 2020 2020 2020 2020  _error:.        
-0001ce70: 2020 2020 7769 7468 2075 785f 7574 696c      with ux_util
-0001ce80: 732e 7072 696e 745f 6578 6365 7074 696f  s.print_exceptio
-0001ce90: 6e5f 6e6f 5f74 7261 6365 6261 636b 2829  n_no_traceback()
-0001cea0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ceb0: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
-0001cec0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0001ced0: 2020 2020 2020 2020 2020 6627 7b63 6f6c            f'{col
-0001cee0: 6f72 616d 612e 466f 7265 2e52 4544 7d53  orama.Fore.RED}S
-0001cef0: 6b79 5069 6c6f 7420 7275 6e74 696d 6520  kyPilot runtime 
-0001cf00: 6e65 6564 7320 746f 2062 6520 7570 6461  needs to be upda
-0001cf10: 7465 6420 270a 2020 2020 2020 2020 2020  ted '.          
-0001cf20: 2020 2020 2020 2020 2020 276f 6e20 7468            'on th
-0001cf30: 6520 7265 6d6f 7465 2063 6c75 7374 6572  e remote cluster
-0001cf40: 2e20 546f 2075 7064 6174 652c 2072 756e  . To update, run
-0001cf50: 2028 6578 6973 7469 6e67 206a 6f62 7320   (existing jobs 
-0001cf60: 6172 6520 270a 2020 2020 2020 2020 2020  are '.          
-0001cf70: 2020 2020 2020 2020 2020 6627 6e6f 7420            f'not 
-0001cf80: 696e 7465 7272 7570 7465 6429 3a20 7b63  interrupted): {c
-0001cf90: 6f6c 6f72 616d 612e 5374 796c 652e 4252  olorama.Style.BR
-0001cfa0: 4947 4854 7d73 6b79 2073 7461 7274 202d  IGHT}sky start -
-0001cfb0: 6620 2d79 2027 0a20 2020 2020 2020 2020  f -y '.         
-0001cfc0: 2020 2020 2020 2020 2020 2066 277b 636c             f'{cl
-0001cfd0: 7573 7465 725f 6e61 6d65 7d7b 636f 6c6f  uster_name}{colo
-0001cfe0: 7261 6d61 2e53 7479 6c65 2e52 4553 4554  rama.Style.RESET
-0001cff0: 5f41 4c4c 7d27 0a20 2020 2020 2020 2020  _ALL}'.         
-0001d000: 2020 2020 2020 2020 2020 2066 275c 6e2d             f'\n-
-0001d010: 2d2d 2044 6574 6169 6c73 202d 2d2d 5c6e  -- Details ---\n
-0001d020: 7b73 7464 6572 722e 7374 7269 7028 297d  {stderr.strip()}
-0001d030: 5c6e 2729 0a                             \n').
+0001c8e0: 2020 7374 6465 7272 3d73 7464 6572 7229    stderr=stderr)
+0001c8f0: 0a20 2020 2072 6574 7572 6e20 7374 646f  .    return stdo
+0001c900: 7574 0a0a 0a64 6566 2063 6865 636b 5f72  ut...def check_r
+0001c910: 7379 6e63 5f69 6e73 7461 6c6c 6564 2829  sync_installed()
+0001c920: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+0001c930: 2243 6865 636b 7320 6966 2072 7379 6e63  "Checks if rsync
+0001c940: 2069 7320 696e 7374 616c 6c65 642e 0a0a   is installed...
+0001c950: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+0001c960: 2020 2020 5275 6e74 696d 6545 7272 6f72      RuntimeError
+0001c970: 3a20 6966 2072 7379 6e63 2069 7320 6e6f  : if rsync is no
+0001c980: 7420 696e 7374 616c 6c65 6420 696e 2074  t installed in t
+0001c990: 6865 206d 6163 6869 6e65 2e0a 2020 2020  he machine..    
+0001c9a0: 2222 220a 2020 2020 7472 793a 0a20 2020  """.    try:.   
+0001c9b0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0001c9c0: 7275 6e28 2772 7379 6e63 202d 2d76 6572  run('rsync --ver
+0001c9d0: 7369 6f6e 272c 0a20 2020 2020 2020 2020  sion',.         
+0001c9e0: 2020 2020 2020 2020 2020 2020 2020 7368                sh
+0001c9f0: 656c 6c3d 5472 7565 2c0a 2020 2020 2020  ell=True,.      
+0001ca00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca10: 2063 6865 636b 3d54 7275 652c 0a20 2020   check=True,.   
+0001ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca30: 2020 2020 7374 646f 7574 3d73 7562 7072      stdout=subpr
+0001ca40: 6f63 6573 732e 5049 5045 2c0a 2020 2020  ocess.PIPE,.    
+0001ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca60: 2020 2073 7464 6572 723d 7375 6270 726f     stderr=subpro
+0001ca70: 6365 7373 2e50 4950 4529 0a20 2020 2065  cess.PIPE).    e
+0001ca80: 7863 6570 7420 7375 6270 726f 6365 7373  xcept subprocess
+0001ca90: 2e43 616c 6c65 6450 726f 6365 7373 4572  .CalledProcessEr
+0001caa0: 726f 723a 0a20 2020 2020 2020 2077 6974  ror:.        wit
+0001cab0: 6820 7578 5f75 7469 6c73 2e70 7269 6e74  h ux_utils.print
+0001cac0: 5f65 7863 6570 7469 6f6e 5f6e 6f5f 7472  _exception_no_tr
+0001cad0: 6163 6562 6163 6b28 293a 0a20 2020 2020  aceback():.     
+0001cae0: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
+0001caf0: 7469 6d65 4572 726f 7228 0a20 2020 2020  timeError(.     
+0001cb00: 2020 2020 2020 2020 2020 2027 6072 7379             '`rsy
+0001cb10: 6e63 6020 6973 2072 6571 7569 7265 6420  nc` is required 
+0001cb20: 666f 7220 7072 6f76 6973 696f 6e69 6e67  for provisioning
+0001cb30: 2061 6e64 270a 2020 2020 2020 2020 2020   and'.          
+0001cb40: 2020 2020 2020 2720 6974 2069 7320 6e6f        ' it is no
+0001cb50: 7420 696e 7374 616c 6c65 642e 2046 6f72  t installed. For
+0001cb60: 2044 6562 6961 6e2f 5562 756e 7475 2073   Debian/Ubuntu s
+0001cb70: 7973 7465 6d2c 2027 0a20 2020 2020 2020  ystem, '.       
+0001cb80: 2020 2020 2020 2020 2027 696e 7374 616c           'instal
+0001cb90: 6c20 6974 2077 6974 683a 5c6e 270a 2020  l it with:\n'.  
+0001cba0: 2020 2020 2020 2020 2020 2020 2020 2720                ' 
+0001cbb0: 2024 2073 7564 6f20 6170 7420 696e 7374   $ sudo apt inst
+0001cbc0: 616c 6c20 7273 796e 6327 2920 6672 6f6d  all rsync') from
+0001cbd0: 204e 6f6e 650a 0a0a 6465 6620 6368 6563   None...def chec
+0001cbe0: 6b5f 7374 616c 655f 7275 6e74 696d 655f  k_stale_runtime_
+0001cbf0: 6f6e 5f72 656d 6f74 6528 7265 7475 726e  on_remote(return
+0001cc00: 636f 6465 3a20 696e 742c 2073 7464 6572  code: int, stder
+0001cc10: 723a 2073 7472 2c0a 2020 2020 2020 2020  r: str,.        
+0001cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc30: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
+0001cc40: 725f 6e61 6d65 3a20 7374 7229 202d 3e20  r_name: str) -> 
+0001cc50: 4e6f 6e65 3a0a 2020 2020 2222 2252 6169  None:.    """Rai
+0001cc60: 7365 7320 5275 6e74 696d 6545 7272 6f72  ses RuntimeError
+0001cc70: 2069 6620 7265 6d6f 7465 2053 6b79 5069   if remote SkyPi
+0001cc80: 6c6f 7420 7275 6e74 696d 6520 6e65 6564  lot runtime need
+0001cc90: 7320 746f 2062 6520 7570 6461 7465 642e  s to be updated.
+0001cca0: 0a0a 2020 2020 5765 2064 6574 6563 7420  ..    We detect 
+0001ccb0: 7468 6973 2062 7920 7061 7273 696e 6720  this by parsing 
+0001ccc0: 6365 7274 6169 6e20 6261 636b 7761 7264  certain backward
+0001ccd0: 2d69 6e63 6f6d 7061 7469 626c 6520 6572  -incompatible er
+0001cce0: 726f 7220 6d65 7373 6167 6573 2066 726f  ror messages fro
+0001ccf0: 6d0a 2020 2020 6073 7464 6572 7260 2e20  m.    `stderr`. 
+0001cd00: 5479 7069 6361 6c6c 7920 6475 6520 746f  Typically due to
+0001cd10: 2074 6865 206c 6f63 616c 2063 6c69 656e   the local clien
+0001cd20: 7420 7665 7273 696f 6e20 6a75 7374 2067  t version just g
+0001cd30: 6f74 2075 7064 6174 6564 2c20 616e 640a  ot updated, and.
+0001cd40: 2020 2020 7468 6520 7265 6d6f 7465 2072      the remote r
+0001cd50: 756e 7469 6d65 2069 7320 616e 206f 6c64  untime is an old
+0001cd60: 6572 2076 6572 7369 6f6e 2e0a 2020 2020  er version..    
+0001cd70: 2222 220a 2020 2020 7061 7474 6572 6e20  """.    pattern 
+0001cd80: 3d20 7265 2e63 6f6d 7069 6c65 2872 2741  = re.compile(r'A
+0001cd90: 7474 7269 6275 7465 4572 726f 723a 206d  ttributeError: m
+0001cda0: 6f64 756c 6520 5c27 736b 795c 2e28 2e2a  odule \'sky\.(.*
+0001cdb0: 295c 2720 6861 7320 6e6f 2027 0a20 2020  )\' has no '.   
+0001cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cdd0: 2020 2020 2020 7227 6174 7472 6962 7574        r'attribut
+0001cde0: 6520 5c27 282e 2a29 5c27 2729 0a20 2020  e \'(.*)\'').   
+0001cdf0: 2069 6620 7265 7475 726e 636f 6465 2021   if returncode !
+0001ce00: 3d20 303a 0a20 2020 2020 2020 2061 7474  = 0:.        att
+0001ce10: 7269 6275 7465 5f65 7272 6f72 203d 2072  ribute_error = r
+0001ce20: 652e 6669 6e64 616c 6c28 7061 7474 6572  e.findall(patter
+0001ce30: 6e2c 2073 7464 6572 7229 0a20 2020 2020  n, stderr).     
+0001ce40: 2020 2069 6620 6174 7472 6962 7574 655f     if attribute_
+0001ce50: 6572 726f 723a 0a20 2020 2020 2020 2020  error:.         
+0001ce60: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
+0001ce70: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
+0001ce80: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
+0001ce90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cea0: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+0001ceb0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+0001cec0: 2020 2020 2020 2020 2066 277b 636f 6c6f           f'{colo
+0001ced0: 7261 6d61 2e46 6f72 652e 5245 447d 536b  rama.Fore.RED}Sk
+0001cee0: 7950 696c 6f74 2072 756e 7469 6d65 206e  yPilot runtime n
+0001cef0: 6565 6473 2074 6f20 6265 2075 7064 6174  eeds to be updat
+0001cf00: 6564 2027 0a20 2020 2020 2020 2020 2020  ed '.           
+0001cf10: 2020 2020 2020 2020 2027 6f6e 2074 6865           'on the
+0001cf20: 2072 656d 6f74 6520 636c 7573 7465 722e   remote cluster.
+0001cf30: 2054 6f20 7570 6461 7465 2c20 7275 6e20   To update, run 
+0001cf40: 2865 7869 7374 696e 6720 6a6f 6273 2061  (existing jobs a
+0001cf50: 7265 2027 0a20 2020 2020 2020 2020 2020  re '.           
+0001cf60: 2020 2020 2020 2020 2066 276e 6f74 2069           f'not i
+0001cf70: 6e74 6572 7275 7074 6564 293a 207b 636f  nterrupted): {co
+0001cf80: 6c6f 7261 6d61 2e53 7479 6c65 2e42 5249  lorama.Style.BRI
+0001cf90: 4748 547d 736b 7920 7374 6172 7420 2d66  GHT}sky start -f
+0001cfa0: 202d 7920 270a 2020 2020 2020 2020 2020   -y '.          
+0001cfb0: 2020 2020 2020 2020 2020 6627 7b63 6c75            f'{clu
+0001cfc0: 7374 6572 5f6e 616d 657d 7b63 6f6c 6f72  ster_name}{color
+0001cfd0: 616d 612e 5374 796c 652e 5245 5345 545f  ama.Style.RESET_
+0001cfe0: 414c 4c7d 270a 2020 2020 2020 2020 2020  ALL}'.          
+0001cff0: 2020 2020 2020 2020 2020 6627 5c6e 2d2d            f'\n--
+0001d000: 2d20 4465 7461 696c 7320 2d2d 2d5c 6e7b  - Details ---\n{
+0001d010: 7374 6465 7272 2e73 7472 6970 2829 7d5c  stderr.strip()}\
+0001d020: 6e27 290a                                n').
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/backends/cloud_vm_ray_backend.py` & `skypilot-nightly-1.0.0.dev20240403/sky/backends/cloud_vm_ray_backend.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Backend: runs on cloud virtual machines, managed by Ray."""
+import base64
 import copy
 import enum
 import getpass
 import inspect
 import json
 import math
 import os
@@ -33,14 +34,15 @@
 from sky import serve as serve_lib
 from sky import sky_logging
 from sky import spot as spot_lib
 from sky import status_lib
 from sky import task as task_lib
 from sky.backends import backend_utils
 from sky.backends import wheel_utils
+from sky.clouds import service_catalog
 from sky.clouds.utils import gcp_utils
 from sky.data import data_utils
 from sky.data import storage as storage_lib
 from sky.provision import common as provision_common
 from sky.provision import instance_setup
 from sky.provision import metadata_utils
 from sky.provision import provisioner
@@ -746,15 +748,15 @@
         logger.warning(f'{style.DIM}\t{messages}{style.RESET_ALL}')
         _add_to_blocked_resources(blocked_resources,
                                   launchable_resources.copy(zone=None))
 
         # Sometimes, LambdaCloudError will list available regions.
         for e in errors:
             if e.find('Regions with capacity available:') != -1:
-                for r in clouds.Lambda.regions():
+                for r in service_catalog.regions('lambda'):
                     if e.find(r.name) == -1:
                         _add_to_blocked_resources(
                             blocked_resources,
                             launchable_resources.copy(region=r.name, zone=None))
 
     @staticmethod
     def _kubernetes_handler(blocked_resources: Set['resources_lib.Resources'],
@@ -818,15 +820,15 @@
         logger.warning(f'{style.DIM}\t{messages}{style.RESET_ALL}')
         _add_to_blocked_resources(blocked_resources,
                                   launchable_resources.copy(zone=None))
 
         # Sometimes, SCPError will list available regions.
         for e in errors:
             if e.find('Regions with capacity available:') != -1:
-                for r in clouds.SCP.regions():
+                for r in service_catalog.regions('scp'):
                     if e.find(r.name) == -1:
                         _add_to_blocked_resources(
                             blocked_resources,
                             launchable_resources.copy(region=r.name, zone=None))
 
     @staticmethod
     def _ibm_handler(blocked_resources: Set['resources_lib.Resources'],
@@ -1071,15 +1073,16 @@
             elif code == 'VPC_NOT_FOUND':
                 # User has specified a VPC that does not exist. On GCP, VPC is
                 # global. So we skip the entire cloud.
                 _add_to_blocked_resources(
                     blocked_resources,
                     launchable_resources.copy(region=None, zone=None))
             elif code == 'SUBNET_NOT_FOUND_FOR_VPC':
-                if (any(acc.lower().startswith('tpu-v4')
+                if (launchable_resources.accelerators is not None and any(
+                        acc.lower().startswith('tpu-v4')
                         for acc in launchable_resources.accelerators.keys()) and
                         region.name == 'us-central2'):
                     # us-central2 is a TPU v4 only region. The subnet for
                     # this region may not exist when the user does not have
                     # the TPU v4 quota. We should skip this region.
                     logger.warning('Please check if you have TPU v4 quotas '
                                    f'in {region.name}.')
@@ -3098,49 +3101,38 @@
         job_id: int,
         detach_run: bool = False,
         spot_dag: Optional['dag.Dag'] = None,
     ) -> None:
         """Executes generated code on the head node."""
         style = colorama.Style
         fore = colorama.Fore
-        ssh_credentials = backend_utils.ssh_credential_from_yaml(
-            handle.cluster_yaml, handle.docker_user, handle.ssh_user)
-        head_ssh_port = handle.head_ssh_port
-        runner = command_runner.SSHCommandRunner(handle.head_ip,
-                                                 port=head_ssh_port,
-                                                 **ssh_credentials)
-        with tempfile.NamedTemporaryFile('w', prefix='sky_app_') as fp:
-            fp.write(codegen)
-            fp.flush()
-            script_path = os.path.join(SKY_REMOTE_APP_DIR, f'sky_job_{job_id}')
-            # We choose to sync code + exec, because the alternative of 'ray
-            # submit' may not work as it may use system python (python2) to
-            # execute the script.  Happens for AWS.
-            runner.rsync(source=fp.name,
-                         target=script_path,
-                         up=True,
-                         stream_logs=False)
+
+        script_path = os.path.join(SKY_REMOTE_APP_DIR, f'sky_job_{job_id}')
         remote_log_dir = self.log_dir
         remote_log_path = os.path.join(remote_log_dir, 'run.log')
 
         cd = f'cd {SKY_REMOTE_WORKDIR}'
 
+        mkdir_code = (f'{cd} && mkdir -p {remote_log_dir} && '
+                      f'touch {remote_log_path}')
+        encoded_script = base64.b64encode(
+            codegen.encode('utf-8')).decode('utf-8')
+        create_script_code = (f'{{ echo "{encoded_script}" | base64 --decode > '
+                              f'{script_path}; }}')
         job_submit_cmd = (
             f'RAY_DASHBOARD_PORT=$({constants.SKY_PYTHON_CMD} -c "from sky.skylet import job_lib; print(job_lib.get_job_submission_port())" 2> /dev/null || echo 8265);'  # pylint: disable=line-too-long
             f'{cd} && {constants.SKY_RAY_CMD} job submit '
             '--address=http://127.0.0.1:$RAY_DASHBOARD_PORT '
             f'--submission-id {job_id}-$(whoami) --no-wait '
             # Redirect stderr to /dev/null to avoid distracting error from ray.
             f'"{constants.SKY_PYTHON_CMD} -u {script_path} > {remote_log_path} 2> /dev/null"'
         )
 
-        mkdir_code = (f'{cd} && mkdir -p {remote_log_dir} && '
-                      f'touch {remote_log_path}')
         code = job_lib.JobLibCodeGen.queue_job(job_id, job_submit_cmd)
-        job_submit_cmd = mkdir_code + ' && ' + code
+        job_submit_cmd = ' && '.join([mkdir_code, create_script_code, code])
 
         if spot_dag is not None:
             # Add the spot job to spot queue table.
             spot_codegen = spot_lib.SpotCodeGen()
             spot_code = spot_codegen.set_pending(job_id, spot_dag)
             # Set the spot job to PENDING state to make sure that this spot
             # job appears in the `sky spot queue`, when there are already 16
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/backends/docker_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/backends/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/backends/local_docker_backend.py` & `skypilot-nightly-1.0.0.dev20240403/sky/backends/local_docker_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/backends/monkey_patches/monkey_patch_ray_up.py` & `skypilot-nightly-1.0.0.dev20240403/sky/backends/monkey_patches/monkey_patch_ray_up.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/backends/wheel_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/backends/wheel_utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -103,22 +103,22 @@
                 'pip3', 'wheel', '--no-deps', norm_path, '--wheel-dir',
                 str(tmp_dir)
             ],
                            stdout=subprocess.DEVNULL,
                            stderr=subprocess.PIPE,
                            check=True)
         except subprocess.CalledProcessError as e:
-            raise RuntimeError('Fail to build pip wheel for SkyPilot. '
+            raise RuntimeError('Failed to build pip wheel for SkyPilot. '
                                f'Error message: {e.stderr.decode()}') from e
 
         try:
             wheel_path = next(tmp_dir.glob(_WHEEL_PATTERN))
         except StopIteration:
             raise RuntimeError(
-                f'Fail to find pip wheel for SkyPilot under {tmp_dir} with '
+                f'Failed to find pip wheel for SkyPilot under {tmp_dir} with '
                 f'glob pattern {_WHEEL_PATTERN!r}. '
                 f'Found: {list(map(str, tmp_dir.glob("*")))}.'
                 'No wheel file is generated.') from None
 
         # Use a unique temporary dir per wheel hash, because there may be many
         # concurrent 'sky launch' happening.  The path should be stable if the
         # wheel content hash doesn't change.
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/benchmark/benchmark_state.py` & `skypilot-nightly-1.0.0.dev20240403/sky/benchmark/benchmark_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/benchmark/benchmark_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/benchmark/benchmark_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/check.py` & `skypilot-nightly-1.0.0.dev20240403/sky/check.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/cli.py` & `skypilot-nightly-1.0.0.dev20240403/sky/cli.py`

 * *Files 0% similar despite different names*

```diff
@@ -52,14 +52,15 @@
 from sky import exceptions
 from sky import global_user_state
 from sky import provision as provision_lib
 from sky import serve as serve_lib
 from sky import sky_logging
 from sky import spot as spot_lib
 from sky import status_lib
+from sky.adaptors import common as adaptors_common
 from sky.backends import backend_utils
 from sky.benchmark import benchmark_state
 from sky.benchmark import benchmark_utils
 from sky.clouds import service_catalog
 from sky.data import storage_utils
 from sky.provision.kubernetes import utils as kubernetes_utils
 from sky.skylet import constants
@@ -76,14 +77,15 @@
 from sky.utils import timeline
 from sky.utils import ux_utils
 from sky.utils.cli_utils import status_utils
 
 if typing.TYPE_CHECKING:
     from sky.backends import backend as backend_lib
 
+pd = adaptors_common.LazyImport('pandas')
 logger = sky_logging.init_logger(__name__)
 
 _CONTEXT_SETTINGS = dict(help_option_names=['-h', '--help'])
 
 _CLUSTER_FLAG_HELP = """\
 A cluster name. If provided, either reuse an existing cluster with that name or
 provision a new cluster with that name. Otherwise provision a new cluster with
@@ -2990,15 +2992,14 @@
             quantity_str = (f' with requested quantity {quantity}'
                             if quantity else '')
             yield f'Resources \'{name}\'{quantity_str} not found. '
             yield 'Try \'sky show-gpus --all\' '
             yield 'to show available accelerators.'
             return
 
-        import pandas as pd  # pylint: disable=import-outside-toplevel
         for i, (gpu, items) in enumerate(result.items()):
             accelerator_table_headers = [
                 'GPU',
                 'QTY',
                 'CLOUD',
                 'INSTANCE_TYPE',
                 'DEVICE_MEM',
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/cloud_stores.py` & `skypilot-nightly-1.0.0.dev20240403/sky/cloud_stores.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/aws.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/azure.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/cloud.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/cloud.py`

 * *Files 0% similar despite different names*

```diff
@@ -38,14 +38,15 @@
     CLONE_DISK_FROM_CLUSTER = 'clone_disk_from_cluster'
     IMAGE_ID = 'image_id'
     DOCKER_IMAGE = 'docker_image'
     SPOT_INSTANCE = 'spot_instance'
     CUSTOM_DISK_TIER = 'custom_disk_tier'
     OPEN_PORTS = 'open_ports'
     STORAGE_MOUNTING = 'storage_mounting'
+    HOST_CONTROLLERS = 'host_controllers'  # Can run spot/serve controllers
 
 
 class Region(collections.namedtuple('Region', ['name'])):
     """A region."""
     name: str
     zones: Optional[List['Zone']] = None
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/cloud_registry.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/cloud_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/cudo.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/fluidstack.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/gcp.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/ibm.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/kubernetes.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/kubernetes.py`

 * *Files 3% similar despite different names*

```diff
@@ -60,37 +60,34 @@
         clouds.CloudImplementationFeatures.SPOT_INSTANCE: 'Spot instances are '
                                                           'not supported in '
                                                           'Kubernetes.',
         clouds.CloudImplementationFeatures.CUSTOM_DISK_TIER: 'Custom disk '
                                                              'tiers are not '
                                                              'supported in '
                                                              'Kubernetes.',
+        # Kubernetes may be using exec-based auth, which may not work by
+        # directly copying the kubeconfig file to the controller.
+        # Support for service accounts for auth will be added in #3377, which
+        # will allow us to support hosting controllers.
+        clouds.CloudImplementationFeatures.HOST_CONTROLLERS: 'Kubernetes can '
+                                                             'not host '
+                                                             'controllers.',
     }
 
     IMAGE_CPU = 'skypilot:cpu-ubuntu-2004'
     IMAGE_GPU = 'skypilot:gpu-ubuntu-2004'
 
     PROVISIONER_VERSION = clouds.ProvisionerVersion.SKYPILOT
     STATUS_VERSION = clouds.StatusVersion.SKYPILOT
 
     @classmethod
     def _unsupported_features_for_resources(
         cls, resources: 'resources_lib.Resources'
     ) -> Dict[clouds.CloudImplementationFeatures, str]:
         unsupported_features = cls._CLOUD_UNSUPPORTED_FEATURES
-        curr_context = kubernetes_utils.get_current_kube_config_context_name()
-        if curr_context == kubernetes_utils.KIND_CONTEXT_NAME:
-            # If we are using KIND, the loadbalancer service will never be
-            # assigned an external IP. Users may use ingress, but that requires
-            # blocking HTTP port 80.
-            # For now, we disable port opening feature on kind clusters.
-            unsupported_features[
-                clouds.CloudImplementationFeatures.OPEN_PORTS] = (
-                    'Opening ports is not supported in Kubernetes when '
-                    'using local kind cluster.')
         return unsupported_features
 
     @classmethod
     def regions(cls) -> List[clouds.Region]:
         return cls._regions
 
     @classmethod
@@ -374,15 +371,15 @@
         if zone is not None:
             raise ValueError('Kubernetes support does not support setting zone.'
                              ' Cluster used is determined by the kubeconfig.')
         return region, zone
 
     @classmethod
     def get_current_user_identity(cls) -> Optional[List[str]]:
-        k8s = kubernetes.get_kubernetes()
+        k8s = kubernetes.kubernetes
         try:
             _, current_context = k8s.config.list_kube_config_contexts()
             if 'namespace' in current_context['context']:
                 namespace = current_context['context']['namespace']
             else:
                 namespace = kubernetes_utils.DEFAULT_NAMESPACE
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/lambda_cloud.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/lambda_cloud.py`

 * *Files 0% similar despite different names*

```diff
@@ -276,14 +276,15 @@
     def query_status(cls, name: str, tag_filters: Dict[str, str],
                      region: Optional[str], zone: Optional[str],
                      **kwargs) -> List[status_lib.ClusterStatus]:
         status_map = {
             'booting': status_lib.ClusterStatus.INIT,
             'active': status_lib.ClusterStatus.UP,
             'unhealthy': status_lib.ClusterStatus.INIT,
+            'terminating': None,
             'terminated': None,
         }
         # TODO(ewzeng): filter by hash_filter_string to be safe
         status_list = []
         vms = lambda_utils.LambdaCloudClient().list_instances()
         possible_names = [f'{name}-head', f'{name}-worker']
         for node in vms:
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/oci.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/oci.py`

 * *Files 1% similar despite different names*

```diff
@@ -265,16 +265,16 @@
                 ad_list = identity_client.list_availability_domains(
                     compartment_id=oci_adaptor.get_oci_config(
                         profile=oci_utils.oci_config.get_profile())
                     ['tenancy']).data
 
                 first_ad = ad_list[0]
                 _tenancy_prefix = str(first_ad.name).split(':', maxsplit=1)[0]
-            except (oci_adaptor.get_oci().exceptions.ConfigFileNotFound,
-                    oci_adaptor.get_oci().exceptions.InvalidConfig) as e:
+            except (oci_adaptor.oci.exceptions.ConfigFileNotFound,
+                    oci_adaptor.oci.exceptions.InvalidConfig) as e:
                 # This should only happen in testing where oci config is
                 # monkeypatched. In real use, if the OCI config is not
                 # valid, the 'sky check' would fail (OCI disabled).
                 logger.debug(f'It is OK goes here when testing: {str(e)}')
                 pass
 
         # Disk performane: Volume Performance Units.
@@ -399,16 +399,16 @@
                 region=None,
                 profile=oci_utils.oci_config.get_profile()).get_user(
                     oci_adaptor.get_oci_config(profile=oci_utils.oci_config.
                                                get_profile())['user']).data
             del user
             # TODO[Hysun]: More privilege check can be added
             return True, None
-        except (oci_adaptor.get_oci().exceptions.ConfigFileNotFound,
-                oci_adaptor.get_oci().exceptions.InvalidConfig,
+        except (oci_adaptor.oci.exceptions.ConfigFileNotFound,
+                oci_adaptor.oci.exceptions.InvalidConfig,
                 oci_adaptor.service_exception()) as e:
             return False, (
                 f'OCI credential is not correctly set. '
                 f'Check the credential file at {conf_file}\n'
                 f'{cls._INDENT_PREFIX}{credential_help_str}\n'
                 f'{cls._INDENT_PREFIX}Error details: '
                 f'{common_utils.format_exception(e, use_bracket=True)}')
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/paperspace.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/paperspace.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/runpod.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/runpod.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/scp.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/scp.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/aws_catalog.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/aws_catalog.py`

 * *Files 2% similar despite different names*

```diff
@@ -7,27 +7,31 @@
 import hashlib
 import os
 import threading
 import typing
 from typing import Dict, List, Optional, Tuple
 
 import colorama
-import pandas as pd
 
 from sky import exceptions
 from sky import sky_logging
+from sky.adaptors import common as adaptors_common
 from sky.clouds import aws
 from sky.clouds.service_catalog import common
 from sky.clouds.service_catalog import config
 from sky.clouds.service_catalog.data_fetchers import fetch_aws
 from sky.utils import common_utils
 from sky.utils import resources_utils
 
 if typing.TYPE_CHECKING:
+    import pandas as pd
+
     from sky.clouds import cloud
+else:
+    pd = adaptors_common.LazyImport('pandas')
 
 logger = sky_logging.init_logger(__name__)
 
 # We will select from the following three instance families:
 _DEFAULT_INSTANCE_FAMILY = [
     # This is the latest general-purpose instance family as of Mar 2023.
     # CPU: Intel Ice Lake 8375C.
@@ -66,15 +70,15 @@
 _image_df = common.read_catalog('aws/images.csv',
                                 pull_frequency_hours=_PULL_FREQUENCY_HOURS)
 
 _quotas_df = common.read_catalog('aws/instance_quota_mapping.csv',
                                  pull_frequency_hours=_PULL_FREQUENCY_HOURS)
 
 
-def _get_az_mappings(aws_user_hash: str) -> Optional[pd.DataFrame]:
+def _get_az_mappings(aws_user_hash: str) -> Optional['pd.DataFrame']:
     filename = f'aws/az_mappings-{aws_user_hash}.csv'
     az_mapping_path = common.get_catalog_path(filename)
     az_mapping_md5_path = common.get_catalog_path(f'.meta/{filename}.md5')
     if not os.path.exists(az_mapping_path):
         az_mappings = None
         if aws_user_hash != 'default':
             # Fetch az mapping from AWS.
@@ -93,15 +97,15 @@
         with open(az_mapping_md5_path, 'w', encoding='utf-8') as f:
             f.write(az_mapping_hash)
     else:
         az_mappings = pd.read_csv(az_mapping_path)
     return az_mappings
 
 
-def _fetch_and_apply_az_mapping(df: pd.DataFrame) -> pd.DataFrame:
+def _fetch_and_apply_az_mapping(df: common.LazyDataFrame) -> 'pd.DataFrame':
     """Maps zone IDs (use1-az1) to zone names (us-east-1x).
 
     The upper-level functions that use the availability zone information
     should be able to handle the case where the zone name is not correct,
     due to the credentials not being configured.
 
     Such mappings are account-specific and determined by AWS. We fetch the
@@ -154,15 +158,15 @@
     # there will be rows with NaN in the AvailabilityZone column.
     df = df.merge(az_mappings, on=['AvailabilityZone'], how='inner')
     df = df.drop(columns=['AvailabilityZone']).rename(
         columns={'AvailabilityZoneName': 'AvailabilityZone'})
     return df
 
 
-def _get_df() -> pd.DataFrame:
+def _get_df() -> 'pd.DataFrame':
     global _user_df
     with _apply_az_mapping_lock:
         if _user_df is None:
             try:
                 _user_df = _fetch_and_apply_az_mapping(_default_df)
             except (RuntimeError, ImportError) as e:
                 if config.get_use_default_catalog_if_failed():
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/azure_catalog.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/azure_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/common.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/common.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,26 +1,32 @@
 """Common utilities for service catalog."""
 import ast
 import difflib
 import hashlib
 import os
 import time
+import typing
 from typing import Dict, List, NamedTuple, Optional, Tuple
 
 import filelock
-import pandas as pd
 import requests
 
 from sky import sky_logging
+from sky.adaptors import common as adaptors_common
 from sky.clouds import cloud as cloud_lib
 from sky.clouds import cloud_registry
 from sky.clouds.service_catalog import constants
 from sky.utils import rich_utils
 from sky.utils import ux_utils
 
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 logger = sky_logging.init_logger(__name__)
 
 _ABSOLUTE_VERSIONED_CATALOG_DIR = os.path.join(
     os.path.expanduser(constants.CATALOG_DIR), constants.CATALOG_SCHEMA_VERSION)
 os.makedirs(_ABSOLUTE_VERSIONED_CATALOG_DIR, exist_ok=True)
 
 
@@ -107,16 +113,51 @@
         remote_path = os.path.join(constants.CATALOG_DIR,
                                    constants.CATALOG_SCHEMA_VERSION, catalog)
         local_path = os.path.expanduser(remote_path)
         modified_catalog_path_map[remote_path] = local_path
     return modified_catalog_path_map
 
 
+class LazyDataFrame:
+    """A lazy data frame that reads the catalog on demand.
+
+    We don't need to load the catalog for every SkyPilot call, and this class
+    allows us to load the catalog only when needed.
+    """
+
+    def __init__(self, filename: str):
+        self._filename = filename
+        self._df: Optional['pd.DataFrame'] = None
+
+    def _load_df(self) -> 'pd.DataFrame':
+        if self._df is None:
+            try:
+                self._df = pd.read_csv(self._filename)
+            except Exception as e:  # pylint: disable=broad-except
+                # As users can manually modify the catalog, read_csv can fail.
+                logger.error(f'Failed to read {self._filename}. '
+                             'To fix: delete the csv file and try again.')
+                with ux_utils.print_exception_no_traceback():
+                    raise e
+        return self._df
+
+    def __getattr__(self, name: str):
+        return getattr(self._load_df(), name)
+
+    def __getitem__(self, key):
+        # Delegate the indexing operation to the underlying DataFrame
+        return self._load_df()[key]
+
+    def __setitem__(self, key, value):
+        # Delegate the set operation to the underlying DataFrame
+        self._load_df()[key] = value
+
+
 def read_catalog(filename: str,
-                 pull_frequency_hours: Optional[int] = None) -> pd.DataFrame:
+                 pull_frequency_hours: Optional[int] = None) -> LazyDataFrame:
     """Reads the catalog from a local CSV file.
 
     If the file does not exist, download the up-to-date catalog that matches
     the schema version.
     If `pull_frequency_hours` is not None: pull the latest catalog with
     possibly updated prices, if the local catalog file is older than
     `pull_frequency_hours` and no changes to the local catalog file are
@@ -178,47 +219,39 @@
                     # Download successful, save the catalog to a local file.
                     os.makedirs(os.path.dirname(catalog_path), exist_ok=True)
                     with open(catalog_path, 'w', encoding='utf-8') as f:
                         f.write(r.text)
                     with open(meta_path + '.md5', 'w', encoding='utf-8') as f:
                         f.write(hashlib.md5(r.text.encode()).hexdigest())
 
-    try:
-        df = pd.read_csv(catalog_path)
-    except Exception as e:  # pylint: disable=broad-except
-        # As users can manually modify the catalog, read_csv can fail.
-        logger.error(f'Failed to read {catalog_path}. '
-                     'To fix: delete the csv file and try again.')
-        with ux_utils.print_exception_no_traceback():
-            raise e
-    return df
+    return LazyDataFrame(catalog_path)
 
 
 def _get_instance_type(
-    df: pd.DataFrame,
+    df: 'pd.DataFrame',
     instance_type: str,
     region: Optional[str],
     zone: Optional[str] = None,
-) -> pd.DataFrame:
+) -> 'pd.DataFrame':
     idx = df['InstanceType'] == instance_type
     if region is not None:
         idx &= df['Region'].str.lower() == region.lower()
     if zone is not None:
         # NOTE: For Azure instances, zone must be None.
         idx &= df['AvailabilityZone'] == zone
     return df[idx]
 
 
-def instance_type_exists_impl(df: pd.DataFrame, instance_type: str) -> bool:
+def instance_type_exists_impl(df: 'pd.DataFrame', instance_type: str) -> bool:
     """Returns True if the instance type is valid."""
     return instance_type in df['InstanceType'].unique()
 
 
 def validate_region_zone_impl(
-        cloud_name: str, df: pd.DataFrame, region: Optional[str],
+        cloud_name: str, df: 'pd.DataFrame', region: Optional[str],
         zone: Optional[str]) -> Tuple[Optional[str], Optional[str]]:
     """Validates whether region and zone exist in the catalog.
 
     Returns:
         A tuple of region and zone, if validated.
 
     Raises:
@@ -280,15 +313,15 @@
         region_df = filter_df['Region'].unique()
         assert len(region_df) == 1, 'Zone should be unique across regions.'
         validated_region = region_df[0]
     return validated_region, validated_zone
 
 
 def get_hourly_cost_impl(
-    df: pd.DataFrame,
+    df: 'pd.DataFrame',
     instance_type: str,
     use_spot: bool,
     region: Optional[str],
     zone: Optional[str],
 ) -> float:
     """Returns the hourly price of a VM instance in the given region and zone.
 
@@ -325,15 +358,15 @@
 def _get_value(value):
     if pd.isna(value):
         return None
     return float(value)
 
 
 def get_vcpus_mem_from_instance_type_impl(
-    df: pd.DataFrame,
+    df: 'pd.DataFrame',
     instance_type: str,
 ) -> Tuple[Optional[float], Optional[float]]:
     df = _get_instance_type(df, instance_type, None)
     if len(df) == 0:
         with ux_utils.print_exception_no_traceback():
             raise ValueError(f'No instance type {instance_type} found.')
     assert len(set(df['vCPUs'])) == 1, ('Cannot determine the number of vCPUs '
@@ -346,15 +379,16 @@
 
     vcpus = df['vCPUs'].iloc[0]
     mem = df['MemoryGiB'].iloc[0]
 
     return _get_value(vcpus), _get_value(mem)
 
 
-def _filter_with_cpus(df: pd.DataFrame, cpus: Optional[str]) -> pd.DataFrame:
+def _filter_with_cpus(df: 'pd.DataFrame',
+                      cpus: Optional[str]) -> 'pd.DataFrame':
     if cpus is None:
         return df
 
     # The following code is redundant with the code in resources.py::_set_cpus()
     # but we add it here for safety.
     if cpus.endswith('+'):
         num_cpus_str = cpus[:-1]
@@ -369,16 +403,16 @@
 
     if cpus.endswith('+'):
         return df[df['vCPUs'] >= num_cpus]
     else:
         return df[df['vCPUs'] == num_cpus]
 
 
-def _filter_with_mem(df: pd.DataFrame,
-                     memory_gb_or_ratio: Optional[str]) -> pd.DataFrame:
+def _filter_with_mem(df: 'pd.DataFrame',
+                     memory_gb_or_ratio: Optional[str]) -> 'pd.DataFrame':
     if memory_gb_or_ratio is None:
         return df
 
     # The following code is partially redundant with the code in
     # resources.py::_set_memory() but we add it here for safety.
     if memory_gb_or_ratio.endswith(('+', 'x')):
         memory_gb_str = memory_gb_or_ratio[:-1]
@@ -395,25 +429,25 @@
         return df[df['MemoryGiB'] >= memory]
     elif memory_gb_or_ratio.endswith('x'):
         return df[df['MemoryGiB'] >= df['vCPUs'] * memory]
     else:
         return df[df['MemoryGiB'] == memory]
 
 
-def _filter_region_zone(df: pd.DataFrame, region: Optional[str],
-                        zone: Optional[str]) -> pd.DataFrame:
+def _filter_region_zone(df: 'pd.DataFrame', region: Optional[str],
+                        zone: Optional[str]) -> 'pd.DataFrame':
     if region is not None:
         df = df[df['Region'].str.lower() == region.lower()]
     if zone is not None:
         df = df[df['AvailabilityZone'].str.lower() == zone.lower()]
     return df
 
 
 def get_instance_type_for_cpus_mem_impl(
-        df: pd.DataFrame, cpus: Optional[str],
+        df: 'pd.DataFrame', cpus: Optional[str],
         memory_gb_or_ratio: Optional[str]) -> Optional[str]:
     """Returns the cheapest instance type that satisfies the requirements.
 
     Args:
         df: The catalog cloud catalog data frame.
         cpus: The number of vCPUs. Can be a number or a string "<number>+". If
             the string ends with "+", then the returned instance type should
@@ -430,30 +464,30 @@
         return None
     # Sort by the price.
     df = df.sort_values(by=['Price'], ascending=True)
     return df['InstanceType'].iloc[0]
 
 
 def get_accelerators_from_instance_type_impl(
-    df: pd.DataFrame,
+    df: 'pd.DataFrame',
     instance_type: str,
 ) -> Optional[Dict[str, int]]:
     df = _get_instance_type(df, instance_type, None)
     if len(df) == 0:
         with ux_utils.print_exception_no_traceback():
             raise ValueError(f'No instance type {instance_type} found.')
     row = df.iloc[0]
     acc_name, acc_count = row['AcceleratorName'], row['AcceleratorCount']
     if pd.isnull(acc_name):
         return None
     return {acc_name: int(acc_count)}
 
 
 def get_instance_type_for_accelerator_impl(
-    df: pd.DataFrame,
+    df: 'pd.DataFrame',
     acc_name: str,
     acc_count: int,
     cpus: Optional[str] = None,
     memory: Optional[str] = None,
     use_spot: bool = False,
     region: Optional[str] = None,
     zone: Optional[str] = None,
@@ -492,15 +526,15 @@
     result = result.sort_values(price_str, ascending=True)
     instance_types = list(result['InstanceType'].drop_duplicates())
     return (instance_types, [])
 
 
 def list_accelerators_impl(
         cloud: str,
-        df: pd.DataFrame,
+        df: 'pd.DataFrame',
         gpus_only: bool,
         name_filter: Optional[str],
         region_filter: Optional[str],
         quantity_filter: Optional[int],
         case_sensitive: bool = True,
         all_regions: bool = False,
         require_price: bool = True) -> Dict[str, List[InstanceTypeInfo]]:
@@ -586,15 +620,15 @@
                               cpu_count if not pd.isna(info.cpu_count) else 0,
                               info.price, info.spot_price, info.region))
         return ret
 
     return {k: make_list_from_df(v) for k, v in grouped}
 
 
-def get_region_zones(df: pd.DataFrame,
+def get_region_zones(df: 'pd.DataFrame',
                      use_spot: bool) -> List[cloud_lib.Region]:
     """Returns a list of regions/zones from a dataframe."""
     price_str = 'SpotPrice' if use_spot else 'Price'
     sort_keys = [price_str, 'Region']
     if 'AvailabilityZone' in df.columns:
         sort_keys.append('AvailabilityZone')
     # If NaN appears in any of the sort keys, drop the row, as that means
@@ -606,15 +640,15 @@
             lambda x: [cloud_lib.Zone(zone) for zone in x])
         for region in regions:
             region.set_zones(zones_in_region[region.name])
     return regions
 
 
 # Images
-def get_image_id_from_tag_impl(df: pd.DataFrame, tag: str,
+def get_image_id_from_tag_impl(df: 'pd.DataFrame', tag: str,
                                region: Optional[str]) -> Optional[str]:
     """Returns the image ID for the given tag and region.
 
     If region is None, there must be only one image with the given tag.
 
     Returns None if a region (or globally if region is None) does not have
     an image that matches the tag.
@@ -627,14 +661,14 @@
         return None
     image_id = df['ImageId'].iloc[0]
     if pd.isna(image_id):
         return None
     return image_id
 
 
-def is_image_tag_valid_impl(df: pd.DataFrame, tag: str,
+def is_image_tag_valid_impl(df: 'pd.DataFrame', tag: str,
                             region: Optional[str]) -> bool:
     """Returns True if the image tag is valid."""
     df = df[df['Tag'] == tag]
     df = _filter_region_zone(df, region, zone=None)
     df = df.dropna(subset=['ImageId'])
     return len(df) > 0
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/config.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/cudo_catalog.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/cudo_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_aws.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_aws.py`

 * *Files 2% similar despite different names*

```diff
@@ -8,24 +8,30 @@
 from multiprocessing import pool as mp_pool
 import os
 import re
 import subprocess
 import sys
 import textwrap
 import traceback
+import typing
 from typing import Dict, List, Optional, Set, Tuple, Union
 
 import numpy as np
-import pandas as pd
 
 from sky import exceptions
 from sky.adaptors import aws
+from sky.adaptors import common as adaptors_common
 from sky.utils import log_utils
 from sky.utils import ux_utils
 
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 # Enable most of the regions. Each user's account may have a subset of these
 # enabled; this is ok because we take the intersection of the list here with
 # the user-specific enabled regions in `aws_catalog`, via the "availability
 # zone mapping".
 # TODO(zhwu): fix the regions with no supported AMI (maybe by finding AMIs
 # similar to the Deep Learning AMI).
 ALL_REGIONS = [
@@ -94,39 +100,39 @@
             else:
                 raise
         regions_enabled = {r['RegionName'] for r in user_cloud_regions}
         regions_enabled = regions_enabled.intersection(set(ALL_REGIONS))
     return regions_enabled
 
 
-def _get_instance_types(region: str) -> pd.DataFrame:
+def _get_instance_types(region: str) -> 'pd.DataFrame':
     client = aws.client('ec2', region_name=region)
     paginator = client.get_paginator('describe_instance_types')
     items = []
     for i, resp in enumerate(paginator.paginate()):
         print(f'{region} getting instance types page {i}')
         items += resp['InstanceTypes']
 
     return pd.DataFrame(items)
 
 
-def _get_instance_type_offerings(region: str) -> pd.DataFrame:
+def _get_instance_type_offerings(region: str) -> 'pd.DataFrame':
     client = aws.client('ec2', region_name=region)
     paginator = client.get_paginator('describe_instance_type_offerings')
     items = []
     for i, resp in enumerate(
             paginator.paginate(LocationType='availability-zone')):
         print(f'{region} getting instance type offerings page {i}')
         items += resp['InstanceTypeOfferings']
 
     return pd.DataFrame(items).rename(
         columns={'Location': 'AvailabilityZoneName'})
 
 
-def _get_availability_zones(region: str) -> pd.DataFrame:
+def _get_availability_zones(region: str) -> 'pd.DataFrame':
     client = aws.client('ec2', region_name=region)
     zones = []
     try:
         response = client.describe_availability_zones()
     except aws.botocore_exceptions().ClientError as e:
         if e.response['Error']['Code'] == 'AuthFailure':
             # The user's AWS account may not have access to this region.
@@ -152,15 +158,15 @@
         zones.append({
             'AvailabilityZoneName': resp['ZoneName'],
             'AvailabilityZone': resp['ZoneId'],
         })
     return pd.DataFrame(zones)
 
 
-def _get_pricing_table(region: str) -> pd.DataFrame:
+def _get_pricing_table(region: str) -> 'pd.DataFrame':
     print(f'{region} downloading pricing table')
     url = PRICING_TABLE_URL_FMT.format(region=region)
     df = pd.read_csv(url, skiprows=5, low_memory=False)
     df.rename(columns={
         'Instance Type': 'InstanceType',
         'PricePerUnit': 'Price',
     },
@@ -170,15 +176,15 @@
               df['Pre Installed S/W'].isnull() &
               (df['CapacityStatus'] == 'Used') &
               (df['Tenancy'].isin(['Host', 'Shared'])) & df['Price'] > 0][[
                   'InstanceType', 'Price', 'vCPU', 'Memory'
               ]]
 
 
-def _get_spot_pricing_table(region: str) -> pd.DataFrame:
+def _get_spot_pricing_table(region: str) -> 'pd.DataFrame':
     """Get spot pricing table for a region.
 
     Example output:
         InstanceType  AvailabilityZoneName  SpotPrice
         p3.2xlarge    us-east-1a            1.0000
     """
     print(f'{region} downloading spot pricing table')
@@ -199,16 +205,16 @@
         ret = ret + response['SpotPriceHistory']
     df = pd.DataFrame(ret)[['InstanceType', 'AvailabilityZone', 'SpotPrice']]
     df = df.rename(columns={'AvailabilityZone': 'AvailabilityZoneName'})
     df = df.set_index(['InstanceType', 'AvailabilityZoneName'])
     return df
 
 
-def _patch_p4de(region: str, df: pd.DataFrame,
-                pricing_df: pd.DataFrame) -> pd.DataFrame:
+def _patch_p4de(region: str, df: 'pd.DataFrame',
+                pricing_df: 'pd.DataFrame') -> 'pd.DataFrame':
     # Hardcoded patch for p4de.24xlarge, as our credentials doesn't have access
     # to the instance type.
     # Columns:
     # InstanceType,AcceleratorName,AcceleratorCount,vCPUs,MemoryGiB,GpuInfo,
     # Price,SpotPrice,Region,AvailabilityZone
     records = []
     for zone in df[df['Region'] == region]['AvailabilityZone'].unique():
@@ -228,15 +234,15 @@
                      ['Price'].values[0],
             'SpotPrice': np.nan,
         })
     df = pd.concat([df, pd.DataFrame.from_records(records)])
     return df
 
 
-def _get_instance_types_df(region: str) -> Union[str, pd.DataFrame]:
+def _get_instance_types_df(region: str) -> Union[str, 'pd.DataFrame']:
     try:
         # Fetch the zone info first to make sure the account has access to the
         # region.
         zone_df = _get_availability_zones(region)
 
         # Use ThreadPool instead of Pool because this function can be called
         # within a multiprocessing.Pool, and Pool cannot be nested.
@@ -337,15 +343,15 @@
     except Exception as e:  # pylint: disable=broad-except
         print(traceback.format_exc())
         print(f'{region} failed with {e}', file=sys.stderr)
         return region
     return df
 
 
-def get_all_regions_instance_types_df(regions: Set[str]) -> pd.DataFrame:
+def get_all_regions_instance_types_df(regions: Set[str]) -> 'pd.DataFrame':
     with mp_pool.Pool() as pool:
         df_or_regions = pool.map(_get_instance_types_df, regions)
     new_dfs = []
     for df_or_region in df_or_regions:
         if isinstance(df_or_region, str):
             print(f'{df_or_region} failed')
         else:
@@ -409,28 +415,28 @@
     if image_id is None:
         # not found
         print(f'Failed to find image for {region}, {ubuntu_version}, {gpu}')
     tag = f'skypilot:{gpu}-ubuntu-{ubuntu_version.replace(".", "")}'
     return tag, region, 'ubuntu', ubuntu_version, image_id, date
 
 
-def get_all_regions_images_df(regions: Set[str]) -> pd.DataFrame:
+def get_all_regions_images_df(regions: Set[str]) -> 'pd.DataFrame':
     image_metas = [
         (r, *i) for r, i in itertools.product(regions, _GPU_UBUNTU_DATE_PYTORCH)
     ]
     with mp_pool.Pool() as pool:
         results = pool.starmap(_get_image_row, image_metas)
     result_df = pd.DataFrame(
         results,
         columns=['Tag', 'Region', 'OS', 'OSVersion', 'ImageId', 'CreationDate'])
     result_df.sort_values(['Tag', 'Region'], inplace=True)
     return result_df
 
 
-def fetch_availability_zone_mappings() -> pd.DataFrame:
+def fetch_availability_zone_mappings() -> 'pd.DataFrame':
     """Fetch the availability zone mappings from ID to Name.
 
     Example output:
         AvailabilityZone  AvailabilityZoneName
         use1-az1          us-east-1b
         use1-az2          us-east-1a
     """
@@ -500,15 +506,15 @@
 
     user_regions = get_enabled_regions()
     if args.check_all_regions_enabled_for_account and set(
             ALL_REGIONS) - user_regions:
         raise RuntimeError('The following regions are not enabled: '
                            f'{set(ALL_REGIONS) - user_regions}')
 
-    def _check_regions_integrity(df: pd.DataFrame, name: str):
+    def _check_regions_integrity(df: 'pd.DataFrame', name: str):
         # Check whether the fetched regions match the requested regions to
         # guard against network issues or glitches in the AWS API.
         fetched_regions = set(df['Region'].unique())
         if fetched_regions != user_regions:
             # This is a sanity check to make sure that the regions we
             # requested are the same as the ones we fetched.
             # The mismatch could happen for network issues or glitches
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_azure.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_azure.py`

 * *Files 2% similar despite different names*

```diff
@@ -3,21 +3,28 @@
 This script takes about 1 minute to finish.
 """
 import argparse
 import json
 from multiprocessing import pool as mp_pool
 import os
 import subprocess
+import typing
 from typing import List, Optional, Set
 import urllib
 
 import numpy as np
-import pandas as pd
 import requests
 
+from sky.adaptors import common as adaptors_common
+
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 US_REGIONS = {
     'centralus',
     'eastus',
     'eastus2',
     'northcentralus',
     'southcentralus',
     'westcentralus',
@@ -99,15 +106,15 @@
     ]
     if region is not None:
         filters.append(f'armRegionName eq \'{region}\'')
     filters_str = urllib.parse.quote(' and '.join(filters))
     return f'https://prices.azure.com/api/retail/prices?$filter={filters_str}'
 
 
-def get_pricing_df(region: Optional[str] = None) -> pd.DataFrame:
+def get_pricing_df(region: Optional[str] = None) -> 'pd.DataFrame':
     all_items = []
     url = get_pricing_url(region)
     print(f'Getting pricing for {region}, url: {url}')
     page = 0
     while url is not None:
         page += 1
         if page % 10 == 0:
@@ -124,15 +131,15 @@
     print(f'Done fetching pricing {region}')
     df = pd.DataFrame(all_items)
     assert 'productName' in df.columns, (region, df.columns)
     return df[(~df['productName'].str.contains(' Windows')) &
               (df['unitPrice'] > 0)]
 
 
-def get_sku_df(region_set: Set[str]) -> pd.DataFrame:
+def get_sku_df(region_set: Set[str]) -> 'pd.DataFrame':
     print('Fetching SKU list')
     # To get a complete list, --all option is necessary.
     proc = subprocess.run(
         'az vm list-skus --all --resource-type virtualMachines -o json',
         shell=True,
         check=True,
         stdout=subprocess.PIPE,
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py`

 * *Files 4% similar despite different names*

```diff
@@ -6,23 +6,29 @@
 
 import argparse
 import functools
 import io
 import multiprocessing
 import os
 import textwrap
+import typing
 from typing import Any, Callable, Dict, List, Optional, Set
 
 import google.auth
 from googleapiclient import discovery
 import numpy as np
-import pandas as pd
 
+from sky.adaptors import common as adaptors_common
 from sky.adaptors import gcp
 
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 # Useful links:
 # GCP SKUs: https://cloud.google.com/skus
 # VM pricing: https://cloud.google.com/compute/vm-instance-pricing
 # GPU pricing: https://cloud.google.com/compute/gpus-pricing
 # TPU pricing: https://cloud.google.com/tpu/pricing
 
 # Service IDs found in https://cloud.google.com/skus
@@ -171,15 +177,15 @@
         zones_response = zones_request.execute()
         zones.extend([zone['name'] for zone in zones_response['items']])
         zones_request = gcp_client.zones().list_next(
             previous_request=zones_request, previous_response=zones_response)
     return zones
 
 
-def _get_machine_type_for_zone(zone: str) -> pd.DataFrame:
+def _get_machine_type_for_zone(zone: str) -> 'pd.DataFrame':
     machine_types_request = gcp_client.machineTypes().list(project=project_id,
                                                            zone=zone)
     print(f'Fetching machine types for zone {zone!r}...')
     machine_types = []
     while machine_types_request is not None:
         machine_types_response = machine_types_request.execute()
         machine_types.extend(machine_types_response['items'])
@@ -192,27 +198,27 @@
         'MemoryGiB': machine_type['memoryMb'] / 1024,
         'Region': zone.rpartition('-')[0],
         'AvailabilityZone': zone
     } for machine_type in machine_types]
     return pd.DataFrame(machine_types).reset_index(drop=True)
 
 
-def _get_machine_types(region_prefix: str) -> pd.DataFrame:
+def _get_machine_types(region_prefix: str) -> 'pd.DataFrame':
     zones = _get_all_zones()
     zones = [zone for zone in zones if zone.startswith(region_prefix)]
     if SINGLE_THREADED:
         all_machine_dfs = [_get_machine_type_for_zone(zone) for zone in zones]
     else:
         with multiprocessing.Pool() as pool:
             all_machine_dfs = pool.map(_get_machine_type_for_zone, zones)
     machine_df = pd.concat(all_machine_dfs, ignore_index=True)
     return machine_df
 
 
-def get_vm_df(skus: List[Dict[str, Any]], region_prefix: str) -> pd.DataFrame:
+def get_vm_df(skus: List[Dict[str, Any]], region_prefix: str) -> 'pd.DataFrame':
     df = _get_machine_types(region_prefix)
     if df.empty:
         return df
 
     # Drop the unsupported series.
     df = df[df['InstanceType'].str.startswith(
         tuple(f'{series}-' for series in SERIES_TO_DISCRIPTION))]
@@ -277,15 +283,15 @@
     df['Price'] = df.apply(lambda row: get_vm_price(row, spot=False), axis=1)
     df['SpotPrice'] = df.apply(lambda row: get_vm_price(row, spot=True), axis=1)
     df = df.reset_index(drop=True)
     df = df.sort_values(['InstanceType', 'Region', 'AvailabilityZone'])
     return df
 
 
-def _get_gpus_for_zone(zone: str) -> pd.DataFrame:
+def _get_gpus_for_zone(zone: str) -> 'pd.DataFrame':
     gpus_request = gcp_client.acceleratorTypes().list(project=project_id,
                                                       zone=zone)
     print(f'Fetching GPUs for zone {zone!r}...')
     gpus = []
     while gpus_request is not None:
         gpus_response = gpus_request.execute()
         gpus.extend(gpus_response.get('items', []))
@@ -342,27 +348,28 @@
     gpu_memory_in_mib = name_to_gpu_memory_in_mib.get(name)
     if gpu_memory_in_mib is not None:
         return {'Gpus': [{'MemoryInfo': {'SizeInMiB': gpu_memory_in_mib}}]}
     print('Warning: GPU memory info not found for', name)
     return None
 
 
-def _get_gpus(region_prefix: str) -> pd.DataFrame:
+def _get_gpus(region_prefix: str) -> 'pd.DataFrame':
     zones = _get_all_zones()
     zones = [zone for zone in zones if zone.startswith(region_prefix)]
     if SINGLE_THREADED:
         all_gpu_dfs = [_get_gpus_for_zone(zone) for zone in zones]
     else:
         with multiprocessing.Pool() as pool:
             all_gpu_dfs = pool.map(_get_gpus_for_zone, zones)
     gpu_df = pd.concat(all_gpu_dfs, ignore_index=True)
     return gpu_df
 
 
-def get_gpu_df(skus: List[Dict[str, Any]], region_prefix: str) -> pd.DataFrame:
+def get_gpu_df(skus: List[Dict[str, Any]],
+               region_prefix: str) -> 'pd.DataFrame':
     gpu_skus = [
         sku for sku in skus if sku['category']['resourceGroup'] == 'GPU'
     ]
     df = _get_gpus(region_prefix)
     if df.empty:
         return df
 
@@ -403,15 +410,15 @@
     df = df[df['Price'].notna() | df['SpotPrice'].notna()]
     df = df.reset_index(drop=True)
     df = df.sort_values(
         ['AcceleratorName', 'AcceleratorCount', 'Region', 'AvailabilityZone'])
     return df
 
 
-def _get_tpu_for_zone(zone: str) -> pd.DataFrame:
+def _get_tpu_for_zone(zone: str) -> 'pd.DataFrame':
     tpus = []
     parent = f'projects/{project_id}/locations/{zone}'
     tpus_request = tpu_client.projects().locations().acceleratorTypes().list(
         parent=parent)
     try:
         tpus_response = tpus_request.execute()
         for tpu in tpus_response['acceleratorTypes']:
@@ -433,29 +440,29 @@
             'AcceleratorCount': 1,
             'Region': zone.rpartition('-')[0],
             'AvailabilityZone': zone,
         })
     return pd.DataFrame(new_tpus).reset_index(drop=True)
 
 
-def _get_tpus() -> pd.DataFrame:
+def _get_tpus() -> 'pd.DataFrame':
     zones = _get_all_zones()
     # Add TPU-v4 zones.
     zones += TPU_V4_ZONES
     if SINGLE_THREADED:
         all_tpu_dfs = [_get_tpu_for_zone(zone) for zone in zones]
     else:
         with multiprocessing.Pool() as pool:
             all_tpu_dfs = pool.map(_get_tpu_for_zone, zones)
     tpu_df = pd.concat(all_tpu_dfs, ignore_index=True)
     return tpu_df
 
 
 # TODO: the TPUs fetched fails to contain us-east1
-def get_tpu_df(skus: List[Dict[str, Any]]) -> pd.DataFrame:
+def get_tpu_df(skus: List[Dict[str, Any]]) -> 'pd.DataFrame':
     df = _get_tpus()
     if df.empty:
         return df
 
     def get_tpu_price(row: pd.Series, spot: bool) -> Optional[float]:
         assert row['AcceleratorCount'] == 1, row
         tpu_price = None
@@ -523,15 +530,15 @@
     df = df.sort_values(
         ['version_and_size', 'AcceleratorCount', 'Region', 'AvailabilityZone'])
     df.drop(columns=['version_and_size'], inplace=True)
     df['GpuInfo'] = df['AcceleratorName']
     return df
 
 
-def get_catalog_df(region_prefix: str) -> pd.DataFrame:
+def get_catalog_df(region_prefix: str) -> 'pd.DataFrame':
     gcp_skus = get_skus(GCE_SERVICE_ID)
     vm_df = get_vm_df(gcp_skus, region_prefix)
     gpu_df = get_gpu_df(gcp_skus, region_prefix)
 
     # Drop regions without the given prefix.
     # NOTE: We intentionally do not drop any TPU regions.
     vm_df = vm_df[vm_df['Region'].str.startswith(region_prefix)]
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,19 +1,23 @@
 """ data fetcher for vsphere """
 import json
 import logging
 import os
 import typing
 
-import pandas as pd
-
+from sky.adaptors import common as adaptors_common
 from sky.adaptors import vsphere as vsphere_adaptor
 from sky.clouds.service_catalog.common import get_catalog_path
 from sky.provision.vsphere.common.cls_api_client import ClsApiClient
 
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 logging.basicConfig(level=logging.INFO)
 logger = logging.getLogger(__name__)
 
 # TODO: Add more GPUs and a GPU full/short name mapping
 PRESET_GPU_LIST = [
     {
         'Model': 'V100',
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/fluidstack_catalog.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/fluidstack_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/gcp_catalog.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/gcp_catalog.py`

 * *Files 1% similar despite different names*

```diff
@@ -2,24 +2,27 @@
 
 For now this service catalog is manually coded. In the future it should be
 queried from GCP API.
 """
 import typing
 from typing import Dict, List, Optional, Tuple
 
-import pandas as pd
-
 from sky import exceptions
 from sky import sky_logging
+from sky.adaptors import common as adaptors_common
 from sky.clouds.service_catalog import common
 from sky.utils import resources_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
+    import pandas as pd
+
     from sky.clouds import cloud
+else:
+    pd = adaptors_common.LazyImport('pandas')
 
 logger = sky_logging.init_logger(__name__)
 
 # Pull the latest catalog every week.
 # GCP guarantees that the catalog is updated at most once per 30 days, but
 # different VMs can be updated at different time. Thus, we pull the catalog
 # every 7 hours to make sure we have the latest information.
@@ -319,20 +322,20 @@
 def get_region_zones_for_instance_type(instance_type: str,
                                        use_spot: bool) -> List['cloud.Region']:
     df = _df[_df['InstanceType'] == instance_type]
     return common.get_region_zones(df, use_spot)
 
 
 def _get_accelerator(
-    df: pd.DataFrame,
+    df: 'pd.DataFrame',
     accelerator: str,
     count: int,
     region: Optional[str],
     zone: Optional[str] = None,
-) -> pd.DataFrame:
+) -> 'pd.DataFrame':
     idx = (df['AcceleratorName'].str.fullmatch(
         accelerator, case=False)) & (df['AcceleratorCount'] == count)
     if region is not None:
         idx &= df['Region'] == region
     if zone is not None:
         idx &= df['AvailabilityZone'] == zone
     return df[idx]
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/ibm_catalog.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/ibm_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/kubernetes_catalog.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/kubernetes_catalog.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,22 +1,27 @@
 """Kubernetes Catalog.
 
 Kubernetes does not require a catalog of instances, but we need an image catalog
 mapping SkyPilot image tags to corresponding container image tags.
 """
+import typing
 from typing import Dict, List, Optional, Set, Tuple
 
-import pandas as pd
-
 from sky import check as sky_check
+from sky.adaptors import common as adaptors_common
 from sky.clouds import Kubernetes
 from sky.clouds.service_catalog import CloudFilter
 from sky.clouds.service_catalog import common
 from sky.provision.kubernetes import utils as kubernetes_utils
 
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 _PULL_FREQUENCY_HOURS = 7
 
 # We keep pull_frequency_hours so we can remotely update the default image paths
 _image_df = common.read_catalog('kubernetes/images.csv',
                                 pull_frequency_hours=_PULL_FREQUENCY_HOURS)
 
 # TODO(romilb): Refactor implementation of common service catalog functions from
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/lambda_catalog.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/lambda_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/oci_catalog.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/oci_catalog.py`

 * *Files 1% similar despite different names*

```diff
@@ -36,31 +36,31 @@
     with _lock:
         global _df
         if _df is not None:
             return _df
 
         df = common.read_catalog('oci/vms.csv')
         try:
-            oci_adaptor.get_oci()
+            oci_adaptor.oci
         except ImportError:
             _df = df
             return _df
 
         try:
             config_profile = oci_utils.oci_config.get_profile()
             client = oci_adaptor.get_identity_client(profile=config_profile)
 
             subscriptions = client.list_region_subscriptions(
                 tenancy_id=oci_adaptor.get_oci_config(
                     profile=config_profile)['tenancy']).data
 
             subscribed_regions = [r.region_name for r in subscriptions]
 
-        except (oci_adaptor.get_oci().exceptions.ConfigFileNotFound,
-                oci_adaptor.get_oci().exceptions.InvalidConfig) as e:
+        except (oci_adaptor.oci.exceptions.ConfigFileNotFound,
+                oci_adaptor.oci.exceptions.InvalidConfig) as e:
             # This should only happen in testing where oci config is
             # missing, because it means the 'sky check' will fail if
             # enter here (meaning OCI disabled).
             logger.debug(f'It is OK goes here when testing: {str(e)}')
             subscribed_regions = []
 
         except oci_adaptor.service_exception() as e:
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/paperspace_catalog.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/paperspace_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/runpod_catalog.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/runpod_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/scp_catalog.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/scp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/service_catalog/vsphere_catalog.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/service_catalog/vsphere_catalog.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,33 +1,36 @@
 """Vsphere catalog."""
 import io
 import os
 import typing
 from typing import Dict, List, Optional, Tuple
 
-import pandas as pd
-
+from sky.adaptors import common as adaptors_common
 from sky.clouds.service_catalog import common
 
 if typing.TYPE_CHECKING:
+    import pandas as pd
+
     from sky.clouds import cloud
+else:
+    pd = adaptors_common.LazyImport('pandas')
 
 _DEFAULT_NUM_VCPUS = 2
 _DEFAULT_MEMORY_CPU_RATIO = 4
 _CLOUD_VSPHERE = 'vsphere'
 
 VSPHERE_CATALOG_HEADER = (
     'InstanceType,AcceleratorName,AcceleratorCount,vCPUs,'
     'MemoryGiB,GpuInfo,Price,SpotPrice,Region,AvailabilityZone')
 
 _LOCAL_CATALOG = common.get_catalog_path('vsphere/vms.csv')
 _df = None
 
 
-def _get_df() -> pd.DataFrame:
+def _get_df() -> 'pd.DataFrame':
     """Returns the catalog as a DataFrame."""
     global _df
     if _df is not None:
         return _df
     if os.path.exists(_LOCAL_CATALOG):
         _df = pd.read_csv(_LOCAL_CATALOG)
     else:
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/utils/gcp_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/utils/gcp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/utils/lambda_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/utils/lambda_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/utils/oci_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/utils/oci_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/utils/scp_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/utils/scp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/clouds/vsphere.py` & `skypilot-nightly-1.0.0.dev20240403/sky/clouds/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/core.py` & `skypilot-nightly-1.0.0.dev20240403/sky/core.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/dag.py` & `skypilot-nightly-1.0.0.dev20240403/sky/dag.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/data/data_transfer.py` & `skypilot-nightly-1.0.0.dev20240403/sky/data/data_transfer.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/data/data_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/data/data_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/data/mounting_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/data/mounting_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/data/storage.py` & `skypilot-nightly-1.0.0.dev20240403/sky/data/storage.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/data/storage_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/data/storage_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/exceptions.py` & `skypilot-nightly-1.0.0.dev20240403/sky/exceptions.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/execution.py` & `skypilot-nightly-1.0.0.dev20240403/sky/execution.py`

 * *Files 1% similar despite different names*

```diff
@@ -230,14 +230,18 @@
         # unlike `gpus`.
 
     stages = stages if stages is not None else list(Stage)
 
     # Requested features that some clouds support and others don't.
     requested_features = set()
 
+    if controller_utils.Controllers.from_name(cluster_name) is not None:
+        requested_features.add(
+            clouds.CloudImplementationFeatures.HOST_CONTROLLERS)
+
     # Add requested features from the task
     requested_features |= task.get_required_cloud_features()
 
     backend = backend if backend is not None else backends.CloudVmRayBackend()
     if isinstance(backend, backends.CloudVmRayBackend):
         if down and idle_minutes_to_autostop is None:
             # Use auto{stop,down} to terminate the cluster after the task is
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/global_user_state.py` & `skypilot-nightly-1.0.0.dev20240403/sky/global_user_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/optimizer.py` & `skypilot-nightly-1.0.0.dev20240403/sky/optimizer.py`

 * *Files 1% similar despite different names*

```diff
@@ -3,31 +3,34 @@
 import copy
 import enum
 import json
 import typing
 from typing import Any, Dict, Iterable, List, Optional, Tuple
 
 import colorama
-import networkx as nx
 import numpy as np
 import prettytable
 
 from sky import check as sky_check
 from sky import clouds
 from sky import exceptions
 from sky import resources as resources_lib
 from sky import sky_logging
 from sky import task as task_lib
+from sky.adaptors import common as adaptors_common
 from sky.utils import env_options
 from sky.utils import log_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
-    # pylint: disable=ungrouped-imports
+    import networkx as nx
+
     from sky import dag as dag_lib
+else:
+    nx = adaptors_common.LazyImport('networkx')
 
 logger = sky_logging.init_logger(__name__)
 
 _DUMMY_SOURCE_NAME = 'skypilot-dummy-source'
 _DUMMY_SINK_NAME = 'skypilot-dummy-sink'
 
 # task -> resources -> estimated cost or time.
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/aws/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/aws/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/aws/config.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/aws/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/aws/instance.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/aws/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/aws/utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/aws/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/azure/instance.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/azure/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/common.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/common.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/cudo/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/cudo/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/cudo/cudo_machine_type.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/cudo/cudo_machine_type.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/cudo/cudo_wrapper.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/cudo/cudo_wrapper.py`

 * *Files 13% similar despite different names*

```diff
@@ -1,111 +1,111 @@
 """Cudo Compute library wrapper for SkyPilot."""
 import time
 from typing import Dict
 
 from sky import sky_logging
-from sky.adaptors.cudo import cudo
+from sky.adaptors import cudo
 
 logger = sky_logging.init_logger(__name__)
 
 
 def launch(name: str, data_center_id: str, ssh_key: str, machine_type: str,
            memory_gib: int, vcpu_count: int, gpu_count: int, gpu_model: str,
            tags: Dict[str, str], disk_size: int):
     """Launches an instance with the given parameters."""
-    disk = cudo().Disk(storage_class='STORAGE_CLASS_NETWORK',
-                       size_gib=disk_size)
+    disk = cudo.cudo.Disk(storage_class='STORAGE_CLASS_NETWORK',
+                          size_gib=disk_size)
 
-    request = cudo().CreateVMBody(ssh_key_source='SSH_KEY_SOURCE_NONE',
-                                  custom_ssh_keys=[ssh_key],
-                                  vm_id=name,
-                                  machine_type=machine_type,
-                                  data_center_id=data_center_id,
-                                  boot_disk_image_id='ubuntu-nvidia-docker',
-                                  memory_gib=memory_gib,
-                                  vcpus=vcpu_count,
-                                  gpus=gpu_count,
-                                  gpu_model=gpu_model,
-                                  boot_disk=disk,
-                                  metadata=tags)
+    request = cudo.cudo.CreateVMBody(ssh_key_source='SSH_KEY_SOURCE_NONE',
+                                     custom_ssh_keys=[ssh_key],
+                                     vm_id=name,
+                                     machine_type=machine_type,
+                                     data_center_id=data_center_id,
+                                     boot_disk_image_id='ubuntu-nvidia-docker',
+                                     memory_gib=memory_gib,
+                                     vcpus=vcpu_count,
+                                     gpus=gpu_count,
+                                     gpu_model=gpu_model,
+                                     boot_disk=disk,
+                                     metadata=tags)
 
     try:
-        api = cudo().cudo_api.virtual_machines()
-        vm = api.create_vm(cudo().cudo_api.project_id(), request)
+        api = cudo.cudo.cudo_api.virtual_machines()
+        vm = api.create_vm(cudo.cudo.cudo_api.project_id(), request)
         return vm.to_dict()['id']
-    except cudo().rest.ApiException as e:
+    except cudo.cudo.rest.ApiException as e:
         raise e
 
 
 def remove(instance_id: str):
     """Terminates the given instance."""
     terminate_ok = [
         'pend',
         'poff',
         'runn',
         'stop',
         'susp',
         'unde',
         'fail',
     ]
-    api = cudo().cudo_api.virtual_machines()
+    api = cudo.cudo.cudo_api.virtual_machines()
     max_retries = 10
     retry_interval = 5
     retry_count = 0
     state = 'unknown'
-    project_id = cudo().cudo_api.project_id()
+    project_id = cudo.cudo.cudo_api.project_id()
     while retry_count < max_retries:
         try:
             vm = api.get_vm(project_id, instance_id)
             state = vm.to_dict()['vm']['short_state']
-        except cudo().rest.ApiException as e:
+        except cudo.cudo.rest.ApiException as e:
             raise e
 
         if state in terminate_ok:
             break
         retry_count += 1
         time.sleep(retry_interval)
     else:
         raise Exception(
             'Timeout error, could not terminate due to VM state: {}'.format(
                 state))
 
     try:
         api.terminate_vm(project_id, instance_id)
-    except cudo().rest.ApiException as e:
+    except cudo.cudo.rest.ApiException as e:
         raise e
 
 
 def set_tags(instance_id: str, tags: Dict):
     """Sets the tags for the given instance."""
     try:
-        api = cudo().cudo_api.virtual_machines()
+        api = cudo.cudo.cudo_api.virtual_machines()
         api.update_vm_metadata(
-            cudo().cudo_api.project_id(), instance_id,
-            cudo().UpdateVMMetadataBody(
+            cudo.cudo.cudo_api.project_id(), instance_id,
+            cudo.cudo.UpdateVMMetadataBody(
                 metadata=tags,
                 merge=True))  # TODO (skypilot team) merge or overwrite?
-    except cudo().rest.ApiException as e:
+    except cudo.cudo.rest.ApiException as e:
         raise e
 
 
 def get_instance(vm_id):
     try:
-        api = cudo().cudo_api.virtual_machines()
-        vm = api.get_vm(cudo().cudo_api.project_id(), vm_id)
+        api = cudo.cudo.cudo_api.virtual_machines()
+        vm = api.get_vm(cudo.cudo.cudo_api.project_id(), vm_id)
         vm_dict = vm.to_dict()
         return vm_dict
-    except cudo().rest.ApiException as e:
+    except cudo.cudo.rest.ApiException as e:
         raise e
 
 
 def list_instances():
     try:
-        api = cudo().cudo_api.virtual_machines()
-        vms = api.list_vms(cudo().cudo_api.project_id())
+        api = cudo.cudo.cudo_api.virtual_machines()
+        vms = api.list_vms(cudo.cudo.cudo_api.project_id())
         instances = {}
         for vm in vms.to_dict()['vms']:
             ex_ip = vm['external_ip_address']
             in_ip = vm['internal_ip_address']
             if not in_ip:
                 in_ip = ex_ip
             instance = {
@@ -115,9 +115,9 @@
                 'name': vm['id'],
                 'ip': ex_ip,
                 'external_ip': ex_ip,
                 'internal_ip': in_ip
             }
             instances[vm['id']] = instance
         return instances
-    except cudo().rest.ApiException as e:
+    except cudo.cudo.rest.ApiException as e:
         raise e
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/cudo/instance.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/cudo/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/docker_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/fluidstack/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/fluidstack/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/fluidstack/fluidstack_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/fluidstack/fluidstack_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/fluidstack/instance.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/fluidstack/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/gcp/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/gcp/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/gcp/config.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/gcp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/gcp/constants.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/gcp/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/gcp/instance.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/gcp/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/gcp/instance_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/gcp/instance_utils.py`

 * *Files 0% similar despite different names*

```diff
@@ -408,15 +408,15 @@
         else:
             kwargs = {}
             operation_caller = cls.load_resource().globalOperations()
         logger.debug(
             f'Waiting GCP operation {operation["name"]} to be ready ...')
 
         @_retry_on_http_exception(
-            f'Fail to wait for operation {operation["name"]}')
+            f'Failed to wait for operation {operation["name"]}')
         def call_operation(fn, timeout: int):
             request = fn(
                 project=project_id,
                 operation=operation['name'],
                 **kwargs,
             )
             request.http.timeout = timeout
@@ -961,15 +961,15 @@
     @classmethod
     def wait_for_operation(cls, operation: dict, project_id: str,
                            zone: Optional[str]) -> None:
         """Poll for TPU operation until finished."""
         del project_id, zone  # unused
 
         @_retry_on_http_exception(
-            f'Fail to wait for operation {operation["name"]}')
+            f'Failed to wait for operation {operation["name"]}')
         def call_operation(fn, timeout: int):
             request = fn(name=operation['name'])
             request.http.timeout = timeout
             return request.execute(num_retries=GCP_MAX_RETRIES)
 
         wait_start = time.time()
         while time.time() - wait_start < GCP_TIMEOUT:
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/instance_setup.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/instance_setup.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/kubernetes/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/kubernetes/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/kubernetes/config.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/kubernetes/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/kubernetes/instance.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/kubernetes/instance.py`

 * *Files 1% similar despite different names*

```diff
@@ -449,15 +449,15 @@
             'This is likely a resource leak. '
             'Use "sky down" to terminate the cluster.')
 
     # Add nvidia runtime class if it exists
     nvidia_runtime_exists = False
     try:
         nvidia_runtime_exists = kubernetes_utils.check_nvidia_runtime_class()
-    except kubernetes.get_kubernetes().client.ApiException as e:
+    except kubernetes.kubernetes.client.ApiException as e:
         logger.warning('run_instances: Error occurred while checking for '
                        f'nvidia RuntimeClass - '
                        f'{common_utils.format_exception(e)}'
                        'Continuing without using nvidia RuntimeClass.\n'
                        'If you are on a K3s cluster, manually '
                        'override runtimeClassName in ~/.sky/config.yaml. '
                        'For more details, refer to https://skypilot.readthedocs.io/en/latest/reference/config.html')  # pylint: disable=line-too-long
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/kubernetes/network.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/kubernetes/network.py`

 * *Files 1% similar despite different names*

```diff
@@ -189,15 +189,15 @@
         elif port_mode == kubernetes_enums.KubernetesPortMode.INGRESS:
             return _query_ports_for_ingress(
                 cluster_name_on_cloud=cluster_name_on_cloud,
                 ports=ports,
             )
         else:
             return {}
-    except kubernetes.get_kubernetes().client.ApiException as e:
+    except kubernetes.kubernetes.client.ApiException as e:
         if e.status == 404:
             return {}
         raise e
 
 
 def _query_ports_for_loadbalancer(
     cluster_name_on_cloud: str,
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/kubernetes/network_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/kubernetes/network_utils.py`

 * *Files 7% similar despite different names*

```diff
@@ -5,24 +5,33 @@
 import jinja2
 import yaml
 
 import sky
 from sky import exceptions
 from sky import skypilot_config
 from sky.adaptors import kubernetes
+from sky.provision.kubernetes import utils as kubernetes_utils
 from sky.utils import kubernetes_enums
 from sky.utils import ux_utils
 
 _INGRESS_TEMPLATE_NAME = 'kubernetes-ingress.yml.j2'
 _LOADBALANCER_TEMPLATE_NAME = 'kubernetes-loadbalancer.yml.j2'
 
 
 def get_port_mode(
         mode_str: Optional[str] = None) -> kubernetes_enums.KubernetesPortMode:
     """Get the port mode from the provider config."""
+
+    curr_kube_config = kubernetes_utils.get_current_kube_config_context_name()
+    running_kind = curr_kube_config == kubernetes_utils.KIND_CONTEXT_NAME
+
+    if running_kind:
+        # If running in kind (`sky local up`), use ingress mode
+        return kubernetes_enums.KubernetesPortMode.INGRESS
+
     mode_str = mode_str or skypilot_config.get_nested(
         ('kubernetes', 'ports'),
         kubernetes_enums.KubernetesPortMode.LOADBALANCER.value)
     try:
         port_mode = kubernetes_enums.KubernetesPortMode(mode_str)
     except ValueError as e:
         with ux_utils.print_exception_no_traceback():
@@ -94,15 +103,15 @@
         ingress_spec: Dict[str, Union[str, int]]) -> None:
     """Creates an ingress resource for the specified service."""
     networking_api = kubernetes.networking_api()
 
     try:
         networking_api.read_namespaced_ingress(
             ingress_name, namespace, _request_timeout=kubernetes.API_TIMEOUT)
-    except kubernetes.get_kubernetes().client.ApiException as e:
+    except kubernetes.kubernetes.client.ApiException as e:
         if e.status == 404:
             networking_api.create_namespaced_ingress(
                 namespace,
                 ingress_spec,
                 _request_timeout=kubernetes.API_TIMEOUT)
             return
         raise e
@@ -116,15 +125,15 @@
 
 def delete_namespaced_ingress(namespace: str, ingress_name: str) -> None:
     """Deletes an ingress resource."""
     networking_api = kubernetes.networking_api()
     try:
         networking_api.delete_namespaced_ingress(
             ingress_name, namespace, _request_timeout=kubernetes.API_TIMEOUT)
-    except kubernetes.get_kubernetes().client.ApiException as e:
+    except kubernetes.kubernetes.client.ApiException as e:
         if e.status == 404:
             raise exceptions.PortDoesNotExistError(
                 f'Port {ingress_name.split("--")[-1]} does not exist.')
         raise e
 
 
 def create_or_replace_namespaced_service(
@@ -132,15 +141,15 @@
         service_spec: Dict[str, Union[str, int]]) -> None:
     """Creates a service resource for the specified service."""
     core_api = kubernetes.core_api()
 
     try:
         core_api.read_namespaced_service(
             service_name, namespace, _request_timeout=kubernetes.API_TIMEOUT)
-    except kubernetes.get_kubernetes().client.ApiException as e:
+    except kubernetes.kubernetes.client.ApiException as e:
         if e.status == 404:
             core_api.create_namespaced_service(
                 namespace,
                 service_spec,
                 _request_timeout=kubernetes.API_TIMEOUT)
             return
         raise e
@@ -154,15 +163,15 @@
 def delete_namespaced_service(namespace: str, service_name: str) -> None:
     """Deletes a service resource."""
     core_api = kubernetes.core_api()
 
     try:
         core_api.delete_namespaced_service(
             service_name, namespace, _request_timeout=kubernetes.API_TIMEOUT)
-    except kubernetes.get_kubernetes().client.ApiException as e:
+    except kubernetes.kubernetes.client.ApiException as e:
         if e.status == 404:
             raise exceptions.PortDoesNotExistError(
                 f'Port {service_name.split("--")[-1]} does not exist.')
         raise e
 
 
 def ingress_controller_exists(ingress_class_name: str = 'nginx') -> bool:
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/kubernetes/utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/kubernetes/utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -527,30 +527,30 @@
 
 def get_current_kube_config_context_name() -> Optional[str]:
     """Get the current kubernetes context from the kubeconfig file
 
     Returns:
         str | None: The current kubernetes context if it exists, None otherwise
     """
-    k8s = kubernetes.get_kubernetes()
+    k8s = kubernetes.kubernetes
     try:
         _, current_context = k8s.config.list_kube_config_contexts()
         return current_context['name']
     except k8s.config.config_exception.ConfigException:
         return None
 
 
 def get_current_kube_config_context_namespace() -> str:
     """Get the current kubernetes context namespace from the kubeconfig file
 
     Returns:
         str | None: The current kubernetes context namespace if it exists, else
             the default namespace.
     """
-    k8s = kubernetes.get_kubernetes()
+    k8s = kubernetes.kubernetes
     try:
         _, current_context = k8s.config.list_kube_config_contexts()
         if 'namespace' in current_context['context']:
             return current_context['context']['namespace']
         else:
             return DEFAULT_NAMESPACE
     except k8s.config.config_exception.ConfigException:
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/logging.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/logging.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/metadata_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/paperspace/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/paperspace/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/paperspace/config.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/paperspace/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/paperspace/constants.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/paperspace/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/paperspace/instance.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/paperspace/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/paperspace/utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/paperspace/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/provisioner.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/provisioner.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/runpod/instance.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/runpod/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/runpod/utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/runpod/utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -50,27 +50,27 @@
 
     def wrapper(*args, **kwargs):
         """Wrapper for retrying a function."""
         cnt = 0
         while True:
             try:
                 return func(*args, **kwargs)
-            except runpod.runpod().error.QueryError as e:
+            except runpod.runpod.error.QueryError as e:
                 if cnt >= 3:
                     raise
                 logger.warning('Retrying for exception: '
                                f'{common_utils.format_exception(e)}.')
                 time.sleep(1)
 
     return wrapper
 
 
 def list_instances() -> Dict[str, Dict[str, Any]]:
     """Lists instances associated with API key."""
-    instances = runpod.runpod().get_pods()
+    instances = runpod.runpod.get_pods()
 
     instance_dict: Dict[str, Dict[str, Any]] = {}
     for instance in instances:
         info = {}
 
         info['status'] = instance['desiredStatus']
         info['name'] = instance['name']
@@ -94,17 +94,17 @@
     Converts the instance_type to the RunPod GPU name, finds the specs for the
     GPU, and launches the instance.
     """
     gpu_type = GPU_NAME_MAP[instance_type.split('_')[1]]
     gpu_quantity = int(instance_type.split('_')[0].replace('x', ''))
     cloud_type = instance_type.split('_')[2]
 
-    gpu_specs = runpod.runpod().get_gpu(gpu_type)
+    gpu_specs = runpod.runpod.get_gpu(gpu_type)
 
-    new_instance = runpod.runpod().create_pod(
+    new_instance = runpod.runpod.create_pod(
         name=name,
         image_name='runpod/base:0.0.2',
         gpu_type_id=gpu_type,
         cloud_type=cloud_type,
         container_disk_in_gb=disk_size,
         min_vcpu_count=4 * gpu_quantity,
         min_memory_in_gb=gpu_specs['memoryInGb'] * gpu_quantity,
@@ -117,15 +117,15 @@
     )
 
     return new_instance['id']
 
 
 def remove(instance_id: str) -> None:
     """Terminates the given instance."""
-    runpod.runpod().terminate_pod(instance_id)
+    runpod.runpod.terminate_pod(instance_id)
 
 
 def get_ssh_ports(cluster_name) -> List[int]:
     """Gets the SSH ports for the given cluster."""
     logger.debug(f'Getting SSH ports for cluster {cluster_name}.')
 
     instances = list_instances()
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/cls_api_client.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/cls_api_client.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/cls_api_helper.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/cls_api_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/metadata_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/service_manager.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/service_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/service_manager_factory.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/service_manager_factory.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/ssl_helper.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/ssl_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/vapiconnect.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/vapiconnect.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/common/vim_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/common/vim_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/instance.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/instance.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,28 +1,33 @@
 """Vsphere instance provisioning."""
 import json
 import os
+import typing
 from typing import Any, Dict, List, Optional
 
-import pandas as pd
-
 from sky import exceptions
 from sky import sky_logging
 from sky import status_lib
+from sky.adaptors import common as adaptors_common
 from sky.adaptors import vsphere as vsphere_adaptor
 from sky.clouds.service_catalog.common import get_catalog_path
 from sky.provision import common
 from sky.provision.vsphere import vsphere_utils
 from sky.provision.vsphere.common import custom_script as custom_script_lib
 from sky.provision.vsphere.common import metadata_utils
 from sky.provision.vsphere.common.vim_utils import poweroff_vm
 from sky.provision.vsphere.common.vim_utils import wait_for_tasks
 from sky.provision.vsphere.common.vim_utils import wait_internal_ip_ready
 from sky.provision.vsphere.vsphere_utils import VsphereClient
 
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 logger = sky_logging.init_logger(__name__)
 
 TAG_SKYPILOT_CLUSTER_NAME = 'skypilot-cluster-name'
 TAG_SKYPILOT_HEAD_NODE = 'skypilot-head-node'
 HEAD_NODE_VALUE = '1'
 WORKER_NODE_VALUE = '0'
 PUBLIC_SSH_KEY_PATH = '~/.ssh/sky-key.pub'
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/provision/vsphere/vsphere_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/provision/vsphere/vsphere_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/resources.py` & `skypilot-nightly-1.0.0.dev20240403/sky/resources.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/serve/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/serve/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/serve/autoscalers.py` & `skypilot-nightly-1.0.0.dev20240403/sky/serve/autoscalers.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/serve/constants.py` & `skypilot-nightly-1.0.0.dev20240403/sky/serve/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/serve/controller.py` & `skypilot-nightly-1.0.0.dev20240403/sky/serve/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/serve/core.py` & `skypilot-nightly-1.0.0.dev20240403/sky/serve/core.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/serve/load_balancer.py` & `skypilot-nightly-1.0.0.dev20240403/sky/serve/load_balancer.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/serve/load_balancing_policies.py` & `skypilot-nightly-1.0.0.dev20240403/sky/serve/load_balancing_policies.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/serve/replica_managers.py` & `skypilot-nightly-1.0.0.dev20240403/sky/serve/replica_managers.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/serve/serve_state.py` & `skypilot-nightly-1.0.0.dev20240403/sky/serve/serve_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/serve/serve_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/serve/serve_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/serve/service.py` & `skypilot-nightly-1.0.0.dev20240403/sky/serve/service.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/serve/service_spec.py` & `skypilot-nightly-1.0.0.dev20240403/sky/serve/service_spec.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/setup_files/MANIFEST.in` & `skypilot-nightly-1.0.0.dev20240403/sky/setup_files/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/setup_files/setup.py` & `skypilot-nightly-1.0.0.dev20240403/sky/setup_files/setup.py`

 * *Files 1% similar despite different names*

```diff
@@ -232,14 +232,15 @@
     'scp': local_ray,
     'oci': ['oci'] + local_ray,
     'kubernetes': ['kubernetes>=20.0.0'],
     'remote': remote,
     'runpod': ['runpod>=1.5.1'],
     'fluidstack': [],  # No dependencies needed for fluidstack
     'cudo': ['cudo-compute>=0.1.8'],
+    'paperspace': [],  # No dependencies needed for paperspace
     'vsphere': [
         'pyvmomi==8.0.1.0.2',
         # vsphere-automation-sdk is also required, but it does not have
         # pypi release, which cause failure of our pypi release.
         # https://peps.python.org/pep-0440/#direct-references
         # We have the instruction for its installation in our
         # docs instead.
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/sky_logging.py` & `skypilot-nightly-1.0.0.dev20240403/sky/sky_logging.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/LICENSE` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/attempt_skylet.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/attempt_skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/autostop_lib.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/autostop_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/configs.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/configs.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/constants.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/events.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/events.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/job_lib.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/job_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/log_lib.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/log_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/log_lib.pyi` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/log_lib.pyi`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/azure/azure-config-template.json` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/azure/azure-config-template.json`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/azure/azure-vm-template.json` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/azure/azure-vm-template.json`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/azure/config.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/azure/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/azure/node_provider.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/azure/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/command_runner.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/ibm/node_provider.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/ibm/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/ibm/utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/ibm/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/ibm/vpc_provider.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/ibm/vpc_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/lambda_cloud/node_provider.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/lambda_cloud/node_provider.py`

 * *Files 0% similar despite different names*

```diff
@@ -148,15 +148,15 @@
                 if tags.get(k) != v:
                     return False
             return True
 
         def _get_internal_ip(node: Dict[str, Any]):
             # TODO(ewzeng): cache internal ips in metadata file to reduce
             # ssh overhead.
-            if node['external_ip'] is None:
+            if node['external_ip'] is None or node['status'] != 'active':
                 node['internal_ip'] = None
                 return
             runner = command_runner.SSHCommandRunner(node['external_ip'],
                                                      'ubuntu',
                                                      self.ssh_key_path)
             rc, stdout, stderr = runner.run(_GET_INTERNAL_IP_CMD,
                                             require_outputs=True,
@@ -168,14 +168,18 @@
                 stderr=stdout + stderr)
             node['internal_ip'] = stdout.strip()
 
         vms = self._list_instances_in_cluster()
         self.metadata.refresh([node['id'] for node in vms])
         self._guess_and_add_missing_tags(vms)
         nodes = [_extract_metadata(vm) for vm in filter(_match_tags, vms)]
+        nodes = [
+            node for node in nodes
+            if node['status'] not in ['terminating', 'terminated']
+        ]
         subprocess_utils.run_in_parallel(_get_internal_ip, nodes)
         self.cached_nodes = {node['id']: node for node in nodes}
         return self.cached_nodes
 
     def non_terminated_nodes(self, tag_filters: Dict[str, str]) -> List[str]:
         """Return a list of node ids filtered by the specified tags dict.
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/oci/node_provider.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/oci/node_provider.py`

 * *Files 2% similar despite different names*

```diff
@@ -204,15 +204,15 @@
 
             for reuse_node in reuse_nodes:
                 if reuse_node["status"] == "STOPPING":
                     get_instance_response = oci_adaptor.get_core_client(
                         self.region,
                         oci_utils.oci_config.get_profile()).get_instance(
                             instance_id=reuse_node["id"])
-                    oci_adaptor.get_oci().wait_until(
+                    oci_adaptor.oci.wait_until(
                         oci_adaptor.get_core_client(
                             self.region, oci_utils.oci_config.get_profile()),
                         get_instance_response,
                         "lifecycle_state",
                         "STOPPED",
                     )
 
@@ -262,29 +262,29 @@
             ocpu_count = 1 if (ocpu_count > 0 and
                                ocpu_count < 1) else ocpu_count
 
             machine_shape_config = None
             if ocpu_count > 0:
                 mem = node_config["MemoryInGbs"]
                 if mem is not None and mem != "None":
-                    machine_shape_config = (oci_adaptor.get_oci().core.models.
+                    machine_shape_config = (oci_adaptor.oci.core.models.
                                             LaunchInstanceShapeConfigDetails(
                                                 ocpus=ocpu_count,
                                                 memory_in_gbs=mem))
                 else:
-                    machine_shape_config = (oci_adaptor.get_oci().core.models.
+                    machine_shape_config = (oci_adaptor.oci.core.models.
                                             LaunchInstanceShapeConfigDetails(
                                                 ocpus=ocpu_count))
 
-            preempitible_config = (oci_adaptor.get_oci(
-            ).core.models.PreemptibleInstanceConfigDetails(
-                preemption_action=oci_adaptor.get_oci().core.models.
-                TerminatePreemptionAction(type="TERMINATE",
-                                          preserve_boot_volume=False))
-                                   if node_config["Preemptible"] else None)
+            preempitible_config = (
+                oci_adaptor.oci.core.models.PreemptibleInstanceConfigDetails(
+                    preemption_action=oci_adaptor.oci.core.models.
+                    TerminatePreemptionAction(type="TERMINATE",
+                                              preserve_boot_volume=False))
+                if node_config["Preemptible"] else None)
 
             logger.debug(f"Shape: {instance_type_str}, ocpu: {ocpu_count}")
             logger.debug(f"Shape config is {machine_shape_config}")
             logger.debug(f"Spot config is {preempitible_config}")
 
             vm_tags = {
                 **tags,
@@ -302,41 +302,43 @@
                 region=self.region,
             )
 
             start_time1 = round(time.time() * 1000)
             for seq in range(1, count + 1):
                 launch_instance_response = oci_adaptor.get_core_client(
                     self.region, oci_utils.oci_config.get_profile()
-                ).launch_instance(launch_instance_details=oci_adaptor.get_oci(
-                ).core.models.LaunchInstanceDetails(
-                    availability_domain=node_config["AvailabilityDomain"],
-                    compartment_id=compartment,
-                    shape=instance_type_str,
-                    display_name=
-                    f"{self.cluster_name}_{node_type}_{batch_id}_{seq}",
-                    freeform_tags=vm_tags,
-                    metadata={
-                        "ssh_authorized_keys": node_config["AuthorizedKey"]
-                    },
-                    source_details=oci_adaptor.get_oci(
-                    ).core.models.InstanceSourceViaImageDetails(
-                        source_type="image",
-                        image_id=node_config["ImageId"],
-                        boot_volume_size_in_gbs=node_config["BootVolumeSize"],
-                        boot_volume_vpus_per_gb=int(
-                            node_config["BootVolumePerf"]),
-                    ),
-                    create_vnic_details=oci_adaptor.get_oci(
-                    ).core.models.CreateVnicDetails(
-                        assign_public_ip=True,
-                        subnet_id=vcn,
-                    ),
-                    shape_config=machine_shape_config,
-                    preemptible_instance_config=preempitible_config,
-                ))
+                ).launch_instance(
+                    launch_instance_details=oci_adaptor.oci.core.models.
+                    LaunchInstanceDetails(
+                        availability_domain=node_config["AvailabilityDomain"],
+                        compartment_id=compartment,
+                        shape=instance_type_str,
+                        display_name=
+                        f"{self.cluster_name}_{node_type}_{batch_id}_{seq}",
+                        freeform_tags=vm_tags,
+                        metadata={
+                            "ssh_authorized_keys": node_config["AuthorizedKey"]
+                        },
+                        source_details=oci_adaptor.oci.core.models.
+                        InstanceSourceViaImageDetails(
+                            source_type="image",
+                            image_id=node_config["ImageId"],
+                            boot_volume_size_in_gbs=node_config[
+                                "BootVolumeSize"],
+                            boot_volume_vpus_per_gb=int(
+                                node_config["BootVolumePerf"]),
+                        ),
+                        create_vnic_details=oci_adaptor.oci.core.models.
+                        CreateVnicDetails(
+                            assign_public_ip=True,
+                            subnet_id=vcn,
+                        ),
+                        shape_config=machine_shape_config,
+                        preemptible_instance_config=preempitible_config,
+                    ))
 
                 new_inst = launch_instance_response.data
                 starting_insts.append({
                     "inst_id": new_inst.id,
                     "ad": new_inst.availability_domain,
                     "compartment": new_inst.compartment_id,
                     "lifecycle_state": new_inst.lifecycle_state,
@@ -350,15 +352,15 @@
         # end if count > 0:...
 
         for ninst in starting_insts:
             # Waiting for the instance to be RUNNING state
             get_instance_response = oci_adaptor.get_core_client(
                 self.region, oci_utils.oci_config.get_profile()).get_instance(
                     instance_id=ninst["inst_id"])
-            oci_adaptor.get_oci().wait_until(
+            oci_adaptor.oci.wait_until(
                 oci_adaptor.get_core_client(self.region,
                                             oci_utils.oci_config.get_profile()),
                 get_instance_response,
                 "lifecycle_state",
                 "RUNNING",
             )
             ninst["lifecycle_state"] = "RUNNING"
@@ -405,17 +407,16 @@
         retry_count = 0
         while retry_count < oci_utils.oci_config.MAX_RETRY_COUNT:
             try:
                 oci_adaptor.get_core_client(
                     self.region,
                     oci_utils.oci_config.get_profile()).update_instance(
                         instance_id=node_id,
-                        update_instance_details=oci_adaptor.get_oci().core.
-                        models.UpdateInstanceDetails(
-                            freeform_tags=combined_tags),
+                        update_instance_details=oci_adaptor.oci.core.models.
+                        UpdateInstanceDetails(freeform_tags=combined_tags),
                     )
                 logger.info(f"Tags are well set for node {node_id}")
                 break
             except Exception as e:
                 retry_count = retry_count + 1
                 wait_seconds = oci_utils.oci_config.RETRY_INTERVAL_BASE_SECONDS * retry_count
                 logger.warn(
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/oci/query_helper.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/oci/query_helper.py`

 * *Files 4% similar despite different names*

```diff
@@ -8,22 +8,27 @@
 """
 
 from datetime import datetime
 import logging
 import re
 import time
 import traceback
+import typing
 from typing import Optional
 
-import pandas as pd
-
+from sky.adaptors import common as adaptors_common
 from sky.adaptors import oci as oci_adaptor
 from sky.clouds.utils import oci_utils
 from sky.skylet.providers.oci import utils
 
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 logger = logging.getLogger(__name__)
 
 
 class oci_query_helper:
 
     # Call Cloud API to try getting the satisfied nodes.
     @classmethod
@@ -39,19 +44,18 @@
             where_clause_tags += (f"(freeformTags.key = '{tag_key}'"
                                   f" && freeformTags.value = '{tag_value}')")
 
         qv_str = (f"query instance resources where {where_clause_tags}"
                   f" && (lifecycleState != 'TERMINATED'"
                   f" && lifecycleState != 'TERMINATING')")
 
-        qv = oci_adaptor.get_oci(
-        ).resource_search.models.StructuredSearchDetails(
+        qv = oci_adaptor.oci.resource_search.models.StructuredSearchDetails(
             query=qv_str,
             type="Structured",
-            matching_context_type=oci_adaptor.get_oci().resource_search.models.
+            matching_context_type=oci_adaptor.oci.resource_search.models.
             SearchDetails.MATCHING_CONTEXT_TYPE_NONE,
         )
 
         list_instances_response = oci_adaptor.get_search_client(
             region, oci_utils.oci_config.get_profile()).search_resources(qv)
         result_set = list_instances_response.data.items
 
@@ -95,16 +99,16 @@
             region, oci_utils.oci_config.get_profile())
         try:
             agreements_response = core_client.get_app_catalog_listing_agreements(
                 listing_id=listing_id, resource_version=resource_version)
             agreements = agreements_response.data
 
             core_client.create_app_catalog_subscription(
-                create_app_catalog_subscription_details=oci_adaptor.get_oci(
-                ).core.models.CreateAppCatalogSubscriptionDetails(
+                create_app_catalog_subscription_details=oci_adaptor.oci.core.
+                models.CreateAppCatalogSubscriptionDetails(
                     compartment_id=compartment_id,
                     listing_id=listing_id,
                     listing_resource_version=agreements.
                     listing_resource_version,
                     oracle_terms_of_use_link=agreements.
                     oracle_terms_of_use_link,
                     time_retrieved=datetime.strptime(
@@ -198,44 +202,44 @@
 
     @classmethod
     @utils.debug_enabled(logger=logger)
     def create_vcn_subnet(cls, net_client,
                           skypilot_compartment) -> Optional[str]:
         try:
             create_vcn_response = net_client.create_vcn(
-                create_vcn_details=oci_adaptor.get_oci().core.models.
-                CreateVcnDetails(compartment_id=skypilot_compartment,
-                                 cidr_blocks=[oci_utils.oci_config.VCN_CIDR],
-                                 display_name=oci_utils.oci_config.VCN_NAME,
-                                 is_ipv6_enabled=False,
-                                 dns_label=oci_utils.oci_config.VCN_DNS_LABEL))
+                create_vcn_details=oci_adaptor.oci.core.models.CreateVcnDetails(
+                    compartment_id=skypilot_compartment,
+                    cidr_blocks=[oci_utils.oci_config.VCN_CIDR],
+                    display_name=oci_utils.oci_config.VCN_NAME,
+                    is_ipv6_enabled=False,
+                    dns_label=oci_utils.oci_config.VCN_DNS_LABEL))
             vcn_data = create_vcn_response.data
             logger.debug(f'Created VCN \n{vcn_data}')
             skypilot_vcn = vcn_data.id
             route_table = vcn_data.default_route_table_id
             security_list = vcn_data.default_security_list_id
             dhcp_options_id = vcn_data.default_dhcp_options_id
 
             # Create internet gateway for internet access
             create_ig_response = net_client.create_internet_gateway(
-                create_internet_gateway_details=oci_adaptor.get_oci(
-                ).core.models.CreateInternetGatewayDetails(
+                create_internet_gateway_details=oci_adaptor.oci.core.models.
+                CreateInternetGatewayDetails(
                     compartment_id=skypilot_compartment,
                     is_enabled=True,
                     vcn_id=skypilot_vcn,
-                    display_name=oci_utils.oci_config.VCN_INTERNET_GATEWAY_NAME)
-            )
+                    display_name=oci_utils.oci_config.VCN_INTERNET_GATEWAY_NAME
+                ))
             logger.debug(
                 f'Created internet gateway \n{create_ig_response.data}')
             ig = create_ig_response.data.id
 
             # Create a public subnet.
             create_subnet_response = net_client.create_subnet(
-                create_subnet_details=oci_adaptor.get_oci(
-                ).core.models.CreateSubnetDetails(
+                create_subnet_details=oci_adaptor.oci.core.models.
+                CreateSubnetDetails(
                     cidr_block=oci_utils.oci_config.VCN_SUBNET_CIDR,
                     compartment_id=skypilot_compartment,
                     vcn_id=skypilot_vcn,
                     dhcp_options_id=dhcp_options_id,
                     display_name=oci_utils.oci_config.VCN_SUBNET_NAME,
                     prohibit_internet_ingress=False,
                     prohibit_public_ip_on_vnic=False,
@@ -249,74 +253,74 @@
                 s for s in list_services_response.data
                 if str(s.cidr_block).startswith('all-') and str(s.cidr_block).
                 endswith('-services-in-oracle-services-network')
             ]
             if len(services) > 0:
                 # Create service gateway for regional services.
                 create_sg_response = net_client.create_service_gateway(
-                    create_service_gateway_details=oci_adaptor.get_oci(
-                    ).core.models.CreateServiceGatewayDetails(
+                    create_service_gateway_details=oci_adaptor.oci.core.models.
+                    CreateServiceGatewayDetails(
                         compartment_id=skypilot_compartment,
                         services=[
-                            oci_adaptor.get_oci().core.models.
-                            ServiceIdRequestDetails(service_id=services[0].id)
+                            oci_adaptor.oci.core.models.ServiceIdRequestDetails(
+                                service_id=services[0].id)
                         ],
                         vcn_id=skypilot_vcn))
                 logger.debug(f'Service Gateway: \n{create_sg_response.data}')
                 sg = create_sg_response.data.id
 
             # Update security list: Allow all traffic in the same subnet
             update_security_list_response = net_client.update_security_list(
                 security_list_id=security_list,
-                update_security_list_details=oci_adaptor.get_oci(
-                ).core.models.UpdateSecurityListDetails(ingress_security_rules=[
-                    oci_adaptor.get_oci().core.models.IngressSecurityRule(
+                update_security_list_details=oci_adaptor.oci.core.models.
+                UpdateSecurityListDetails(ingress_security_rules=[
+                    oci_adaptor.oci.core.models.IngressSecurityRule(
                         protocol="6",
                         source=oci_utils.oci_config.VCN_CIDR_INTERNET,
                         is_stateless=False,
                         source_type="CIDR_BLOCK",
-                        tcp_options=oci_adaptor.get_oci().core.models.
-                        TcpOptions(destination_port_range=oci_adaptor.get_oci().
-                                   core.models.PortRange(max=22, min=22),
-                                   source_port_range=oci_adaptor.get_oci(
-                                   ).core.models.PortRange(max=65535, min=1)),
+                        tcp_options=oci_adaptor.oci.core.models.TcpOptions(
+                            destination_port_range=oci_adaptor.oci.core.models.
+                            PortRange(max=22, min=22),
+                            source_port_range=oci_adaptor.oci.core.models.
+                            PortRange(max=65535, min=1)),
                         description="Allow SSH port."),
-                    oci_adaptor.get_oci().core.models.IngressSecurityRule(
+                    oci_adaptor.oci.core.models.IngressSecurityRule(
                         protocol="all",
                         source=oci_utils.oci_config.VCN_SUBNET_CIDR,
                         is_stateless=False,
                         source_type="CIDR_BLOCK",
                         description="Allow all traffic from/to same subnet."),
-                    oci_adaptor.get_oci().core.models.IngressSecurityRule(
+                    oci_adaptor.oci.core.models.IngressSecurityRule(
                         protocol="1",
                         source=oci_utils.oci_config.VCN_CIDR_INTERNET,
                         is_stateless=False,
                         source_type="CIDR_BLOCK",
-                        icmp_options=oci_adaptor.get_oci(
-                        ).core.models.IcmpOptions(type=3, code=4),
+                        icmp_options=oci_adaptor.oci.core.models.IcmpOptions(
+                            type=3, code=4),
                         description="ICMP traffic."),
-                    oci_adaptor.get_oci().core.models.IngressSecurityRule(
+                    oci_adaptor.oci.core.models.IngressSecurityRule(
                         protocol="1",
                         source=oci_utils.oci_config.VCN_CIDR,
                         is_stateless=False,
                         source_type="CIDR_BLOCK",
-                        icmp_options=oci_adaptor.get_oci(
-                        ).core.models.IcmpOptions(type=3),
+                        icmp_options=oci_adaptor.oci.core.models.IcmpOptions(
+                            type=3),
                         description="ICMP traffic (VCN)."),
                 ]))
             logger.debug(
                 f'Updated security_list: \n{update_security_list_response.data}'
             )
 
             # Update route table: bind to the internet gateway
             update_route_table_response = net_client.update_route_table(
                 rt_id=route_table,
-                update_route_table_details=oci_adaptor.get_oci(
-                ).core.models.UpdateRouteTableDetails(route_rules=[
-                    oci_adaptor.get_oci().core.models.RouteRule(
+                update_route_table_details=oci_adaptor.oci.core.models.
+                UpdateRouteTableDetails(route_rules=[
+                    oci_adaptor.oci.core.models.RouteRule(
                         network_entity_id=create_ig_response.data.id,
                         destination='0.0.0.0/0',
                         destination_type='CIDR_BLOCK',
                         description='Route table for SkyPilot VCN',
                         route_type='STATIC')
                 ]))
             logger.debug(f'Route table: \n{update_route_table_response.data}')
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/scp/config.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/scp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/providers/scp/node_provider.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/providers/scp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/ray_patches/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/ray_patches/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/ray_patches/log_monitor.py.patch` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/ray_patches/log_monitor.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/ray_patches/resource_demand_scheduler.py.patch` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/ray_patches/resource_demand_scheduler.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/ray_patches/worker.py.patch` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/ray_patches/worker.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/skylet.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skylet/subprocess_daemon.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skylet/subprocess_daemon.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/skypilot_config.py` & `skypilot-nightly-1.0.0.dev20240403/sky/skypilot_config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/spot/__init__.py` & `skypilot-nightly-1.0.0.dev20240403/sky/spot/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/spot/constants.py` & `skypilot-nightly-1.0.0.dev20240403/sky/spot/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/spot/controller.py` & `skypilot-nightly-1.0.0.dev20240403/sky/spot/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/spot/dashboard/dashboard.py` & `skypilot-nightly-1.0.0.dev20240403/sky/spot/dashboard/dashboard.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/spot/dashboard/static/favicon.ico` & `skypilot-nightly-1.0.0.dev20240403/sky/spot/dashboard/static/favicon.ico`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/spot/dashboard/templates/index.html` & `skypilot-nightly-1.0.0.dev20240403/sky/spot/dashboard/templates/index.html`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/spot/recovery_strategy.py` & `skypilot-nightly-1.0.0.dev20240403/sky/spot/recovery_strategy.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/spot/spot_state.py` & `skypilot-nightly-1.0.0.dev20240403/sky/spot/spot_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/spot/spot_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/spot/spot_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/status_lib.py` & `skypilot-nightly-1.0.0.dev20240403/sky/status_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/task.py` & `skypilot-nightly-1.0.0.dev20240403/sky/task.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/aws-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/aws-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/azure-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/azure-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/cudo-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/cudo-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/fluidstack-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/fluidstack-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/gcp-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/gcp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/ibm-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/ibm-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/kubernetes-ingress.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/kubernetes-ingress.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/kubernetes-port-forward-proxy-command.sh.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/kubernetes-port-forward-proxy-command.sh.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/kubernetes-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/kubernetes-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/kubernetes-ssh-jump.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/kubernetes-ssh-jump.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/lambda-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/lambda-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/local-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/local-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/oci-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/oci-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/paperspace-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/paperspace-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/runpod-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/runpod-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/scp-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/scp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/sky-serve-controller.yaml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/sky-serve-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/spot-controller.yaml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/spot-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/templates/vsphere-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240403/sky/templates/vsphere-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/usage/constants.py` & `skypilot-nightly-1.0.0.dev20240403/sky/usage/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/usage/usage_lib.py` & `skypilot-nightly-1.0.0.dev20240403/sky/usage/usage_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/accelerator_registry.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/accelerator_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/cli_utils/status_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/cli_utils/status_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/cluster_yaml_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/cluster_yaml_utils.py`

 * *Files 18% similar despite different names*

```diff
@@ -14,8 +14,11 @@
     # Examples:
     #   'sky.skylet.providers.aws.AWSNodeProviderV2' -> 'aws'
     #   'sky.provision.aws' -> 'aws'
     provider_search = re.search(r'(?:providers|provision)\.(\w+)\.?',
                                 provider_module)
     assert provider_search is not None, config
     provider_name = provider_search.group(1).lower()
+    # Special handling for lambda_cloud as Lambda cloud is registered as lambda.
+    if provider_name == 'lambda_cloud':
+        provider_name = 'lambda'
     return provider_name
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/command_runner.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/command_runner.pyi` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/command_runner.pyi`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/common_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/common_utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -319,15 +319,16 @@
         dump_func = yaml.dump
     return dump_func(config,
                      Dumper=LineBreakDumper,
                      sort_keys=False,
                      default_flow_style=False)
 
 
-def make_decorator(cls, name_or_fn: Union[str, Callable], **ctx_kwargs):
+def make_decorator(cls, name_or_fn: Union[str, Callable],
+                   **ctx_kwargs) -> Callable:
     """Make the cls a decorator.
 
     class cls:
         def __init__(self, name, **kwargs):
             pass
         def __enter__(self):
             pass
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/controller_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/controller_utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -142,16 +142,21 @@
     commands = [
         # aws
         'pip list | grep boto3 > /dev/null 2>&1 || '
         'pip install "urllib3<2" awscli>=1.27.10 botocore>=1.29.10 '
         'boto3>=1.26.1 > /dev/null 2>&1',
         # gcp
         'pip list | grep google-api-python-client > /dev/null 2>&1 || '
-        'pip install google-api-python-client>=2.69.0 google-cloud-storage '
+        'pip install google-api-python-client>=2.69.0 '
         '> /dev/null 2>&1',
+        # Have to separate the installation of google-cloud-storage from above
+        # because for a VM launched on GCP, the VM may have
+        # google-api-python-client installed alone.
+        'pip list | grep google-cloud-storage > /dev/null 2>&1 || '
+        'pip install google-cloud-storage > /dev/null 2>&1',
         f'{gcp.GOOGLE_SDK_INSTALLATION_COMMAND}',
         # fluidstack does not need to install any cloud dependencies.
     ]
     # k8s and ibm doesn't support open port and spot instance yet, so we don't
     # install them for either controller.
     if controller_type == 'spot':
         # oci doesn't support open port yet, so we don't install oci
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/dag_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/dag_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/db_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/db_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/env_options.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/env_options.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/create_cluster.sh` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/create_cluster.sh`

 * *Files 12% similar despite different names*

```diff
@@ -162,14 +162,39 @@
     echo "Pulling SkyPilot CPU image..."
     docker pull ${IMAGE}
     echo "Loading SkyPilot CPU image into kind cluster..."
     kind load docker-image --name skypilot ${IMAGE}
     echo "SkyPilot CPU image loaded into kind cluster."
 }
 
+wait_for_nginx_ingress_controller_install() {
+    echo "Starting installation of Nginx Ingress Controller..."
+
+    SECONDS=0
+    TIMEOUT=600  # 10 minutes in seconds
+
+    kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
+
+    while true; do
+        if kubectl get pod -n ingress-nginx -l app.kubernetes.io/component=controller -o wide | grep 'Running'; then
+            echo "Nginx Ingress Controller installed."
+            break
+        elif [ $SECONDS -ge $TIMEOUT ]; then
+            echo "Timed out waiting for installation of Nginx Ingress Controller."
+            exit 1
+        else
+            echo "Waiting for Nginx Ingress Controller Installation..."
+            echo "To check status, check Nginx Ingress Controller pods:"
+            echo "kubectl get pod -n ingress-nginx -l app.kubernetes.io/component=controller -o wide"
+            sleep 5
+        fi
+    done
+
+}
+
 if $ENABLE_GPUS; then
     echo "Enabling GPU support..."
     # Run patch for missing ldconfig.real
     # https://github.com/NVIDIA/nvidia-docker/issues/614#issuecomment-423991632
     docker exec -ti skypilot-control-plane ln -s /sbin/ldconfig /sbin/ldconfig.real
 
     echo "Installing NVIDIA GPU operator..."
@@ -192,14 +217,17 @@
     # Wait for all the GPU labeling jobs to complete
     wait_for_gpu_labeling_jobs
 fi
 
 # Load local skypilot image on to the cluster for faster startup
 wait_for_skypilot_cpu_image_pull
 
+# Install the Nginx Ingress Controller
+wait_for_nginx_ingress_controller_install
+
 # Print CPUs available on the local cluster
 NUM_CPUS=$(kubectl get nodes -o jsonpath='{.items[0].status.capacity.cpu}')
 echo "Kubernetes cluster ready! Run `sky check` to setup Kubernetes access."
 if $ENABLE_GPUS; then
     # As a sanity check, verify if GPU support is enabled
     if ! kubectl describe nodes | grep -q nvidia.com/gpu; then
         >&2 echo "GPU support was not enabled. Please check for any errors above."
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/delete_cluster.sh` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/delete_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/generate_kind_config.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/generate_kind_config.py`

 * *Files 10% similar despite different names*

```diff
@@ -27,15 +27,22 @@
     kubeadmConfigPatches:
     - |
       kind: ClusterConfiguration
       apiServer:
         extraArgs:
           "service-node-port-range": {port_start}-{port_end}
     nodes:
-    - role: control-plane""")
+    - role: control-plane
+      kubeadmConfigPatches:
+      - |
+        kind: InitConfiguration
+        nodeRegistration:
+          kubeletExtraArgs:
+            node-labels: "ingress-ready=true"
+    """)
     if gpus:
         preamble += textwrap.indent(
             textwrap.dedent("""
         extraMounts:
         - hostPath: /dev/null
           containerPath: /var/run/nvidia-container-devices/all"""), ' ' * 2)
     preamble += textwrap.indent(
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/gpu_labeler.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/gpu_labeler.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/kubernetes_enums.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/kubernetes_enums.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/log_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/log_utils.py`

 * *Files 5% similar despite different names*

```diff
@@ -112,14 +112,21 @@
                         f'{colorama.Style.RESET_ALL}')
         if 'Pulling SkyPilot CPU image...' in log_line:
             self.status_display.update('[bold cyan]Creating local cluster - '
                                        'pulling and loading SkyPilot CPU image')
         if 'SkyPilot CPU image loaded into kind cluster' in log_line:
             logger.info(f'{colorama.Fore.GREEN}SkyPilot CPU image pulled.'
                         f'{colorama.Style.RESET_ALL}')
+        if 'Starting installation of Nginx Ingress Controller...' in log_line:
+            self.status_display.update(
+                '[bold cyan]Creating Nginx Ingress Controller')
+        if 'Nginx Ingress Controller installed' in log_line:
+            logger.info(
+                f'{colorama.Fore.GREEN}Nginx Ingress Controller installed.'
+                f'{colorama.Style.RESET_ALL}')
 
     def __exit__(self, except_type, except_value, traceback):
         del except_type, except_value, traceback  # unused
         self.status_display.stop()
 
 
 def create_table(field_names: List[str], **kwargs) -> prettytable.PrettyTable:
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/resources_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/resources_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/rich_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/rich_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/schemas.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/schemas.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/subprocess_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/subprocess_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/timeline.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/timeline.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/ux_utils.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/ux_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/sky/utils/validator.py` & `skypilot-nightly-1.0.0.dev20240403/sky/utils/validator.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/skypilot_nightly.egg-info/PKG-INFO` & `skypilot-nightly-1.0.0.dev20240403/skypilot_nightly.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240402
+Version: 1.0.0.dev20240403
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
@@ -87,14 +87,15 @@
 Requires-Dist: protobuf!=3.19.5,>=3.15.3; extra == "remote"
 Requires-Dist: pydantic!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3; extra == "remote"
 Provides-Extra: runpod
 Requires-Dist: runpod>=1.5.1; extra == "runpod"
 Provides-Extra: fluidstack
 Provides-Extra: cudo
 Requires-Dist: cudo-compute>=0.1.8; extra == "cudo"
+Provides-Extra: paperspace
 Provides-Extra: vsphere
 Requires-Dist: pyvmomi==8.0.1.0.2; extra == "vsphere"
 Provides-Extra: all
 Requires-Dist: urllib3<2; extra == "all"
 Requires-Dist: awscli>=1.27.10; extra == "all"
 Requires-Dist: botocore>=1.29.10; extra == "all"
 Requires-Dist: boto3>=1.26.1; extra == "all"
@@ -196,22 +197,22 @@
 * [Optimizer](https://skypilot.readthedocs.io/en/latest/examples/auto-failover.html): 2x cost savings by auto-picking the cheapest VM/zone/region/cloud
 * [Autostop](https://skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup of idle clusters
 
 SkyPilot supports your existing GPU, TPU, and CPU workloads, with no code changes.
 
 Install with pip (we recommend the nightly build for the latest features or [from source](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html)):
 ```bash
-pip install "skypilot-nightly[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]"  # choose your clouds
+pip install "skypilot-nightly[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"  # choose your clouds
 ```
 To get the last release, use:
 ```bash
-pip install -U "skypilot[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]"  # choose your clouds
+pip install -U "skypilot[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"  # choose your clouds
 ```
 
-Current supported providers (AWS, Azure, GCP, OCI, Lambda Cloud, RunPod, Fluidstack, Cudo, IBM, Samsung, Cloudflare, any Kubernetes cluster):
+Current supported providers (AWS, Azure, GCP, OCI, Lambda Cloud, RunPod, Fluidstack, Paperspace, Cudo, IBM, Samsung, Cloudflare, any Kubernetes cluster):
 <p align="center">
   <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/cloud-logos-light.png" width=85%>
 </p>
 
 
 ## Getting Started
 You can find our documentation [here](https://skypilot.readthedocs.io/en/latest/).
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/skypilot_nightly.egg-info/SOURCES.txt` & `skypilot-nightly-1.0.0.dev20240403/skypilot_nightly.egg-info/SOURCES.txt`

 * *Files 1% similar despite different names*

```diff
@@ -19,14 +19,15 @@
 sky/skypilot_config.py
 sky/status_lib.py
 sky/task.py
 sky/adaptors/__init__.py
 sky/adaptors/aws.py
 sky/adaptors/azure.py
 sky/adaptors/cloudflare.py
+sky/adaptors/common.py
 sky/adaptors/cudo.py
 sky/adaptors/docker.py
 sky/adaptors/gcp.py
 sky/adaptors/ibm.py
 sky/adaptors/kubernetes.py
 sky/adaptors/oci.py
 sky/adaptors/runpod.py
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/skypilot_nightly.egg-info/requires.txt` & `skypilot-nightly-1.0.0.dev20240403/skypilot_nightly.egg-info/requires.txt`

 * *Files 1% similar despite different names*

```diff
@@ -105,14 +105,16 @@
 [lambda]
 ray[default]!=2.6.0,<=2.9.3,>=2.2.0
 
 [oci]
 oci
 ray[default]!=2.6.0,<=2.9.3,>=2.2.0
 
+[paperspace]
+
 [remote]
 protobuf!=3.19.5,>=3.15.3
 pydantic!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3
 
 [remote:python_version < "3.10" and sys_platform != "darwin"]
 grpcio!=1.48.0,<=1.51.3,>=1.32.0
```

### Comparing `skypilot-nightly-1.0.0.dev20240402/tests/test_cli.py` & `skypilot-nightly-1.0.0.dev20240403/tests/test_cli.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/tests/test_config.py` & `skypilot-nightly-1.0.0.dev20240403/tests/test_config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/tests/test_jobs.py` & `skypilot-nightly-1.0.0.dev20240403/tests/test_jobs.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/tests/test_list_accelerators.py` & `skypilot-nightly-1.0.0.dev20240403/tests/test_list_accelerators.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/tests/test_optimizer_dryruns.py` & `skypilot-nightly-1.0.0.dev20240403/tests/test_optimizer_dryruns.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/tests/test_optimizer_random_dag.py` & `skypilot-nightly-1.0.0.dev20240403/tests/test_optimizer_random_dag.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/tests/test_serve_autoscaler.py` & `skypilot-nightly-1.0.0.dev20240403/tests/test_serve_autoscaler.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/tests/test_smoke.py` & `skypilot-nightly-1.0.0.dev20240403/tests/test_smoke.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/tests/test_spot_serve.py` & `skypilot-nightly-1.0.0.dev20240403/tests/test_spot_serve.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/tests/test_storage.py` & `skypilot-nightly-1.0.0.dev20240403/tests/test_storage.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/tests/test_wheels.py` & `skypilot-nightly-1.0.0.dev20240403/tests/test_wheels.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240402/tests/test_yaml_parser.py` & `skypilot-nightly-1.0.0.dev20240403/tests/test_yaml_parser.py`

 * *Files identical despite different names*

