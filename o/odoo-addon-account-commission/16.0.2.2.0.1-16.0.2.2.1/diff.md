# Comparing `tmp/odoo_addon_account_commission-16.0.2.2.0.1-py3-none-any.whl.zip` & `tmp/odoo_addon_account_commission-16.0.2.2.1-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,43 +1,43 @@
-Zip file size: 73831 bytes, number of entries: 41
--rw-r--r--  2.0 unx     5964 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/README.rst
--rw-r--r--  2.0 unx       64 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/__init__.py
--rw-r--r--  2.0 unx      893 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/__manifest__.py
--rw-r--r--  2.0 unx      361 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/data/menuitem_data.xml
--rw-r--r--  2.0 unx    21955 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/i18n/account_commission.pot
--rw-r--r--  2.0 unx    24802 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/i18n/es.po
--rw-r--r--  2.0 unx    22102 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/i18n/hr.po
--rw-r--r--  2.0 unx    24522 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/i18n/it.po
--rw-r--r--  2.0 unx    24651 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/i18n/ja.po
--rw-r--r--  2.0 unx    24514 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/i18n/pt.po
--rw-r--r--  2.0 unx    24504 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/i18n/pt_BR.po
--rw-r--r--  2.0 unx       88 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/models/__init__.py
--rw-r--r--  2.0 unx     9198 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/models/account_move.py
--rw-r--r--  2.0 unx      562 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/models/commission.py
--rw-r--r--  2.0 unx     7177 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/models/commission_settlement.py
--rw-r--r--  2.0 unx      287 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/readme/CONFIGURE.rst
--rw-r--r--  2.0 unx      667 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx      208 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx     1798 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/readme/USAGE.rst
--rw-r--r--  2.0 unx       34 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/report/__init__.py
--rw-r--r--  2.0 unx     3915 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/report/commission_analysis.py
--rw-r--r--  2.0 unx     5289 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/report/commission_analysis_view.xml
--rw-r--r--  2.0 unx     1418 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/security/account_commission_security.xml
--rw-r--r--  2.0 unx      883 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/security/ir.model.access.csv
--rw-r--r--  2.0 unx     8219 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/static/description/icon.png
--rw-r--r--  2.0 unx    17220 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/static/description/icon.svg
--rw-r--r--  2.0 unx    16898 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/static/description/index.html
--rw-r--r--  2.0 unx       38 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/tests/__init__.py
--rw-r--r--  2.0 unx    22008 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/tests/test_account_commission.py
--rw-r--r--  2.0 unx     6600 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/views/account_move_views.xml
--rw-r--r--  2.0 unx     3496 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/views/commission_settlement_views.xml
--rw-r--r--  2.0 unx      614 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/views/commission_views.xml
--rw-r--r--  2.0 unx     1781 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/views/report_settlement_templates.xml
--rw-r--r--  2.0 unx       66 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/wizards/__init__.py
--rw-r--r--  2.0 unx     1717 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/wizards/commission_make_settle.py
--rw-r--r--  2.0 unx     3162 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/wizards/wizard_invoice.py
--rw-r--r--  2.0 unx     2292 b- defN 24-Jan-20 03:13 odoo/addons/account_commission/wizards/wizard_invoice.xml
--rw-r--r--  2.0 unx     6552 b- defN 24-Jan-20 03:13 odoo_addon_account_commission-16.0.2.2.0.1.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 24-Jan-20 03:13 odoo_addon_account_commission-16.0.2.2.0.1.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 24-Jan-20 03:13 odoo_addon_account_commission-16.0.2.2.0.1.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     4494 b- defN 24-Jan-20 03:13 odoo_addon_account_commission-16.0.2.2.0.1.dist-info/RECORD
-41 files, 301110 bytes uncompressed, 66245 bytes compressed:  78.0%
+Zip file size: 74592 bytes, number of entries: 41
+-rw-r--r--  2.0 unx     6143 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/README.rst
+-rw-r--r--  2.0 unx       64 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/__init__.py
+-rw-r--r--  2.0 unx      893 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/__manifest__.py
+-rw-r--r--  2.0 unx      361 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/data/menuitem_data.xml
+-rw-r--r--  2.0 unx    21969 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/i18n/account_commission.pot
+-rw-r--r--  2.0 unx    24802 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/i18n/es.po
+-rw-r--r--  2.0 unx    22102 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/i18n/hr.po
+-rw-r--r--  2.0 unx    24522 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/i18n/it.po
+-rw-r--r--  2.0 unx    24651 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/i18n/ja.po
+-rw-r--r--  2.0 unx    24514 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/i18n/pt.po
+-rw-r--r--  2.0 unx    24504 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/i18n/pt_BR.po
+-rw-r--r--  2.0 unx       88 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/models/__init__.py
+-rw-r--r--  2.0 unx     9198 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/models/account_move.py
+-rw-r--r--  2.0 unx      576 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/models/commission.py
+-rw-r--r--  2.0 unx     7177 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/models/commission_settlement.py
+-rw-r--r--  2.0 unx      466 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/readme/CONFIGURE.rst
+-rw-r--r--  2.0 unx      667 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx      208 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx     1798 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/readme/USAGE.rst
+-rw-r--r--  2.0 unx       34 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/report/__init__.py
+-rw-r--r--  2.0 unx     3915 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/report/commission_analysis.py
+-rw-r--r--  2.0 unx     5289 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/report/commission_analysis_view.xml
+-rw-r--r--  2.0 unx     1418 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/security/account_commission_security.xml
+-rw-r--r--  2.0 unx      883 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/security/ir.model.access.csv
+-rw-r--r--  2.0 unx     8219 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/static/description/icon.png
+-rw-r--r--  2.0 unx    17220 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/static/description/icon.svg
+-rw-r--r--  2.0 unx    17067 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/static/description/index.html
+-rw-r--r--  2.0 unx       38 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/tests/__init__.py
+-rw-r--r--  2.0 unx    27141 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/tests/test_account_commission.py
+-rw-r--r--  2.0 unx     6600 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/views/account_move_views.xml
+-rw-r--r--  2.0 unx     3496 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/views/commission_settlement_views.xml
+-rw-r--r--  2.0 unx      614 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/views/commission_views.xml
+-rw-r--r--  2.0 unx     1781 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/views/report_settlement_templates.xml
+-rw-r--r--  2.0 unx       66 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/wizards/__init__.py
+-rw-r--r--  2.0 unx     1717 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/wizards/commission_make_settle.py
+-rw-r--r--  2.0 unx     3162 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/wizards/wizard_invoice.py
+-rw-r--r--  2.0 unx     2292 b- defN 24-Apr-03 10:25 odoo/addons/account_commission/wizards/wizard_invoice.xml
+-rw-r--r--  2.0 unx     6729 b- defN 24-Apr-03 10:25 odoo_addon_account_commission-16.0.2.2.1.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 24-Apr-03 10:25 odoo_addon_account_commission-16.0.2.2.1.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 24-Apr-03 10:25 odoo_addon_account_commission-16.0.2.2.1.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     4486 b- defN 24-Apr-03 10:25 odoo_addon_account_commission-16.0.2.2.1.dist-info/RECORD
+41 files, 306967 bytes uncompressed, 67022 bytes compressed:  78.2%
```

## zipnote {}

```diff
@@ -105,20 +105,20 @@
 
 Filename: odoo/addons/account_commission/wizards/wizard_invoice.py
 Comment: 
 
 Filename: odoo/addons/account_commission/wizards/wizard_invoice.xml
 Comment: 
 
-Filename: odoo_addon_account_commission-16.0.2.2.0.1.dist-info/METADATA
+Filename: odoo_addon_account_commission-16.0.2.2.1.dist-info/METADATA
 Comment: 
 
-Filename: odoo_addon_account_commission-16.0.2.2.0.1.dist-info/WHEEL
+Filename: odoo_addon_account_commission-16.0.2.2.1.dist-info/WHEEL
 Comment: 
 
-Filename: odoo_addon_account_commission-16.0.2.2.0.1.dist-info/top_level.txt
+Filename: odoo_addon_account_commission-16.0.2.2.1.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo_addon_account_commission-16.0.2.2.0.1.dist-info/RECORD
+Filename: odoo_addon_account_commission-16.0.2.2.1.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/account_commission/README.rst

```diff
@@ -3,15 +3,15 @@
 ===================
 
 .. 
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !! This file is generated by oca-gen-addon-readme !!
    !! changes will be overwritten.                   !!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-   !! source digest: sha256:aebcf65d67c56dd22612b39b8beddce430bbf62d966760b7e5381d914fe4cb14
+   !! source digest: sha256:77299b3b65fc7979bfd7818c3aed06a5912134599c1e0469f00ed5f220b2b5be
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 
 .. |badge1| image:: https://img.shields.io/badge/maturity-Beta-yellow.png
     :target: https://odoo-community.org/page/development-status
     :alt: Beta
 .. |badge2| image:: https://img.shields.io/badge/licence-AGPL--3-blue.png
     :target: http://www.gnu.org/licenses/agpl-3.0-standalone.html
@@ -43,15 +43,17 @@
 =============
 
 For selecting invoice status in commissions:
 
 #. Edit or create a new record to select the invoice status for settling the commissions.
 
    * **Invoice Based**: Commissions are settled when the invoice is issued.
-   * **Payment Based**: Commissions are settled when the invoice is paid.
+   * **Payment Based**: Commissions are settled when the invoice is paid or refunded.
+     Note that when refunding an invoice, the corresponding reversed commission will
+     be settled as well, resulting in a 0 net commission between both operations.
 
 Usage
 =====
 
 For adding commissions on invoices:
 
 #. Go to *Invoicing > Customers > Invoices*.
```

## odoo/addons/account_commission/__manifest__.py

```diff
@@ -1,13 +1,13 @@
 # Copyright 2020 Tecnativa - Manuel Calero
 # Copyright 2022 Quartile
 # Copyright 2014-2022 Tecnativa - Pedro M. Baeza
 {
     "name": "Account commissions",
-    "version": "16.0.2.2.0",
+    "version": "16.0.2.2.1",
     "author": "Tecnativa, Odoo Community Association (OCA)",
     "category": "Sales Management",
     "license": "AGPL-3",
     "depends": [
         "account",
         "commission",
     ],
```

## odoo/addons/account_commission/i18n/account_commission.pot

```diff
@@ -435,15 +435,15 @@
 msgstr ""
 
 #. module: account_commission
 #: model:ir.model.fields,help:account_commission.field_commission__invoice_state
 msgid ""
 "Select the invoice status for settling the commissions:\n"
 "* 'Invoice Based': Commissions are settled when the invoice is issued.\n"
-"* 'Payment Based': Commissions are settled when the invoice is paid."
+"* 'Payment Based': Commissions are settled when the invoice is paid (or refunded)."
 msgstr ""
 
 #. module: account_commission
 #: model:ir.model.fields,field_description:account_commission.field_account_invoice_line_agent__settled
 #: model:ir.model.fields,field_description:account_commission.field_invoice_commission_analysis_report__settled
 #: model_terms:ir.ui.view,arch_db:account_commission.view_invoice_commission_analysis_search
 msgid "Settled"
```

## odoo/addons/account_commission/models/commission.py

```diff
@@ -8,9 +8,9 @@
 
     invoice_state = fields.Selection(
         [("open", "Invoice Based"), ("paid", "Payment Based")],
         string="Invoice Status",
         default="open",
         help="Select the invoice status for settling the commissions:\n"
         "* 'Invoice Based': Commissions are settled when the invoice is issued.\n"
-        "* 'Payment Based': Commissions are settled when the invoice is paid.",
+        "* 'Payment Based': Commissions are settled when the invoice is paid (or refunded).",
     )
```

## odoo/addons/account_commission/readme/CONFIGURE.rst

```diff
@@ -1,6 +1,8 @@
 For selecting invoice status in commissions:
 
 #. Edit or create a new record to select the invoice status for settling the commissions.
 
    * **Invoice Based**: Commissions are settled when the invoice is issued.
-   * **Payment Based**: Commissions are settled when the invoice is paid.
+   * **Payment Based**: Commissions are settled when the invoice is paid or refunded.
+     Note that when refunding an invoice, the corresponding reversed commission will
+     be settled as well, resulting in a 0 net commission between both operations.
```

## odoo/addons/account_commission/static/description/index.html

```diff
@@ -362,15 +362,15 @@
 <div class="document" id="account-commissions">
 <h1 class="title">Account commissions</h1>
 
 <!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 !! This file is generated by oca-gen-addon-readme !!
 !! changes will be overwritten.                   !!
 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-!! source digest: sha256:aebcf65d67c56dd22612b39b8beddce430bbf62d966760b7e5381d914fe4cb14
+!! source digest: sha256:77299b3b65fc7979bfd7818c3aed06a5912134599c1e0469f00ed5f220b2b5be
 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
 <p><a class="reference external image-reference" href="https://odoo-community.org/page/development-status"><img alt="Beta" src="https://img.shields.io/badge/maturity-Beta-yellow.png" /></a> <a class="reference external image-reference" href="http://www.gnu.org/licenses/agpl-3.0-standalone.html"><img alt="License: AGPL-3" src="https://img.shields.io/badge/licence-AGPL--3-blue.png" /></a> <a class="reference external image-reference" href="https://github.com/OCA/commission/tree/16.0/account_commission"><img alt="OCA/commission" src="https://img.shields.io/badge/github-OCA%2Fcommission-lightgray.png?logo=github" /></a> <a class="reference external image-reference" href="https://translation.odoo-community.org/projects/commission-16-0/commission-16-0-account_commission"><img alt="Translate me on Weblate" src="https://img.shields.io/badge/weblate-Translate%20me-F47D42.png" /></a> <a class="reference external image-reference" href="https://runboat.odoo-community.org/builds?repo=OCA/commission&amp;target_branch=16.0"><img alt="Try me on Runboat" src="https://img.shields.io/badge/runboat-Try%20me-875A7B.png" /></a></p>
 <p>This module adds the function to calculate commissions in invoices (account moves).</p>
 <p>It also allows to create vendor bills from settlements for external agents.</p>
 <p>This module depends on the commission module.</p>
 <p><strong>Table of contents</strong></p>
 <div class="contents local topic" id="contents">
@@ -388,15 +388,17 @@
 </div>
 <div class="section" id="configuration">
 <h1><a class="toc-backref" href="#toc-entry-1">Configuration</a></h1>
 <p>For selecting invoice status in commissions:</p>
 <ol class="arabic simple">
 <li>Edit or create a new record to select the invoice status for settling the commissions.<ul>
 <li><strong>Invoice Based</strong>: Commissions are settled when the invoice is issued.</li>
-<li><strong>Payment Based</strong>: Commissions are settled when the invoice is paid.</li>
+<li><strong>Payment Based</strong>: Commissions are settled when the invoice is paid or refunded.
+Note that when refunding an invoice, the corresponding reversed commission will
+be settled as well, resulting in a 0 net commission between both operations.</li>
 </ul>
 </li>
 </ol>
 </div>
 <div class="section" id="usage">
 <h1><a class="toc-backref" href="#toc-entry-2">Usage</a></h1>
 <p>For adding commissions on invoices:</p>
```

### html2text {}

```diff
@@ -14,15 +14,18 @@
           o _C_o_n_t_r_i_b_u_t_o_r_s
           o _M_a_i_n_t_a_i_n_e_r_s
 ************ _CC_oo_nn_ff_ii_gg_uu_rr_aa_tt_ii_oo_nn ************
 For selecting invoice status in commissions:
    1. Edit or create a new record to select the invoice status for settling the
       commissions.
           o IInnvvooiiccee BBaasseedd: Commissions are settled when the invoice is issued.
-          o PPaayymmeenntt BBaasseedd: Commissions are settled when the invoice is paid.
+          o PPaayymmeenntt BBaasseedd: Commissions are settled when the invoice is paid or
+            refunded. Note that when refunding an invoice, the corresponding
+            reversed commission will be settled as well, resulting in a 0 net
+            commission between both operations.
 ************ _UU_ss_aa_gg_ee ************
 For adding commissions on invoices:
    1. Go to IInnvvooiicciinngg >> CCuussttoommeerrss >> IInnvvooiicceess.
    2. Edit or create a new record.
    3. When you have selected a partner, each new invoice line you add will have
       the agents and commissions set at customer level.
    4. You can add, modify or delete these agents discretely clicking on the
```

## odoo/addons/account_commission/tests/test_account_commission.py

```diff
@@ -3,15 +3,15 @@
 # Copyright 2016-2022 Tecnativa - Pedro M. Baeza
 # License AGPL-3 - See https://www.gnu.org/licenses/agpl-3.0.html
 
 from dateutil.relativedelta import relativedelta
 
 from odoo import fields
 from odoo.exceptions import UserError, ValidationError
-from odoo.tests import tagged
+from odoo.tests import Form, tagged
 
 from odoo.addons.commission.tests.test_commission import TestCommissionBase
 
 
 @tagged("post_install", "-at_install")
 class TestAccountCommission(TestCommissionBase):
     @classmethod
@@ -528,7 +528,134 @@
         settlements = self.settle_model.search(
             [
                 ("agent_id", "=", agent.id),
                 ("state", "=", "settled"),
             ]
         )
         self.assertEqual(2, len(settlements))
+
+    def test_invoice_partial_refund(self):
+        commission = self.commission_net_paid
+        agent = self.agent_monthly
+        today = fields.Date.today()
+        # Create an invoice
+        invoice = self._create_invoice(agent, commission, today, currency=None)
+        invoice.action_post()
+        # Register payment for invoice
+        payment_journal = self.env["account.journal"].search(
+            [("type", "=", "cash"), ("company_id", "=", invoice.company_id.id)],
+            limit=1,
+        )
+        register_payments = (
+            self.env["account.payment.register"]
+            .with_context(active_ids=invoice.id, active_model="account.move")
+            .create({"journal_id": payment_journal.id})
+        )
+        register_payments.action_create_payments()
+        # Make a parcial refund for the invoice
+        move_reversal = (
+            self.env["account.move.reversal"]
+            .with_context(active_model="account.move", active_ids=invoice.id)
+            .create(
+                {
+                    "reason": "no reason",
+                    "refund_method": "refund",
+                    "journal_id": invoice.journal_id.id,
+                }
+            )
+        )
+        refund_form = Form(
+            self.env["account.move"].browse(move_reversal.reverse_moves()["res_id"])
+        )
+        with refund_form.invoice_line_ids.edit(0) as line:
+            line.price_unit -= 2
+        refund = refund_form.save()
+        refund.action_post()
+        # Register payment for the refund
+        register_payments = (
+            self.env["account.payment.register"]
+            .with_context(active_ids=refund.id, active_model="account.move")
+            .create({"journal_id": payment_journal.id})
+        )
+        register_payments.action_create_payments()
+        # check settlement creation. The commission must be (5 - 3) * 0.2 = 0.4
+        self._settle_agent_invoice(agent, 1)
+        settlements = self.settle_model.search([("agent_id", "=", agent.id)])
+        self.assertEqual(2, len(settlements.line_ids))
+        self.assertEqual(0.4, sum(settlements.mapped("total")))
+
+    def test_invoice_full_refund(self):
+        commission = self.commission_net_paid
+        agent = self.agent_monthly
+        today = fields.Date.today()
+        # Create an invoice and refund it
+        invoice = self._create_invoice(agent, commission, today, currency=None)
+        invoice.action_post()
+        move_reversal = (
+            self.env["account.move.reversal"]
+            .with_context(active_model="account.move", active_ids=invoice.id)
+            .create(
+                {
+                    "reason": "no reason",
+                    "refund_method": "cancel",
+                    "journal_id": invoice.journal_id.id,
+                }
+            )
+        )
+        move_reversal.reverse_moves()
+        # check settlement creation. The commission must be: (5 - 5) * 0.2 = 0
+        self._settle_agent_invoice(agent, 1)
+        settlements = self.settle_model.search(
+            [
+                ("agent_id", "=", agent.id),
+            ]
+        )
+        self.assertEqual(2, len(settlements.line_ids))
+        self.assertEqual(0, sum(settlements.mapped("total")))
+
+    def test_invoice_modify_refund(self):
+        commission = self.commission_net_paid
+        agent = self.agent_monthly
+        today = fields.Date.today()
+        # Create an invoice
+        invoice = self._create_invoice(agent, commission, today, currency=None)
+        invoice.action_post()
+        # Create a full refund and a new invoice
+        move_reversal = (
+            self.env["account.move.reversal"]
+            .with_context(active_model="account.move", active_ids=invoice.id)
+            .create(
+                {
+                    "reason": "no reason",
+                    "refund_method": "modify",
+                    "journal_id": invoice.journal_id.id,
+                }
+            )
+        )
+        invoice2_form = Form(
+            self.env["account.move"].browse(move_reversal.reverse_moves()["res_id"])
+        )
+        with invoice2_form.invoice_line_ids.edit(0) as line:
+            line.price_unit -= 2
+        invoice2 = invoice2_form.save()
+        invoice2.action_post()
+        # Register payment for the new invoice
+        payment_journal = self.env["account.journal"].search(
+            [("type", "=", "cash"), ("company_id", "=", invoice.company_id.id)],
+            limit=1,
+        )
+        register_payments = (
+            self.env["account.payment.register"]
+            .with_context(active_ids=invoice2.id, active_model="account.move")
+            .create({"journal_id": payment_journal.id})
+        )
+        register_payments.action_create_payments()
+
+        # check settlement creation. The commission must be (5 - 5 + 3) * 0.2 = 0.6
+        self._settle_agent_invoice(agent, 1)
+        settlements = self.settle_model.search(
+            [
+                ("agent_id", "=", agent.id),
+            ]
+        )
+        self.assertEqual(3, len(settlements.line_ids))
+        self.assertAlmostEqual(0.6, sum(settlements.mapped("total")), 2)
```

## Comparing `odoo_addon_account_commission-16.0.2.2.0.1.dist-info/METADATA` & `odoo_addon_account_commission-16.0.2.2.1.dist-info/METADATA`

 * *Files 3% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: odoo-addon-account-commission
-Version: 16.0.2.2.0.1
+Version: 16.0.2.2.1
 Summary: Account commissions
 Home-page: https://github.com/OCA/commission
 Author: Tecnativa, Odoo Community Association (OCA)
 Author-email: support@odoo-community.org
 License: AGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
@@ -20,15 +20,15 @@
 ===================
 
 .. 
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !! This file is generated by oca-gen-addon-readme !!
    !! changes will be overwritten.                   !!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-   !! source digest: sha256:aebcf65d67c56dd22612b39b8beddce430bbf62d966760b7e5381d914fe4cb14
+   !! source digest: sha256:77299b3b65fc7979bfd7818c3aed06a5912134599c1e0469f00ed5f220b2b5be
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 
 .. |badge1| image:: https://img.shields.io/badge/maturity-Beta-yellow.png
     :target: https://odoo-community.org/page/development-status
     :alt: Beta
 .. |badge2| image:: https://img.shields.io/badge/licence-AGPL--3-blue.png
     :target: http://www.gnu.org/licenses/agpl-3.0-standalone.html
@@ -60,15 +60,17 @@
 =============
 
 For selecting invoice status in commissions:
 
 #. Edit or create a new record to select the invoice status for settling the commissions.
 
    * **Invoice Based**: Commissions are settled when the invoice is issued.
-   * **Payment Based**: Commissions are settled when the invoice is paid.
+   * **Payment Based**: Commissions are settled when the invoice is paid or refunded.
+     Note that when refunding an invoice, the corresponding reversed commission will
+     be settled as well, resulting in a 0 net commission between both operations.
 
 Usage
 =====
 
 For adding commissions on invoices:
 
 #. Go to *Invoicing > Customers > Invoices*.
```

## Comparing `odoo_addon_account_commission-16.0.2.2.0.1.dist-info/RECORD` & `odoo_addon_account_commission-16.0.2.2.1.dist-info/RECORD`

 * *Files 3% similar despite different names*

```diff
@@ -1,41 +1,41 @@
-odoo/addons/account_commission/README.rst,sha256=9GJMhy4HpARjkITw5ZL3Tg6Bn8vInvnKSCWwR8OuMzE,5964
+odoo/addons/account_commission/README.rst,sha256=yrN_glpY0JN2HsDPh6AGoq_tBuisbi2CQx5WpX6D4yg,6143
 odoo/addons/account_commission/__init__.py,sha256=8JG3SPnwMlgXTppOwkp3YTgDDQGo7U7veMEMpG1bL_c,64
-odoo/addons/account_commission/__manifest__.py,sha256=DqmhUIrB1VC7rC_kSalfm8lyb0H2Ub_ftkGtjnOJe7c,893
+odoo/addons/account_commission/__manifest__.py,sha256=LYhfoiheaRMmpLKQm9b32TW0L3amYfCu4MefuAEYcA4,893
 odoo/addons/account_commission/data/menuitem_data.xml,sha256=OX8KpilSn3zWf9cMNiJLDO7aV_vtaH6GTIyMZWDxYqM,361
-odoo/addons/account_commission/i18n/account_commission.pot,sha256=FJXrWRpZL3TTTlcYsSadekfVafl28riCk9wMxJP8I1g,21955
+odoo/addons/account_commission/i18n/account_commission.pot,sha256=YM_lHjaDADe8EjFteiOtG5wRZutjZuvuXy8P7hCbZRU,21969
 odoo/addons/account_commission/i18n/es.po,sha256=Ph1GCvKqbAc2ejPfGACqmwF81HP0m5UrBRCbdFjopok,24802
 odoo/addons/account_commission/i18n/hr.po,sha256=Q0fYDpbCdxtKNvJ1ElqlOG_Yprpkf5_uBCL5bl2R46g,22102
 odoo/addons/account_commission/i18n/it.po,sha256=-bMDQcj7sjtmzmDcr-w7xUWKq0FkEgk95Fnkfc7hTN8,24522
 odoo/addons/account_commission/i18n/ja.po,sha256=BQv8Nzq_Q26TCWM-GhKTvOUnRQignYu3pVYaaq1_YN4,24651
 odoo/addons/account_commission/i18n/pt.po,sha256=LULptNZCEkKt1JLTcf_slnnh_fYNyOWhfRzObKacn-k,24514
 odoo/addons/account_commission/i18n/pt_BR.po,sha256=UmMTEJy8d-W7yEZbSh2bHlFMi3RczRQt85vYVsSQ9iI,24504
 odoo/addons/account_commission/models/__init__.py,sha256=NAnZVtdmEwISK51Ipnoin5jHE3_bVPLsNghvuFcM3NI,88
 odoo/addons/account_commission/models/account_move.py,sha256=6P9SkOsurOvxTY4eA3hv72pHK95u1wYrkVYsLkSyJz4,9198
-odoo/addons/account_commission/models/commission.py,sha256=AIEMAKgRh8JegGp1aMKOpUzsIKzy9PEUl3O63ixX04A,562
+odoo/addons/account_commission/models/commission.py,sha256=OHzmB5iH-h4oQf5JQGV4EFpNOkAHxC1_0-j0g-8nDXE,576
 odoo/addons/account_commission/models/commission_settlement.py,sha256=zlC641aN3U_13O0qVp2fPuHHMXnEhMS_Q-RbD4z4JU8,7177
-odoo/addons/account_commission/readme/CONFIGURE.rst,sha256=6pepxEYibatNUsjms0bHoR7YlpT7FvSrqFLrje565T4,287
+odoo/addons/account_commission/readme/CONFIGURE.rst,sha256=vUEhtDTSXiZc88gXBuQZIcSkM3CbkmzQQwdVgJfnbSA,466
 odoo/addons/account_commission/readme/CONTRIBUTORS.rst,sha256=QsQobB9fWIKbpeWn8EHcxpOVKgnsjuqydf3FRLbC3v4,667
 odoo/addons/account_commission/readme/DESCRIPTION.rst,sha256=dLMZSNYGysvHiOC7Untw2leoCloADPLcrkIoE8FDEVI,208
 odoo/addons/account_commission/readme/USAGE.rst,sha256=kyhxu0d4eBImmEfJ4f-blVNPNByzArlsT9SIvLpQFqI,1798
 odoo/addons/account_commission/report/__init__.py,sha256=w7t-EO6EMoLF3jDCOZz5mMxeLWYADB6TeEI2GWbzy5M,34
 odoo/addons/account_commission/report/commission_analysis.py,sha256=3GtN00qKdAZppDxy3spyuWQOCarwhaR8C4Nyj3vwqWE,3915
 odoo/addons/account_commission/report/commission_analysis_view.xml,sha256=epC8NSQ9BWypxPCaYJuJReozUSEM97HUIM-nZwtRNWQ,5289
 odoo/addons/account_commission/security/account_commission_security.xml,sha256=pwM4bUnnov262aWbg_KXo1kGsiE0h_jqiWa5gc7e0Eo,1418
 odoo/addons/account_commission/security/ir.model.access.csv,sha256=c0k8cFhVg1A4XCaUQ-mzJdLIotKKt1ltIYznK8ELhYE,883
 odoo/addons/account_commission/static/description/icon.png,sha256=ydxSIUuHSeE4CfMVsEzLjKKVdX4RicuPj8VGM2rBpBg,8219
 odoo/addons/account_commission/static/description/icon.svg,sha256=96b_cQ-F1XuDU6S5mDi9ioe0d22Vwn30uBDQ_3ZSi5w,17220
-odoo/addons/account_commission/static/description/index.html,sha256=3YEvNWQH3si670-EdWXbEVNIQF7lb_Oe8DzKwvX_wnc,16898
+odoo/addons/account_commission/static/description/index.html,sha256=rsCEueGEDQH3lDRwd6PE-_TBnXDr2h1gq4VaNtBejHc,17067
 odoo/addons/account_commission/tests/__init__.py,sha256=bxd564RH-TWEpEJWbbc558dPFEJZCsH9JM8JF3-PMUM,38
-odoo/addons/account_commission/tests/test_account_commission.py,sha256=2VQjWEFznOKutjyXH1NSKpo_af6sPhXA6BHoYFFYv5E,22008
+odoo/addons/account_commission/tests/test_account_commission.py,sha256=yhSNC5SyEqDt3kFG7edGLka3eZl0C7FzqtBYKoIXQp8,27141
 odoo/addons/account_commission/views/account_move_views.xml,sha256=N6PGXNMSxgpwaz5HtydDTRX0stu3QzTX5vBICCksP9s,6600
 odoo/addons/account_commission/views/commission_settlement_views.xml,sha256=JG5sX13R5jdB79m1Pub2rwqhM1s3Kux3btXAbgv_sFk,3496
 odoo/addons/account_commission/views/commission_views.xml,sha256=oY2-WJ-lEn3gCoFMqStKObGT3LRkBxMmANm2MRhYuRE,614
 odoo/addons/account_commission/views/report_settlement_templates.xml,sha256=xr0G0Og9iKCcnB08QA0fy0dT_P90pVZ4w6OuJ_NVx2U,1781
 odoo/addons/account_commission/wizards/__init__.py,sha256=ddwjnl0fpZTw56iNQmRcDJ0Q1RfptMC23XtvW93Ofec,66
 odoo/addons/account_commission/wizards/commission_make_settle.py,sha256=k7yztap0JSa5q-QH71GXd0WFaUG639ETaAKrqdH8UE0,1717
 odoo/addons/account_commission/wizards/wizard_invoice.py,sha256=SumDW3606uLS4d6L2rKjQbwdvfmIYovKark-EUMTve0,3162
 odoo/addons/account_commission/wizards/wizard_invoice.xml,sha256=Afx90Mccl0EjLzZ2dJa2dOikYhWxIY5tQ7objmca8gc,2292
-odoo_addon_account_commission-16.0.2.2.0.1.dist-info/METADATA,sha256=MaknJ-UIpfKs0-jHtZTkPqiI6em60UaILYdtPRLb2yQ,6552
-odoo_addon_account_commission-16.0.2.2.0.1.dist-info/WHEEL,sha256=oiQVh_5PnQM0E3gPdiz09WCNmwiHDMaGer_elqB3coM,92
-odoo_addon_account_commission-16.0.2.2.0.1.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo_addon_account_commission-16.0.2.2.0.1.dist-info/RECORD,,
+odoo_addon_account_commission-16.0.2.2.1.dist-info/METADATA,sha256=iIQxKe0IT3HNDbFbgPMhFtln-eN_0b2fwHBsSqsxLDY,6729
+odoo_addon_account_commission-16.0.2.2.1.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
+odoo_addon_account_commission-16.0.2.2.1.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo_addon_account_commission-16.0.2.2.1.dist-info/RECORD,,
```

